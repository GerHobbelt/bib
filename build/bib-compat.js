(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.ZoteroBib = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
(function (process,global){
/**
 * Copyright (c) 2014, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * https://raw.github.com/facebook/regenerator/master/LICENSE file. An
 * additional grant of patent rights can be found in the PATENTS file in
 * the same directory.
 */

!(function(global) {
  "use strict";

  var hasOwn = Object.prototype.hasOwnProperty;
  var undefined; // More compressible than void 0.
  var iteratorSymbol =
    typeof Symbol === "function" && Symbol.iterator || "@@iterator";

  var inModule = typeof module === "object";
  var runtime = global.regeneratorRuntime;
  if (runtime) {
    if (inModule) {
      // If regeneratorRuntime is defined globally and we're in a module,
      // make the exports object identical to regeneratorRuntime.
      module.exports = runtime;
    }
    // Don't bother evaluating the rest of this file if the runtime was
    // already defined globally.
    return;
  }

  // Define the runtime globally (as expected by generated code) as either
  // module.exports (if we're in a module) or a new, empty object.
  runtime = global.regeneratorRuntime = inModule ? module.exports : {};

  function wrap(innerFn, outerFn, self, tryLocsList) {
    // If outerFn provided, then outerFn.prototype instanceof Generator.
    var generator = Object.create((outerFn || Generator).prototype);
    var context = new Context(tryLocsList || []);

    // The ._invoke method unifies the implementations of the .next,
    // .throw, and .return methods.
    generator._invoke = makeInvokeMethod(innerFn, self, context);

    return generator;
  }
  runtime.wrap = wrap;

  // Try/catch helper to minimize deoptimizations. Returns a completion
  // record like context.tryEntries[i].completion. This interface could
  // have been (and was previously) designed to take a closure to be
  // invoked without arguments, but in all the cases we care about we
  // already have an existing method we want to call, so there's no need
  // to create a new function object. We can even get away with assuming
  // the method takes exactly one argument, since that happens to be true
  // in every case, so we don't have to touch the arguments object. The
  // only additional allocation required is the completion record, which
  // has a stable shape and so hopefully should be cheap to allocate.
  function tryCatch(fn, obj, arg) {
    try {
      return { type: "normal", arg: fn.call(obj, arg) };
    } catch (err) {
      return { type: "throw", arg: err };
    }
  }

  var GenStateSuspendedStart = "suspendedStart";
  var GenStateSuspendedYield = "suspendedYield";
  var GenStateExecuting = "executing";
  var GenStateCompleted = "completed";

  // Returning this object from the innerFn has the same effect as
  // breaking out of the dispatch switch statement.
  var ContinueSentinel = {};

  // Dummy constructor functions that we use as the .constructor and
  // .constructor.prototype properties for functions that return Generator
  // objects. For full spec compliance, you may wish to configure your
  // minifier not to mangle the names of these two functions.
  function Generator() {}
  function GeneratorFunction() {}
  function GeneratorFunctionPrototype() {}

  var Gp = GeneratorFunctionPrototype.prototype = Generator.prototype;
  GeneratorFunction.prototype = Gp.constructor = GeneratorFunctionPrototype;
  GeneratorFunctionPrototype.constructor = GeneratorFunction;
  GeneratorFunction.displayName = "GeneratorFunction";

  // Helper for defining the .next, .throw, and .return methods of the
  // Iterator interface in terms of a single ._invoke method.
  function defineIteratorMethods(prototype) {
    ["next", "throw", "return"].forEach(function(method) {
      prototype[method] = function(arg) {
        return this._invoke(method, arg);
      };
    });
  }

  runtime.isGeneratorFunction = function(genFun) {
    var ctor = typeof genFun === "function" && genFun.constructor;
    return ctor
      ? ctor === GeneratorFunction ||
        // For the native GeneratorFunction constructor, the best we can
        // do is to check its .name property.
        (ctor.displayName || ctor.name) === "GeneratorFunction"
      : false;
  };

  runtime.mark = function(genFun) {
    if (Object.setPrototypeOf) {
      Object.setPrototypeOf(genFun, GeneratorFunctionPrototype);
    } else {
      genFun.__proto__ = GeneratorFunctionPrototype;
    }
    genFun.prototype = Object.create(Gp);
    return genFun;
  };

  // Within the body of any async function, `await x` is transformed to
  // `yield regeneratorRuntime.awrap(x)`, so that the runtime can test
  // `value instanceof AwaitArgument` to determine if the yielded value is
  // meant to be awaited. Some may consider the name of this method too
  // cutesy, but they are curmudgeons.
  runtime.awrap = function(arg) {
    return new AwaitArgument(arg);
  };

  function AwaitArgument(arg) {
    this.arg = arg;
  }

  function AsyncIterator(generator) {
    // This invoke function is written in a style that assumes some
    // calling function (or Promise) will handle exceptions.
    function invoke(method, arg) {
      var result = generator[method](arg);
      var value = result.value;
      return value instanceof AwaitArgument
        ? Promise.resolve(value.arg).then(invokeNext, invokeThrow)
        : Promise.resolve(value).then(function(unwrapped) {
            // When a yielded Promise is resolved, its final value becomes
            // the .value of the Promise<{value,done}> result for the
            // current iteration. If the Promise is rejected, however, the
            // result for this iteration will be rejected with the same
            // reason. Note that rejections of yielded Promises are not
            // thrown back into the generator function, as is the case
            // when an awaited Promise is rejected. This difference in
            // behavior between yield and await is important, because it
            // allows the consumer to decide what to do with the yielded
            // rejection (swallow it and continue, manually .throw it back
            // into the generator, abandon iteration, whatever). With
            // await, by contrast, there is no opportunity to examine the
            // rejection reason outside the generator function, so the
            // only option is to throw it from the await expression, and
            // let the generator function handle the exception.
            result.value = unwrapped;
            return result;
          });
    }

    if (typeof process === "object" && process.domain) {
      invoke = process.domain.bind(invoke);
    }

    var invokeNext = invoke.bind(generator, "next");
    var invokeThrow = invoke.bind(generator, "throw");
    var invokeReturn = invoke.bind(generator, "return");
    var previousPromise;

    function enqueue(method, arg) {
      function callInvokeWithMethodAndArg() {
        return invoke(method, arg);
      }

      return previousPromise =
        // If enqueue has been called before, then we want to wait until
        // all previous Promises have been resolved before calling invoke,
        // so that results are always delivered in the correct order. If
        // enqueue has not been called before, then it is important to
        // call invoke immediately, without waiting on a callback to fire,
        // so that the async generator function has the opportunity to do
        // any necessary setup in a predictable way. This predictability
        // is why the Promise constructor synchronously invokes its
        // executor callback, and why async functions synchronously
        // execute code before the first await. Since we implement simple
        // async functions in terms of async generators, it is especially
        // important to get this right, even though it requires care.
        previousPromise ? previousPromise.then(
          callInvokeWithMethodAndArg,
          // Avoid propagating failures to Promises returned by later
          // invocations of the iterator.
          callInvokeWithMethodAndArg
        ) : new Promise(function (resolve) {
          resolve(callInvokeWithMethodAndArg());
        });
    }

    // Define the unified helper method that is used to implement .next,
    // .throw, and .return (see defineIteratorMethods).
    this._invoke = enqueue;
  }

  defineIteratorMethods(AsyncIterator.prototype);

  // Note that simple async functions are implemented on top of
  // AsyncIterator objects; they just return a Promise for the value of
  // the final result produced by the iterator.
  runtime.async = function(innerFn, outerFn, self, tryLocsList) {
    var iter = new AsyncIterator(
      wrap(innerFn, outerFn, self, tryLocsList)
    );

    return runtime.isGeneratorFunction(outerFn)
      ? iter // If outerFn is a generator, return the full iterator.
      : iter.next().then(function(result) {
          return result.done ? result.value : iter.next();
        });
  };

  function makeInvokeMethod(innerFn, self, context) {
    var state = GenStateSuspendedStart;

    return function invoke(method, arg) {
      if (state === GenStateExecuting) {
        throw new Error("Generator is already running");
      }

      if (state === GenStateCompleted) {
        if (method === "throw") {
          throw arg;
        }

        // Be forgiving, per 25.3.3.3.3 of the spec:
        // https://people.mozilla.org/~jorendorff/es6-draft.html#sec-generatorresume
        return doneResult();
      }

      while (true) {
        var delegate = context.delegate;
        if (delegate) {
          if (method === "return" ||
              (method === "throw" && delegate.iterator[method] === undefined)) {
            // A return or throw (when the delegate iterator has no throw
            // method) always terminates the yield* loop.
            context.delegate = null;

            // If the delegate iterator has a return method, give it a
            // chance to clean up.
            var returnMethod = delegate.iterator["return"];
            if (returnMethod) {
              var record = tryCatch(returnMethod, delegate.iterator, arg);
              if (record.type === "throw") {
                // If the return method threw an exception, let that
                // exception prevail over the original return or throw.
                method = "throw";
                arg = record.arg;
                continue;
              }
            }

            if (method === "return") {
              // Continue with the outer return, now that the delegate
              // iterator has been terminated.
              continue;
            }
          }

          var record = tryCatch(
            delegate.iterator[method],
            delegate.iterator,
            arg
          );

          if (record.type === "throw") {
            context.delegate = null;

            // Like returning generator.throw(uncaught), but without the
            // overhead of an extra function call.
            method = "throw";
            arg = record.arg;
            continue;
          }

          // Delegate generator ran and handled its own exceptions so
          // regardless of what the method was, we continue as if it is
          // "next" with an undefined arg.
          method = "next";
          arg = undefined;

          var info = record.arg;
          if (info.done) {
            context[delegate.resultName] = info.value;
            context.next = delegate.nextLoc;
          } else {
            state = GenStateSuspendedYield;
            return info;
          }

          context.delegate = null;
        }

        if (method === "next") {
          context._sent = arg;

          if (state === GenStateSuspendedYield) {
            context.sent = arg;
          } else {
            context.sent = undefined;
          }
        } else if (method === "throw") {
          if (state === GenStateSuspendedStart) {
            state = GenStateCompleted;
            throw arg;
          }

          if (context.dispatchException(arg)) {
            // If the dispatched exception was caught by a catch block,
            // then let that catch block handle the exception normally.
            method = "next";
            arg = undefined;
          }

        } else if (method === "return") {
          context.abrupt("return", arg);
        }

        state = GenStateExecuting;

        var record = tryCatch(innerFn, self, context);
        if (record.type === "normal") {
          // If an exception is thrown from innerFn, we leave state ===
          // GenStateExecuting and loop back for another invocation.
          state = context.done
            ? GenStateCompleted
            : GenStateSuspendedYield;

          var info = {
            value: record.arg,
            done: context.done
          };

          if (record.arg === ContinueSentinel) {
            if (context.delegate && method === "next") {
              // Deliberately forget the last sent value so that we don't
              // accidentally pass it on to the delegate.
              arg = undefined;
            }
          } else {
            return info;
          }

        } else if (record.type === "throw") {
          state = GenStateCompleted;
          // Dispatch the exception by looping back around to the
          // context.dispatchException(arg) call above.
          method = "throw";
          arg = record.arg;
        }
      }
    };
  }

  // Define Generator.prototype.{next,throw,return} in terms of the
  // unified ._invoke helper method.
  defineIteratorMethods(Gp);

  Gp[iteratorSymbol] = function() {
    return this;
  };

  Gp.toString = function() {
    return "[object Generator]";
  };

  function pushTryEntry(locs) {
    var entry = { tryLoc: locs[0] };

    if (1 in locs) {
      entry.catchLoc = locs[1];
    }

    if (2 in locs) {
      entry.finallyLoc = locs[2];
      entry.afterLoc = locs[3];
    }

    this.tryEntries.push(entry);
  }

  function resetTryEntry(entry) {
    var record = entry.completion || {};
    record.type = "normal";
    delete record.arg;
    entry.completion = record;
  }

  function Context(tryLocsList) {
    // The root entry object (effectively a try statement without a catch
    // or a finally block) gives us a place to store values thrown from
    // locations where there is no enclosing try statement.
    this.tryEntries = [{ tryLoc: "root" }];
    tryLocsList.forEach(pushTryEntry, this);
    this.reset(true);
  }

  runtime.keys = function(object) {
    var keys = [];
    for (var key in object) {
      keys.push(key);
    }
    keys.reverse();

    // Rather than returning an object with a next method, we keep
    // things simple and return the next function itself.
    return function next() {
      while (keys.length) {
        var key = keys.pop();
        if (key in object) {
          next.value = key;
          next.done = false;
          return next;
        }
      }

      // To avoid creating an additional object, we just hang the .value
      // and .done properties off the next function object itself. This
      // also ensures that the minifier will not anonymize the function.
      next.done = true;
      return next;
    };
  };

  function values(iterable) {
    if (iterable) {
      var iteratorMethod = iterable[iteratorSymbol];
      if (iteratorMethod) {
        return iteratorMethod.call(iterable);
      }

      if (typeof iterable.next === "function") {
        return iterable;
      }

      if (!isNaN(iterable.length)) {
        var i = -1, next = function next() {
          while (++i < iterable.length) {
            if (hasOwn.call(iterable, i)) {
              next.value = iterable[i];
              next.done = false;
              return next;
            }
          }

          next.value = undefined;
          next.done = true;

          return next;
        };

        return next.next = next;
      }
    }

    // Return an iterator with no values.
    return { next: doneResult };
  }
  runtime.values = values;

  function doneResult() {
    return { value: undefined, done: true };
  }

  Context.prototype = {
    constructor: Context,

    reset: function(skipTempReset) {
      this.prev = 0;
      this.next = 0;
      this.sent = undefined;
      this.done = false;
      this.delegate = null;

      this.tryEntries.forEach(resetTryEntry);

      if (!skipTempReset) {
        for (var name in this) {
          // Not sure about the optimal order of these conditions:
          if (name.charAt(0) === "t" &&
              hasOwn.call(this, name) &&
              !isNaN(+name.slice(1))) {
            this[name] = undefined;
          }
        }
      }
    },

    stop: function() {
      this.done = true;

      var rootEntry = this.tryEntries[0];
      var rootRecord = rootEntry.completion;
      if (rootRecord.type === "throw") {
        throw rootRecord.arg;
      }

      return this.rval;
    },

    dispatchException: function(exception) {
      if (this.done) {
        throw exception;
      }

      var context = this;
      function handle(loc, caught) {
        record.type = "throw";
        record.arg = exception;
        context.next = loc;
        return !!caught;
      }

      for (var i = this.tryEntries.length - 1; i >= 0; --i) {
        var entry = this.tryEntries[i];
        var record = entry.completion;

        if (entry.tryLoc === "root") {
          // Exception thrown outside of any try block that could handle
          // it, so set the completion value of the entire function to
          // throw the exception.
          return handle("end");
        }

        if (entry.tryLoc <= this.prev) {
          var hasCatch = hasOwn.call(entry, "catchLoc");
          var hasFinally = hasOwn.call(entry, "finallyLoc");

          if (hasCatch && hasFinally) {
            if (this.prev < entry.catchLoc) {
              return handle(entry.catchLoc, true);
            } else if (this.prev < entry.finallyLoc) {
              return handle(entry.finallyLoc);
            }

          } else if (hasCatch) {
            if (this.prev < entry.catchLoc) {
              return handle(entry.catchLoc, true);
            }

          } else if (hasFinally) {
            if (this.prev < entry.finallyLoc) {
              return handle(entry.finallyLoc);
            }

          } else {
            throw new Error("try statement without catch or finally");
          }
        }
      }
    },

    abrupt: function(type, arg) {
      for (var i = this.tryEntries.length - 1; i >= 0; --i) {
        var entry = this.tryEntries[i];
        if (entry.tryLoc <= this.prev &&
            hasOwn.call(entry, "finallyLoc") &&
            this.prev < entry.finallyLoc) {
          var finallyEntry = entry;
          break;
        }
      }

      if (finallyEntry &&
          (type === "break" ||
           type === "continue") &&
          finallyEntry.tryLoc <= arg &&
          arg <= finallyEntry.finallyLoc) {
        // Ignore the finally entry if control is not jumping to a
        // location outside the try/catch block.
        finallyEntry = null;
      }

      var record = finallyEntry ? finallyEntry.completion : {};
      record.type = type;
      record.arg = arg;

      if (finallyEntry) {
        this.next = finallyEntry.finallyLoc;
      } else {
        this.complete(record);
      }

      return ContinueSentinel;
    },

    complete: function(record, afterLoc) {
      if (record.type === "throw") {
        throw record.arg;
      }

      if (record.type === "break" ||
          record.type === "continue") {
        this.next = record.arg;
      } else if (record.type === "return") {
        this.rval = record.arg;
        this.next = "end";
      } else if (record.type === "normal" && afterLoc) {
        this.next = afterLoc;
      }
    },

    finish: function(finallyLoc) {
      for (var i = this.tryEntries.length - 1; i >= 0; --i) {
        var entry = this.tryEntries[i];
        if (entry.finallyLoc === finallyLoc) {
          this.complete(entry.completion, entry.afterLoc);
          resetTryEntry(entry);
          return ContinueSentinel;
        }
      }
    },

    "catch": function(tryLoc) {
      for (var i = this.tryEntries.length - 1; i >= 0; --i) {
        var entry = this.tryEntries[i];
        if (entry.tryLoc === tryLoc) {
          var record = entry.completion;
          if (record.type === "throw") {
            var thrown = record.arg;
            resetTryEntry(entry);
          }
          return thrown;
        }
      }

      // The context.catch method must only be called with a location
      // argument that corresponds to a known catch block.
      throw new Error("illegal catch attempt");
    },

    delegateYield: function(iterable, resultName, nextLoc) {
      this.delegate = {
        iterator: values(iterable),
        resultName: resultName,
        nextLoc: nextLoc
      };

      return ContinueSentinel;
    }
  };
})(
  // Among the various tricks for obtaining a reference to the global
  // object, this seems to be the most reliable technique that does not
  // use indirect eval (which violates Content Security Policy).
  typeof global === "object" ? global :
  typeof window === "object" ? window :
  typeof self === "object" ? self : this
);

}).call(this,require('_process'),typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})

},{"_process":6}],2:[function(require,module,exports){
/*
 * Copyright (c) 2009-2016 Frank Bennett
 * 
 * 	This program is free software: you can redistribute it and/or
 * 	modify it under EITHER
 * 
 *       * the terms of the Common Public Attribution License (CPAL) as
 * 	    published by the Open Source Initiative, either version 1 of
 * 	    the CPAL, or (at your option) any later version; OR
 * 
 *       * the terms of the GNU Affero General Public License (AGPL)
 *         as published by the Free Software Foundation, either version
 *         3 of the AGPL, or (at your option) any later version.
 * 
 * 	This program is distributed in the hope that it will be useful,
 * 	but WITHOUT ANY WARRANTY; without even the implied warranty of
 * 	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * 	Affero General Public License for more details.
 * 
 * 	You should have received copies of the Common Public Attribution
 *     License and of the GNU Affero General Public License along with
 *     this program.  If not, see <https://opensource.org/licenses/> or
 *     <http://www.gnu.org/licenses/> respectively.
 */

var CSL = {
    PROCESSOR_VERSION: "1.1.178",
    CONDITION_LEVEL_TOP: 1,
    CONDITION_LEVEL_BOTTOM: 2,
    PLAIN_HYPHEN_REGEX: /(?:[^\\]-|\u2013)/,
    LOCATOR_LABELS_REGEXP: new RegExp("^((art|ch|subch|col|fig|l|n|no|op|p|pp|para|subpara|pt|r|sec|subsec|sv|sch|tit|vrs|vol)\\.)\\s+(.*)"),
    STATUTE_SUBDIV_GROUPED_REGEX: /((?:^| )(?:art|bk|ch|subch|col|fig|fol|l|n|no|op|p|pp|para|subpara|pt|r|sec|subsec|sv|sch|tit|vrs|vol)\. *)/g,
    STATUTE_SUBDIV_PLAIN_REGEX: /(?:(?:^| )(?:art|bk|ch|subch|col|fig|fol|l|n|no|op|p|pp|para|subpara|pt|r|sec|subsec|sv|sch|tit|vrs|vol)\. *)/,
    STATUTE_SUBDIV_STRINGS: {
        "art.": "article",
        "bk.": "book",
        "ch.": "chapter",
        "subch.": "subchapter",
        "p.": "page",
        "pp.": "page",
        "para.": "paragraph",
        "subpara.": "subparagraph",
        "pt.": "part",
        "r.": "rule",
        "sec.": "section",
        "subsec.": "subsection",
        "sch.": "schedule",
        "tit.": "title",
        "col.": "column",
        "fig.": "figure",
        "fol.": "folio",
        "l.": "line",
        "n.": "note",
        "no.": "issue",
        "op.": "opus",
        "sv.": "sub-verbo",
        "vrs.": "verse",
        "vol.": "volume"
    },
    STATUTE_SUBDIV_STRINGS_REVERSE: {
        "article": "art.",
        "book": "bk.",
        "chapter": "ch.",
        "subchapter": "subch.",
        "page": "p.",
        "paragraph": "para.",
        "subparagraph": "subpara.",
        "part": "pt.",
        "rule": "r.",
        "section": "sec.",
        "subsection": "subsec.",
        "schedule": "sch.",
        "title": "tit.",
        "column": "col.",
        "figure": "fig.",
        "folio": "fol.",
        "line": "l.",
        "note": "n.",
        "issue": "no.",
        "opus": "op.",
        "sub-verbo": "sv.",
        "sub verbo": "sv.",
        "verse": "vrs.",
        "volume": "vol."
    },
    LOCATOR_LABELS_MAP: {
        "art": "article",
        "bk": "book",
        "ch": "chapter",
        "subch": "subchapter",
        "col": "column",
        "fig": "figure",
        "fol": "folio",
        "l": "line",
        "n": "note",
        "no": "issue",
        "op": "opus",
        "p": "page",
        "pp": "page",
        "para": "paragraph",
        "subpara": "subparagraph",
        "pt": "part",
        "r": "rule",
		"sec": "section",
		"subsec": "subsection",
		"sv": "sub-verbo",
        "sch": "schedule",
        "tit": "title",
        "vrs": "verse",
        "vol": "volume"
    },
    MODULE_MACROS: {
        "juris-pretitle": true,
        "juris-title": true,
        "juris-pretitle-short": true,
        "juris-title-short": true,
        "juris-main": true,
        "juris-main-short": true,
        "juris-tail": true,
        "juris-tail-short": true,
        "juris-locator": true
    },
    MODULE_TYPES: {
        "legal_case": true,
        "legislation": true,
        "bill": true,
        "hearing": true,
        "gazette": true,
        "report": true,
        "regulation": true,
        "standard": true
    },
    NestedBraces: [
        ["(", "["],
        [")", "]"]
    ],
    checkNestedBrace: function(state) {
        if (state.opt.xclass === "note") {
            this.depth = 0;
            this.update = function(str) {
                var str = str ? str : '';
                var lst = str.split(/([\(\)])/);
                for (var i=1,ilen=lst.length;i<ilen;i += 2) {
                    if (lst[i] === '(') {
                        if (1 === (this.depth % 2)) {
                            lst[i] = '['
                        }
                        this.depth += 1;
                    } else if (lst[i] === ')') {
                        if (0 === (this.depth % 2)) {
                            lst[i] = ']'
                        }
                        this.depth -= 1;
                    }
                }
                var ret = lst.join("");
                return ret;
            }
        } else {
            this.update = function(str) {
                return str;
            }
        };
    },
    MULTI_FIELDS: ["event", "publisher", "publisher-place", "event-place", "title", "container-title", "collection-title", "authority","genre","title-short","medium","jurisdiction","archive","archive-place"],
    LangPrefsMap: {
        "title":"titles",
        "title-short":"titles",
        "event":"titles",
        "genre":"titles",
        "medium":"titles",
        "container-title":"journals",
        "collection-title":"journals",
        "archive":"journals",
        "publisher":"publishers",
        "authority":"publishers",
        "publisher-place": "places",
        "event-place": "places",
        "archive-place": "places",
        "jurisdiction": "places",
        "number": "number",
        "edition":"number",
        "issue":"number",
        "volume":"number"
    },
    AbbreviationSegments: function () {
        this["container-title"] = {};
        this["collection-title"] = {};
        this["institution-entire"] = {};
        this["institution-part"] = {};
        this.nickname = {};
        this.number = {};
        this.title = {};
        this.place = {};
        this.hereinafter = {};
        this.classic = {};
        this["container-phrase"] = {};
        this["title-phrase"] = {};
    },
    FIELD_CATEGORY_REMAP: {
        "title": "title",
        "container-title": "container-title",
        "collection-title": "collection-title",
        "number": "number",
        "place": "place",
        "archive": "collection-title",
        "title-short": "title",
        "genre": "title",
        "event": "title",
        "medium": "title",
		"archive-place": "place",
		"publisher-place": "place",
		"event-place": "place",
		"jurisdiction": "place",
		"language-name": "place",
		"language-name-original": "place",
        "call-number": "number",
        "chapter-number": "number",
        "collection-number": "number",
        "edition": "number",
        "page": "number",
        "issue": "number",
        "locator": "number",
        "number-of-pages": "number",
        "number-of-volumes": "number",
        "volume": "number",
        "citation-number": "number",
        "publisher": "institution-part"
    },
    parseLocator: function(item) {
        if (this.opt.development_extensions.locator_date_and_revision) {
            if (item.locator) {
                item.locator = "" + item.locator;
                var idx = item.locator.indexOf("|");
                if (idx > -1) {
                    var raw_locator = item.locator;
                    item.locator = raw_locator.slice(0, idx);
                    raw_locator = raw_locator.slice(idx + 1);
                    var m = raw_locator.match(/^([0-9]{4}-[0-9]{2}-[0-9]{2}).*/);
                    if (m) {
                        item["locator-date"] = this.fun.dateparser.parseDateToObject(m[1]);
                        raw_locator = raw_locator.slice(m[1].length);
                    }
                    item["locator-extra"] = raw_locator.replace(/^\s+/, "").replace(/\s+$/, "");
                }
            }
        }
        if (item.locator) {
            item.locator = ("" + item.locator).replace(/\s+$/, '');
        }
        return item;
    },
    normalizeLocaleStr: function(str) {
        if (!str) return;
        var lst = str.split('-');
        lst[0] = lst[0].toLowerCase();
        if (lst[1]) {
            lst[1] = lst[1].toUpperCase();
        }
        return lst.join("-");
    },
    parseNoteFieldHacks: function(Item, validFieldsForType, allowDateOverride) {
        if ("string" !== typeof Item.note) return;
        var elems = [];
        var lines = Item.note.split('\n');
        var lastline = "";
        for (var i=0, ilen=lines.length; i<ilen; i++) {
            var line = lines[i];
            var elems = [];
            var m = line.match(CSL.NOTE_FIELDS_REGEXP);
            if (m) {
                var splt = line.split(CSL.NOTE_FIELDS_REGEXP);
                for (var j=0,jlen=(splt.length-1);j<jlen;j++) {
                    elems.push(splt[j]);
                    elems.push(m[j]);
                }
                elems.push(splt[splt.length-1])
                for (var j=1,jlen=elems.length;j<jlen;j += 2) {
                    if (elems[j-1].trim() && (i>0 || j>1) && !elems[j-1].match(CSL.NOTE_FIELD_REGEXP)) {
                        break
                    } else {
                        elems[j] = '\n' + elems[j].slice(2,-1).trim() + '\n';
                    }
                }
                lines[i] = elems.join('');
            }
        }
        lines = lines.join('\n').split('\n');
        var offset = 0;
        var names = {};
        for (var i=0,ilen=lines.length;i<ilen;i++) {
            var line = lines[i];
            var mm = line.match(CSL.NOTE_FIELD_REGEXP);
            if (!line.trim()) {
                continue;
            } else if (!mm) {
                if (i === 0) {
                    continue;
                } else {
                    offset = i;
                    break;
                }
            }
            var key = mm[1];
            var val = mm[2].replace(/^\s+/, "").replace(/\s+$/, "");
            if (key === "type") {
                Item.type = val;
                lines[i] = "";
            } else if (CSL.DATE_VARIABLES.indexOf(key) > -1) {
                if (allowDateOverride) {
                    Item[key] = {raw: val};
                    if (!validFieldsForType || (validFieldsForType[key] && val.match(/^[0-9]{4}(?:-[0-9]{1,2}(?:-[0-9]{1,2})*)*$/))) {
                        lines[i] = "";
                    }
                }
            } else if (!Item[key]) {
                if (CSL.NAME_VARIABLES.indexOf(key) > -1) {
                    if (!names[key]) {
                        names[key] = [];
                    }
                    var lst = val.split(/\s*\|\|\s*/);
                    if (lst.length === 1) {
                        names[key].push({literal:lst[0]});
                    } else if (lst.length === 2) {
                        var name = {family:lst[0],given:lst[1]};
                        CSL.parseParticles(name);
                        names[key].push(name);
                    }
                } else {
                    Item[key] = val;
                }
                if (!validFieldsForType || validFieldsForType[key]) {
                    lines[i] = "";
                }
            }
        }
        for (var key in names) {
            Item[key] = names[key];
        }
        if (validFieldsForType) {
            if (lines[offset].trim()) {
                lines[offset] = '\n' + lines[offset]
            }
            for (var i=offset-1;i>-1;i--) {
                if (!lines[i].trim()) {
                    lines = lines.slice(0, i).concat(lines.slice(i + 1));
                }
            }
        }
        Item.note = lines.join("\n").trim();
    },
    GENDERS: ["masculine", "feminine"],
    ERROR_NO_RENDERED_FORM: 1,
    PREVIEW: "Just for laughs.",
    ASSUME_ALL_ITEMS_REGISTERED: 2,
    START: 0,
    END: 1,
    SINGLETON: 2,
    SEEN: 6,
    SUCCESSOR: 3,
    SUCCESSOR_OF_SUCCESSOR: 4,
    SUPPRESS: 5,
    SINGULAR: 0,
    PLURAL: 1,
    LITERAL: true,
    BEFORE: 1,
    AFTER: 2,
    DESCENDING: 1,
    ASCENDING: 2,
    ONLY_FIRST: 1,
    ALWAYS: 2,
    ONLY_LAST: 3,
    FINISH: 1,
    POSITION_FIRST: 0,
    POSITION_SUBSEQUENT: 1,
    POSITION_IBID: 2,
    POSITION_IBID_WITH_LOCATOR: 3,
    MARK_TRAILING_NAMES: true,
    POSITION_TEST_VARS: ["position", "first-reference-note-number", "near-note"],
    AREAS: ["citation", "citation_sort", "bibliography", "bibliography_sort"],
    CITE_FIELDS: ["first-reference-note-number", "locator", "locator-extra"],
    MINIMAL_NAME_FIELDS: ["literal", "family"],
    SWAPPING_PUNCTUATION: [".", "!", "?", ":", ","],
    TERMINAL_PUNCTUATION: [":", ".", ";", "!", "?", " "],
    NONE: 0,
    NUMERIC: 1,
    POSITION: 2,
    COLLAPSE_VALUES: ["citation-number", "year", "year-suffix"],
    DATE_PARTS: ["year", "month", "day"],
    DATE_PARTS_ALL: ["year", "month", "day", "season"],
    DATE_PARTS_INTERNAL: ["year", "month", "day", "year_end", "month_end", "day_end"],
    NAME_PARTS: ["non-dropping-particle", "family", "given", "dropping-particle", "suffix", "literal"],
    DECORABLE_NAME_PARTS: ["given", "family", "suffix"],
    DISAMBIGUATE_OPTIONS: [
        "disambiguate-add-names",
        "disambiguate-add-givenname",
        "disambiguate-add-year-suffix"
    ],
    GIVENNAME_DISAMBIGUATION_RULES: [
        "all-names",
        "all-names-with-initials",
        "primary-name",
        "primary-name-with-initials",
        "by-cite"
    ],
    NAME_ATTRIBUTES: [
        "and",
        "delimiter-precedes-last",
        "delimiter-precedes-et-al",
        "initialize-with",
        "initialize",
        "name-as-sort-order",
        "sort-separator",
        "et-al-min",
        "et-al-use-first",
        "et-al-subsequent-min",
        "et-al-subsequent-use-first",
        "form",
        "prefix",
        "suffix",
        "delimiter"
    ],
    PARALLEL_MATCH_VARS: ["container-title"],
    PARALLEL_TYPES: ["bill","gazette","regulation","legislation","legal_case","treaty","article-magazine","article-journal"],
    PARALLEL_COLLAPSING_MID_VARSET: ["volume", "issue", "container-title", "section", "collection-number"],
    LOOSE: 0,
    STRICT: 1,
    TOLERANT: 2,
    PREFIX_PUNCTUATION: /[.;:]\s*$/,
    SUFFIX_PUNCTUATION: /^\s*[.;:,\(\)]/,
    NUMBER_REGEXP: /(?:^\d+|\d+$)/,
    NAME_INITIAL_REGEXP: /^([A-Z\u0590-\u05ff\u00c0-\u017f\u0400-\u042f\u0600-\u06ff\u0370\u0372\u0376\u0386\u0388-\u03ab\u03e2\u03e4\u03e6\u03e8\u03ea\u03ec\u03ee\u03f4\u03f7\u03fd-\u03ff])([a-zA-Z\u00c0-\u017f\u0400-\u052f\u0600-\u06ff\u0370-\u03ff\u1f00-\u1fff]*|)/,
    ROMANESQUE_REGEXP: /[-0-9a-zA-Z\u0590-\u05d4\u05d6-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/,
    ROMANESQUE_NOT_REGEXP: /[^a-zA-Z\u0590-\u05ff\u00c0-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/g,
    STARTSWITH_ROMANESQUE_REGEXP: /^[&a-zA-Z\u0590-\u05d4\u05d6-\u05ff\u00c0-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/,
    ENDSWITH_ROMANESQUE_REGEXP: /[.;:&a-zA-Z\u0590-\u05d4\u05d6-\u05ff\u00c0-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]$/,
    ALL_ROMANESQUE_REGEXP: /^[a-zA-Z\u0590-\u05ff\u00c0-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]+$/,
    VIETNAMESE_SPECIALS: /[\u00c0-\u00c3\u00c8-\u00ca\u00cc\u00cd\u00d2-\u00d5\u00d9\u00da\u00dd\u00e0-\u00e3\u00e8-\u00ea\u00ec\u00ed\u00f2-\u00f5\u00f9\u00fa\u00fd\u0101\u0103\u0110\u0111\u0128\u0129\u0168\u0169\u01a0\u01a1\u01af\u01b0\u1ea0-\u1ef9]/,
    VIETNAMESE_NAMES: /^(?:(?:[.AaBbCcDdEeGgHhIiKkLlMmNnOoPpQqRrSsTtUuVvXxYy \u00c0-\u00c3\u00c8-\u00ca\u00cc\u00cd\u00d2-\u00d5\u00d9\u00da\u00dd\u00e0-\u00e3\u00e8-\u00ea\u00ec\u00ed\u00f2-\u00f5\u00f9\u00fa\u00fd\u0101\u0103\u0110\u0111\u0128\u0129\u0168\u0169\u01a0\u01a1\u01af\u01b0\u1ea0-\u1ef9]{2,6})(\s+|$))+$/,
    NOTE_FIELDS_REGEXP: /\{:(?:[\-_a-z]+|[A-Z]+):[^\}]+\}/g,
    NOTE_FIELD_REGEXP: /^([\-_a-z]+|[A-Z]+):\s*([^\}]+)$/,
	PARTICLE_GIVEN_REGEXP: /^([^ ]+(?:\u02bb |\u2019 | |\' ) *)(.+)$/,
	PARTICLE_FAMILY_REGEXP: /^([^ ]+(?:\-|\u02bb|\u2019| |\') *)(.+)$/,
    DISPLAY_CLASSES: ["block", "left-margin", "right-inline", "indent"],
    NAME_VARIABLES: [
        "author",
        "editor",
        "translator",
        "contributor",
        "collection-editor",
        "composer",
        "container-author",
        "director",
        "editorial-director",
        "interviewer",
        "original-author",
        "recipient"
    ],
    NUMERIC_VARIABLES: [
        "call-number",
        "chapter-number",
        "collection-number",
        "edition",
        "page",
        "issue",
        "locator",
        "number",
        "number-of-pages",
        "number-of-volumes",
        "volume",
        "citation-number"
    ],
    DATE_VARIABLES: [
        "locator-date", 
        "issued", 
        "event-date", 
        "accessed", 
        "container", 
        "original-date",
        "publication-date",
        "original-date",
        "available-date",
        "submitted"
    ],
    TITLE_FIELD_SPLITS: function(seg) {
        var keys = ["title", "short", "main", "sub"];
        var ret = {};
        for (var i=0,ilen=keys.length;i<ilen;i++) {
            ret[keys[i]] = seg + "title" + (keys[i] === "title" ? "" : "-" + keys[i]);
        }
        return ret;
    },
    TAG_USEALL: function (str) {
        var ret, open, close, end;
        ret = [""];
        open = str.indexOf("<");
        close = str.indexOf(">");
        while (open > -1 && close > -1) {
            if (open > close) {
                end = open + 1;
            } else {
                end = close + 1;
            }
            if (open < close && str.slice(open + 1, close).indexOf("<") === -1) {
                ret[ret.length - 1] += str.slice(0, open);
                ret.push(str.slice(open, close + 1));
                ret.push("");
                str = str.slice(end);
            } else {
                ret[ret.length - 1] += str.slice(0, close + 1);
                str = str.slice(end);
            }
            open = str.indexOf("<");
            close = str.indexOf(">");
        }
        ret[ret.length - 1] += str;
        return ret;
    },
    demoteNoiseWords: function (state, fld, drop_or_demote) {
        var SKIP_WORDS = state.locale[state.opt.lang].opts["leading-noise-words"];
        if (fld && drop_or_demote) {
            fld = fld.split(/\s+/);
            fld.reverse();
            var toEnd = [];
            for (var j  = fld.length - 1; j > -1; j += -1) {
                if (SKIP_WORDS.indexOf(fld[j].toLowerCase()) > -1) {
                    toEnd.push(fld.pop());
                } else {
                    break;
                }
            }
            fld.reverse();
            var start = fld.join(" ");
            var end = toEnd.join(" ");
            if ("drop" === drop_or_demote || !end) {
                fld = start;
            } else if ("demote" === drop_or_demote) {
                fld = [start, end].join(", ");
            }
        }
        return fld;
    },
    extractTitleAndSubtitle: function (Item) {
        var segments = ["", "container-"];
        for (var i=0,ilen=segments.length;i<ilen;i++) {
            var seg = segments[i];
            var title = CSL.TITLE_FIELD_SPLITS(seg);
            var langs = [false];
            if (Item.multi) {
                for (var lang in Item.multi._keys[title.short]) {
                    langs.push(lang);
                }
            }
            for (var j=0,jlen=langs.length;j<ilen;j++) {
                var lang = langs[j];
                var vals = {};
                if (lang) {
                    if (Item.multi._keys[title.title]) {
                        vals[title.title] = Item.multi._keys[title.title][lang];
                    }
                    if (Item.multi._keys[title["short"]]) {
                        vals[title["short"]] = Item.multi._keys[title["short"]][lang];
                    }
                } else {
                    vals[title.title] = Item[title.title];
                    vals[title["short"]] = Item[title["short"]];
                }
                vals[title.main] = vals[title.title];
                vals[title.sub] = false;
                if (vals[title.title] && vals[title["short"]]) {
                    var shortTitle = vals[title["short"]];
                    var offset = shortTitle.length;
                    if (vals[title.title].slice(0,offset) === shortTitle && vals[title.title].slice(offset).match(/^\s*:/)) {
                        vals[title.main] = vals[title.title].slice(0,offset).replace(/\s+$/,"");
                        vals[title.sub] = vals[title.title].slice(offset).replace(/^\s*:\s*/,"");
                    }
                }
                if (lang) {
                    for (var key in vals) {
                        if (!Item.multi._keys[key]) {
                            Item.multi._keys[key] = {};
                        }
                        Item.multi._keys[key][lang] = vals[key];
                    }
                } else {
                    for (var key in vals) {
                        Item[key] = vals[key];
                    }
                }
            }
        }
    },
    titlecaseSentenceOrNormal: function(state, Item, seg, lang, sentenceCase) {
        var title = CSL.TITLE_FIELD_SPLITS(seg);
        var vals = {};
        if (lang && Item.multi) {
            if (Item.multi._keys[title.title]) {
                vals[title.title] = Item.multi._keys[title.title][lang];
            }
            if (Item.multi._keys[title.main]) {
                vals[title.main] = Item.multi._keys[title.main][lang];
            }
            if (Item.multi._keys[title.sub]) {
                vals[title.sub] = Item.multi._keys[title.sub][lang];
            }
        } else {
            vals[title.title] = Item[title.title];
            vals[title.main] = Item[title.main];
            vals[title.sub] = Item[title.sub];
        }
        if (vals[title.main] && vals[title.sub]) {
            var mainTitle = vals[title.main];
            var subTitle = vals[title.sub];
            if (sentenceCase) {
                mainTitle = CSL.Output.Formatters.sentence(state, mainTitle);
                subTitle = CSL.Output.Formatters.sentence(state, subTitle);
            } else {
                subTitle = CSL.Output.Formatters["capitalize-first"](state, subTitle);
            }
            return [mainTitle, subTitle].join(vals[title.title].slice(mainTitle.length, -1 * subTitle.length));
        } else {
            if (sentenceCase) {
                return CSL.Output.Formatters.sentence(state, vals[title.title]);
            } else {
                return vals[title.title];
            }
        }
    },
    getSafeEscape: function(state) {
        if (["bibliography", "citation"].indexOf(state.tmp.area) > -1) {
            var callbacks = [];
            if (state.opt.development_extensions.thin_non_breaking_space_html_hack && state.opt.mode === "html") {
                callbacks.push(function (txt) {
                    return txt.replace(/\u202f/g, '<span style="white-space:nowrap">&thinsp;</span>');
                });
            }
            if (callbacks.length) {
                return function (txt) {
                    for (var i = 0, ilen = callbacks.length; i < ilen; i += 1) {
                        txt = callbacks[i](txt);
                    }
                    return CSL.Output.Formats[state.opt.mode].text_escape(txt);
                }
            } else {
                return CSL.Output.Formats[state.opt.mode].text_escape;
            }
        } else {
            return function (txt) { return txt; };
        }
    },
    SKIP_WORDS: ["about","above","across","afore","after","against","along","alongside","amid","amidst","among","amongst","anenst","apropos","apud","around","as","aside","astride","at","athwart","atop","barring","before","behind","below","beneath","beside","besides","between","beyond","but","by","circa","despite","down","during","except","for","forenenst","from","given","in","inside","into","lest","like","modulo","near","next","notwithstanding","of","off","on","onto","out","over","per","plus","pro","qua","sans","since","than","through"," thru","throughout","thruout","till","to","toward","towards","under","underneath","until","unto","up","upon","versus","vs.","v.","vs","v","via","vis-à-vis","with","within","without","according to","ahead of","apart from","as for","as of","as per","as regards","aside from","back to","because of","close to","due to","except for","far from","inside of","instead of","near to","next to","on to","out from","out of","outside of","prior to","pursuant to","rather than","regardless of","such as","that of","up to","where as","or", "yet", "so", "for", "and", "nor", "a", "an", "the", "de", "d'", "von", "van", "c", "et", "ca"],
    FORMAT_KEY_SEQUENCE: [
        "@strip-periods",
        "@font-style",
        "@font-variant",
        "@font-weight",
        "@text-decoration",
        "@vertical-align",
        "@quotes"
    ],
    INSTITUTION_KEYS: [
        "font-style",
        "font-variant",
        "font-weight",
        "text-decoration",
        "text-case"
    ],
    SUFFIX_CHARS: "a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z",
    ROMAN_NUMERALS: [
        [ "", "i", "ii", "iii", "iv", "v", "vi", "vii", "viii", "ix" ],
        [ "", "x", "xx", "xxx", "xl", "l", "lx", "lxx", "lxxx", "xc" ],
        [ "", "c", "cc", "ccc", "cd", "d", "dc", "dcc", "dccc", "cm" ],
        [ "", "m", "mm", "mmm", "mmmm", "mmmmm"]
    ],
    CREATORS: [
        "author",
        "editor",
        "contributor",
        "translator",
        "recipient",
        "interviewer",
        "composer",
        "original-author",
        "container-author",
        "collection-editor"
    ],
    LANGS: {
        "af-ZA":"Afrikaans",
        "ar":"Arabic",
        "bg-BG":"Bulgarian",
        "ca-AD":"Catalan",
        "cs-CZ":"Czech",
        "da-DK":"Danish",
        "de-AT":"Austrian",
        "de-CH":"German (CH)",
        "de-DE":"German (DE)",
        "el-GR":"Greek",
        "en-GB":"English (GB)",
        "en-US":"English (US)",
        "es-ES":"Spanish",
        "et-EE":"Estonian",
        "eu":"European",
        "fa-IR":"Persian",
        "fi-FI":"Finnish",
        "fr-CA":"French (CA)",
        "fr-FR":"French (FR)",
        "he-IL":"Hebrew",
        "hr-HR":"Croatian",
        "hu-HU":"Hungarian",
        "is-IS":"Icelandic",
        "it-IT":"Italian",
        "ja-JP":"Japanese",
        "km-KH":"Khmer",
        "ko-KR":"Korean",
        "lt-LT":"Lithuanian",
        "lv-LV":"Latvian",
        "mn-MN":"Mongolian",
        "nb-NO":"Norwegian (Bokmål)",
        "nl-NL":"Dutch",
        "nn-NO":"Norwegian (Nynorsk)",
        "pl-PL":"Polish",
        "pt-BR":"Portuguese (BR)",
        "pt-PT":"Portuguese (PT)",
        "ro-RO":"Romanian",
        "ru-RU":"Russian",
        "sk-SK":"Slovak",
        "sl-SI":"Slovenian",
        "sr-RS":"Serbian",
        "sv-SE":"Swedish",
        "th-TH":"Thai",
        "tr-TR":"Turkish",
        "uk-UA":"Ukranian",
        "vi-VN":"Vietnamese",
        "zh-CN":"Chinese (CN)",
        "zh-TW":"Chinese (TW)"
    },
    LANG_BASES: {
        af: "af_ZA",
        ar: "ar",
        bg: "bg_BG",
        ca: "ca_AD",
        cs: "cs_CZ",
        da: "da_DK",
        de: "de_DE",
        el: "el_GR",
        en: "en_US",
        es: "es_ES",
        et: "et_EE",
        eu: "eu",
        fa: "fa_IR",
        fi: "fi_FI",
        fr: "fr_FR",
        he: "he_IL",
        hr: "hr-HR",
        hu: "hu_HU",
        is: "is_IS",
        it: "it_IT",
        ja: "ja_JP",
        km: "km_KH",
        ko: "ko_KR",
        lt: "lt_LT",
        lv: "lv-LV",
        mn: "mn_MN",
        nb: "nb_NO",
        nl: "nl_NL",
        nn: "nn-NO",
        pl: "pl_PL",
        pt: "pt_PT",
        ro: "ro_RO",
        ru: "ru_RU",
        sk: "sk_SK",
        sl: "sl_SI",
        sr: "sr_RS",
        sv: "sv_SE",
        th: "th_TH",
        tr: "tr_TR",
        uk: "uk_UA",
        vi: "vi_VN",
        zh: "zh_CN"
    },
    SUPERSCRIPTS: {
        "\u00AA": "\u0061",
        "\u00B2": "\u0032",
        "\u00B3": "\u0033",
        "\u00B9": "\u0031",
        "\u00BA": "\u006F",
        "\u02B0": "\u0068",
        "\u02B1": "\u0266",
        "\u02B2": "\u006A",
        "\u02B3": "\u0072",
        "\u02B4": "\u0279",
        "\u02B5": "\u027B",
        "\u02B6": "\u0281",
        "\u02B7": "\u0077",
        "\u02B8": "\u0079",
        "\u02E0": "\u0263",
        "\u02E1": "\u006C",
        "\u02E2": "\u0073",
        "\u02E3": "\u0078",
        "\u02E4": "\u0295",
        "\u1D2C": "\u0041",
        "\u1D2D": "\u00C6",
        "\u1D2E": "\u0042",
        "\u1D30": "\u0044",
        "\u1D31": "\u0045",
        "\u1D32": "\u018E",
        "\u1D33": "\u0047",
        "\u1D34": "\u0048",
        "\u1D35": "\u0049",
        "\u1D36": "\u004A",
        "\u1D37": "\u004B",
        "\u1D38": "\u004C",
        "\u1D39": "\u004D",
        "\u1D3A": "\u004E",
        "\u1D3C": "\u004F",
        "\u1D3D": "\u0222",
        "\u1D3E": "\u0050",
        "\u1D3F": "\u0052",
        "\u1D40": "\u0054",
        "\u1D41": "\u0055",
        "\u1D42": "\u0057",
        "\u1D43": "\u0061",
        "\u1D44": "\u0250",
        "\u1D45": "\u0251",
        "\u1D46": "\u1D02",
        "\u1D47": "\u0062",
        "\u1D48": "\u0064",
        "\u1D49": "\u0065",
        "\u1D4A": "\u0259",
        "\u1D4B": "\u025B",
        "\u1D4C": "\u025C",
        "\u1D4D": "\u0067",
        "\u1D4F": "\u006B",
        "\u1D50": "\u006D",
        "\u1D51": "\u014B",
        "\u1D52": "\u006F",
        "\u1D53": "\u0254",
        "\u1D54": "\u1D16",
        "\u1D55": "\u1D17",
        "\u1D56": "\u0070",
        "\u1D57": "\u0074",
        "\u1D58": "\u0075",
        "\u1D59": "\u1D1D",
        "\u1D5A": "\u026F",
        "\u1D5B": "\u0076",
        "\u1D5C": "\u1D25",
        "\u1D5D": "\u03B2",
        "\u1D5E": "\u03B3",
        "\u1D5F": "\u03B4",
        "\u1D60": "\u03C6",
        "\u1D61": "\u03C7",
        "\u2070": "\u0030",
        "\u2071": "\u0069",
        "\u2074": "\u0034",
        "\u2075": "\u0035",
        "\u2076": "\u0036",
        "\u2077": "\u0037",
        "\u2078": "\u0038",
        "\u2079": "\u0039",
        "\u207A": "\u002B",
        "\u207B": "\u2212",
        "\u207C": "\u003D",
        "\u207D": "\u0028",
        "\u207E": "\u0029",
        "\u207F": "\u006E",
        "\u2120": "\u0053\u004D",
        "\u2122": "\u0054\u004D",
        "\u3192": "\u4E00",
        "\u3193": "\u4E8C",
        "\u3194": "\u4E09",
        "\u3195": "\u56DB",
        "\u3196": "\u4E0A",
        "\u3197": "\u4E2D",
        "\u3198": "\u4E0B",
        "\u3199": "\u7532",
        "\u319A": "\u4E59",
        "\u319B": "\u4E19",
        "\u319C": "\u4E01",
        "\u319D": "\u5929",
        "\u319E": "\u5730",
        "\u319F": "\u4EBA",
        "\u02C0": "\u0294",
        "\u02C1": "\u0295",
        "\u06E5": "\u0648",
        "\u06E6": "\u064A"
    },
    SUPERSCRIPTS_REGEXP: new RegExp("[\u00AA\u00B2\u00B3\u00B9\u00BA\u02B0\u02B1\u02B2\u02B3\u02B4\u02B5\u02B6\u02B7\u02B8\u02E0\u02E1\u02E2\u02E3\u02E4\u1D2C\u1D2D\u1D2E\u1D30\u1D31\u1D32\u1D33\u1D34\u1D35\u1D36\u1D37\u1D38\u1D39\u1D3A\u1D3C\u1D3D\u1D3E\u1D3F\u1D40\u1D41\u1D42\u1D43\u1D44\u1D45\u1D46\u1D47\u1D48\u1D49\u1D4A\u1D4B\u1D4C\u1D4D\u1D4F\u1D50\u1D51\u1D52\u1D53\u1D54\u1D55\u1D56\u1D57\u1D58\u1D59\u1D5A\u1D5B\u1D5C\u1D5D\u1D5E\u1D5F\u1D60\u1D61\u2070\u2071\u2074\u2075\u2076\u2077\u2078\u2079\u207A\u207B\u207C\u207D\u207E\u207F\u2120\u2122\u3192\u3193\u3194\u3195\u3196\u3197\u3198\u3199\u319A\u319B\u319C\u319D\u319E\u319F\u02C0\u02C1\u06E5\u06E6]", "g"),
    UPDATE_GROUP_CONTEXT_CONDITION: function (state, termtxt, valueTerm) {
        if (state.tmp.group_context.tip.condition) {
            if (state.tmp.group_context.tip.condition.test) {
                var testres;
                if (state.tmp.group_context.tip.condition.test === "empty-label") {
                    testres = !termtxt;
                } else if (state.tmp.group_context.tip.condition.test === "comma-safe") {
                    var empty = !termtxt;
                    var alpha = termtxt.slice(0,1).match(CSL.ALL_ROMANESQUE_REGEXP);
                    var num = state.tmp.just_did_number;
                    if (empty) {
                        testres = true;
                    } else if (num) {
                        if (alpha && !valueTerm) {
                            testres = true;
                        } else {
                            testres = false;
                        }
                    } else {
                        if (alpha && !valueTerm) {
                            testres = true;
                        } else {
                            testres = false;
                        }
                    }
                }
                if (testres) {
                    state.tmp.group_context.tip.force_suppress = false;
                } else {
                    state.tmp.group_context.tip.force_suppress = true;
                }
                if (state.tmp.group_context.tip.condition.not) {
                    state.tmp.group_context.tip.force_suppress = !state.tmp.group_context.tip.force_suppress;
                }
            }
        } else {
            if (termtxt.slice(-1).match(/[0-9]/)) {
                state.tmp.just_did_number = true;
            } else {
                state.tmp.just_did_number = false;
            }
        }
    },
    locale: {},
    locale_opts: {},
    locale_dates: {}
};
if (typeof require !== "undefined" && typeof module !== 'undefined' && "exports" in module) {
    var CSL_IS_NODEJS = true;
    exports.CSL = CSL;
}
CSL.TERMINAL_PUNCTUATION_REGEXP = new RegExp("^([" + CSL.TERMINAL_PUNCTUATION.slice(0, -1).join("") + "])(.*)");
CSL.CLOSURES = new RegExp(".*[\\]\\)]");
module.exports = CSL;
if ("undefined" === typeof console) {
    CSL.debug = function (str) {
        dump("CSL: " + str + "\n");
    };
    CSL.error = function (str) {
        dump("CSL error: " + str + "\n");
    };
} else {
    CSL.debug = function (str) {
        console.log("CSL: " + str);
    };
    CSL.error = function (str) {
        console.log("CSL error: " + str);
    };
}
module.exports = CSL;
CSL.XmlJSON = function (dataObj) {
    this.dataObj = dataObj;
    this.institution = {
        name:"institution",
        attrs:{
            "institution-parts":"long",
            "delimiter":", ",
            "substitute-use-first":"1",
            "use-last":"1"
        },
        children:[
            {
                name:"institution-part",
                attrs:{
                    name:"long"
                },
                children:[]
            }
        ]
    };
};
CSL.XmlJSON.prototype.clean = function (json) {
    return json;
};
CSL.XmlJSON.prototype.getStyleId = function (myjson, styleName) {
    var tagName = 'id';
    if (styleName) {
        tagName = 'title';
    }
    var ret = "";
    var children = myjson.children;
    for (var i=0,ilen=children.length;i<ilen;i++) {
        if (children[i].name === 'info') {
            var grandkids = children[i].children;
            for (var j=0,jlen=grandkids.length;j<jlen;j++) {
                if (grandkids[j].name === tagName) {
                    ret = grandkids[j].children[0];
                }
            }
        }
    }
    return ret;
};
CSL.XmlJSON.prototype.children = function (myjson) {
    if (myjson && myjson.children.length) {
        return myjson.children.slice();
    } else {
        return false;
    }
};
CSL.XmlJSON.prototype.nodename = function (myjson) {
    return myjson ? myjson.name : null;
};
CSL.XmlJSON.prototype.attributes = function (myjson) {
    var ret = {};
    for (var attrname in myjson.attrs) {
        ret["@"+attrname] = myjson.attrs[attrname];
    }
    return ret;
};
CSL.XmlJSON.prototype.content = function (myjson) {
    var ret = "";
    if (!myjson || !myjson.children) {
        return ret;
    }
    for (var i=0, ilen=myjson.children.length; i < ilen; i += 1) {
        if ("string" === typeof myjson.children[i]) {
            ret += myjson.children[i];
        }
    }
    return ret;
};
CSL.XmlJSON.prototype.namespace = {}
CSL.XmlJSON.prototype.numberofnodes = function (myjson) {
    if (myjson && "number" == typeof myjson.length) {
        return myjson.length;
    } else {
        return 0;
    }
};
CSL.XmlJSON.prototype.getAttributeValue = function (myjson,name,namespace) {
    var ret = "";
    if (namespace) {
        name = namespace+":"+name;
    }
    if (myjson) {
        if (myjson.attrs) {
            if (myjson.attrs[name]) {
                ret = myjson.attrs[name];
            } else {
                ret = "";
            }
        }
    }
    return ret;
}
CSL.XmlJSON.prototype.getNodeValue = function (myjson,name) {
    var ret = "";
    if (name){
        for (var i=0, ilen=myjson.children.length; i < ilen; i += 1) {
            if (myjson.children[i].name === name) {
                if (myjson.children[i].children.length) {
                    ret = myjson.children[i];
                } else {
                    ret = "";
                }
            }
        }
    } else if (myjson) {
        ret = myjson;
    }
    if (ret && ret.children && ret.children.length == 1 && "string" === typeof ret.children[0]) {
        ret = ret.children[0];
    }
    return ret;
}
CSL.XmlJSON.prototype.setAttributeOnNodeIdentifiedByNameAttribute = function (myjson,nodename,partname,attrname,val) {
    var pos, len, xml, nodes, node;
    if (attrname.slice(0,1) === '@'){
        attrname = attrname.slice(1);
    }
    for (var i=0,ilen=myjson.children.length; i<ilen; i += 1) {
        if (myjson.children[i].name === nodename && myjson.children[i].attrs.name === partname) {
            myjson.children[i].attrs[attrname] = val;
        }
    }
}
CSL.XmlJSON.prototype.deleteNodeByNameAttribute = function (myjson,val) {
    var i, ilen;
    for (i = 0, ilen = myjson.children.length; i < ilen; i += 1) {
        if (!myjson.children[i] || "string" === typeof myjson.children[i]) {
            continue;
        }
        if (myjson.children[i].attrs.name == val) {
            myjson.children = myjson.children.slice(0,i).concat(myjson.children.slice(i+1));
        }
    }
}
CSL.XmlJSON.prototype.deleteAttribute = function (myjson,attrname) {
    var i, ilen;
    if ("undefined" !== typeof myjson.attrs[attrname]) {
        myjson.attrs.pop(attrname);
    }
}
CSL.XmlJSON.prototype.setAttribute = function (myjson,attr,val) {
    myjson.attrs[attr] = val;
    return false;
}
CSL.XmlJSON.prototype.nodeCopy = function (myjson,clone) {
    if (!clone) {
        var clone = {};
    }
    if ("object" === typeof clone && "undefined" === typeof clone.length) {
        for (var key in myjson) {
            if ("string" === typeof myjson[key]) {
                clone[key] = myjson[key];
            } else if ("object" === typeof myjson[key]) {
                if ("undefined" === typeof myjson[key].length) {
                    clone[key] = this.nodeCopy(myjson[key],{});
                } else {
                    clone[key] = this.nodeCopy(myjson[key],[]);
                }
            }
        }
    } else {
        for (var i=0,ilen=myjson.length;i<ilen; i += 1) {
            if ("string" === typeof myjson[i]) {
                clone[i] = myjson[i];
            } else {
                clone[i] = this.nodeCopy(myjson[i],{});
            }
        }
    }
    return clone;
}
CSL.XmlJSON.prototype.getNodesByName = function (myjson,name,nameattrval,ret) {
    var nodes, node, pos, len;
    if (!ret) {
        var ret = [];
    }
    if (!myjson || !myjson.children) {
        return ret;
    }
    if (name === myjson.name) {
        if (nameattrval) {
            if (nameattrval === myjson.attrs.name) {
                ret.push(myjson);
            }
        } else {
            ret.push(myjson);
        }
    }
    for (var i=0,ilen=myjson.children.length;i<ilen;i+=1){
        if ("object" !== typeof myjson.children[i]) {
            continue;
        }
        this.getNodesByName(myjson.children[i],name,nameattrval,ret);
    }
    return ret;
}
CSL.XmlJSON.prototype.nodeNameIs = function (myjson,name) {
    if (typeof myjson === "undefined") {
        return false;
    }
    if (name == myjson.name) {
        return true;
    }
    return false;
}
CSL.XmlJSON.prototype.makeXml = function (myjson) {
    if ("string" === typeof myjson) {
        if (myjson.slice(0, 1) === "<") {
            myjson = this.jsonStringWalker.walkToObject(myjson);
        } else {
            myjson = JSON.parse(myjson);
        }
    }
    return myjson;
};
CSL.XmlJSON.prototype.insertChildNodeAfter = function (parent,node,pos,datejson) {
    for (var i=0,ilen=parent.children.length;i<ilen;i+=1) {
        if (node === parent.children[i]) {
            parent.children = parent.children.slice(0,i).concat([datejson]).concat(parent.children.slice(i+1));
            break;
        }
    }
    return parent;
};
CSL.XmlJSON.prototype.insertPublisherAndPlace = function(myjson) {
    if (myjson.name === "group") {
        var useme = true;
        var mustHaves = ["publisher","publisher-place"];
        for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
            var haveVarname = mustHaves.indexOf(myjson.children[i].attrs.variable);
            var isText = myjson.children[i].name === "text";
            if (isText && haveVarname > -1 && !myjson.children[i].attrs.prefix && !myjson.children[i].attrs.suffix) {
                mustHaves = mustHaves.slice(0,haveVarname).concat(mustHaves.slice(haveVarname+1));
            } else {
                useme = false;
                break;
            }
        }
        if (useme && !mustHaves.length) {
            myjson.attrs["has-publisher-and-publisher-place"] = true;
       }
    }
    for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
        if ("object" === typeof myjson.children[i]) {
            this.insertPublisherAndPlace(myjson.children[i]);
        }
    }    
}
CSL.XmlJSON.prototype.isChildOfSubstitute = function(parents) {
    if (parents.length > 0) {
        var myparents = parents.slice();
        var parent = myparents.pop();
        if (parent === "substitute") {
            return true;
        } else {
            return this.isChildOfSubstitute(myparents);
        }
    }
    return false;
};
CSL.XmlJSON.prototype.addMissingNameNodes = function(myjson,parents) {
    if (!parents) {
        parents = [];
    }
    if (myjson.name === "names") {
        if (!this.isChildOfSubstitute(parents)) {
            var addName = true;
            for (var i=0,ilen=myjson.children.length;i<ilen;i++) {
                if (myjson.children[i].name === "name") {
                    addName = false;
                    break;
                }
            }
            if (addName) {
                myjson.children = [{name:"name",attrs:{},children:[]}].concat(myjson.children);
            }
        }
    }
    parents.push(myjson.name);
    for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
        if ("object" === typeof myjson.children[i]) {
            this.addMissingNameNodes(myjson.children[i],parents);
        }
    }
    parents.pop();
}
CSL.XmlJSON.prototype.addInstitutionNodes = function(myjson) {
    var names, thenames, institution, theinstitution, name, thename, xml, pos, len;
    if (myjson.name === "names") {
        var attributes = {};
        var insertPos = -1;
        for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
            if (myjson.children[i].name == "name") {
                for (var key in myjson.children[i].attrs) {
                    attributes[key] = myjson.children[i].attrs[key];
                }
                attributes.delimiter = myjson.children[i].attrs.delimiter;
                attributes.and = myjson.children[i].attrs.and;
                insertPos = i;
                for (var k=0,klen=myjson.children[i].children.length;k<klen;k+=1) {
                    if (myjson.children[i].children[k].attrs.name !== 'family') {
                        continue;
                    }
                    for (var key in myjson.children[i].children[k].attrs) {
                        attributes[key] = myjson.children[i].children[k].attrs[key];
                    }
                }
            }
            if (myjson.children[i].name == "institution") {
                insertPos = -1;
                break;
            }
        }
        if (insertPos > -1) {
            var institution = this.nodeCopy(this.institution);
            for (var i=0,ilen = CSL.INSTITUTION_KEYS.length;i<ilen;i+=1) {
                var attrname = CSL.INSTITUTION_KEYS[i];
                if ("undefined" !== typeof attributes[attrname]) {
                    institution.children[0].attrs[attrname] = attributes[attrname];
                }
                if (attributes.delimiter) {
                    institution.attrs.delimiter = attributes.delimiter;
                }
                if (attributes.and) {
                    institution.attrs.and = "text";
                }
            }
            myjson.children = myjson.children.slice(0,insertPos+1).concat([institution]).concat(myjson.children.slice(insertPos+1));
        }
    }
    for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
        if ("string" === typeof myjson.children[i]) {
            continue;
        }
        this.addInstitutionNodes(myjson.children[i]);
    }
}
CSL.XmlJSON.prototype.flagDateMacros = function(myjson) {
    for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
        if (myjson.children[i].name === "macro") {
            if (this.inspectDateMacros(myjson.children[i])) {
                myjson.children[i].attrs["macro-has-date"] = "true";
            }
        }
    }
}
CSL.XmlJSON.prototype.inspectDateMacros = function(myjson) {
    if (!myjson || !myjson.children) {
        return false;
    }
    if (myjson.name === "date") {
        return true;
    } else {
        for (var i=0,ilen=myjson.children.length;i<ilen;i+=1) {
            if (this.inspectDateMacros(myjson.children[i])) {
                return true;
            }
        }
    }
    return false;
}
CSL.stripXmlProcessingInstruction = function (xml) {
    if (!xml) {
        return xml;
    }
    xml = xml.replace(/^<\?[^?]+\?>/, "");
    xml = xml.replace(/<!--[^>]+-->/g, "");
    xml = xml.replace(/^\s+/g, "");
    xml = xml.replace(/\s+$/g, "");
    return xml;
};
CSL.parseXml = function(str) {
    var _pos = 0;
    var _obj = {children:[]};
    var _stack = [_obj.children];
    function _listifyString(str) {
        str = str.split(/(?:\r\n|\n|\r)/).join(" ").replace(/>[	 ]+</g, "><").replace(/<\!--.*?-->/g, "");
        var lst = str.split("><");
        var stylePos = null;
        for (var i=0,ilen=lst.length;i<ilen;i++) {
            if (i > 0) {
                lst[i] = "<" + lst[i];
            }
            if (i < (lst.length-1)) {
                lst[i] = lst[i] + ">";
            }
            if ("number" != typeof stylePos) {
                if (lst[i].slice(0, 7) === "<style " || lst[i].slice(0, 8) == "<locale ") {
                    stylePos = i;
                }
            }
        }
        lst = lst.slice(stylePos);
        for (var i=lst.length-2;i>-1;i--) {
            if (lst[i].slice(1).indexOf("<") === -1) {
                var stub = lst[i].slice(0, 5);
                if (stub === "<term") {
                    if (lst[i+1].slice(0, 6) === "</term") {
                        lst[i] = lst[i] + lst[i+1];
                        lst = lst.slice(0, i+1).concat(lst.slice(i+2));
                    }
                } else if (["<sing", "<mult"].indexOf(stub) > -1) {
                    if (lst[i].slice(-2) !== "/>" && lst[i+1].slice(0, 1) === "<") {
                        lst[i] = lst[i] + lst[i+1];
                        lst = lst.slice(0, i+1).concat(lst.slice(i+2));
                    }
                }
            }
        }
        return lst;
    }
    function _decodeHtmlEntities(str) {
        return str
            .split("&amp;").join("&")
            .split("&quot;").join("\"")
            .split("&gt;").join(">").split("&lt;").join("<")
            .replace(/&#([0-9]{1,6});/gi, function(match, numStr) {
                var num = parseInt(numStr, 10); // read num as normal number
                return String.fromCharCode(num);
            })
            .replace(/&#x([a-f0-9]{1,6});/gi, function(match, numStr){
                var num = parseInt(numStr, 16); // read num as hex
                return String.fromCharCode(num);
            });
    }
    function _getAttributes(elem) {
        var m = elem.match(/([^\'\"=	 ]+)=(?:\"[^\"]*\"|\'[^\']*\')/g);
        if (m) {
            for (var i=0,ilen=m.length;i<ilen;i++) {
                m[i] = m[i].replace(/=.*/, "");
            }
        }
        return m;
    }
    function _getAttribute(elem, attr) {
        var rex = RegExp('^.*[	 ]+' + attr + '=(\"(?:[^\"]*)\"|\'(?:[^\']*)\').*$');
        var m = elem.match(rex);
        return m ? m[1].slice(1, -1) : null;
    }
    function _getTagName(elem) {
        var rex = RegExp("^<([^	 />]+)");
        var m = elem.match(rex);
        return m ? m[1] : null;
    }
    function _castObjectFromOpeningTag(elem) {
        var obj = {};
        obj.name = _getTagName(elem);
        obj.attrs = {};
        var attributes = _getAttributes(elem);
        if (attributes) {
            for (var i=0,ilen=attributes.length;i<ilen;i++) {
                var attr = {
                    name: attributes[i],
                    value: _getAttribute(elem, attributes[i])
                }
                obj.attrs[attr.name] = _decodeHtmlEntities(attr.value);
            }
        }
        obj.children = [];
        return obj;
    }
    function _extractTextFromCompositeElement(elem) {
        var m = elem.match(/^.*>([^<]*)<.*$/);
        return _decodeHtmlEntities(m[1]);
    }
    function _appendToChildren(obj) {
        _stack.slice(-1)[0].push(obj);
    }
    function _extendStackWithNewChildren(obj) {
        _stack.push(obj.children);
    }
    function processElement(elem) {
        var obj;
        if (elem.slice(1).indexOf('<') > -1) {
            var tag = elem.slice(0, elem.indexOf('>')+1);
            obj = _castObjectFromOpeningTag(tag);
            obj.children = [_extractTextFromCompositeElement(elem)];
            _appendToChildren(obj);
        } else if (elem.slice(-2) === '/>') {
            obj = _castObjectFromOpeningTag(elem);
            if (_getTagName(elem) === 'term') {
                obj.children.push('');
            }
            _appendToChildren(obj);
        } else if (elem.slice(0, 2) === '</') {
            _stack.pop();
        } else {
            obj = _castObjectFromOpeningTag(elem);
            _appendToChildren(obj)
            _extendStackWithNewChildren(obj);
        }
    }
    var lst = _listifyString(str);
    for (var i=0,ilen=lst.length;i<ilen;i++) {
        var elem = lst[i];
        processElement(elem);
    }
    return _obj.children[0];
}
module.exports = CSL;
CSL.XmlDOM = function (dataObj) {
    this.dataObj = dataObj;
    if ("undefined" == typeof DOMParser) {
        DOMParser = function() {};
        DOMParser.prototype.parseFromString = function(str, contentType) {
            if ("undefined" != typeof ActiveXObject) {
                var xmldata = new ActiveXObject('MSXML.DomDocument');
                xmldata.async = false;
                xmldata.loadXML(str);
                return xmldata;
            } else if ("undefined" != typeof XMLHttpRequest) {
                var xmldata = new XMLHttpRequest;
                if (!contentType) {
                    contentType = 'text/xml';
                }
                xmldata.open('GET', 'data:' + contentType + ';charset=utf-8,' + encodeURIComponent(str), false);
                if(xmldata.overrideMimeType) {
                    xmldata.overrideMimeType(contentType);
                }
                xmldata.send(null);
                return xmldata.responseXML;
            } else if ("undefined" != typeof marknote) {
                var parser = new marknote.Parser();
                return parser.parse(str);
            }
        };
        this.hasAttributes = function (node) {
            var ret;
            if (node.attributes && node.attributes.length) {
                ret = true;
            } else {
                ret = false;
            }
            return ret;
        };
    } else {
        this.hasAttributes = function (node) {
            var ret;
            if (node.attributes && node.attributes.length) {
                ret = true;
            } else {
                ret = false;
            }
            return ret;
        };
    }
    this.importNode = function (doc, srcElement) {
        if ("undefined" == typeof doc.importNode) {
            var ret = this._importNode(doc, srcElement, true);
        } else {
            var ret = doc.importNode(srcElement, true);
        }
        return ret;
    };
    this._importNode = function(doc, node, allChildren) {
        switch (node.nodeType) {
            case 1:
                var newNode = doc.createElement(node.nodeName);
                if (node.attributes && node.attributes.length > 0)
                    for (var i = 0, il = node.attributes.length; i < il;)
                        newNode.setAttribute(node.attributes[i].nodeName, node.getAttribute(node.attributes[i++].nodeName));
                    if (allChildren && node.childNodes && node.childNodes.length > 0)
                        for (var i = 0, il = node.childNodes.length; i < il;)
                            newNode.appendChild(this._importNode(doc, node.childNodes[i++], allChildren));
                return newNode;
                break;
            case 3:
            case 4:
            case 8:
        }
    };
    this.parser = new DOMParser();
    var str = "<docco><institution institution-parts=\"long\" delimiter=\", \" substitute-use-first=\"1\" use-last=\"1\"><institution-part name=\"long\"/></institution></docco>";
    var inst_doc = this.parser.parseFromString(str, "text/xml");
    var inst_node = inst_doc.getElementsByTagName("institution");
    this.institution = inst_node.item(0);
    var inst_part_node = inst_doc.getElementsByTagName("institution-part");
    this.institutionpart = inst_part_node.item(0);
    this.ns = "http://purl.org/net/xbiblio/csl";
};
CSL.XmlDOM.prototype.clean = function (xml) {
    xml = xml.replace(/<\?[^?]+\?>/g, "");
    xml = xml.replace(/<![^>]+>/g, "");
    xml = xml.replace(/^\s+/, "");
    xml = xml.replace(/\s+$/, "");
    xml = xml.replace(/^\n*/, "");
    return xml;
};
CSL.XmlDOM.prototype.getStyleId = function (myxml, styleName) {
    var text = "";
    var tagName = "id";
    if (styleName) {
        tagName = "title";
    }
    var node = myxml.getElementsByTagName(tagName);
    if (node && node.length) {
        node = node.item(0);
    }
    if (node) {
        text = node.textContent;
    }
    if (!text) {
        text = node.innerText;
    }
    if (!text) {
        text = node.innerHTML;
    }
    return text;
};
CSL.XmlDOM.prototype.children = function (myxml) {
    var children, pos, len, ret;
    if (myxml) {
        ret = [];
        children = myxml.childNodes;
        for (pos = 0, len = children.length; pos < len; pos += 1) {
            if (children[pos].nodeName != "#text") {
                ret.push(children[pos]);
            }
        }
        return ret;
    } else {
        return [];
    }
};
CSL.XmlDOM.prototype.nodename = function (myxml) {
    var ret = myxml.nodeName;
    return ret;
};
CSL.XmlDOM.prototype.attributes = function (myxml) {
    var ret, attrs, attr, key, xml, pos, len;
    ret = new Object();
    if (myxml && this.hasAttributes(myxml)) {
        attrs = myxml.attributes;
        for (pos = 0, len=attrs.length; pos < len; pos += 1) {
            attr = attrs[pos];
            ret["@" + attr.name] = attr.value;
        }
    }
    return ret;
};
CSL.XmlDOM.prototype.content = function (myxml) {
    var ret;
    if ("undefined" != typeof myxml.textContent) {
        ret = myxml.textContent;
    } else if ("undefined" != typeof myxml.innerText) {
        ret = myxml.innerText;
    } else {
        ret = myxml.txt;
    }
    return ret;
};
CSL.XmlDOM.prototype.namespace = {
    "xml":"http://www.w3.org/XML/1998/namespace"
}
CSL.XmlDOM.prototype.numberofnodes = function (myxml) {
    if (myxml) {
        return myxml.length;
    } else {
        return 0;
    }
};
CSL.XmlDOM.prototype.getAttributeName = function (attr) {
    var ret = attr.name;
    return ret;
}
CSL.XmlDOM.prototype.getAttributeValue = function (myxml,name,namespace) {
    var ret = "";
    if (namespace) {
        name = namespace+":"+name;
    }
    if (myxml && this.hasAttributes(myxml) && myxml.getAttribute(name)) {
        ret = myxml.getAttribute(name);
    }
    return ret;
}
CSL.XmlDOM.prototype.getNodeValue = function (myxml,name) {
    var ret = null;
    if (name){
        var vals = myxml.getElementsByTagName(name);
        if (vals.length > 0) {
            if ("undefined" != typeof vals[0].textContent) {
                ret = vals[0].textContent;
            } else if ("undefined" != typeof vals[0].innerText) {
                ret = vals[0].innerText;
            } else {
                ret = vals[0].text;
            }
        }
    }
    if (ret === null && myxml && myxml.childNodes && (myxml.childNodes.length == 0 || (myxml.childNodes.length == 1 && myxml.firstChild.nodeName == "#text"))) {
        if ("undefined" != typeof myxml.textContent) {
            ret = myxml.textContent;
        } else if ("undefined" != typeof myxml.innerText) {
            ret = myxml.innerText;
        } else {
            ret = myxml.text;
        }
    }
    if (ret === null) {
        ret = myxml;
    }
    return ret;
}
CSL.XmlDOM.prototype.setAttributeOnNodeIdentifiedByNameAttribute = function (myxml,nodename,partname,attrname,val) {
    var pos, len, xml, nodes, node;
    if (attrname.slice(0,1) === '@'){
        attrname = attrname.slice(1);
    }
    nodes = myxml.getElementsByTagName(nodename);
    for (pos = 0, len = nodes.length; pos < len; pos += 1) {
        node = nodes[pos];
        if (node.getAttribute("name") != partname) {
            continue;
        }
        node.setAttribute(attrname, val);
    }
}
CSL.XmlDOM.prototype.deleteNodeByNameAttribute = function (myxml,val) {
    var pos, len, node, nodes;
    nodes = myxml.childNodes;
    for (pos = 0, len = nodes.length; pos < len; pos += 1) {
        node = nodes[pos];
        if (!node || node.nodeType == node.TEXT_NODE) {
            continue;
        }
        if (this.hasAttributes(node) && node.getAttribute("name") == val) {
            myxml.removeChild(nodes[pos]);
        }
    }
}
CSL.XmlDOM.prototype.deleteAttribute = function (myxml,attr) {
    myxml.removeAttribute(attr);
}
CSL.XmlDOM.prototype.setAttribute = function (myxml,attr,val) {
    if (!myxml.ownerDocument) {
        myxml = myxml.firstChild;
    }
    if (["function", "unknown"].indexOf(typeof myxml.setAttribute) > -1) {
        myxml.setAttribute(attr, val);
    }
    return false;
}
CSL.XmlDOM.prototype.nodeCopy = function (myxml) {
    var cloned_node = myxml.cloneNode(true);
    return cloned_node;
}
CSL.XmlDOM.prototype.getNodesByName = function (myxml,name,nameattrval) {
    var ret, nodes, node, pos, len;
    ret = [];
    nodes = myxml.getElementsByTagName(name);
    for (pos = 0, len = nodes.length; pos < len; pos += 1) {
        node = nodes.item(pos);
        if (nameattrval && !(this.hasAttributes(node) && node.getAttribute("name") == nameattrval)) {
            continue;
        }
        ret.push(node);
    }
    return ret;
}
CSL.XmlDOM.prototype.nodeNameIs = function (myxml,name) {
    if (name == myxml.nodeName) {
        return true;
    }
    return false;
}
CSL.XmlDOM.prototype.makeXml = function (myxml) {
    var ret, topnode;
    if (!myxml) {
        myxml = "<docco><bogus/></docco>";
    }
    myxml = myxml.replace(/\s*<\?[^>]*\?>\s*\n*/g, "");
    var nodetree = this.parser.parseFromString(myxml, "application/xml");
    return nodetree.firstChild;
};
CSL.XmlDOM.prototype.insertChildNodeAfter = function (parent,node,pos,datexml) {
    var myxml, xml;
    myxml = this.importNode(node.ownerDocument, datexml);
    parent.replaceChild(myxml, node);
     return parent;
};
CSL.XmlDOM.prototype.insertPublisherAndPlace = function(myxml) {
    var group = myxml.getElementsByTagName("group");
    for (var i = 0, ilen = group.length; i < ilen; i += 1) {
        var node = group.item(i);
        var skippers = [];
        for (var j = 0, jlen = node.childNodes.length; j < jlen; j += 1) {
            if (node.childNodes.item(j).nodeType !== 1) {
                skippers.push(j);
            }
        }
        if (node.childNodes.length - skippers.length === 2) {
            var twovars = [];
            for (var j = 0, jlen = 2; j < jlen; j += 1) {
                if (skippers.indexOf(j) > -1) {
                    continue;
                }
                var child = node.childNodes.item(j);                    
                var subskippers = [];
                for (var k = 0, klen = child.childNodes.length; k < klen; k += 1) {
                    if (child.childNodes.item(k).nodeType !== 1) {
                        subskippers.push(k);
                    }
                }
                if (child.childNodes.length - subskippers.length === 0) {
                    twovars.push(child.getAttribute('variable'));
                    if (child.getAttribute('suffix')
                        || child.getAttribute('prefix')) {
                        twovars = [];
                        break;
                    }
                }
            }
            if (twovars.indexOf("publisher") > -1 && twovars.indexOf("publisher-place") > -1) {
                node.setAttribute('has-publisher-and-publisher-place', true);
            }
        }
    }
};
CSL.XmlDOM.prototype.isChildOfSubstitute = function(node) {
    if (node.parentNode) {
        if (node.parentNode.tagName.toLowerCase() === "substitute") {
            return true;
        } else {
            return this.isChildOfSubstitute(node.parentNode);
        }
    }
    return false;
};
CSL.XmlDOM.prototype.addMissingNameNodes = function(myxml) {
    var nameslist = myxml.getElementsByTagName("names");
    for (var i = 0, ilen = nameslist.length; i < ilen; i += 1) {
        var names = nameslist.item(i);
        var namelist = names.getElementsByTagName("name");
        if ((!namelist || namelist.length === 0)
            && !this.isChildOfSubstitute(names)) {
            var doc = names.ownerDocument;
            var name = doc.createElement("name");
            names.appendChild(name);
        }
    }
};
CSL.XmlDOM.prototype.addInstitutionNodes = function(myxml) {
    var names, thenames, institution, theinstitution, name, thename, xml, pos, len;
    names = myxml.getElementsByTagName("names");
    for (pos = 0, len = names.length; pos < len; pos += 1) {
        thenames = names.item(pos);
        name = thenames.getElementsByTagName("name");
        if (name.length == 0) {
            continue;
        }
        institution = thenames.getElementsByTagName("institution");
        if (institution.length == 0) {
            theinstitution = this.importNode(myxml.ownerDocument, this.institution);
            theinstitutionpart = theinstitution.getElementsByTagName("institution-part").item(0);
            thename = name.item(0);
            thenames.insertBefore(theinstitution, thename.nextSibling);
            for (var j = 0, jlen = CSL.INSTITUTION_KEYS.length; j < jlen; j += 1) {
                var attrname = CSL.INSTITUTION_KEYS[j];
                var attrval = thename.getAttribute(attrname);
                if (attrval) {
                    theinstitutionpart.setAttribute(attrname, attrval);
                }
            }
            var nameparts = thename.getElementsByTagName("name-part");
            for (var j = 0, jlen = nameparts.length; j < jlen; j += 1) {
                if ('family' === nameparts[j].getAttribute('name')) {
                    for (var k = 0, klen = CSL.INSTITUTION_KEYS.length; k < klen; k += 1) {
                        var attrname = CSL.INSTITUTION_KEYS[k];
                        var attrval = nameparts[j].getAttribute(attrname);
                        if (attrval) {
                            theinstitutionpart.setAttribute(attrname, attrval);
                        }
                    }
                }
            }
        }
    }
};
CSL.XmlDOM.prototype.flagDateMacros = function(myxml) {
    var pos, len, thenode, thedate;
    nodes = myxml.getElementsByTagName("macro");
    for (pos = 0, len = nodes.length; pos < len; pos += 1) {
        thenode = nodes.item(pos);
        thedate = thenode.getElementsByTagName("date");
        if (thedate.length) {
            thenode.setAttribute('macro-has-date', 'true');
        }
    }
};
module.exports = CSL;
if ("undefined" !== typeof XML) {
    try {
    } catch (e) {
        throw "OOPS: "+e;
    }
}
module.exports = CSL;
CSL.setupXml = function(xmlObject) {
    var dataObj = {};
    var parser = null;
    if ("undefined" !== typeof xmlObject) {
        if ("string" === typeof xmlObject) {
            xmlObject = xmlObject.replace("^\uFEFF", "")
                .replace(/^\s+/, "");
            if (xmlObject.slice(0, 1) === "<") {
                dataObj = CSL.parseXml(xmlObject);
            } else {
                dataObj = JSON.parse(xmlObject);
            }
            parser = new CSL.XmlJSON(dataObj);
        } else if ("undefined" !== typeof xmlObject.getAttribute) {
            parser = new CSL.XmlDOM(xmlObject);
        } else if ("undefined" !== typeof xmlObject.toXMLString) {
            parser = new CSL.XmlE4X(xmlObject);
        } else {
            parser = new CSL.XmlJSON(xmlObject);
        }
    } else {
        CSL.error("unable to parse XML input");
    }
    if (!parser) {
        throw "citeproc-js error: unable to parse CSL style or locale object";
    }
    return parser;
}
module.exports = CSL;
CSL.getSortCompare = function (default_locale) {
    if (CSL.stringCompare) {
        return CSL.stringCompare;
    }
    var strcmp;
    var strcmp_opts = {
        sensitivity:"base",
        ignorePunctuation:true,
        numeric:true
   }
    if (!default_locale) {
        default_locale = "en-US";
    }
    strcmp = function (a, b) {
        return a.toLocaleLowerCase().localeCompare(b.toLocaleLowerCase(),default_locale,strcmp_opts);
    };
    var stripPunct = function (str) {
        return str.replace(/^[\[\]\'\"]*/g, "");
    }
    var getBracketPreSort = function () {
        if (!strcmp("[x","x")) {
            return false;
        } else {
            return function (a, b) {
                return strcmp(stripPunct(a), stripPunct(b));
            }
        }
    }
    var bracketPreSort = getBracketPreSort();
    var sortCompare = function (a, b) {
        if (bracketPreSort) {
            return bracketPreSort(a, b);
        } else {
            return strcmp(a, b);
        }
    }
    return sortCompare;
};
module.exports = CSL;
CSL.ambigConfigDiff = function(a, b) {
    var ret, pos, len, ppos, llen;
    if (a.names.length !== b.names.length) {
        return 1;
    } else {
        for (pos = 0, len = a.names.length; pos < len; pos += 1) {
            if (a.names[pos] !== b.names[pos]) {
                return 1;
            } else {
                for (ppos = 0, llen = a.givens[pos]; ppos < llen; ppos += 1) {
                    if (a.givens[pos][ppos] !== b.givens[pos][ppos]) {
                        return 1;
                    }
                }
            }
        }
    }
    if (a.disambiguate != b.disambiguate) {
        return 1;
    }
    if (a.year_suffix !== b.year_suffix) {
        return 1;
    }
    return 0;
};
CSL.cloneAmbigConfig = function (config, oldconfig, tainters) {
    var i, ilen, j, jlen, k, klen, param;
    var ret = {};
    ret.names = [];
    ret.givens = [];
    ret.year_suffix = false;
    ret.disambiguate = false;
    for (i = 0, ilen = config.names.length; i < ilen; i += 1) {
        param = config.names[i];
        ret.names[i] = param;
    }
    for (i  = 0, ilen = config.givens.length; i < ilen; i += 1) {
        param = [];
        for (j = 0, jlen = config.givens[i].length; j < jlen; j += 1) {
            param.push(config.givens[i][j]);
        }
        ret.givens.push(param);
    }
    if (oldconfig) {
        ret.year_suffix = oldconfig.year_suffix;
        ret.disambiguate = oldconfig.disambiguate;
    } else {
        ret.year_suffix = config.year_suffix;
        ret.disambiguate = config.disambiguate;
    }
    return ret;
};
CSL.getAmbigConfig = function () {
    var config, ret;
    config = this.tmp.disambig_request;
    if (!config) {
        config = this.tmp.disambig_settings;
    }
    var ret = CSL.cloneAmbigConfig(config);
    return ret;
};
CSL.getMaxVals = function () {
    return this.tmp.names_max.mystack.slice();
};
CSL.getMinVal = function () {
    return this.tmp["et-al-min"];
};
module.exports = CSL;
CSL.tokenExec = function (token, Item, item) {
    var next, maybenext, exec, debug;
    debug = false;
    next = token.next;
    maybenext = false;
    var record = function (result) {
        if (result) {
            this.tmp.jump.replace("succeed");
            return token.succeed;
        } else {
            this.tmp.jump.replace("fail");
            return token.fail;
        }
    }
    if (token.test) {
        next = record.call(this,token.test(Item, item));
    }
    for (var i=0,ilen=token.execs.length;i<ilen;i++) {
        exec = token.execs[i];
        maybenext = exec.call(token, this, Item, item);
        if (maybenext) {
            next = maybenext;
        }
    }
    return next;
};
CSL.expandMacro = function (macro_key_token, target) {
    var mkey, start_token, key, end_token, navi, macro_nodes, newoutput, mergeoutput, end_of_macro, func;
    mkey = macro_key_token.postponed_macro;
    macro_key_token = new CSL.Token("group", CSL.START);
    var hasDate = false;
    var macroid = false;
    macro_nodes = this.cslXml.getNodesByName(this.cslXml.dataObj, 'macro', mkey);
    if (macro_nodes.length) {
        macroid = this.cslXml.getAttributeValue(macro_nodes[0],'cslid');
        hasDate = this.cslXml.getAttributeValue(macro_nodes[0], "macro-has-date");
    }
    if (hasDate) {
        mkey = mkey + "@" + this.build.current_default_locale;
        func = function (state, Item) {
            if (state.tmp.extension) {
                state.tmp["doing-macro-with-date"] = true;
            }
        };
        macro_key_token.execs.push(func);
    }
    if (this.build.macro_stack.indexOf(mkey) > -1) {
        throw "CSL processor error: call to macro \"" + mkey + "\" would cause an infinite loop";
    } else {
        this.build.macro_stack.push(mkey);
    }
    macro_key_token.cslid = macroid;
    if (CSL.MODULE_MACROS[mkey]) {
        macro_key_token.juris = mkey;
        this.opt.update_mode = CSL.POSITION;
    }
    CSL.Node.group.build.call(macro_key_token, this, target, true);
    if (!this.cslXml.getNodeValue(macro_nodes)) {
        throw "CSL style error: undefined macro \"" + mkey + "\"";
    }
    var mytarget = CSL.getMacroTarget.call(this, mkey);
    if (mytarget) {
        CSL.buildMacro.call(this, mytarget, macro_nodes);
        CSL.configureMacro.call(this, mytarget);
    }
    if (!this.build.extension) {
        var func = function(macro_name) {
            return function (state, Item, item) {
                var next = 0;
                while (next < state.macros[macro_name].length) {
                    next = CSL.tokenExec.call(state, state.macros[macro_name][next], Item, item);
                }
            }
        }(mkey);
        var text_node = new CSL.Token("text", CSL.SINGLETON);
        text_node.execs.push(func);
        target.push(text_node);
    }
    end_of_macro = new CSL.Token("group", CSL.END);
    if (hasDate) {
        func = function (state, Item) {
            if (state.tmp.extension) {
                state.tmp["doing-macro-with-date"] = false;
            }
        };
        end_of_macro.execs.push(func);
    }
    if (macro_key_token.juris) {
        end_of_macro.juris = mkey;
     }
    CSL.Node.group.build.call(end_of_macro, this, target, true);
    this.build.macro_stack.pop();
};
CSL.getMacroTarget = function (mkey) {
    var mytarget = false;
    if (this.build.extension) {
        mytarget = this[this.build.root + this.build.extension].tokens;
    } else if (!this.macros[mkey]) {
        mytarget = [];
        this.macros[mkey] = mytarget;
    }
    return mytarget;
}
CSL.buildMacro = function (mytarget, macro_nodes) {
    var builder = CSL.makeBuilder(this, mytarget);
    var mynode;
    if ("undefined" === typeof macro_nodes.length) {
        mynode = macro_nodes;
    } else {
        mynode = macro_nodes[0];
    }
    builder(mynode);
}
CSL.configureMacro = function (mytarget) {
    if (!this.build.extension) {
        this.configureTokenList(mytarget);
    }
}
CSL.XmlToToken = function (state, tokentype, explicitTarget) {
    var name, txt, attrfuncs, attributes, decorations, token, key, target;
    name = state.cslXml.nodename(this);
    if (state.build.skip && state.build.skip !== name) {
        return;
    }
    if (!name) {
        txt = state.cslXml.content(this);
        if (txt) {
            state.build.text = txt;
        }
        return;
    }
    if (!CSL.Node[state.cslXml.nodename(this)]) {
        throw "Undefined node name \"" + name + "\".";
    }
    attrfuncs = [];
    attributes = state.cslXml.attributes(this);
    decorations = CSL.setDecorations.call(this, state, attributes);
    token = new CSL.Token(name, tokentype);
    if (tokentype !== CSL.END || name === "if" || name === "else-if" || name === "layout") {
        for (var key in attributes) {
            if (attributes.hasOwnProperty(key)) {
                if (tokentype === CSL.END && key !== "@language" && key !== "@locale") {
                    continue;
                }
                if (attributes.hasOwnProperty(key)) {
                    if (CSL.Attributes[key]) {
                        try {
                            CSL.Attributes[key].call(token, state, "" + attributes[key]);
                        } catch (e) {
                            CSL.error(e);
                            throw "CSL processor error, " + key + " attribute: " + e;
                        }
                    } else {
                        CSL.debug("warning: undefined attribute \""+key+"\" in style");
                    }
                }
            }
        }
        token.decorations = decorations;
    } else if (tokentype === CSL.END && attributes['@variable']) {
        token.hasVariable = true;
        if (CSL.DATE_VARIABLES.indexOf(attributes['@variable']) > -1) {
            token.variables = attributes['@variable'].split(/\s+/);
        }
    }
    if (explicitTarget) {
        target = explicitTarget;
    } else {
        target = state[state.build.area].tokens;
    }
    CSL.Node[name].build.call(token, state, target, true);
};
module.exports = CSL;
CSL.DateParser = new function () {
    var epochPairs = [
        ["\u660E\u6CBB", 1867],
        ["\u5927\u6B63", 1911],
        ["\u662D\u548C", 1925],
        ["\u5E73\u6210", 1988]
    ];
    var epochYearByName = {};
    for (var i=0,ilen=epochPairs.length; i<ilen; i++) {
        var key = epochPairs[i][0];
        var val = epochPairs[i][1];
        epochYearByName[key] = val;
    }
    var epochMatchStrings = [];
    for (var i=0,ilen=epochPairs.length; i<ilen; i++) {
        var val = epochPairs[i][0];
        epochMatchStrings.push(val);
    }
    var epochMatchString = epochMatchStrings.join("|");
    var epochSplitter = new RegExp("(?:" + epochMatchString + ")(?:[0-9]+)");
    var epochMatcher = new RegExp("(?:" + epochMatchString + ")(?:[0-9]+)", "g");
    var kanjiMonthDay = /(\u6708|\u5E74)/g;
    var kanjiYear = /\u65E5/g;
    var kanjiRange = /\u301c/g;
    var yearLast = "(?:[?0-9]{1,2}%%NUMD%%){0,2}[?0-9]{4}(?![0-9])";
    var yearFirst = "[?0-9]{4}(?:%%NUMD%%[?0-9]{1,2}){0,2}(?![0-9])";
    var numberVal = "[?0-9]{1,3}";
    var rangeSeparator = "[%%DATED%%]";
    var fuzzyChar = "[?~]";
    var chars = "[^\-\/\~\?0-9]+";
    var rexString = "(" + yearFirst + "|" + yearLast + "|" + numberVal + "|" + rangeSeparator + "|" + fuzzyChar + "|" + chars + ")";
    var rexDash = new RegExp(rexString.replace(/%%NUMD%%/g, "-").replace(/%%DATED%%/g, "-"));
    var rexDashSlash = new RegExp(rexString.replace(/%%NUMD%%/g, "-").replace(/%%DATED%%/g, "\/"));
    var rexSlashDash = new RegExp(rexString.replace(/%%NUMD%%/g, "\/").replace(/%%DATED%%/g, "-"));
    var monthString = "january february march april may june july august september october november december spring summer fall winter spring summer";
    this.monthStrings = monthString.split(" ");
    this.setOrderDayMonth = function() {
        this.monthGuess = 1;
        this.dayGuess = 0;
    };
    this.setOrderMonthDay = function() {
        this.monthGuess = 0;
        this.dayGuess = 1;
    };
    this.resetDateParserMonths = function() {
        this.monthSets = [];
        for (var i=0,ilen=this.monthStrings.length; i<ilen; i++) {
            this.monthSets.push([this.monthStrings[i]]);
        }
        this.monthAbbrevs = [];
        for (var i=0,ilen=this.monthSets.length; i<ilen; i++) {
            this.monthAbbrevs.push([]);
            for (var j=0,jlen=this.monthSets[i].length; j<jlen; j++) {
                this.monthAbbrevs[i].push(this.monthSets[i][0].slice(0, 3));
            }
        }
        this.monthRexes = [];
        for (var i=0,ilen=this.monthAbbrevs.length; i<ilen; i++) {
            this.monthRexes.push(new RegExp("(?:" + this.monthAbbrevs[i].join("|") + ")"));
        }
    };
    this.addDateParserMonths = function(lst) {
        if ("string" === typeof lst) {
            lst = lst.split(/\s+/);
        }
        if (lst.length !== 12 && lst.length !== 16) {
            CSL.debug("month [+season] list of "+lst.length+", expected 12 or 16. Ignoring.");
            return;
        }
        var otherMatch = [];
        var thisMatch = [];
        for (var i=0,ilen=lst.length; i<ilen; i++) {
            var abbrevLength = null;
            var skip = false;
            var insert = 3;
            var extendedSets = {};
            for (var j=0,jlen=this.monthAbbrevs.length; j<jlen; j++) {
                extendedSets[j] = {};
                if (j === i) {
                    for (var k=0,klen=this.monthAbbrevs[i].length; k<klen; k++) {
                        if (this.monthAbbrevs[i][k] === lst[i].slice(0, this.monthAbbrevs[i][k].length)) {
                            skip = true;
                            break;
                        }
                    }
                } else {
                    for (var k=0,klen=this.monthAbbrevs[j].length; k<klen; k++) {
                        abbrevLength = this.monthAbbrevs[j][k].length;
                        if (this.monthAbbrevs[j][k] === lst[i].slice(0, abbrevLength)) {
                            while (this.monthSets[j][k].slice(0, abbrevLength) === lst[i].slice(0, abbrevLength)) {
                                if (abbrevLength > lst[i].length || abbrevLength > this.monthSets[j][k].length) {
                                    CSL.debug("unable to disambiguate month string in date parser: "+lst[i]);
                                    break;
                                } else {
                                    abbrevLength += 1;
                                }
                            }
                            insert = abbrevLength;
                            extendedSets[j][k] = abbrevLength;
                        }
                    }
                }
                for (var jKey in extendedSets) {
                    for (kKey in extendedSets[jKey]) {
                        abbrevLength = extendedSets[jKey][kKey];
                        jKey = parseInt(jKey, 10);
                        kKey = parseInt(kKey, 10);
                        this.monthAbbrevs[jKey][kKey] = this.monthSets[jKey][kKey].slice(0, abbrevLength);
                    }
                }
            }
            if (!skip) {
                this.monthSets[i].push(lst[i]);
                this.monthAbbrevs[i].push(lst[i].slice(0, insert));
            }
        }
        this.monthRexes = [];
        this.monthRexStrs = [];
        for (var i=0,ilen=this.monthAbbrevs.length; i<ilen; i++) {
            this.monthRexes.push(new RegExp("^(?:" + this.monthAbbrevs[i].join("|") + ")"));
            this.monthRexStrs.push("^(?:" + this.monthAbbrevs[i].join("|") + ")");
        }
        if (this.monthAbbrevs.length === 18) {
            for (var i=12,ilen=14; i<ilen; i++) {
                this.monthRexes[i+4] = new RegExp("^(?:" + this.monthAbbrevs[i].join("|") + ")");
                this.monthRexStrs[i+4] = "^(?:" + this.monthAbbrevs[i].join("|") + ")";
            }
        }
    };
    this.convertDateObjectToArray = function (thedate) {
        thedate["date-parts"] = [];
        thedate["date-parts"].push([]);
        var slicelen = 0;
        for (var i=0,ilen=3; i<ilen; i++) {
            var part = ["year", "month", "day"][i];
            if (!thedate[part]) {
                break;
            }
            slicelen += 1;
            thedate["date-parts"][0].push(thedate[part]);
            delete thedate[part];
        }
        thedate["date-parts"].push([]);
        for (var i=0, ilen=slicelen; i<ilen; i++) {
            part = ["year_end", "month_end", "day_end"][i];
            if (!thedate[part]) {
                break;
            }
            thedate["date-parts"][1].push(thedate[part]);
            delete thedate[part];
        }
        if (thedate["date-parts"][0].length !== thedate["date-parts"][1].length) {
            thedate["date-parts"].pop();
        }
        return thedate;
    };
    this.convertDateObjectToString = function(thedate) {
        var ret = [];
        for (var i = 0, ilen = 3; i < ilen; i += 1) {
            if (thedate[DATE_PARTS_ALL[i]]) {
                ret.push(thedate[DATE_PARTS_ALL[i]]);
            } else {
                break;
            }
        }
        return ret.join("-");
    }
    this._parseNumericDate = function (ret, delim, suff, txt) {
        if (!suff) suff = "";
        var lst = txt.split(delim);
        for (var i=0, ilen=lst.length; i<ilen; i++) {
            if (lst[i].length === 4) {
                ret[("year" + suff)] = lst[i].replace(/^0*/, "");
                if (!i) {
                    lst = lst.slice(1);
                } else {
                    lst = lst.slice(0, i);
                }
                break;
            }
        }
        for (var i=0,ilen=lst.length; i<ilen; i++) {
            lst[i] = parseInt(lst[i], 10);
        }
        if (lst.length === 1 || (lst.length === 2 && !lst[1])) {
            ret[("month" + suff)] = "" + lst[0];
        } else if (lst.length === 2) {
            if (lst[this.monthGuess] > 12) {
                ret[("month" + suff)] = "" + lst[this.dayGuess];
                ret[("day" + suff)] = "" + lst[this.monthGuess];
            } else {
                ret[("month" + suff)] = "" + lst[this.monthGuess];
                ret[("day" + suff)] = "" + lst[this.dayGuess];
            }
        }
    };
    this.parseDateToObject = function (txt) {
        var orig = txt;
        var slashPos = -1;
        var dashPos = -1;
        var yearIsNegative = false;
        var lst;
        if (txt) {
            if (txt.slice(0, 1) === "-") {
                yearIsNegative = true;
                txt = txt.slice(1);
            }
            if (txt.match(/^[0-9]{1,3}$/)) {
                while (txt.length < 4) {
                    txt = "0" + txt;
                }
            }
            txt = "" + txt;
            txt = txt.replace(/\s*[0-9]{2}:[0-9]{2}(?::[0-9]+)/,"");
            var m = txt.match(kanjiMonthDay);
            if (m) {
                txt = txt.replace(/\s+/g, "");
                txt = txt.replace(kanjiYear, "");
                txt = txt.replace(kanjiMonthDay, "-");
                txt = txt.replace(kanjiRange, "/");
                txt = txt.replace(/\-\//g, "/");
                txt = txt.replace(/-$/g,"");
                var slst = txt.split(epochSplitter);
                lst = [];
                var mm = txt.match(epochMatcher);
                if (mm) {
                    var mmx = [];
                    for (var i=0,ilen=mm.length; i<ilen; i++) {
                        mmx = mmx.concat(mm[i].match(/([^0-9]+)([0-9]+)/).slice(1));
                    }
                    for (var i=0,ilen=slst.length; i<ilen; i++) {
                        lst.push(slst[i]);
                        if (i !== (len - 1)) {
                            var mmpos = (pos * 2);
                            lst.push(mmx[mmpos]);
                            lst.push(mmx[mmpos + 1]);
                        }
                    }
                } else {
                    lst = slst;
                }
                for (var i=1,ilen=lst.length; i<ilen; i+=3) {
                    lst[i + 1] = jiy[lst[i]] + parseInt(lst[i + 1], 10);
                    lst[i] = "";
                }
                txt = lst.join("");
                txt = txt.replace(/\s*-\s*$/, "").replace(/\s*-\s*\//, "/");
                txt = txt.replace(/\.\s*$/, "");
                txt = txt.replace(/\.(?! )/, "");
                slashPos = txt.indexOf("/");
                dashPos = txt.indexOf("-");
            }
        }
        txt = txt.replace(/([A-Za-z])\./g, "$1");
        var number = "";
        var note = "";
        var thedate = {};
        var rangeDelim;
        var dateDelim;
        if (txt.slice(0, 1) === "\"" && txt.slice(-1) === "\"") {
            thedate.literal = txt.slice(1, -1);
            return thedate;
        }
        if (slashPos > -1 && dashPos > -1) {
            var slashCount = txt.split("/");
            if (slashCount.length > 3) {
                rangeDelim = "-";
                txt = txt.replace(/\_/g, "-");
                dateDelim = "/";
                lst = txt.split(rexSlashDash);
            } else {
                rangeDelim = "/";
                txt = txt.replace(/\_/g, "/");
                dateDelim = "-";
                lst = txt.split(rexDashSlash);
            }
        } else {
            txt = txt.replace(/\//g, "-");
            txt = txt.replace(/\_/g, "-");
            rangeDelim = "-";
            dateDelim = "-";
            lst = txt.split(rexDash);
        }
        var ret = [];
        for (var i=0,ilen=lst.length; i<ilen; i++) {
            var m = lst[i].match(/^\s*([\-\/]|[^\-\/\~\?0-9]+|[\-~?0-9]+)\s*$/);
            if (m) {
                ret.push(m[1]);
            }
        }
        var delimPos = ret.indexOf(rangeDelim);
        var delims = [];
        var isRange = false;
        if (delimPos > -1) {
            delims.push([0, delimPos]);
            delims.push([(delimPos + 1), ret.length]);
            isRange = true;
        } else {
            delims.push([0, ret.length]);
        }
        var suff = "";
        for (var i=0,ilen=delims.length; i<ilen; i++) {
            var delim = delims[i];
            var date = ret.slice(delim[0], delim[1]);
            outer: 
            for (var j=0,jlen=date.length; j<jlen; j++) {
                var element = date[j];
                if (element.indexOf(dateDelim) > -1) {
                    this._parseNumericDate(thedate, dateDelim, suff, element);
                    continue;
                }
                if (element.match(/[0-9]{4}/)) {
                    thedate[("year" + suff)] = element.replace(/^0*/, "");
                    continue;
                }
                for (var k=0,klen=this.monthRexes.length; k<klen; k++) {
                    if (element.toLocaleLowerCase().match(this.monthRexes[k])) {
                        thedate[("month" + suff)] = "" + (parseInt(k, 10) + 1);
                        continue outer;
                    }
                }
                if (element.match(/^[0-9]+$/)) {
                    number = element;
                }
                if (element.toLocaleLowerCase().match(/^bc/) && number) {
                    thedate[("year" + suff)] = "" + (number * -1);
                    number = "";
                    continue;
                }
                if (element.toLocaleLowerCase().match(/^ad/) && number) {
                    thedate[("year" + suff)] = "" + number;
                    number = "";
                    continue;
                }
                if (element === "~" || element === "?" || element === "c" || element.match(/^cir/)) {
                    thedate.circa = "" + 1;
                    continue;
                }
                if (element.toLocaleLowerCase().match(/(?:mic|tri|hil|eas)/) && !thedate[("season" + suff)]) {
                    note = element;
                    continue;
                }
            }
            if (number) {
                thedate[("day" + suff)] = number;
                number = "";
            }
            if (note && !thedate[("season" + suff)]) {
                thedate[("season" + suff)] = note;
                note = "";
            }
            suff = "_end";
        }
        if (isRange) {
            for (var j=0,jlen=CSL.DATE_PARTS_ALL.length; j<jlen; j++) {
                var item = CSL.DATE_PARTS_ALL[j];
                if (thedate[item] && !thedate[(item + "_end")]) {
                    thedate[(item + "_end")] = thedate[item];
                } else if (!thedate[item] && thedate[(item + "_end")]) {
                    thedate[item] = thedate[(item + "_end")];
                }
            }
        }
        if (!thedate.year || (thedate.year && thedate.day && !thedate.month)) {
            thedate = { "literal": orig };
        }
        var parts = ["year", "month", "day", "year_end", "month_end", "day_end"];
        for (var i=0,ilen=parts.length; i<ilen; i++) {
            var part = parts[i];
            if ("string" === typeof thedate[part] && thedate[part].match(/^[0-9]+$/)) {
                thedate[part] = parseInt(thedate[part], 10);
            }
        }
        if (yearIsNegative && Object.keys(thedate).indexOf("year") > -1) {
            thedate.year = (thedate.year * -1);
        }
        return thedate;
    };
    this.parseDateToArray = function(txt) {
        return this.convertDateObjectToArray(this.parseDateToObject(txt));            
    }
    this.parseDateToString = function(txt) {
        return this.convertDateObjectToString(this.parseDateToObject(txt));
    }
    this.parse = function(txt) {
        return this.parseDateToObject(txt);
    }
    this.setOrderMonthDay();
    this.resetDateParserMonths();
};
module.exports = CSL;
CSL.Engine = function (sys, style, lang, forceLang) {
    var attrs, langspec, localexml, locale;
    this.processor_version = CSL.PROCESSOR_VERSION;
    this.csl_version = "1.0";
    this.sys = sys;
    if (sys.variableWrapper) {
        CSL.VARIABLE_WRAPPER_PREPUNCT_REX = new RegExp('^([' + [" "].concat(CSL.SWAPPING_PUNCTUATION).join("") + ']*)(.*)');
    }
    if (CSL.retrieveStyleModule) {
        this.sys.retrieveStyleModule = CSL.retrieveStyleModule;
    }
    if (CSL.getAbbreviation) {
        this.sys.getAbbreviation = CSL.getAbbreviation;
    }
    if (this.sys.stringCompare) {
        CSL.stringCompare = this.sys.stringCompare;
    }
    this.sys.AbbreviationSegments = CSL.AbbreviationSegments;
    this.parallel = new CSL.Parallel(this);
    this.transform = new CSL.Transform(this);
    this.setParseNames = function (val) {
        this.opt['parse-names'] = val;
    };
    this.opt = new CSL.Engine.Opt();
    this.tmp = new CSL.Engine.Tmp();
    this.build = new CSL.Engine.Build();
    this.fun = new CSL.Engine.Fun(this);
    this.configure = new CSL.Engine.Configure();
    this.citation_sort = new CSL.Engine.CitationSort();
    this.bibliography_sort = new CSL.Engine.BibliographySort();
    this.citation = new CSL.Engine.Citation(this);
    this.bibliography = new CSL.Engine.Bibliography();
    this.output = new CSL.Output.Queue(this);
    this.dateput = new CSL.Output.Queue(this);
    this.cslXml = CSL.setupXml(style);
    if (this.opt.development_extensions.csl_reverse_lookup_support || this.sys.csl_reverse_lookup_support) {
        this.build.cslNodeId = 0;
        this.setCslNodeIds = function(myxml, nodename) {
            var children = this.cslXml.children(myxml);
            this.cslXml.setAttribute(myxml, 'cslid', this.build.cslNodeId);
            this.opt.nodenames.push(nodename);
            this.build.cslNodeId += 1;
            for (var i = 0, ilen = this.cslXml.numberofnodes(children); i < ilen; i += 1) {
                nodename = this.cslXml.nodename(children[i]);
                if (nodename) {
                    this.setCslNodeIds(children[i], nodename);
                }
            }
        };
        this.setCslNodeIds(this.cslXml.dataObj, "style");
    }
    this.cslXml.addMissingNameNodes(this.cslXml.dataObj);
    this.cslXml.addInstitutionNodes(this.cslXml.dataObj);
    this.cslXml.insertPublisherAndPlace(this.cslXml.dataObj);
    this.cslXml.flagDateMacros(this.cslXml.dataObj);
    attrs = this.cslXml.attributes(this.cslXml.dataObj);
    if ("undefined" === typeof attrs["@sort-separator"]) {
        this.cslXml.setAttribute(this.cslXml.dataObj, "sort-separator", ", ");
    }
    this.opt["initialize-with-hyphen"] = true;
    this.setStyleAttributes();
    this.opt.xclass = this.cslXml.getAttributeValue(this.cslXml.dataObj, "class");
    this.opt["class"] = this.opt.xclass;
    this.opt.styleID = this.cslXml.getStyleId(this.cslXml.dataObj);
    if (CSL.setSuppressedJurisdictions) {
        CSL.setSuppressedJurisdictions(this.opt.styleID, this.opt.suppressedJurisdictions);
    }
    this.opt.styleName = this.cslXml.getStyleId(this.cslXml.dataObj, true);
    if (this.opt.version.slice(0,4) === "1.1m") {
        this.opt.development_extensions.static_statute_locator = true;
        this.opt.development_extensions.handle_parallel_articles = true;
        this.opt.development_extensions.main_title_from_short_title = true;
        this.opt.development_extensions.rtl_support = true;
        this.opt.development_extensions.expect_and_symbol_form = true;
        this.opt.development_extensions.require_explicit_legal_case_title_short = true;
        this.opt.development_extensions.force_jurisdiction = true;
    }
    if (lang) {
        lang = lang.replace("_", "-");
        lang = CSL.normalizeLocaleStr(lang);
    }
    if (this.opt["default-locale"][0]) {
        this.opt["default-locale"][0] = this.opt["default-locale"][0].replace("_", "-");
        this.opt["default-locale"][0] = CSL.normalizeLocaleStr(this.opt["default-locale"][0]);
    }
    if (lang && forceLang) {
        this.opt["default-locale"] = [lang];
    }
    if (lang && !forceLang && this.opt["default-locale"][0]) {
        lang = this.opt["default-locale"][0];
    }
    if (this.opt["default-locale"].length === 0) {
        if (!lang) {
            lang = "en-US";
        }
        this.opt["default-locale"].push("en-US");
    }
    if (!lang) {
        lang = this.opt["default-locale"][0];
    }
    langspec = CSL.localeResolve(lang);
    this.opt.lang = langspec.best;
    this.opt["default-locale"][0] = langspec.best;
    this.locale = {};
    if (!this.opt["default-locale-sort"]) {
        this.opt["default-locale-sort"] = this.opt["default-locale"][0];
    }
    if ('dale|'.localeCompare('daleb', this.opt["default-locale-sort"]) > -1) {
        this.opt.sort_sep = "@";
    } else {
        this.opt.sort_sep = "|";
    }
    this.localeConfigure(langspec);
    function makeRegExp(lst) {
        var lst = lst.slice();
        var ret = new RegExp( "(?:(?:[?!:]*\\s+|-|^)(?:" + lst.join("|") + ")(?=[!?:]*\\s+|-|$))", "g");
        return ret;
    }
    this.locale[this.opt.lang].opts["skip-words-regexp"] = makeRegExp(this.locale[this.opt.lang].opts["skip-words"]);
    this.output.adjust = new CSL.Output.Queue.adjust(this.getOpt('punctuation-in-quote'));
    this.registry = new CSL.Registry(this);
    this.macros = {};
    this.build.area = "citation";
    var area_nodes = this.cslXml.getNodesByName(this.cslXml.dataObj, this.build.area);
    this.buildTokenLists(area_nodes, this[this.build.area].tokens);
    this.build.area = "bibliography";
    var area_nodes = this.cslXml.getNodesByName(this.cslXml.dataObj, this.build.area);
    this.buildTokenLists(area_nodes, this[this.build.area].tokens);
    this.juris = {};
    this.configureTokenLists();
    this.disambiguate = new CSL.Disambiguation(this);
    this.splice_delimiter = false;
    this.fun.dateparser = CSL.DateParser;
    this.fun.flipflopper = new CSL.Util.FlipFlopper(this);
    this.setCloseQuotesArray();
    this.fun.ordinalizer.init(this);
    this.fun.long_ordinalizer.init(this);
    this.fun.page_mangler = CSL.Util.PageRangeMangler.getFunction(this, "page");
    this.fun.year_mangler = CSL.Util.PageRangeMangler.getFunction(this, "year");
    this.setOutputFormat("html");
};
CSL.Engine.prototype.setCloseQuotesArray = function () {
    var ret;
    ret = [];
    ret.push(this.getTerm("close-quote"));
    ret.push(this.getTerm("close-inner-quote"));
    ret.push('"');
    ret.push("'");
    this.opt.close_quotes_array = ret;
};
CSL.makeBuilder = function (me, target) {
    function enterFunc (node) {
        CSL.XmlToToken.call(node, me, CSL.START, target);
    };
    function leaveFunc (node) {
        CSL.XmlToToken.call(node, me, CSL.END, target);
    };
    function singletonFunc (node) {
        CSL.XmlToToken.call(node, me, CSL.SINGLETON, target);
    };
    function buildStyle (node) {
        var starttag, origparent;
        if (me.cslXml.numberofnodes(me.cslXml.children(node))) {
            origparent = node;
            enterFunc(origparent);
            for (var i=0;i<me.cslXml.numberofnodes(me.cslXml.children(origparent));i+=1) {
                node = me.cslXml.children(origparent)[i];
                if (me.cslXml.nodename(node) === null) {
                    continue;
                }
                if (me.cslXml.nodename(node) === "date") {
                    CSL.Util.fixDateNode.call(me, origparent, i, node)
                    node = me.cslXml.children(origparent)[i];
                }
                buildStyle(node, enterFunc, leaveFunc, singletonFunc);
            }
            leaveFunc(origparent);
        } else {
            singletonFunc(node);
        }
    }
    return buildStyle;
};
CSL.Engine.prototype.buildTokenLists = function (area_nodes, target) {
    if (!this.cslXml.getNodeValue(area_nodes)) return;
    var builder = CSL.makeBuilder(this, target);
    var mynode;
    if ("undefined" === typeof area_nodes.length) {
        mynode = area_nodes;
    } else {
        mynode = area_nodes[0];
    }
    builder(mynode);
};
CSL.Engine.prototype.setStyleAttributes = function () {
    var dummy, attr, key, attributes, attrname;
    var dummy = {};
    dummy.name = this.cslXml.nodename(this.cslXml.dataObj);
    attributes = this.cslXml.attributes(this.cslXml.dataObj);
    for (attrname in attributes) {
        if (attributes.hasOwnProperty(attrname)) {
            CSL.Attributes[attrname].call(dummy, this, attributes[attrname]);
        }
    }
};
CSL.Engine.prototype.getTerm = function (term, form, plural, gender, mode, forceDefaultLocale) {
    if (term && term.match(/[A-Z]/) && term === term.toUpperCase()) {
        CSL.debug("Warning: term key is in uppercase form: "+term);
        term = term.toLowerCase();
    }
    var lang;
    if (forceDefaultLocale) {
        lang = this.opt["default-locale"][0];
    } else {
        lang = this.opt.lang;
    }
    var ret = CSL.Engine.getField(CSL.LOOSE, this.locale[lang].terms, term, form, plural, gender);
    if (!ret && term === "range-delimiter") {
        ret = "\u2013";
    }
    if (typeof ret === "undefined") {
        if (mode === CSL.STRICT) {
            throw "Error in getTerm: term \"" + term + "\" does not exist.";
        } else if (mode === CSL.TOLERANT) {
            ret = "";
        }
    }
    if (ret) {
        this.tmp.cite_renders_content = true;
    }
    return ret;
};
CSL.Engine.prototype.getDate = function (form, forceDefaultLocale) {
    var lang;
    if (forceDefaultLocale) {
        lang = this.opt["default-locale"];
    } else {
        lang = this.opt.lang;
    }
    if (this.locale[lang].dates[form]) {
        return this.locale[lang].dates[form];
    } else {
        return false;
    }
};
CSL.Engine.prototype.getOpt = function (arg) {
    if ("undefined" !== typeof this.locale[this.opt.lang].opts[arg]) {
        return this.locale[this.opt.lang].opts[arg];
    } else {
        return false;
    }
};
CSL.Engine.prototype.getVariable = function (Item, varname, form, plural) {
    return CSL.Engine.getField(CSL.LOOSE, Item, varname, form, plural);
};
CSL.Engine.prototype.getDateNum = function (ItemField, partname) {
    if ("undefined" === typeof ItemField) {
        return 0;
    } else {
        return ItemField[partname];
    }
};
CSL.Engine.getField = function (mode, hash, term, form, plural, gender) {
    var ret, forms, f, pos, len, hashterm;
    ret = "";
    if ("undefined" === typeof hash[term]) {
        if (mode === CSL.STRICT) {
            throw "Error in getField: term \"" + term + "\" does not exist.";
        } else {
            return undefined;
        }
    }
    if (gender && hash[term][gender]) {
        hashterm = hash[term][gender];
    } else {
        hashterm = hash[term];
    }
    forms = [];
    if (form === "symbol") {
        forms = ["symbol", "short"];
    } else if (form === "verb-short") {
        forms = ["verb-short", "verb"];
    } else if (form !== "long") {
        forms = [form];
    }
    forms = forms.concat(["long"]);
    len = forms.length;
    for (pos = 0; pos < len; pos += 1) {
        f = forms[pos];
        if ("string" === typeof hashterm || "number" === typeof hashterm) {
            ret = hashterm;
        } else if ("undefined" !== typeof hashterm[f]) {
            if ("string" === typeof hashterm[f] || "number" === typeof hashterm[f]) {
                ret = hashterm[f];
            } else {
                if ("number" === typeof plural) {
                    ret = hashterm[f][plural];
                } else {
                    ret = hashterm[f][0];
                }
            }
            break;
        }
    }
    return ret;
};
CSL.Engine.prototype.configureTokenLists = function () {
    var dateparts_master, area, pos, token, dateparts, part, ppos, pppos, len, llen, lllen;
    len = CSL.AREAS.length;
    for (pos = 0; pos < len; pos += 1) {
        area = CSL.AREAS[pos];
        var tokens = this[area].tokens;
        this.configureTokenList(tokens);
    }
    this.version = CSL.version;
    return this.state;
};
CSL.Engine.prototype.configureTokenList = function (tokens) {
    var dateparts_master, area, pos, token, dateparts, part, ppos, pppos, len, llen, lllen;
    dateparts_master = ["year", "month", "day"];
    llen = tokens.length - 1;
    for (ppos = llen; ppos > -1; ppos += -1) {
        token = tokens[ppos];
        if ("date" === token.name && CSL.END === token.tokentype) {
            dateparts = [];
        }
        if ("date-part" === token.name && token.strings.name) {
            lllen = dateparts_master.length;
            for (pppos = 0; pppos < lllen; pppos += 1) {
                part = dateparts_master[pppos];
                if (part === token.strings.name) {
                    dateparts.push(token.strings.name);
                }
            }
        }
        if ("date" === token.name && CSL.START === token.tokentype) {
            dateparts.reverse();
            token.dateparts = dateparts;
        }
        token.next = (ppos + 1);
        if (token.name && CSL.Node[token.name].configure) {
            CSL.Node[token.name].configure.call(token, this, ppos);
        }
    }
}
CSL.Engine.prototype.retrieveItems = function (ids) {
    var ret, pos, len;
    ret = [];
    for (var i = 0, ilen = ids.length; i < ilen; i += 1) {
        ret.push(this.retrieveItem("" + ids[i]));
    }
    return ret;
};
CSL.ITERATION = 0;
CSL.Engine.prototype.retrieveItem = function (id) {
    var Item, m, pos, len, mm, i;
    if (!this.tmp.loadedItemIDs[id]) {
        this.tmp.loadedItemIDs[id] = true;
    } else {
        return this.registry.refhash[id];
    }
    if (this.opt.development_extensions.normalize_lang_keys_to_lowercase &&
        "boolean" === typeof this.opt.development_extensions.normalize_lang_keys_to_lowercase) {
        for (var i=0,ilen=this.opt["default-locale"].length; i<ilen; i+=1) {
            this.opt["default-locale"][i] = this.opt["default-locale"][i].toLowerCase();
        }
        for (var i=0,ilen=this.opt["locale-translit"].length; i<ilen; i+=1) {
            this.opt["locale-translit"][i] = this.opt["locale-translit"][i].toLowerCase();
        }
        for (var i=0,ilen=this.opt["locale-translat"].length; i<ilen; i+=1) {
            this.opt["locale-translat"][i] = this.opt["locale-translat"][i].toLowerCase();
        }
        this.opt.development_extensions.normalize_lang_keys_to_lowercase = 100;
    }
    CSL.ITERATION += 1;
    Item = JSON.parse(JSON.stringify(this.sys.retrieveItem("" + id)));
    if (this.opt.development_extensions.normalize_lang_keys_to_lowercase) {
        if (Item.multi) {
            if (Item.multi._keys) {
                for (var field in Item.multi._keys) {
                    for (var key in Item.multi._keys[field]) {
                        if (key !== key.toLowerCase()) {
                            Item.multi._keys[field][key.toLowerCase()] = Item.multi._keys[field][key];
                            delete Item.multi._keys[field][key];
                        }
                    }
                }
            }
            if (Item.multi.main) {
                for (var field in Item.multi.main) {
                    Item.multi.main[field] = Item.multi.main[field].toLowerCase();
                }
            }
        }
        for (var i=0, ilen=CSL.CREATORS.length; i>ilen; i+=1) {
            var ctype = CSL.CREATORS[i];
            if (Item[ctype] && Item[ctype].multi) {
                for (var j=0, jlen=Item[ctype].length; j<jlen; j+=1) {
                    var creator = Item[ctype][j];
                    if (creator.multi) {
                        if (creator.multi._key) {
                            for (var key in creator.multi._key) {
                                if (key !== key.toLowerCase()) {
                                    creator.multi._key[key.toLowerCase()] = creator.multi._key[key];
                                    delete creator.multi._key[key];
                                }
                            }
                        }
                        if (creator.multi.main) {
                            creator.multi.main = creator.multi.main.toLowerCase();
                        }
                    }
                }
            }
        }
    }
    if (this.sys.getLanguageName && Item.language) {
		if (Item.language) {
            Item.language = Item.language.toLowerCase();
			var lst = Item.language.split("<");
            if (lst.length > 0) {
                var languageName = this.sys.getLanguageName(lst[0]);
                if (languageName) {
                    Item["language-name"] = languageName;
                }
            }
			if (lst.length === 2) {
				var originalLanguage = this.sys.getLanguageName(lst[1]);
				if (originalLanguage) {
					Item["language-name-original"] = originalLanguage;
				}
			}
		}
    }
    if (Item.page) {
        Item["page-first"] = Item.page;
        var num = "" + Item.page;
        var m = num.split(/\s*(?:&|, |-|\u2013)\s*/);
        if (m[0].slice(-1) !== "\\") {
            Item["page-first"] = m[0];
        }
    }
    if (this.opt.development_extensions.field_hack && Item.note) {
        CSL.parseNoteFieldHacks(Item, false, this.opt.development_extensions.allow_field_hack_date_override);
    }
    for (var i = 1, ilen = CSL.DATE_VARIABLES.length; i < ilen; i += 1) {
        var dateobj = Item[CSL.DATE_VARIABLES[i]];
        if (dateobj) {
            if (this.opt.development_extensions.raw_date_parsing) {
                if (dateobj.raw) {
                    dateobj = this.fun.dateparser.parseDateToObject(dateobj.raw);
                }
            }
            Item[CSL.DATE_VARIABLES[i]] = this.dateParseArray(dateobj);
        }
    }
    if (this.opt.development_extensions.static_statute_locator) {
        if (Item.type && ["bill","gazette","legislation","regulation","treaty"].indexOf(Item.type) > -1) {
            var varname;
            var elements = ["type", "title", "jurisdiction", "genre", "volume", "container-title"];
            var legislation_id = [];
            for (i = 0, ilen = elements.length; i < ilen; i += 1) {
                varname = elements[i];
				if (Item[varname]) {
					legislation_id.push(Item[varname]);
				}
			}
            elements = ["original-date", "issued"];
			for (i = 0, elements.length; i < ilen; i += 1) {
                varname = elements[i];
				if (Item[varname] && Item[varname].year) {
					var value = Item[varname].year;
					legislation_id.push(value);
					break;
				}
			}
			Item.legislation_id = legislation_id.join("::");
        }
    }
    if (this.opt.development_extensions.force_jurisdiction) {
        if ("string" === typeof Item.authority) {
            Item.authority = [
                {
                    literal: Item.authority
                }
            ]
        }
    }
    if (!Item["title-short"]) {
        Item["title-short"] = Item.shortTitle;
    }
    if (this.opt.development_extensions.main_title_from_short_title) {
        CSL.extractTitleAndSubtitle(Item);
    }
    var isLegalType = ["bill","legal_case","legislation","gazette","regulation"].indexOf(Item.type) > -1;
    if (this.opt.development_extensions.force_jurisdiction && isLegalType) {
        if (!Item.jurisdiction) {
            Item.jurisdiction = "us";
        }
    }
    if (!isLegalType && Item.title && this.sys.getAbbreviation) {
        var noHints = false;
        if (!Item.jurisdiction) {
            noHints = true;
        }
        var jurisdiction = this.transform.loadAbbreviation(Item.jurisdiction, "title", Item.title, Item.type, true);
        if (this.transform.abbrevs[jurisdiction].title) {
            if (this.transform.abbrevs[jurisdiction].title[Item.title]) {
                Item["title-short"] = this.transform.abbrevs[jurisdiction].title[Item.title];
            }
        }
    }
    if (!Item["container-title-short"]) {
        Item["container-title-short"] = Item.journalAbbreviation;
    }
    if (Item["container-title"] && this.sys.getAbbreviation) {
        var jurisdiction = this.transform.loadAbbreviation(Item.jurisdiction, "container-title", Item["container-title"]);
        if (this.transform.abbrevs[jurisdiction]["container-title"]) {
            if (this.transform.abbrevs[jurisdiction]["container-title"][Item["container-title"]]) {
                Item["container-title-short"] = this.transform.abbrevs[jurisdiction]["container-title"][Item["container-title"]];
            }
        }
    }
    this.registry.refhash[id] = Item;
    return Item;
};
CSL.Engine.prototype.setOpt = function (token, name, value) {
    if (token.name === "style" || token.name === "cslstyle") {
        this.opt.inheritedAttributes[name] = value;
        this.citation.opt.inheritedAttributes[name] = value;
        this.bibliography.opt.inheritedAttributes[name] = value;
    } else if (["citation", "bibliography"].indexOf(token.name) > -1) {
        this[token.name].opt.inheritedAttributes[name] = value;
    } else {
        token.strings[name] = value;
    }
};
CSL.Engine.prototype.inheritOpt = function (token, attrname, parentname, defaultValue) {
    if ("undefined" !== typeof token.strings[attrname]) {
        return token.strings[attrname];
    } else {
        var parentValue = this[this.tmp.root].opt.inheritedAttributes[parentname ? parentname : attrname];
        if ("undefined" !== typeof parentValue) {
            return parentValue;
        } else {
            return defaultValue;
        }
    }
};
module.exports = CSL;
CSL.Engine.prototype.remapSectionVariable = function (inputList) {
    for (var i = 0, ilen = inputList.length; i < ilen; i += 1) {
        var Item = inputList[i][0];
        var item = inputList[i][1];
        if (["bill","gazette","legislation","regulation","treaty"].indexOf(Item.type) > -1) {
            if (item.locator) {
                item.locator = item.locator.trim();
                var m = item.locator.match(CSL.STATUTE_SUBDIV_PLAIN_REGEX);
                if (!m) {
                    if (item.label) {
                        item.locator = CSL.STATUTE_SUBDIV_STRINGS_REVERSE[item.label] + " " + item.locator;
                    } else {
                        item.locator = "p. " + item.locator;
                    }
                }
            }
            var sectionMasterLabel = null;
            if (Item.section) {
                Item.section = Item.section.trim();
                var m = Item.section.match(CSL.STATUTE_SUBDIV_PLAIN_REGEX);
                if (!m) {
                    Item.section = "sec. " + Item.section;
                    sectionMasterLabel = "sec.";
                } else {
                    sectionMasterLabel = m[0].trim();
                }
            }
            if (Item.section) {
                if (!item.locator) {
                    item.locator = Item.section;
                } else {
                    var m = item.locator.match(/^([^ ]*)\s*(.*)/);
                    var space = " ";
                    if (m) {
                        if (m[1] === "p." && sectionMasterLabel !== "p.") {
                            item.locator = m[2];
                        }
                        if (["[", "(", ".", ",", ";", ":", "?"].indexOf(item.locator.slice(0, 1)) > -1) {
                            space = "";
                        }
                    } else {
                       space = ""; 
                    }
                    item.locator = Item.section + space + item.locator;
                }
            }
            item.label = "";
        }
    }
}
CSL.Engine.prototype.setNumberLabels = function (Item) {
     if (Item.number
        && ["bill", "gazette", "legislation","regulation","treaty"].indexOf(Item.type) > -1
        && this.opt.development_extensions.static_statute_locator
        && !this.tmp.shadow_numbers["number"]) {
        this.tmp.shadow_numbers["number"] = {};
        this.tmp.shadow_numbers["number"].values = [];
        this.tmp.shadow_numbers["number"].plural = 0;
        this.tmp.shadow_numbers["number"].numeric = false;
        this.tmp.shadow_numbers["number"].label = false;
        var value = "" + Item.number;
        value = value.split("\\").join("");
        var firstword = value.split(/\s+/)[0];
        var firstlabel = CSL.STATUTE_SUBDIV_STRINGS[firstword];
        if (firstlabel) {
            var m = value.match(CSL.STATUTE_SUBDIV_GROUPED_REGEX);
            var splt = value.split(CSL.STATUTE_SUBDIV_PLAIN_REGEX);
            if (splt.length > 1) {
                var lst = [];
                for (var j=1, jlen=splt.length; j < jlen; j += 1) {
                    var subdiv = m[j - 1].replace(/^\s*/, "");
                    lst.push(splt[j].replace(/\s*$/, "").replace(/^\s*/, ""));
                }
                value = lst.join(" ");
            } else {
                value = splt[0];
            }
            this.tmp.shadow_numbers["number"].label = firstlabel;
            this.tmp.shadow_numbers["number"].values.push(["Blob", value, false]);
            this.tmp.shadow_numbers["number"].numeric = false;
        } else {
            this.tmp.shadow_numbers["number"].values.push(["Blob", value, false]);
            this.tmp.shadow_numbers["number"].numeric = true;
        }
    }
}
module.exports = CSL;
CSL.substituteOne = function (template) {
    return function (state, list) {
        if (!list) {
            return "";
        } else {
            return template.replace("%%STRING%%", list);
        }
    };
};
CSL.substituteTwo = function (template) {
    return function (param) {
        var template2 = template.replace("%%PARAM%%", param);
        return function (state, list) {
            if (!list) {
                return "";
            } else {
                return template2.replace("%%STRING%%", list);
            }
        };
    };
};
CSL.Mode = function (mode) {
    var decorations, params, param, func, val, args;
    decorations = {};
    params = CSL.Output.Formats[mode];
    for (param in params) {
        if (true) {
            if ("@" !== param.slice(0, 1)) {
                decorations[param] = params[param];
                continue;
            }
            func = false;
            val = params[param];
            args = param.split('/');
            if (typeof val === "string" && val.indexOf("%%STRING%%") > -1)  {
                if (val.indexOf("%%PARAM%%") > -1) {
                    func = CSL.substituteTwo(val);
                } else {
                    func = CSL.substituteOne(val);
                }
            } else if (typeof val === "boolean" && !val) {
                func = CSL.Output.Formatters.passthrough;
            } else if (typeof val === "function") {
                func = val;
            } else {
                throw "CSL.Compiler: Bad " + mode + " config entry for " + param + ": " + val;
            }
            if (args.length === 1) {
                decorations[args[0]] = func;
            } else if (args.length === 2) {
                if (!decorations[args[0]]) {
                    decorations[args[0]] = {};
                }
                decorations[args[0]][args[1]] = func;
            }
        }
    }
    return decorations;
};
CSL.setDecorations = function (state, attributes) {
    var ret, key, pos;
    ret = [];
    for (pos in CSL.FORMAT_KEY_SEQUENCE) {
        if (true) {
            var key = CSL.FORMAT_KEY_SEQUENCE[pos];
            if (attributes[key]) {
                ret.push([key, attributes[key]]);
                delete attributes[key];
            }
        }
    }
    return ret;
};
CSL.Doppeler = function(rexStr, stringMangler) {
    var mx, lst, len, pos, m, buf1, buf2, idx, ret, myret;
    this.split = split;
    this.join = join;
    var matchRex = new RegExp("(" + rexStr + ")", "g");
    var splitRex = new RegExp(rexStr, "g");
    function split(str) {
        if (stringMangler) {
            str = stringMangler(str);
        }
        var match = str.match(matchRex);
        if (!match) {
            return {
                tags: [],
                strings: [str]
            };
        }
        var split = str.split(splitRex);
        return {
            tags: match,
            strings: split,
            origStrings: split.slice()
        }
    }
    function join(obj) {
        var lst = obj.strings.slice(-1);
        for (var i=obj.tags.length-1; i>-1; i--) {
            lst.push(obj.tags[i]);
            lst.push(obj.strings[i]);
        }
        lst.reverse();
        return lst.join("");
    }
}
CSL.Engine.prototype.normalDecorIsOrphan = function (blob, params) {
    if (params[1] === "normal") {
        var use_param = false;
        var all_the_decor;
        if (this.tmp.area === "citation") {
            all_the_decor = [this.citation.opt.layout_decorations].concat(blob.alldecor);
        } else {
            all_the_decor = blob.alldecor;
        }
        for (var k = all_the_decor.length - 1; k > -1; k += -1) {
            for (var n = all_the_decor[k].length - 1; n > -1; n += -1) {
                if (all_the_decor[k][n][0] === params[0]) {
                    if (all_the_decor[k][n][1] !== "normal") {
                        use_param = true;
                    }
                }
            }
        }
        if (!use_param) {
            return true;
        }
    }
    return false;
};
CSL.getJurisdictionNameAndSuppress = function(state, jurisdictionID, jurisdictionName, chopTo) {
    var ret = null;
    if (chopTo) {
        jurisdictionID = jurisdictionID.split(":").slice(0, chopTo).join(":");
        jurisdictionName = state.sys.getHumanForm(jurisdictionID);
    }
    if (!jurisdictionName) {
        jurisdictionName = state.sys.getHumanForm(jurisdictionID);
    }
    if (!jurisdictionName) {
        ret = jurisdictionID;
    } else {
        var code = jurisdictionID.split(":");
        var name = jurisdictionName.split("|");
        var valid = false;
        if (code.length === 1 && name.length === 2) {
            valid = true;
        } else if (code.length > 1 && name.length === code.length) {
            valid = true;
        }
        if (!valid) {
            ret = name.join("|");
        } else {
            var mask = 0;
            var stub;
            for (var i=0,ilen=code.length;i<ilen;i++) {
                stub = code.slice(0, i+1).join(":");
                if (state.opt.suppressedJurisdictions[stub]) {
                    mask = (i+1);
                }
            }
            if (mask === 0) {
                if (code.length === 1) {
                    ret = name[0];
                } else {
                    ret = name.join("|");
                }
            } else if (mask === 1) {
                if (code.length === 1) {
                    ret = "";
                } else {
                    ret = name.slice(mask).join("|");
                }
            } else {
                ret = name.slice(mask).join("|");
            }
        }
    }
    return ret;
};
module.exports = CSL;
CSL.Engine.prototype.getCitationLabel = function (Item) {
    var label = "";
    var params = this.getTrigraphParams();
    var config = params[0];
    var myname = this.getTerm("reference", "short", 0);
    if ("undefined" === typeof myname) {
        myname = "reference";
    }
    myname = myname.replace(".", "");
    myname = myname.slice(0, 1).toUpperCase() + myname.slice(1);
    for (var i = 0, ilen = CSL.CREATORS.length; i < ilen; i += 1) {
        var n = CSL.CREATORS[i];
        if (Item[n]) {
            var names = Item[n];
            if (names.length > params.length) {
                config = params[params.length - 1];
            } else {
                config = params[names.length - 1];
            }
            for (var j = 0, jlen = names.length; j < jlen; j += 1) {
                if (j === config.authors.length) {
                    break;
                }
                var res = this.nameOutput.getName(names[j], "locale-translit", true);
                var name = res.name;
                if (name && name.family) {
                    myname = name.family;
                    myname = myname.replace(/^([ \'\u2019a-z]+\s+)/, "");
                } else if (name && name.literal) {
                    myname = name.literal;
                }
                var m = myname.toLowerCase().match(/^(a\s+|the\s+|an\s+)/);
                if (m) {
                    myname = myname.slice(m[1].length);
                }
                myname = myname.replace(CSL.ROMANESQUE_NOT_REGEXP, "");
                if (!myname) {
                    break;
                }
                myname = myname.slice(0, config.authors[j]);
                if (myname.length > 1) {
                    myname = myname.slice(0, 1).toUpperCase() + myname.slice(1).toLowerCase();
                } else if (myname.length === 1) {
                    myname = myname.toUpperCase();
                }
                label += myname;
            }
            break;
        }
    }
    if (!label) {
        if (Item.title) {
            var skipWords = this.locale[this.opt.lang].opts["skip-words"];
            var lst = Item.title.split(/\s+/);
            for (var i = lst.length - 1; i > -1; i--) {
                if (skipWords.indexOf(lst[i]) > -1) {
                    lst = lst.slice(0, i).concat(lst.slice(i + 1));
                }
            }
            var str = lst.join('');
            str = str.slice(0, params[0].authors[0]);
            if (str.length > 1) {
                str = str.slice(0, 1).toUpperCase() + str.slice(1).toLowerCase();
            } else if (str.length === 1) {
                str = str.toUpperCase();
            }
            label = str;
        }
    }
    var year = "0000";
    if (Item.issued) {
        if (Item.issued.year) {
            year = "" + Item.issued.year;
        }
    }
    year = year.slice((config.year * -1));
    label = label + year;
    return label;
};
CSL.Engine.prototype.getTrigraphParams = function () {
    var params = [];
    var ilst = this.opt.trigraph.split(":");
    if (!this.opt.trigraph || this.opt.trigraph.slice(0,1) !== "A") {
        throw "Bad trigraph definition: "+this.opt.trigraph;
    }
    for (var i = 0, ilen = ilst.length; i < ilen; i += 1) {
        var str = ilst[i];
        var config = {authors:[], year:0};
        for (var j = 0, jlen = str.length; j < jlen; j += 1) {
            switch (str.slice(j,j+1)) {
            case "A":
                config.authors.push(1);
                break;
            case "a":
                config.authors[config.authors.length - 1] += 1;
                break;
            case "0":
                config.year += 1;
                break;
            default:
                throw "Invalid character in trigraph definition: "+this.opt.trigraph;
            }
        }
        params.push(config);
    }
    return params;
};
module.exports = CSL;
CSL.Engine.prototype.setOutputFormat = function (mode) {
    this.opt.mode = mode;
    this.fun.decorate = CSL.Mode(mode);
    if (!this.output[mode]) {
        this.output[mode] = {};
        this.output[mode].tmp = {};
    }
};
CSL.Engine.prototype.getSortFunc = function () {
    return function (a,b) {
        a = a.split("-");
        b = b.split("-");
        if (a.length < b.length) {
            return 1
        } else if (a.length > b.length) {
            return -1
        } else {
            a = a.slice(-1)[0];
            b = b.slice(-1)[0];
            if (a.length < b.length) {
                return 1;
            } else if (a.length > b.length) {
                return -1;
            } else {
                return 0;
            }
        }
    };
};
CSL.Engine.prototype.setLangTagsForCslSort = function (tags) {
    var i, ilen;
    if (tags) {
        this.opt['locale-sort'] = [];
        for (i = 0, ilen = tags.length; i < ilen; i += 1) {
            this.opt['locale-sort'].push(tags[i]);
        }
    }
    this.opt['locale-sort'].sort(this.getSortFunc());
};
CSL.Engine.prototype.setLangTagsForCslTransliteration = function (tags) {
    var i, ilen;
    this.opt['locale-translit'] = [];
    if (tags) {
        for (i = 0, ilen = tags.length; i < ilen; i += 1) {
            this.opt['locale-translit'].push(tags[i]);
        }
    }
    this.opt['locale-translit'].sort(this.getSortFunc());
};
CSL.Engine.prototype.setLangTagsForCslTranslation = function (tags) {
    var i, ilen;
    this.opt['locale-translat'] = [];
    if (tags) {
        for (i = 0, ilen = tags.length; i < ilen; i += 1) {
            this.opt['locale-translat'].push(tags[i]);
        }
    }
    this.opt['locale-translat'].sort(this.getSortFunc());
};
CSL.Engine.prototype.setLangPrefsForCites = function (obj, conv) {
    var opt = this.opt['cite-lang-prefs'];
    if (!conv) {
        conv = function (key) {
            return key.toLowerCase();
        };
    }
    var segments = ['Persons', 'Institutions', 'Titles', 'Journals', 'Publishers', 'Places'];
    for (var i = 0, ilen = segments.length; i < ilen; i += 1) {
        var clientSegment = conv(segments[i]);
        var citeprocSegment = segments[i].toLowerCase();
        if (!obj[clientSegment]) {
            continue;
        }
        var supplements = [];
        while (obj[clientSegment].length > 1) {
            supplements.push(obj[clientSegment].pop());
        }
        var sortval = {orig:1,translit:2,translat:3};
        if (supplements.length === 2 && sortval[supplements[0]] < sortval[supplements[1]]) {
            supplements.reverse();
        }
        while (supplements.length) {
            obj[clientSegment].push(supplements.pop());
        }
        var lst = opt[citeprocSegment];
        while (lst.length) {
            lst.pop();
        }
        for (var j = 0, jlen = obj[clientSegment].length; j < jlen; j += 1) {
            lst.push(obj[clientSegment][j]);
        }
    }
};
CSL.Engine.prototype.setLangPrefsForCiteAffixes = function (affixList) {
    if (affixList && affixList.length === 48) {
        var affixes = this.opt.citeAffixes;
        var count = 0;
        var settings = ["persons", "institutions", "titles", "journals", "publishers", "places"];
        var forms = ["translit", "orig", "translit", "translat"];
        var value;
        for (var i = 0, ilen = settings.length; i < ilen; i += 1) {
            for (var j = 0, jlen = forms.length; j < jlen; j += 1) {
                value = "";
                if ((count % 8) === 4) {
                    if (!affixes[settings[i]]["locale-"+forms[j]].prefix
                        && !affixes[settings[i]]["locale-"+forms[j]].suffix) {
                        value = affixList[count] ? affixList[count] : "";
                        affixes[settings[i]]["locale-" + forms[j]].prefix = value;
                        value = affixList[count] ? affixList[count + 1] : "";
                        affixes[settings[i]]["locale-" + forms[j]].suffix = value;
                    }
                } else {
                    value = affixList[count] ? affixList[count] : "";
                    affixes[settings[i]]["locale-" + forms[j]].prefix = value;
                    value = affixList[count] ? affixList[count + 1] : "";
                    affixes[settings[i]]["locale-" + forms[j]].suffix = value;
                }
                count += 2;
            }
        }
        this.opt.citeAffixes = affixes;
    }
};
CSL.Engine.prototype.setAutoVietnameseNamesOption = function (arg) {
    if (arg) {
        this.opt["auto-vietnamese-names"] = true;
    } else {
        this.opt["auto-vietnamese-names"] = false;
    }
};
CSL.Engine.prototype.setAbbreviations = function (arg) {
    if (this.sys.setAbbreviations) {
        this.sys.setAbbreviations(arg);
    }
};
CSL.Engine.prototype.setSuppressTrailingPunctuation = function (arg) {
    this.citation.opt.suppressTrailingPunctuation = !!arg;
};
module.exports = CSL;
CSL.Output = {};
CSL.Output.Queue = function (state) {
    this.levelname = ["top"];
    this.state = state;
    this.queue = [];
    this.empty = new CSL.Token("empty");
    var tokenstore = {};
    tokenstore.empty = this.empty;
    this.formats = new CSL.Stack(tokenstore);
    this.current = new CSL.Stack(this.queue);
};
CSL.Output.Queue.prototype.pop = function () {
    var drip = this.current.value();
    if (drip.length) {
        return drip.pop();
    } else {
        return drip.blobs.pop();
    }
};
CSL.Output.Queue.prototype.getToken = function (name) {
    var ret = this.formats.value()[name];
    return ret;
};
CSL.Output.Queue.prototype.mergeTokenStrings = function (base, modifier) {
    var base_token, modifier_token, ret, key;
    base_token = this.formats.value()[base];
    modifier_token = this.formats.value()[modifier];
    ret = base_token;
    if (modifier_token) {
        if (!base_token) {
            base_token = new CSL.Token(base, CSL.SINGLETON);
            base_token.decorations = [];
        }
        ret = new CSL.Token(base, CSL.SINGLETON);
        var key = "";
        for (var key in base_token.strings) {
            if (base_token.strings.hasOwnProperty(key)) {
                ret.strings[key] = base_token.strings[key];
            }
        }
        for (var key in modifier_token.strings) {
            if (modifier_token.strings.hasOwnProperty(key)) {
                ret.strings[key] = modifier_token.strings[key];
            }
        }
        ret.decorations = base_token.decorations.concat(modifier_token.decorations);
    }
    return ret;
};
CSL.Output.Queue.prototype.addToken = function (name, modifier, token) {
    var newtok, attr;
    newtok = new CSL.Token("output");
    if ("string" === typeof token) {
        token = this.formats.value()[token];
    }
    if (token && token.strings) {
        for (attr in token.strings) {
            if (token.strings.hasOwnProperty(attr)) {
                newtok.strings[attr] = token.strings[attr];
            }
        }
        newtok.decorations = token.decorations;
    }
    if ("string" === typeof modifier) {
        newtok.strings.delimiter = modifier;
    }
    this.formats.value()[name] = newtok;
};
CSL.Output.Queue.prototype.pushFormats = function (tokenstore) {
    if (!tokenstore) {
        tokenstore = {};
    }
    tokenstore.empty = this.empty;
    this.formats.push(tokenstore);
};
CSL.Output.Queue.prototype.popFormats = function (tokenstore) {
    this.formats.pop();
};
CSL.Output.Queue.prototype.startTag = function (name, token) {
    var tokenstore = {};
    if (this.state.tmp["doing-macro-with-date"] && this.state.tmp.extension) {
        token = this.empty;
        name = "empty";
    }
    tokenstore[name] = token;
    this.pushFormats(tokenstore);
    this.openLevel(name);
};
CSL.Output.Queue.prototype.endTag = function (name) {
    this.closeLevel(name);
    this.popFormats();
};
CSL.Output.Queue.prototype.openLevel = function (token, ephemeral) {
    var blob, curr, x, has_ephemeral;
    if ("object" === typeof token) {
        blob = new CSL.Blob(undefined, token);
    } else if ("undefined" === typeof token) {
        blob = new CSL.Blob(undefined, this.formats.value().empty, "empty");
    } else {
        if (!this.formats.value() || !this.formats.value()[token]) {
            throw "CSL processor error: call to nonexistent format token \"" + token + "\"";
        }
        blob = new CSL.Blob(undefined, this.formats.value()[token], token);
    }
    curr = this.current.value();
    if (!this.state.tmp.just_looking && this.checkNestedBrace) {
        blob.strings.prefix = this.checkNestedBrace.update(blob.strings.prefix);
    }
    curr.push(blob);
    this.current.push(blob);
};
CSL.Output.Queue.prototype.closeLevel = function (name) {
    if (name && name !== this.current.value().levelname) {
        CSL.error("Level mismatch error:  wanted " + name + " but found " + this.current.value().levelname);
    }
    var blob = this.current.pop();
    if (!this.state.tmp.just_looking && this.checkNestedBrace) {
        blob.strings.suffix = this.checkNestedBrace.update(blob.strings.suffix);
    }
};
CSL.Output.Queue.prototype.append = function (str, tokname, notSerious, ignorePredecessor, noStripPeriods) {
    var token, blob, curr;
    var useblob = true;
    if (notSerious) {
        ignorePredecessor = true;
    }
    if (this.state.tmp["doing-macro-with-date"] && !notSerious) {
        if (tokname !== "macro-with-date") {
            return false;
        }
        if (tokname === "macro-with-date") {
            tokname = "empty";
        }
    }
    if ("undefined" === typeof str) {
        return false;
    }
    if ("number" === typeof str) {
        str = "" + str;
    }
    if (!notSerious 
        && this.state.tmp.element_trace 
        && this.state.tmp.element_trace.value() === "suppress-me") {
        return false;
    }
    blob = false;
    if (!tokname) {
        token = this.formats.value().empty;
    } else if (tokname === "literal") {
        token = true;
        useblob = false;
    } else if ("string" === typeof tokname) {
        token = this.formats.value()[tokname];
    } else {
        token = tokname;
    }
    if (!token) {
        throw "CSL processor error: unknown format token name: " + tokname;
    }
    if (token.strings && "undefined" === typeof token.strings.delimiter) {
        token.strings.delimiter = "";
    }
    if ("string" === typeof str && str.length) {
        str = str.replace(/ ([:;?!\u00bb])/g, "\u202f$1").replace(/\u00ab /g, "\u00ab\u202f");
        this.last_char_rendered = str.slice(-1);
        str = str.replace(/\s+'/g, " \'");
        if (!notSerious) {
            str = str.replace(/^'/g, " \'");
        }
        if (!ignorePredecessor) {
            this.state.tmp.term_predecessor = true;
            this.state.tmp.in_cite_predecessor = true;
        } else if (notSerious) {
            this.state.tmp.term_predecessor_name = true;
        }
    }
    blob = new CSL.Blob(str, token);
    curr = this.current.value();
    if ("undefined" === typeof curr && this.current.mystack.length === 0) {
        this.current.mystack.push([]);
        curr = this.current.value();
    }
    if ("string" === typeof blob.blobs) {
        if (!ignorePredecessor) {
            this.state.tmp.term_predecessor = true;
            this.state.tmp.in_cite_predecessor = true;
        } else if (notSerious) {
            this.state.tmp.term_predecessor_name = true;
        }
    }
    if (!notSerious) {
        this.state.parallel.AppendBlobPointer(curr);
    }
    if ("string" === typeof str) {
        if ("string" === typeof blob.blobs) {
            if (blob.blobs.slice(0, 1) !== " ") {
                var blobPrefix = "";
                var blobBlobs = blob.blobs;
                while (CSL.TERMINAL_PUNCTUATION.indexOf(blobBlobs.slice(0, 1)) > -1) {
                    blobPrefix = blobPrefix + blobBlobs.slice(0, 1);
                    blobBlobs = blobBlobs.slice(1);
                }
                if (blobBlobs && blobPrefix) {
                    blob.strings.prefix = blob.strings.prefix + blobPrefix;
                    blob.blobs = blobBlobs;
                }
            }
        }
        if (blob.strings["text-case"]) {
            blob.blobs = CSL.Output.Formatters[blob.strings["text-case"]](this.state, str);
        }
        if (this.state.tmp.strip_periods && !noStripPeriods) {
            blob.blobs = blob.blobs.replace(/\.([^a-z]|$)/g, "$1");
        }
        for (var i = blob.decorations.length - 1; i > -1; i += -1) {
            if (blob.decorations[i][0] === "@quotes" && blob.decorations[i][1] !== "false") {
                blob.punctuation_in_quote = this.state.getOpt("punctuation-in-quote");
            }
            if (!blob.blobs.match(CSL.ROMANESQUE_REGEXP)) {
                if (blob.decorations[i][0] === "@font-style") {
                    blob.decorations = blob.decorations.slice(0, i).concat(blob.decorations.slice(i + 1));
                }
            }
        }
        curr.push(blob);
        this.state.fun.flipflopper.processTags(blob);
    } else if (useblob) {
        curr.push(blob);
    } else {
        curr.push(str);
    }
    return true;
};
CSL.Output.Queue.prototype.string = function (state, myblobs, blob) {
    var i, ilen, j, jlen, b;
    var txt_esc = CSL.getSafeEscape(this.state);
    var blobs = myblobs.slice();
    var ret = [];
    if (blobs.length === 0) {
        return ret;
    }
    var blob_delimiter = "";
    if (blob) {
        blob_delimiter = blob.strings.delimiter;
    } else {
        state.tmp.count_offset_characters = false;
        state.tmp.offset_characters = 0;
    }
    if (blob && blob.new_locale) {
        blob.old_locale = state.opt.lang;
        state.opt.lang = blob.new_locale;
    }
    var blobjr, use_suffix, use_prefix, params;
    for (var i = 0, ilen = blobs.length; i < ilen; i += 1) {
        blobjr = blobs[i];
        if (blobjr.strings.first_blob) {
            state.tmp.count_offset_characters = blobjr.strings.first_blob;
        }
        if ("string" === typeof blobjr.blobs) {
            if ("number" === typeof blobjr.num) {
                ret.push(blobjr);
            } else if (blobjr.blobs) {
                b = txt_esc(blobjr.blobs);
                var blen = b.length;
                if (!state.tmp.suppress_decorations) {
                    for (j = 0, jlen = blobjr.decorations.length; j < jlen; j += 1) {
                        params = blobjr.decorations[j];
                        if (params[0] === "@showid") {
                            continue;
                        }
                        if (state.normalDecorIsOrphan(blobjr, params)) {
                            continue;
                        }
                        b = state.fun.decorate[params[0]][params[1]].call(blobjr, state, b, params[2]);
                    }
                }
                if (b && b.length) {
                    b = txt_esc(blobjr.strings.prefix) + b + txt_esc(blobjr.strings.suffix);
                    if ((state.opt.development_extensions.csl_reverse_lookup_support || state.sys.csl_reverse_lookup_support) && !state.tmp.suppress_decorations) {
                        for (j = 0, jlen = blobjr.decorations.length; j < jlen; j += 1) {
                            params = blobjr.decorations[j];
                            if (params[0] === "@showid") {
                                b = state.fun.decorate[params[0]][params[1]].call(blobjr, state, b, params[2]);
                            }
                        }
                    }
                    ret.push(b);
                    if (state.tmp.count_offset_characters) {
                        state.tmp.offset_characters += (blen + blobjr.strings.suffix.length + blobjr.strings.prefix.length);
                    }
                }
            }
        } else if (blobjr.blobs.length) {
            var addtoret = state.output.string(state, blobjr.blobs, blobjr);
            if (blob) {
                if ("string" !== addtoret && addtoret.length > 1 && blobjr.strings.delimiter) {
                    var numberSeen = false;
                    for (var j=0,jlen=addtoret.length;j<jlen;j++) {
                        if ("string" !== typeof addtoret[j]) {
                            numberSeen = true;
                        } else if (numberSeen) {
                            addtoret[j] = (blobjr.strings.delimiter + addtoret[j]);
                        }
                    }
                }
            }
            ret = ret.concat(addtoret);
        }
        if (blobjr.strings.first_blob && state.registry.registry[blobjr.strings.first_blob]) {
            state.registry.registry[blobjr.strings.first_blob].offset = state.tmp.offset_characters;
            state.tmp.count_offset_characters = false;
        }
    }
    for (i=0,ilen=ret.length - 1;i<ilen;i+=1) {
        if ("number" === typeof ret[i].num && "number" === typeof ret[i+1].num && !ret[i+1].UGLY_DELIMITER_SUPPRESS_HACK) {
            ret[i].strings.suffix = ret[i].strings.suffix + (blob_delimiter ? blob_delimiter : "");
            ret[i+1].successor_prefix = "";
            ret[i+1].UGLY_DELIMITER_SUPPRESS_HACK = true;
        }
    }
    var span_split = 0;
    for (var i = 0, ilen = ret.length; i < ilen; i += 1) {
        if ("string" === typeof ret[i]) {
            span_split = (parseInt(i, 10) + 1);
            if (i < ret.length - 1  && "object" === typeof ret[i + 1]) {
                if (blob_delimiter && !ret[i + 1].UGLY_DELIMITER_SUPPRESS_HACK) {
                    ret[i] += txt_esc(blob_delimiter);
                }
                ret[i + 1].UGLY_DELIMITER_SUPPRESS_HACK = true;
            }
        }
    }
    if (blob && (blob.decorations.length || blob.strings.suffix)) {
        span_split = ret.length;
    } else if (blob && blob.strings.prefix) {
        for (var i=0,ilen=ret.length;i<ilen;i++) {
            if ("undefined" !== typeof ret[i].num) {
                span_split = i;
                if (i === 0) {
                    ret[i].strings.prefix = blob.strings.prefix + ret[i].strings.prefix;
                }
                break;
            }
        }
    }
    var blobs_start = state.output.renderBlobs(ret.slice(0, span_split), blob_delimiter, false, blob);
    if (blobs_start && blob && (blob.decorations.length || blob.strings.suffix || blob.strings.prefix)) {
        if (!state.tmp.suppress_decorations) {
            for (var i = 0, ilen = blob.decorations.length; i < ilen; i += 1) {
                params = blob.decorations[i];
                if (["@cite","@bibliography", "@display", "@showid"].indexOf(params[0]) > -1) {
                    continue;
                }
                if (state.normalDecorIsOrphan(blobjr, params)) {
                    continue;
                }
                if ("string" === typeof blobs_start) {
                    blobs_start = state.fun.decorate[params[0]][params[1]].call(blob, state, blobs_start, params[2]);
                }
            }
        }
        b = blobs_start;
        use_suffix = blob.strings.suffix;
        if (b && b.length) {
            use_prefix = blob.strings.prefix;
            b = txt_esc(use_prefix) + b + txt_esc(use_suffix);
            if (state.tmp.count_offset_characters) {
                state.tmp.offset_characters += (use_prefix.length + use_suffix.length);
            }
        }
        blobs_start = b;
        if (!state.tmp.suppress_decorations) {
            for (var i = 0, ilen = blob.decorations.length; i < ilen; i += 1) {
                params = blob.decorations[i];
                if (["@cite","@bibliography", "@display", "@showid"].indexOf(params[0]) === -1) {
                    continue;
                }
                if ("string" === typeof blobs_start) {
                    blobs_start = state.fun.decorate[params[0]][params[1]].call(blob, state, blobs_start, params[2]);
                }
            }
        }
    }
    var blobs_end = ret.slice(span_split, ret.length);
    if (!blobs_end.length && blobs_start) {
        ret = [blobs_start];
    } else if (blobs_end.length && !blobs_start) {
        ret = blobs_end;
    } else if (blobs_start && blobs_end.length) {
        ret = [blobs_start].concat(blobs_end);
    }
    if ("undefined" === typeof blob) {
        this.queue = [];
        this.current.mystack = [];
        this.current.mystack.push(this.queue);
        if (state.tmp.suppress_decorations) {
            ret = state.output.renderBlobs(ret, undefined, false);
        }
    } else if ("boolean" === typeof blob) {
        ret = state.output.renderBlobs(ret, undefined, true);
    }
    if (blob && blob.new_locale) {
        state.opt.lang = blob.old_locale;
    }
    return ret;
};
CSL.Output.Queue.prototype.clearlevel = function () {
    var blob, pos, len;
    blob = this.current.value();
    len = blob.blobs.length;
    for (pos = 0; pos < len; pos += 1) {
        blob.blobs.pop();
    }
};
CSL.Output.Queue.prototype.renderBlobs = function (blobs, delim, in_cite, parent) {
    var state, ret, ret_last_char, use_delim, i, blob, pos, len, ppos, llen, pppos, lllen, res, str, params, txt_esc;
    txt_esc = CSL.getSafeEscape(this.state);
    if (!delim) {
        delim = "";
    }
    state = this.state;
    ret = "";
    ret_last_char = [];
    use_delim = "";
    len = blobs.length;
    if (this.state.tmp.area === "citation" && !this.state.tmp.just_looking && len === 1 && typeof blobs[0] === "object" && parent) {
        blobs[0].strings.prefix = parent.strings.prefix + blobs[0].strings.prefix;
        blobs[0].strings.suffix = blobs[0].strings.suffix + parent.strings.suffix;
        blobs[0].decorations = blobs[0].decorations.concat(parent.decorations);
        blobs[0].params = parent.params;
        return blobs[0];
    }
    var start = true;
    for (pos = 0; pos < len; pos += 1) {
        if (blobs[pos].checkNext) {
            blobs[pos].checkNext(blobs[pos + 1],start);
            start = false;
        } else if (blobs[pos+1] && blobs[pos+1].splice_prefix) {
            start = false;
        } else {
            start = true;
        }
    }
    var doit = true;
    for (pos = blobs.length - 1; pos > 0; pos += -1) {
        if (blobs[pos].checkLast) {
            if (doit && blobs[pos].checkLast(blobs[pos - 1])) {
                doit = false;
            }
        } else {
            doit = true;
        }
    }
    len = blobs.length;
    for (pos = 0; pos < len; pos += 1) {
        blob = blobs[pos];
        if (ret) {
            use_delim = delim;
        }
        if ("string" === typeof blob) {
            ret += txt_esc(use_delim);
            ret += blob;
            if (state.tmp.count_offset_characters) {
                state.tmp.offset_characters += (use_delim.length);
            }
        } else if (in_cite) {
            if (ret) {
                ret = [ret, blob];
            } else {
                ret = [blob];
            }
        } else if (blob.status !== CSL.SUPPRESS) {
            if (blob.particle) {
                str = blob.particle + blob.num;
            } else {
                str = blob.formatter.format(blob.num, blob.gender);
            }
            var strlen = str.replace(/<[^>]*>/g, "").length;
            this.append(str, "empty", true);
            var str_blob = this.pop();
            var count_offset_characters = state.tmp.count_offset_characters;
            str = this.string(state, [str_blob], false);
            state.tmp.count_offset_characters = count_offset_characters;
            if (blob.strings["text-case"]) {
                str = CSL.Output.Formatters[blob.strings["text-case"]](this.state, str);
            }
            if (str && this.state.tmp.strip_periods) {
                str = str.replace(/\.([^a-z]|$)/g, "$1");
            }
            if (!state.tmp.suppress_decorations) {
                llen = blob.decorations.length;
                for (ppos = 0; ppos < llen; ppos += 1) {
                    params = blob.decorations[ppos];
                    if (state.normalDecorIsOrphan(blob, params)) {
                        continue;
                    }
                    str = state.fun.decorate[params[0]][params[1]].call(blob, state, str, params[2]);
                }
            }
            str = txt_esc(blob.strings.prefix) + str + txt_esc(blob.strings.suffix);
            var addme = "";
            if (blob.status === CSL.END) {
                addme = txt_esc(blob.range_prefix);
            } else if (blob.status === CSL.SUCCESSOR) {
                addme = txt_esc(blob.successor_prefix);
            } else if (blob.status === CSL.START) {
                if (pos > 0 && !blob.suppress_splice_prefix) {
                    addme = txt_esc(blob.splice_prefix);
                } else {
                    addme = "";
                }
            } else if (blob.status === CSL.SEEN) {
                addme = txt_esc(blob.splice_prefix);
            }
            ret += addme;
            ret += str;
            if (state.tmp.count_offset_characters) {
                state.tmp.offset_characters += (addme.length + blob.strings.prefix.length + strlen + blob.strings.suffix.length);
            }
        }
    }
    return ret;
};
CSL.Output.Queue.purgeEmptyBlobs = function (parent) {
    if ("object" !== typeof parent || "object" !== typeof parent.blobs || !parent.blobs.length) {
        return;
    }
    for (var i=parent.blobs.length-1;i>-1;i--) {
        CSL.Output.Queue.purgeEmptyBlobs(parent.blobs[i]);
        var child = parent.blobs[i];
        if (!child || !child.blobs || !child.blobs.length) {
            var buf = [];
            while ((parent.blobs.length-1) > i) {
                buf.push(parent.blobs.pop());
            }
            parent.blobs.pop();
            while (buf.length) {
                parent.blobs.push(buf.pop());
            }
        }
    }
};
CSL.Output.Queue.adjust = function (punctInQuote) {
    var NO_SWAP_IN = {
        ";": true,
        ":": true
    }
    var NO_SWAP_OUT = {
        ".": true,
        "!": true,
        "?": true
    }
    this.upward = upward;
    this.leftward = leftward;
    this.downward = downward;
    this.fix = fix;
    var LtoR_MAP = {
        "!": {
            ".": "!",
            "?": "!?",
            ":": "!",
            ",": "!,",
            ";": "!;"
        },
        "?": {
            "!": "?!",
            ".": "?",
            ":": "?",
            ",": "?,",
            ";": "?;"
        },
        ".": {
            "!": ".!",
            "?": ".?",
            ":": ".:",
            ",": ".,",
            ";": ".;"
        },
        ":": {
            "!": "!",
            "?": "?",
            ".": ":",
            ",": ":,",
            ";": ":;"
        },
        ",": {
            "!": ",!",
            "?": ",?",
            ":": ",:",
            ".": ",.",
            ";": ",;"
        },
        ";": {
            "!": "!",
            "?": "?",
            ":": ";",
            ",": ";,",
            ".": ";"
        }
    }
    var SWAP_IN = {};
    var SWAP_OUT = {};
    var PUNCT = {};
    var PUNCT_OR_SPACE = {};
    for (var key in LtoR_MAP) {
        PUNCT[key] = true;
        PUNCT_OR_SPACE[key] = true;
        if (!NO_SWAP_IN[key]) {
            SWAP_IN[key] = true;
        }
        if (!NO_SWAP_OUT[key]) {
            SWAP_OUT[key] = true;
        }
    }
    PUNCT_OR_SPACE[" "] = true;
    PUNCT_OR_SPACE[" "] = true;
    var RtoL_MAP = {};
    for (var key in LtoR_MAP) {
        for (var subkey in LtoR_MAP[key]) {
            if (!RtoL_MAP[subkey]) {
                RtoL_MAP[subkey] = {};
            }
            RtoL_MAP[subkey][key] = LtoR_MAP[key][subkey];
        }
    }
    function blobIsNumber(blob) {
        return ("number" === typeof blob.num || (blob.blobs && blob.blobs.length === 1 && "number" === typeof blob.blobs[0].num));
    };
    function blobEndsInNumber(blob) {
        if ("number" === typeof blob.num) {
            return true;
        }
        if (!blob.blobs || "object" !==  typeof blob.blobs) return false;
        if (blobEndsInNumber(blob.blobs[blob.blobs.length-1])) return true;
    }
    function blobHasDecorations(blob,includeQuotes) {
        var ret = false;
        var decorlist = ['@font-style','@font-variant','@font-weight','@text-decoration','@vertical-align'];
        if (includeQuotes) {
            decorlist.push('@quotes');
        }
        if (blob.decorations) {
            for (var i=0,ilen=blob.decorations.length;i<ilen;i++) {
                if (decorlist.indexOf(blob.decorations[i][0]) > -1) {
                    ret = true;
                    break;
                }
            }
        }
        return ret;
    };
    function blobHasDescendantQuotes(blob) {
        if (blob.decorations) {
            for (var i=0,ilen=blob.decorations.length;i<ilen;i++) {
                if (blob.decorations[i][0] === '@quotes' && blob.decorations[i][1] !== "false") {
                    return true;
                }
            }
        }
        if ("object" !== typeof blob.blobs) {
            return false
        };
        return blobHasDescendantQuotes(blob.blobs[blob.blobs.length-1]);
    }
    function blobHasDescendantMergingPunctuation(parentChar,blob) {
        var childChar = blob.strings.suffix.slice(-1);
        if (!childChar && "string" === typeof blob.blobs) {
            childChar = blob.blobs.slice(-1);
        }
        var mergedChars = RtoL_MAP[parentChar][childChar];
        if (mergedChars && mergedChars.length === 1) {
            return true;
        }
        if ("object" !== typeof blob.blobs) return false;
        if (blobHasDescendantMergingPunctuation(parentChar,blob.blobs[blob.blobs.length-1])) return true;
        return false;
    }
    function matchLastChar(blob, chr) {
        if (!PUNCT[chr]) {
            return false;
        }
        if ("string" === typeof blob.blobs) {
            if (blob.blobs.slice(-1) === chr) {
                return true;
            } else {
                return false;
            }
        } else {
            var child = blob.blobs[blob.blobs.length-1];
            if (child) {
                var childChar = child.strings.suffix.slice(-1);
                if (!childChar) {
                    return matchLastChar(child,chr);
                } else if (child.strings.suffix.slice(-1) == chr) {
                    return true;
                } else {
                    return false;
                }
            } else {
                return false;
            }
        }
    };
    function mergeChars (First, first, Second, second, merge_right) {
        var FirstStrings = "blobs" === first ? First : First.strings;
        var SecondStrings = "blobs" === second ? Second: Second.strings;
        var firstChar = FirstStrings[first].slice(-1);
        var secondChar = SecondStrings[second].slice(0,1);
        function cullRight () {
            SecondStrings[second] = SecondStrings[second].slice(1);
        };
        function cullLeft () {
            FirstStrings[first] = FirstStrings[first].slice(0,-1);
        };
        function addRight (chr) {
            SecondStrings[second] = chr + SecondStrings[second];
        }
        function addLeft (chr) {
            FirstStrings[first] += chr;
        }
        var cull = merge_right ? cullLeft : cullRight;
        function matchOnRight () {
            return RtoL_MAP[secondChar];
        }
        function matchOnLeft () {
            return LtoR_MAP[firstChar];
        }
        var match = merge_right ? matchOnLeft : matchOnRight;
        function mergeToRight () {
            var chr = LtoR_MAP[firstChar][secondChar];
            if ("string" === typeof chr) {
                cullLeft();
                cullRight();
                addRight(chr);
            } else {
                addRight(firstChar);
                cullLeft();
            }
        }
        function mergeToLeft () {
            var chr = RtoL_MAP[secondChar][firstChar];
            if ("string" === typeof chr) {
                cullLeft();
                cullRight();
                addLeft(chr);
            } else {
                addLeft(secondChar);
                cullRight();
            }
        }
        var merge = merge_right ? mergeToRight: mergeToLeft;
        var isDuplicate = firstChar === secondChar;
        if (isDuplicate) {
            cull();
        } else {
            if (match()) {
                merge();
            }
        }
    };
    function upward (parent) {
        if (parent.blobs && "string" == typeof parent.blobs) {
            if (PUNCT[parent.strings.suffix.slice(0,1)]
                && parent.strings.suffix.slice(0,1) === parent.blobs.slice(-1)) {
                parent.strings.suffix = parent.strings.suffix.slice(1);
            }
            return;
        } else if ("object" !== typeof parent || "object" !== typeof parent.blobs || !parent.blobs.length) {
            return;
        }
        var parentDecorations = blobHasDecorations(parent,true);
        for (var i=parent.blobs.length-1;i>-1;i--) {
            var endFlag = i === (parent.blobs.length-1);
            this.upward(parent.blobs[i]);
            var parentStrings = parent.strings;
            var childStrings = parent.blobs[i].strings;
            if (i === 0) {
                if (" " === parentStrings.prefix.slice(-1) && " " === childStrings.prefix.slice(0, 1)) {
                    childStrings.prefix = childStrings.prefix.slice(1);
                }
                var childChar = childStrings.prefix.slice(0, 1);
                if (!parentDecorations && PUNCT_OR_SPACE[childChar] && !parentStrings.prefix) {
                    parentStrings.prefix += childChar;
                    childStrings.prefix = childStrings.prefix.slice(1);
                }
            }
            if (i === (parent.blobs.length - 1)) {
                var childChar = childStrings.suffix.slice(-1);
                if (!parentDecorations && [" "].indexOf(childChar) > -1) {
                    if (parentStrings.suffix.slice(0,1) !== childChar) {
                        parentStrings.suffix = childChar + parentStrings.suffix;
                    }
                    childStrings.suffix = childStrings.suffix.slice(0, -1);
                }
            }
            if (parentStrings.delimiter && i > 0) {
                if (PUNCT_OR_SPACE[parentStrings.delimiter.slice(-1)]
                    && parentStrings.delimiter.slice(-1) === childStrings.prefix.slice(0, 1)) {
                    childStrings.prefix = childStrings.prefix.slice(1);
                }
            }
        }
    };
    function leftward (parent) {
        if ("object" !== typeof parent || "object" !== typeof parent.blobs || !parent.blobs.length) {
            return;
        }
        for (var i=parent.blobs.length-1;i>-1;i--) {
            this.leftward(parent.blobs[i]);
            if ((i < parent.blobs.length -1) && !parent.strings.delimiter) {
                var child = parent.blobs[i];
                var childChar = child.strings.suffix.slice(-1);
                var sibling = parent.blobs[i+1];
                var siblingChar = sibling.strings.prefix.slice(0, 1);
                var hasDecorations = blobHasDecorations(child) || blobHasDecorations(sibling);
                var hasNumber = "number" === typeof childChar || "number" === typeof siblingChar;
                if (!hasDecorations && !hasNumber && PUNCT[siblingChar] && !hasNumber) {
                    var suffixAndPrefixMatch = siblingChar === child.strings.suffix.slice(-1);
                    var suffixAndFieldMatch = (!child.strings.suffix && "string" === typeof child.blobs && child.blobs.slice(-1) === siblingChar);
                    if (!suffixAndPrefixMatch && !suffixAndFieldMatch) {
                        mergeChars(child, 'suffix', sibling, 'prefix');
                    } else {
                        sibling.strings.prefix = sibling.strings.prefix.slice(1);
                    }
                }
            }
        }
    };
    function downward (parent, top) {
        if (parent.blobs && "string" == typeof parent.blobs) {
            if (PUNCT[parent.strings.suffix.slice(0,1)]
                && parent.strings.suffix.slice(0,1) === parent.blobs.slice(-1)) {
                parent.strings.suffix = parent.strings.suffix.slice(1);
            }
            return;
        } else if ("object" !== typeof parent || "object" !== typeof parent.blobs || !parent.blobs.length) {
            return;
        }
        var parentStrings = parent.strings;
        var someChildrenAreNumbers = false;
        for (var i=0,ilen=parent.blobs.length;i<ilen;i++) {
            if (blobIsNumber(parent.blobs[i])) {
                someChildrenAreNumbers = true;
                break;
            }
        }
        if (true || !someChildrenAreNumbers) {
            if (parentStrings.delimiter && PUNCT[parentStrings.delimiter.slice(0, 1)]) {
                var delimChar = parentStrings.delimiter.slice(0, 1);
                for (var i=parent.blobs.length-2;i>-1;i--) {
                    var childStrings = parent.blobs[i].strings;
                    if (childStrings.suffix.slice(-1) !== delimChar) {
                        childStrings.suffix += delimChar;
                    }
                }
                parentStrings.delimiter = parentStrings.delimiter.slice(1);
            }
        }
        var parentDecorations = blobHasDecorations(parent, true);
        var parentIsNumber = blobIsNumber(parent);
        for (var i=parent.blobs.length-1;i>-1;i--) {
            var child = parent.blobs[i];
            var childStrings = parent.blobs[i].strings;
            var childDecorations = blobHasDecorations(child, true);
            var childIsNumber = blobIsNumber(child);
            if (i === (parent.blobs.length - 1)) {
                if (true || !someChildrenAreNumbers) {
                    var parentChar = parentStrings.suffix.slice(0, 1);
                    var allowMigration = false;
                    if (PUNCT[parentChar]) {
                        allowMigration = blobHasDescendantMergingPunctuation(parentChar,child);
                        if (!allowMigration && punctInQuote) {
                            allowMigration = blobHasDescendantQuotes(child);
                        }
                    }
                    if (allowMigration) {
                        if (PUNCT[parentChar]) {
                            if (!blobEndsInNumber(child)) {
                                if ("string" === typeof child.blobs) {
                                    mergeChars(child, 'blobs', parent, 'suffix');
                                } else {
                                    mergeChars(child, 'suffix', parent, 'suffix');
                                }
                                if (parentStrings.suffix.slice(0,1) === ".") {
                                    childStrings.suffix += parentStrings.suffix.slice(0,1);
                                    parentStrings.suffix = parentStrings.suffix.slice(1);
                                }
                            }
                        }
                    }
                    if (childStrings.suffix.slice(-1) === " " && parentStrings.suffix.slice(0,1) === " ") {
                        parentStrings.suffix = parentStrings.suffix.slice(1);
                    }
                    if (PUNCT_OR_SPACE[childStrings.suffix.slice(0,1)]) {
                        if ("string" === typeof child.blobs && child.blobs.slice(-1) === childStrings.suffix.slice(0,1)) {
                            childStrings.suffix = childStrings.suffix.slice(1);
                        }
                        if (childStrings.suffix.slice(-1) === parentStrings.suffix.slice(0, 1)) {
                            parentStrings.suffix = parentStrings.suffix.slice(0, -1);
                        }
                    }
                }
                if (matchLastChar(parent,parent.strings.suffix.slice(0,1))) {
                    parent.strings.suffix = parent.strings.suffix.slice(1);
                }
            } else if (parentStrings.delimiter) {
                if (PUNCT_OR_SPACE[parentStrings.delimiter.slice(0,1)]
                    && parentStrings.delimiter.slice(0, 1) === childStrings.suffix.slice(-1)) {
                    parent.blobs[i].strings.suffix = parent.blobs[i].strings.suffix.slice(0, -1);
                }
            } else {
                var siblingStrings = parent.blobs[i+1].strings;
                if (!blobIsNumber(child) 
                    && !childDecorations
                    && PUNCT_OR_SPACE[childStrings.suffix.slice(-1)]
                    && childStrings.suffix.slice(-1) === siblingStrings.prefix.slice(0, 1)) {
                    siblingStrings.prefix = siblingStrings.prefix.slice(1);
                }
            }
            if (!childIsNumber && !childDecorations && PUNCT[childStrings.suffix.slice(0,1)]
                && "string" === typeof child.blobs) {
                mergeChars(child, 'blobs', child, 'suffix')
            }
            this.downward(parent.blobs[i]);
        }
    };
    function swapToTheLeft (child) {
        var childChar = child.strings.suffix.slice(0,1);
        if ("string" === typeof child.blobs) {
            while (SWAP_IN[childChar]) {
                mergeChars(child, 'blobs', child, 'suffix');
                childChar = child.strings.suffix.slice(0,1);
            }                                
        } else {
            while (SWAP_IN[childChar]) {
                mergeChars(child.blobs[child.blobs.length-1], 'suffix', child, 'suffix');
                childChar = child.strings.suffix.slice(0,1);
            }
        }
    }
    function swapToTheRight (child) {
        if ("string" === typeof child.blobs) {
            var childChar = child.blobs.slice(-1);
            while (SWAP_OUT[childChar]) {
                mergeChars(child, 'blobs', child, 'suffix', true);
                childChar = child.blobs.slice(-1);
            }
        } else {
            var childChar = child.blobs[child.blobs.length-1].strings.suffix.slice(-1);
            while (SWAP_OUT[childChar]) {
                mergeChars(child.blobs[child.blobs.length-1], 'suffix', child, 'suffix', true);
                childChar = child.blobs[child.blobs.length-1].strings.suffix.slice(-1);
            }
        }
    }
    function fix (parent) {
        if ("object" !== typeof parent || "object" !== typeof parent.blobs || !parent.blobs.length) {
            return;
        }
        var lastChar;
        for (var i=0,ilen=parent.blobs.length;i<ilen;i++) {
            var child = parent.blobs[i];
            var quoteSwap = false;
            for (var j=0,jlen=child.decorations.length;j<jlen;j++) {
                var decoration = child.decorations[j];
                if (decoration[0] === "@quotes" && decoration[1] !== "false") {
                    quoteSwap = true;
                }
            }
            if (quoteSwap) {
                if (punctInQuote) {
                    swapToTheLeft(child);
                } else {
                    swapToTheRight(child);
                }
            }
            lastChar = this.fix(parent.blobs[i]);
            if (child.blobs && "string" === typeof child.blobs) {
                lastChar = child.blobs.slice(-1);
            }
        }
        return lastChar;
    };
}
module.exports = CSL;
CSL.Engine.Opt = function () {
    this.has_disambiguate = false;
    this.mode = "html";
    this.dates = {};
    this.jurisdictions_seen = {};
    this.suppressedJurisdictions = {};
    this.inheritedAttributes = {};
    this["locale-sort"] = [];
    this["locale-translit"] = [];
    this["locale-translat"] = [];
    this.citeAffixes = {
        persons:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        },
        institutions:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        },
        titles:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        },
        journals:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        },
        publishers:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        },
        places:{
            "locale-orig":{
                prefix:"",
                suffix:""
            },
            "locale-translit":{
                prefix:"",
                suffix:""
            },
            "locale-translat":{
                prefix:"",
                suffix:""
            }
        }
    };
    this["default-locale"] = [];
    this.update_mode = CSL.NONE;
    this.bib_mode = CSL.NONE;
    this.sort_citations = false;
    this["et-al-min"] = 0;
    this["et-al-use-first"] = 1;
    this["et-al-use-last"] = false;
    this["et-al-subsequent-min"] = false;
    this["et-al-subsequent-use-first"] = false;
    this["demote-non-dropping-particle"] = "display-and-sort";
    this["parse-names"] = true;
    this.citation_number_slug = false;
    this.trigraph = "Aaaa00:AaAa00:AaAA00:AAAA00";
    this.nodenames = [];
    this.gender = {};
    this['cite-lang-prefs'] = {
        persons:['orig'],
        institutions:['orig'],
        titles:['orig'],
        journals:['orig'],
        publishers:['orig'],
        places:['orig'],
        number:['orig']
    };
    this.has_layout_locale = false;
    this.development_extensions = {};
    this.development_extensions.field_hack = true;
    this.development_extensions.allow_field_hack_date_override = true;
    this.development_extensions.locator_date_and_revision = true;
    this.development_extensions.locator_parsing_for_plurals = true;
    this.development_extensions.locator_label_parse = true;
    this.development_extensions.raw_date_parsing = true;
    this.development_extensions.clean_up_csl_flaws = true;
    this.development_extensions.flip_parentheses_to_braces = true;
    this.development_extensions.jurisdiction_subfield = true;
    this.development_extensions.static_statute_locator = false;
    this.development_extensions.csl_reverse_lookup_support = false;
    this.development_extensions.clobber_locator_if_no_statute_section = false;
    this.development_extensions.wrap_url_and_doi = false;
    this.development_extensions.allow_force_lowercase = false;
    this.development_extensions.handle_parallel_articles = false;
    this.development_extensions.thin_non_breaking_space_html_hack = false;
    this.development_extensions.apply_citation_wrapper = false;
    this.development_extensions.main_title_from_short_title = false;
    this.development_extensions.uppercase_subtitles = false;
    this.development_extensions.normalize_lang_keys_to_lowercase = false;
    this.development_extensions.strict_text_case_locales = false;
    this.development_extensions.rtl_support = false;
    this.development_extensions.expect_and_symbol_form = false;
    this.development_extensions.require_explicit_legal_case_title_short = false;
    this.development_extensions.spoof_institutional_affiliations = false;
    this.development_extensions.force_jurisdiction = false;
    this.development_extensions.parse_names = true;
};
CSL.Engine.Tmp = function () {
    this.names_max = new CSL.Stack();
    this.names_base = new CSL.Stack();
    this.givens_base = new CSL.Stack();
    this.value = [];
    this.namepart_decorations = {};
    this.namepart_type = false;
    this.area = "citation";
    this.root = "citation";
    this.extension = "";
    this.can_substitute = new CSL.Stack(0, CSL.LITERAL);
    this.element_rendered_ok = false;
    this.element_trace = new CSL.Stack("style");
    this.nameset_counter = 0;
    this.group_context = new CSL.Stack({
        term_intended: false,
        variable_attempt: false,
        variable_success: false,
        output_tip: undefined,
        label_form:  undefined,
        parallel_conditions: undefined,
        condition: false,
        force_suppress: false,
        done_vars: []
    });
    this.term_predecessor = false;
    this.in_cite_predecessor = false;
    this.jump = new CSL.Stack(0, CSL.LITERAL);
    this.decorations = new CSL.Stack();
    this.tokenstore_stack = new CSL.Stack();
    this.last_suffix_used = "";
    this.last_names_used = [];
    this.last_years_used = [];
    this.years_used = [];
    this.names_used = [];
    this.taintedItemIDs = {};
    this.taintedCitationIDs = {};
    this.initialize_with = new CSL.Stack();
    this.disambig_request = false;
    this["name-as-sort-order"] = false;
    this.suppress_decorations = false;
    this.disambig_settings = new CSL.AmbigConfig();
    this.bib_sort_keys = [];
    this.prefix = new CSL.Stack("", CSL.LITERAL);
    this.suffix = new CSL.Stack("", CSL.LITERAL);
    this.delimiter = new CSL.Stack("", CSL.LITERAL);
    this.cite_locales = [];
    this.cite_affixes = {
        citation: false, 
        bibliography: false,
        citation_sort: false, 
        bibliography_sort: false
    };
    this.strip_periods = 0;
    this.shadow_numbers = {};
    this.authority_stop_last = 0;
    this.loadedItemIDs = {};
};
CSL.Engine.Fun = function (state) {
    this.match = new CSL.Util.Match;
    this.suffixator = new CSL.Util.Suffixator(CSL.SUFFIX_CHARS);
    this.romanizer = new CSL.Util.Romanizer();
    this.ordinalizer = new CSL.Util.Ordinalizer(state);
    this.long_ordinalizer = new CSL.Util.LongOrdinalizer();
};
CSL.Engine.Build = function () {
    this["alternate-term"] = false;
    this.in_bibliography = false;
    this.in_style = false;
    this.skip = false;
    this.postponed_macro = false;
    this.layout_flag = false;
    this.name = false;
    this.form = false;
    this.term = false;
    this.macro = {};
    this.macro_stack = [];
    this.text = false;
    this.lang = false;
    this.area = "citation";
    this.root = "citation";
    this.extension = "";
    this.substitute_level = new CSL.Stack(0, CSL.LITERAL);
    this.names_level = 0;
    this.render_nesting_level = 0;
    this.render_seen = false;
};
CSL.Engine.Configure = function () {
    this.fail = [];
    this.succeed = [];
};
CSL.Engine.Citation = function (state) {
    this.opt = {
        inheritedAttributes: {}
    };
    this.tokens = [];
    this.srt = new CSL.Registry.Comparifier(state, "citation_sort");
    this.opt.collapse = [];
    this.opt["disambiguate-add-names"] = false;
    this.opt["disambiguate-add-givenname"] = false;
    this.opt["disambiguate-add-year-suffix"] = false;
    this.opt["givenname-disambiguation-rule"] = "by-cite";
    this.opt["near-note-distance"] = 5;
    this.opt.topdecor = [];
    this.opt.layout_decorations = [];
    this.opt.layout_prefix = "";
    this.opt.layout_suffix = "";
    this.opt.layout_delimiter = "";
    this.opt.sort_locales = [];
    this.opt.max_number_of_names = 0;
    this.root = "citation";
};
CSL.Engine.Bibliography = function () {
    this.opt = {
        inheritedAttributes: {}
    };
    this.tokens = [];
    this.opt.collapse = [];
    this.opt.topdecor = [];
    this.opt.layout_decorations = [];
    this.opt.layout_prefix = "";
    this.opt.layout_suffix = "";
    this.opt.layout_delimiter = "";
    this.opt["line-spacing"] = 1;
    this.opt["entry-spacing"] = 1;
    this.opt.sort_locales = [];
    this.opt.max_number_of_names = 0;
    this.root = "bibliography";
};
CSL.Engine.BibliographySort = function () {
    this.tokens = [];
    this.opt = {};
    this.opt.sort_directions = [];
    this.keys = [];
    this.opt.topdecor = [];
    this.root = "bibliography";
};
CSL.Engine.CitationSort = function () {
    this.tokens = [];
    this.opt = {};
    this.opt.sort_directions = [];
    this.keys = [];
    this.opt.topdecor = [];
    this.root = "citation";
};
module.exports = CSL;
CSL.Engine.prototype.previewCitationCluster = function (citation, citationsPre, citationsPost, newMode) {
    var oldMode = this.opt.mode;
    this.setOutputFormat(newMode);
    var ret = this.processCitationCluster(citation, citationsPre, citationsPost, CSL.PREVIEW);
    this.setOutputFormat(oldMode);
    return ret[1];
};
CSL.Engine.prototype.appendCitationCluster = function (citation) {
    var citationsPre = [];
    var len = this.registry.citationreg.citationByIndex.length;
    for (var pos = 0; pos < len; pos += 1) {
        var c = this.registry.citationreg.citationByIndex[pos];
        citationsPre.push(["" + c.citationID, c.properties.noteIndex]);
    }
    return this.processCitationCluster(citation, citationsPre, [])[1];
};
CSL.Engine.prototype.processCitationCluster = function (citation, citationsPre, citationsPost, flag) {
    var c, i, ilen, j, jlen, k, klen, n, nlen, key, Item, item, noteCitations, textCitations, m, citationsInNote;
    this.debug = false;
    this.tmp.loadedItemIDs = {};
    this.tmp.citation_errors = [];
    var return_data = {"bibchange": false};
    this.setCitationId(citation);
    var oldCitationList;
    var oldItemList;
    var oldAmbigs;
    if (flag === CSL.PREVIEW) {
        oldCitationList = this.registry.citationreg.citationByIndex.slice();
        oldItemList = this.registry.reflist.slice();
        var newCitationList = citationsPre.concat([["" + citation.citationID, citation.properties.noteIndex]]).concat(citationsPost);
        var newItemIds = {};
        var newItemIdsList = [];
        for (var i = 0, ilen = newCitationList.length; i < ilen; i += 1) {
            c = this.registry.citationreg.citationById[newCitationList[i][0]];
            for (j = 0, jlen = c.citationItems.length; j < jlen; j += 1) {
                newItemIds[c.citationItems[j].id] = true;
                newItemIdsList.push("" + c.citationItems[j].id);
            }
        }
        oldAmbigs = {};
        for (var i = 0, ilen = oldItemList.length; i < ilen; i += 1) {
            if (!newItemIds[oldItemList[i].id]) {
                var oldAkey = this.registry.registry[oldItemList[i].id].ambig;
                var ids = this.registry.ambigcites[oldAkey];
                if (ids) {
                    for (j = 0, jlen = ids.length; j < jlen; j += 1) {
                        oldAmbigs[ids[j]] = CSL.cloneAmbigConfig(this.registry.registry[ids[j]].disambig);
                    }
                }
            }
        }
    }
    this.tmp.taintedCitationIDs = {};
    var sortedItems = [];
    var rerunAkeys = {};
    for (var i = 0, ilen = citation.citationItems.length; i < ilen; i += 1) {
        item = {};
        for (var key in citation.citationItems[i]) {
            item[key] = citation.citationItems[i][key];
        }
        Item = this.retrieveItem("" + item.id);
        if (Item.id) {
            this.transform.loadAbbreviation("default", "hereinafter", Item.id);
        }
        item = CSL.parseLocator.call(this, item);
        if (this.opt.development_extensions.static_statute_locator) {
            this.remapSectionVariable([[Item,item]]);
        }
        if (this.opt.development_extensions.locator_label_parse) {
            if (item.locator && ["bill","gazette","legislation","regulation","treaty"].indexOf(Item.type) === -1 && (!item.label || item.label === 'page')) {
                var m = CSL.LOCATOR_LABELS_REGEXP.exec(item.locator);
                if (m) {
                    var tryLabel = CSL.LOCATOR_LABELS_MAP[m[2]];
                    if (this.getTerm(tryLabel)) {
                        item.label = tryLabel;
                        item.locator = m[3];
                    }
                }
            }
        }
        var newitem = [Item, item];
        sortedItems.push(newitem);
        citation.citationItems[i].item = Item;
    }
    citation.sortedItems = sortedItems;
    var citationByIndex = [];
    for (var i = 0, ilen = citationsPre.length; i < ilen; i += 1) {
        c = citationsPre[i];
        this.registry.citationreg.citationById[c[0]].properties.noteIndex = c[1];
        citationByIndex.push(this.registry.citationreg.citationById[c[0]]);
    }
    citationByIndex.push(citation);
    for (var i = 0, ilen = citationsPost.length; i < ilen; i += 1) {
        c = citationsPost[i];
        this.registry.citationreg.citationById[c[0]].properties.noteIndex = c[1];
        citationByIndex.push(this.registry.citationreg.citationById[c[0]]);
    }
    this.registry.citationreg.citationByIndex = citationByIndex;
    this.registry.citationreg.citationsByItemId = {};
    if (this.opt.update_mode === CSL.POSITION) {
        textCitations = [];
        noteCitations = [];
        citationsInNote = {};
    }
    var update_items = [];
    for (var i = 0, ilen = citationByIndex.length; i < ilen; i += 1) {
        citationByIndex[i].properties.index = i;
        for (j = 0, jlen = citationByIndex[i].sortedItems.length; j < jlen; j += 1) {
            item = citationByIndex[i].sortedItems[j];
            if (!this.registry.citationreg.citationsByItemId[item[1].id]) {
                this.registry.citationreg.citationsByItemId[item[1].id] = [];
                update_items.push("" + item[1].id);
            }
            if (this.registry.citationreg.citationsByItemId[item[1].id].indexOf(citationByIndex[i]) === -1) {
                this.registry.citationreg.citationsByItemId[item[1].id].push(citationByIndex[i]);
            }
        }
        if (this.opt.update_mode === CSL.POSITION) {
            if (citationByIndex[i].properties.noteIndex) {
                noteCitations.push(citationByIndex[i]);
            } else {
                citationByIndex[i].properties.noteIndex = 0;
                textCitations.push(citationByIndex[i]);
            }
        }
    }
    if (flag !== CSL.ASSUME_ALL_ITEMS_REGISTERED) {
        this.updateItems(update_items, null, null, true);
    }
    if (!this.opt.citation_number_sort && sortedItems && sortedItems.length > 1 && this.citation_sort.tokens.length > 0) {
        for (var i = 0, ilen = sortedItems.length; i < ilen; i += 1) {
            sortedItems[i][1].sortkeys = CSL.getSortKeys.call(this, sortedItems[i][0], "citation_sort");
        }
        if (this.opt.grouped_sort &&  !citation.properties.unsorted) {
            for (var i = 0, ilen = sortedItems.length; i < ilen; i += 1) {
                var sortkeys = sortedItems[i][1].sortkeys;
                this.tmp.authorstring_request = true;
                var mydisambig = this.registry.registry[sortedItems[i][0].id].disambig;
                this.tmp.authorstring_request = true;
                CSL.getAmbiguousCite.call(this, sortedItems[i][0], mydisambig);
                var authorstring = this.registry.authorstrings[sortedItems[i][0].id];
                this.tmp.authorstring_request = false;
                sortedItems[i][1].sortkeys = [authorstring].concat(sortkeys);
            }
            sortedItems.sort(this.citation.srt.compareCompositeKeys);
            var lastauthor = false;
            var thiskey = false;
            var thisauthor = false;
            for (var i = 0, ilen = sortedItems.length; i < ilen; i += 1) {
                if (sortedItems[i][1].sortkeys[0] !== lastauthor) {
                    thisauthor = sortedItems[i][1].sortkeys[0];
                    thiskey =  sortedItems[i][1].sortkeys[1];
                }
                sortedItems[i][1].sortkeys[0] = "" + thiskey + i;
                lastauthor = thisauthor;
            }
        }
        if (!citation.properties.unsorted) {
            sortedItems.sort(this.citation.srt.compareCompositeKeys);
        }
    }
    var citations;
    if (this.opt.update_mode === CSL.POSITION) {
        for (var i = 0; i < 2; i += 1) {
            citations = [textCitations, noteCitations][i];
            var first_ref = {};
            var last_ref = {};
            for (j = 0, jlen = citations.length; j < jlen; j += 1) {
                var onecitation = citations[j];
                if (!citations[j].properties.noteIndex) {
                    citations[j].properties.noteIndex = 0;
                }
                citations[j].properties.noteIndex = parseInt(citations[j].properties.noteIndex, 10);
                if (j > 0 && citations[j - 1].properties.noteIndex > citations[j].properties.noteIndex) {
                    citationsInNote = {};
                    first_ref = {};
                    last_ref = {};
                }
                for (k = 0, klen = onecitation.sortedItems.length; k < klen; k += 1) {
                    if (!this.registry.registry[onecitation.sortedItems[k][1].id].parallel) {
                        if (!citationsInNote[onecitation.properties.noteIndex]) {
                            citationsInNote[onecitation.properties.noteIndex] = 1;
                        } else {
                            citationsInNote[onecitation.properties.noteIndex] += 1;
                        }
                    }
                }
                for (k = 0, klen = citations[j].sortedItems.length; k < klen; k += 1) {
                    item = citations[j].sortedItems[k];
                    var myid = item[0].id;
                    var mylocator = item[1].locator;
                    var mylabel = item[1].label;
                    if (item[0].legislation_id) {
                        myid = item[0].legislation_id;
                    }
                    var incitationid;
                    if (k > 0) {
                        if (onecitation.sortedItems[k - 1][0].legislation_id) {
                            incitationid = onecitation.sortedItems[k - 1][0].legislation_id;
                        } else {
                            incitationid = onecitation.sortedItems[k - 1][1].id;
                        }
                    }
                    if (flag === CSL.PREVIEW) {
                        if (onecitation.citationID != citation.citationID) {
                            if ("undefined" === typeof first_ref[item[1].id]) {
                                first_ref[myid] = onecitation.properties.noteIndex;
                                last_ref[myid] = onecitation.properties.noteIndex;
                            } else {
                                last_ref[myid] = onecitation.properties.noteIndex;
                            }
                            continue;
                        }
                    }
                    var oldvalue = {};
                    oldvalue.position = item[1].position;
                    oldvalue["first-reference-note-number"] = item[1]["first-reference-note-number"];
                    oldvalue["near-note"] = item[1]["near-note"];
                    item[1]["first-reference-note-number"] = 0;
                    item[1]["near-note"] = false;
                    if (this.registry.citationreg.citationsByItemId[myid]) {
                        if (this.opt.xclass === 'note' && this.opt.has_disambiguate) {
                            var oldCount = this.registry.registry[myid]["citation-count"]
                            var newCount = this.registry.citationreg.citationsByItemId[myid].length;
                            this.registry.registry[myid]["citation-count"] = this.registry.citationreg.citationsByItemId[myid].length;
                            if ("number" === typeof oldCount) {
                                var oldCountCheck = (oldCount < 2);
                                var newCountCheck = (newCount < 2);
                                if (oldCountCheck !== newCountCheck) {
                                    for (var l=0,llen=this.registry.citationreg.citationsByItemId[myid].length;l<llen;l++) {
                                        rerunAkeys[this.registry.registry[myid].ambig] = true;
                                        this.tmp.taintedCitationIDs[this.registry.citationreg.citationsByItemId[myid][l].citationID] = true;
                                    }
                                }
                            } else {
                                for (var l=0,llen=this.registry.citationreg.citationsByItemId[myid].length;l<llen;l++) {
                                    rerunAkeys[this.registry.registry[myid].ambig] = true;
                                    this.tmp.taintedCitationIDs[this.registry.citationreg.citationsByItemId[myid][l].citationID] = true;
                                }
                            }
                        }
                    }
                    var oldlastid;
                    if ("undefined" === typeof first_ref[myid]) {
                        first_ref[myid] = onecitation.properties.noteIndex;
                        if (this.registry.registry[myid]) {
                            this.registry.registry[myid]['first-reference-note-number'] = onecitation.properties.noteIndex;
                        }
                        last_ref[myid] = onecitation.properties.noteIndex;
                        item[1].position = CSL.POSITION_FIRST;
                    } else {
                        var ibidme = false;
                        var suprame = false;
                        if (j > 0) {
                            oldlastid =  citations[j - 1].sortedItems.slice(-1)[0][1].id;
                            if (citations[j - 1].sortedItems[0].slice(-1)[0].legislation_id) {
                                oldlastid = citations[j - 1].sortedItems[0].slice(-1)[0].legislation_id;
                            }
                        }
                        if (j > 0 && parseInt(k, 10) === 0 && citations[j - 1].properties.noteIndex !== citations[j].properties.noteIndex) {
                            var items = citations[(j - 1)].sortedItems;
                            var useme = false;
                            var oldid = citations[j - 1].sortedItems[0][0].id;
                            if (citations[j - 1].sortedItems[0][0].legislation_id) {
                                oldid = citations[j - 1].sortedItems[0][0].legislation_id;
                            }
                            if ((oldid  == myid && citations[j - 1].properties.noteIndex >= (citations[j].properties.noteIndex - 1)) || citations[j - 1].sortedItems[0][1].id == this.registry.registry[item[1].id].parallel) {
                                if (citationsInNote[citations[j - 1].properties.noteIndex] === 1 || citations[j - 1].properties.noteIndex === 0) {
                                    useme = true;
                                }
                            }
                            for (n = 0, nlen = items.slice(1).length; n < nlen; n += 1) {
                                var itmp = items.slice(1)[n];
                                if (!this.registry.registry[itmp[1].id].parallel || this.registry.registry[itmp[1].id].parallel == this.registry.registry[itmp[1].id]) {
                                    useme = false;
                                }
                            }
                            if (useme) {
                                ibidme = true;
                            } else {
                                suprame = true;
                            }
                        } else if (k > 0 && incitationid == myid) {
                            ibidme = true;
                        } else if (k === 0 && citations[j - 1].properties.noteIndex == citations[j].properties.noteIndex
                                   && citations[j - 1].sortedItems.length 
                                   && oldlastid == myid) {
                            ibidme = true;
                        } else {
                            suprame = true;
                        }
                        var prev, prev_locator, prev_label, curr_locator, curr_label;
                        if (ibidme) {
                            if (k > 0) {
                                prev = onecitation.sortedItems[(k - 1)][1];
                            } else {
                                prev = citations[(j - 1)].sortedItems[0][1];
                            }
                            if (prev.locator) {
                                if (prev.label) {
                                    prev_label = prev.label;
                                } else {
                                    prev_label = "";
                                }
                                prev_locator = "" + prev.locator + prev_label;
                            } else {
                                prev_locator = prev.locator;
                            }
                            if (mylocator) {
                                if (mylabel) {
                                    curr_label = mylabel;
                                } else {
                                    curr_label = "";
                                }
                                curr_locator = "" + mylocator + curr_label;
                            } else {
                                curr_locator = mylocator;
                            }
                        }
                        if (ibidme && prev_locator && !curr_locator) {
                            ibidme = false;
                            suprame = true;
                        }
                        if (ibidme) {
                            if (!prev_locator && curr_locator) {
                                item[1].position = CSL.POSITION_IBID_WITH_LOCATOR;
                            } else if (!prev_locator && !curr_locator) {
                                item[1].position = CSL.POSITION_IBID;
                            } else if (prev_locator && curr_locator === prev_locator) {
                                item[1].position = CSL.POSITION_IBID;
                            } else if (prev_locator && curr_locator && curr_locator !== prev_locator) {
                                item[1].position = CSL.POSITION_IBID_WITH_LOCATOR;
                            } else {
                                ibidme = false; // just to be clear
                                suprame = true;
                            }
                        }
                        if (suprame) {
                            item[1].position = CSL.POSITION_SUBSEQUENT;
                        }
                        if (suprame || ibidme) {
                            if (first_ref[myid] != onecitation.properties.noteIndex) {
                                item[1]["first-reference-note-number"] = first_ref[myid];
                                if (this.registry.registry[myid]) {
                                    var oldFirst = this.registry.citationreg.citationsByItemId[myid][0].properties.noteIndex;
                                    var newFirst = onecitation.properties.noteIndex;
                                    this.registry.registry[myid]['first-reference-note-number'] = newFirst < oldFirst ? newFirst: oldFirst;
                                }
                            }
                        }
                    }
                    if (onecitation.properties.noteIndex) {
                        var note_distance = parseInt(onecitation.properties.noteIndex, 10) - parseInt(last_ref[myid], 10);
                        if (item[1].position !== CSL.POSITION_FIRST 
                            && note_distance <= this.citation.opt["near-note-distance"]) {
                            item[1]["near-note"] = true;
                        }
                        last_ref[myid] = onecitation.properties.noteIndex;
                    }
                    if (onecitation.citationID != citation.citationID) {
                        for (n = 0, nlen = CSL.POSITION_TEST_VARS.length; n < nlen; n += 1) {
                            var param = CSL.POSITION_TEST_VARS[n];
                            if (item[1][param] !== oldvalue[param]) {
                                if (this.registry.registry[myid]) {
                                    if (param === 'first-reference-note-number') {
                                        rerunAkeys[this.registry.registry[myid].ambig] = true;
                                        this.tmp.taintedItemIDs[myid] = true;
                                    }
                                }
                                this.tmp.taintedCitationIDs[onecitation.citationID] = true;
                            }
                        }
                    }
                    if (this.sys.variableWrapper) {
                        item[1].index = onecitation.properties.index;
                        item[1].noteIndex = onecitation.properties.noteIndex;
                    }
                }
            }
        }
    }
    if (this.opt.citation_number_sort && sortedItems && sortedItems.length > 1 && this.citation_sort.tokens.length > 0) {
        if (!citation.properties.unsorted) {
            for (var i = 0, ilen = sortedItems.length; i < ilen; i += 1) {
                sortedItems[i][1].sortkeys = CSL.getSortKeys.call(this, sortedItems[i][0], "citation_sort");
            }
            sortedItems.sort(this.citation.srt.compareCompositeKeys);
        }
    }
    for (var key in this.tmp.taintedItemIDs) {
        if (this.tmp.taintedItemIDs.hasOwnProperty(key)) {
            citations = this.registry.citationreg.citationsByItemId[key];
            if (citations) {
                for (var i = 0, ilen = citations.length; i < ilen; i += 1) {
                    this.tmp.taintedCitationIDs[citations[i].citationID] = true;
                }
            }
        }
    }
    var ret = [];
    if (flag === CSL.PREVIEW) {
        try {
            ret = this.process_CitationCluster.call(this, citation.sortedItems, citation.citationID);
        } catch (e) {
            CSL.error("Error running CSL processor for preview: "+e);
        }
        this.registry.citationreg.citationByIndex = oldCitationList;
        this.registry.citationreg.citationById = {};
        for (var i = 0, ilen = oldCitationList.length; i < ilen; i += 1) {
            this.registry.citationreg.citationById[oldCitationList[i].citationID] = oldCitationList[i];
        }
        var oldItemIds = [];
        for (var i = 0, ilen = oldItemList.length; i < ilen; i += 1) {
            oldItemIds.push("" + oldItemList[i].id);
        }
        this.updateItems(oldItemIds, null, null, true);
        for (var key in oldAmbigs) {
            if (oldAmbigs.hasOwnProperty(key)) {
                this.registry.registry[key].disambig = oldAmbigs[key];
            }
        }
    } else {
        for (var rerunAkey in rerunAkeys) {
            this.disambiguate.run(rerunAkey, citation);
        }
        var obj;
        for (var key in this.tmp.taintedCitationIDs) {
            if (key == citation.citationID) {
                continue;
            }
            var mycitation = this.registry.citationreg.citationById[key];
            if (!mycitation.properties.unsorted) {
                for (var i = 0, ilen = mycitation.sortedItems.length; i < ilen; i += 1) {
                    mycitation.sortedItems[i][1].sortkeys = CSL.getSortKeys.call(this, mycitation.sortedItems[i][0], "citation_sort");
                }
                mycitation.sortedItems.sort(this.citation.srt.compareCompositeKeys);
            }
            this.tmp.citation_pos = mycitation.properties.index;
            this.tmp.citation_note_index = mycitation.properties.noteIndex;
            this.tmp.citation_id = "" + mycitation.citationID;
            obj = [];
            obj.push(mycitation.properties.index);
            obj.push(this.process_CitationCluster.call(this, mycitation.sortedItems, mycitation.citationID));
            obj.push(mycitation.citationID);
            ret.push(obj);
        }
        this.tmp.taintedItemIDs = {};
        this.tmp.taintedCitationIDs = {};
        this.tmp.citation_pos = citation.properties.index;
        this.tmp.citation_note_index = citation.properties.noteIndex;
        this.tmp.citation_id = "" + citation.citationID;
        obj = [];
        obj.push(citationsPre.length);
        obj.push(this.process_CitationCluster.call(this, sortedItems, citation.citationID));
        obj.push(citation.citationID);
        ret.push(obj);
        ret.sort(function (a, b) {
            if (a[0] > b[0]) {
                return 1;
            } else if (a[0] < b[0]) {
                return -1;
            } else {
                return 0;
            }
        });
    }
    return_data.citation_errors = this.tmp.citation_errors.slice();
    return [return_data, ret];
};
CSL.Engine.prototype.process_CitationCluster = function (sortedItems, citationID) {
    var str;
    this.parallel.StartCitation(sortedItems);
    str = CSL.getCitationCluster.call(this, sortedItems, citationID);
    return str;
};
CSL.Engine.prototype.makeCitationCluster = function (rawList) {
    var inputList, newitem, str, pos, len, item, Item;
    inputList = [];
    len = rawList.length;
    for (pos = 0; pos < len; pos += 1) {
        item = {};
        for (var key in rawList[pos]) {
            item[key] = rawList[pos][key];
        }
        Item = this.retrieveItem("" + item.id);
        if (this.opt.development_extensions.locator_label_parse) {
            if (item.locator && ["bill","gazette","legislation","regulation","treaty"].indexOf(Item.type) === -1 && (!item.label || item.label === 'page')) {
                var m = CSL.LOCATOR_LABELS_REGEXP.exec(item.locator);
                if (m) {
                    var tryLabel = CSL.LOCATOR_LABELS_MAP[m[2]];
                    if (this.getTerm(tryLabel)) {
                        item.label = tryLabel;
                        item.locator = m[3];
                    }
                }
            }
        }
        if (item.locator) {
            item.locator = ("" + item.locator).replace(/\s+$/, '');
        }
        newitem = [Item, item];
        inputList.push(newitem);
    }
    if (this.opt.development_extensions.static_statute_locator) {
        this.remapSectionVariable(inputList);
    }
    if (inputList && inputList.length > 1 && this.citation_sort.tokens.length > 0) {
        len = inputList.length;
        for (pos = 0; pos < len; pos += 1) {
            inputList[pos][1].sortkeys = CSL.getSortKeys.call(this, inputList[pos][0], "citation_sort");
        }
        inputList.sort(this.citation.srt.compareCompositeKeys);
    }
    this.tmp.citation_errors = [];
    this.parallel.StartCitation(inputList);
    str = CSL.getCitationCluster.call(this, inputList);
    return str;
};
CSL.getAmbiguousCite = function (Item, disambig, visualForm, item) {
    var use_parallels, ret;
    var flags = this.tmp.group_context.tip;
    var oldTermSiblingLayer = {
        term_intended: flags.term_intended,
        variable_attempt: flags.variable_attempt,
        variable_success: flags.variable_success,
        output_tip: flags.output_tip,
        label_form: flags.label_form,
        parallel_conditions: flags.parallel_conditions,
        condition: flags.condition,
        force_suppress: flags.force_suppress,
        done_vars: flags.done_vars.slice()
    }
    if (disambig) {
        this.tmp.disambig_request = disambig;
    } else {
        this.tmp.disambig_request = false;
    }
    var itemSupp = {
        position: 1,
        "near-note": true
    };
    if (item) {
        itemSupp.locator = item.locator;
        itemSupp.label = item.label;
    }
    if (this.registry.registry[Item.id] 
        && this.registry.citationreg.citationsByItemId
        && this.registry.citationreg.citationsByItemId[Item.id]
        && this.registry.citationreg.citationsByItemId[Item.id].length 
        && visualForm) {
        if (this.citation.opt["givenname-disambiguation-rule"] === "by-cite") {
            itemSupp['first-reference-note-number'] = this.registry.registry[Item.id]['first-reference-note-number'];
        }
    }
    this.tmp.area = "citation";
    this.tmp.root = "citation";
    this.parallel.use_parallels = (this.parallel.use_parallels === true || this.parallel.use_parallels === null) ? null : false;
    this.tmp.suppress_decorations = true;
    this.tmp.just_looking = true;
    CSL.getCite.call(this, Item, itemSupp, null, false);
    for (var i=0,ilen=this.output.queue.length;i<ilen;i+=1) {
        CSL.Output.Queue.purgeEmptyBlobs(this.output.queue[i]);
    }
    if (this.opt.development_extensions.clean_up_csl_flaws) {
        for (var j=0,jlen=this.output.queue.length;j<jlen;j+=1) {
            this.output.adjust.upward(this.output.queue[j]);
            this.output.adjust.leftward(this.output.queue[j]);
            this.output.adjust.downward(this.output.queue[j]);
            this.output.adjust.fix(this.output.queue[j]);
        }
    }
    var ret = this.output.string(this, this.output.queue);
    this.tmp.just_looking = false;
    this.tmp.suppress_decorations = false;
    this.parallel.use_parallels = this.parallel.use_parallels === null ? true : false;
    this.tmp.group_context.replace(oldTermSiblingLayer);
    return ret;
};
CSL.getSpliceDelimiter = function (last_collapsed, pos) {
    if (last_collapsed && ! this.tmp.have_collapsed && "string" === typeof this.citation.opt["after-collapse-delimiter"]) {
        this.tmp.splice_delimiter = this.citation.opt["after-collapse-delimiter"];
    } else if (this.tmp.use_cite_group_delimiter) {
        this.tmp.splice_delimiter = this.citation.opt.cite_group_delimiter;
    } else if (this.tmp.have_collapsed && this.opt.xclass === "in-text" && this.opt.update_mode !== CSL.NUMERIC) {
        this.tmp.splice_delimiter = ", ";
    } else if (this.tmp.cite_locales[pos - 1]) {
        var alt_affixes = this.tmp.cite_affixes[this.tmp.area][this.tmp.cite_locales[pos - 1]];
        if (alt_affixes && alt_affixes.delimiter) {
            this.tmp.splice_delimiter = alt_affixes.delimiter;
        }
    } else if (!this.tmp.splice_delimiter) {
        this.tmp.splice_delimiter = "";
    }
    return this.tmp.splice_delimiter;
};
CSL.getCitationCluster = function (inputList, citationID) {
    var result, objects, myparams, len, pos, item, last_collapsed, params, empties, composite, compie, myblobs, Item, llen, ppos, obj, preceding_item, txt_esc, error_object;
    inputList = inputList ? inputList : [];
    this.tmp.last_primary_names_string = false;
    txt_esc = CSL.getSafeEscape(this);
    this.tmp.area = "citation";
    this.tmp.root = "citation";
    result = "";
    objects = [];
    this.tmp.last_suffix_used = "";
    this.tmp.last_names_used = [];
    this.tmp.last_years_used = [];
    this.tmp.backref_index = [];
    this.tmp.cite_locales = [];
    this.output.checkNestedBrace = new CSL.checkNestedBrace(this);
    var use_layout_prefix = this.output.checkNestedBrace.update(this.citation.opt.layout_prefix);
    var suppressTrailingPunctuation = false;
    if (this.opt.xclass === "note" && this.citation.opt.suppressTrailingPunctuation) {
        suppressTrailingPunctuation = true;
    }
    if (citationID) {
        if (this.registry.citationreg.citationById[citationID].properties["suppress-trailing-punctuation"]) {
            suppressTrailingPunctuation = true;
        }
    }
    if (this.opt.xclass === "note") {
        var parasets = [];
        var lastTitle = false;
        var lastPosition = false;
        var lastID = false;
        var lst = [];
        for (var i=0, ilen = inputList.length; i < ilen; i += 1) {
            var type = inputList[i][0].type;
            var title = inputList[i][0].title;
            var position = inputList[i][1].position;
            var id = inputList[i][0].id;
            if (title && type === "legal_case" && id !== lastID && position) {
                if (title !== lastTitle || parasets.length === 0) {
                    lst = [];
                    parasets.push(lst);
                }
                lst.push(inputList[i][1]);
            }
            lastTitle = title;
            lastPosition = position;
            lastID = id;
        }
        for (i=0, ilen=parasets.length; i < ilen; i += 1) {
            lst = parasets[i];
            if (lst.length < 2) {
                continue;
            }
            var locatorInLastPosition = lst.slice(-1)[0].locator;
            if (locatorInLastPosition) {
                for (var j=0, jlen=lst.length - 1; j < jlen; j += 1) {
                    if (lst[j].locator) {
                        locatorInLastPosition = false;
                    }
                }
            }
            if (locatorInLastPosition) {
                lst[0].locator = locatorInLastPosition;
                delete lst.slice(-1)[0].locator;
                lst[0].label = lst.slice(-1)[0].label;
                if (lst.slice(-1)[0].label) {
                    delete lst.slice(-1)[0].label;
                }
            }
       }
    }
    myparams = [];
    len = inputList.length;
    for (pos = 0; pos < len; pos += 1) {
        Item = inputList[pos][0];
        item = inputList[pos][1];
        item = CSL.parseLocator.call(this, item);
        last_collapsed = this.tmp.have_collapsed;
        params = {};
        this.tmp.shadow_numbers = {};
        if (!this.tmp.just_looking && this.opt.hasPlaceholderTerm) {
            var output = this.output;
            this.output = new CSL.Output.Queue(this);
            this.output.adjust = new CSL.Output.Queue.adjust();
            CSL.getAmbiguousCite.call(this, Item, null, false, item);
            this.output = output;
        }
        this.tmp.in_cite_predecessor = false;
        if (pos > 0) {
            CSL.getCite.call(this, Item, item, "" + inputList[(pos - 1)][0].id, true);
        } else {
            this.tmp.term_predecessor = false;
            CSL.getCite.call(this, Item, item, null, true);
        }
        if (!this.tmp.cite_renders_content) {
            error_object = {
                citationID: "" + this.tmp.citation_id,
                index: this.tmp.citation_pos,
                noteIndex: this.tmp.citation_note_index,
                itemID: "" + Item.id,
                citationItems_pos: pos,
                error_code: CSL.ERROR_NO_RENDERED_FORM
            };
            this.tmp.citation_errors.push(error_object);
        }
        if (pos === (inputList.length - 1)) {
            this.parallel.ComposeSet();
        }
        params.splice_delimiter = CSL.getSpliceDelimiter.call(this, last_collapsed, pos);
        if (item && item["author-only"]) {
            this.tmp.suppress_decorations = true;
        }
        if (pos > 0) {
            preceding_item = inputList[pos - 1][1];
            var precedingEndsInPeriodOrComma = preceding_item.suffix && [".", ","].indexOf(preceding_item.suffix.slice(-1)) > -1;
            var currentStartsWithPeriodOrComma = !preceding_item.suffix && item.prefix && [".", ","].indexOf(item.prefix.slice(0, 1)) > -1;
            if (precedingEndsInPeriodOrComma || currentStartsWithPeriodOrComma) {
                var spaceidx = params.splice_delimiter.indexOf(" ");
                if (spaceidx > -1 && !currentStartsWithPeriodOrComma) {
                    params.splice_delimiter = params.splice_delimiter.slice(spaceidx);
                } else {
                    params.splice_delimiter = "";
                }
            }
        }
        params.suppress_decorations = this.tmp.suppress_decorations;
        params.have_collapsed = this.tmp.have_collapsed;
        myparams.push(params);
    }
    this.tmp.has_purged_parallel = false;
    this.parallel.PruneOutputQueue(this);
    empties = 0;
    myblobs = this.output.queue.slice();
    var fakeblob = {
        strings: {
            suffix: this.citation.opt.layout_suffix,
            delimiter: this.citation.opt.layout_delimiter                
        }
    };
    var suffix = this.citation.opt.layout_suffix;
    var last_locale = this.tmp.cite_locales[this.tmp.cite_locales.length - 1];
    if (last_locale && this.tmp.cite_affixes[this.tmp.area][last_locale] && this.tmp.cite_affixes[this.tmp.area][last_locale].suffix) {
        suffix = this.tmp.cite_affixes[this.tmp.area][last_locale].suffix;
    }
    if (CSL.TERMINAL_PUNCTUATION.slice(0, -1).indexOf(suffix.slice(0, 1)) > -1) {
        suffix = suffix.slice(0, 1);
    }
    var delimiter = this.citation.opt.layout_delimiter;
    if (!delimiter) {
        delimiter = "";
    }
    if (CSL.TERMINAL_PUNCTUATION.slice(0, -1).indexOf(delimiter.slice(0, 1)) > -1) {
        delimiter = delimiter.slice(0, 1);
    }
    suffix = this.output.checkNestedBrace.update(suffix);
    for (var i=0,ilen=this.output.queue.length;i<ilen;i+=1) {
        CSL.Output.Queue.purgeEmptyBlobs(this.output.queue[i]);
    }
    if (!this.tmp.suppress_decorations && this.output.queue.length) {
        if (!(this.opt.development_extensions.apply_citation_wrapper
              && this.sys.wrapCitationEntry
               && !this.tmp.just_looking
              && this.tmp.area === "citation")) { 
            if (!suppressTrailingPunctuation) {
                this.output.queue[this.output.queue.length - 1].strings.suffix = suffix;
            }
            this.output.queue[0].strings.prefix = use_layout_prefix;
        }
    }
    if (this.opt.development_extensions.clean_up_csl_flaws) {
        for (var j=0,jlen=this.output.queue.length;j<jlen;j+=1) {
            this.output.adjust.upward(this.output.queue[j]);
            this.output.adjust.leftward(this.output.queue[j]);
            this.output.adjust.downward(this.output.queue[j]);
            this.tmp.last_chr = this.output.adjust.fix(this.output.queue[j]);
        }
    }
    for (pos = 0, len = myblobs.length; pos < len; pos += 1) {
        var buffer = [];
        this.output.queue = [myblobs[pos]];
        this.tmp.suppress_decorations = myparams[pos].suppress_decorations;
        this.tmp.splice_delimiter = myparams[pos].splice_delimiter;
        if (myblobs[pos].parallel_delimiter) {
            this.tmp.splice_delimiter = myblobs[pos].parallel_delimiter;
        }
        this.tmp.have_collapsed = myparams[pos].have_collapsed;
        composite = this.output.string(this, this.output.queue);
        this.tmp.suppress_decorations = false;
        if ("string" === typeof composite) {
            this.tmp.suppress_decorations = false;
            return composite;
        }
        if ("object" === typeof composite && composite.length === 0 && !item["suppress-author"]) {
            if (this.tmp.has_purged_parallel) {
                composite.push("");
            } else {
                var errStr = "[CSL STYLE ERROR: reference with no printed form.]";
                var preStr = pos === 0 ? txt_esc(this.citation.opt.layout_prefix) : "";
                var sufStr = pos === (myblobs.length - 1) ? txt_esc(this.citation.opt.layout_suffix) : "";
                composite.push(preStr + errStr + sufStr);
            }
        }
        if (buffer.length && "string" === typeof composite[0]) {
            composite.reverse();
            var tmpstr = composite.pop();
            if (tmpstr && tmpstr.slice(0, 1) === ",") {
                buffer.push(tmpstr);
            } else if ("string" == typeof buffer.slice(-1)[0] && buffer.slice(-1)[0].slice(-1) === ",") {
                buffer.push(" " + tmpstr);
            } else if (tmpstr) {
                buffer.push(txt_esc(this.tmp.splice_delimiter) + tmpstr);
            }
        } else {
            composite.reverse();
            compie = composite.pop();
            if ("undefined" !== typeof compie) {
                if (buffer.length && "string" === typeof buffer[buffer.length - 1]) {
                    buffer[buffer.length - 1] += compie.successor_prefix;
                }
                buffer.push(compie);
            }
        }
        llen = composite.length;
        for (ppos = 0; ppos < llen; ppos += 1) {
            obj = composite[ppos];
            if ("string" === typeof obj) {
                buffer.push(txt_esc(this.tmp.splice_delimiter) + obj);
                continue;
            }
            compie = composite.pop();
            if ("undefined" !== typeof compie) {
                buffer.push(compie);
            }
        }
        if (buffer.length === 0 && !inputList[pos][1]["suppress-author"]) {
            empties += 1;
        }
        if (buffer.length > 1 && typeof buffer[0] !== "string") {
            buffer = [this.output.renderBlobs(buffer)];
        }
        if (buffer.length) {
            if ("string" === typeof buffer[0]) {
                if (pos > 0) {
                    if (((myblobs.length-1) > pos && myparams[pos+1].have_collapsed) && !myparams[pos].have_collapsed) {
                        this.tmp.splice_delimiter = myparams[pos-1].splice_delimiter;
                    }
                    buffer[0] = txt_esc(this.tmp.splice_delimiter) + buffer[0];
                }
            } else {
                if (pos > 0) {
                    buffer[0].splice_prefix = this.tmp.splice_delimiter;
                } else {
                    buffer[0].splice_prefix = "";
                }
            }
        }
        objects = objects.concat(buffer);
    }
    result += this.output.renderBlobs(objects);
    if (result) {
        if (!this.tmp.suppress_decorations) {
            len = this.citation.opt.layout_decorations.length;
            for (pos = 0; pos < len; pos += 1) {
                params = this.citation.opt.layout_decorations[pos];
                if (params[1] === "normal") {
                    continue;
                }
                if (!item || !item["author-only"]) {
                    result = this.fun.decorate[params[0]][params[1]](this, result);
                }
            }
        }
    }
    this.tmp.suppress_decorations = false;
    return result;
};
CSL.getCite = function (Item, item, prevItemID, blockShadowNumberReset) {
    var next, error_object;
    this.tmp.cite_renders_content = false;
    this.parallel.StartCite(Item, item, prevItemID);
    CSL.citeStart.call(this, Item, item, blockShadowNumberReset);
    next = 0;
    this.tmp.name_node = {};
    this.nameOutput = new CSL.NameOutput(this, Item, item);
    while (next < this[this.tmp.area].tokens.length) {
        next = CSL.tokenExec.call(this, this[this.tmp.area].tokens[next], Item, item);
    }
    CSL.citeEnd.call(this, Item, item);
    this.parallel.CloseCite(this);
    if (!this.tmp.cite_renders_content && !this.tmp.just_looking) {
        if (this.tmp.area === "bibliography") {
            error_object = {
                index: this.tmp.bibliography_pos,
                itemID: "" + Item.id,
                error_code: CSL.ERROR_NO_RENDERED_FORM
            };
            this.tmp.bibliography_errors.push(error_object);
        }
    }
    return "" + Item.id;
};
CSL.citeStart = function (Item, item, blockShadowNumberReset) {
    if (!blockShadowNumberReset) {
        this.tmp.shadow_numbers = {};
    }
    this.tmp.disambiguate_count = 0;
    this.tmp.disambiguate_maxMax = 0;
    this.tmp.same_author_as_previous_cite = false;
    if (!this.tmp.suppress_decorations) {
        this.tmp.subsequent_author_substitute_ok = true;
    } else {
        this.tmp.subsequent_author_substitute_ok = false;
    }
    this.tmp.lastchr = "";
    if (this.tmp.area === "citation" && this.citation.opt.collapse && this.citation.opt.collapse.length) {
        this.tmp.have_collapsed = true;
    } else {
        this.tmp.have_collapsed = false;
    }
    this.tmp.render_seen = false;
    if (this.tmp.disambig_request  && ! this.tmp.disambig_override) {
        this.tmp.disambig_settings = this.tmp.disambig_request;
    } else if (this.registry.registry[Item.id] && ! this.tmp.disambig_override) {
        this.tmp.disambig_request = this.registry.registry[Item.id].disambig;
        this.tmp.disambig_settings = this.registry.registry[Item.id].disambig;
    } else {
        this.tmp.disambig_settings = new CSL.AmbigConfig();
    }
    if (this.tmp.area !== 'citation') {
        if (!this.registry.registry[Item.id]) {
            this.tmp.disambig_restore = new CSL.AmbigConfig();
        } else {
            this.tmp.disambig_restore = CSL.cloneAmbigConfig(this.registry.registry[Item.id].disambig);
            if (this.tmp.area === 'bibliography' && this.tmp.disambig_settings && this.tmp.disambig_override) {
                if (this.opt["disambiguate-add-names"]) {
                    this.tmp.disambig_settings.names = this.registry.registry[Item.id].disambig.names.slice();
                    if (this.tmp.disambig_request) {
                        this.tmp.disambig_request.names = this.registry.registry[Item.id].disambig.names.slice();
                    }
                }
                if (this.opt["disambiguate-add-givenname"]) {
                    this.tmp.disambig_request = this.tmp.disambig_settings;
                    this.tmp.disambig_settings.givens = this.registry.registry[Item.id].disambig.givens.slice();
                    this.tmp.disambig_request.givens = this.registry.registry[Item.id].disambig.givens.slice();
                    for (var i=0,ilen=this.tmp.disambig_settings.givens.length;i<ilen;i+=1) {
                        this.tmp.disambig_settings.givens[i] = this.registry.registry[Item.id].disambig.givens[i].slice();
                    }
                    for (var i=0,ilen=this.tmp.disambig_request.givens.length;i<ilen;i+=1) {
                        this.tmp.disambig_request.givens[i] = this.registry.registry[Item.id].disambig.givens[i].slice();
                    }
                }
            }
        }
    }
    this.tmp.names_used = [];
    this.tmp.nameset_counter = 0;
    this.tmp.years_used = [];
    this.tmp.names_max.clear();
    this.tmp.splice_delimiter = this[this.tmp.area].opt.layout_delimiter;
    this.bibliography_sort.keys = [];
    this.citation_sort.keys = [];
    this.tmp.has_done_year_suffix = false;
    this.tmp.last_cite_locale = false;
    if (!this.tmp.just_looking && item && !item.position && this.registry.registry[Item.id]) {
        this.tmp.disambig_restore = CSL.cloneAmbigConfig(this.registry.registry[Item.id].disambig);
    }
    this.tmp.first_name_string = false;
    this.tmp.authority_stop_last = 0;
};
CSL.citeEnd = function (Item, item) {
    if (this.tmp.disambig_restore && this.registry.registry[Item.id]) {
        this.registry.registry[Item.id].disambig.names = this.tmp.disambig_restore.names.slice();
        this.registry.registry[Item.id].disambig.givens = this.tmp.disambig_restore.givens.slice();
        for (var i=0,ilen=this.registry.registry[Item.id].disambig.givens.length;i<ilen;i+=1) {
            this.registry.registry[Item.id].disambig.givens[i] = this.tmp.disambig_restore.givens[i].slice();
        }
    }
    this.tmp.disambig_restore = false;
    if (item && item.suffix) {
        this.tmp.last_suffix_used = item.suffix;
    } else {
        this.tmp.last_suffix_used = "";
    }
    this.tmp.last_years_used = this.tmp.years_used.slice();
    this.tmp.last_names_used = this.tmp.names_used.slice();
    this.tmp.cut_var = false;
    this.tmp.disambig_request = false;
    this.tmp.cite_locales.push(this.tmp.last_cite_locale);
    if (this.tmp.issued_date && this.tmp.renders_collection_number) {
        var buf = [];
        for (var i = this.tmp.issued_date.list.length - 1; i > this.tmp.issued_date.pos; i += -1) {
            buf.push(this.tmp.issued_date.list.pop());
        }
        this.tmp.issued_date.list.pop();
        for (i = buf.length - 1; i > -1; i += -1) {
            this.tmp.issued_date.list.push(buf.pop());
        }
        if (this.parallel.use_parallels) {
            this.parallel.cite["issued"] = false;
        }
    }
    this.tmp.issued_date = false;
    this.tmp.renders_collection_number = false;
};
module.exports = CSL;
CSL.Engine.prototype.makeBibliography = function (bibsection) {
    var debug, ret, params, maxoffset, item, len, pos, tok, tokk, tokkk, entry_ids, entry_strings, bibliography_errors;
    debug = false;
    if (!this.bibliography.tokens.length) {
        return false;
    }
    if ("string" === typeof bibsection) {
        this.opt.citation_number_slug = bibsection;
        bibsection = false;
    }
    ret = CSL.getBibliographyEntries.call(this, bibsection);
    entry_ids = ret[0];
    entry_strings = ret[1];
    var done = ret[2];
    params = {
        "maxoffset": 0,
        "entryspacing": this.bibliography.opt["entry-spacing"],
        "linespacing": this.bibliography.opt["line-spacing"],
        "second-field-align": false,
        "entry_ids": entry_ids,
        "bibliography_errors": this.tmp.bibliography_errors.slice(),
        "done": done
    };
    if (this.bibliography.opt["second-field-align"]) {
        params["second-field-align"] = this.bibliography.opt["second-field-align"];
    }
    maxoffset = 0;
    len = this.registry.reflist.length;
    for (pos = 0; pos < len; pos += 1) {
        item = this.registry.reflist[pos];
        if (item.offset > params.maxoffset) {
            params.maxoffset = item.offset;
        }
    }
    if (this.bibliography.opt.hangingindent) {
        params.hangingindent = this.bibliography.opt.hangingindent;
    }
    params.bibstart = this.fun.decorate.bibstart;
    params.bibend = this.fun.decorate.bibend;
    this.opt.citation_number_slug = false;
    return [params, entry_strings];
};
CSL.getBibliographyEntries = function (bibsection) {
    var ret, input, include, anymatch, allmatch, bib_entry, res, len, pos, item, llen, ppos, spec, lllen, pppos, bib_layout, topblobs, all_item_ids, entry_item_ids, debug, collapse_parallel, i, ilen, siblings, skips, sortedItems, eyetem, chr, entry_item_data, j, jlen, newIDs, originalIDs;
    ret = [];
    entry_item_data = [];
    this.tmp.area = "bibliography";
    this.tmp.root = "bibliography";
    this.tmp.last_rendered_name = false;
    this.tmp.bibliography_errors = [];
    this.tmp.bibliography_pos = 0;
    if (bibsection && bibsection.page_start && bibsection.page_length) {
        input = this.registry.getSortedIds();        
    } else {
        input = this.retrieveItems(this.registry.getSortedIds());
    }
    this.tmp.disambig_override = true;
    function eval_string(a, b) {
        if (a === b) {
            return true;
        }
        return false;
    }
    function eval_list(a, lst) {
        lllen = lst.length;
        for (pppos = 0; pppos < lllen; pppos += 1) {
            if (eval_string(a, lst[pppos])) {
                return true;
            }
        }
        return false;
    }
    function eval_spec(a, b) {
        if ((a === "none" || !a) && !b) {
            return true;
        }
        if ("string" === typeof b) {
            return eval_string(a, b);
        } else if (!b) {
            return false;
        } else {
            return eval_list(a, b);
        }
    }
    skips = {};
    var page_item_count;
    if (bibsection && bibsection.page_start && bibsection.page_length) {
        page_item_count = 0;
        if (bibsection.page_start !== true) {
            for (var i = 0, ilen = input.length; i < ilen; i += 1) {
                skips[input[i]] = true;
                if (bibsection.page_start == input[i]) {
                    break;
                }
            }
        }
    }
    var processed_item_ids = [];
    for (var i = 0, ilen = input.length; i < ilen; i += 1) {
        if (bibsection && bibsection.page_start && bibsection.page_length) {
            if (skips[input[i]]) {
                continue;
            }
            item = this.retrieveItem(input[i]);
            if (page_item_count === bibsection.page_length) {
                break;
            }
        } else {
            item = input[i];
            if (skips[item.id]) {
                continue;
            }
        }
        if (bibsection) {
            include = true;
            if (bibsection.include) {
                include = false;
                for (j = 0, jlen = bibsection.include.length; j < jlen; j += 1) {
                    spec = bibsection.include[j];
                    if (eval_spec(spec.value, item[spec.field])) {
                        include = true;
                        break;
                    }
                }
            } else if (bibsection.exclude) {
                anymatch = false;
                for (j = 0, jlen = bibsection.exclude.length; j < jlen; j += 1) {
                    spec = bibsection.exclude[j];
                    if (eval_spec(spec.value, item[spec.field])) {
                        anymatch = true;
                        break;
                    }
                }
                if (anymatch) {
                    include = false;
                }
            } else if (bibsection.select) {
                include = false;
                allmatch = true;
                for (j = 0, jlen = bibsection.select.length; j < jlen; j += 1) {
                    spec = bibsection.select[j];
                    if (!eval_spec(spec.value, item[spec.field])) {
                        allmatch = false;
                    }
                }
                if (allmatch) {
                    include = true;
                }
            }
            if (bibsection.quash) {
                allmatch = true;
                for (j = 0, jlen = bibsection.quash.length; j < jlen; j += 1) {
                    spec = bibsection.quash[j];
                    if (!eval_spec(spec.value, item[spec.field])) {
                        allmatch = false;
                    }
                }
                if (allmatch) {
                    include = false;
                }
            }
            if (!include) {
                continue;
            }
        }
        bib_entry = new CSL.Token("group", CSL.START);
        bib_entry.decorations = [["@bibliography", "entry"]].concat(this.bibliography.opt.layout_decorations);
        this.output.startTag("bib_entry", bib_entry);
        if (item.system_id && this.sys.embedBibliographyEntry) {
            this.output.current.value().item_id = item.system_id;
        } else {
            this.output.current.value().system_id = item.id;
        }
        sortedItems = [[{id: "" + item.id}, item]];
        entry_item_ids = [];
        if (this.registry.registry[item.id].master 
            && !(bibsection && bibsection.page_start && bibsection.page_length)) {
            collapse_parallel = true;
            this.parallel.StartCitation(sortedItems);
            this.output.queue[0].strings.delimiter = ", ";
            this.tmp.term_predecessor = false;
            entry_item_ids.push("" + CSL.getCite.call(this, item));
            skips[item.id] = true;
            siblings = this.registry.registry[item.id].siblings;
            for (j = 0, jlen = siblings.length; j < jlen; j += 1) {
                var k = this.registry.registry[item.id].siblings[j];
                eyetem = this.retrieveItem(k);
                entry_item_ids.push("" + CSL.getCite.call(this, eyetem));
                skips[eyetem.id] = true;
            }
            this.parallel.ComposeSet();
            this.parallel.PruneOutputQueue();
        } else if (!this.registry.registry[item.id].siblings) {
            this.parallel.StartCitation(sortedItems);
            this.tmp.term_predecessor = false;
            entry_item_ids.push("" + CSL.getCite.call(this, item));
            if (bibsection && bibsection.page_start && bibsection.page_length) {
                page_item_count += 1;
            }
        }
        entry_item_data.push("");
        this.tmp.bibliography_pos += 1;
        processed_item_ids.push(entry_item_ids);
        this.output.endTag("bib_entry");
        if (this.output.queue[0].blobs.length && this.output.queue[0].blobs[0].blobs.length) {
            if (collapse_parallel || !this.output.queue[0].blobs[0].blobs[0].strings) {
                topblobs = this.output.queue[0].blobs;
                collapse_parallel = false;
            } else {
                topblobs = this.output.queue[0].blobs[0].blobs;
            }
            topblobs[0].strings.prefix = this.bibliography.opt.layout_prefix + topblobs[0].strings.prefix;
        }
        for (var j=0,jlen=this.output.queue.length;j<jlen;j+=1) {
            CSL.Output.Queue.purgeEmptyBlobs(this.output.queue[j]);
        }
        for (var j=0,jlen=this.output.queue.length;j<jlen;j+=1) {
            this.output.adjust.upward(this.output.queue[j]);
            this.output.adjust.leftward(this.output.queue[j]);
            this.output.adjust.downward(this.output.queue[j],true);
            this.output.adjust.fix(this.output.queue[j]);
        }
        var res = this.output.string(this, this.output.queue)[0];
        if (!res && this.opt.update_mode === CSL.NUMERIC) {
            var err = (ret.length + 1) + ". [CSL STYLE ERROR: reference with no printed form.]"
            res = CSL.Output.Formats[this.opt.mode]["@bibliography/entry"](this, err) 
        }
        if (res) {
            ret.push(res);
        }
    }
    var done = false;
    if (bibsection && bibsection.page_start && bibsection.page_length) {
        var last_expected_id = input.slice(-1)[0];
        var last_seen_id = processed_item_ids.slice(-1)[0];
        if (!last_expected_id || !last_seen_id || last_expected_id == last_seen_id) {
            done = true;
        }
    }
    this.tmp.disambig_override = false;
    return [processed_item_ids, ret, done];
};
module.exports = CSL;
CSL.Engine.prototype.setCitationId = function (citation, force) {
    var ret, id, direction;
    ret = false;
    if (!citation.citationID || force) {
        id = Math.floor(Math.random() * 100000000000000);
        while (true) {
            direction = 0;
            if (!this.registry.citationreg.citationById[id]) {
                citation.citationID = "a" + id.toString(32);
                break;
            } else if (!direction && id < 50000000000000) {
                direction = 1;
            } else {
                direction = -1;
            }
            if (direction === 1) {
                id += 1;
            } else {
                id += -1;
            }
        }
        ret = "" + id;
    }
    this.registry.citationreg.citationById[citation.citationID] = citation;
    return ret;
};
module.exports = CSL;
CSL.Engine.prototype.rebuildProcessorState = function (citations, mode, uncitedItemIDs) {
    if (!citations) {
        citations = [];
    }
    if (!mode) {
        mode = 'html';
    }
    var doneIDs = {};
    var itemIDs = [];
    for (var i=0,ilen=citations.length;i<ilen;i+=1) {
        for (var j=0,jlen=citations[i].citationItems.length;j<jlen;j+=1) {
            var itemID = "" + citations[i].citationItems[j].id;
            if (!doneIDs[itemID]) {
                itemIDs.push(itemID);
            }
            doneIDs[itemID] = true;
        }
    }
    this.updateItems(itemIDs);
    var pre = [];
    var post = [];
    var ret = [];
    var oldMode = this.opt.mode;
    this.setOutputFormat(mode);
    for (var i=0,ilen=citations.length;i<ilen;i+=1) {
        var res = this.processCitationCluster(citations[i],pre,post,CSL.ASSUME_ALL_ITEMS_REGISTERED);
        pre.push([citations[i].citationID,citations[i].properties.noteIndex]);
        for (var j=0,jlen=res[1].length;j<jlen;j+=1) {
            var index = res[1][j][0];
            ret[index] = [
                pre[index][0],
                pre[index][1],
                res[1][j][1]
            ];
        }
    }
    this.updateUncitedItems(uncitedItemIDs);
    this.setOutputFormat(oldMode);
    return ret;
}
CSL.Engine.prototype.restoreProcessorState = function (citations) {
    var i, ilen, j, jlen, item, Item, newitem, citationList, itemList, sortedItems;
    citationList = [];
    itemList = [];
    if (!citations) {
        citations = [];
    }
    var indexNumbers = [];
    var citationIds = {};
    for (i = 0, ilen = citations.length; i < ilen; i += 1) {
        if (citationIds[citations[i].citationID]) {
            this.setCitationId(citations[i], true);
        }
        citationIds[citations[i].citationID] = true;
        indexNumbers.push(citations[i].properties.index);
    }
    var oldCitations = citations.slice();
    oldCitations.sort(
        function (a,b) {
            if (a.properties.index < b.properties.index) {
                return -1;
            } else if (a.properties.index > b.properties.index) {
                return 1;
            } else {
                return 0;
            }
        }
    );
    for (i = 0, ilen = oldCitations.length; i < ilen; i += 1) {
        oldCitations[i].properties.index = i;
    }
    for (i = 0, ilen = oldCitations.length; i < ilen; i += 1) {
        sortedItems = [];
        for (j = 0, jlen = oldCitations[i].citationItems.length; j < jlen; j += 1) {
            item = oldCitations[i].citationItems[j];
            if ("undefined" === typeof item.sortkeys) {
                item.sortkeys = [];
            }
            Item = this.retrieveItem("" + item.id);
            newitem = [Item, item];
            sortedItems.push(newitem);
            oldCitations[i].citationItems[j].item = Item;
            itemList.push("" + item.id);
        }
        if (!oldCitations[i].properties.unsorted) {
            sortedItems.sort(this.citation.srt.compareCompositeKeys);
        }
        oldCitations[i].sortedItems = sortedItems;
        this.registry.citationreg.citationById[oldCitations[i].citationID] = oldCitations[i];
    }
    this.updateItems(itemList);
    for (i = 0, ilen = citations.length; i < ilen; i += 1) {
        citationList.push(["" + citations[i].citationID, citations[i].properties.noteIndex]);
    }
    var ret = [];
    if (citations && citations.length) {
        ret = this.processCitationCluster(citations[0], [], citationList.slice(1));
    } else {
        this.registry = new CSL.Registry(this);
        this.tmp = new CSL.Engine.Tmp();
        this.disambiguate = new CSL.Disambiguation(this);
    }
    return ret;
};
CSL.Engine.prototype.updateItems = function (idList, nosort, rerun_ambigs, implicitUpdate) {
    var debug = false;
    var oldArea = this.tmp.area;
    var oldRoot = this.tmp.root;
    var oldExtension = this.tmp.extension;
    this.tmp.area = "citation";
    this.tmp.root = "citation";
    this.tmp.extension = "";
    if (!implicitUpdate) {
        this.tmp.loadedItemIDs = {};
    }
    this.registry.init(idList);
	if (rerun_ambigs) {
		for (var ambig in this.registry.ambigcites) {
			this.registry.ambigsTouched[ambig] = true;
		}
	}
    this.registry.dodeletes(this.registry.myhash);
    this.registry.doinserts(this.registry.mylist);
    this.registry.dorefreshes();
    this.registry.rebuildlist();
    this.registry.setsortkeys();
    this.registry.setdisambigs();
    if (!nosort) {
        this.registry.sorttokens();
    }
    this.registry.renumber();
    this.tmp.extension = oldExtension;
    this.tmp.area = oldArea;
    this.tmp.root = oldRoot;
    return this.registry.getSortedIds();
};
CSL.Engine.prototype.updateUncitedItems = function (idList, nosort) {
    var debug = false;
    var oldArea = this.tmp.area;
    var oldRoot = this.tmp.root;
    var oldExtension = this.tmp.extension;
    this.tmp.area = "citation";
    this.tmp.root = "citation"
    this.tmp.extension = ""
    this.tmp.loadedItemIDs = {};
    if (!idList) {
        idList = [];
    }
    if ("object" == typeof idList) {
        if ("undefined" == typeof idList.length) {
            var idHash = idList;
            idList = [];
            for (var key in idHash) {
                idList.push(key);
            }
        } else if ("number" == typeof idList.length) {
            var idHash = {};
            for (var i=0,ilen=idList.length;i<ilen;i+=1) {
                idHash[idList[i]] = true;
            }
        }
    }
    this.registry.init(idList, true);
    this.registry.dopurge(idHash);
    this.registry.doinserts(this.registry.mylist);
    this.registry.dorefreshes();
    this.registry.rebuildlist();
    this.registry.setsortkeys();
    this.registry.setdisambigs();
    if (!nosort) {
        this.registry.sorttokens();
    }
    this.registry.renumber();
    this.tmp.extension = oldExtension;
    this.tmp.area = oldArea;
    this.tmp.root = oldRoot;
    return this.registry.getSortedIds();
};
module.exports = CSL;
CSL.localeResolve = function (langstr, defaultLocale) {
    var ret, langlst;
    if (!defaultLocale) {
        defaultLocale = "en-US";
    }
    if (!langstr) {
        langstr = defaultLocale;
    }
    ret = {};
    langlst = langstr.split(/[\-_]/);
    ret.base = CSL.LANG_BASES[langlst[0]];
    if ("undefined" === typeof ret.base) {
        return {base:defaultLocale, best:langstr, bare:langlst[0]};
    }
    if (langlst.length === 1) {
        ret.generic = true;
    }
    if (langlst.length === 1 || langlst[1] === "x") {
        ret.best = ret.base.replace("_", "-");
    } else {
        ret.best = langlst.slice(0, 2).join("-");
    }
    ret.base = ret.base.replace("_", "-");
    ret.bare = langlst[0];
    return ret;
};
CSL.Engine.prototype.localeConfigure = function (langspec, beShy) {
    var localexml;
    if (beShy && this.locale[langspec.best]) {
        return;
    }
    if (langspec.best === "en-US") {
        localexml = CSL.setupXml(this.sys.retrieveLocale("en-US"));
        this.localeSet(localexml, "en-US", langspec.best);
    } else if (langspec.best !== "en-US") {
        if (langspec.base !== langspec.best) {
            localexml = CSL.setupXml(this.sys.retrieveLocale(langspec.base));
            this.localeSet(localexml, langspec.base, langspec.best);
        }
        localexml = CSL.setupXml(this.sys.retrieveLocale(langspec.best));
        this.localeSet(localexml, langspec.best, langspec.best);        
    }
    this.localeSet(this.cslXml, "", langspec.best);
    this.localeSet(this.cslXml, langspec.bare, langspec.best);
    if (langspec.base !== langspec.best) {
        this.localeSet(this.cslXml, langspec.base, langspec.best);
    }
    this.localeSet(this.cslXml, langspec.best, langspec.best);
    if ("undefined" === typeof this.locale[langspec.best].terms["page-range-delimiter"]) {
        if (["fr", "pt"].indexOf(langspec.best.slice(0, 2).toLowerCase()) > -1) {
            this.locale[langspec.best].terms["page-range-delimiter"] = "-";
        } else {
            this.locale[langspec.best].terms["page-range-delimiter"] = "\u2013";
        }
    }
    if ("undefined" === typeof this.locale[langspec.best].terms["year-range-delimiter"]) {
        this.locale[langspec.best].terms["year-range-delimiter"] = "\u2013";
    }
    if ("undefined" === typeof this.locale[langspec.best].terms["citation-range-delimiter"]) {
        this.locale[langspec.best].terms["citation-range-delimiter"] = "\u2013";
    }
    if (this.opt.development_extensions.normalize_lang_keys_to_lowercase) {
        var localeLists = ["default-locale","locale-sort","locale-translit","locale-translat"];
        for (var i=0,ilen=localeLists.length;i<ilen;i+=1) {
            for (var j=0,jlen=this.opt[localeLists[i]].length;j<jlen;j+=1) {
                this.opt[localeLists[i]][j] = this.opt[localeLists[i]][j].toLowerCase();
            }
        }
        this.opt.lang = this.opt.lang.toLowerCase();
    }
};
CSL.Engine.prototype.localeSet = function (myxml, lang_in, lang_out) {
    var blob, locale, nodes, attributes, pos, ppos, term, form, termname, styleopts, attr, date, attrname, len, genderform, target, i, ilen;
    lang_in = lang_in.replace("_", "-");
    lang_out = lang_out.replace("_", "-");
    if (this.opt.development_extensions.normalize_lang_keys_to_lowercase) {
        lang_in = lang_in.toLowerCase();
        lang_out = lang_out.toLowerCase();
    }
    if (!this.locale[lang_out]) {
        this.locale[lang_out] = {};
        this.locale[lang_out].terms = {};
        this.locale[lang_out].opts = {};
        this.locale[lang_out].opts["skip-words"] = CSL.SKIP_WORDS;
        if (!this.locale[lang_out].opts["leading-noise-words"]) {
            this.locale[lang_out].opts["leading-noise-words"] = [];
        }
        this.locale[lang_out].dates = {};
        this.locale[lang_out].ord = {'1.0.1':false,keys:{}};
        this.locale[lang_out]["noun-genders"] = {};
    }
    locale = myxml.makeXml();
    if (myxml.nodeNameIs(myxml.dataObj, 'locale')) {
        locale = myxml.dataObj;
    } else {
        nodes = myxml.getNodesByName(myxml.dataObj, "locale");
        for (pos = 0, len = myxml.numberofnodes(nodes); pos < len; pos += 1) {
            blob = nodes[pos];
            if (myxml.getAttributeValue(blob, 'lang', 'xml') === lang_in) {
                locale = blob;
                break;
            }
        }
    }
    nodes = myxml.getNodesByName(locale, 'type');
    for (i = 0, ilen = myxml.numberofnodes(nodes); i < ilen; i += 1) {
        var typenode = nodes[i];
        var type = myxml.getAttributeValue(typenode, 'name');
        var gender = myxml.getAttributeValue(typenode, 'gender');
        this.opt.gender[type] = gender;
    }
    var hasCslOrdinals101 = myxml.getNodesByName(locale, 'term', 'ordinal').length;
    if (hasCslOrdinals101) {
        for (var key in this.locale[lang_out].ord.keys) {
            delete this.locale[lang_out].terms[key];
        }
        this.locale[lang_out].ord = {"1.0.1":false,keys:{}};
    }
    nodes = myxml.getNodesByName(locale, 'term');
    var ordinals101 = {"last-digit":{},"last-two-digits":{},"whole-number":{}};
    var ordinals101_toggle = false;
    var genderized_terms = {};
    for (pos = 0, len = myxml.numberofnodes(nodes); pos < len; pos += 1) {
        term = nodes[pos];
        termname = myxml.getAttributeValue(term, 'name');
        if (termname === "sub verbo") {
            termname = "sub-verbo";
        }
        if (termname.slice(0,7) === "ordinal") {
            var termstring = myxml.getNodeValue(term);
            if (termname === "ordinal") {
                ordinals101_toggle = true;
            } else {
                var match = myxml.getAttributeValue(term, 'match');
                var termstub = termname.slice(8);
                var genderform = myxml.getAttributeValue(term, 'gender-form');
                if (!genderform) {
                    genderform = "neuter";
                }
                if (!match) {
                    match = "last-two-digits";
                    if (termstub.slice(0,1) === "0") {
                        match = "last-digit";
                    }
                }
                if (termstub.slice(0,1) === "0") {
                    termstub = termstub.slice(1);
                }
                if (!ordinals101[match][termstub]) {
                    ordinals101[match][termstub] = {};
                }
                ordinals101[match][termstub][genderform] = termname;
            }
            this.locale[lang_out].ord.keys[termname] = true;
        }
        if ("undefined" === typeof this.locale[lang_out].terms[termname]) {
            this.locale[lang_out].terms[termname] = {};
        }
        form = "long";
        genderform = false;
        if (myxml.getAttributeValue(term, 'form')) {
            form = myxml.getAttributeValue(term, 'form');
        }
        if (myxml.getAttributeValue(term, 'gender-form')) {
            genderform = myxml.getAttributeValue(term, 'gender-form');
        }
        if (myxml.getAttributeValue(term, 'gender')) {
            this.locale[lang_out]["noun-genders"][termname] = myxml.getAttributeValue(term, 'gender');
        }
        if (genderform) {
            this.locale[lang_out].terms[termname][genderform] = {};
            this.locale[lang_out].terms[termname][genderform][form] = [];
            target = this.locale[lang_out].terms[termname][genderform];
            genderized_terms[termname] = true;
        } else {
            this.locale[lang_out].terms[termname][form] = [];
            target = this.locale[lang_out].terms[termname];
        }
        if (myxml.numberofnodes(myxml.getNodesByName(term, 'multiple'))) {
            target[form][0] = myxml.getNodeValue(term, 'single');
            if (target[form][0].indexOf("%s") > -1) {
                this.opt.hasPlaceholderTerm = true;
            }
            target[form][1] = myxml.getNodeValue(term, 'multiple');
            if (target[form][1].indexOf("%s") > -1) {
                this.opt.hasPlaceholderTerm = true;
            }
        } else {
            target[form] = myxml.getNodeValue(term);
            if (target[form].indexOf("%s") > -1) {
                this.opt.hasPlaceholderTerm = true;
            }
        }
    }
    if (ordinals101_toggle) {
        for (var ikey in genderized_terms) {
            var gender_segments = {};
            var form_segments = 0;
            for (var jkey in this.locale[lang_out].terms[ikey]) {
                if (["masculine","feminine"].indexOf(jkey) > -1) {
                    gender_segments[jkey] = this.locale[lang_out].terms[ikey][jkey];
                } else {
                    form_segments += 1;
                }
            }
            if (!form_segments) {
                if (gender_segments.feminine) {
                    for (var jkey in gender_segments.feminine) {
                        this.locale[lang_out].terms[ikey][jkey] = gender_segments.feminine[jkey];
                    }
                } else if (gender_segments.masculine) {
                    for (var jkey in gender_segments.masculine) {
                        this.locale[lang_out].terms[ikey][jkey] = gender_segments.masculine[jkey];
                    }
                }
            }
        }
        this.locale[lang_out].ord['1.0.1'] = ordinals101;
    }
    for (termname in this.locale[lang_out].terms) {
        for (i = 0, ilen = 2; i < ilen; i += 1) {
            genderform = CSL.GENDERS[i];
            if (this.locale[lang_out].terms[termname][genderform]) {
                for (form in this.locale[lang_out].terms[termname]) {
                    if (!this.locale[lang_out].terms[termname][genderform][form]) {
                        this.locale[lang_out].terms[termname][genderform][form] = this.locale[lang_out].terms[termname][form];
                    }
                }
            }
        }
    }
    nodes = myxml.getNodesByName(locale, 'style-options');
    for (pos = 0, len = myxml.numberofnodes(nodes); pos < len; pos += 1) {
        if (true) {
            styleopts = nodes[pos];
            attributes = myxml.attributes(styleopts);
            for (attrname in attributes) {
                if (attributes.hasOwnProperty(attrname)) {
                    if (attrname === "@punctuation-in-quote" || attrname === "@limit-day-ordinals-to-day-1") {
                        if (attributes[attrname] === "true") {
                            this.locale[lang_out].opts[attrname.slice(1)] = true;
                        } else {
                            this.locale[lang_out].opts[attrname.slice(1)] = false;
                        }
                    } else if (attrname === "@jurisdiction-preference") {
                        var jurisdiction_preference = attributes[attrname].split(/\s*,\s*/);
                        this.locale[lang_out].opts[attrname.slice(1)] = jurisdiction_preference;
                    } else if (attrname === "@skip-words") {
                        var skip_words = attributes[attrname].split(/\s*,\s*/);
                        this.locale[lang_out].opts[attrname.slice(1)] = skip_words;
                    } else if (attrname === "@leading-noise-words") {
                        var val = attributes[attrname].split(/\s*,\s*/);
                        this.locale[lang_out].opts["leading-noise-words"] = val;
                    } else if (attrname === "@name-as-sort-order") {
                        this.locale[lang_out].opts["name-as-sort-order"] = {};
                        var lst = attributes[attrname].split(/\s+/);
                        for (var i=0,ilen=lst.length;i<ilen;i+=1) {
                            this.locale[lang_out].opts["name-as-sort-order"][lst[i]] = true;
                        }
                    } else if (attrname === "@name-as-reverse-order") {
                        this.locale[lang_out].opts["name-as-reverse-order"] = {};
                        var lst = attributes[attrname].split(/\s+/);
                        for (var i=0,ilen=lst.length;i<ilen;i+=1) {
                            this.locale[lang_out].opts["name-as-reverse-order"][lst[i]] = true;
                        }
                    } else if (attrname === "@name-never-short") {
                        this.locale[lang_out].opts["name-never-short"] = {};
                        var lst = attributes[attrname].split(/\s+/);
                        for (var i=0,ilen=lst.length;i<ilen;i+=1) {
                            this.locale[lang_out].opts["name-never-short"][lst[i]] = true;
                        }
                    }
                }
            }
        }
    }
    nodes = myxml.getNodesByName(locale, 'date');
    for (pos = 0, len = myxml.numberofnodes(nodes); pos < len; pos += 1) {
        if (true) {
            var date = nodes[pos];
            this.locale[lang_out].dates[myxml.getAttributeValue(date, "form")] = date;
        }
    }
};
module.exports = CSL;
CSL.getLocaleNames = function (myxml, preferredLocale) {
    var stylexml = CSL.setupXml(myxml);
    function extendLocaleList(localeList, locale) {
        var forms = ["base", "best"];
        if (locale) {
            normalizedLocale = CSL.localeResolve(locale);
            for (var i=0,ilen=forms.length;i<ilen;i++) {
                if (normalizedLocale[forms[i]] && localeList.indexOf(normalizedLocale[forms[i]]) === -1) {
                    localeList.push(normalizedLocale[forms[i]]);
                }
            }
        }
    }
    function sniffLocaleOnOneNodeName(nodeName) {
        var nodes = stylexml.getNodesByName(stylexml.dataObj, nodeName);
        for (var i=0,ilen=nodes.length;i<ilen;i++) {
            var nodeLocales = stylexml.getAttributeValue(nodes[i], "locale");
            if (nodeLocales) {
                nodeLocales = nodeLocales.split(/ +/);
                for (var j=0,jlen=nodeLocales.length;j<jlen;j++) {
                    this.extendLocaleList(localeIDs, nodeLocales[j]);
                }
            }
        }
    }
    var localeIDs = ["en-US"];
    extendLocaleList(localeIDs, preferredLocale);
    var styleNode = stylexml.getNodesByName(stylexml.dataObj, "style")[0];
    var defaultLocale = stylexml.getAttributeValue(styleNode, "default-locale");
    extendLocaleList(localeIDs, defaultLocale);
    var nodeNames = ["layout", "if", "else-if", "condition"];
    for (var i=0,ilen=nodeNames.length;i<ilen;i++) {
        sniffLocaleOnOneNodeName(stylexml, localeIDs, nodeNames[i]);
    }
    return localeIDs;
};
module.exports = CSL;
CSL.Node = {};
CSL.Node.bibliography = {
    build: function (state, target) {
        if (this.tokentype === CSL.START) {
            state.build.area = "bibliography";
            state.build.root = "bibliography";
            state.build.extension = "";
            var func = function(state, Item) {
                state.tmp.area = "bibliography";
                state.tmp.root = "bibliography";
                state.tmp.extension = "";
            }
            this.execs.push(func);
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.choose = {
    build: function (state, target) {
        var func;
        if (this.tokentype === CSL.START) {
            func = function (state, Item) {
                state.tmp.jump.push(undefined, CSL.LITERAL);
            };
        }
        if (this.tokentype === CSL.END) {
            func = function (state, Item) {
                state.tmp.jump.pop();
            };
        }
        this.execs.push(func);
        target.push(this);
    },
    configure: function (state, pos) {
        if (this.tokentype === CSL.END) {
            state.configure.fail.push((pos));
            state.configure.succeed.push((pos));
        } else {
            state.configure.fail.pop();
            state.configure.succeed.pop();
        }
    }
};
module.exports = CSL;
CSL.Node.citation = {
    build: function (state, target) {
        if (this.tokentype === CSL.START) {
            state.build.area = "citation";
            state.build.root = "citation";
            state.build.extension = "";
            var func = function(state, Item) {
                state.tmp.area = "citation";
                state.tmp.root = "citation";
                state.tmp.extension = "";
            }
            this.execs.push(func);
        }
        if (this.tokentype === CSL.END) {
            state.opt.grouped_sort = state.opt.xclass === "in-text" 
                && (state.citation.opt.collapse 
                    && state.citation.opt.collapse.length)
                || (state.citation.opt.cite_group_delimiter
                    && state.citation.opt.cite_group_delimiter.length)
                && state.opt.update_mode !== CSL.POSITION
                && state.opt.update_mode !== CSL.NUMERIC;
            if (state.opt.grouped_sort 
                && state.citation_sort.opt.sort_directions.length) {
                var firstkey = state.citation_sort.opt.sort_directions[0].slice();
                state.citation_sort.opt.sort_directions = [firstkey].concat(state.citation_sort.opt.sort_directions);
            }
            state.citation.srt = new CSL.Registry.Comparifier(state, "citation_sort");
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node["#comment"] = {
       build: function (state, target) {
       }
};
module.exports = CSL;
CSL.Node.date = {
    build: function (state, target) {
        var func, date_obj, tok, len, pos, part, dpx, parts, mypos, start, end;
        if (this.tokentype === CSL.START || this.tokentype === CSL.SINGLETON) {
            state.build.date_parts = [];
            state.build.date_variables = this.variables;
            if (!state.build.extension) {
                CSL.Util.substituteStart.call(this, state, target);
            }
            if (state.build.extension) {
                func = CSL.dateMacroAsSortKey;
            } else {
                func = function (state, Item, item) {
                    var key, dp;
                    state.tmp.element_rendered_ok = false;
                    state.tmp.donesies = [];
                    state.tmp.dateparts = [];
                    dp = [];
                    if (this.variables.length
                        && !(state.tmp.just_looking
                             && this.variables[0] === "accessed")) {
                        date_obj = Item[this.variables[0]];
                        if ("undefined" === typeof date_obj) {
                            date_obj = {"date-parts": [[0]] };
                            if (state.opt.development_extensions.locator_date_and_revision) {
                                if (item && this.variables[0] === "locator-date" && item["locator-date"]) {
                                    date_obj = item["locator-date"];
                                }
                            }
                        }
                        state.tmp.date_object = date_obj;
                        len = this.dateparts.length;
                        for (pos = 0; pos < len; pos += 1) {
                            part = this.dateparts[pos];
                            if ("undefined" !== typeof state.tmp.date_object[(part +  "_end")]) {
                                dp.push(part);
                            } else if (part === "month" && "undefined" !== typeof state.tmp.date_object.season_end) {
                                dp.push(part);
                            }
                        }
                        dpx = [];
                        parts = ["year", "month", "day"];
                        len = parts.length;
                        for (pos = 0; pos < len; pos += 1) {
                            if (dp.indexOf(parts[pos]) > -1) {
                                dpx.push(parts[pos]);
                            }
                        }
                        dp = dpx.slice();
                        mypos = 2;
                        len = dp.length;
                        for (pos = 0; pos < len; pos += 1) {
                            part = dp[pos];
                            start = state.tmp.date_object[part];
                            end = state.tmp.date_object[(part + "_end")];
                            if (start !== end) {
                                mypos = pos;
                                break;
                            }
                        }
                        state.tmp.date_collapse_at = dp.slice(mypos);
                    } else {
                        state.tmp.date_object = false;
                    }
                };
            }
            this.execs.push(func);
            func = function (state, Item) {
                if (!Item[this.variables[0]]) return;
                state.parallel.StartVariable(this.variables[0]);
                state.output.startTag("date", this);
                if (this.variables[0] === "issued"
                    && Item.type === "legal_case"
                    && !state.tmp.extension
                    && "" + Item["collection-number"] === "" + state.tmp.date_object.year
                    && this.dateparts.length === 1
                    && this.dateparts[0] === "year") {
                    for (var key in state.tmp.date_object) {
                        if (state.tmp.date_object.hasOwnProperty(key)) {
                            if (key.slice(0, 4) === "year") {
                                state.tmp.issued_date = {};
                                var lst = state.output.current.mystack.slice(-2)[0].blobs;
                                state.tmp.issued_date.list = lst;
                                state.tmp.issued_date.pos = lst.length - 1;
                            }
                        }
                    }
                }
            };
            this.execs.push(func);
        }
        if (!state.build.extension && (this.tokentype === CSL.END || this.tokentype === CSL.SINGLETON)) {
            func = function (state, Item) {
                if (!Item[this.variables[0]]) return;
                state.output.endTag();
                state.parallel.CloseVariable(this.variables[0]);
            };
            this.execs.push(func);
        }
        target.push(this);
        if (this.tokentype === CSL.END || this.tokentype === CSL.SINGLETON) {
            if (!state.build.extension) {
                CSL.Util.substituteEnd.call(this, state, target);
            }
        }
    }
};
module.exports = CSL;
CSL.Node["date-part"] = {
    build: function (state, target) {
        var func, pos, len, decor, first_date, value, value_end, real, have_collapsed, invoked, precondition, known_year, bc, ad, bc_end, ad_end, ready, curr, dcurr, number, num, formatter, item, i, ilen;
        if (!this.strings.form) {
            this.strings.form = "long";
        }
        state.build.date_parts.push(this.strings.name);
        var date_variable = state.build.date_variables[0];
        func = function (state, Item) {
            if (!state.tmp.date_object) {
                return;
            }
            first_date = true;
            value = "";
            value_end = "";
            state.tmp.donesies.push(this.strings.name);
            if (state.tmp.date_object.literal && "year" === this.strings.name) {
                state.parallel.AppendToVariable(state.tmp.date_object.literal);
                state.output.append(state.tmp.date_object.literal, this);
            }
            if (state.tmp.date_object) {
                value = state.tmp.date_object[this.strings.name];
                value_end = state.tmp.date_object[(this.strings.name + "_end")];
            }
            if ("year" === this.strings.name && value === 0 && !state.tmp.suppress_decorations) {
                value = false;
            }
            real = !state.tmp.suppress_decorations;
            have_collapsed = state.tmp.have_collapsed;
            invoked = state[state.tmp.area].opt.collapse === "year-suffix" || state[state.tmp.area].opt.collapse === "year-suffix-ranged";
            precondition = state.opt["disambiguate-add-year-suffix"];
            if (real && precondition && invoked) {
                state.tmp.years_used.push(value);
                known_year = state.tmp.last_years_used.length >= state.tmp.years_used.length;
                if (known_year && have_collapsed) {
                    if (state.tmp.last_years_used[(state.tmp.years_used.length - 1)] === value) {
                        value = false;
                    }
                }
            }
            if ("undefined" !== typeof value) {
                bc = false;
                ad = false;
                bc_end = false;
                ad_end = false;
                if ("year" === this.strings.name) {
                    if (parseInt(value, 10) < 500 && parseInt(value, 10) > 0) {
                        ad = state.getTerm("ad");
                    }
                    if (parseInt(value, 10) < 0) {
                        bc = state.getTerm("bc");
                        value = (parseInt(value, 10) * -1);
                    }
                    if (value_end) {
                        if (parseInt(value_end, 10) < 500 && parseInt(value_end, 10) > 0) {
                            ad_end = state.getTerm("ad");
                        }
                        if (parseInt(value_end, 10) < 0) {
                            bc_end = state.getTerm("bc");
                            value_end = (parseInt(value_end, 10) * -1);
                        }
                    }
                }
                state.parallel.AppendToVariable(value);
                var monthnameid = ""+state.tmp.date_object.month;
                while (monthnameid.length < 2) {
                    monthnameid = "0"+monthnameid;
                }
                monthnameid = "month-"+monthnameid;
                var gender = state.locale[state.opt.lang]["noun-genders"][monthnameid];
                if (this.strings.form) {
                    var myform = this.strings.form;
                    if (this.strings.name === "day") {
                        if (myform === "ordinal"
                            && state.locale[state.opt.lang].opts["limit-day-ordinals-to-day-1"]
                            && ("" + value) !== "1") {
                            myform = "numeric";
                        }
                    }
                    value = CSL.Util.Dates[this.strings.name][myform](state, value, gender, this.default_locale);
                    if ("month" === this.strings.name) {
                        if (state.tmp.strip_periods) {
                            value = value.replace(/\./g, "");
                        } else {
                            for (var i = 0, ilen = this.decorations.length; i < ilen; i += 1) {
                                if ("@strip-periods" === this.decorations[i][0] && "true" === this.decorations[i][1]) {
                                    value = value.replace(/\./g, "");
                                    break;
                                }
                            }
                        }
                    }
                    if (value_end) {
                        value_end = CSL.Util.Dates[this.strings.name][myform](state, value_end, gender, ("accessed" === date_variable), "_end");
                        if (state.tmp.strip_periods) {
                            value_end = value_end.replace(/\./g, "");
                        } else {
                            for (var i = 0, ilen = this.decorations.length; i < ilen; i += 1) {
                                if ("@strip-periods" === this.decorations[i][0] && "true" === this.decorations[i][1]) {
                                    value_end = value_end.replace(/\./g, "");
                                    break;
                                }
                            }
                        }
                    }
                }
                state.output.openLevel("empty");
                if (state.tmp.date_collapse_at.length) {
                    ready = true;
                    len = state.tmp.date_collapse_at.length;
                    for (pos = 0; pos < len; pos += 1) {
                        item = state.tmp.date_collapse_at[pos];
                        if (state.tmp.donesies.indexOf(item) === -1) {
                            ready = false;
                            break;
                        }
                    }
                    if (ready) {
                        if ("" + value_end !== "0") {
                            if (state.dateput.queue.length === 0) {
                                first_date = true;
                            }
                            if (state.opt["year-range-format"]
                                && state.opt["year-range-format"] !== "expanded"
                                && !state.tmp.date_object.day
                                && !state.tmp.date_object.month
                                && !state.tmp.date_object.season
                                && this.strings.name === "year"
                                && value && value_end) {
                                value_end = state.fun.year_mangler(value + "-" + value_end, true);
                                var range_delimiter = state.getTerm("year-range-delimiter");
                                value_end = value_end.slice(value_end.indexOf(range_delimiter) + 1);
                            }
                            state.dateput.append(value_end, this);
                            if (first_date) {
                                state.dateput.current.value()[0].strings.prefix = "";
                            }
                        }
                        state.output.append(value, this);
                        curr = state.output.current.value();
                        curr.blobs[(curr.blobs.length - 1)].strings.suffix = "";
                        state.output.append(state.getTerm("year-range-delimiter"), "empty");
                        dcurr = state.dateput.current.value();
                        curr.blobs = curr.blobs.concat(dcurr);
                        state.dateput.string(state, state.dateput.queue);
                        state.tmp.date_collapse_at = [];
                    } else {
                        state.output.append(value, this);
                        if (state.tmp.date_collapse_at.indexOf(this.strings.name) > -1) {
                            if ("" + value_end !== "0") {
                                if (state.dateput.queue.length === 0) {
                                    first_date = true;
                                }
                                state.dateput.openLevel("empty");
                                state.dateput.append(value_end, this);
                                if (first_date) {
                                    state.dateput.current.value().blobs[0].strings.prefix = "";
                                }
                                if (bc) {
                                    state.dateput.append(bc);
                                }
                                if (ad) {
                                    state.dateput.append(ad);
                                }
                                state.dateput.closeLevel();
                            }
                        }
                    }
                } else {
                    state.output.append(value, this);
                }
                if (bc) {
                    state.output.append(bc);
                }
                if (ad) {
                    state.output.append(ad);
                }
                state.output.closeLevel();
            } else if ("month" === this.strings.name) {
                if (state.tmp.date_object.season) {
                    value = "" + state.tmp.date_object.season;
                    if (value && value.match(/^[1-4]$/)) {
                        state.tmp.group_context.tip.variable_success = true;
                        state.output.append(state.getTerm(("season-0" + value)), this);
                    } else if (value) {
                        state.output.append(value, this);
                    }
                }
            }
            state.tmp.value = [];
            if (Item[date_variable] && (value || state.tmp.have_collapsed) && !state.opt.has_year_suffix && "year" === this.strings.name && !state.tmp.just_looking) {
                if (state.registry.registry[Item.id] && state.registry.registry[Item.id].disambig.year_suffix !== false && !state.tmp.has_done_year_suffix) {
                    state.tmp.has_done_year_suffix = true;
                    num = parseInt(state.registry.registry[Item.id].disambig.year_suffix, 10);
                    number = new CSL.NumericBlob(false, num, this, Item.id);
                    this.successor_prefix = state[state.build.area].opt.layout_delimiter;
                    this.splice_prefix = state[state.build.area].opt.layout_delimiter;
                    formatter = new CSL.Util.Suffixator(CSL.SUFFIX_CHARS);
                    number.setFormatter(formatter);
                    if (state[state.tmp.area].opt.collapse === "year-suffix-ranged") {
                        number.range_prefix = state.getTerm("citation-range-delimiter");
                    }
                    if (state[state.tmp.area].opt.cite_group_delimiter) {
                        number.successor_prefix = state[state.tmp.area].opt.cite_group_delimiter;
                    } else if (state[state.tmp.area].opt["year-suffix-delimiter"]) {
                        number.successor_prefix = state[state.tmp.area].opt["year-suffix-delimiter"];
                    } else {
                        number.successor_prefix = state[state.tmp.area].opt.layout_delimiter;
                    }
                    number.UGLY_DELIMITER_SUPPRESS_HACK = true;
                    state.output.append(number, "literal");
                }
            }
        };
        this.execs.push(func);
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node["else-if"] = {
    build: function (state, target) {
        CSL.Conditions.TopNode.call(this, state, target);
        target.push(this);
    },
    configure: function (state, pos) {
        CSL.Conditions.Configure.call(this, state, pos);
    }
};
module.exports = CSL;
CSL.Node["else"] = {
    build: function (state, target) {
        target.push(this);
    },
    configure: function (state, pos) {
        if (this.tokentype === CSL.START) {
            state.configure.fail[(state.configure.fail.length - 1)] = pos;
        }
    }
};
module.exports = CSL;
CSL.Node["et-al"] = {
    build: function (state, target) {
        if (state.build.area === "citation" || state.build.area === "bibliography") {
            var func = function (state, Item, item) {
                state.tmp.etal_node = this;
                if ("string" === typeof this.strings.term) {
                    state.tmp.etal_term = this.strings.term;
                }
            }
            this.execs.push(func);
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.group = {
    build: function (state, target, realGroup) {
        var func, execs, done_vars;
        this.realGroup = realGroup;
        if (this.tokentype === CSL.START) {
            CSL.Util.substituteStart.call(this, state, target);
            if (state.build.substitute_level.value()) {
                state.build.substitute_level.replace((state.build.substitute_level.value() + 1));
            }
            if (!this.juris) {
                target.push(this);
            }
            func = function (state, Item) {
                state.output.startTag("group", this);
                if (this.strings.label_form_override) {
                    if (!state.tmp.group_context.tip.label_form) {
                        state.tmp.group_context.tip.label_form = this.strings.label_form_override;
                    }
                }
                if (this.realGroup) {
                    var condition = false;
                    var force_suppress = false;
                    if (state.tmp.group_context.mystack.length) {
                        state.output.current.value().parent = state.tmp.group_context.tip.output_tip;
                    }
                    var label_form = state.tmp.group_context.tip.label_form;
                    if (!label_form) {
                        label_form = this.strings.label_form_override;
                    }
                    if (state.tmp.group_context.tip.condition) {
                        condition = state.tmp.group_context.tip.condition;
                        force_suppress = state.tmp.group_context.tip.force_suppress;
                    } else if (this.strings.reject) {
                        condition = {
                            test: this.strings.reject,
                            not: true
                        }
                        force_suppress = true;
                        done_vars = [];
                    } else if (this.strings.require) {
                        condition = {
                            test: this.strings.require,
                            not: false
                        }
                        done_vars = [];
                    }
                    state.tmp.group_context.push({
                        term_intended: false,
                        variable_attempt: false,
                        variable_success: false,
                        variable_success_parent: state.tmp.group_context.tip.variable_success,
                        output_tip: state.output.current.tip,
                        label_form: label_form,
                        parallel_conditions: this.strings.set_parallel_condition,
                        condition: condition,
                        force_suppress: force_suppress,
                        done_vars: state.tmp.group_context.tip.done_vars.slice()
                    });
                }
            };
            execs = [];
            execs.push(func);
            this.execs = execs.concat(this.execs);
            if (this.strings["has-publisher-and-publisher-place"]) {
                state.build["publisher-special"] = true;
                func = function (state, Item) {
                    if (this.strings["subgroup-delimiter"]
                        && Item.publisher && Item["publisher-place"]) {
                        var publisher_lst = Item.publisher.split(/;\s*/);
                        var publisher_place_lst = Item["publisher-place"].split(/;\s*/);
                        if (publisher_lst.length > 1
                            && publisher_lst.length === publisher_place_lst.length) {
                            state.publisherOutput = new CSL.PublisherOutput(state, this);
                            state.publisherOutput["publisher-list"] = publisher_lst;
                            state.publisherOutput["publisher-place-list"] = publisher_place_lst;
                        }
                    }
                };
                this.execs.push(func);
            }
            if (this.juris) {
                for (var x=0,xlen=target.length;x<xlen;x++) {
                    var token = target[x];
                }
                var choose_start = new CSL.Token("choose", CSL.START);
                CSL.Node.choose.build.call(choose_start, state, target);
                var if_start = new CSL.Token("if", CSL.START);
                func = function (macroName) {
                    return function (Item) {
                        if (!state.sys.retrieveStyleModule || !CSL.MODULE_MACROS[macroName] || !Item.jurisdiction) return false;
                        var jurisdictionList = state.getJurisdictionList(Item.jurisdiction);
                        if (!state.opt.jurisdictions_seen[jurisdictionList[0]]) {
                            var res = state.retrieveAllStyleModules(jurisdictionList);
                            for (var jurisdiction in res) {
                                var macroCount = 0;
                                state.juris[jurisdiction] = {};
                                var myXml = CSL.setupXml(res[jurisdiction]);
                                var myNodes = myXml.getNodesByName(myXml.dataObj, "law-module");
                                for (var i=0,ilen=myNodes.length;i<ilen;i++) {
                                    var myTypes = myXml.getAttributeValue(myNodes[i],"types");
                                    if (myTypes) {
                                        state.juris[jurisdiction].types = {};
                                        myTypes =  myTypes.split(/\s+/);
                                        for (var j=0,jlen=myTypes.length;j<jlen;j++) {
                                            state.juris[jurisdiction].types[myTypes[j]] = true;
                                        }
                                    }
                                }
                                if (!state.juris[jurisdiction].types) {
                                    state.juris[jurisdiction].types = CSL.MODULE_TYPES;
                                }
                                var myNodes = myXml.getNodesByName(myXml.dataObj, "macro");
                                for (var i=0,ilen=myNodes.length;i<ilen;i++) {
                                    var myName = myXml.getAttributeValue(myNodes[i], "name");
                                    if (!CSL.MODULE_MACROS[myName]) {
                                        CSL.debug("CSL: skipping non-modular macro name \"" + myName + "\" in module context");
                                        continue;
                                    };
                                    macroCount++;
                                    state.juris[jurisdiction][myName] = [];
                                    state.buildTokenLists(myNodes[i], state.juris[jurisdiction][myName]);
                                    state.configureTokenList(state.juris[jurisdiction][myName]);
                                }
                            }
                        }
                        for (var i=0,ilen=jurisdictionList.length;i<ilen;i++) {
                            var jurisdiction = jurisdictionList[i];
                            if(state.juris[jurisdiction] && state.juris[jurisdiction].types[Item.type]) {
                                Item["best-jurisdiction"] = jurisdiction;
                                return true;
                            }
                        }
                        return false;
                    };
                }(this.juris);
                if_start.tests.push(func);
                if_start.test = state.fun.match.any(if_start, state, if_start.tests);
                target.push(if_start);
                var text_node = new CSL.Token("text", CSL.SINGLETON);
                func = function (state, Item, item) {
                    var next = 0;
                    if (state.juris[Item["best-jurisdiction"]][this.juris]) {
                        while (next < state.juris[Item["best-jurisdiction"]][this.juris].length) {
                            next = CSL.tokenExec.call(state, state.juris[Item["best-jurisdiction"]][this.juris][next], Item, item);
                        }
                    }
                }
                text_node.juris = this.juris;
                text_node.execs.push(func);
                target.push(text_node);
                var if_end = new CSL.Token("if", CSL.END);
                CSL.Node["if"].build.call(if_end, state, target);
                var else_start = new CSL.Token("else", CSL.START);
                CSL.Node["else"].build.call(else_start, state, target);
            }
        }
        if (this.tokentype === CSL.END) {
            if (state.build["publisher-special"]) {
                state.build["publisher-special"] = false;
                if ("string" === typeof state[state.build.root].opt["name-delimiter"]) {
                    func = function (state, Item) {
                        if (state.publisherOutput) {
                            state.publisherOutput.render();
                            state.publisherOutput = false;
                        }
                    };
                    this.execs.push(func);
                }
            }
            func = function (state, Item) {
                state.output.endTag();
                if (this.realGroup) {
                    var flags = state.tmp.group_context.pop();
                    if (state.tmp.group_context.tip.condition) {
                        state.tmp.group_context.tip.force_suppress = flags.force_suppress;
                    }
                    if (!flags.force_suppress && (flags.variable_success || (flags.term_intended && !flags.variable_attempt))) {
                        if (!this.isJurisLocatorLabel) {
                            state.tmp.group_context.tip.variable_success = true;
                        }
                        var blobs = state.output.current.value().blobs;
                        var pos = state.output.current.value().blobs.length - 1;
                        if (!state.tmp.just_looking && "undefined" !== typeof flags.parallel_conditions) {
                            var parallel_condition_object = {
                                blobs: blobs,
                                conditions: flags.parallel_conditions,
                                id: Item.id,
                                pos: pos
                            };
                            state.parallel.parallel_conditional_blobs_list.push(parallel_condition_object);
                        }
                    } else {
                        state.tmp.group_context.tip.variable_attempt = flags.variable_attempt;
                        if (flags.force_suppress && !state.tmp.group_context.tip.condition) {
                            state.tmp.group_context.tip.variable_attempt = true;
                            state.tmp.group_context.tip.variable_success = flags.variable_success_parent;
                            for (var i=0,ilen=flags.done_vars.length;i<ilen;i++) {
                                if (state.tmp.done_vars.indexOf(flags.done_vars[i]) > -1) {
                                    state.tmp.done_vars = state.tmp.done_vars.slice(0, i).concat(state.tmp.done_vars.slice(i+1));
                                }
                            }
                        }
                        if (state.output.current.value().blobs) {
                            state.output.current.value().blobs.pop();
                        }
                    }
                }
            };
            this.execs.push(func);
            if (this.juris) {
                var else_end = new CSL.Token("else", CSL.END);
                CSL.Node["else"].build.call(else_end, state, target);
                var choose_end = new CSL.Token("choose", CSL.END);
                CSL.Node.choose.build.call(choose_end, state, target);
            }
        }
        if (this.tokentype === CSL.END) {
            if (!this.juris) {
                target.push(this);
            }
            if (state.build.substitute_level.value()) {
                state.build.substitute_level.replace((state.build.substitute_level.value() - 1));
            }
            CSL.Util.substituteEnd.call(this, state, target);
        }
    }
};
module.exports = CSL;
CSL.Node["if"] = {
    build: function (state, target) {
        CSL.Conditions.TopNode.call(this, state, target);
        target.push(this);
    },
    configure: function (state, pos) {
        CSL.Conditions.Configure.call(this, state, pos);
    }
};
module.exports = CSL;
CSL.Node["conditions"] = {
    build: function (state, target) {
        if (this.tokentype === CSL.START) {
            state.tmp.conditions.addMatch(this.match);
        }
        if (this.tokentype === CSL.END) {
            state.tmp.conditions.matchCombine();
        }
    }
};
module.exports = CSL;
CSL.Node["condition"] = {
    build: function (state, target) {
        if (this.tokentype === CSL.SINGLETON) {
            var test = state.fun.match[this.match](this, state, this.tests);
            state.tmp.conditions.addTest(test);
        }
    }
};
module.exports = CSL;
CSL.Conditions = {};
CSL.Conditions.TopNode = function (state, target) {
    var func;
    if (this.tokentype === CSL.START || this.tokentype === CSL.SINGLETON) {
        if (this.locale) {
            state.opt.lang = this.locale;
        }
        if (!this.tests || !this.tests.length) {
            state.tmp.conditions = new CSL.Conditions.Engine(state, this);
        } else {
            this.test = state.fun.match[this.match](this, state, this.tests);
        }
    }
    if (this.tokentype === CSL.END || this.tokentype === CSL.SINGLETON) {
        func = function (state, Item) {
            if (this.locale_default) {
                state.output.current.value().old_locale = this.locale_default;
                state.output.closeLevel("empty");
                state.opt.lang = this.locale_default;
            }
            var next = this[state.tmp.jump.value()];
            return next;
        };
        this.execs.push(func);
        if (this.locale_default) {
            state.opt.lang = this.locale_default;
        }
    }
};
CSL.Conditions.Configure = function (state, pos) {
    if (this.tokentype === CSL.START) {
        this.fail = state.configure.fail.slice(-1)[0];
        this.succeed = this.next;
        state.configure.fail[(state.configure.fail.length - 1)] = pos;
    } else if (this.tokentype === CSL.SINGLETON) {
        this.fail = this.next;
        this.succeed = state.configure.succeed.slice(-1)[0];
        state.configure.fail[(state.configure.fail.length - 1)] = pos;
    } else {
        this.succeed = state.configure.succeed.slice(-1)[0];
        this.fail = this.next;
    }
};
CSL.Conditions.Engine = function (state, token) {
    this.token = token;
    this.state = state;
};
CSL.Conditions.Engine.prototype.addTest = function (test) {
    this.token.tests.push(test);
};
CSL.Conditions.Engine.prototype.addMatch = function (match) {
    this.token.match = match;
};
CSL.Conditions.Engine.prototype.matchCombine = function () {
    this.token.test = this.state.fun.match[this.token.match](this.token, this.state, this.token.tests);
};
module.exports = CSL;
CSL.Node.info = {
    build: function (state, target) {
        if (this.tokentype === CSL.START) {
            state.build.skip = "info";
        } else {
            state.build.skip = false;
        }
    }
};
module.exports = CSL;
CSL.Node.institution = {
    build: function (state, target) {
        if ([CSL.SINGLETON, CSL.START].indexOf(this.tokentype) > -1) {
            var func = function (state, Item) {
                if ("string" === typeof this.strings.delimiter) {
                    state.tmp.institution_delimiter = this.strings.delimiter;
                } else {
                    state.tmp.institution_delimiter = state.tmp.name_delimiter;
                }
                var myand, and_default_prefix, and_suffix;
                if ("text" === state.inheritOpt(this, "and")) {
                    this.and_term = state.getTerm("and", "long", 0);
                } else if ("symbol" === state.inheritOpt(this, "and")) {
                    if (state.opt.development_extensions.expect_and_symbol_form) {
                        this.and_term = state.getTerm("and", "symbol", 0);
                    } else {
                        this.and_term = "&";
                    }
                } else if ("none" === state.inheritOpt(this, "and")) {
                    this.and_term = state.tmp.institution_delimiter;
                }
                if ("undefined" === typeof this.and_term && state.tmp.and_term) {
                    this.and_term = state.getTerm("and", "long", 0);
                }
                if (CSL.STARTSWITH_ROMANESQUE_REGEXP.test(this.and_term)) {
                    this.and_prefix_single = " ";
                    this.and_prefix_multiple = ", ";
                    if ("string" === typeof state.tmp.institution_delimiter) {
                        this.and_prefix_multiple = state.tmp.institution_delimiter;
                    }
                    this.and_suffix = " ";
                } else {
                    this.and_prefix_single = "";
                    this.and_prefix_multiple = "";
                    this.and_suffix = "";
                }
                if (state.inheritOpt(this, "delimiter-precedes-last") === "always") {
                    this.and_prefix_single = state.tmp.institution_delimiter;
                } else if (state.inheritOpt(this, "delimiter-precedes-last") === "never") {
                    if (this.and_prefix_multiple) {
                        this.and_prefix_multiple = " ";
                    }
                }
                this.and = {};
                if ("undefined" !== typeof this.and_term) {
                    state.output.append(this.and_term, "empty", true);
                    this.and.single = state.output.pop();
                    this.and.single.strings.prefix = this.and_prefix_single;
                    this.and.single.strings.suffix = this.and_suffix;
                    state.output.append(this.and_term, "empty", true);
                    this.and.multiple = state.output.pop();
                    this.and.multiple.strings.prefix = this.and_prefix_multiple;
                    this.and.multiple.strings.suffix = this.and_suffix;
                } else if ("undefined" !== this.strings.delimiter) {
                    this.and.single = new CSL.Blob(state.tmp.institution_delimiter);
                    this.and.single.strings.prefix = "";
                    this.and.single.strings.suffix = "";
                    this.and.multiple = new CSL.Blob(state.tmp.institution_delimiter);
                    this.and.multiple.strings.prefix = "";
                    this.and.multiple.strings.suffix = "";
                }
                state.nameOutput.institution = this;
            };
            this.execs.push(func);
        }
        target.push(this);
    },
    configure: function (state, pos) {
        if ([CSL.SINGLETON, CSL.START].indexOf(this.tokentype) > -1) {
            state.build.has_institution = true;
        }
    }
};
module.exports = CSL;
CSL.Node["institution-part"] = {
    build: function (state, target) {
        var func;
        if ("long" === this.strings.name) {
            if (this.strings["if-short"]) {
                func = function (state, Item) {
                    state.nameOutput.institutionpart["long-with-short"] = this;
                };
            } else {
                func = function (state, Item) {
                    state.nameOutput.institutionpart["long"] = this;
                };
            }
        } else if ("short" === this.strings.name) {
            func = function (state, Item) {
                state.nameOutput.institutionpart["short"] = this;
            };
        }
        this.execs.push(func);
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.key = {
    build: function (state, target) {
        target = state[state.build.root + "_sort"].tokens;
        var func, i, ilen;
        var debug = false;
        var start_key = new CSL.Token("key", CSL.START);
        state.tmp.root = state.build.root;
        start_key.strings["et-al-min"] = state.inheritOpt(this, "et-al-min");
        start_key.strings["et-al-use-first"] = state.inheritOpt(this, "et-al-use-first");
        start_key.strings["et-al-use-last"] = state.inheritOpt(this, "et-al-use-last");
        func = function (state, Item) {
            state.tmp.done_vars = [];
        };
        start_key.execs.push(func);
        state.opt.citation_number_sort_direction = this.strings.sort_direction;
        func = function (state, Item) {
            state.output.openLevel("empty");
        };
        start_key.execs.push(func);
        var sort_direction = [];
        if (this.strings.sort_direction === CSL.DESCENDING) {
            sort_direction.push(1);
            sort_direction.push(-1);
        } else {
            sort_direction.push(-1);
            sort_direction.push(1);
        }
        state[state.build.area].opt.sort_directions.push(sort_direction);
        if (CSL.DATE_VARIABLES.indexOf(this.variables[0]) > -1) {
            state.build.date_key = true;
        }
        func = function (state, Item) {
            state.tmp.sort_key_flag = true;
            if (state.inheritOpt(this, "et-al-min")) {
                state.tmp["et-al-min"] = state.inheritOpt(this, "et-al-min");
            }
            if (state.inheritOpt(this, "et-al-use-first")) {
                state.tmp["et-al-use-first"] = state.inheritOpt(this, "et-al-use-first");
            }
            if ("boolean" === typeof state.inheritOpt(this, "et-al-use-last")) {
                state.tmp["et-al-use-last"] = state.inheritOpt(this, "et-al-use-last");
            }
        };
        start_key.execs.push(func);
        target.push(start_key);
        if (this.variables.length) {
            var variable = this.variables[0];
            if (variable === "citation-number") {
                if (state.build.area === "citation" && state.build.extension === "_sort") {
                    state.opt.citation_number_sort = false;
                }
                if (state.build.root === "bibliography" && state.build.extension === "_sort") {
                    state.opt.citation_number_sort_used = false;
                }
            }
            if (CSL.CREATORS.indexOf(variable) > -1) {
                var names_start_token = new CSL.Token("names", CSL.START);
                names_start_token.tokentype = CSL.START;
                names_start_token.variables = this.variables;
                CSL.Node.names.build.call(names_start_token, state, target);
                var name_token = new CSL.Token("name", CSL.SINGLETON);
                name_token.tokentype = CSL.SINGLETON;
                name_token.strings["name-as-sort-order"] = "all";
                name_token.strings["sort-separator"] = " ";
                name_token.strings["et-al-use-last"] = state.inheritOpt(this, "et-al-use-last");
                name_token.strings["et-al-min"] = state.inheritOpt(this, "et-al-min");
                name_token.strings["et-al-use-first"] = state.inheritOpt(this, "et-al-use-first");
                CSL.Node.name.build.call(name_token, state, target);
                var institution_token = new CSL.Token("institution", CSL.SINGLETON);
                institution_token.tokentype = CSL.SINGLETON;
                CSL.Node.institution.build.call(institution_token, state, target);
                var names_end_token = new CSL.Token("names", CSL.END);
                names_end_token.tokentype = CSL.END;
                CSL.Node.names.build.call(names_end_token, state, target);
            } else {
                var single_text = new CSL.Token("text", CSL.SINGLETON);
                single_text.dateparts = this.dateparts;
                if (CSL.NUMERIC_VARIABLES.indexOf(variable) > -1) {
                    func = function (state, Item) {
                        var num, m;
                        num = false;
                        if ("citation-number" === variable) {
                            num = state.registry.registry[Item.id].seq.toString();
                        } else {
                            num = Item[variable];
                        }
                        if (num) {
                            num = CSL.Util.padding(num);
                        }
                        state.output.append(num, this);
                    };
                } else if (variable === "citation-label") {
                    func = function (state, Item) {
                        var trigraph = state.getCitationLabel(Item);
                        state.output.append(trigraph, this);
                    };
                } else if (CSL.DATE_VARIABLES.indexOf(variable) > -1) {
                    func = CSL.dateAsSortKey;
                    single_text.variables = this.variables;
                } else if ("title" === variable) {
                    var abbrevfam = "title";
                    var abbrfall = false;
                    var altvar = false;
                    var transfall = true;
                    func = state.transform.getOutputFunction(this.variables, abbrevfam, abbrfall, altvar, transfall);
                } else {
                    func = function (state, Item) {
                        var varval = Item[variable];
                        state.output.append(varval, "empty");
                    };
                }
                single_text.execs.push(func);
                target.push(single_text);
            }
        } else { // macro
            var token = new CSL.Token("text", CSL.SINGLETON);
            token.postponed_macro = this.postponed_macro;
            CSL.expandMacro.call(state, token, target);
        }
        var end_key = new CSL.Token("key", CSL.END);
        func = function (state, Item) {
            var keystring = state.output.string(state, state.output.queue);
            if (state.sys.normalizeUnicode) {
                keystring = state.sys.normalizeUnicode(keystring);
            }
            keystring = keystring ? (keystring.split(" ").join(state.opt.sort_sep) + state.opt.sort_sep) : "";
            if ("" === keystring) {
                keystring = undefined;
            }
            if ("string" !== typeof keystring || state.tmp.empty_date) {
                keystring = undefined;
                state.tmp.empty_date = false;
            }
            state[state[state.tmp.area].root + "_sort"].keys.push(keystring);
            state.tmp.value = [];
        };
        end_key.execs.push(func);
        if (state.build.date_key) {
            if (state.build.area === "citation" && state.build.extension === "_sort") {
                state[state.build.area].opt.sort_directions.push([-1,1]);
                func = function (state, Item) {
                    var year_suffix = state.registry.registry[Item.id].disambig.year_suffix;
                    if (!year_suffix) {
                        year_suffix = 0;
                    }
                    var key = CSL.Util.padding("" + year_suffix);
                    state[state.tmp.area].keys.push(key);
                }
                end_key.execs.push(func);
            }
            state.build.date_key = false;
        }
        func = function (state, Item) {
            state.tmp["et-al-min"] = undefined;
            state.tmp["et-al-use-first"] = undefined;
            state.tmp["et-al-use-last"] = undefined;
            state.tmp.sort_key_flag = false;
        };
        end_key.execs.push(func);
        target.push(end_key);
    }
};
module.exports = CSL;
CSL.Node.label = {
    build: function (state, target) {
        var debug = false;
        if (this.strings.term) {
            var plural = false;
            if (!this.strings.form) {
            }
            var func = function (state, Item, item) {
                var termtxt = CSL.evaluateLabel(this, state, Item, item);
                if (item && this.strings.term === "locator") {
                    state.parallel.StartVariable("label");
                    state.parallel.AppendToVariable(item.label);
                    item.section_form_override = this.strings.form;
                }
                if (termtxt) {
                    state.tmp.group_context.tip.term_intended = true;
                }
                CSL.UPDATE_GROUP_CONTEXT_CONDITION(state, termtxt);
                if (termtxt.indexOf("%s") === -1) {
                    state.output.append(termtxt, this);
                }
                if (item && this.strings.term === "locator") {
                    state.parallel.CloseVariable();
                }
            };
            this.execs.push(func);
        } else {
            var namevars = state.build.names_variables.slice(-1)[0];
            if (!state.build.name_label) {
                state.build.name_label = {};
            }
            for (var i = 0, ilen = namevars.length; i < ilen; i += 1) {
                if (!state.build.name_label[namevars[i]]) {
                    state.build.name_label[namevars[i]] = {};
                }
            }
            if (!state.build.name_flag) {
                for (var i = 0, ilen = namevars.length; i < ilen; i += 1) {
                    state.build.name_label[namevars[i]].before = this;
                }
            } else {
                for (var i = 0, ilen = namevars.length; i < ilen; i += 1) {
                    state.build.name_label[namevars[i]].after = this;
                }
            }
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.layout = {
    build: function (state, target) {
        var func, prefix_token, suffix_token, tok;
        function setSuffix() {
            if (state.build.area === "bibliography") {
                suffix_token = new CSL.Token("text", CSL.SINGLETON);
                func = function(state, Item, item) {
                    var last_locale = state.tmp.cite_locales[state.tmp.cite_locales.length - 1];
                    var suffix;
                    if (state.tmp.cite_affixes[state.tmp.area][state.tmp.last_cite_locale]) {
                        suffix = state.tmp.cite_affixes[state.tmp.area][state.tmp.last_cite_locale].suffix;
                    } else {
                        suffix = state.bibliography.opt.layout_suffix;
                    }
                    var topblob = state.output.current.value();
                    if (state.opt.using_display) {
                        topblob.blobs[topblob.blobs.length-1].strings.suffix = suffix;
                    } else {
                        topblob.strings.suffix = suffix;
                    }
                    if (state.bibliography.opt["second-field-align"]) {
                        state.output.endTag("bib_other");
                    }
                };
                suffix_token.execs.push(func);
                target.push(suffix_token);
            }
        }
        if (this.tokentype === CSL.START) {
            if (this.locale_raw) {
                state.build.current_default_locale = this.locale_raw;
            } else {
                state.build.current_default_locale = state.opt["default-locale"];
            }
            func = function (state, Item, item) {
                if (state.opt.development_extensions.apply_citation_wrapper
                    && state.sys.wrapCitationEntry
                    && !state.tmp.just_looking
                    && Item.system_id 
                    && state.tmp.area === "citation") { 
                    cite_entry = new CSL.Token("group", CSL.START);
                    cite_entry.decorations = [["@cite", "entry"]];
                    state.output.startTag("cite_entry", cite_entry);
                    state.output.current.value().item_id = Item.system_id;
                    if (item) {
                        state.output.current.value().locator_txt = item.locator_txt;
                        state.output.current.value().suffix_txt = item.suffix_txt;
                    }
                }
            }
            this.execs.push(func);
        }
        if (this.tokentype === CSL.START && !state.tmp.cite_affixes[state.build.area]) {
            func = function (state, Item) {
                state.tmp.done_vars = [];
                if (!state.tmp.just_looking && state.registry.registry[Item.id] && state.registry.registry[Item.id].parallel) {
                    state.tmp.done_vars.push("first-reference-note-number");
                }
                state.tmp.rendered_name = false;
            };
            this.execs.push(func);
            func = function (state, Item) {
                state.tmp.sort_key_flag = false;
            };
            this.execs.push(func);
            func = function (state, Item) {
                state.tmp.nameset_counter = 0;
            };
            this.execs.push(func);
            func = function (state, Item) {
                var tok = new CSL.Token();
                if (state.opt.development_extensions.rtl_support) {
                    if (["ar", "he", "fa", "ur", "yi", "ps", "syr"].indexOf(Item.language) > -1) {
                        tok = new CSL.Token();
                        tok.strings.prefix = "\u202b";
                        tok.strings.suffix = "\u202c";
                    }
                }
                state.output.openLevel(tok);
            }
            this.execs.push(func);
            target.push(this);
            if (state.opt.development_extensions.rtl_support && false) {
                this.strings.prefix = this.strings.prefix.replace(/\((.|$)/g,"(\u200e$1");
                this.strings.suffix = this.strings.suffix.replace(/\)(.|$)/g,")\u200e$1");
            }
            if (state.build.area === "citation") {
                prefix_token = new CSL.Token("text", CSL.SINGLETON);
                func = function (state, Item, item) {
                    var sp;
                    if (item && item.prefix) {
                        sp = "";
                        var test_prefix = item.prefix.replace(/<[^>]+>/g, "").replace(/["'\u201d\u2019\u00bb\u202f\u00a0 ]+$/g,"");
                        var test_char = test_prefix.slice(-1);
                        if (test_prefix.match(CSL.ENDSWITH_ROMANESQUE_REGEXP)) {
                            sp = " ";
                        } else if (CSL.TERMINAL_PUNCTUATION.slice(0,-1).indexOf(test_char) > -1) {
                            sp = " ";
                        } else if (test_char.match(/[\)\],0-9]/)) {
                            sp = " ";
                        }
                        var ignorePredecessor = false;
                        if (CSL.TERMINAL_PUNCTUATION.slice(0,-1).indexOf(test_char) > -1 && item.prefix.trim().indexOf(" ") > -1) {
                            state.tmp.term_predecessor = false;
                            ignorePredecessor = true;
                        }
                        var prefix = (item.prefix + sp).replace(/\s+/g, " ");
                        if (!state.tmp.just_looking) {
                            prefix = state.output.checkNestedBrace.update(prefix);
                        }
                        state.output.append(prefix, this, false, ignorePredecessor);
                    }
                };
                prefix_token.execs.push(func);
                target.push(prefix_token);
            }
        }
        var my_tok;
        if (this.locale_raw) {
            my_tok = new CSL.Token("dummy", CSL.START);
            my_tok.locale = this.locale_raw;
            my_tok.strings.delimiter = this.strings.delimiter;
            my_tok.strings.suffix = this.strings.suffix;
            if (!state.tmp.cite_affixes[state.build.area]) {
                state.tmp.cite_affixes[state.build.area] = {};
            }
        }
        if (this.tokentype === CSL.START) {
            state.build.layout_flag = true;
            if (!this.locale_raw) {
                state[state.tmp.area].opt.topdecor = [this.decorations];
                state[(state.tmp.area + "_sort")].opt.topdecor = [this.decorations];
                state[state.build.area].opt.layout_prefix = this.strings.prefix;
                state[state.build.area].opt.layout_suffix = this.strings.suffix;
                state[state.build.area].opt.layout_delimiter = this.strings.delimiter;
                state[state.build.area].opt.layout_decorations = this.decorations;
                if (state.tmp.cite_affixes[state.build.area]) {
                    tok = new CSL.Token("else", CSL.START);
                    CSL.Node["else"].build.call(tok, state, target);
                }
            } // !this.locale_raw
            if (this.locale_raw) {
                if (!state.build.layout_locale_flag) {
                    var choose_tok = new CSL.Token("choose", CSL.START);
                    CSL.Node.choose.build.call(choose_tok, state, target);
                    my_tok.name = "if";
                    CSL.Attributes["@locale-internal"].call(my_tok, state, this.locale_raw);
                    CSL.Node["if"].build.call(my_tok, state, target);
                } else {
                    my_tok.name = "else-if";
                    CSL.Attributes["@locale-internal"].call(my_tok, state, this.locale_raw);
                    CSL.Node["else-if"].build.call(my_tok, state, target);
                }
                state.tmp.cite_affixes[state.build.area][my_tok.locale] = {};
                state.tmp.cite_affixes[state.build.area][my_tok.locale].delimiter = this.strings.delimiter;
                state.tmp.cite_affixes[state.build.area][my_tok.locale].suffix = this.strings.suffix;
            }
        }
        if (this.tokentype === CSL.END) {
            if (this.locale_raw) {
                setSuffix();
                if (!state.build.layout_locale_flag) {
                    my_tok.name = "if";
                    my_tok.tokentype = CSL.END;
                    CSL.Attributes["@locale-internal"].call(my_tok, state, this.locale_raw);
                    CSL.Node["if"].build.call(my_tok, state, target);
                    state.build.layout_locale_flag = true;
                } else {
                    my_tok.name = "else-if";
                    my_tok.tokentype = CSL.END;
                    CSL.Attributes["@locale-internal"].call(my_tok, state, this.locale_raw);
                    CSL.Node["else-if"].build.call(my_tok, state, target);
                }
            }
            if (!this.locale_raw) {
                setSuffix();
                if (state.tmp.cite_affixes[state.build.area]) {
                    if (state.build.layout_locale_flag) {
                        tok = new CSL.Token("else", CSL.END);
                        CSL.Node["else"].build.call(tok, state, target);
                        tok = new CSL.Token("choose", CSL.END);
                        CSL.Node.choose.build.call(tok, state, target);
                    }
                }
                state.build_layout_locale_flag = true;
                if (state.build.area === "citation") {
                    suffix_token = new CSL.Token("text", CSL.SINGLETON);
                    func = function (state, Item, item) {
                        var sp;
                        if (item && item.suffix) {
                            sp = "";
                            if (item.suffix.match(CSL.STARTSWITH_ROMANESQUE_REGEXP)
                                || ['[','('].indexOf(item.suffix.slice(0,1)) > -1) {
                                sp = " ";
                            }
                            var suffix = item.suffix;
                            if (!state.tmp.just_looking) {
                                suffix = state.output.checkNestedBrace.update(suffix);
                            }
                            state.output.append((sp + suffix), this);
                        }
                    };
                    suffix_token.execs.push(func);
                    target.push(suffix_token);
                }
                func = function (state, Item) {
                    state.output.closeLevel();
                };
                this.execs.push(func);
                func = function (state, Item) {
                    if (state.opt.development_extensions.apply_citation_wrapper
                        && state.sys.wrapCitationEntry
                        && !state.tmp.just_looking
                        && Item.system_id 
                        && state.tmp.area === "citation") { 
                        state.output.endTag(); // closes citation link wrapper
                    }
                }
                this.execs.push(func);
                target.push(this);
                state.build.layout_flag = false;
                state.build.layout_locale_flag = false;
            } // !this.layout_raw
        }
    }
};
module.exports = CSL;
CSL.Node.macro = {
    build: function (state, target) {}
};
module.exports = CSL;
CSL.NameOutput = function(state, Item, item, variables) {
    this.debug = false;
    this.state = state;
    this.Item = Item;
    this.item = item;
    this.nameset_base = 0;
    this.etal_spec = {};
    this._first_creator_variable = false;
    this._please_chop = false;
};
CSL.NameOutput.prototype.init = function (names) {
    if (this.state.tmp.term_predecessor) {
        this.state.tmp.subsequent_author_substitute_ok = false;
    }
    if (this.nameset_offset) {
        this.nameset_base = this.nameset_base + this.nameset_offset;
    }
    this.nameset_offset = 0;
    this.names = names;
    this.variables = names.variables;
    this.state.tmp.value = [];
    this.state.tmp.rendered_name = [];
    this.state.tmp.label_blob = false;
    this.state.tmp.etal_node = false;
    this.state.tmp.etal_term = false;
    for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        if (this.Item[this.variables[i]] && this.Item[this.variables[i]].length) {
            this.state.tmp.value = this.state.tmp.value.concat(this.Item[this.variables[i]]);
        }
    }
    this["et-al"] = undefined;
    this["with"] = undefined;
    this.name = undefined;
    this.institutionpart = {};
    this.state.tmp.group_context.tip.variable_attempt = true;
    this.labelVariable = this.variables[0];
    if (!this.state.tmp.value.length) {
        return;
    }
};
CSL.NameOutput.prototype.reinit = function (names, labelVariable) {
    this.labelVariable = labelVariable;
    if (this.state.tmp.can_substitute.value()) {
        this.nameset_offset = 0;
        this.variables = names.variables;
        var oldval = this.state.tmp.value.slice();
        this.state.tmp.value = [];
        for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
            if (this.Item[this.variables[i]] && this.Item[this.variables[i]].length) {
                this.state.tmp.value = this.state.tmp.value.concat(this.Item[this.variables[i]]);
            }
        }
        if (this.state.tmp.value.length) {
            this.state.tmp.can_substitute.replace(false, CSL.LITERAL);
        }
        this.state.tmp.value = oldval;
    }
};
CSL.NameOutput.prototype.outputNames = function () {
    var i, ilen;
    var variables = this.variables;
    if (this.institution.and) {
        if (!this.institution.and.single.blobs || !this.institution.and.single.blobs.length) {
            this.institution.and.single.blobs = this.name.and.single.blobs;
        }
        if (!this.institution.and.multiple.blobs || !this.institution.and.multiple.blobs.length) {
            this.institution.and.multiple.blobs = this.name.and.multiple.blobs;
        }
    }
    this.variable_offset = {};
    if (this.family) {
        this.family_decor = CSL.Util.cloneToken(this.family);
        this.family_decor.strings.prefix = "";
        this.family_decor.strings.suffix = "";
        for (i = 0, ilen = this.family.execs.length; i < ilen; i += 1) {
            this.family.execs[i].call(this.family_decor, this.state, this.Item);
        }
    } else {
        this.family_decor = false;
    }
    if (this.given) {
        this.given_decor = CSL.Util.cloneToken(this.given);
        this.given_decor.strings.prefix = "";
        this.given_decor.strings.suffix = "";
        for (i = 0, ilen = this.given.execs.length; i < ilen; i += 1) {
            this.given.execs[i].call(this.given_decor, this.state, this.Item);
        }
    } else {
        this.given_decor = false;
    }
    this.getEtAlConfig();
    this.divideAndTransliterateNames();
    this.truncatePersonalNameLists();
    this.disambigNames();
    this.constrainNames();
    if (this.name.strings.form === "count") {
        if (this.state.tmp.extension || this.names_count != 0) {
            this.state.output.append(this.names_count, "empty");
            this.state.tmp.group_context.tip.variable_success = true;
        }
        return;
    }
    this.setEtAlParameters();
    this.setCommonTerm();
    this.state.tmp.name_node = {};
    this.state.tmp.name_node.children = [];
    this.renderAllNames();
    var blob_list = [];
    for (i = 0, ilen = variables.length; i < ilen; i += 1) {
        var v = variables[i];
        var institution_sets = [];
        var institutions = false;
        var varblob = null;
        if (!this.state.opt.development_extensions.spoof_institutional_affiliations) {
            varblob = this._join([this.freeters[v]], "");
        } else {
            for (var j = 0, jlen = this.institutions[v].length; j < jlen; j += 1) {
                institution_sets.push(this.joinPersonsAndInstitutions([this.persons[v][j], this.institutions[v][j]]));
            }
            if (this.institutions[v].length) {
                var pos = this.nameset_base + this.variable_offset[v];
                if (this.freeters[v].length) {
                    pos += 1;
                }
                institutions = this.joinInstitutionSets(institution_sets, pos);
            }
            var varblob = this.joinFreetersAndInstitutionSets([this.freeters[v], institutions]);
        }
        if (varblob) {
            if (!this.state.tmp.extension) {
                varblob = this._applyLabels(varblob, v);
            }
            blob_list.push(varblob);
        }
        if (this.common_term) {
            break;
        }
    }
    this.state.output.openLevel("empty");
    this.state.output.current.value().strings.delimiter = this.state.inheritOpt(this.names, "delimiter", "names-delimiter");
    for (i = 0, ilen = blob_list.length; i < ilen; i += 1) {
        this.state.output.append(blob_list[i], "literal", true);
    }
    this.state.output.closeLevel("empty");
    var blob = this.state.output.pop();
    var namesToken = CSL.Util.cloneToken(this.names);
    this.state.output.append(blob, namesToken);
    if (this.state.tmp.term_predecessor_name) {
        this.state.tmp.term_predecessor = true;
    }
    this.state.tmp.name_node.top = this.state.output.current.value();
    if (variables[0] !== "authority") {
        var name_node_string = [];
        var nameobjs = this.Item[variables[0]];
        if (nameobjs) {
            for (var i = 0, ilen = nameobjs.length; i < ilen; i += 1) {
                var substring = CSL.Util.Names.getRawName(nameobjs[i]);
                if (substring) {
                    name_node_string.push(substring);
                }
            }
        }
        name_node_string = name_node_string.join(", ");
        if (name_node_string) {
            this.state.tmp.name_node.string = name_node_string;
        }
    }
    if (this.state.tmp.name_node.string && !this.state.tmp.first_name_string) {
        this.state.tmp.first_name_string = this.state.tmp.name_node.string;
    }
    if ("classic" === this.Item.type) {
        var author_title = [];
        if (this.state.tmp.first_name_string) {
            author_title.push(this.state.tmp.first_name_string);
        }
        if (this.Item.title) {
            author_title.push(this.Item.title);
        }
        author_title = author_title.join(", ");
        if (author_title && this.state.sys.getAbbreviation) {
            this.state.transform.loadAbbreviation("default", "classic", author_title);
            if (this.state.transform.abbrevs["default"].classic[author_title]) {
                this.state.tmp.done_vars.push("title");
                this.state.output.append(this.state.transform.abbrevs["default"].classic[author_title], "empty", true);
                blob = this.state.output.pop();
				this.state.tmp.name_node.top.blobs.pop();
                this.state.tmp.name_node.top.blobs.push(blob);
            }
        }
    }
    this._collapseAuthor();
    this.variables = [];
};
CSL.NameOutput.prototype._applyLabels = function (blob, v) {
    var txt;
    if (!this.label || !this.label[this.labelVariable]) {
        return blob;
    }
    var plural = 0;
    var num = this.freeters_count[v] + this.institutions_count[v];
    if (num > 1) {
        plural = 1;
    } else {
        for (var i = 0, ilen = this.persons[v].length; i < ilen; i += 1) {
            num += this.persons_count[v][i];
        }
        if (num > 1) {
            plural = 1;
        }
    }
    if (this.label[this.labelVariable].before) {
        if ("number" === typeof this.label[this.labelVariable].before.strings.plural) {
            plural = this.label[this.labelVariable].before.strings.plural;
        }
        txt = this._buildLabel(v, plural, "before", this.labelVariable);
        this.state.output.openLevel("empty");
        this.state.output.append(txt, this.label[this.labelVariable].before, true);
        this.state.output.append(blob, "literal", true);
        this.state.output.closeLevel("empty");
        blob = this.state.output.pop();
    } else if (this.label[this.labelVariable].after) {
        if ("number" === typeof this.label[this.labelVariable].after.strings.plural) {
            plural = this.label[this.labelVariable].after.strings.plural;
        }
        txt = this._buildLabel(v, plural, "after", this.labelVariable);
        this.state.output.openLevel("empty");
        this.state.output.append(blob, "literal", true);
        this.state.output.append(txt, this.label[this.labelVariable].after, true);
        this.state.tmp.label_blob = this.state.output.pop();
        this.state.output.append(this.state.tmp.label_blob,"literal",true);
        this.state.output.closeLevel("empty");
        blob = this.state.output.pop();
    }
    return blob;
};
CSL.NameOutput.prototype._buildLabel = function (term, plural, position, v) {
    if (this.common_term) {
        term = this.common_term;
    }
    var ret = false;
    var node = this.label[v][position];
    if (node) {
        ret = CSL.castLabel(this.state, node, term, plural, CSL.TOLERANT);
    }
    return ret;
};
CSL.NameOutput.prototype._collapseAuthor = function () {
    var myqueue, mystr, oldchars;
    if (this.nameset_base === 0 && this.Item[this.variables[0]] && !this._first_creator_variable) {
        this._first_creator_variable = this.variables[0];
    }
    if ((this.item && this.item["suppress-author"] && this._first_creator_variable == this.variables[0])
        || (this.state[this.state.tmp.area].opt.collapse 
            && this.state[this.state.tmp.area].opt.collapse.length)
        || (this.state[this.state.tmp.area].opt.cite_group_delimiter 
            && this.state[this.state.tmp.area].opt.cite_group_delimiter.length)) {
        if (this.state.tmp.authorstring_request) {
            mystr = "";
            myqueue = this.state.tmp.name_node.top.blobs.slice(-1)[0].blobs;
            oldchars = this.state.tmp.offset_characters;
            if (myqueue) {
                mystr = this.state.output.string(this.state, myqueue, false);
            }
            this.state.tmp.offset_characters = oldchars;
            this.state.registry.authorstrings[this.Item.id] = mystr;
        } else if (!this.state.tmp.just_looking
                   && !this.state.tmp.suppress_decorations && (this.item["suppress-author"] || (this.state[this.state.tmp.area].opt.collapse && this.state[this.state.tmp.area].opt.collapse.length) || this.state[this.state.tmp.area].opt.cite_group_delimiter && this.state[this.state.tmp.area].opt.cite_group_delimiter)) {
            mystr = "";
            myqueue = this.state.tmp.name_node.top.blobs.slice(-1)[0].blobs;
            oldchars = this.state.tmp.offset_characters;
            if (myqueue) {
                mystr = this.state.output.string(this.state, myqueue, false);
            }
            if (mystr === this.state.tmp.last_primary_names_string) {
                if (this.item["suppress-author"] || (this.state[this.state.tmp.area].opt.collapse && this.state[this.state.tmp.area].opt.collapse.length)) {
                    this.state.tmp.name_node.top.blobs.pop();
                    this.state.tmp.name_node.children = [];
                    this.state.tmp.offset_characters = oldchars;
                }
                if (this.state[this.state.tmp.area].opt.cite_group_delimiter && this.state[this.state.tmp.area].opt.cite_group_delimiter) {
                    this.state.tmp.use_cite_group_delimiter = true;
                }
            } else {
                this.state.tmp.last_primary_names_string = mystr;
                if (this.variables.indexOf(this._first_creator_variable) > -1 && this.item && this.item["suppress-author"] && this.Item.type !== "legal_case") {
                    this.state.tmp.name_node.top.blobs.pop();
                    this.state.tmp.name_node.children = [];
                    this.state.tmp.offset_characters = oldchars;
                    this.state.tmp.term_predecessor = false;
                }
                this.state.tmp.have_collapsed = false;
                if (this.state[this.state.tmp.area].opt.cite_group_delimiter && this.state[this.state.tmp.area].opt.cite_group_delimiter) {
                    this.state.tmp.use_cite_group_delimiter = false;
                }
            }
        }
    }
};
module.exports = CSL;
CSL.NameOutput.prototype.isPerson = function (value) {
    if (value.literal
        || (!value.given && value.family && value.isInstitution)) {
        return false;
    } else {
        return true;
    }
};
module.exports = CSL;
CSL.NameOutput.prototype.truncatePersonalNameLists = function () {
    var v, i, ilen, j, jlen, chopvar, values;
    this.freeters_count = {};
    this.persons_count = {};
    this.institutions_count = {};
    for (v in this.freeters) {
        if (this.freeters.hasOwnProperty(v)) {
            this.freeters_count[v] = this.freeters[v].length;
            this.freeters[v] = this._truncateNameList(this.freeters, v);
        }
    }
    for (v in this.persons) {
        if (this.persons.hasOwnProperty(v)) {
            this.institutions_count[v] = this.institutions[v].length;
            this._truncateNameList(this.institutions, v);
            this.persons[v] = this.persons[v].slice(0, this.institutions[v].length);
            this.persons_count[v] = [];
            for (j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
                this.persons_count[v][j] = this.persons[v][j].length;
                this.persons[v][j] = this._truncateNameList(this.persons, v, j);
            }
        }
    }
    if (this.etal_min === 1 && this.etal_use_first === 1 
        && !(this.state.tmp.extension
             || this.state.tmp.just_looking)) {
        chopvar = v;
    } else {
        chopvar = false;
    }
    if (chopvar || this._please_chop) {
        for (i = 0, ilen = this.variables.length; i < ilen; i += 1) {
            v = this.variables[i];
            if (this.freeters[v].length) {
                if (this._please_chop === v) {
                    this.freeters[v] = this.freeters[v].slice(1);
                    this.freeters_count[v] += -1;
                    this._please_chop = false;
                } else if (chopvar && !this._please_chop) {
                    this.freeters[v] = this.freeters[v].slice(0, 1);
                    this.freeters_count[v] = 1;
                    this.institutions[v] = [];
                    this.persons[v] = [];
                    this._please_chop = chopvar;
                }
            }
            for (var j=0,jlen = this.persons[v].length;j<jlen;j++) {
                if (this.persons[v][j].length) {
                    if (this._please_chop === v) {
                        this.persons[v][j] = this.persons[v][j].slice(1);
                        this.persons_count[v][j] += -1;
                        this._please_chop = false;
                        break;
                    } else if (chopvar && !this._please_chop) {
                        this.freeters[v] = this.persons[v][j].slice(0, 1);
                        this.freeters_count[v] = 1;
                        this.institutions[v] = [];
                        this.persons[v] = [];
                        values = [];
                        this._please_chop = chopvar;
                        break;
                    }
                }
            }
            if (this.institutions[v].length) {
                if (this._please_chop === v) {
                    this.institutions[v] = this.institutions[v].slice(1);
                    this.institutions_count[v] += -1;
                    this._please_chop = false;
                } else if (chopvar && !this._please_chop) {
                    this.institutions[v] = this.institutions[v].slice(0, 1);
                    this.institutions_count[v] = 1;
                    values = [];
                    this._please_chop = chopvar;
                }
            }
        }
    }
    for (i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        if (this.institutions[v].length) {
            this.nameset_offset += 1;
        }
        for (var j=0,jlen=this.persons[v].length;j<jlen;j++) {
            if (this.persons[v][j].length) {
                this.nameset_offset += 1;
            }
        }
    }
};
CSL.NameOutput.prototype._truncateNameList = function (container, variable, index) {
    var lst;
    if ("undefined" === typeof index) {
        lst = container[variable];
    } else {
        lst = container[variable][index];
    }
    if (this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names 
        && lst.length > 50 
        && lst.length > (this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names + 2)) {
        var limit = this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names;
        lst = lst.slice(0, limit+1).concat(lst.slice(-1));
    }
    return lst;
};
module.exports = CSL;
CSL.NameOutput.prototype.divideAndTransliterateNames = function () {
    var i, ilen, j, jlen;
    var Item = this.Item;
    var variables = this.variables;
    this.varnames = variables.slice();
    this.freeters = {};
    this.persons = {};
    this.institutions = {};
    for (i = 0, ilen = variables.length; i < ilen; i += 1) {
        var v = variables[i];
        this.variable_offset[v] = this.nameset_offset;
        var values = this._normalizeVariableValue(Item, v);
        if (this.name.strings["suppress-min"] && values.length >= this.name.strings["suppress-min"]) {
            values = [];
        }
        if (this.name.strings["suppress-max"] && values.length <= this.name.strings["suppress-max"]) {
            values = [];
        }
        this._getFreeters(v, values);
        this._getPersonsAndInstitutions(v, values);
        if (this.state.opt.development_extensions.spoof_institutional_affiliations) {
            if (this.name.strings["suppress-min"] === 0) {
                this.freeters[v] = [];
                for (j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
                    this.persons[v][j] = [];
                }
            } else if (this.institution.strings["suppress-min"] === 0) {
                this.institutions[v] = [];
                this.freeters[v] = this.freeters[v].concat(this.persons[v]);
                for (j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
                    for (var k = 0, klen = this.persons[v][j].length; k < klen; k += 1) {
                        this.freeters[v].push(this.persons[v][j][k]);
                    }
                }
                this.persons[v] = [];
            }
        }
    }
};
CSL.NameOutput.prototype._normalizeVariableValue = function (Item, variable) {
    var names, name, i, ilen;
    if ("string" === typeof Item[variable] || "number" === typeof Item[variable]) {
        CSL.debug("name variable \"" + variable + "\" is string or number, not array. Attempting to fix.");
        names = [{literal: Item[variable] + ""}];
    } else if (!Item[variable]) {
        names = [];
    } else if ("number" !== typeof Item[variable].length) {
        CSL.debug("name variable \"" + variable + "\" is object, not array. Attempting to fix.");
        Item[variable] = [Item[variable]];
        names = Item[variable].slice();
    } else {
        names = Item[variable].slice();
    }
    return names;
};
CSL.NameOutput.prototype._getFreeters = function (v, values) {
    this.freeters[v] = [];
    if (this.state.opt.development_extensions.spoof_institutional_affiliations) {
        for (var i=values.length-1;i>-1;i--) {
            if (this.isPerson(values[i])) {
                var value = this._checkNickname(values.pop());
                if (value) {
                    this.freeters[v].push(value);
                }
            } else {
                break;
            }
        }
    } else {
        for (var i=values.length-1;i>-1;i--) {
            var value = values.pop();
            if (this.isPerson(value)) {
                var value = this._checkNickname(value);
            }
            this.freeters[v].push(value);
        }
    }
    this.freeters[v].reverse();
    if (this.freeters[v].length) {
        this.nameset_offset += 1;
    }
};
CSL.NameOutput.prototype._getPersonsAndInstitutions = function (v, values) {
    this.persons[v] = [];
    this.institutions[v] = [];
    if (!this.state.opt.development_extensions.spoof_institutional_affiliations) return;
    var persons = [];
    var has_affiliates = false;
    var first = true;
    for (var i = values.length - 1; i > -1; i += -1) {
        if (this.isPerson(values[i])) {
            var value = this._checkNickname(values[i]);
            if (value) {
                persons.push(value);
            }
        } else {
            has_affiliates = true;
            this.institutions[v].push(values[i]);
            if (!first) {
                persons.reverse();
                this.persons[v].push(persons);
                persons = [];
            }
            first = false;
        }
    }
    if (has_affiliates) {
        persons.reverse();
        this.persons[v].push(persons);
        this.persons[v].reverse();
        this.institutions[v].reverse();
    }
};
CSL.NameOutput.prototype._clearValues = function (values) {
    for (var i = values.length - 1; i > -1; i += -1) {
        values.pop();
    }
};
CSL.NameOutput.prototype._checkNickname = function (name) {
    if (["interview", "personal_communication"].indexOf(this.Item.type) > -1) {
        var author = "";
        author = CSL.Util.Names.getRawName(name);
        if (author && this.state.sys.getAbbreviation && !(this.item && this.item["suppress-author"])) {
            var normalizedKey = author;
            if (this.state.sys.normalizeAbbrevsKey) {
                normalizedKey = this.state.sys.normalizeAbbrevsKey(author);
            }
            this.state.transform.loadAbbreviation("default", "nickname", normalizedKey);
            var myLocalName = this.state.transform.abbrevs["default"].nickname[normalizedKey];
            if (myLocalName) {
                if (myLocalName === "!here>>>") {
                    name = false;
                } else {
                    name = {family:myLocalName,given:''};
                }
            }
        }
    }
    return name;
};
module.exports = CSL;
CSL.NameOutput.prototype.joinPersons = function (blobs, pos, j, tokenname) {
    var ret;
    if (!tokenname) {
        tokenname = "name";
    }
    if ("undefined" === typeof j) {
        if (this.etal_spec[pos].freeters === 1) {
           ret = this._joinEtAl(blobs, tokenname);
        } else if (this.etal_spec[pos].freeters === 2) {
            ret = this._joinEllipsis(blobs, tokenname);
        } else if (!this.state.tmp.sort_key_flag) {
            ret = this._joinAnd(blobs, tokenname);
        } else {
            ret = this._join(blobs, " ");
        }
    } else {
        if (this.etal_spec[pos].persons[j] === 1) {
            ret = this._joinEtAl(blobs, tokenname);
        } else if (this.etal_spec[pos].persons[j] === 2) {
            ret = this._joinEllipsis(blobs, tokenname);
        } else if (!this.state.tmp.sort_key_flag) {
            ret = this._joinAnd(blobs, tokenname);
        } else {
            ret = this._join(blobs, " ");
        }
    }
    return ret;
};
CSL.NameOutput.prototype.joinInstitutionSets = function (blobs, pos) {
    var ret;
    if (this.etal_spec[pos].institutions === 1) {
        ret = this._joinEtAl(blobs, "institution");
    } else if (this.etal_spec[pos].institutions === 2) {
        ret = this._joinEllipsis(blobs, "institution");
    } else {
        ret = this._joinAnd(blobs, "institution");
    }
    return ret;
};
CSL.NameOutput.prototype.joinPersonsAndInstitutions = function (blobs) {
    return this._join(blobs, this.state.tmp.name_delimiter);
};
CSL.NameOutput.prototype.joinFreetersAndInstitutionSets = function (blobs) {
    var ret = this._join(blobs, "[never here]", this["with"].single, this["with"].multiple);
    return ret;
};
CSL.NameOutput.prototype._joinEtAl = function (blobs, tokenname) {
    var blob = this._join(blobs, this.state.tmp.name_delimiter);
    this.state.output.openLevel(this._getToken(tokenname));
    this.state.output.current.value().strings.delimiter = "";
    this.state.output.append(blob, "literal", true);
    if (blobs.length > 1) {
        this.state.output.append(this["et-al"].multiple, "literal", true);
    } else if (blobs.length === 1) {
        this.state.output.append(this["et-al"].single, "literal", true);
    }
    this.state.output.closeLevel();
    return this.state.output.pop();
};
CSL.NameOutput.prototype._joinEllipsis = function (blobs, tokenname) {
    return this._join(blobs, this.state.tmp.name_delimiter, this.name.ellipsis.single, this.name.ellipsis.multiple, tokenname);
};
CSL.NameOutput.prototype._joinAnd = function (blobs, tokenname) {
    return this._join(blobs, this.state.inheritOpt(this[tokenname], "delimiter", (tokenname + "-delimiter"), ", "), this[tokenname].and.single, this[tokenname].and.multiple, tokenname);
};
CSL.NameOutput.prototype._join = function (blobs, delimiter, single, multiple, tokenname) {
    var i, ilen;
    if (!blobs) {
        return false;
    }
    for (i = blobs.length - 1; i > -1; i += -1) {
        if (!blobs[i] || blobs[i].length === 0 || !blobs[i].blobs.length) {
            blobs = blobs.slice(0, i).concat(blobs.slice(i + 1));
        }
    }
    if (!blobs.length) {
        return false;
    } else if (single && blobs.length === 2) {
        if (single) {
            single = new CSL.Blob(single.blobs,single);
        }
        blobs = [blobs[0], single, blobs[1]];
    } else {
        var delimiter_offset;
        if (multiple) {
            delimiter_offset = 2;
        } else {
            delimiter_offset = 1;
        }
        for (i = 0, ilen = blobs.length - delimiter_offset; i < ilen; i += 1) {
            blobs[i].strings.suffix += delimiter;
        }
        if (blobs.length > 1) {
            var blob = blobs.pop();
            if (multiple) {
                multiple = new CSL.Blob(multiple.blobs,multiple);
                blobs.push(multiple);
            } else {
                if (single) {
                    single = new CSL.Blob(single.blobs,single);
                }
                blobs.push(single);
            }
            blobs.push(blob);
        }
    }
    this.state.output.openLevel();
    if (single && multiple) {
        this.state.output.current.value().strings.delimiter = "";
    }
    for (i = 0, ilen = blobs.length; i < ilen; i += 1) {
        this.state.output.append(blobs[i], false, true);
    }
    this.state.output.closeLevel();
    return this.state.output.pop();
};
CSL.NameOutput.prototype._getToken = function (tokenname) {
    var token = this[tokenname];
    if (tokenname === "institution") {
        var newtoken = new CSL.Token();
        return newtoken;
    }
    return token;
};
module.exports = CSL;
CSL.NameOutput.prototype.setCommonTerm = function () {
    var variables = this.variables;
    var varnames = variables.slice();
    varnames.sort();
    this.common_term = varnames.join("");
    if (!this.common_term) {
        return false;
    }
    var has_term = false;
    if (this.label && this.label[this.variables[0]]) {
        if (this.label[this.variables[0]].before) {
            has_term = this.state.getTerm(this.common_term, this.label[this.variables[0]].before.strings.form, 0);
        } else if (this.label[this.variables[0]].after) {
            has_term = this.state.getTerm(this.common_term, this.label[this.variables[0]].after.strings.form, 0);
        }
    }
    if (!this.state.locale[this.state.opt.lang].terms[this.common_term]
        || !has_term
        || this.variables.length < 2) {
        this.common_term = false;
        return;
    }
    var freeters_offset = 0;
    for (var i = 0, ilen = this.variables.length - 1; i < ilen; i += 1) {
        var v = this.variables[i];
        var vv = this.variables[i + 1];
        if (this.freeters[v].length || this.freeters[vv].length) {
            if (this.etal_spec[v].freeters !== this.etal_spec[vv].freeters
                || !this._compareNamesets(this.freeters[v], this.freeters[vv])) {
                this.common_term = false;
                return;
            }
            freeters_offset += 1;
        }
        if (this.persons[v].length !== this.persons[vv].length) {
            this.common_term = false;
            return;
        }
        for (var j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
            if (this.etal_spec[v].persons[j] !== this.etal_spec[vv].persons[j]
                || !this._compareNamesets(this.persons[v][j], this.persons[vv][j])) {
                this.common_term = false;
                return;
            }
        }
    }
};
CSL.NameOutput.prototype._compareNamesets = function (base_nameset, nameset) {
    if (base_nameset.length !== nameset.length) {
        return false;
    }
    for (var i = 0, ilen = nameset.length; i < ilen; i += 1) {
        var name = nameset[i];
        for (var j = 0, jlen = CSL.NAME_PARTS.length; j < jlen; j += 1) {
            var part = CSL.NAME_PARTS[j];
            if (!base_nameset[i] || base_nameset[i][part] != nameset[i][part]) {
                return false;
            }
        }
    }
    return true;
};
module.exports = CSL;
CSL.NameOutput.prototype.constrainNames = function () {
    this.names_count = 0;
    var pos;
    for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        var v = this.variables[i];
        pos = this.nameset_base + i;
        if (this.freeters[v].length) {
            this.state.tmp.names_max.push(this.freeters[v].length, "literal");
            this._imposeNameConstraints(this.freeters, this.freeters_count, v, pos);
            this.names_count += this.freeters[v].length;
        }
        if (this.institutions[v].length) {
            this.state.tmp.names_max.push(this.institutions[v].length, "literal");
            this._imposeNameConstraints(this.institutions, this.institutions_count, v, pos);
            this.persons[v] = this.persons[v].slice(0, this.institutions[v].length);
            this.names_count += this.institutions[v].length;
        }
        for (var j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
            if (this.persons[v][j].length) {
                this.state.tmp.names_max.push(this.persons[v][j].length, "literal");
                this._imposeNameConstraints(this.persons[v], this.persons_count[v], j, pos);
                this.names_count += this.persons[v][j].length;
            }
        }
    }
};
CSL.NameOutput.prototype._imposeNameConstraints = function (lst, count, key, pos) {
    var display_names = lst[key];
    var discretionary_names_length = this.state.tmp["et-al-min"];
    if (this.state.tmp.suppress_decorations) {
        if (this.state.tmp.disambig_request && this.state.tmp.disambig_request.names[pos]) {
            discretionary_names_length = this.state.tmp.disambig_request.names[pos];
        } else if (count[key] >= this.etal_min) {
            discretionary_names_length = this.etal_use_first;
        }
    } else {
        if (this.state.tmp.disambig_request 
            && this.state.tmp.disambig_request.names[pos] > this.etal_use_first) {
            if (count[key] < this.etal_min) {
                discretionary_names_length = count[key];
            } else {
                discretionary_names_length = this.state.tmp.disambig_request.names[pos];
            }
        } else if (count[key] >= this.etal_min) {
            discretionary_names_length = this.etal_use_first;
        }
        if (this.etal_use_last && discretionary_names_length > (this.etal_min - 2)) {
            discretionary_names_length = this.etal_min - 2;
        }
    }
    var sane = this.etal_min >= this.etal_use_first;
    var overlength = count[key] > discretionary_names_length;
    if (discretionary_names_length > count[key]) {
        discretionary_names_length = display_names.length;
    }
    if (sane && overlength) {
        if (this.etal_use_last) {
            lst[key] = display_names.slice(0, discretionary_names_length).concat(display_names.slice(-1));
        } else {
            lst[key] = display_names.slice(0, discretionary_names_length);
        }
    }
    this.state.tmp.disambig_settings.names[pos] = lst[key].length;
    this.state.disambiguate.padBase(this.state.tmp.disambig_settings);
};
module.exports = CSL;
CSL.NameOutput.prototype.disambigNames = function () {
    var pos;
    for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        var v = this.variables[i];
        pos = this.nameset_base + i;
        if (this.freeters[v].length) {
            this._runDisambigNames(this.freeters[v], pos);
        }
        if (this.institutions[v].length) {
            if ("undefined" === typeof this.state.tmp.disambig_settings.givens[pos]) {
                this.state.tmp.disambig_settings.givens[pos] = [];
            }
            for (var j=0,jlen=this.institutions[v].length;j<jlen;j+=1) {
                if ("undefined" === typeof this.state.tmp.disambig_settings.givens[pos][j]) {
                    this.state.tmp.disambig_settings.givens[pos].push(2);
                }
            }
        }
        for (var j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
            if (this.persons[v][j].length) {
                this._runDisambigNames(this.persons[v][j], pos);
            }
        }
    }
};
CSL.NameOutput.prototype._runDisambigNames = function (lst, pos) {
    var chk, myform, myinitials, param, i, ilen, paramx;
    for (i = 0, ilen = lst.length; i < ilen; i += 1) {
        if (!lst[i].given && !lst[i].family) {
            continue;
        }
        myinitials = this.state.inheritOpt(this.name, "initialize-with");
        this.state.registry.namereg.addname("" + this.Item.id, lst[i], i);
        chk = this.state.tmp.disambig_settings.givens[pos];
        if ("undefined" === typeof chk) {
            for (var j = 0, jlen = pos + 1; j < jlen; j += 1) {
                if (!this.state.tmp.disambig_settings.givens[j]) {
                    this.state.tmp.disambig_settings.givens[j] = [];
                }
            }
        }
        chk = this.state.tmp.disambig_settings.givens[pos][i];
        if ("undefined" === typeof chk) {
            myform = this.state.inheritOpt(this.name, "form", "name-form");
            param = this.state.registry.namereg.evalname("" + this.Item.id, lst[i], i, 0, myform, myinitials);
            this.state.tmp.disambig_settings.givens[pos].push(param);
        }
        myform = this.state.inheritOpt(this.name, "form", "name-form");
        paramx = this.state.registry.namereg.evalname("" + this.Item.id, lst[i], i, 0, myform, myinitials);
        if (this.state.tmp.disambig_request) {
            var val = this.state.tmp.disambig_settings.givens[pos][i];
            if (val === 1 && 
                this.state.citation.opt["givenname-disambiguation-rule"] === "by-cite" && 
                ("undefined" === typeof this.state.inheritOpt(this.name, "initialize-with")
                 || "undefined" === typeof lst[i].given)) {
                val = 2;
            }
            param = val;
            if (this.state.opt["disambiguate-add-givenname"] && lst[i].given) {
                param = this.state.registry.namereg.evalname("" + this.Item.id, lst[i], i, param, this.state.inheritOpt(this.name, "form", "name-form"), this.state.inheritOpt(this.name, "initialize-with"));
            }
        } else {
            param = paramx;
        }
        if (!this.state.tmp.just_looking && this.item && this.item.position === CSL.POSITION_FIRST) {
            if (paramx > param) {
                param = paramx;
            }
        }
        if (!this.state.tmp.sort_key_flag) {
            this.state.tmp.disambig_settings.givens[pos][i] = param;
            if ("string" === typeof myinitials
                && ("undefined" === typeof this.name.strings["initialize"]
                    || true === this.name.strings["initialize"])) {
                this.state.tmp.disambig_settings.use_initials = true;
            }
        }
    }
};
module.exports = CSL;
CSL.NameOutput.prototype.getEtAlConfig = function () {
    var item = this.item;
    this["et-al"] = {};
    this.state.output.append(this.etal_term, this.etal_style, true);
    this["et-al"].single = this.state.output.pop();
    this["et-al"].single.strings.suffix = this.etal_suffix;
    this["et-al"].single.strings.prefix = this.etal_prefix_single;
    this.state.output.append(this.etal_term, this.etal_style, true);
    this["et-al"].multiple = this.state.output.pop();
    this["et-al"].multiple.strings.suffix = this.etal_suffix;
    this["et-al"].multiple.strings.prefix = this.etal_prefix_multiple;
    if ("undefined" === typeof item) {
        item = {};
    }
    if (item.position) {
        if (this.state.inheritOpt(this.name, "et-al-subsequent-min")) {
            this.etal_min = this.state.inheritOpt(this.name, "et-al-subsequent-min");
        } else {
            this.etal_min = this.state.inheritOpt(this.name, "et-al-min");
        }
        if (this.state.inheritOpt(this.name, "et-al-subsequent-use-first")) {
            this.etal_use_first = this.state.inheritOpt(this.name, "et-al-subsequent-use-first");
        } else {
            this.etal_use_first = this.state.inheritOpt(this.name, "et-al-use-first");
        }
    } else {
        if (this.state.tmp["et-al-min"]) {
            this.etal_min = this.state.tmp["et-al-min"];
        } else {
            this.etal_min = this.state.inheritOpt(this.name, "et-al-min");
        }
        if (this.state.tmp["et-al-use-first"]) {
            this.etal_use_first = this.state.tmp["et-al-use-first"];
        } else {
            this.etal_use_first = this.state.inheritOpt(this.name, "et-al-use-first");
        }
        if ("boolean" === typeof this.state.tmp["et-al-use-last"]) {
            this.etal_use_last = this.state.tmp["et-al-use-last"];
        } else {
            this.etal_use_last = this.state.inheritOpt(this.name, "et-al-use-last");
        }
    }
    if (!this.state.tmp["et-al-min"]) {
        this.state.tmp["et-al-min"] = this.etal_min;
    }
};
module.exports = CSL;
CSL.NameOutput.prototype.setEtAlParameters = function () {
    var i, ilen, j, jlen;
    for (i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        var v = this.variables[i];
        if ("undefined" === typeof this.etal_spec[v]) {
            this.etal_spec[v] = {freeters:0,institutions:0,persons:[]};
        }
        this.etal_spec[this.nameset_base + i] = this.etal_spec[v];
        if (this.freeters[v].length) {
            this._setEtAlParameter("freeters", v);
        }
        for (j = 0, jlen = this.persons[v].length; j < jlen; j += 1) {
            if ("undefined" === typeof this.etal_spec[v][j]) {
                this.etal_spec[v].persons[j] = 0;
            }
            this._setEtAlParameter("persons", v, j);
        }
        if (this.institutions[v].length) {
            this._setEtAlParameter("institutions", v);
        }
    }
};
CSL.NameOutput.prototype._setEtAlParameter = function (type, v, j) {
    var lst, count;
    if (type === "persons") {
        lst = this.persons[v][j];
        count = this.persons_count[v][j];
    } else {
        lst = this[type][v];
        count = this[type + "_count"][v];
    }
    if (lst.length < count && !this.state.tmp.sort_key_flag) {
        if (this.etal_use_last) {
            if (type === "persons") {
                this.etal_spec[v].persons[j] = 2
            } else {
                this.etal_spec[v][type] = 2;
            }
        } else {
            if (type === "persons") {
                this.etal_spec[v].persons[j] = 1;
            } else {
                this.etal_spec[v][type] = 1;
            }
        }
    } else {
        if (type === "persons") {
            this.etal_spec[v].persons[j] = 0;
        } else {
            this.etal_spec[v][type] = 0;
        }
    }
};
module.exports = CSL;
CSL.NameOutput.prototype.renderAllNames = function () {
    var pos;
    for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        var v = this.variables[i];
        if (this.freeters[v].length || this.institutions[v].length) {
            if (!this.state.tmp.group_context.tip.condition) {
                this.state.tmp.just_did_number = false;
            }
        }
        pos = this.nameset_base + i;
        if (this.freeters[v].length) {
            this.freeters[v] = this._renderNames(v, this.freeters[v], pos);
        }
        for (var j = 0, jlen = this.institutions[v].length; j < jlen; j += 1) {
            this.persons[v][j] = this._renderNames(v, this.persons[v][j], pos, j);
        }
    }
    this.renderInstitutionNames();
};
CSL.NameOutput.prototype.renderInstitutionNames = function () {
    for (var i = 0, ilen = this.variables.length; i < ilen; i += 1) {
        var v = this.variables[i];
        for (var j = 0, jlen = this.institutions[v].length; j < jlen; j += 1) {
            var institution, institution_short, institution_long, short_style, long_style;
            var name = this.institutions[v][j];
            var j, ret, optLangTag, jlen, key, localesets;
            if (this.state.tmp.extension) {
                localesets = ["sort"];
            } else if (name.isInstitution || name.literal) {
                localesets = this.state.opt['cite-lang-prefs'].institutions;
            } else {
                localesets = this.state.opt['cite-lang-prefs'].persons;
            }
            var slot = {primary:'locale-orig',secondary:false,tertiary:false};
	        if (localesets) {
		        var slotnames = ["primary", "secondary", "tertiary"];
		        for (var k = 0, klen = slotnames.length; k < klen; k += 1) {
			        if (localesets.length - 1 <  k) {
				        break;
			        }
                    if (localesets[k]) {
			            slot[slotnames[k]] = 'locale-' + localesets[k];
                    }
		        }
	        } else {
		        slot.primary = 'locale-translat';
	        }
	        if (this.state.tmp.area !== "bibliography"
		        && !(this.state.tmp.area === "citation"
			         && this.state.opt.xclass === "note"
			         && this.item && !this.item.position)) {
		        slot.secondary = false;
		        slot.tertiary = false;
	        }
            var res;
            this.setRenderedName(name);
            var institution = this._renderInstitutionName(v, name, slot, j);
            this.institutions[v][j] = institution;
        }
    }
}
CSL.NameOutput.prototype._renderInstitutionName = function (v, name, slot, j) {
    var secondary, tertiary, long_style, short_style, institution, institution_short, institution_long;
    var res = this.getName(name, slot.primary, true);
    var primary = res.name;
    var usedOrig = res.usedOrig;
    if (primary) {
        primary = this.fixupInstitution(primary, v, j);
    }
	secondary = false;
	if (slot.secondary) {
        res = this.getName(name, slot.secondary, false, usedOrig);
        var secondary = res.name;
        usedOrig = res.usedOrig;
        if (secondary) {
			secondary = this.fixupInstitution(secondary, v, j);
        }
	}
	tertiary = false;
	if (slot.tertiary) {
        res = this.getName(name, slot.tertiary, false, usedOrig);
        tertiary = res.name;
        if (tertiary) {
			tertiary = this.fixupInstitution(tertiary, v, j);
        }
	}
    var n = {
        l: {
            pri: false,
            sec: false,
            ter: false
        },
        s: {
            pri: false,
            sec: false,
            ter: false
        }
    };
    if (primary) {
        n.l.pri = primary["long"];
        n.s.pri = primary["short"].length ? primary["short"] : primary["long"];
    }
    if (secondary) {
        n.l.sec = secondary["long"];
        n.s.sec = secondary["short"].length ? secondary["short"] : secondary["long"];
    }
    if (tertiary) {
        n.l.ter = tertiary["long"];
        n.s.ter = tertiary["short"].length ? tertiary["short"] : tertiary["long"];
    }
    switch (this.institution.strings["institution-parts"]) {
    case "short":
        if (primary["short"].length) {
            short_style = this._getShortStyle();
            institution = [this._composeOneInstitutionPart([n.s.pri, n.s.sec, n.s.ter], slot, short_style, v)];
        } else {
            long_style = this._getLongStyle(primary, v, j);
            institution = [this._composeOneInstitutionPart([n.l.pri, n.l.sec, n.l.ter], slot, long_style, v)];
        }
        break;
    case "short-long":
        long_style = this._getLongStyle(primary, v, j);
        short_style = this._getShortStyle();
        institution_short = this._renderOneInstitutionPart(primary["short"], short_style);
        institution_long = this._composeOneInstitutionPart([n.l.pri, n.l.sec, n.l.ter], slot, long_style, v);
        institution = [institution_short, institution_long];
        break;
    case "long-short":
        long_style = this._getLongStyle(primary, v, j);
        short_style = this._getShortStyle();
        institution_short = this._renderOneInstitutionPart(primary["short"], short_style);
        institution_long = this._composeOneInstitutionPart([n.l.pri, n.l.sec, n.l.ter], slot, long_style, v);
        institution = [institution_long, institution_short];
        break;
    default:
        long_style = this._getLongStyle(primary, v, j);
        institution = [this._composeOneInstitutionPart([n.l.pri, n.l.sec, n.l.ter], slot, long_style, v)];
        break;
    }
    var blob = this._join(institution, " ");
    this.state.tmp.name_node.children.push(blob);
    return blob;
};
CSL.NameOutput.prototype._composeOneInstitutionPart = function (names, slot, style, v) {
    var primary = false, secondary = false, tertiary = false, primary_tok, secondary_tok, tertiary_tok;
    if (names[0]) {
        primary_tok = CSL.Util.cloneToken(style);
        if (this.state.opt.citeAffixes[slot.primary]){
            if ("<i>" === this.state.opt.citeAffixes.institutions[slot.primary].prefix) {
                var hasItalic = false;
                for (var i = 0, ilen = primary_tok.decorations.length; i < ilen; i += 1) {
                    if (style.decorations[i][0] === "@font-style"
                        && primary_tok.decorations[i][1] === "italic") {
                        hasItalic = true;
                    }
                }
                if (!hasItalic) {
                    primary_tok.decorations.push(["@font-style", "italic"])
                }
            }
        }
        primary = this._renderOneInstitutionPart(names[0], primary_tok);
     }
    if (names[1]) {
        secondary = this._renderOneInstitutionPart(names[1], style);
    }
    if (names[2]) {
        tertiary = this._renderOneInstitutionPart(names[2], style);
    }
    var institutionblob;
    if (secondary || tertiary) {
        this.state.output.openLevel("empty");
        this.state.output.append(primary);
        secondary_tok = CSL.Util.cloneToken(style);
        if (slot.secondary) {
            secondary_tok.strings.prefix = this.state.opt.citeAffixes.institutions[slot.secondary].prefix;
            secondary_tok.strings.suffix = this.state.opt.citeAffixes.institutions[slot.secondary].suffix;
            if (!secondary_tok.strings.prefix) {
                secondary_tok.strings.prefix = " ";
            }
        }
        var secondary_outer = new CSL.Token();
        secondary_outer.decorations.push(["@font-style", "normal"]);
        secondary_outer.decorations.push(["@font-weight", "normal"]);
        this.state.output.openLevel(secondary_outer);
        this.state.output.append(secondary, secondary_tok);
        this.state.output.closeLevel();
        tertiary_tok = CSL.Util.cloneToken(style);
        if (slot.tertiary) {
            tertiary_tok.strings.prefix = this.state.opt.citeAffixes.institutions[slot.tertiary].prefix;
            tertiary_tok.strings.suffix = this.state.opt.citeAffixes.institutions[slot.tertiary].suffix;
            if (!tertiary_tok.strings.prefix) {
                tertiary_tok.strings.prefix = " ";
            }
        }
        var tertiary_outer = new CSL.Token();
        tertiary_outer.decorations.push(["@font-style", "normal"]);
        tertiary_outer.decorations.push(["@font-weight", "normal"]);
        this.state.output.openLevel(tertiary_outer);
        this.state.output.append(tertiary, tertiary_tok);
        this.state.output.closeLevel();
        this.state.output.closeLevel();
        institutionblob = this.state.output.pop();
    } else {
        institutionblob = primary;
    }
    return institutionblob;
}
CSL.NameOutput.prototype._renderOneInstitutionPart = function (blobs, style) {
    for (var i = 0, ilen = blobs.length; i < ilen; i += 1) {
        if (blobs[i]) {
            var str = blobs[i];
            if (this.state.tmp.strip_periods) {
                str = str.replace(/\./g, "");
            } else {
                for (var j = 0, jlen = style.decorations.length; j < jlen; j += 1) {
                    if ("@strip-periods" === style.decorations[j][0] && "true" === style.decorations[j][1]) {
                        str = str.replace(/\./g, "");
                        break;
                    }
                }
            }
            this.state.tmp.group_context.tip.variable_success = true;
            this.state.tmp.can_substitute.replace(false, CSL.LITERAL);
            if (str === "!here>>>") {
                blobs[i] = false;
            } else {
                this.state.output.append(str, style, true);
                blobs[i] = this.state.output.pop();
            }
        }
    }
    if ("undefined" === typeof this.institution.strings["part-separator"]) {
        this.institution.strings["part-separator"] = this.state.tmp.name_delimiter;
    }
    return this._join(blobs, this.institution.strings["part-separator"]);
};
CSL.NameOutput.prototype._renderNames = function (v, values, pos, j) {
    var ret = false;
    if (values.length) {
        var names = [];
        for (var i = 0, ilen = values.length; i < ilen; i += 1) {
            var name = values[i];
            var ret, optLangTag, jlen, key, localesets;
            if (this.state.tmp.extension) {
                localesets = ["sort"];
            } else if (name.isInstitution || name.literal) {
                localesets = this.state.opt['cite-lang-prefs'].institutions;
            } else {
                localesets = this.state.opt['cite-lang-prefs'].persons;
            }
            var slot = {primary:'locale-orig',secondary:false,tertiary:false};
	        if (localesets) {
		        var slotnames = ["primary", "secondary", "tertiary"];
		        for (var k = 0, klen = slotnames.length; k < klen; k += 1) {
			        if (localesets.length - 1 <  k) {
				        break;
			        }
			        slot[slotnames[k]] = 'locale-' + localesets[k];
		        }
	        } else {
		        slot.primary = 'locale-translat';
	        }
	        if (this.state.tmp.sort_key_flag || (this.state.tmp.area !== "bibliography"
		        && !(this.state.tmp.area === "citation"
			         && this.state.opt.xclass === "note"
			         && this.item && !this.item.position))) {
		        slot.secondary = false;
		        slot.tertiary = false;
	        }
            this.setRenderedName(name);
            if (!name.literal && !name.isInstitution) {
                var nameBlob = this._renderPersonalName(v, name, slot, pos, i, j);
                var nameToken = CSL.Util.cloneToken(this.name);
                this.state.output.append(nameBlob, nameToken, true);
                names.push(this.state.output.pop());
            } else {
                names.push(this._renderInstitutionName(v, name, slot, j));
            }
        }
        ret = this.joinPersons(names, pos, j);
    }
    return ret
}
CSL.NameOutput.prototype._renderPersonalName = function (v, name, slot, pos, i, j) {
    var res = this.getName(name, slot.primary, true);
    var primary = this._renderOnePersonalName(res.name, pos, i, j);
	var secondary = false;
	if (slot.secondary) {
        res = this.getName(name, slot.secondary, false, res.usedOrig);
        if (res.name) {
			secondary = this._renderOnePersonalName(res.name, pos, i, j);
        }
	}
	var tertiary = false;
	if (slot.tertiary) {
        res = this.getName(name, slot.tertiary, false, res.usedOrig);
        if (res.name) {
			tertiary = this._renderOnePersonalName(res.name, pos, i, j);
        }
	}
    var personblob;
    if (secondary || tertiary) {
        this.state.output.openLevel("empty");
        this.state.output.append(primary);
        var secondary_tok = new CSL.Token();
        if (slot.secondary) {
            secondary_tok.strings.prefix = this.state.opt.citeAffixes.persons[slot.secondary].prefix;
            secondary_tok.strings.suffix = this.state.opt.citeAffixes.persons[slot.secondary].suffix;
            if (!secondary_tok.strings.prefix) {
                secondary_tok.strings.prefix = " ";
            }
        }
        this.state.output.append(secondary, secondary_tok);
        var tertiary_tok = new CSL.Token();
        if (slot.tertiary) {
            tertiary_tok.strings.prefix = this.state.opt.citeAffixes.persons[slot.tertiary].prefix;
            tertiary_tok.strings.suffix = this.state.opt.citeAffixes.persons[slot.tertiary].suffix;
            if (!tertiary_tok.strings.prefix) {
                tertiary_tok.strings.prefix = " ";
            }
        }
        this.state.output.append(tertiary, tertiary_tok);
        this.state.output.closeLevel();
        personblob = this.state.output.pop();
    } else {
        personblob = primary;
    }
    return personblob;
};
CSL.NameOutput.prototype._isRomanesque = function (name) {
    var ret = 2;
    if (!name.family.replace(/\"/g, '').match(CSL.ROMANESQUE_REGEXP)) {
        ret = 0;
    }
    if (!ret && name.given && name.given.match(CSL.STARTSWITH_ROMANESQUE_REGEXP)) {
        ret = 1;
    }
    if (ret == 2) {
        if (name.multi && name.multi.main) {
            var top_locale = name.multi.main.slice(0, 2);
        } else if (this.Item.language) {
            top_locale = this.Item.language.slice(0, 2);
        }
        if (["ja", "zh"].indexOf(top_locale) > -1) {
            ret = 1;
        }
    }
    return ret;
};
CSL.NameOutput.prototype._renderOnePersonalName = function (value, pos, i, j) {
    var name = value;
    var dropping_particle = this._droppingParticle(name, pos, j);
    var family = this._familyName(name);
    var non_dropping_particle = this._nonDroppingParticle(name);
    var given = this._givenName(name, pos, i);
    var suffix = this._nameSuffix(name);
    if (this._isShort(pos, i) && !name["full-form-always"]) {
        dropping_particle = false;
        given = false;
        suffix = false;
    }
    var sort_sep = this.state.inheritOpt(this.name, "sort-separator");
    if (!sort_sep) {
        sort_sep = "";
    }
    var suffix_sep;
    if (name["comma-suffix"]) {
        suffix_sep = ", ";
    } else {
        suffix_sep = " ";
    }
    var romanesque = this._isRomanesque(name);
    function hasJoiningPunctuation(blob) {
        if (!blob) {
            return false;
        } else if ("string" === typeof blob.blobs) {
            if (["\u2019", "\'", "-", " "].indexOf(blob.blobs.slice(-1)) > -1) {
                return true;
            } else {
                return false;
            }
        } else {
            return hasJoiningPunctuation(blob.blobs[blob.blobs.length-1]);
        }
    }
    var has_hyphenated_non_dropping_particle = hasJoiningPunctuation(non_dropping_particle);
    var blob, merged, first, second;
    if (romanesque === 0) {
        blob = this._join([non_dropping_particle, family, given], "");
    } else if (romanesque === 1 || name["static-ordering"]) { // entry likes sort order
        blob = this._join([non_dropping_particle, family, given], " ");
    } else if (name["reverse-ordering"]) { // entry likes reverse order
        blob = this._join([given, non_dropping_particle, family], " ");
    } else if (this.state.tmp.sort_key_flag) {
        if (this.state.opt["demote-non-dropping-particle"] === "never") {
            first = this._join([non_dropping_particle, family, dropping_particle], " ");
            merged = this._join([first, given], this.state.opt.sort_sep);
            blob = this._join([merged, suffix], " ");
        } else {
            second = this._join([given, dropping_particle, non_dropping_particle], " ");
            merged = this._join([family, second], this.state.opt.sort_sep);
            blob = this._join([merged, suffix], " ");
        }
    } else if (this.state.inheritOpt(this.name, "name-as-sort-order") === "all" || (this.state.inheritOpt(this.name, "name-as-sort-order") === "first" && i === 0 && (j === 0 || "undefined" === typeof j))) {
        if (["Lord", "Lady"].indexOf(name.given) > -1) {
            sort_sep = ", ";
        }
        if (["always", "display-and-sort"].indexOf(this.state.opt["demote-non-dropping-particle"]) > -1) {
            second = this._join([given, dropping_particle], (name["comma-dropping-particle"] + " "));
            second = this._join([second, non_dropping_particle], " ");
            if (second && this.given) {
                second.strings.prefix = this.given.strings.prefix;
                second.strings.suffix = this.given.strings.suffix;
            }
            if (family && this.family) {
                family.strings.prefix = this.family.strings.prefix;
                family.strings.suffix = this.family.strings.suffix;
            }
            merged = this._join([family, second], sort_sep);
            blob = this._join([merged, suffix], sort_sep);
        } else {
            if (has_hyphenated_non_dropping_particle) {
                first = this._join([non_dropping_particle, family], "");
            } else {
                first = this._join([non_dropping_particle, family], " ");
            }
            if (first && this.family) {
                first.strings.prefix = this.family.strings.prefix;
                first.strings.suffix = this.family.strings.suffix;
            }
            second = this._join([given, dropping_particle], (name["comma-dropping-particle"] + " "));
            if (second && this.given) {
                second.strings.prefix = this.given.strings.prefix;
                second.strings.suffix = this.given.strings.suffix;
            }
            merged = this._join([first, second], sort_sep);
            blob = this._join([merged, suffix], sort_sep);
        }
    } else { // plain vanilla
        if (name["dropping-particle"] && name.family && !name["non-dropping-particle"]) {
            if (["'","\u02bc","\u2019","-"].indexOf(name["dropping-particle"].slice(-1)) > -1) {
                family = this._join([dropping_particle, family], "");
                dropping_particle = false;
            }
        }
        if (!this.state.tmp.term_predecessor) {
        }
        var space = " ";
        if (this.state.inheritOpt(this.name, "initialize-with")
            && this.state.inheritOpt(this.name, "initialize-with").match(/[\u00a0\ufeff]/)
            && ["fr", "ru", "cs"].indexOf(this.state.opt["default-locale"][0].slice(0, 2)) > -1) {
            space = "\u00a0"
        }
        if (has_hyphenated_non_dropping_particle) {
            second = this._join([non_dropping_particle, family], "");
            second = this._join([dropping_particle, second], space);
        } else {
            second = this._join([dropping_particle, non_dropping_particle, family], space);
        }
        second = this._join([second, suffix], suffix_sep);
        if (second && this.family) {
            second.strings.prefix = this.family.strings.prefix;
            second.strings.suffix = this.family.strings.suffix;
        }
        if (given && this.given) {
            given.strings.prefix = this.given.strings.prefix;
            given.strings.suffix = this.given.strings.suffix;
        }
        if (second.strings.prefix) {
            name["comma-dropping-particle"] = "";
        }
        blob = this._join([given, second], (name["comma-dropping-particle"] + space));
    }
    this.state.tmp.group_context.tip.variable_success = true;
    this.state.tmp.can_substitute.replace(false, CSL.LITERAL);
    this.state.tmp.term_predecessor = true;
    this.state.tmp.name_node.children.push(blob);
    return blob;
};
CSL.NameOutput.prototype._isShort = function (pos, i) {
    if (0 === this.state.tmp.disambig_settings.givens[pos][i]) {
        return true;
    } else {
        return false;
    }
};
CSL.NameOutput.prototype._normalizeNameInput = function (value) {
    var name = {
        literal:value.literal,
        family:value.family,
        isInstitution:value.isInstitution,
        given:value.given,
        suffix:value.suffix,
        "comma-suffix":value["comma-suffix"],
        "non-dropping-particle":value["non-dropping-particle"],
        "dropping-particle":value["dropping-particle"],
        "static-ordering":value["static-ordering"],
        "static-particles":value["static-particles"],
        "reverse-ordering":value["reverse-ordering"],
        "full-form-always": value["full-form-always"],
        "parse-names":value["parse-names"],
        "comma-dropping-particle": "",
        block_initialize:value.block_initialize,
        multi:value.multi
    };
    this._parseName(name);
    return name;
};
CSL.NameOutput.prototype._stripPeriods = function (tokname, str) {
    var decor_tok = this[tokname + "_decor"];
    if (str) {
        if (this.state.tmp.strip_periods) {
            str = str.replace(/\./g, "");
        } else  if (decor_tok) {
            for (var i = 0, ilen = decor_tok.decorations.length; i < ilen; i += 1) {
                if ("@strip-periods" === decor_tok.decorations[i][0] && "true" === decor_tok.decorations[i][1]) {
                    str = str.replace(/\./g, "");
                    break;
                }
            }
        }
    }
    return str;
};
CSL.NameOutput.prototype._nonDroppingParticle = function (name) {
    var ndp = name["non-dropping-particle"];
    if (ndp && this.state.tmp.sort_key_flag) {
        ndp = ndp.replace(/[\'\u2019]/, "");
    }
    var str = this._stripPeriods("family", ndp);
    if (this.state.output.append(str, this.family_decor, true)) {
        return this.state.output.pop();
    }
    return false;
};
CSL.NameOutput.prototype._droppingParticle = function (name, pos, j) {
    var dp = name["dropping-particle"];
    if (dp && this.state.tmp.sort_key_flag) {
        dp = dp.replace(/[\'\u2019]/, "");
    }
    var str = this._stripPeriods("given", dp);
    if (name["dropping-particle"] && name["dropping-particle"].match(/^et.?al[^a-z]$/)) {
        if (this.state.inheritOpt(this.name, "et-al-use-last")) {
            if ("undefined" === typeof j) { 
                this.etal_spec[pos].freeters = 2;
            } else {
                this.etal_spec[pos].persons = 2;
            }
        } else {
            if ("undefined" === typeof j) { 
                this.etal_spec[pos].freeters = 1;
            } else {
                this.etal_spec[pos].persons = 1;
            }
        }
        name["comma-dropping-particle"] = "";
    } else if (this.state.output.append(str, this.given_decor, true)) {
        return this.state.output.pop();
    }
    return false;
};
CSL.NameOutput.prototype._familyName = function (name) {
    var str = this._stripPeriods("family", name.family);
    if (this.state.output.append(str, this.family_decor, true)) {
        return this.state.output.pop();
    }
    return false;
};
CSL.NameOutput.prototype._givenName = function (name, pos, i) {
    var ret;
    if (this.state.inheritOpt(this.name, "initialize") === false) {
        if (name.family && name.given && this.state.inheritOpt(this.name, "initialize") === false) {
            name.given = CSL.Util.Names.initializeWith(this.state, name.given, this.state.inheritOpt(this.name, "initialize-with"), true);
        }
        name.given = CSL.Util.Names.unInitialize(this.state, name.given);
    } else {
        if (name.family && 1 === this.state.tmp.disambig_settings.givens[pos][i] && !name.block_initialize) {
            var initialize_with = this.state.inheritOpt(this.name, "initialize-with");
            name.given = CSL.Util.Names.initializeWith(this.state, name.given, initialize_with);
        } else {
            name.given = CSL.Util.Names.unInitialize(this.state, name.given);
        }
    }
    var str = this._stripPeriods("given", name.given);
    var rendered = this.state.output.append(str, this.given_decor, true);
    if (rendered) {
        ret = this.state.output.pop();
	    return ret;
    }
    return false;
};
CSL.NameOutput.prototype._nameSuffix = function (name) {
    var str = name.suffix, ret;
    if ("string" === typeof this.state.inheritOpt(this.name, "initialize-with")) {
        str = CSL.Util.Names.initializeWith(this.state, name.suffix, this.state.inheritOpt(this.name, "initialize-with"), true);
    }
    str = this._stripPeriods("family", str);
    var toSuffix = '';
    if (str && str.slice(-1) === '.') {
	str = str.slice(0, -1);
	toSuffix = '.';
    }
    var rendered = this.state.output.append(str, "empty", true);
    if (rendered) {
        ret = this.state.output.pop();
	ret.strings.suffix = toSuffix + ret.strings.suffix;
	return ret;
    }
    return false;
};
CSL.NameOutput.prototype._getLongStyle = function (name, v, i) {
    var long_style, short_style;
    if (name["short"].length) {
        if (this.institutionpart["long-with-short"]) {
            long_style = this.institutionpart["long-with-short"];
        } else {
            long_style = this.institutionpart["long"];
        }
    } else {
        long_style = this.institutionpart["long"];
    }
    if (!long_style) {
        long_style = new CSL.Token();
    }
    return long_style;
};
CSL.NameOutput.prototype._getShortStyle = function () {
    var short_style;
    if (this.institutionpart["short"]) {
        short_style = this.institutionpart["short"];
    } else {
        short_style = new CSL.Token();
    }
    return short_style;
};
CSL.NameOutput.prototype._parseName = function (name) {
    var m, idx;
    if (!name["parse-names"] && "undefined" !== typeof name["parse-names"]) {
        return name;
    }
    if (name.family && !name.given && name.isInstitution) {
        name.literal = name.family;
        name.family = undefined;
        name.isInstitution = undefined;
    }
    var noparse;
    if (name.family 
        && (name.family.slice(0, 1) === '"' && name.family.slice(-1) === '"')
        || (!name["parse-names"] && "undefined" !== typeof name["parse-names"])) {
        name.family = name.family.slice(1, -1);
        noparse = true;
        name["parse-names"] = 0;
    } else {
        noparse = false;
    }
    if (this.state.opt.development_extensions.parse_names) {
        if (!name["non-dropping-particle"] && name.family && !noparse && name.given) {
            if (!name["static-particles"]) {
                CSL.parseParticles(name, true);
            }
        }
    }
};
CSL.NameOutput.prototype.getName = function (name, slotLocaleset, fallback, stopOrig) {
    if (stopOrig && slotLocaleset === 'locale-orig') {
        return {name:false,usedOrig:stopOrig};
    }
    if (!name.family) {
        name.family = "";
    }
    if (!name.given) {
        name.given = "";
    }
    var name_params = {};
    name_params["static-ordering"] = this.getStaticOrder(name);
    var foundTag = true;
    if (slotLocaleset !== 'locale-orig') {
        foundTag = false;
        if (name.multi) {
            var langTags = this.state.opt[slotLocaleset]
            for (var i = 0, ilen = langTags.length; i < ilen; i += 1) {
                langTag = langTags[i];
                if (name.multi._key[langTag]) {
                    foundTag = true;
                    var isInstitution = name.isInstitution;
                    name = name.multi._key[langTag];
                    name.isInstitution = isInstitution;
                    name_params = this.getNameParams(langTag);
                    name_params.transliterated = true;
                    break;
                }
            }
        }
    }
    if (!foundTag) {
        var langTag = false;
        if (name.multi && name.multi.main) {
            langTag = name.multi.main;
        } else if (this.Item.language) {
            langTag = this.Item.language;
        }
        if (langTag) {
            name_params = this.getNameParams(langTag);
        }
    }
    if (!fallback && !foundTag) {
        return {name:false,usedOrig:stopOrig};
    }
    if (!name.family) {
        name.family = "";
    }
    if (!name.given) {
        name.given = "";
    }
    name = {
        family:name.family,
        given:name.given,
        "non-dropping-particle":name["non-dropping-particle"],
        "dropping-particle":name["dropping-particle"],
        suffix:name.suffix,
        "static-ordering":name_params["static-ordering"],
        "static-particles":name["static-particles"],
        "reverse-ordering":name_params["reverse-ordering"],
        "full-form-always": name_params["full-form-always"],
        "parse-names":name["parse-names"],
        "comma-suffix":name["comma-suffix"],
        "comma-dropping-particle":name["comma-dropping-particle"],
        transliterated: name_params.transliterated,
        block_initialize: name_params["block-initialize"],
        literal:name.literal,
        isInstitution:name.isInstitution,
        multi:name.multi
    };
    if (!name.literal && (!name.given && name.family && name.isInstitution)) {
        name.literal = name.family;
    }
    if (name.literal) {
        delete name.family;
        delete name.given;
    }
    name = this._normalizeNameInput(name);
    var usedOrig;
    if (stopOrig) {
        usedOrig = stopOrig;
    } else {
        usedOrig = !foundTag;
    }
    return {name:name,usedOrig:usedOrig};
}
CSL.NameOutput.prototype.getNameParams = function (langTag) {
    var ret = {};
    var langspec = CSL.localeResolve(this.Item.language, this.state.opt["default-locale"][0]);
    var try_locale = this.state.locale[langspec.best] ? langspec.best : this.state.opt["default-locale"][0];
    var name_as_sort_order = this.state.locale[try_locale].opts["name-as-sort-order"]
    var name_as_reverse_order = this.state.locale[try_locale].opts["name-as-reverse-order"]
    var name_never_short = this.state.locale[try_locale].opts["name-never-short"]
    var field_lang_bare = langTag.split("-")[0];
    if (name_as_sort_order && name_as_sort_order[field_lang_bare]) {
        ret["static-ordering"] = true;
        ret["reverse-ordering"] = false;
    }
    if (name_as_reverse_order && name_as_reverse_order[field_lang_bare]) {
        ret["reverse-ordering"] = true;
        ret["static-ordering"] = false;
    }
    if (name_never_short && name_never_short[field_lang_bare]) {
        ret["full-form-always"] = true;
    }
    if (ret["static-ordering"]) {
        ret["block-initialize"] = true;
    }
    return ret;
}
CSL.NameOutput.prototype.setRenderedName = function (name) {
    if (this.state.tmp.area === "bibliography") {
        var strname = "";
        for (var j=0,jlen=CSL.NAME_PARTS.length;j<jlen;j+=1) {
            if (name[CSL.NAME_PARTS[j]]) {
                strname += name[CSL.NAME_PARTS[j]];
            }
        }
        this.state.tmp.rendered_name.push(strname);
    }
}
CSL.NameOutput.prototype.fixupInstitution = function (name, varname, listpos) {
    if (this.state.sys.getHumanForm && "legal_case" === this.Item.type && "authority" === varname) {
        name.literal = this.state.sys.getHumanForm(this.Item.jurisdiction, name.literal, true);
    }
    name = this._splitInstitution(name, varname, listpos);
    if (this.institution.strings["reverse-order"]) {
        name["long"].reverse();
    }
    var long_form = name["long"];
    var short_form = name["long"].slice();
    var use_short_form = false;
    if (this.state.sys.getAbbreviation) {
        var jurisdiction = this.Item.jurisdiction;
        for (var j = 0, jlen = long_form.length; j < jlen; j += 1) {
            var normalizedKey = long_form[j];
            if (this.state.sys.normalizeAbbrevsKey) {
                normalizedKey = this.state.sys.normalizeAbbrevsKey(long_form[j]);
            }
            jurisdiction = this.state.transform.loadAbbreviation(jurisdiction, "institution-part", normalizedKey);
            if (this.state.transform.abbrevs[jurisdiction]["institution-part"][normalizedKey]) {
                short_form[j] = this.state.transform.abbrevs[jurisdiction]["institution-part"][normalizedKey];
                use_short_form = true;
            }
        }
    }
    if (use_short_form) {
        name["short"] = short_form;
    } else {
        name["short"] = [];
    }
    return name;
}
CSL.NameOutput.prototype.getStaticOrder = function (name, refresh) {
    var static_ordering_val = false;
    if (!refresh && name["static-ordering"]) {
        static_ordering_val = true;
    } else if (this._isRomanesque(name) === 0) {
        static_ordering_val = true;
    } else if ((!name.multi || !name.multi.main) && this.Item.language && ['vi', 'hu'].indexOf(this.Item.language) > -1) {
        static_ordering_val = true;
    } else if (name.multi && name.multi.main && ['vi', 'hu'].indexOf(name.multi.main.slice(0,2)) > -1) {
        static_ordering_val = true;
    } else {
        if (this.state.opt['auto-vietnamese-names']
            && (CSL.VIETNAMESE_NAMES.exec(name.family + " " + name.given)
                && CSL.VIETNAMESE_SPECIALS.exec(name.family + name.given))) {
            static_ordering_val = true;
        }
    }
    return static_ordering_val;
}
CSL.NameOutput.prototype._splitInstitution = function (value, v, i) {
    var ret = {};
    if (!value.literal && value.family) {
        value.literal = value.family;
        delete value.family;
    }
    var splitInstitution = value.literal.replace(/\s*\|\s*/g, "|");
    splitInstitution = splitInstitution.split("|");
    if (this.institution.strings.form === "short" && this.state.sys.getAbbreviation) {
        var jurisdiction = this.Item.jurisdiction;
        for (var j = splitInstitution.length; j > 0; j += -1) {
            var str = splitInstitution.slice(0, j).join("|");
            var normalizedKey = str;
            if (this.state.sys.normalizeAbbrevsKey) {
                normalizedKey = this.state.sys.normalizeAbbrevsKey(str);
            }
            jurisdiction = this.state.transform.loadAbbreviation(jurisdiction, "institution-entire", normalizedKey);
            if (this.state.transform.abbrevs[jurisdiction]["institution-entire"][normalizedKey]) {
                var splitLst = this.state.transform.abbrevs[jurisdiction]["institution-entire"][normalizedKey];
                splitLst = this.state.transform.quashCheck(splitLst);
                var splitSplitLst = splitLst.split(/>>[0-9]{4}>>/);
                var m = splitLst.match(/>>([0-9]{4})>>/);
                splitLst = splitSplitLst.pop();
                if (splitSplitLst.length > 0 && this.Item["original-date"] && this.Item["original-date"].year) {
                    for (var k=m.length - 1; k > 0; k += -1) {
                        if (parseInt(this.Item["original-date"].year, 10) >= parseInt(m[k], 10)) {
                            break;
                        }
                        splitLst = splitSplitLst.pop();
                    }
                }
                splitLst = splitLst.replace(/\s*\|\s*/g, "|");
                splitInstitution = [splitLst];
                break;
            }
        }
    }
    splitInstitution.reverse();
    ret["long"] = this._trimInstitution(splitInstitution, v, i);
    return ret;
};
CSL.NameOutput.prototype._trimInstitution = function (subunits, v, i) {
    var use_first = false;
    var append_last = false;
    var s = subunits.slice();
    var stop_last = false;
    if (this.institution) {
        if ("undefined" !== typeof this.institution.strings["use-first"]) {
            use_first = this.institution.strings["use-first"];
        }
        if ("undefined" !== typeof this.institution.strings["stop-last"]) {
            stop_last = this.institution.strings["stop-last"];
        } else if ("authority" === v && this.state.tmp.authority_stop_last) {
            stop_last = this.state.tmp.authority_stop_last;
        }
        if (stop_last) {
            s = s.slice(0, stop_last);
            subunits = subunits.slice(0, stop_last);
        }
        if ("undefined" !== typeof this.institution.strings["use-last"]) {
            append_last = this.institution.strings["use-last"];
        }
        if ("authority" === v) {
            if (stop_last) {
                this.state.tmp.authority_stop_last = stop_last;
            }
            if (append_last)  {
                this.state.tmp.authority_stop_last += (append_last * -1);
            }
        }
    }
    if (false === use_first) {
        if (this.persons[v].length === 0) {
            use_first = this.institution.strings["substitute-use-first"];
        }
        if (!use_first) {
            use_first = 0;
        }
    }
    if (false === append_last) {
        if (!use_first) {
            append_last = subunits.length;
        } else {
            append_last = 0;
        }
    }
    if (use_first > subunits.length - append_last) {
        use_first = subunits.length - append_last;
    }
    subunits = subunits.slice(0, use_first);
    s = s.slice(use_first);
    if (append_last) {
        if (append_last > s.length) {
            append_last = s.length;
        }
        if (append_last) {
            subunits = subunits.concat(s.slice((s.length - append_last)));
        }
    }
    return subunits;
};
module.exports = CSL;
CSL.PublisherOutput = function (state, group_tok) {
    this.state = state;
    this.group_tok = group_tok;
    this.varlist = [];
};
CSL.PublisherOutput.prototype.render = function () {
    this.clearVars();
    this.composeAndBlob();
    this.composeElements();
    this.composePublishers();
    this.joinPublishers();
};
CSL.PublisherOutput.prototype.composeAndBlob = function () {
    this.and_blob = {};
    var and_term = false;
    if (this.group_tok.strings.and === "text") {
        and_term = this.state.getTerm("and");
    } else if (this.group_tok.strings.and === "symbol") {
        and_term = "&";
    }
    var tok = new CSL.Token();
    tok.strings.suffix = " ";
    tok.strings.prefix = " ";
    this.state.output.append(and_term, tok, true);
    var no_delim = this.state.output.pop();
    tok.strings.prefix = this.group_tok.strings["subgroup-delimiter"];
    this.state.output.append(and_term, tok, true);
    var with_delim = this.state.output.pop();
    this.and_blob.single = false;
    this.and_blob.multiple = false;
    if (and_term) {
        if (this.group_tok.strings["subgroup-delimiter-precedes-last"] === "always") {
            this.and_blob.single = with_delim;
        } else if (this.group_tok.strings["subgroup-delimiter-precedes-last"] === "never") {
            this.and_blob.single = no_delim;
            this.and_blob.multiple = no_delim;
        } else {
            this.and_blob.single = no_delim;
            this.and_blob.multiple = with_delim;
        }
    }
};
CSL.PublisherOutput.prototype.composeElements = function () {
    for (var i = 0, ilen = 2; i < ilen; i += 1) {
        var varname = ["publisher", "publisher-place"][i];
        for (var j = 0, jlen = this["publisher-list"].length; j < jlen; j += 1) {
            var str = this[varname + "-list"][j];
            var tok = this[varname + "-token"];
            this.state.output.append(str, tok, true);
            this[varname + "-list"][j] = this.state.output.pop();
        }
    }
};
CSL.PublisherOutput.prototype.composePublishers = function () {
    var blobs;
    for (var i = 0, ilen = this["publisher-list"].length; i < ilen; i += 1) {
        var ordered_list = [];
        blobs = [this[this.varlist[0] + "-list"][i], this[this.varlist[1] + "-list"][i]];
        this["publisher-list"][i] = this._join(blobs, this.group_tok.strings.delimiter);
    }
};
CSL.PublisherOutput.prototype.joinPublishers = function () {
    var blobs = this["publisher-list"];
    var delim = this.name_delimiter;
    var publishers = this._join(blobs, this.group_tok.strings["subgroup-delimiter"], this.and_blob.single, this.and_blob.multiple, this.group_tok);
    this.state.output.append(publishers, "literal");
};
CSL.PublisherOutput.prototype._join = CSL.NameOutput.prototype._join;
CSL.PublisherOutput.prototype._getToken = CSL.NameOutput.prototype._getToken;
CSL.PublisherOutput.prototype.clearVars = function () {
    this.state.tmp["publisher-list"] = false;
    this.state.tmp["publisher-place-list"] = false;
    this.state.tmp["publisher-group-token"] = false;
    this.state.tmp["publisher-token"] = false;
    this.state.tmp["publisher-place-token"] = false;
};
module.exports = CSL;
CSL.evaluateLabel = function (node, state, Item, item) {
    var myterm;
    if ("locator" === node.strings.term) {
        if (item && item.label) {
            if (item.label === "sub verbo") {
                myterm = "sub-verbo";
            } else {
                myterm = item.label;
            }
        }
        if (!myterm) {
            myterm = "page";
        }
    } else {
        myterm = node.strings.term;
    }
    var plural = node.strings.plural;
    if ("number" !== typeof plural) {
        var theItem = node.strings.term === "locator" ? item : Item;
        state.processNumber(false, theItem, node.strings.term, Item.type);
        plural = state.tmp.shadow_numbers[node.strings.term].plural;
        if (!state.tmp.shadow_numbers[node.strings.term].labelForm
           && !state.tmp.shadow_numbers[node.strings.term].labelDecorations) {
            state.tmp.shadow_numbers[node.strings.term].labelForm = node.strings.form;
            state.tmp.shadow_numbers[node.strings.term].labelDecorations = node.decorations.slice();
        }
        if (["locator", "number", "page"].indexOf(node.strings.term) > -1 && state.tmp.shadow_numbers[node.strings.term].label) {
            myterm = state.tmp.shadow_numbers[node.strings.term].label;
        }
        if (node.decorations && (state.opt.development_extensions.csl_reverse_lookup_support || state.sys.csl_reverse_lookup_support)) {
            node.decorations.reverse();
            node.decorations.push(["@showid","true", node.cslid]);
            node.decorations.reverse();
        }
    }
    return CSL.castLabel(state, node, myterm, plural, CSL.TOLERANT);
};
CSL.castLabel = function (state, node, term, plural, mode) {
    var label_form = node.strings.form;
    if (state.tmp.group_context.tip.label_form && label_form !== "static") {
        label_form = state.tmp.group_context.tip.label_form;
    }
    var ret = state.getTerm(term, label_form, plural, false, mode, node.default_locale);
    if (state.tmp.strip_periods) {
        ret = ret.replace(/\./g, "");
    } else {
        for (var i = 0, ilen = node.decorations.length; i < ilen; i += 1) {
            if ("@strip-periods" === node.decorations[i][0] && "true" === node.decorations[i][1]) {
                ret = ret.replace(/\./g, "");
                break;
            }
        }
    }
    return ret;
};
module.exports = CSL;
CSL.Node.name = {
    build: function (state, target) {
        var func, pos, len, attrname;
        if ([CSL.SINGLETON, CSL.START].indexOf(this.tokentype) > -1) {
            if ("undefined" === typeof state.tmp.root) {
                var oldTmpRoot = undefined;
                state.tmp.root = "citation";
            } else {
                var oldTmpRoot = state.tmp.root;
            }
            if (state.inheritOpt(this, "et-al-subsequent-min")
                && (state.inheritOpt(this, "et-al-subsequent-min") !== state.inheritOpt(this, "et-al-min"))) {
                state.opt.update_mode = CSL.POSITION;
            }
            if (state.inheritOpt(this, "et-al-subsequent-use-first")
                && (state.inheritOpt(this, "et-al-subsequent-use-first") !== state.inheritOpt(this, "et-al-use-first"))) {
                state.opt.update_mode = CSL.POSITION;
            }
            state.tmp.root = oldTmpRoot;
            func = function (state, Item) {
                state.tmp.etal_term = "et-al";
                state.tmp.name_delimiter = state.inheritOpt(this, "delimiter", "name-delimiter", ", ");
                state.tmp["delimiter-precedes-et-al"] = state.inheritOpt(this, "delimiter-precedes-et-al");
                if ("text" === state.inheritOpt(this, "and")) {
                    this.and_term = state.getTerm("and", "long", 0);
                } else if ("symbol" === state.inheritOpt(this, "and")) {
                    if (state.opt.development_extensions.expect_and_symbol_form) {
                        this.and_term = state.getTerm("and", "symbol", 0);
                    } else {
                        this.and_term = "&";
                    }
                }
                state.tmp.and_term = this.and_term;
                if (CSL.STARTSWITH_ROMANESQUE_REGEXP.test(this.and_term)) {
                    this.and_prefix_single = " ";
                    this.and_prefix_multiple = ", ";
                    if ("string" === typeof state.tmp.name_delimiter) {
                        this.and_prefix_multiple = state.tmp.name_delimiter;
                    }
                    this.and_suffix = " ";
                } else {
                    this.and_prefix_single = "";
                    this.and_prefix_multiple = "";
                    this.and_suffix = "";
                }
                if (state.inheritOpt(this, "delimiter-precedes-last") === "always") {
                    this.and_prefix_single = state.tmp.name_delimiter;
                } else if (state.inheritOpt(this, "delimiter-precedes-last") === "never") {
                    if (this.and_prefix_multiple) {
                        this.and_prefix_multiple = " ";
                    }
                } else if (state.inheritOpt(this, "delimiter-precedes-last") === "after-inverted-name") {
                    if (this.and_prefix_single) {
                        this.and_prefix_single = state.tmp.name_delimiter;
                    }
                    if (this.and_prefix_multiple) {
                        this.and_prefix_multiple = " ";
                    }
                }
                this.and = {};
                if (state.inheritOpt(this, "and")) {
                    state.output.append(this.and_term, "empty", true);
                    this.and.single = state.output.pop();
                    this.and.single.strings.prefix = this.and_prefix_single;
                    this.and.single.strings.suffix = this.and_suffix;
                    state.output.append(this.and_term, "empty", true);
                    this.and.multiple = state.output.pop();
                    this.and.multiple.strings.prefix = this.and_prefix_multiple;
                    this.and.multiple.strings.suffix = this.and_suffix;
                } else if (state.tmp.name_delimiter) {
                    this.and.single = new CSL.Blob(state.tmp.name_delimiter);
                    this.and.single.strings.prefix = "";
                    this.and.single.strings.suffix = "";
                    this.and.multiple = new CSL.Blob(state.tmp.name_delimiter);
                    this.and.multiple.strings.prefix = "";
                    this.and.multiple.strings.suffix = "";
                }
                this.ellipsis = {};
                if (state.inheritOpt(this, "et-al-use-last")) {
                    this.ellipsis_term = "\u2026";
                    this.ellipsis_prefix_single = " ";
                    this.ellipsis_prefix_multiple =  state.inheritOpt(this, "delimiter", "name-delimiter", ", ");
                    this.ellipsis_suffix = " ";
                    this.ellipsis.single = new CSL.Blob(this.ellipsis_term);
                    this.ellipsis.single.strings.prefix = this.ellipsis_prefix_single;
                    this.ellipsis.single.strings.suffix = this.ellipsis_suffix;
                    this.ellipsis.multiple = new CSL.Blob(this.ellipsis_term);
                    this.ellipsis.multiple.strings.prefix = this.ellipsis_prefix_multiple;
                    this.ellipsis.multiple.strings.suffix = this.ellipsis_suffix;
                }
                if ("undefined" === typeof state.tmp["et-al-min"]) {
                    state.tmp["et-al-min"] = state.inheritOpt(this, "et-al-min");
                }
                if ("undefined" === typeof state.tmp["et-al-use-first"]) {
                    state.tmp["et-al-use-first"] = state.inheritOpt(this, "et-al-use-first");
                }
                if ("undefined" === typeof state.tmp["et-al-use-last"]) {
                    state.tmp["et-al-use-last"] = state.inheritOpt(this, "et-al-use-last");
                }
                state.nameOutput.name = this;
            };
            state.build.name_flag = true;
            this.execs.push(func);
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node["name-part"] = {
    build: function (state, target) {
        state.build[this.strings.name] = this;
    }
};
module.exports = CSL;
CSL.Node.names = {
    build: function (state, target) {
        var func, len, pos, attrname;
        var debug = false;
        if (this.tokentype === CSL.START || this.tokentype === CSL.SINGLETON) {
            CSL.Util.substituteStart.call(this, state, target);
            state.build.substitute_level.push(1);
        }
        if (this.tokentype === CSL.SINGLETON) {
            state.build.names_variables.push(this.variables);
            func = function (state, Item, item) {
                var labelVariable = state.nameOutput.labelVariable;
                state.nameOutput.reinit(this, labelVariable);
            };
            this.execs.push(func);
        }
        if (this.tokentype === CSL.START) {
            state.build.names_flag = true;
            state.build.names_level += 1;
            if (state.build.names_level === 1) {
                state.build.names_variables = [];
                state.build.name_label = {};
            }
            state.build.names_variables.push(this.variables);
            func = function (state, Item, item) {
                state.tmp.can_substitute.push(true);
                state.parallel.StartVariable("names",this.variables[0]);
                state.nameOutput.init(this);
            };
            this.execs.push(func);
        }
        if (this.tokentype === CSL.END) {
            for (var i = 0, ilen = 3; i < ilen; i += 1) {
                var key = ["family", "given", "et-al"][i];
                this[key] = state.build[key];
                if (state.build.names_level === 1) {
                    state.build[key] = undefined;
                }
            }
            this.label = state.build.name_label;
            if (state.build.names_level === 1) {
                state.build.name_label = {};
            }
            state.build.names_level += -1;
            state.build.names_variables.pop();
            func = function (state, Item, item) {
                if (state.tmp.etal_node) {
                    this.etal_style = state.tmp.etal_node;
                } else {
                    this.etal_style = "empty";
                }
                this.etal_term = state.getTerm(state.tmp.etal_term, "long", 0);
                if (CSL.STARTSWITH_ROMANESQUE_REGEXP.test(this.etal_term)) {
                    this.etal_prefix_single = " ";
                    this.etal_prefix_multiple = state.tmp.name_delimiter;
                    if (state.tmp["delimiter-precedes-et-al"] === "always") {
                        this.etal_prefix_single = state.tmp.name_delimiter;
                    } else if (state.tmp["delimiter-precedes-et-al"] === "never") {
                        this.etal_prefix_multiple = " ";
                    } else if (state.tmp["delimiter-precedes-et-al"] === "after-inverted-name") {
                        this.etal_prefix_single = state.tmp.name_delimiter;
                        this.etal_prefix_multiple = " ";
                    }
                    this.etal_suffix = "";
                } else {
                    this.etal_prefix_single = "";
                    this.etal_prefix_multiple = "";
                    this.etal_suffix = "";
                }
                for (var i = 0, ilen = 3; i < ilen; i += 1) {
                    var key = ["family", "given"][i];
                    state.nameOutput[key] = this[key];
                }
                state.nameOutput["with"] = this["with"];
                var mywith = "with";
                var with_default_prefix = "";
                var with_suffix = "";
                if (CSL.STARTSWITH_ROMANESQUE_REGEXP.test(mywith)) {
                    with_default_prefix = " ";
                    with_suffix = " ";
                }
                var thewith = {};
                thewith.single = new CSL.Blob(mywith);
                thewith.single.strings.suffix = with_suffix;
                thewith.multiple = new CSL.Blob(mywith);
                thewith.multiple.strings.suffix = with_suffix;
                if (state.inheritOpt(state.nameOutput.name, "delimiter-precedes-last") === "always") {
                    thewith.single.strings.prefix = state.inheritOpt(this, "delimiter", "names-delimiter");
                    thewith.multiple.strings.prefix = state.inheritOpt(this, "delimiter", "names-delimiter");
                } else if (state.inheritOpt(state.nameOutput.name, "delimiter-precedes-last") === "contextual") {
                    thewith.single.strings.prefix = with_default_prefix;
                    thewith.multiple.strings.prefix = state.inheritOpt(this, "delimiter", "names-delimiter");
                } else if (state.inheritOpt(state.nameOutput.name, "delimiter-precedes-last") === "after-inverted-name") {
                    thewith.single.strings.prefix = state.inheritOpt(this, "delimiter", "names-delimiter");
                    thewith.multiple.strings.prefix = with_default_prefix;
                } else {
                    thewith.single.strings.prefix = with_default_prefix;
                    thewith.multiple.strings.prefix = with_default_prefix;
                }
                state.nameOutput["with"] = thewith;
                state.nameOutput.label = this.label;
                state.nameOutput.etal_style = this.etal_style;
                state.nameOutput.etal_term = this.etal_term;
                state.nameOutput.etal_prefix_single = this.etal_prefix_single;
                state.nameOutput.etal_prefix_multiple = this.etal_prefix_multiple;
                state.nameOutput.etal_suffix = this.etal_suffix;
                state.nameOutput.outputNames();
                state.tmp["et-al-use-first"] = undefined;
                state.tmp["et-al-min"] = undefined;
                state.tmp["et-al-use-last"] = undefined;
            };
            this.execs.push(func);
            func = function (state, Item) {
                if (!state.tmp.can_substitute.pop()) {
                    state.tmp.can_substitute.replace(false, CSL.LITERAL);
                }
                state.parallel.CloseVariable("names");
                if (state.tmp.can_substitute.mystack.length === 1) {
                    state.tmp.can_block_substitute = false;
                }
            };
            this.execs.push(func);
            state.build.name_flag = false;
        }
        target.push(this);
        if (this.tokentype === CSL.END || this.tokentype === CSL.SINGLETON) {
            state.build.substitute_level.pop();
            CSL.Util.substituteEnd.call(this, state, target);
        }
    }
};
module.exports = CSL;
CSL.Node.number = {
    build: function (state, target) {
        var func;
        CSL.Util.substituteStart.call(this, state, target);
        if (this.strings.form === "roman") {
            this.formatter = state.fun.romanizer;
        } else if (this.strings.form === "ordinal") {
            this.formatter = state.fun.ordinalizer;
        } else if (this.strings.form === "long-ordinal") {
            this.formatter = state.fun.long_ordinalizer;
        }
        if ("undefined" === typeof this.successor_prefix) {
            this.successor_prefix = state[state.build.area].opt.layout_delimiter;
        }
        if ("undefined" === typeof this.splice_prefix) {
            this.splice_prefix = state[state.build.area].opt.layout_delimiter;
        }
        func = function (state, Item, item) {
            var i, ilen, newlst, lst;
            if (this.variables.length === 0) {
                return;
            }
            if ("undefined" === typeof item) {
                var item = {};
            }
            var varname, num, number, m, j, jlen;
            varname = this.variables[0];
            if (varname === "locator" && state.tmp.just_looking) {
                return;
            }
            state.parallel.StartVariable(this.variables[0]);
            if (this.variables[0] === "locator") {
                state.parallel.AppendToVariable(Item.section);
            } else {
                state.parallel.AppendToVariable(Item[this.variables[0]]);
            }
            var rex = new RegExp("(?:&|, | and |" + state.getTerm("page-range-delimiter") + ")");
            if (varname === 'collection-number' && Item.type === 'legal_case') {
                state.tmp.renders_collection_number = true;
            }
            var value = Item[this.variables[0]];
            var form = "long";
            if (this.strings.label_form_override) {
                form = this.strings.label_form_override;
            }
            var node = this;
            if (state.tmp.group_context.tip.force_suppress) {
                return false;
            }
            if (varname === "locator") {
                state.processNumber(node, item, varname, Item.type);
            } else {
                if (!state.tmp.group_context.tip.condition && Item[varname]) {
                    state.tmp.just_did_number = true;
                }
                state.processNumber(node, Item, varname, Item.type);
            }
            CSL.Util.outputNumericField(state, varname, Item.id);
            state.parallel.CloseVariable("number");
            if (["locator", "locator-extra"].indexOf(this.variables_real[0]) > -1
               && !state.tmp.just_looking) {
                state.tmp.done_vars.push(this.variables_real[0]);
                state.tmp.group_context.tip.done_vars.push(this.variables_real[0]);
            }
        };
        this.execs.push(func);
        target.push(this);
        CSL.Util.substituteEnd.call(this, state, target);
    }
};
module.exports = CSL;
CSL.Node.sort = {
    build: function (state, target) {
        target = state[state.build.root + "_sort"].tokens;
        if (this.tokentype === CSL.START) {
            if (state.build.area === "citation") {
                state.parallel.use_parallels = false;
                state.opt.sort_citations = true;
            }
            state.build.area = state.build.root + "_sort";
            state.build.extension = "_sort";
            var func = function (state, Item) {
                if (state.opt.has_layout_locale) {
                    var langspec = CSL.localeResolve(Item.language, state.opt["default-locale"][0]);
                    var sort_locales = state[state.tmp.area.slice(0,-5)].opt.sort_locales;
                    var langForItem;
                    for (var i=0,ilen=sort_locales.length;i<ilen;i+=1) {
                        langForItem = sort_locales[i][langspec.bare];
                        if (!langForItem) {
                            langForItem = sort_locales[i][langspec.best];
                        }
                        if (langForItem) {
                            break;
                        }
                    }
                    if (!langForItem) {
                        langForItem = state.opt["default-locale"][0];
                    }
                    state.tmp.lang_sort_hold = state.opt.lang;
                    state.opt.lang = langForItem;
                }
            }
            this.execs.push(func);
        }
        if (this.tokentype === CSL.END) {
            state.build.area = state.build.root;
            state.build.extension = "";
            var func = function (state, Item) {
                if (state.opt.has_layout_locale) {
                    state.opt.lang = state.tmp.lang_sort_hold;
                    delete state.tmp.lang_sort_hold;
                }
            }
            this.execs.push(func);
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.substitute = {
    build: function (state, target) {
        var func;
        if (this.tokentype === CSL.START) {
            func = function (state, Item) {
                state.tmp.can_block_substitute = true;
                if (state.tmp.value.length) {
                    state.tmp.can_substitute.replace(false, CSL.LITERAL);
                }
            };
            this.execs.push(func);
        }
        target.push(this);
    }
};
module.exports = CSL;
CSL.Node.text = {
    build: function (state, target) {
        var variable, func, form, plural, id, num, number, formatter, firstoutput, specialdelimiter, label, myname, names, name, year, suffix, term, dp, len, pos, n, m, value, flag;
        if (this.postponed_macro) {
            var group_start = CSL.Util.cloneToken(this);
            group_start.name = "group";
            group_start.tokentype = CSL.START;
            CSL.Node.group.build.call(group_start, state, target);
            CSL.expandMacro.call(state, this, target);
            var group_end = CSL.Util.cloneToken(this);
            group_end.name = "group";
            group_end.tokentype = CSL.END;
            if (this.postponed_macro === 'juris-locator-label') {
                group_end.isJurisLocatorLabel = true;
            }
            CSL.Node.group.build.call(group_end, state, target);
        } else {
            CSL.Util.substituteStart.call(this, state, target);
            if (!this.variables_real) {
                this.variables_real = [];
            }
            if (!this.variables) {
                this.variables = [];
            }
            form = "long";
            plural = 0;
            if (this.strings.form) {
                form = this.strings.form;
            }
            if (this.strings.plural) {
                plural = this.strings.plural;
            }
            if ("citation-number" === this.variables_real[0] || "year-suffix" === this.variables_real[0] || "citation-label" === this.variables_real[0]) {
                if (this.variables_real[0] === "citation-number") {
                    if (state.build.root === "citation") {
                        state.opt.update_mode = CSL.NUMERIC;
                    }
                    if (state.build.root === "bibliography") {
                        state.opt.bib_mode = CSL.NUMERIC;
                    }
                    if (state.build.area === "bibliography_sort") {
                        state.opt.citation_number_sort_used = true;
                    }
                    if ("citation-number" === state[state.tmp.area].opt.collapse) {
                        this.range_prefix = state.getTerm("citation-range-delimiter");
                    }
                    this.successor_prefix = state[state.build.area].opt.layout_delimiter;
                    this.splice_prefix = state[state.build.area].opt.layout_delimiter;
                    func = function (state, Item, item) {
                        id = "" + Item.id;
                        if (!state.tmp.just_looking) {
                            if (item && item["author-only"]) {
                                state.tmp.element_trace.replace("do-not-suppress-me");
                                var reference_term = state.getTerm("reference", "long", "singular");
                                if ("undefined" === typeof reference_term) {
                                    reference_term = "reference";
                                }
                                term = CSL.Output.Formatters["capitalize-first"](state, reference_term);
                                state.output.append(term + " ");
                                state.tmp.last_element_trace = true;
                            }
                            if (item && item["suppress-author"]) {
                                if (state.tmp.last_element_trace) {
                                    state.tmp.element_trace.replace("suppress-me");
                                }
                                state.tmp.last_element_trace = false;
                            }
                            num = state.registry.registry[id].seq;
                            if (state.opt.citation_number_slug) {
                                state.output.append(state.opt.citation_number_slug, this);
                            } else {
                                number = new CSL.NumericBlob(false, num, this, Item.id);
                                if (state.tmp.in_cite_predecessor) {
                                    if (!state.tmp.just_looking) {
                                    }
                                    number.suppress_splice_prefix = true;
                                }
                                state.output.append(number, "literal");
                            }
                        }
                    };
                    this.execs.push(func);
                } else if (this.variables_real[0] === "year-suffix") {
                    state.opt.has_year_suffix = true;
                    if (state[state.tmp.area].opt.collapse === "year-suffix-ranged") {
                        this.range_prefix = state.getTerm("citation-range-delimiter");
                    }
                    this.successor_prefix = state[state.build.area].opt.layout_delimiter;
                    if (state[state.tmp.area].opt["year-suffix-delimiter"]) {
                        this.successor_prefix = state[state.build.area].opt["year-suffix-delimiter"];
                    }
                    func = function (state, Item) {
                        if (state.registry.registry[Item.id] && state.registry.registry[Item.id].disambig.year_suffix !== false && !state.tmp.just_looking) {
                            num = parseInt(state.registry.registry[Item.id].disambig.year_suffix, 10);
                            if (state[state.tmp.area].opt.cite_group_delimiter) {
                                this.successor_prefix = state[state.tmp.area].opt.cite_group_delimiter;
                            }
                            number = new CSL.NumericBlob(false, num, this, Item.id);
                            formatter = new CSL.Util.Suffixator(CSL.SUFFIX_CHARS);
                            number.setFormatter(formatter);
                            state.output.append(number, "literal");
                            firstoutput = false;
                            for (var i=0,ilen=state.tmp.group_context.mystack.length; i<ilen; i++) {
                                var flags = state.tmp.group_context.mystack[i];
                                if (!flags.variable_success && (flags.variable_attempt || (!flags.variable_attempt && !flags.term_intended))) {
                                    firstoutput = true;
                                    break;
                                }
                            }
                            specialdelimiter = state[state.tmp.area].opt["year-suffix-delimiter"];
                            if (firstoutput && specialdelimiter && !state.tmp.sort_key_flag) {
                                state.tmp.splice_delimiter = state[state.tmp.area].opt["year-suffix-delimiter"];
                            }
                        }
                    };
                    this.execs.push(func);
                } else if (this.variables_real[0] === "citation-label") {
                    state.opt.has_year_suffix = true;
                    func = function (state, Item) {
                        label = Item["citation-label"];
                        if (!label) {
                            label = state.getCitationLabel(Item);
                        }
                        if (!state.tmp.just_looking) {
                            suffix = "";
                            if (state.registry.registry[Item.id] && state.registry.registry[Item.id].disambig.year_suffix !== false) {
                                num = parseInt(state.registry.registry[Item.id].disambig.year_suffix, 10);
                                suffix = state.fun.suffixator.format(num);
                            }
                            label += suffix;
                        }
                        state.output.append(label, this);
                    };
                    this.execs.push(func);
                }
            } else {
                if (this.strings.term) {
                    func = function (state, Item, item) {
                        var gender = state.opt.gender[Item.type];
                        var term = this.strings.term;
                        term = state.getTerm(term, form, plural, gender, CSL.TOLERANT, this.default_locale);
                        var myterm;
                        if (term !== "") {
                            state.tmp.group_context.tip.term_intended = true;
                        }
                        CSL.UPDATE_GROUP_CONTEXT_CONDITION(state, term);
                        if (!state.tmp.term_predecessor && !(state.opt["class"] === "in-text" && state.tmp.area === "citation")) {
                            myterm = CSL.Output.Formatters["capitalize-first"](state, term);
                        } else {
                            myterm = term;
                        }
                        if (state.tmp.strip_periods) {
                            myterm = myterm.replace(/\./g, "");
                        } else {
                            for (var i = 0, ilen = this.decorations.length; i < ilen; i += 1) {
                                if ("@strip-periods" === this.decorations[i][0] && "true" === this.decorations[i][1]) {
                                    myterm = myterm.replace(/\./g, "");
                                    break;
                                }
                            }
                        }
                        state.output.append(myterm, this);
                    };
                    this.execs.push(func);
                    state.build.term = false;
                    state.build.form = false;
                    state.build.plural = false;
                } else if (this.variables_real.length) {
                    func = function (state, Item, item) {
                        if (this.variables_real[0] !== "locator") {
                            state.tmp.have_collapsed = false;
                        }
                        var parallel_variable = this.variables[0];
                        if (parallel_variable === "title" 
                            && (form === "short" || Item["title-short"])) { 
                            parallel_variable = "title-short";
                        }
                        state.parallel.StartVariable(parallel_variable);
                        state.parallel.AppendToVariable(Item[parallel_variable],parallel_variable);
                        if (!state.tmp.group_context.tip.condition && Item[this.variables[0]]) {
                            state.tmp.just_did_number = false;
                        }
                    };
                    this.execs.push(func);
                    if (CSL.MULTI_FIELDS.indexOf(this.variables_real[0]) > -1
                        || ["language-name", "language-name-original"].indexOf(this.variables_real[0]) > -1) {
                        var abbrevfam = this.variables[0];
                        var abbrfall = false;
                        var altvar = false;
                        var transfall = false;
                        if (form === "short") {
                            if (this.variables_real[0] === "container-title") {
                                altvar = "journalAbbreviation";
                            } else if (this.variables_real[0] === "title") {
                                altvar = "title-short";
                            }
                        } else {
                            abbrevfam = false;
                        }
                        if (state.build.extension) {
                            transfall = true;
                        } else {
                            transfall = true;
                            abbrfall = true;
						}
                        func = state.transform.getOutputFunction(this.variables, abbrevfam, abbrfall, altvar, transfall);
                    } else {
                        if (CSL.CITE_FIELDS.indexOf(this.variables_real[0]) > -1) {
                            func = function (state, Item, item) {
                                if (item && item[this.variables[0]]) {
                                    state.processNumber(this, item, this.variables[0], Item.type);
                                    CSL.Util.outputNumericField(state, this.variables[0], Item.id);
                                    state.output.append(value, this, false, false, true);
                                    if (["locator", "locator-extra"].indexOf(this.variables_real[0]) > -1
                                       && !state.tmp.just_looking) { 
                                        state.tmp.done_vars.push(this.variables_real[0]);
                                    }
                                }
                            };
                        } else  if (["page", "page-first", "chapter-number", "collection-number", "edition", "issue", "number", "number-of-pages", "number-of-volumes", "volume"].indexOf(this.variables_real[0]) > -1) {
                            func = function(state, Item) {
                                state.processNumber(this, Item, this.variables[0], Item.type);
                                CSL.Util.outputNumericField(state, this.variables[0], Item.id);
                            }
                        } else if (["URL", "DOI"].indexOf(this.variables_real[0]) > -1) {
                            func = function (state, Item) {
                                var value;
                                if (this.variables[0]) {
                                    value = state.getVariable(Item, this.variables[0], form);
                                    if (value) {
                                        if (state.opt.development_extensions.wrap_url_and_doi) {
                                            if (!this.decorations.length || this.decorations[0][0] !== "@" + this.variables[0]) {
                                                this.decorations = [["@" + this.variables[0], "true"]].concat(this.decorations);
                                            }
                                        } else {
                                            if (this.decorations.length && this.decorations[0][0] === "@" + this.variables[0]) {
                                                this.decorations = this.decorations.slice(1);
                                            }
                                        }
                                        state.output.append(value, this, false, false, true);
                                    }
                                }
                            };
                        } else if (this.variables_real[0] === "section") {
                            func = function (state, Item) {
                                var value;
                                value = state.getVariable(Item, this.variables[0], form);
                                if (value) {
                                    state.output.append(value, this);
                                }
                            };
                        } else if (this.variables_real[0] === "hereinafter") {
                            func = function (state, Item) {
                                var value = state.transform.abbrevs["default"]["hereinafter"][Item.id];
                                if (value) {
                                    state.output.append(value, this);
                                    state.tmp.group_context.tip.variable_success = true;
                                }
                            }
                        } else {
                            func = function (state, Item) {
                                var value;
                                if (this.variables[0]) {
                                    value = state.getVariable(Item, this.variables[0], form);
                                    if (value) {
                                        value = "" + value;
                                        value = value.split("\\").join("");
                                        state.output.append(value, this);
                                    }
                                }
                            };
                        }
                    }
                    this.execs.push(func);
                    func = function (state, Item) {
                        state.parallel.CloseVariable("text");
                    };
                    this.execs.push(func);
                } else if (this.strings.value) {
                    func = function (state, Item) {
                        state.tmp.group_context.tip.term_intended = true;
                        CSL.UPDATE_GROUP_CONTEXT_CONDITION(state, this.strings.value, true);
                        state.output.append(this.strings.value, this);
                    };
                    this.execs.push(func);
                }
            }
            target.push(this);
            CSL.Util.substituteEnd.call(this, state, target);
        }
    }
};
module.exports = CSL;
CSL.Attributes = {};
CSL.Attributes["@genre"] = function (state, arg) {
    arg = arg.replace("-", " ");
    var func = function (Item, item) {
        var ret;
        if (arg === Item.genre) {
            return true;
        }
        return false;
    }
    this.tests.push(func);
}
CSL.Attributes["@disambiguate"] = function (state, arg) {
    if (arg === "true") {
        state.opt.has_disambiguate = true;
        var func = function (Item, item) {
            state.tmp.disambiguate_maxMax += 1;
            if (state.tmp.disambig_settings.disambiguate
                && state.tmp.disambiguate_count < state.tmp.disambig_settings.disambiguate) {
                state.tmp.disambiguate_count += 1;
                return true;
            }
            return false;
        };
        this.tests.push(func);
    } else if (arg === "check-ambiguity-and-backreference") {
        var func = function (Item, item) {
            if (state.registry.registry[Item.id].disambig.disambiguate && state.registry.registry[Item.id]["citation-count"] > 1) {
                return true;
            }
            return false;
        };
        this.tests.push(func);
    }
};
CSL.Attributes["@is-numeric"] = function (state, arg, joiner) {
    var variables = arg.split(/\s+/);
    var maketest = function(variable) {
        return function (Item, item) {
            var myitem = Item;
            if (["locator","locator-extra"].indexOf(variable) > -1) {
                myitem = item;
            }
            if ("undefined" === typeof myitem) {
                return false;
            }
            if (CSL.NUMERIC_VARIABLES.indexOf(variable) > -1) {
                if (!state.tmp.shadow_numbers[variable]) {
                    state.processNumber(false, myitem, variable, Item.type);
                }
                if (myitem[variable] && state.tmp.shadow_numbers[variable].numeric) {
                    return true;
                }
            } else if (["title", "locator-extra","version"].indexOf(variable) > -1) {
                if (myitem[variable]) {
                    if (myitem[variable].slice(-1) === "" + parseInt(myitem[variable].slice(-1), 10)) {
                        return true;
                    }
                }
            }
            return false;
        }
    }
    for (var i=0; i<variables.length; i+=1) {
        this.tests.push(maketest(variables[i]));
    }
};
CSL.Attributes["@is-uncertain-date"] = function (state, arg) {
    var variables = arg.split(/\s+/);
    var maketest = function (myvariable) {
        return function(Item, item) {
            if (Item[myvariable] && Item[myvariable].circa) {
                return true;
            } else {
                return false;
            }
        }
    }
    for (var i=0,ilen=variables.length;i<ilen;i+=1) {
        this.tests.push(maketest(variables[i]));
    };
};
CSL.Attributes["@locator"] = function (state, arg) {
    var trylabels = arg.replace("sub verbo", "sub-verbo");
    trylabels = trylabels.split(/\s+/);
    var maketest = function (trylabel) {
        return function(Item, item) {
            var label;
            state.processNumber(false, item, "locator");
            label = state.tmp.shadow_numbers.locator.label;
            if (trylabel === label) {
                return true;
            } else {
                return false;
            }
        }
    }
    for (var i=0,ilen=trylabels.length;i<ilen;i+=1) {
        this.tests.push(maketest(trylabels[i]));
    }
};
CSL.Attributes["@position"] = function (state, arg) {
    var tryposition;
    state.opt.update_mode = CSL.POSITION;
    state.parallel.use_parallels = null;
    var trypositions = arg.split(/\s+/);
    var maketest = function(tryposition) {
        return function (Item, item) {
            if (state.tmp.area === "bibliography") {
                return false;
            }
            if (item && "undefined" === typeof item.position) {
                item.position = 0;
            }
            if (item && typeof item.position === "number") {
                if (item.position === 0 && tryposition === 0) {
                    return true;
                } else if (tryposition > 0 && item.position >= tryposition) {
                    return true;
                }
            } else if (tryposition === 0) {
                return true;
            }
            return false;
        }
    }
    for (var i=0,ilen=trypositions.length;i<ilen;i+=1) {
        var tryposition = trypositions[i];
        if (tryposition === "first") {
            tryposition = CSL.POSITION_FIRST;
        } else if (tryposition === "subsequent") {
            tryposition = CSL.POSITION_SUBSEQUENT;
        } else if (tryposition === "ibid") {
            tryposition = CSL.POSITION_IBID;
        } else if (tryposition === "ibid-with-locator") {
            tryposition = CSL.POSITION_IBID_WITH_LOCATOR;
        }
        if ("near-note" === tryposition) {
            this.tests.push(function (Item, item) {
                if (item && item.position >= CSL.POSITION_SUBSEQUENT && item["near-note"]) {
                    return true;
                }
                return false;
            });
        } else if ("far-note" === tryposition) {
            this.tests.push(function (Item, item) {
                if (item && item.position == CSL.POSITION_SUBSEQUENT && !item["near-note"]) {
                    return true;
                }
                return false;
            });
        } else {
            this.tests.push(maketest(tryposition));
        }
    }
};
CSL.Attributes["@type"] = function (state, arg) {
    var types = arg.split(/\s+/);
    var maketest = function (mytype) {
        return function(Item,item) {
            var ret = (Item.type === mytype);
            if (ret) {
                return true;
            } else {
                return false;
            }
        }
    }
    var tests = [];
    for (var i=0,ilen=types.length;i<ilen;i+=1) {
        tests.push(maketest(types[i]));
    }
    this.tests.push(state.fun.match.any(this, state, tests));
};
CSL.Attributes["@variable"] = function (state, arg) {
    var func;
    this.variables = arg.split(/\s+/);
    this.variables_real = this.variables.slice();
    if ("label" === this.name && this.variables[0]) {
        this.strings.term = this.variables[0];
    } else if (["names", "date", "text", "number"].indexOf(this.name) > -1) {
        func = function (state, Item, item) {
            for (var i = this.variables.length - 1; i > -1; i += -1) {
                this.variables.pop();
            }
            for (var i=0,ilen=this.variables_real.length;i<ilen;i++) {
                if (state.tmp.done_vars.indexOf(this.variables_real[i]) === -1 
                    && !(item && Item.type === "legal_case" && item["suppress-author"] && this.variables_real[i] === "title")
                   ) {
                    this.variables.push(this.variables_real[i]);
                }
                if (state.tmp.can_block_substitute) {
                    state.tmp.done_vars.push(this.variables_real[i]);
                }
            }
        };
        this.execs.push(func);
        func = function (state, Item, item) {
            var mydate;
            var output = false;
            for (var i=0,ilen=this.variables.length;i<ilen;i++) {
                var variable = this.variables[i];
                if (["authority", "committee"].indexOf(variable) > -1
                    && "string" === typeof Item[variable]
                    && "names" === this.name) {
                    var creatorParents = [];
                    var isValid = true;
                    var rawNames = Item[variable].split(/\s*;\s*/);
                    var rawMultiNames = {};
                    if (Item.multi && Item.multi._keys[variable]) {
                        for (var langTag in Item.multi._keys[variable]) {
                            rawMultiNames[langTag] = Item.multi._keys[variable][langTag].split(/\s*;\s*/);
                            if (rawMultiNames[langTag].length !== rawNames.length) {
                                isValid = false;
                                break;
                            }
                        }
                    }
                    if (!isValid) {
                        rawNames = [Item[variable]];
                        rawMultiNames = Item.multi._keys[variable];
                    }
                    for (var j = 0, jlen = rawNames.length; j < jlen; j++) {
                        var creatorParent = {
                            literal:rawNames[j],
                            multi:{
                                _key:{}
                            }
                        };
                        for (var langTag in rawMultiNames) {
                            var creatorChild = {
                                literal:rawMultiNames[langTag][j]
                            }
                            creatorParent.multi._key[langTag] = creatorChild;
                        }
                        rawNames[j] = creatorParent;
                    }
                    Item[variable] = rawNames;
                }
                if (this.strings.form === "short" && !Item[variable]) {
                    if (variable === "title") {
                        variable = "title-short";
                    } else if (variable === "container-title") {
                        variable = "journalAbbreviation";
                    }
                }
                if (variable === "year-suffix") {
                    output = true;
                    break;
                } else if (CSL.DATE_VARIABLES.indexOf(variable) > -1) {
                    if (state.opt.development_extensions.locator_date_and_revision && "locator-date" === variable) {
                        output = true;
                        break;
                    }
                    if (Item[variable]) {
                        for (var key in Item[variable]) {
                            if (this.dateparts.indexOf(key) === -1 && "literal" !== key) {
                                continue;
                            }
                            if (Item[variable][key]) {
                                output = true;
                                break;
                            }
                        }
                        if (output) {
                            break;
                        }
                    }
                } else if ("locator" === variable) {
                    if (item && item.locator) {
                        output = true;
                    }
                    break;
                } else if ("locator-extra" === variable) {
                    if (item && item["locator-extra"]) {
                        output = true;
                    }
                    break;
                } else if (["citation-number","citation-label"].indexOf(variable) > -1) {
                    output = true;
                    break;
                } else if ("first-reference-note-number" === variable) {
                    if (item && item["first-reference-note-number"]) {
                        output = true;
                    }
                    break;
                } else if ("hereinafter" === variable) {
                    if (state.transform.abbrevs["default"].hereinafter[Item.id]
                        && state.sys.getAbbreviation
                        && Item.id) {
                        output = true;
                    }
                    break;
                } else if ("object" === typeof Item[variable]) {
                    if (Item[variable].length) {
                    }
                    break;
                } else if ("string" === typeof Item[variable] && Item[variable]) {
                    output = true;
                    break;
                } else if ("number" === typeof Item[variable]) {
                    output = true;
                    break;
                }
                if (output) {
                    break;
                }
            }
            if (output) {
                for (var i=0,ilen=this.variables_real.length;i<ilen;i++) {
                    var variable = this.variables_real[i];
                    if (variable !== "citation-number" || state.tmp.area !== "bibliography") {
                        state.tmp.cite_renders_content = true;
                    }
                    state.tmp.group_context.tip.variable_success = true;
                    if (state.tmp.can_substitute.value() 
                        && state.tmp.area === "bibliography"
                        && "string" === typeof Item[variable]) {
                        state.tmp.name_node.top = state.output.current.value();
                        state.tmp.rendered_name.push(Item[variable]);
                    }
                }
                state.tmp.can_substitute.replace(false,  CSL.LITERAL);
            } else {
                state.tmp.group_context.tip.variable_attempt = true;
            }
        };
        this.execs.push(func);
    } else if (["if",  "else-if", "condition"].indexOf(this.name) > -1) {
        var maketest = function (variable) {
            return function(Item,item){
                var myitem = Item;
                if (item && ["locator", "locator-extra", "first-reference-note-number", "locator-date"].indexOf(variable) > -1) {
                    myitem = item;
                }
                if (variable === "hereinafter" && state.sys.getAbbreviation && myitem.id) {
                    if (state.transform.abbrevs["default"].hereinafter[myitem.id]) {
                        return true;
                    }
                } else if (myitem[variable]) {
                    if ("number" === typeof myitem[variable] || "string" === typeof myitem[variable]) {
                        return true;
                    } else if ("object" === typeof myitem[variable]) {
                        for (var key in myitem[variable]) {
                            if (myitem[variable][key]) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }
        }
        for (var i=0,ilen=this.variables.length;i<ilen;i+=1) {
            this.tests.push(maketest(this.variables[i]));
        }
    }
};
CSL.Attributes["@page"] = function (state, arg) {
    var trylabels = arg.replace("sub verbo", "sub-verbo");
    trylabels = trylabels.split(/\s+/);
    var maketest = function (trylabel) {
        return function(Item, item) {
            var label;
            state.processNumber(false, Item, "page", Item.type);
            if (!state.tmp.shadow_numbers.page.label) {
                label = "page";
            } else if (state.tmp.shadow_numbers.page.label === "sub verbo") {
                label = "sub-verbo";
            } else {
                label = state.tmp.shadow_numbers.page.label;
            }
            if (trylabel === label) {
                return true;
            } else {
                return false;
            }
        }
    }
    for (var i=0,ilen=trylabels.length;i<ilen;i+=1) {
        this.tests.push(maketest(trylabels[i]));
    }
};
CSL.Attributes["@number"] = function (state, arg) {
    var trylabels = arg.replace("sub verbo", "sub-verbo");
    trylabels = trylabels.split(/\s+/);
    var maketest = function(trylabel) {
        return function (Item, item) {
            var label;
            state.processNumber(false, Item, "number", Item.type);
            if (!state.tmp.shadow_numbers.number.label) {
                label = "number";
            } else if (state.tmp.shadow_numbers.number.label === "sub verbo") {
                label = "sub-verbo";
            } else {
                label = state.tmp.shadow_numbers.number.label;
            }
            if (trylabel === label) {
                return true;
            } else {
                return false;
            }
        }
    }
    for (var i=0,ilen=trylabels.length;i<ilen;i+=1) {
        this.tests.push(maketest(trylabels[i]));
    }
};
CSL.Attributes["@jurisdiction"] = function (state, arg) {
    var tryjurisdictions = arg.split(/\s+/);
    for (var i=0,ilen=tryjurisdictions.length;i<ilen;i+=1) {
        tryjurisdictions[i] = tryjurisdictions[i].split(":");
    }
    var maketests = function (tryjurisdiction) {
        return function(Item,item){
            if (!Item.jurisdiction) {
                return false;
            }
            var jurisdictions = Item.jurisdiction.split(":");
            for (var i=0,ilen=jurisdictions.length;i<ilen;i+=1) {
                jurisdictions[i] = jurisdictions[i].split(":");
            }
            for (i=tryjurisdiction.length;i>0;i+=-1) {
                var tryjurisdictionStr = tryjurisdiction.slice(0,i).join(":");
                var jurisdiction = jurisdictions.slice(0,i).join(":");
                if (tryjurisdictionStr !== jurisdiction) {
                    return false;
                }
            }
            return true;
        }
    }
    for (var i=0,ilen=tryjurisdictions.length;i<ilen;i+=1) {
        var tryjurisdictionSlice = tryjurisdictions[i].slice();
        this.tests.push(maketests(tryjurisdictionSlice));
    }
};
CSL.Attributes["@context"] = function (state, arg) {
    var func = function (Item, item) {
		var area = state.tmp.area.slice(0, arg.length);
		if (area === arg) {
			return true;
		}
		return false;
    };
    this.tests.push(func);
};
CSL.Attributes["@has-year-only"] = function (state, arg) {
    var trydates = arg.split(/\s+/);
    var maketest = function (trydate) {
        return function(Item,item){
            var date = Item[trydate];
            if (!date || date.month || date.season) {
                return false;
            } else {
                return true;
            }
        }
    }
    for (var i=0,ilen=trydates.length;i<ilen;i+=1) {
        this.tests.push(maketest(trydates[i]));
    }
};
CSL.Attributes["@has-to-month-or-season"] = function (state, arg) {
    var trydates = arg.split(/\s+/);
    var maketest = function (trydate) {
        return function(Item,item){
            var date = Item[trydate];
            if (!date || (!date.month && !date.season) || date.day) {
                return false;
            } else {
                return true;
            }
        }
    }
    for (var i=0,ilen=trydates.length;i<ilen;i+=1) {
        this.tests.push(maketest(trydates[i]));
    }
};
CSL.Attributes["@has-day"] = function (state, arg) {
    var trydates = arg.split(/\s+/);
    var maketest = function (trydate) {
        return function(Item,item){
            var date = Item[trydate];
            if (!date || !date.day) {
                return false;
            } else {
                return true;
            }
        }
    }
    for (var i=0,ilen=trydates.length;i<ilen;i+=1) {
        this.tests.push(maketest(trydates[i]));
    };
};
CSL.Attributes["@subjurisdictions"] = function (state, arg) {
    var trysubjurisdictions = parseInt(arg, 10);
    var func = function (Item, item) {
        var subjurisdictions = 0;
        if (Item.jurisdiction) {
            subjurisdictions = Item.jurisdiction.split(":").length;
        }
        if (subjurisdictions) {
            subjurisdictions += -1;
        }
        if (subjurisdictions >= trysubjurisdictions) {
            return true;
        }
        return false;
    };
    this.tests.push(func);
};
CSL.Attributes["@is-plural"] = function (state, arg) {
    var func = function (Item, item) {
        var nameList = Item[arg];
        if (nameList && nameList.length) {
            var persons = 0;
            var institutions = 0;
            var last_is_person = false;
            for (var i = 0, ilen = nameList.length; i < ilen; i += 1) {
                if (state.opt.development_extensions.spoof_institutional_affiliations
                    && (nameList[i].literal || (nameList[i].isInstitution && nameList[i].family && !nameList[i].given))) {
                    institutions += 1;
                    last_is_person = false;
                } else {
                    persons += 1;
                    last_is_person = true;
                }
            }
            if (persons > 1) {
                return true;
            } else if (institutions > 1) {
                return true;
            } else if (institutions && last_is_person) {
                return true;
            }
        }
        return false;
    };
    this.tests.push(func);
};
CSL.Attributes["@locale"] = function (state, arg) {
    var func, ret, len, pos, variable, myitem, langspec, lang, lst, i, ilen, fallback;
    var locale_default = state.opt["default-locale"][0];
    if (this.name === "layout") {
        this.locale_raw = arg;
        if (this.tokentype === CSL.START) {
            var locales = arg.split(/\s+/);
            var sort_locale = {};
            var localeMaster = CSL.localeResolve(locales[0], locale_default);
            if (localeMaster.generic) {
                sort_locale[localeMaster.generic] = localeMaster.best;
            } else {
                sort_locale[localeMaster.best] = localeMaster.best;
            }
            for (var i=1,ilen=locales.length;i<ilen;i+=1) {
                var localeServant = CSL.localeResolve(locales[i], locale_default);
                if (localeServant.generic) {
                    sort_locale[localeServant.generic] = localeMaster.best;
                } else {
                    sort_locale[localeServant.best] = localeMaster.best;
                }
            }
            state[state.build.area].opt.sort_locales.push(sort_locale);
        }
        state.opt.has_layout_locale = true;
    } else {
        lst = arg.split(/\s+/);
        var locale_bares = [];
        for (i = 0, ilen = lst.length; i < ilen; i += 1) {
            lang = lst[i];
            langspec = CSL.localeResolve(lang, locale_default);
            if (lst[i].length === 2) {
                locale_bares.push(langspec.bare);
            }
            state.localeConfigure(langspec, true);
            lst[i] = langspec;
        }
        var locale_list = lst.slice();
        var maketest = function (locale_list, locale_default,locale_bares) {
            return function (Item, item) {
                var key, res;
                ret = [];
                res = false;
                var langspec = false;
                var lang;
                if (!Item.language) {
                    lang = locale_default;
                } else {
                    lang = Item.language;
                }
                langspec = CSL.localeResolve(lang, locale_default);
                for (i = 0, ilen = locale_list.length; i < ilen; i += 1) {
                    if (langspec.best === locale_list[i].best) {
                        res = true;
                        break;
                    }
                }
                if (!res && locale_bares.indexOf(langspec.bare) > -1) {
                    res = true;
                }
                return res;
            }
        }
        this.tests.push(maketest(locale_list,locale_default,locale_bares));
    }
};
CSL.Attributes["@authority-residue"] = function (state, arg) {
    var maketest = function () {
        var succeed = (arg === "true") ? true : false;
        return function(Item, item) {
            if (!Item.authority || !Item.authority[0] || !Item.authority[0].family) return !succeed;
            var varLen = Item.authority[0].family.split("|").length;
            var stopLast = state.tmp.authority_stop_last;
            if ((varLen + stopLast) > 0) {
                return succeed;
            } else {
                return !succeed;
            }
        }
    }
    this.tests.push(maketest());
}
CSL.Attributes["@locale-internal"] = function (state, arg) {
    var func, ret, len, pos, variable, myitem, langspec, lang, lst, i, ilen, fallback;
        lst = arg.split(/\s+/);
        this.locale_bares = [];
        for (i = 0, ilen = lst.length; i < ilen; i += 1) {
            lang = lst[i];
            langspec = CSL.localeResolve(lang, state.opt["default-locale"][0]);
            if (lst[i].length === 2) {
                this.locale_bares.push(langspec.bare);
            }
            state.localeConfigure(langspec);
            lst[i] = langspec;
        }
        this.locale_default = state.opt["default-locale"][0];
        this.locale = lst[0].best;
        this.locale_list = lst.slice();
        var maketest = function (me) {
            return function (Item, item) {
                var key, res;
                ret = [];
                res = false;
                var langspec = false;
                if (Item.language) {
                    lang = Item.language;
                    langspec = CSL.localeResolve(lang, state.opt["default-locale"][0]);
                    if (langspec.best === state.opt["default-locale"][0]) {
                        langspec = false;
                    }
                }
                if (langspec) {
                    for (i = 0, ilen = me.locale_list.length; i < ilen; i += 1) {
                        if (langspec.best === me.locale_list[i].best) {
                            state.opt.lang = me.locale;
                            state.tmp.last_cite_locale = me.locale;
                            state.output.openLevel("empty");
                            state.output.current.value().new_locale = me.locale;
                            res = true;
                            break;
                        }
                    }
                    if (!res && me.locale_bares.indexOf(langspec.bare) > -1) {
                        state.opt.lang = me.locale;
                        state.tmp.last_cite_locale = me.locale;
                        state.output.openLevel("empty");
                        state.output.current.value().new_locale = me.locale;
                        res = true;
                    }
                }
                return res;
            }
        }
        var me = this;
        this.tests.push(maketest(me));
}
CSL.Attributes["@is-parallel"] = function (state, arg) {
    var values = arg.split(" ");
    for (var i = 0, ilen = values.length; i < ilen; i += 1) {
        if (values[i] === "true") {
            values[i] = true;
        } else if (values[i] === "false") {
            values[i] = false;
        }
    }
    this.strings.set_parallel_condition = values;
};
CSL.Attributes["@jurisdiction-depth"] = function (state, arg) {
    this.strings.jurisdiction_depth = parseInt(arg, 10);
};
CSL.Attributes["@require"] = function (state, arg) {
    this.strings.require = arg;
}
CSL.Attributes["@reject"] = function (state, arg) {
    this.strings.reject = arg;
}
CSL.Attributes["@gender"] = function (state, arg) {
    this.gender = arg;
}
CSL.Attributes["@cslid"] = function (state, arg) {
    this.cslid = parseInt(arg, 10);
};
CSL.Attributes["@label-form"] = function (state, arg) {
    this.strings.label_form_override = arg;
};
CSL.Attributes["@part-separator"] = function (state, arg) {
    this.strings["part-separator"] = arg;
};
CSL.Attributes["@leading-noise-words"] = function (state, arg) {
    this["leading-noise-words"] = arg;
};
CSL.Attributes["@name-never-short"] = function (state, arg) {
    this["name-never-short"] = arg;
};
CSL.Attributes["@class"] = function (state, arg) {
    state.opt["class"] = arg;
};
CSL.Attributes["@version"] = function (state, arg) {
    state.opt.version = arg;
};
CSL.Attributes["@value"] = function (state, arg) {
    this.strings.value = arg;
};
CSL.Attributes["@name"] = function (state, arg) {
    this.strings.name = arg;
};
CSL.Attributes["@form"] = function (state, arg) {
    this.strings.form = arg;
};
CSL.Attributes["@date-parts"] = function (state, arg) {
    this.strings["date-parts"] = arg;
};
CSL.Attributes["@range-delimiter"] = function (state, arg) {
    this.strings["range-delimiter"] = arg;
};
CSL.Attributes["@macro"] = function (state, arg) {
    this.postponed_macro = arg;
};
CSL.Attributes["@term"] = function (state, arg) {
    if (arg === "sub verbo") {
        this.strings.term = "sub-verbo";
    } else {
        this.strings.term = arg;
    }
};
CSL.Attributes["@xmlns"] = function (state, arg) {};
CSL.Attributes["@lang"] = function (state, arg) {
    if (arg) {
        state.build.lang = arg;
    }
};
CSL.Attributes["@lingo"] = function (state, arg) {
};
CSL.Attributes["@macro-has-date"] = function (state, arg) {
    this["macro-has-date"] = true;
};
CSL.Attributes["@suffix"] = function (state, arg) {
    this.strings.suffix = arg;
};
CSL.Attributes["@prefix"] = function (state, arg) {
    this.strings.prefix = arg;
};
CSL.Attributes["@delimiter"] = function (state, arg) {
    this.strings.delimiter = arg;
};
CSL.Attributes["@match"] = function (state, arg) {
    this.match = arg;
};
CSL.Attributes["@names-min"] = function (state, arg) {
    var val = parseInt(arg, 10);
    if (state[state.build.area].opt.max_number_of_names < val) {
        state[state.build.area].opt.max_number_of_names = val;
    }
    this.strings["et-al-min"] = val;
};
CSL.Attributes["@names-use-first"] = function (state, arg) {
    this.strings["et-al-use-first"] = parseInt(arg, 10);
};
CSL.Attributes["@names-use-last"] = function (state, arg) {
    if (arg === "true") {
        this.strings["et-al-use-last"] = true;
    } else {
        this.strings["et-al-use-last"] = false;
    }
};
CSL.Attributes["@sort"] = function (state, arg) {
    if (arg === "descending") {
        this.strings.sort_direction = CSL.DESCENDING;
    }
};
CSL.Attributes["@plural"] = function (state, arg) {
    if ("always" === arg || "true" === arg) {
        this.strings.plural = 1;
    } else if ("never" === arg || "false" === arg) {
        this.strings.plural = 0;
    } else if ("contextual" === arg) {
        this.strings.plural = false;
    }
};
CSL.Attributes["@has-publisher-and-publisher-place"] = function (state, arg) {
    this.strings["has-publisher-and-publisher-place"] = true;
};
CSL.Attributes["@publisher-delimiter-precedes-last"] = function (state, arg) {
    this.strings["publisher-delimiter-precedes-last"] = arg;
};
CSL.Attributes["@publisher-delimiter"] = function (state, arg) {
    this.strings["publisher-delimiter"] = arg;
};
CSL.Attributes["@publisher-and"] = function (state, arg) {
    this.strings["publisher-and"] = arg;
};
CSL.Attributes["@newdate"] = function (state, arg) {
};
CSL.Attributes["@givenname-disambiguation-rule"] = function (state, arg) {
    if (CSL.GIVENNAME_DISAMBIGUATION_RULES.indexOf(arg) > -1) {
        state.citation.opt["givenname-disambiguation-rule"] = arg;
    }
};
CSL.Attributes["@collapse"] = function (state, arg) {
    if (arg) {
        state[this.name].opt.collapse = arg;
    }
};
CSL.Attributes["@cite-group-delimiter"] = function (state, arg) {
    if (arg) {
        state[state.tmp.area].opt.cite_group_delimiter = arg;
    }
};
CSL.Attributes["@names-delimiter"] = function (state, arg) {
    state.setOpt(this, "names-delimiter", arg);
};
CSL.Attributes["@name-form"] = function (state, arg) {
    state.setOpt(this, "name-form", arg);
};
CSL.Attributes["@subgroup-delimiter"] = function (state, arg) {
    this.strings["subgroup-delimiter"] = arg;
};
CSL.Attributes["@subgroup-delimiter-precedes-last"] = function (state, arg) {
    this.strings["subgroup-delimiter-precedes-last"] = arg;
};
CSL.Attributes["@name-delimiter"] = function (state, arg) {
    state.setOpt(this, "name-delimiter", arg);
};
CSL.Attributes["@et-al-min"] = function (state, arg) {
    var val = parseInt(arg, 10);
    if (state[state.build.area].opt.max_number_of_names < val) {
        state[state.build.area].opt.max_number_of_names = val;
    }
    state.setOpt(this, "et-al-min", val);
};
CSL.Attributes["@et-al-use-first"] = function (state, arg) {
    state.setOpt(this, "et-al-use-first", parseInt(arg, 10));
};
CSL.Attributes["@et-al-use-last"] = function (state, arg) {
    if (arg === "true") {
        state.setOpt(this, "et-al-use-last", true);
    } else {
        state.setOpt(this, "et-al-use-last", false);
    }
};
CSL.Attributes["@et-al-subsequent-min"] = function (state, arg) {
    var val = parseInt(arg, 10);
    if (state[state.build.area].opt.max_number_of_names < val) {
        state[state.build.area].opt.max_number_of_names = val;
    }
    state.setOpt(this, "et-al-subsequent-min", val);
};
CSL.Attributes["@et-al-subsequent-use-first"] = function (state, arg) {
    state.setOpt(this, "et-al-subsequent-use-first", parseInt(arg, 10));
};
CSL.Attributes["@suppress-min"] = function (state, arg) {
    this.strings["suppress-min"] = parseInt(arg, 10);
};
CSL.Attributes["@suppress-max"] = function (state, arg) {
    this.strings["suppress-max"] = parseInt(arg, 10);
};
CSL.Attributes["@and"] = function (state, arg) {
    state.setOpt(this, "and", arg);
};
CSL.Attributes["@delimiter-precedes-last"] = function (state, arg) {
    state.setOpt(this, "delimiter-precedes-last", arg);
};
CSL.Attributes["@delimiter-precedes-et-al"] = function (state, arg) {
    state.setOpt(this, "delimiter-precedes-et-al", arg);
};
CSL.Attributes["@initialize-with"] = function (state, arg) {
    state.setOpt(this, "initialize-with", arg);
};
CSL.Attributes["@initialize"] = function (state, arg) {
    if (arg === "false") {
        state.setOpt(this, "initialize", false);
    }
};
CSL.Attributes["@name-as-reverse-order"] = function (state, arg) {
    this["name-as-reverse-order"] = arg;
};
CSL.Attributes["@name-as-sort-order"] = function (state, arg) {
    if (this.name === "style-options") {
        this["name-as-sort-order"] = arg;
    } else {
        state.setOpt(this, "name-as-sort-order", arg);
    }
};
CSL.Attributes["@sort-separator"] = function (state, arg) {
    state.setOpt(this, "sort-separator", arg);
};
CSL.Attributes["@year-suffix-delimiter"] = function (state, arg) {
    state[this.name].opt["year-suffix-delimiter"] = arg;
};
CSL.Attributes["@after-collapse-delimiter"] = function (state, arg) {
    state[this.name].opt["after-collapse-delimiter"] = arg;
};
CSL.Attributes["@subsequent-author-substitute"] = function (state, arg) {
    state[this.name].opt["subsequent-author-substitute"] = arg;
};
CSL.Attributes["@subsequent-author-substitute-rule"] = function (state, arg) {
    state[this.name].opt["subsequent-author-substitute-rule"] = arg;
};
CSL.Attributes["@disambiguate-add-names"] = function (state, arg) {
    if (arg === "true") {
        state.opt["disambiguate-add-names"] = true;
    }
};
CSL.Attributes["@disambiguate-add-givenname"] = function (state, arg) {
    if (arg === "true") {
        state.opt["disambiguate-add-givenname"] = true;
    }
};
CSL.Attributes["@disambiguate-add-year-suffix"] = function (state, arg) {
    if (arg === "true" && state.opt.xclass !== "numeric") {
        state.opt["disambiguate-add-year-suffix"] = true;
    }
};
CSL.Attributes["@second-field-align"] = function (state, arg) {
    if (arg === "flush" || arg === "margin") {
        state[this.name].opt["second-field-align"] = arg;
    }
};
CSL.Attributes["@hanging-indent"] = function (state, arg) {
    if (arg === "true") {
        state[this.name].opt.hangingindent = 2;
    }
};
CSL.Attributes["@line-spacing"] = function (state, arg) {
    if (arg && arg.match(/^[.0-9]+$/)) {
        state[this.name].opt["line-spacing"] = parseFloat(arg, 10);
    }
};
CSL.Attributes["@entry-spacing"] = function (state, arg) {
    if (arg && arg.match(/^[.0-9]+$/)) {
        state[this.name].opt["entry-spacing"] = parseFloat(arg, 10);
    }
};
CSL.Attributes["@near-note-distance"] = function (state, arg) {
    state[this.name].opt["near-note-distance"] = parseInt(arg, 10);
};
CSL.Attributes["@text-case"] = function (state, arg) {
    var func = function (state, Item) {
        if (arg === "normal") {
            this.text_case_normal = true;
        } else {
            this.strings["text-case"] = arg;
            if (arg === "title") {
                var m = false;
                var default_locale = state.opt["default-locale"][0].slice(0, 2);
                if (Item.jurisdiction) {
                    this.strings["text-case"] = "passthrough";
                }
            }
        }
    };
    this.execs.push(func);
};
CSL.Attributes["@page-range-format"] = function (state, arg) {
    state.opt["page-range-format"] = arg;
};
CSL.Attributes["@year-range-format"] = function (state, arg) {
    state.opt["year-range-format"] = arg;
};
CSL.Attributes["@default-locale"] = function (state, arg) {
    if (this.name === 'style') {
        var lst, len, pos, m, ret;
        var m = arg.match(/-x-(sort|translit|translat)-/g);
        if (m) {
            for (pos = 0, len = m.length; pos < len; pos += 1) {
                m[pos] = m[pos].replace(/^-x-/, "").replace(/-$/, "");
            }
        }
        lst = arg.split(/-x-(?:sort|translit|translat)-/);
        ret = [lst[0]];
        for (pos = 1, len = lst.length; pos < len; pos += 1) {
            ret.push(m[pos - 1]);
            ret.push(lst[pos]);
        }
        lst = ret.slice();
        len = lst.length;
        for (pos = 1; pos < len; pos += 2) {
            state.opt[("locale-" + lst[pos])].push(lst[(pos + 1)].replace(/^\s*/g, "").replace(/\s*$/g, ""));
        }
        if (lst.length) {
            state.opt["default-locale"] = lst.slice(0, 1);
        } else {
            state.opt["default-locale"] = ["en"];
        }
    } else if (arg === "true") {
        this.default_locale = true;
    }
};
CSL.Attributes["@default-locale-sort"] = function (state, arg) {
    var lst, len, pos, m, ret;
    state.opt["default-locale-sort"] = arg;
};
CSL.Attributes["@demote-non-dropping-particle"] = function (state, arg) {
    state.opt["demote-non-dropping-particle"] = arg;
};
CSL.Attributes["@initialize-with-hyphen"] = function (state, arg) {
    if (arg === "false") {
        state.opt["initialize-with-hyphen"] = false;
    }
};
CSL.Attributes["@institution-parts"] = function (state, arg) {
    this.strings["institution-parts"] = arg;
};
CSL.Attributes["@if-short"] = function (state, arg) {
    if (arg === "true") {
        this.strings["if-short"] = true;
    }
};
CSL.Attributes["@substitute-use-first"] = function (state, arg) {
    this.strings["substitute-use-first"] = parseInt(arg, 10);
};
CSL.Attributes["@use-first"] = function (state, arg) {
    this.strings["use-first"] = parseInt(arg, 10);
};
CSL.Attributes["@stop-last"] = function (state, arg) {
    this.strings["stop-last"] = parseInt(arg, 10) * -1;
};
CSL.Attributes["@use-last"] = function (state, arg) {
    this.strings["use-last"] = parseInt(arg, 10);
};
CSL.Attributes["@reverse-order"] = function (state, arg) {
    if ("true" === arg) {
        this.strings["reverse-order"] = true;
    }
};
CSL.Attributes["@display"] = function (state, arg) {
    if (state.bibliography.tokens.length === 2) {
        state.opt.using_display = true;
    }
    this.strings.cls = arg;
};
module.exports = CSL;
CSL.Stack = function (val, literal) {
    this.mystack = [];
    if (literal || val) {
        this.mystack.push(val);
    }
    this.tip = this.mystack[0];
};
CSL.Stack.prototype.push = function (val, literal) {
    if (literal || val) {
        this.mystack.push(val);
    } else {
        this.mystack.push("");
    }
    this.tip = this.mystack[this.mystack.length - 1];
};
CSL.Stack.prototype.clear = function () {
    this.mystack = [];
    this.tip = {};
};
CSL.Stack.prototype.replace = function (val, literal) {
    if (this.mystack.length === 0) {
        throw "Internal CSL processor error: attempt to replace nonexistent stack item with " + val;
    }
    if (literal || val) {
        this.mystack[(this.mystack.length - 1)] = val;
    } else {
        this.mystack[(this.mystack.length - 1)] = "";
    }
    this.tip = this.mystack[this.mystack.length - 1];
};
CSL.Stack.prototype.pop = function () {
    var ret = this.mystack.pop();
    if (this.mystack.length) {
        this.tip = this.mystack[this.mystack.length - 1];
    } else {
        this.tip = {};
    }
    return ret;
};
CSL.Stack.prototype.value = function () {
    return this.mystack.slice(-1)[0];
};
CSL.Stack.prototype.length = function () {
    return this.mystack.length;
};
module.exports = CSL;
CSL.Parallel = function (state) {
    this.state = state;
    this.sets = new CSL.Stack([]);
    this.try_cite = true;
    this.use_parallels = false;
    this.midVars = ["section", "volume", "container-title", "collection-number", "issue", "page-first", "page", "number"];
    this.ignoreVarsLawGeneral = ["first-reference-note-number", "locator", "label","page-first","page","genre"];
    this.ignoreVarsLawProceduralHistory = ["issued", "first-reference-note-number", "locator", "label","page-first","page","genre","jurisdiction"];
    this.ignoreVarsOrders = ["first-reference-note-number"];
    this.ignoreVarsOther = ["first-reference-note-number", "locator", "label","section","page-first","page"];
};
CSL.Parallel.prototype.isMid = function (variable) {
    return (this.midVars.indexOf(variable) > -1);
};
CSL.Parallel.prototype.StartCitation = function (sortedItems, out) {
    this.parallel_conditional_blobs_list = [];
    if (this.use_parallels) {
        this.sortedItems = sortedItems;
        this.sortedItemsPos = -1;
        this.sets.clear();
        this.sets.push([]);
        this.in_series = true;
        this.delim_counter = 0;
        this.delim_pointers = [];
        if (out) {
            this.out = out;
        } else {
            this.out = this.state.output.queue;
        }
        this.master_was_neutral_cite = true;
    }
};
CSL.Parallel.prototype.StartCite = function (Item, item, prevItemID) {
    var position, len, pos, x, curr, master, last_id, prev_locator, curr_locator, is_master, parallel;
    if (this.use_parallels) {
        if (this.sets.value().length && this.sets.value()[0].itemId == Item.id) {
            this.ComposeSet();
        }
        this.sortedItemsPos += 1;
        if (item) {
            position = item.position;
        }
        this.try_cite = true;
        var has_required_var = false;
        for (var i = 0, ilen = CSL.PARALLEL_MATCH_VARS.length; i < ilen; i += 1) {
            if (Item[CSL.PARALLEL_MATCH_VARS[i]]) {
                has_required_var = true;
                break;
            }
        }
        var basics_ok = true;
        var last_cite = this.sets.value().slice(-1)[0];
        if (last_cite && last_cite.Item) {
            var lastJuris = last_cite.Item.jurisdiction ? last_cite.Item.jurisdiction.split(":")[0] : "";
            var thisJuris = Item.jurisdiction ? Item.jurisdiction.split(":")[0] : "";
            if (last_cite.Item.title !== Item.title) {
                basics_ok = false;
            } else if (lastJuris !== thisJuris) {
                basics_ok = false;
            } else if (last_cite.Item.type !== Item.type) {
                basics_ok = false;
            } else if (["article-journal","article-magazine"].indexOf(Item.type) > -1) {
                if (!this.state.opt.development_extensions.handle_parallel_articles
                   || last_cite.Item["container-title"] !== Item["container-title"]) {
                    basics_ok = false;
                }
            }
        }
        if (!basics_ok || !has_required_var || CSL.PARALLEL_TYPES.indexOf(Item.type) === -1) {
            this.try_cite = true;
            if (this.in_series) {
                this.in_series = false;
            }
        }
        this.cite = {};
        this.cite.front = [];
        this.cite.mid = [];
        this.cite.back = [];
        this.cite.front_collapse = {};
        this.cite.back_forceme = [];
        this.cite.position = position;
        this.cite.Item = Item;
        this.cite.itemId = "" + Item.id;
        this.cite.prevItemID = "" + prevItemID;
        this.target = "front";
        if (["treaty"].indexOf(Item.type) > -1) {
            this.ignoreVars = this.ignoreVarsOrders;
        } else if (["article-journal","article-magazine"].indexOf(Item.type) > -1) {
            this.ignoreVars = this.ignoreVarsOther;
        } else if (item && item.prefix) {
            this.ignoreVars = this.ignoreVarsLawProceduralHistory;
            this.cite.useProceduralHistory = true;
            var prev = this.sets.value()[(this.sets.value().length - 1)];
            if (prev && prev.back) {
                for (var i=prev.back.length-1;i>-1;i+=-1) {
                    if (prev.back[i] && prev[prev.back[i]]) {
                        delete prev[prev.back[i]];
                    }
                }
            }
        } else {
            this.ignoreVars = this.ignoreVarsLawGeneral;
        }
        if (this.sortedItems && this.sortedItemsPos > 0 && this.sortedItemsPos < this.sortedItems.length) {
            curr = this.sortedItems[this.sortedItemsPos][1];
            last_id = "" + this.sortedItems[(this.sortedItemsPos - 1)][1].id;
            master = this.state.registry.registry[last_id].parallel;
            prev_locator = false;
            if (master == curr.id) {
                len = this.sortedItemsPos - 1;
                for (pos = len; pos > -1; pos += -1) {
                    if (this.sortedItems[pos][1].id == Item.id) {
                        prev_locator = this.sortedItems[pos][1].locator;
                        break;
                    }
                }
                curr_locator = this.sortedItems[this.sortedItemsPos][1].locator;
                if (!prev_locator && curr_locator) {
                    curr.position = CSL.POSITION_IBID_WITH_LOCATOR;
                } else if (curr_locator === prev_locator) {
                    curr.position = CSL.POSITION_IBID;
                } else {
                    curr.position = CSL.POSITION_IBID_WITH_LOCATOR;
                }
            }
        } else if (this.state.registry.registry[Item.id]) {
            this.state.registry.registry[Item.id].parallel = false;
        } else {
            this.try_cite = false;
            this.force_collapse = false;
            return;
        }
        this.force_collapse = false;
        if (this.state.registry.registry[Item.id].parallel) {
            this.force_collapse = true;
        }
    }
};
CSL.Parallel.prototype.StartVariable = function (variable, real_variable) {
    if (this.use_parallels && (this.try_cite || this.force_collapse)) {
        if (variable === "names") {
            this.variable = variable + ":" + this.target;
        } else {
            this.variable = variable;
        }
        if (this.ignoreVars.indexOf(variable) > -1) {
            return;
        }
        if (variable === "container-title" && this.sets.value().length === 0) {
            this.master_was_neutral_cite = false;
        }
        this.data = {};
        this.data.value = "";
        this.data.blobs = [];
        var is_mid = this.isMid(variable);
        if (real_variable === "authority" && this.variable === "names:front" && this.sets.value().length) {
            var prev = this.sets.value()[(this.sets.value().length - 1)].Item;
            var thisAuthority = false;
            if (this.cite.Item.authority && this.cite.Item.authority.length) {
                thisAuthority = this.cite.Item.authority[0].literal;
            }
            var thatAuthority = false;
            if (prev.authority && prev.authority.length) {
                thatAuthority = prev.authority[0].literal;
            }
            if (thisAuthority !== thatAuthority) {
                this.try_cite = true;
                this.in_series = false;
            }
         } else if (this.target === "front" && is_mid) {
            this.target = "mid";
        } else if (this.target === "mid" && !is_mid && this.cite.Item.title && variable !== "names") {
            this.target = "back";
        } else if (this.target === "back" && is_mid) {
            this.try_cite = true;
            this.in_series = false;
        }
        if (variable === "number") {
            this.cite.front.push(this.variable);
        } else if (CSL.PARALLEL_COLLAPSING_MID_VARSET.indexOf(variable) > -1) {
            if (["article-journal","article-magazine"].indexOf(this.cite.Item.type) > -1) {
                this.cite.mid.push(this.variable);
            } else {
                this.cite.front.push(this.variable);
            }
        } else {
            this.cite[this.target].push(this.variable);
        }
   }
};
CSL.Parallel.prototype.AppendBlobPointer = function (blob) {
    if (this.use_parallels) {
        if (this.ignoreVars.indexOf(this.variable) > -1) {
            return;
        }
        if (this.use_parallels && (this.force_collapse || this.try_cite)) {
            if (["article-journal", "article-magazine"].indexOf(this.cite.Item.type) > -1) {
                if (["volume","page","page-first","issue"].indexOf(this.variable) > -1) {
                    return;
                }
                if ("container-title" === this.variable && this.cite.mid.length > 1) {
                    return;
                }
            }
            if (this.variable && (this.try_cite || this.force_collapse) && blob && blob.blobs) {
                if (!(this.cite.useProceduralHistory && this.target === "back")) {
                    this.data.blobs.push([blob, blob.blobs.length]);
                }
            }
        }
    }
};
CSL.Parallel.prototype.AppendToVariable = function (str, varname) {
    if (this.use_parallels) {
        if (this.ignoreVars.indexOf(this.variable) > -1) {
            return;
        }
        if (this.try_cite || this.force_collapse) {
            if (this.target !== "back" || true) {
                this.data.value += "::" + str;
            } else {
                var prev = this.sets.value()[(this.sets.value().length - 1)];
                if (prev) {
                    if (prev[this.variable]) {
                        if (prev[this.variable].value) {
                            this.data.value += "::" + str;
                        }
                    }
                }
            }
        }
    }
};
CSL.Parallel.prototype.CloseVariable = function () {
    if (this.use_parallels) {
        if (this.ignoreVars.indexOf(this.variable) > -1) {
            return;
        }
        if (this.try_cite || this.force_collapse) {
            this.cite[this.variable] = this.data;
            if (this.sets.value().length > 0) {
                var prev = this.sets.value()[(this.sets.value().length - 1)];
                if (this.target === "front" && this.variable === "issued") {
                    if (this.data.value && this.master_was_neutral_cite) {
                        this.target = "mid";
                    }
                }
                if (this.target === "front") {
                    if ((prev[this.variable] || this.data.value) && (!prev[this.variable] || this.data.value !== prev[this.variable].value)) {
                        if ("issued" !== this.variable) {
                            this.in_series = false;
                        }
                    }
                } else if (this.target === "mid") {
                    if (CSL.PARALLEL_COLLAPSING_MID_VARSET.indexOf(this.variable) > -1) {
                        if (prev[this.variable]) {
                            if (prev[this.variable].value === this.data.value) {
                                this.cite.front_collapse[this.variable] = true;
                            } else {
                                this.cite.front_collapse[this.variable] = false;
                            }
                        } else {
                            this.cite.front_collapse[this.variable] = false;
                        }
                    }
                } else if (this.target === "back") {
                    if (prev[this.variable]) {
                        if (this.data.value !== prev[this.variable].value 
                            && this.sets.value().slice(-1)[0].back_forceme.indexOf(this.variable) === -1) {
                            this.in_series = false;
                        }
                    }
                }
            }
        }
        this.variable = false;
    }
};
CSL.Parallel.prototype.CloseCite = function () {
    var x, pos, len, has_issued, use_journal_info, volume_pos, container_title_pos, section_pos;
    if (this.use_parallels && (this.force_collapse || this.try_cite)) {
        use_journal_info = false;
        if (!this.cite.front_collapse["container-title"]) {
            use_journal_info = true;
        }
        if (this.cite.front_collapse.volume === false) {
            use_journal_info = true;
        }
        if (this.cite.front_collapse["collection-number"] === false) {
            use_journal_info = true;
        }
        if (this.cite.front_collapse.section === false) {
            use_journal_info = true;
        }
        if (use_journal_info) {
            this.cite.use_journal_info = true;
            section_pos = this.cite.front.indexOf("section");
            if (section_pos > -1) {
                this.cite.front = this.cite.front.slice(0,section_pos).concat(this.cite.front.slice(section_pos + 1));
            }
            volume_pos = this.cite.front.indexOf("volume");
            if (volume_pos > -1) {
                this.cite.front = this.cite.front.slice(0,volume_pos).concat(this.cite.front.slice(volume_pos + 1));
            }
            container_title_pos = this.cite.front.indexOf("container-title");
            if (container_title_pos > -1) {
                this.cite.front = this.cite.front.slice(0,container_title_pos).concat(this.cite.front.slice(container_title_pos + 1));
            }
            var collection_number_pos = this.cite.front.indexOf("collection-number");
            if (collection_number_pos > -1) {
                this.cite.front = this.cite.front.slice(0,collection_number_pos).concat(this.cite.front.slice(collection_number_pos + 1));
            }
        }
        if (!this.in_series && !this.force_collapse) {
            this.ComposeSet(true);
        }
        if (this.sets.value().length === 0) {
            var has_date = false;
            for (pos = 0, len = this.cite.back.length; pos < len; pos += 1) {
                x = this.cite.back[pos];
                if (x === "issued" && this.cite["issued"] && this.cite["issued"].value) {
                    has_date = true;
                    break;
                }
            }
            if (!has_date) {
                this.cite.back_forceme.push("issued");
            }
        } else {
            var idx = this.cite.front.indexOf("issued");
            if (idx === -1 || this.master_was_neutral_cite) {
                this.cite.back_forceme = this.sets.value().slice(-1)[0].back_forceme;
            }
            if (idx > -1) {
                var prev = this.sets.value()[this.sets.value().length - 1];
                if (!prev["issued"]) {
                    this.cite.front = this.cite.front.slice(0, idx).concat(this.cite.front.slice(idx + 1));
                }
            }
            if (this.master_was_neutral_cite && this.cite.mid.indexOf("names:mid") > -1) {
                this.cite.front.push("names:mid");
            }
        }
        this.sets.value().push(this.cite);
    }
};
CSL.Parallel.prototype.ComposeSet = function (next_output_in_progress) {
    var cite, pos, master, len;
    if (this.use_parallels && (this.force_collapse || this.try_cite)) {
        var lengthCheck = this.sets.value().length;
        if (this.sets.value().length === 1) {
            if (!this.in_series) {
                this.sets.value().pop();
                this.delim_counter += 1;
            }
        } else {
            len = this.sets.value().length;
            for (pos = 0; pos < len; pos += 1) {
                cite = this.sets.value()[pos];
                if (pos === 0) {
                    this.delim_counter += 1;
                } else {
                    if (!cite.Item.title && cite.use_journal_info) {
                        this.delim_pointers.push(false);
                    } else {
                        this.delim_pointers.push(this.delim_counter);
                    }
                    this.delim_counter += 1;
                }
                if (CSL.POSITION_FIRST === cite.position) {
                    if (pos === 0) {
                        this.state.registry.registry[cite.itemId].master = true;
                        this.state.registry.registry[cite.itemId].siblings = [];
                        this.state.registry.registry[cite.itemId].parallel = false;
                    } else {
                        if (cite.prevItemID) {
                            if (!this.state.registry.registry[cite.prevItemID].parallel) {
                                this.state.registry.registry[cite.itemId].parallel = cite.prevItemID;
                            } else {
                                this.state.registry.registry[cite.itemId].parallel = this.state.registry.registry[cite.prevItemID].parallel;
                            }
                            this.state.registry.registry[cite.itemId].siblings = this.state.registry.registry[cite.prevItemID].siblings;
                            if (!this.state.registry.registry[cite.itemId].siblings) {
                                this.state.registry.registry[cite.itemId].siblings = [];
                                CSL.debug("WARNING: adding missing siblings array to registry object");
                            }
                            this.state.registry.registry[cite.itemId].siblings.push(cite.itemId);
                        }
                    }
                }
            }
            this.sets.push([]);
        }
        if (lengthCheck < 2) {
            this.purgeGroupsIfParallel(false);
        } else {
            this.purgeGroupsIfParallel(true);
        }
        this.in_series = true;
    }
};
CSL.Parallel.prototype.PruneOutputQueue = function () {
    var len, pos, series, ppos, llen, cite;
    if (this.use_parallels) {
        len = this.sets.mystack.length;
        for (pos = 0; pos < len; pos += 1) {
            series = this.sets.mystack[pos];
            if (series.length > 1) {
                llen = series.length;
                for (ppos = 0; ppos < llen; ppos += 1) {
                    cite = series[ppos];
                    if (ppos === 0) {
                        this.purgeVariableBlobs(cite, cite.back);
                    } else if (ppos === (series.length - 1)) {
                        this.purgeVariableBlobs(cite, cite.front.concat(cite.back_forceme));
                    } else {
                        this.purgeVariableBlobs(cite, cite.front.concat(cite.back));
                    }
                }
            }
        }
    }
};
CSL.Parallel.prototype.purgeVariableBlobs = function (cite, varnames) {
    var len, pos, varname, b, llen, ppos, out;
    if (this.use_parallels) {
        out = this.state.output.current.value();
        if ("undefined" === typeof out.length) {
            out = out.blobs;
        }
        for (pos = 0, len = this.delim_pointers.length; pos < len; pos += 1) {
            ppos = this.delim_pointers[pos];
            if (ppos !== false) {
                out[ppos].parallel_delimiter = ", ";
            }
        }
        len = varnames.length - 1;
        for (pos = len; pos > -1; pos += -1) {
            varname = varnames[pos];
            if (cite[varname]) {
                llen = cite[varname].blobs.length - 1;
                for (ppos = llen; ppos > -1; ppos += -1) {
                    b = cite[varname].blobs[ppos];
                    b[0].blobs = b[0].blobs.slice(0, b[1]).concat(b[0].blobs.slice((b[1] + 1)));
                    this.state.tmp.has_purged_parallel = true;
                    if (b[0] && b[0].strings && "string" == typeof b[0].strings.oops
                        && b[0].parent && b[0].parent) {
                        b[0].parent.parent.strings.delimiter = b[0].strings.oops;
                    }
                }
            }
        }
    }
};
CSL.Parallel.prototype.purgeGroupsIfParallel = function (original_condition) {
    for (var i = this.parallel_conditional_blobs_list.length - 1; i > -1; i += -1) {
        var obj = this.parallel_conditional_blobs_list[i];
        var purgeme = true;
        for (var j = 0, jlen = obj.conditions.length; j < jlen; j += 1) {
            if (!(!obj.conditions[j] === !!original_condition
                || ("master" === obj.conditions[j]
                    && !this.state.registry.registry[obj.id].master)
                || ("servant" === obj.conditions[j]
                    && !this.state.registry.registry[obj.id].parallel))) {
                var purgeme = false;
                break;
            }
        }
        if (purgeme) {
            var buffer = [];
            while (obj.blobs.length > obj.pos) {
                buffer.push(obj.blobs.pop());
            }
            if (buffer.length) {
                buffer.pop();
            }
            while (buffer.length) {
                obj.blobs.push(buffer.pop());
            }
        }
        this.parallel_conditional_blobs_list.pop();
    }
}
module.exports = CSL;
CSL.Util = {};
CSL.Util.Match = function () {
    this.any = function (token, state, tests) {
        return function (Item, item) {
            for (var i=0, ilen=tests.length; i < ilen; i += 1) {
                var result = tests[i](Item, item);
                if (result) {
                    return true;
                }
            }
            return false;
        };
    };
    this.none = function (token, state, tests) {
        return function (Item, item) {
            for (var i=0,ilen=tests.length;i<ilen;i+=1) {
                var result = tests[i](Item,item);
                if (result) {
                    return false;
                }
            }
            return true;
        };
    };
    this.all = function (token, state, tests) {
        return function (Item, item) {
            for (var i=0,ilen=tests.length;i<ilen;i+=1) {
                var result = tests[i](Item,item);
                if (!result) {
                    return false;
                }
            }
            return true;
        };
    };
    this[undefined] = this.all;
    this.nand = function (token, state, tests) {
        return function (Item, item) {
            for (var i=0,ilen=tests.length;i<ilen;i+=1) {
                var result = tests[i](Item,item);
                if (!result) {
                    return true;
                }
            }
            return false;
        };
    };
};
module.exports = CSL;
CSL.Transform = function (state) {
    var debug = false, abbreviations, token, fieldname, abbrev_family, opt;
    this.abbrevs = {};
    this.abbrevs["default"] = new state.sys.AbbreviationSegments();
    this.getTextSubField = getTextSubField;
    function abbreviate(state, Item, altvar, basevalue, myabbrev_family, use_field) {
        var value;
        myabbrev_family = CSL.FIELD_CATEGORY_REMAP[myabbrev_family];
        if (!myabbrev_family) {
            return basevalue;
        }
        var variable = myabbrev_family;
        value = "";
        if (state.sys.getAbbreviation) {
            var normalizedKey = basevalue;
            if (state.sys.normalizeAbbrevsKey) {
                normalizedKey = state.sys.normalizeAbbrevsKey(basevalue);
            }
            var jurisdiction = state.transform.loadAbbreviation(Item.jurisdiction, myabbrev_family, normalizedKey, Item.type, true);
            if (state.transform.abbrevs[jurisdiction][myabbrev_family] && normalizedKey && state.sys.getAbbreviation) {
                if (state.transform.abbrevs[jurisdiction][myabbrev_family][normalizedKey]) {
                    value = state.transform.abbrevs[jurisdiction][myabbrev_family][normalizedKey].replace("{stet}",basevalue);
                }
            }
        }
        if (!value 
            && (!state.opt.development_extensions.require_explicit_legal_case_title_short || Item.type !== 'legal_case') 
            && altvar && Item[altvar] && use_field) {
            value = Item[altvar];
        }
        if (!value) {
            value = basevalue;
        }
        if (value && value.match(/^\!(?:[^>]+,)*here(?:,[^>]+)*>>>/)) {
            if (variable === "jurisdiction" && ["treaty", "patent"].indexOf(Item.type) > -1) {
                value = value.replace(/^\![^>]*>>>\s*/, "");
            } else {
                value = false;
            }
        } 
        return value;
    }
    function getFieldLocale(Item,field) {
        var ret = state.opt["default-locale"][0].slice(0, 2)
        var localeRex;
        if (state.opt.development_extensions.strict_text_case_locales) {
            localeRex = new RegExp("^([a-zA-Z]{2})(?:$|-.*| .*)");
        } else {
            localeRex = new RegExp("^([a-zA-Z]{2})(?:$|-.*|.*)");
        }
        if (Item.language) {
            var m = ("" + Item.language).match(localeRex);
            if (m) {
                ret = m[1];
            } else {
                ret = "tlh";
            }
        }
        if (Item.multi && Item.multi && Item.multi.main && Item.multi.main[field]) {
            ret = Item.multi.main[field];
        }
        if (!state.opt.development_extensions.strict_text_case_locales
           || state.opt.development_extensions.normalize_lang_keys_to_lowercase) {
            ret = ret.toLowerCase();
        }
        return ret;
    };
    function getTextSubField (Item, field, locale_type, use_default, stopOrig) {
        var m, lst, opt, o, oo, pos, key, ret, len, myret, opts;
        var usedOrig = stopOrig;
        var usingOrig = false;
        if (!Item[field]) {
            return {
                name:"",
                usedOrig:stopOrig,
                token: CSL.Util.cloneToken(this)
            };
        }
        ret = {name:"", usedOrig:stopOrig,locale:getFieldLocale(Item,field)};
        opts = state.opt[locale_type];
        var hasVal = false;
        var jurisdictionName = false;
        if (locale_type === 'locale-orig') {
            if (stopOrig) {
                ret = {name:"", usedOrig:stopOrig};
            } else {
                ret = {name:Item[field], usedOrig:false, locale:getFieldLocale(Item,field)};
            }
            hasVal = true;
            usingOrig = true;
        } else if (use_default && ("undefined" === typeof opts || opts.length === 0)) {
            var ret = {name:Item[field], usedOrig:true, locale:getFieldLocale(Item,field)};
            hasVal = true;
            usingOrig = true;
        }
        if (!hasVal) {
            for (var i = 0, ilen = opts.length; i < ilen; i += 1) {
                opt = opts[i];
                o = opt.split(/[\-_]/)[0];
                if (opt && Item.multi && Item.multi._keys[field] && Item.multi._keys[field][opt]) {
                    ret.name = Item.multi._keys[field][opt];
                    ret.locale = opt;
                    if (field === 'jurisdiction') jurisdictionName = ret.name;
                    break;
                } else if (o && Item.multi && Item.multi._keys[field] && Item.multi._keys[field][o]) {
                    ret.name = Item.multi._keys[field][o];
                    ret.locale = o;
                    if (field === 'jurisdiction') jurisdictionName = ret.name;
                    break;
                }
            }
            if (!ret.name && use_default) {
                ret = {name:Item[field], usedOrig:true, locale:getFieldLocale(Item,field)};
                usingOrig = true;
            }
        }
        ret.token = CSL.Util.cloneToken(this);
        if (state.sys.getHumanForm && ret.name && field === 'jurisdiction') {
            ret.name = CSL.getJurisdictionNameAndSuppress(state, Item[field], jurisdictionName, this.strings.jurisdiction_depth);
        } else if (["title", "container-title"].indexOf(field) > -1) {
            if (!usedOrig
                && (!ret.token.strings["text-case"]
                    || ret.token.strings["text-case"] === "sentence"
                    || ret.token.strings["text-case"] === "normal")) {
                var locale = usingOrig ? false : ret.locale;
                var seg = field.slice(0,-5);
                var sentenceCase = ret.token.strings["text-case"] === "sentence" ? true : false;
                ret.name = CSL.titlecaseSentenceOrNormal(state, Item, seg, locale, sentenceCase);
                delete ret.token.strings["text-case"];
            }
        }
        return ret;
    }
    function loadAbbreviation(jurisdiction, category, orig, itemType) {
        var pos, len;
        if (!jurisdiction) {
            jurisdiction = "default";
        }
        if (!orig) {
            if (!state.transform.abbrevs[jurisdiction]) {
                state.transform.abbrevs[jurisdiction] = new state.sys.AbbreviationSegments();
            }
            if (!state.transform.abbrevs[jurisdiction][category]) {
                state.transform.abbrevs[jurisdiction][category] = {};
            }
            return jurisdiction;
        }
        if (state.sys.getAbbreviation) {
            jurisdiction = state.sys.getAbbreviation(state.opt.styleID, state.transform.abbrevs, jurisdiction, category, orig, itemType, true);
            if (!jurisdiction) {
                jurisdiction = "default";
            }
        }
        return jurisdiction;
    }
    this.loadAbbreviation = loadAbbreviation;
    function publisherCheck (tok, Item, primary, myabbrev_family) {
        var varname = tok.variables[0];
        if (state.publisherOutput && primary) {
            if (["publisher","publisher-place"].indexOf(varname) === -1) {
                return false;
            } else {
                state.publisherOutput[varname + "-token"] = tok;
                state.publisherOutput.varlist.push(varname);
                var lst = primary.split(/;\s*/);
                if (lst.length === state.publisherOutput[varname + "-list"].length) {
                    state.publisherOutput[varname + "-list"] = lst;
                }
                for (var i = 0, ilen = lst.length; i < ilen; i += 1) {
                    lst[i] = abbreviate(state, Item, false, lst[i], myabbrev_family, true);
                }
                state.tmp[varname + "-token"] = tok;
                return true;
            }
        }
        return false;
    }
    function getOutputFunction(variables, myabbrev_family, abbreviation_fallback, alternative_varname, transform_fallback) {
        var localesets;
        var langPrefs = CSL.LangPrefsMap[variables[0]];
        if (!langPrefs) {
            localesets = false;
        } else {
            localesets = state.opt['cite-lang-prefs'][langPrefs];
        }
        return function (state, Item, item, usedOrig) {
            var primary, primary_locale, secondary, secondary_locale, tertiary, tertiary_locale, primary_tok, group_tok, key;
            if (!variables[0] || (!Item[variables[0]] && !Item[alternative_varname])) {
                return null;
            }
            var slot = {primary:false, secondary:false, tertiary:false};
            if (state.tmp.area.slice(-5) === "_sort") {
                slot.primary = 'locale-sort';
            } else {
                if (localesets) {
                    var slotnames = ["primary", "secondary", "tertiary"];
                    for (var i = 0, ilen = slotnames.length; i < ilen; i += 1) {
                        if (localesets.length - 1 <  i) {
                            break;
                        }
                        if (localesets[i]) {
                            slot[slotnames[i]] = 'locale-' + localesets[i];
                        }
                    }
                } else {
                    slot.primary = 'locale-orig';
                }
            }
            if (variables[0] === "title-short" 
                || (state.tmp.area !== "bibliography"
                    && !(state.tmp.area === "citation"
                         && state.opt.xclass === "note"
                         && item && !item.position))) {
                slot.secondary = false;
                slot.tertiary = false;
            }
            if (state.tmp["publisher-list"]) {
                if (variables[0] === "publisher") {
                    state.tmp["publisher-token"] = this;
                } else if (variables[0] === "publisher-place") {
                    state.tmp["publisher-place-token"] = this;
                }
                return null;
            }
            var res = getTextSubField.call(this, Item, variables[0], slot.primary, true);
            primary = res.name;
            primary_locale = res.locale;
            var primary_tok = res.token;
            var primaryUsedOrig = res.usedOrig;
            if (publisherCheck(this, Item, primary, myabbrev_family)) {
                return null;
            }
            secondary = false;
            tertiary = false;
            if (slot.secondary) {
                res = getTextSubField.call(this, Item, variables[0], slot.secondary, false, res.usedOrig);
                secondary = res.name;
                secondary_locale = res.locale;
                var secondary_tok = res.token;
            }
            if (slot.tertiary) {
                res = getTextSubField.call(this, Item, variables[0], slot.tertiary, false, res.usedOrig);
                tertiary = res.name;
                tertiary_locale = res.locale;
                var tertiary_tok = res.token;
            }
            if (myabbrev_family) {
                primary = abbreviate(state, Item, alternative_varname, primary, myabbrev_family, true);
                if (primary) {
                    primary = quashCheck(primary);
                }
                secondary = abbreviate(state, Item, false, secondary, myabbrev_family, true);
                tertiary = abbreviate(state, Item, false, tertiary, myabbrev_family, true);
            }
            var primaryPrefix;
            if (slot.primary === "locale-translit") {
                primaryPrefix = state.opt.citeAffixes[langPrefs][slot.primary].prefix;
            }                
            if (primaryPrefix === "<i>" && variables[0] === 'title' && !primaryUsedOrig) {
                var hasItalic = false;
                for (var i = 0, ilen = primary_tok.decorations.length; i < ilen; i += 1) {
                    if (primary_tok.decorations[i][0] === "@font-style"
                        && primary_tok.decorations[i][1] === "italic") {
                        hasItalic = true;
                    }
                }
                if (!hasItalic) {
                    primary_tok.decorations.push(["@font-style", "italic"])
                }
            }
            if (primary_locale !== "en" && primary_tok.strings["text-case"] === "title") {
                primary_tok.strings["text-case"] = "passthrough";
            }
            if ("title" === variables[0]) {
                primary = CSL.demoteNoiseWords(state, primary, this["leading-noise-words"]);
            }
            if (secondary || tertiary) {
                state.output.openLevel("empty");
                primary_tok.strings.suffix = primary_tok.strings.suffix.replace(/[ .,]+$/,"");
                state.output.append(primary, primary_tok);
                if (secondary) {
                    secondary_tok.strings.prefix = state.opt.citeAffixes[langPrefs][slot.secondary].prefix;
                    secondary_tok.strings.suffix = state.opt.citeAffixes[langPrefs][slot.secondary].suffix;
                    if (!secondary_tok.strings.prefix) {
                        secondary_tok.strings.prefix = " ";
                    }
                    for (var i = secondary_tok.decorations.length - 1; i > -1; i += -1) {
                        if (['@quotes/true', '@font-style/italic', '@font-style/oblique', '@font-weight/bold'].indexOf(secondary_tok.decorations[i].join('/')) > -1) {
                            secondary_tok.decorations = secondary_tok.decorations.slice(0, i).concat(secondary_tok.decorations.slice(i + 1))
                        }
                    }
                    if (secondary_locale !== "en" && secondary_tok.strings["text-case"] === "title") {
                        secondary_tok.strings["text-case"] = "passthrough";
                    }
                    var secondary_outer = new CSL.Token();
                    secondary_outer.decorations.push(["@font-style", "normal"]);
                    secondary_outer.decorations.push(["@font-weight", "normal"]);
                    state.output.openLevel(secondary_outer);
                    state.output.append(secondary, secondary_tok);
                    state.output.closeLevel();
                    var blob_obj = state.output.current.value();
                    var blobs_pos = state.output.current.value().blobs.length - 1;
                    if (state.parallel.use_parallels) {
                        state.parallel.cite.front.push(variables[0] + ":secondary");
                        state.parallel.cite[variables[0] + ":secondary"] = {blobs:[[blob_obj, blobs_pos]]};
                    }
                }
                if (tertiary) {
                    tertiary_tok.strings.prefix = state.opt.citeAffixes[langPrefs][slot.tertiary].prefix;
                    tertiary_tok.strings.suffix = state.opt.citeAffixes[langPrefs][slot.tertiary].suffix;
                    if (!tertiary_tok.strings.prefix) {
                        tertiary_tok.strings.prefix = " ";
                    }
                    for (var i = tertiary_tok.decorations.length - 1; i > -1; i += -1) {
                        if (['@quotes/true', '@font-style/italic', '@font-style/oblique', '@font-weight/bold'].indexOf(tertiary_tok.decorations[i].join('/')) > -1) {
                            tertiary_tok.decorations = tertiary_tok.decorations.slice(0, i).concat(tertiary_tok.decorations.slice(i + 1))
                        }
                    }
                    if (tertiary_locale !== "en" && tertiary_tok.strings["text-case"] === "title") {
                        tertiary_tok.strings["text-case"] = "passthrough";
                    }
                    var tertiary_outer = new CSL.Token();
                    tertiary_outer.decorations.push(["@font-style", "normal"]);
                    tertiary_outer.decorations.push(["@font-weight", "normal"]);
                    state.output.openLevel(tertiary_outer);
                    state.output.append(tertiary, tertiary_tok);
                    state.output.closeLevel();
                    var blob_obj = state.output.current.value();
                    var blobs_pos = state.output.current.value().blobs.length - 1;
                    if (state.parallel.use_parallels) {
                        state.parallel.cite.front.push(variables[0] + ":tertiary");
                        state.parallel.cite[variables[0] + ":tertiary"] = {blobs:[[blob_obj, blobs_pos]]};
                    }
                }
                state.output.closeLevel();
            } else {
                state.output.append(primary, primary_tok);
            }
            return null;
        };
    }
    this.getOutputFunction = getOutputFunction;
    function quashCheck(value) {
        var m = value.match(/^!([-,_a-z]+)>>>/);
        if (m) {
            var fields = m[1].split(",");
            value = value.slice(m[0].length);
            for (var i = 0, ilen = fields.length; i < ilen; i += 1) {
                if (state.tmp.done_vars.indexOf(fields[i]) === -1) {
                    state.tmp.done_vars.push(fields[i]);
                }
            }
        }
        return value;
    }
    this.quashCheck = quashCheck;
};
module.exports = CSL;
CSL.Token = function (name, tokentype) {
    this.name = name;
    this.strings = {};
    this.strings.delimiter = undefined;
    this.strings.prefix = "";
    this.strings.suffix = "";
    this.decorations = [];
    this.variables = [];
    this.execs = [];
    this.tokentype = tokentype;
    this.evaluator = false;
    this.tests = [];
    this.rawtests = [];
    this.succeed = false;
    this.fail = false;
    this.next = false;
};
CSL.Util.cloneToken = function (token) {
    var newtok, key, pos, len;
    if ("string" === typeof token) {
        return token;
    }
    newtok = new CSL.Token(token.name, token.tokentype);
    for (var key in token.strings) {
        if (token.strings.hasOwnProperty(key)) {
            newtok.strings[key] = token.strings[key];
        }
    }
    if (token.decorations) {
        newtok.decorations = [];
        for (pos = 0, len = token.decorations.length; pos < len; pos += 1) {
            newtok.decorations.push(token.decorations[pos].slice());
        }
    }
    if (token.variables) {
        newtok.variables = token.variables.slice();
    }
    if (token.execs) {
        newtok.execs = token.execs.slice();
        newtok.tests = token.tests.slice();
        newtok.rawtests = token.tests.slice();
    }
    return newtok;
};
module.exports = CSL;
CSL.AmbigConfig = function () {
    this.maxvals = [];
    this.minval = 1;
    this.names = [];
    this.givens = [];
    this.year_suffix = false;
    this.disambiguate = 0;
};
module.exports = CSL;
CSL.Blob = function (str, token, levelname) {
    var len, pos, key;
    this.levelname = levelname;
    if (token) {
        this.strings = {"prefix":"","suffix":""};
        for (var key in token.strings) {
            if (token.strings.hasOwnProperty(key)) {
                this.strings[key] = token.strings[key];
            }
        }
        this.decorations = [];
        if (token.decorations === undefined) {
            len = 0;
        } else {
            len = token.decorations.length;
        }
        for (pos = 0; pos < len; pos += 1) {
            this.decorations.push(token.decorations[pos].slice());
        }
    } else {
        this.strings = {};
        this.strings.prefix = "";
        this.strings.suffix = "";
        this.strings.delimiter = "";
        this.decorations = [];
    }
    if ("string" === typeof str) {
        this.blobs = str;
    } else if (str) {
        this.blobs = [str];
    } else {
        this.blobs = [];
    }
    this.alldecor = [this.decorations];
};
CSL.Blob.prototype.push = function (blob) {
    if ("string" === typeof this.blobs) {
        throw "Attempt to push blob onto string object";
    } else if (false !== blob) {
        blob.alldecor = blob.alldecor.concat(this.alldecor);
        this.blobs.push(blob);
    }
};
module.exports = CSL;
CSL.NumericBlob = function (particle, num, mother_token, id) {
    this.id = id;
    this.alldecor = [];
    this.num = num;
    this.particle = particle;
    this.blobs = num.toString();
    this.status = CSL.START;
    this.strings = {};
    if (mother_token) {
        this.gender = mother_token.gender;
        this.decorations = mother_token.decorations;
        this.strings.prefix = mother_token.strings.prefix;
        this.strings.suffix = mother_token.strings.suffix;
        this.strings["text-case"] = mother_token.strings["text-case"];
        this.successor_prefix = mother_token.successor_prefix;
        this.range_prefix = mother_token.range_prefix;
        this.splice_prefix = mother_token.splice_prefix;
        this.formatter = mother_token.formatter;
        if (!this.formatter) {
            this.formatter =  new CSL.Output.DefaultFormatter();
        }
        if (this.formatter) {
            this.type = this.formatter.format(1);
        }
    } else {
        this.decorations = [];
        this.strings.prefix = "";
        this.strings.suffix = "";
        this.successor_prefix = "";
        this.range_prefix = "";
        this.splice_prefix = "";
        this.formatter = new CSL.Output.DefaultFormatter();
    }
};
CSL.NumericBlob.prototype.setFormatter = function (formatter) {
    this.formatter = formatter;
    this.type = this.formatter.format(1);
};
CSL.Output.DefaultFormatter = function () {};
CSL.Output.DefaultFormatter.prototype.format = function (num) {
    return num.toString();
};
CSL.NumericBlob.prototype.checkNext = function (next,start) {
    if (start) {
        this.status = CSL.START;
        if ("object" === typeof next) {
            if (next.num === (this.num + 1)) {
                next.status = CSL.SUCCESSOR;
            } else {
                next.status = CSL.SEEN;
            }
        }
    } else if (! next || !next.num || this.type !== next.type || next.num !== (this.num + 1)) {
        if (this.status === CSL.SUCCESSOR_OF_SUCCESSOR) {
            this.status = CSL.END;
        }
        if ("object" === typeof next) { 
           next.status = CSL.SEEN;
        }
    } else { // next number is in the sequence
        if (this.status === CSL.START || this.status === CSL.SEEN) {
            next.status = CSL.SUCCESSOR;
        } else if (this.status === CSL.SUCCESSOR || this.status === CSL.SUCCESSOR_OF_SUCCESSOR) {
            if (this.range_prefix) {
                next.status = CSL.SUCCESSOR_OF_SUCCESSOR;
                this.status = CSL.SUPPRESS;
            } else {
                next.status = CSL.SUCCESSOR;
            }
        }
    }
};
CSL.NumericBlob.prototype.checkLast = function (last) {
    if (this.status === CSL.SEEN 
    || (last.num !== (this.num - 1) && this.status === CSL.SUCCESSOR)) {
        this.status = CSL.SUCCESSOR;
        return true;
    }
    return false;
};
module.exports = CSL;
CSL.Util.fixDateNode = function (parent, pos, node) {
    var form, variable, datexml, subnode, partname, attr, val, prefix, suffix, children, key, subchildren, kkey, display, cslid;
    var lingo = this.cslXml.getAttributeValue(node, "lingo");
    var default_locale = this.cslXml.getAttributeValue(node, "default-locale");
    this.build.date_key = true;
    form = this.cslXml.getAttributeValue(node, "form");
    var lingo;
    if (default_locale) {
        lingo = this.opt["default-locale"][0];
    } else {
        lingo = this.cslXml.getAttributeValue(node, "lingo");
    }
    if (!this.getDate(form, default_locale)) {
        return parent;
    }
    var dateparts = this.cslXml.getAttributeValue(node, "date-parts");
    variable = this.cslXml.getAttributeValue(node, "variable");
    prefix = this.cslXml.getAttributeValue(node, "prefix");
    suffix = this.cslXml.getAttributeValue(node, "suffix");
    display = this.cslXml.getAttributeValue(node, "display");
    cslid = this.cslXml.getAttributeValue(node, "cslid");
    datexml = this.cslXml.nodeCopy(this.getDate(form, default_locale));
    this.cslXml.setAttribute(datexml, 'lingo', this.opt.lang);
    this.cslXml.setAttribute(datexml, 'form', form);
    this.cslXml.setAttribute(datexml, 'date-parts', dateparts);
    this.cslXml.setAttribute(datexml, "cslid", cslid);
    this.cslXml.setAttribute(datexml, 'variable', variable);
    this.cslXml.setAttribute(datexml, 'default-locale', default_locale);
    if (prefix) {
        this.cslXml.setAttribute(datexml, "prefix", prefix);
    }
    if (suffix) {
        this.cslXml.setAttribute(datexml, "suffix", suffix);
    }
    if (display) {
        this.cslXml.setAttribute(datexml, "display", display);
    }
    children = this.cslXml.children(datexml);
    for (var key in children) {
        subnode = children[key];
        if ("date-part" === this.cslXml.nodename(subnode)) {
            partname = this.cslXml.getAttributeValue(subnode, "name");
            if (default_locale) {
                this.cslXml.setAttributeOnNodeIdentifiedByNameAttribute(datexml, "date-part", partname, "@default-locale", "true");
            }
        }
    }
    children = this.cslXml.children(node);
    for (var key in children) {
        subnode = children[key];
        if ("date-part" === this.cslXml.nodename(subnode)) {
            partname = this.cslXml.getAttributeValue(subnode, "name");
            subchildren = this.cslXml.attributes(subnode);
            for (attr in subchildren) {
                if ("@name" === attr) {
                    continue;
                }
                if (lingo && lingo !== this.opt.lang) {
                    if (["@suffix", "@prefix", "@form"].indexOf(attr) > -1) {
                        continue;
                    }
                }
                val = subchildren[attr];
                this.cslXml.setAttributeOnNodeIdentifiedByNameAttribute(datexml, "date-part", partname, attr, val);
            }
        }
    }
    if ("year" === this.cslXml.getAttributeValue(node, "date-parts")) {
        this.cslXml.deleteNodeByNameAttribute(datexml, 'month');
        this.cslXml.deleteNodeByNameAttribute(datexml, 'day');
    } else if ("year-month" === this.cslXml.getAttributeValue(node, "date-parts")) {
        this.cslXml.deleteNodeByNameAttribute(datexml, 'day');
    } else if ("month-day" === this.cslXml.getAttributeValue(node, "date-parts")) {
        var childNodes = this.cslXml.children(datexml);
        for (var i=1,ilen=this.cslXml.numberofnodes(childNodes);i<ilen;i++) {
            if (this.cslXml.getAttributeValue(childNodes[i], 'name') === "year") {
                this.cslXml.setAttribute(childNodes[i-1], "suffix", "");
                break;
            }
        }
        this.cslXml.deleteNodeByNameAttribute(datexml, 'year');
    }
    return this.cslXml.insertChildNodeAfter(parent, node, pos, datexml);
};
module.exports = CSL;
CSL.dateMacroAsSortKey = function (state, Item) {
    CSL.dateAsSortKey.call(this, state, Item, true);
};
CSL.dateAsSortKey = function (state, Item, isMacro) {
    var dp, elem, value, e, yr, prefix, i, ilen, num;
    var variable = this.variables[0];
    var macroFlag = "empty";
    if (isMacro && state.tmp.extension) {
        macroFlag = "macro-with-date";
    }
    dp = Item[variable];
    if ("undefined" === typeof dp) {
        dp = {"date-parts": [[0]] };
        if (!dp.year) {
            state.tmp.empty_date = true;
        }
    }
    if ("undefined" === typeof this.dateparts) {
        this.dateparts = ["year", "month", "day"];
    }
    if (dp.raw) {
        dp = state.fun.dateparser.parseDateToArray(dp.raw);
    } else if (dp["date-parts"]) {
        dp = state.dateParseArray(dp);
    }
    if ("undefined" === typeof dp) {
        dp = {};
    }
    for (i = 0, ilen = CSL.DATE_PARTS_INTERNAL.length; i < ilen; i += 1) {
        elem = CSL.DATE_PARTS_INTERNAL[i];
        value = 0;
        e = elem;
        if (e.slice(-4) === "_end") {
            e = e.slice(0, -4);
        }
        if (dp[elem] && this.dateparts.indexOf(e) > -1) {
            value = dp[elem];
        }
        if (elem.slice(0, 4) === "year") {
            yr = CSL.Util.Dates[e].numeric(state, value);
            var prefix = "Y";
            if (yr[0] === "-") {
                prefix = "X";
                yr = yr.slice(1);
                yr = 9999 - parseInt(yr, 10);
            }
            state.output.append(CSL.Util.Dates[elem.slice(0, 4)].numeric(state, (prefix + yr)), macroFlag);
        } else {
            value = CSL.Util.Dates[e]["numeric-leading-zeros"](state, value);
            if (!value) {
                value = "00";
            }
            state.output.append(value, macroFlag);
        }
    }
};
CSL.Engine.prototype.dateParseArray = function (date_obj) {
    var ret, field, dpos, ppos, dp, exts, llen, pos, len, pppos, lllen;
    ret = {};
    for (field in date_obj) {
        if (field === "date-parts") {
            dp = date_obj["date-parts"];
            if (dp.length > 1) {
                if (dp[0].length !== dp[1].length) {
                    CSL.error("CSL data error: element mismatch in date range input.");
                }
            }
            exts = ["", "_end"];
            for (var i = 0, ilen = dp.length; i < ilen; i += 1) {
                for (var j = 0, jlen = CSL.DATE_PARTS.length; j < jlen; j += 1) {
                    if ("undefined" === typeof dp[i][j]) {
                        ret[(CSL.DATE_PARTS[j] + exts[i])] = dp[i][j];
                    } else {
                        ret[(CSL.DATE_PARTS[j] + exts[i])] = parseInt(dp[i][j], 10);
                    }
                }
            }
        } else if (date_obj.hasOwnProperty(field)) {
            if (field === "literal" && "object" === typeof date_obj.literal && "string" === typeof date_obj.literal.part) {
                CSL.debug("Warning: fixing up weird literal date value");
                ret.literal = date_obj.literal.part;
            } else {
                ret[field] = date_obj[field];
            }
        }
    }
    return ret;
};
module.exports = CSL;
CSL.Util.Names = {};
CSL.Util.Names.compareNamesets = CSL.NameOutput.prototype._compareNamesets;
CSL.Util.Names.unInitialize = function (state, name) {
    var i, ilen, namelist, punctlist, ret;
    if (!name) {
        return "";
    }
    namelist = name.split(/(?:\-|\s+)/);
    punctlist = name.match(/(\-|\s+)/g);
    ret = "";
    for (i = 0, ilen = namelist.length; i < ilen; i += 1) {
        ret += namelist[i];
        if (i < ilen - 1) {
            ret += punctlist[i];
        }
    }
    return ret;
};
CSL.Util.Names.initializeWith = function (state, name, terminator, normalizeOnly) {
    var i, ilen, j, jlen, n, m, mm, str, lst, ret;
    if (!name) {
        return "";
    }
    if (!terminator) {
        terminator = "";
    }
    if (["Lord", "Lady"].indexOf(name) > -1
        || (!name.match(CSL.STARTSWITH_ROMANESQUE_REGEXP)
            && !terminator.match("%s"))) {
        return name;
    }
    var namelist = name;
    if (state.opt["initialize-with-hyphen"] === false) {
        namelist = namelist.replace(/\-/g, " ");
    }
    namelist = namelist.replace(/\s*\-\s*/g, "-").replace(/\s+/g, " ");
    namelist = namelist.replace(/-([a-z])/g, "\u2013$1");
    mm = namelist.match(/[\-\s]+/g);
    lst = namelist.split(/[\-\s]+/);
    if (lst.length === 0) {
        namelist = mm;
    } else {
        namelist = [lst[0]];
        for (i = 1, ilen = lst.length; i < ilen; i += 1) {
            namelist.push(mm[i - 1]);
            namelist.push(lst[i]);
        }
    }
    lst = namelist;
    for (i = lst.length -1; i > -1; i += -1) {
        if (lst[i] && lst[i].slice(0, -1).indexOf(".") > -1) {
            var lstend = lst.slice(i + 1);
            var lstmid = lst[i].slice(0, -1).split(".");
            lst = lst.slice(0, i);
            for (j = 0, jlen = lstmid.length; j < jlen; j += 1) {
                lst.push(lstmid[j] + ".");
                if (j < lstmid.length - 1) {
                    lst.push(" ");
                }
            }
            lst = lst.concat(lstend);
        }
    }
    if (normalizeOnly) {
        ret = CSL.Util.Names.doNormalize(state, lst, terminator);
    } else {
        ret = CSL.Util.Names.doInitialize(state, lst, terminator);
    }
    ret = ret.replace(/\u2013([a-z])/g, "-$1");
    return ret;
};
CSL.Util.Names.doNormalize = function (state, namelist, terminator, mode) {
    var i, ilen;
    terminator = terminator ? terminator : "";
    var isAbbrev = [];
    for (i = 0, ilen = namelist.length; i < ilen; i += 1) {
        if (namelist[i].length > 1 && namelist[i].slice(-1) === ".") {
            namelist[i] = namelist[i].slice(0, -1);
            isAbbrev.push(true);
        } else if (namelist[i].length === 1 && namelist[i].toUpperCase() === namelist[i]) {
            isAbbrev.push(true);
        } else {
            isAbbrev.push(false);
        }
    }
    var ret = [];
    for (i = 0, ilen = namelist.length; i < ilen; i += 2) {
        if (isAbbrev[i]) {
            if (i < namelist.length - 2) {
                namelist[i + 1] = "";
                if ((!terminator || terminator.slice(-1) && terminator.slice(-1) !== " ")
                    && namelist[i].length && namelist[i].match(CSL.ALL_ROMANESQUE_REGEXP)
                    && (namelist[i].length > 1 || namelist[i + 2].length > 1)) {
                    namelist[i + 1] = " ";
                }
                if (namelist[i + 2].length > 1) {
                    namelist[i] = namelist[i] + terminator.replace(/[\u0009\u000a\u000b\u000c\u000d\u0020\ufeff\u00a0]+$/, "");
                } else {
                    namelist[i] = namelist[i] + terminator;
                }
            }
            if (i === namelist.length - 1) {
                namelist[i] = namelist[i] + terminator;
            }
        }
    }
    return namelist.join("").replace(/[\u0009\u000a\u000b\u000c\u000d\u0020\ufeff\u00a0]+$/,"").replace(/\s*\-\s*/g, "-").replace(/[\u0009\u000a\u000b\u000c\u000d\u0020]+/g, " ");
};
CSL.Util.Names.doInitialize = function (state, namelist, terminator, mode) {
    var i, ilen, m, j, jlen, lst, n;
    for (i = 0, ilen = namelist.length; i < ilen; i += 2) {
        n = namelist[i];
        if (!n) {
            continue;
        }
        m = n.match(CSL.NAME_INITIAL_REGEXP);
        if (!m && (!n.match(CSL.STARTSWITH_ROMANESQUE_REGEXP) && n.length > 1 && terminator.match("%s"))) {
            m = n.match(/(.)(.*)/);
        }
        if (m && m[1] === m[1].toUpperCase()) {
            var extra = "";
            if (m[2]) {
                var s = "";
                lst = m[2].split("");
                for (j = 0, jlen = lst.length; j < jlen; j += 1) {
                    var c = lst[j];
                    if (c === c.toUpperCase()) {
                        s += c;
                    } else {
                        break;
                    }
                }
                if (s.length < m[2].length) {
                    extra = s.toLocaleLowerCase();
                }
            }
            namelist[i] = m[1].toLocaleUpperCase() + extra;
            if (i < (ilen - 1)) {
                if (terminator.match("%s")) {
                    namelist[i] = terminator.replace("%s", namelist[i]);
                } else {
                    if (namelist[i + 1].indexOf("-") > -1) {
                        namelist[i + 1] = terminator + namelist[i + 1];
                    } else {
                        namelist[i + 1] = terminator;
                    }
                }
            } else {
                if (terminator.match("%s")) {
                    namelist[i] = terminator.replace("%s", namelist[i]);
                } else {
                    namelist.push(terminator);
                }
            }
        } else if (n.match(CSL.ROMANESQUE_REGEXP)) {
            namelist[i] = " " + n;
        }
    }
    var ret = namelist.join("");
    ret = ret.replace(/[\u0009\u000a\u000b\u000c\u000d\u0020\ufeff\u00a0]+$/,"").replace(/\s*\-\s*/g, "-").replace(/[\u0009\u000a\u000b\u000c\u000d\u0020]+/g, " ");
    return ret;
};
CSL.Util.Names.getRawName = function (name) {
    var ret = [];
    if (name.given) {
        ret.push(name.given);
    }
    if (name.family) {
        ret.push(name.family);
    }
    return ret.join(" ");
};
module.exports = CSL;
CSL.Util.Dates = {};
CSL.Util.Dates.year = {};
CSL.Util.Dates.year["long"] = function (state, num) {
    if (!num) {
        if ("boolean" === typeof num) {
            num = "";
        } else {
            num = 0;
        }
    }
    return num.toString();
};
CSL.Util.Dates.year.imperial = function (state, num, end, makeShort) {
    var year = "";
    if (!num) {
        if ("boolean" === typeof num) {
            num = "";
        } else {
            num = 0;
        }
    }
    end = end ? "_end" : "";
    var month = state.tmp.date_object["month" + end];
    month = month ? ""+month : "1";
    while (month.length < 2) {
        month = "0" + month;
    }
    var day = state.tmp.date_object["day" + end];
    day = day ? ""+day : "1";
    while (day.length < 2) {
        day = "0" + day;
    }
    var date = parseInt(num + month + day, 10);
    var label;
    var offset;
    if (date >= 18680908 && date < 19120730) {
        label = '\u660e\u6cbb';
        offset = 1867;
    } else if (date >= 19120730 && date < 19261225) {
        label = '\u5927\u6b63';
        offset = 1911;
    } else if (date >= 19261225 && date < 19890108) {
        label = '\u662d\u548c';
        offset = 1925;
    } else if (date >= 19890108) {
        label = '\u5e73\u6210';
        offset = 1988;
    }
    if (label && offset) {
        var normalizedKey = label;
        if (state.sys.normalizeAbbrevsKey) {
            normalizedKey = state.sys.normalizeAbbrevsKey(label);
        }
        if (!state.transform.abbrevs['default']['number'][normalizedKey]) {
            state.transform.loadAbbreviation('default', "number", normalizedKey);
        }
        if (state.transform.abbrevs['default']['number'][normalizedKey]) {
            label = state.transform.abbrevs['default']['number'][normalizedKey];
        };
        year = label + (num - offset);
    }
    return year;
};
CSL.Util.Dates.year["short"] = function (state, num) {
    num = num.toString();
    if (num && num.length === 4) {
        return num.substr(2);
    }
};
CSL.Util.Dates.year.numeric = function (state, num) {
    var m, pre;
    num = "" + num;
    var m = num.match(/([0-9]*)$/);
    if (m) {
        pre = num.slice(0, m[1].length * -1);
        num = m[1];
    } else {
        pre = num;
        num = "";
    }
    while (num.length < 4) {
        num = "0" + num;
    }
    return (pre + num);
};
CSL.Util.Dates.normalizeMonth = function (num, useSeason) {
    var ret;
    if (!num) {
        num = 0;
    }
    num = "" + num;
    if (!num.match(/^[0-9]+$/)) {
        num = 0;
    }
    num = parseInt(num, 10);
    if (useSeason) {
        var res = {stub: "month-", num: num};
        if (res.num < 1 || res.num > 20) {
            res.num = 0;
        } else if (res.num > 16) {
            res.stub = "season-";
            res.num = res.num - 16;
        } else if (res.num > 12) {
            res.stub = "season-";
            res.num = res.num - 12;
        }
        ret = res;
    } else {
        if (num < 1 || num > 12) {
            num = 0;
        }
        ret = num;
    }
    return ret;
}
CSL.Util.Dates.month = {};
CSL.Util.Dates.month.numeric = function (state, num) {
    var num = CSL.Util.Dates.normalizeMonth(num);
    if (!num) {
        num = "";
    }
    return num;
};
CSL.Util.Dates.month["numeric-leading-zeros"] = function (state, num) {
    var num = CSL.Util.Dates.normalizeMonth(num);
    if (!num) {
        num = "";
    } else {
        num = "" + num;
        while (num.length < 2) {
            num = "0" + num;
        }
    }
    return num;
};
CSL.Util.Dates.month["long"] = function (state, num, gender, forceDefaultLocale) {
    var res = CSL.Util.Dates.normalizeMonth(num, true);
    var num = res.num;
    if (!num) {
        num = "";
    } else {
        num = "" + num;
        while (num.length < 2) {
            num = "0" + num;
        }
        num = state.getTerm(res.stub + num, "long", 0, 0, false, forceDefaultLocale);
    }
    return num;
};
CSL.Util.Dates.month["short"] = function (state, num, gender, forceDefaultLocale) {
    var res = CSL.Util.Dates.normalizeMonth(num, true);
    var num = res.num;
    if (!num) {
        num = "";
    } else {
        num = "" + num;
        while (num.length < 2) {
            num = "0" + num;
        }
        num = state.getTerm(res.stub + num, "short", 0, 0, false, forceDefaultLocale);
    }
    return num;
};
CSL.Util.Dates.day = {};
CSL.Util.Dates.day.numeric = function (state, num) {
    return num.toString();
};
CSL.Util.Dates.day["long"] = CSL.Util.Dates.day.numeric;
CSL.Util.Dates.day["numeric-leading-zeros"] = function (state, num) {
    if (!num) {
        num = 0;
    }
    num = num.toString();
    while (num.length < 2) {
        num = "0" + num;
    }
    return num.toString();
};
CSL.Util.Dates.day.ordinal = function (state, num, gender) {
    return state.fun.ordinalizer.format(num, gender);
};
module.exports = CSL;
CSL.Util.Sort = {};
CSL.Util.Sort.strip_prepositions = function (str) {
    var m;
    if ("string" === typeof str) {
        m = str.toLocaleLowerCase();
        m = str.match(/^((a|an|the)\s+)/);
    }
    if (m) {
        str = str.substr(m[1].length);
    }
    return str;
};
module.exports = CSL;
CSL.Util.substituteStart = function (state, target) {
    var element_trace, display, bib_first, func, choose_start, if_start, nodetypes;
    func = function (state, Item) {
        for (var i = 0, ilen = this.decorations.length; i < ilen; i += 1) {
            if ("@strip-periods" === this.decorations[i][0] && "true" === this.decorations[i][1]) {
                state.tmp.strip_periods += 1;
                break;
            }
        }
    };
    this.execs.push(func);
    if (this.decorations && (state.opt.development_extensions.csl_reverse_lookup_support || state.sys.csl_reverse_lookup_support)) {
        this.decorations.reverse();
        this.decorations.push(["@showid","true", this.cslid]);
        this.decorations.reverse();
    }
    nodetypes = ["number", "date", "names"];
    if (("text" === this.name && !this.postponed_macro) || nodetypes.indexOf(this.name) > -1) {
        element_trace = function (state, Item, item) {
            if (state.tmp.element_trace.value() === "author" || "names" === this.name) {
                if (item && item["author-only"]) {
                    state.tmp.element_trace.push("do-not-suppress-me");
                } else if (item && item["suppress-author"]) {
                }
            } else {
                if (item && item["author-only"]) {
                    state.tmp.element_trace.push("suppress-me");
                } else if (item && item["suppress-author"]) {
                    state.tmp.element_trace.push("do-not-suppress-me");
                }
            }
        };
        this.execs.push(element_trace);
    }
    display = this.strings.cls;
    this.strings.cls = false;
    if (state.build.render_nesting_level === 0) {
        if (state.build.area === "bibliography" && state.bibliography.opt["second-field-align"]) {
            bib_first = new CSL.Token("group", CSL.START);
            bib_first.decorations = [["@display", "left-margin"]];
            func = function (state, Item) {
                if (!state.tmp.render_seen) {
                    bib_first.strings.first_blob = Item.id;
                    state.output.startTag("bib_first", bib_first);
                }
            };
            bib_first.execs.push(func);
            target.push(bib_first);
        } else if (CSL.DISPLAY_CLASSES.indexOf(display) > -1) {
            bib_first = new CSL.Token("group", CSL.START);
            bib_first.decorations = [["@display", display]];
            func = function (state, Item) {
                bib_first.strings.first_blob = Item.id;
                state.output.startTag("bib_first", bib_first);
            };
            bib_first.execs.push(func);
            target.push(bib_first);
        }
        state.build.cls = display;
    }
    state.build.render_nesting_level += 1;
    if (state.build.substitute_level.value() === 1) {
        choose_start = new CSL.Token("choose", CSL.START);
        CSL.Node.choose.build.call(choose_start, state, target);
        if_start = new CSL.Token("if", CSL.START);
        func = function (Item,item) {
            if (state.tmp.can_substitute.value()) {
                return true;
            }
            return false;
        };
        if_start.tests.push(func);
        if_start.test = state.fun.match.any(this, state, if_start.tests);
        target.push(if_start);
    }
    if (state.sys.variableWrapper
        && this.variables_real
        && this.variables_real.length) {
        func = function (state, Item, item) {
            if (!state.tmp.just_looking && !state.tmp.suppress_decorations) {
                var variable_entry = new CSL.Token("text", CSL.START);
                variable_entry.decorations = [["@showid", "true"]];
                state.output.startTag("variable_entry", variable_entry);
                var position = null;
                if (item) {
                    position = item.position;
                }
                if (!position) position = 0;
                var positionMap = [
                    "first",
                    "subsequent",
                    "ibid",
                    "ibid-with-locator"
                ]
                var noteNumber = 0;
                if (item && item.noteIndex) {
                    noteNumber = item.noteIndex;
                }
                var firstReferenceNoteNumber = 0;
                if (item && item['first-reference-note-number']) {
                    firstReferenceNoteNumber = item['first-reference-note-number'];
                }
                var citationNumber = 0;
                if (item && item['citation-number']) {
                    citationNumber = item['citation-number'];
                }
                var index = 0;
                if (item && item.index) {
                    index = item.index;
                }
                var params = {
                    itemData: Item,
                    variableNames: this.variables,
                    context: state.tmp.area,
                    xclass: state.opt.xclass,
                    position: positionMap[position],
                    "note-number": noteNumber,
                    "first-reference-note-number": firstReferenceNoteNumber,
                    "citation-number": citationNumber,
                    "index": index,
                    "mode": state.opt.mode
                };
                state.output.current.value().params = params;
            }
        }
        this.execs.push(func);
    }
};
CSL.Util.substituteEnd = function (state, target) {
    var func, bib_first_end, bib_other, if_end, choose_end, toplevel, hasval, author_substitute, str;
    if (state.sys.variableWrapper
        && (this.hasVariable || (this.variables_real && this.variables_real.length))) {
        func = function (state,Item) {
            if (!state.tmp.just_looking && !state.tmp.suppress_decorations) {
                state.output.endTag("variable_entry");
            }
        }
        this.execs.push(func);
    }
    func = function (state, Item) {
        for (var i = 0, ilen = this.decorations.length; i < ilen; i += 1) {
            if ("@strip-periods" === this.decorations[i][0] && "true" === this.decorations[i][1]) {
                state.tmp.strip_periods += -1;
                break;
            }
        }
    };
    this.execs.push(func);
    state.build.render_nesting_level += -1;
    if (state.build.render_nesting_level === 0) {
        if (state.build.cls) {
            func = function (state, Item) {
                state.output.endTag("bib_first");
            };
            this.execs.push(func);
            state.build.cls = false;
        } else if (state.build.area === "bibliography" && state.bibliography.opt["second-field-align"]) {
            bib_first_end = new CSL.Token("group", CSL.END);
            func = function (state, Item) {
                if (!state.tmp.render_seen) {
                    state.output.endTag("bib_first"); // closes bib_first
                }
            };
            bib_first_end.execs.push(func);
            target.push(bib_first_end);
            bib_other = new CSL.Token("group", CSL.START);
            bib_other.decorations = [["@display", "right-inline"]];
            func = function (state, Item) {
                if (!state.tmp.render_seen) {
                    state.tmp.render_seen = true;
                    state.output.startTag("bib_other", bib_other);
                }
            };
            bib_other.execs.push(func);
            target.push(bib_other);
        }
    }
    if (state.build.substitute_level.value() === 1) {
        if_end = new CSL.Token("if", CSL.END);
        target.push(if_end);
        choose_end = new CSL.Token("choose", CSL.END);
        CSL.Node.choose.build.call(choose_end, state, target);
    }
    if ("names" === this.name || ("text" === this.name && this.variables_real !== "title")) {
        author_substitute = new CSL.Token("text", CSL.SINGLETON);
        func = function (state, Item) {
            if (state.tmp.area !== "bibliography") return;
            if ("string" !== typeof state.bibliography.opt["subsequent-author-substitute"]) return;
            if (this.variables_real && !Item[this.variables_real]) return;
            if (state.tmp.substituted_variable !== this.variables_real) {
                return;
            }
            var subrule = state.bibliography.opt["subsequent-author-substitute-rule"];
            var i, ilen;
            var printing = !state.tmp.suppress_decorations;
            if (printing && state.tmp.subsequent_author_substitute_ok) {
                if (state.tmp.rendered_name) {
                    if ("partial-each" === subrule || "partial-first" === subrule) {
                        var dosub = true;
                        var rendered_name = [];
                        for (i = 0, ilen = state.tmp.name_node.children.length; i < ilen; i += 1) {
                            var name = state.tmp.rendered_name[i];
                            if (dosub
                                && state.tmp.last_rendered_name && state.tmp.last_rendered_name.length > (i - 1)
                                && name && !name.localeCompare(state.tmp.last_rendered_name[i])) {
                                str = new CSL.Blob(state[state.tmp.area].opt["subsequent-author-substitute"]);
                                state.tmp.name_node.children[i].blobs = [str];
                                if ("partial-first" === subrule) {
                                    dosub = false;
                                }
                            } else {
                                dosub = false;
                            }
                            rendered_name.push(name);
                        }
                        state.tmp.last_rendered_name = rendered_name;
                    } else if ("complete-each" === subrule) {
                        var rendered_name = state.tmp.rendered_name.join(",");
                        if (rendered_name) {
                            if (state.tmp.last_rendered_name && !rendered_name.localeCompare(state.tmp.last_rendered_name)) {
                                for (i = 0, ilen = state.tmp.name_node.children.length; i < ilen; i += 1) {
                                    str = new CSL.Blob(state[state.tmp.area].opt["subsequent-author-substitute"]);
                                    state.tmp.name_node.children[i].blobs = [str];
                                }
                            }
                            state.tmp.last_rendered_name = rendered_name;
                        }
                    } else {
                        var rendered_name = state.tmp.rendered_name.join(",");
                        if (rendered_name) {
                            if (state.tmp.last_rendered_name && !rendered_name.localeCompare(state.tmp.last_rendered_name)) {
                                str = new CSL.Blob(state[state.tmp.area].opt["subsequent-author-substitute"]);
                                if (state.tmp.label_blob) {
                                    state.tmp.name_node.top.blobs = [str,state.tmp.label_blob];
                                } else if (state.tmp.name_node.top.blobs.length) {
                                    state.tmp.name_node.top.blobs[0].blobs = [str];
                                } else {
                                    state.tmp.name_node.top.blobs = [str];
                                }
                                state.tmp.substituted_variable = this.variables_real;
                            }
                            state.tmp.last_rendered_name = rendered_name;
                        }
                    }
                    state.tmp.subsequent_author_substitute_ok = false;
                }
            }
        };
        this.execs.push(func);
    }
    if (("text" === this.name && !this.postponed_macro) || ["number", "date", "names"].indexOf(this.name) > -1) {
        func = function (state, Item) {
            state.tmp.element_trace.pop();
        };
        this.execs.push(func);
    }
};
module.exports = CSL;
CSL.Util.padding = function (num) {
    var m = num.match(/\s*(-{0,1}[0-9]+)/);
    if (m) {
        num = parseInt(m[1], 10);
        if (num < 0) {
            num = 99999999999999999999 + num;
        }
        num = "" + num;
        while (num.length < 20) {
            num = "0" + num;
        }
    }
    return num;
};
CSL.Util.LongOrdinalizer = function () {};
CSL.Util.LongOrdinalizer.prototype.init = function (state) {
    this.state = state;
};
CSL.Util.LongOrdinalizer.prototype.format = function (num, gender) {
    if (num < 10) {
        num = "0" + num;
    }
    var ret = CSL.Engine.getField(
        CSL.LOOSE, 
        this.state.locale[this.state.opt.lang].terms,
        "long-ordinal-" + num,
        "long", 
        0, 
        gender
    );
    if (!ret) {
        ret = this.state.fun.ordinalizer.format(num, gender);
    }
    this.state.tmp.cite_renders_content = true;
    return ret;
};
CSL.Util.Ordinalizer = function (state) {
    this.state = state;
    this.suffixes = {};
};
CSL.Util.Ordinalizer.prototype.init = function () {
    if (!this.suffixes[this.state.opt.lang]) {
        this.suffixes[this.state.opt.lang] = {};
        for (var i = 0, ilen = 3; i < ilen; i += 1) {
            var gender = [undefined, "masculine", "feminine"][i];
            this.suffixes[this.state.opt.lang][gender] = [];
            for (var j = 1; j < 5; j += 1) {
                var ordinal = this.state.getTerm("ordinal-0" + j, "long", false, gender);
                if ("undefined" === typeof ordinal) {
                    delete this.suffixes[this.state.opt.lang][gender];
                    break;
                }
                this.suffixes[this.state.opt.lang][gender].push(ordinal);
            }
        }
    }
};
CSL.Util.Ordinalizer.prototype.format = function (num, gender) {
    var str;
    num = parseInt(num, 10);
    str = "" + num;
    var suffix = "";
    var trygenders = [];
    if (gender) {
        trygenders.push(gender);
    }
    trygenders.push("neuter");
    if (this.state.locale[this.state.opt.lang].ord["1.0.1"]) {
        suffix = this.state.getTerm("ordinal",false,0,gender);
        var trygender;
        for (var i = 0, ilen = trygenders.length; i < ilen; i += 1) {
            trygender = trygenders[i];
            var ordinfo = this.state.locale[this.state.opt.lang].ord["1.0.1"];
            if (ordinfo["whole-number"][str] && ordinfo["whole-number"][str][trygender]) {
                suffix = this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["whole-number"][str][trygender],false,0,gender);
            } else if (ordinfo["last-two-digits"][str.slice(str.length - 2)] && ordinfo["last-two-digits"][str.slice(str.length - 2)][trygender]) {
                suffix = this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["last-two-digits"][str.slice(str.length - 2)][trygender],false,0,gender);
            } else if (ordinfo["last-digit"][str.slice(str.length - 1)] && ordinfo["last-digit"][str.slice(str.length - 1)][trygender]) {
                suffix = this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["last-digit"][str.slice(str.length - 1)][trygender],false,0,gender);
            }
            if (suffix) {
                break;
            }
        }
    } else {
        if (!gender) {
            gender = undefined;
        }
        this.state.fun.ordinalizer.init();
        if ((num / 10) % 10 === 1 || (num > 10 && num < 20)) {
            suffix = this.suffixes[this.state.opt.lang][gender][3];
        } else if (num % 10 === 1 && num % 100 !== 11) {
            suffix = this.suffixes[this.state.opt.lang][gender][0];
        } else if (num % 10 === 2 && num % 100 !== 12) {
            suffix = this.suffixes[this.state.opt.lang][gender][1];
        } else if (num % 10 === 3 && num % 100 !== 13) {
            suffix = this.suffixes[this.state.opt.lang][gender][2];
        } else {
            suffix = this.suffixes[this.state.opt.lang][gender][3];
        }
    }
    str = str += suffix;
    return str;
};
CSL.Util.Romanizer = function () {};
CSL.Util.Romanizer.prototype.format = function (num) {
    var ret, pos, n, numstr, len;
    ret = "";
    if (num < 6000) {
        numstr = num.toString().split("");
        numstr.reverse();
        pos = 0;
        n = 0;
        len = numstr.length;
        for (pos = 0; pos < len; pos += 1) {
            n = parseInt(numstr[pos], 10);
            ret = CSL.ROMAN_NUMERALS[pos][n] + ret;
        }
    }
    return ret;
};
CSL.Util.Suffixator = function (slist) {
    if (!slist) {
        slist = CSL.SUFFIX_CHARS;
    }
    this.slist = slist.split(",");
};
CSL.Util.Suffixator.prototype.format = function (N) {
    var X;
    N += 1;
    var key = "";
    do {
        X = ((N % 26) === 0) ? 26 : (N % 26);
        var key = this.slist[X-1] + key;
        N = (N - X) / 26;
    } while ( N !== 0 );
    return key;
};
CSL.Engine.prototype.processNumber = function (node, ItemObject, variable, type) {
    var val, m, i, ilen, j, jlen;
    var debug = false;
    var me = this;
    function normalizeFieldValue(str, defaultLabel) {
        str = str.trim();
        var m = str.match(/^([^ ]+)/);
        if (m && !CSL.STATUTE_SUBDIV_STRINGS[m[1]]) {
            var embeddedLabel = null;
            if (variable === "locator" ) {
                if (ItemObject.label) {
                    embeddedLabel = CSL.STATUTE_SUBDIV_STRINGS_REVERSE[ItemObject.label];
                } else {
                    embeddedLabel = "p.";
                }
            } else {
                embeddedLabel = CSL.STATUTE_SUBDIV_STRINGS_REVERSE[variable];
            }
            if (embeddedLabel) {
                str = embeddedLabel + " " + str;
            }
        }
        return str;
    }
    function composeNumberInfo(origLabel, label, val, joiningSuffix) {
        joiningSuffix = joiningSuffix ? joiningSuffix : "";
        var info = {};
        if (!label && !CSL.STATUTE_SUBDIV_STRINGS_REVERSE[variable]) {
                label = "var:"+variable;
        }
        if (label) {
            var m = label.match(/(\s*)([^\s]*)(\s*)/);
            info.label = m[2];
            info.origLabel = origLabel;
            info.labelSuffix = m[3] ? m[3] : "";
            info.plural = 0;
            info.labelVisibility = false;
        }
        var m = val.match(/^([a-zA-Z0]*)([0-9]+(?:[a-zA-Z]*|[-,a-zA-Z]+))$/);
        if (m) {
            info.particle = m[1];
            info.value = m[2];
        } else {
            info.particle = "";
            info.value = val;
        }
        info.joiningSuffix = joiningSuffix.replace(/\s*-\s*/, "-");
        return info;
    };
    function fixupSubsections(elems) {
        for (var i=elems.length-2;i>-1;i-=2) {
            if (elems[i] === "-"
               && elems[i-1].match(/^(?:(?:[a-z]|[a-z][a-z]|[a-z][a-z][a-z]|[a-z][a-z][a-z][a-z])\.  *)*[0-9]+[,a-zA-Z]+$/)
               && elems[i+1].match(/^[,a-zA-Z]+$/)) {
                elems[i-1] = elems.slice(i-1,i+2).join("");
                elems = elems.slice(0,i).concat(elems.slice(i+2));
            }
        }
        return elems;
    }
    function parseString(str, defaultLabel) {
        defaultLabel = defaultLabel ? defaultLabel : "";
        str = normalizeFieldValue(str, defaultLabel);
        var elems = [];
        var m = str.match(/(,\s+|\s*\\*[\-\u2013]+\s*|\s*&\s*)/g);
        if (m) {
            var lst = str.split(/(?:,\s+|\s*\\*[\-\u2013]+\s*|\s*&\s*)/);
            for (var i=0,ilen=lst.length-1; i<ilen; i++) {
                elems.push(lst[i]);
                elems.push(m[i]);
            }
            elems.push(lst[lst.length-1]);
            elems = fixupSubsections(elems);
        } else {
            var elems = [str];
        }
        var values = [];
        var label = defaultLabel;
        var origLabel = "";
        for (var i=0,ilen=elems.length;i<ilen;i += 2) {
            var m = elems[i].match(/((?:^| )(?:[a-z]|[a-z][a-z]|[a-z][a-z][a-z]|[a-z][a-z][a-z][a-z])\. *)/g);
            if (m) {
                var lst = elems[i].split(/(?:(?:^| )(?:[a-z]|[a-z][a-z]|[a-z][a-z][a-z]|[a-z][a-z][a-z][a-z])\. *)/);
                for (var j=lst.length-1;j>0;j--) {
                    if (lst[j-1] && (!lst[j].match(/^[0-9]+([-,:a-zA-Z]*)$/) || !lst[j-1].match(/^[0-9]+([-,:a-zA-Z]*)$/))) {
                        lst[j-1] = lst[j-1] + m[j-1] + lst[j];
                        lst = lst.slice(0,j).concat(lst.slice(j+1))
                        m = m.slice(0,j-1).concat(m.slice(j))
                    }
                }
                if (m.length > 0 && i === 0) {
                    var slug = m[0].trim();
                    if (!CSL.STATUTE_SUBDIV_STRINGS[slug]
                        || !me.getTerm(CSL.STATUTE_SUBDIV_STRINGS[slug])
                        || (["locator", "number"].indexOf(variable) === -1 && CSL.STATUTE_SUBDIV_STRINGS[slug] !== variable)) {
                        m = m.slice(1);
                        lst[0] = lst[0] + " " + slug + " " + lst[1];
                        lst = lst.slice(0,1).concat(lst.slice(2))
                    }
                }
                for (var j=0,jlen=lst.length; j<jlen; j++) {
                    if (lst[j] || j === (lst.length-1)) {
                        label = m[j-1] ? m[j-1] : label;
                        var origLabel = j > 1 ? m[j-1] : "";
                        var str = lst[j] ? lst[j].trim() : "";
                        if (j === (lst.length-1)) {
                            values.push(composeNumberInfo(origLabel, label, str, elems[i+1]));
                        } else {
                            values.push(composeNumberInfo(origLabel, label, str));
                        }
                    }
                }
            } else {
                values.push(composeNumberInfo(origLabel, label, elems[i], elems[i+1]));
            }
        }
        return values;
    }
    function setSpaces(values) {
        for (var i=0,ilen=values.length-1;i<ilen;i++) {
            if (!values[i].joiningSuffix && values[i+1].label) {
                values[i].joiningSuffix = " ";
            }
        }
    }
    function fixNumericAndCount(values, i, currentLabelInfo) {
        var master = values[currentLabelInfo.pos];
        var val = values[i].value;
        var isEscapedHyphen = master.joiningSuffix === "\\-";
        if (val.particle && val.particle !== master.particle) {
            currentLabelInfo.collapsible = false;
        }
        var mVal = val.match(/^[0-9]+([-,:a-zA-Z]*)$/);
        var mCurrentLabel = master.value.match(/^[0-9]+([-,:a-zA-Z]*)$/);
        if (!val || !mVal || !mCurrentLabel || isEscapedHyphen) {
            currentLabelInfo.collapsible = false;
            if (!val || !mCurrentLabel) {
                currentLabelInfo.numeric = false;
            }
            if (isEscapedHyphen) {
                currentLabelInfo.count--;
            }
        }
        if ((mVal && mVal[1]) || (mCurrentLabel && mCurrentLabel[1])) {
            currentLabelInfo.collapsible = false;
        }
        var isCollapsible = currentLabelInfo.collapsible;
        if (!isCollapsible && i>0 && val.match(/^[ivxlcmIVXLCM]+$/) && values[i-1].value.match(/^[ivxlcmIVXLCM]+$/)) {
            isCollapsible = true;
        }
        for (var j=currentLabelInfo.pos,jlen=values.length; j<jlen; j++) {
            if (currentLabelInfo.label === values[j].label && currentLabelInfo.count > 1 && isCollapsible) {
                values[j].plural = 1;
            }
            values[j].numeric = currentLabelInfo.numeric;
            values[j].collapsible = currentLabelInfo.collapsible;
        }
        currentLabelInfo.label = values[i].label;
        currentLabelInfo.count = 1;
        currentLabelInfo.pos = i;
        currentLabelInfo.numeric = true;
        currentLabelInfo.collapsible = true;
    }
    function setPluralsAndNumerics(values) {
        var currentLabelInfo = {
            label: null,
            count: 1,
            numeric: true,
            collapsible: true,
            pos: 0
        }
        var masterLabel = values.length ? values[0].label : null;
        for (var i=0,ilen=values.length;i<ilen;i++) {
            if (values[i].label) {
                if (values[i].label === currentLabelInfo.label) {
                    currentLabelInfo.count++;
                } else {
                    fixNumericAndCount(values, i, currentLabelInfo);
                    if (currentLabelInfo.pos === 0) {
                        if (variable === "locator" || variable === "number") {
                            if (!me.getTerm(CSL.STATUTE_SUBDIV_STRINGS[currentLabelInfo.label]) && currentLabelInfo.label.slice(0, 4) !== "var:") {
                                values[currentLabelInfo.pos].labelVisibility = true;
                            }
                        }
                        if (["locator", "number"].indexOf(variable) === -1) {
                            if (CSL.STATUTE_SUBDIV_STRINGS[currentLabelInfo.label] !== variable && currentLabelInfo.label.slice(0, 4) !== "var:") {
                                values[0].labelVisibility = true;
                            }
                        }
                    } else {
                        if (values[i-1].label !== values[i].label && currentLabelInfo.label.slice(0, 4) !== "var:") {
                            values[currentLabelInfo.pos].labelVisibility = true;
                        }
                    }
                }
            }
        }
        fixNumericAndCount(values, values.length-1, currentLabelInfo);
        if (values.length && values[0].numeric && variable.slice(0, 10) === "number-of-") {
            if (parseInt(ItemObject[variable], 10) > 1) {
                values[0].plural = 1;
            }
        }
        for (var i=0,ilen=values.length;i<ilen;i++) {
            if (!values[i].numeric) {
                var origLabel = values[i].origLabel ? values[i].origLabel : "";
                values[i].value = (origLabel + values[i].value).trim();
                if (values[i].label !== values[0].label) {
                    values[i].label = "";
                }
            }
        }
    }        
    function setStyling(values) {
        var masterNode = CSL.Util.cloneToken(node);
        var masterStyling = new CSL.Token();
        if (!me.tmp.just_looking) {
            for (var j=masterNode.decorations.length-1;j>-1;j--) {
                if (masterNode.decorations[j][0] === "@quotes") {
                    masterStyling.decorations = masterStyling.decorations.concat(masterNode.decorations.slice(j, j+1));
                    masterNode.decorations = masterNode.decorations.slice(0, j).concat(masterNode.decorations.slice(j+1))
                }
            }
            masterStyling.strings.prefix = masterNode.strings.prefix;
            masterNode.strings.prefix = "";
            masterStyling.strings.suffix = masterNode.strings.suffix;
            masterNode.strings.suffix = "";
        }
        var masterLabel = values.length ? values[0].label : null;
        if (values.length) {
            for (var i=0,ilen=values.length; i<ilen; i++) {
                var val = values[i];
                var newnode = CSL.Util.cloneToken(masterNode);
                newnode.gender = node.gender;
                if (masterLabel === val.label) {
                    newnode.formatter = node.formatter;
                }
                if (val.numeric) {
                    newnode.successor_prefix = val.successor_prefix;
                }
                newnode.strings.suffix = newnode.strings.suffix + stripHyphenBackslash(val.joiningSuffix);
                val.styling = newnode;
            }
            if (!me.tmp.just_looking) {
                if (values[0].value.slice(0,1) === "\"" && values[values.length-1].value.slice(-1) === "\"") {
                    values[0].value = values[0].value.slice(1);
                    values[values.length-1].value = values[values.length-1].value.slice(0,-1);
                    masterStyling.decorations.push(["@quotes", true]);
                }
            }
        }
        return masterStyling;
    }
    function stripHyphenBackslash(joiningSuffix) {
        return joiningSuffix.replace("\\-", "-");
    }
    function fixupRangeDelimiter(variable, val, rangeDelimiter, isNumeric) {
        var isPage = checkPage(variable, val);
        var hasTerm = checkTerm(variable, val);
        if (hasTerm && rangeDelimiter === "-") {
            if (isNumeric) {
                if (isPage || ["locator", "issue", "volume", "edition", "number"].indexOf(variable) > -1) {
                    rangeDelimiter = me.getTerm("page-range-delimiter")
                    if (!rangeDelimiter) {
                        rangeDelimiter = "\u2013";
                    }
                }
                if (variable === "collection-number") {
                    rangeDelimiter = me.getTerm("year-range-delimiter");
                    if (!rangeDelimiter) {
                        rangeDelimiter = "\u2013";
                    }
                }
            }
        }
        return rangeDelimiter;
    }
    function checkPage(variable, val) {
        return variable === "page" 
            || (variable === "locator" && (["p."].indexOf(val.label) > -1));
    }
    function checkTerm(variable, val) {
        var ret = true;
        if (variable === "locator") {
            ret = !!me.getTerm(CSL.STATUTE_SUBDIV_STRINGS[val.label]);
        }
        return ret;
    }
    function manglePageNumbers(values, i, currentInfo) {
        if (i<1) return;
        if (currentInfo.count !== 2) {
            return;
        }
        if (values[i-1].particle !== values[i].particle) {
            return;
        }
        if (values[i-1].joiningSuffix !== "-") {
            currentInfo.count = 1;
            return;
        }
        if (!me.opt["page-range-format"] && parseInt(values[i-1].value, 10) > parseInt(values[i].value, 10)) {
            values[i-1].joiningSuffix = fixupRangeDelimiter(variable, values[i], values[i-1].joiningSuffix, true);
            return;
        }
        var val = values[i];
        var isPage = checkPage(variable, val);
        if (isPage) {
            var str = values[i-1].particle + values[i-1].value + " - " + values[i].particle + values[i].value;
            str = me.fun.page_mangler(str);
        } else {
            str = values[i-1].value + stripHyphenBackslash(values[i-1].joiningSuffix) + values[i].value;
        }
        var m = str.match(/^([a-zA-Z]?0*)([0-9]+)(\s*[^0-9]+\s*)([-,a-zA-Z]?0*)([0-9]+)$/);
        if (m) {
            var rangeDelimiter = m[3];
            rangeDelimiter = fixupRangeDelimiter(variable, val, rangeDelimiter, values[i].numeric);
            values[i-1].particle = m[1];
            values[i-1].value = m[2];
            values[i-1].joiningSuffix = rangeDelimiter;
            values[i].particle = m[4];
            values[i].value = m[5];
        }
        currentInfo.count = 0;
    }
    function fixRanges(values) {
        if (!node) return;
        if (["page", "page-first", "chapter-number", "collection-number", "edition", "issue", "number", "number-of-pages", "number-of-volumes", "volume", "locator"].indexOf(variable) === -1) return;
        var currentInfo = {
            count: 0,
            label: null,
            lastHadRangeDelimiter: false
        }
        for (var i=0,ilen=values.length; i<ilen; i++) {
            var val = values[i];
            if (!val.collapsible) {
                currentInfo.count = 0;
                currentInfo.label = null;
                var isNumeric = val.numeric;
                if (i<(values.length-1) && !isNumeric && val.value.match(/^[ivxlcmIVXLCM]+$/) && values[i+1].value.match(/^[ivxlcmIVXLCM]+$/)) {
                    isNumeric = true;
                }
                val.joiningSuffix = fixupRangeDelimiter(variable, val, val.joiningSuffix, isNumeric);
            } else if (currentInfo.label === val.label && val.joiningSuffix === "-") {
                currentInfo.count = 1;
            } else if (currentInfo.label === val.label && val.joiningSuffix !== "-") {
                currentInfo.count++;
                if (currentInfo.count === 2) {
                    manglePageNumbers(values, i, currentInfo);
                }
            } else if (currentInfo.label !== val.label) {
                currentInfo.label = val.label;
                currentInfo.count = 1;
            } else {
                currentInfo.count = 1;
                currentInfo.label = val.label;
            }
        }
        if (currentInfo.count === 2) {
            manglePageNumbers(values, values.length-1, currentInfo);
        }
    }
    function setVariableParams(shadow_numbers, variable, values) {
        var obj = shadow_numbers[variable];
        if (values.length) {
            obj.numeric = values[0].numeric;
            obj.collapsible = values[0].collapsible;
            obj.plural = values[0].plural;
            obj.label = CSL.STATUTE_SUBDIV_STRINGS[values[0].label];
            if (variable === "number" && obj.label === "issue" && me.getTerm("number")) {
                obj.label = "number";
            }
        }
    }
    if (node && this.tmp.shadow_numbers[variable] && this.tmp.shadow_numbers[variable].values.length) {
        var values = this.tmp.shadow_numbers[variable].values;
        fixRanges(values);
            this.tmp.shadow_numbers[variable].masterStyling = setStyling(values);
        return;
    }
    if (!this.tmp.shadow_numbers[variable]) {
        this.tmp.shadow_numbers[variable] = {
            values:[]
        };
    }
    if (!ItemObject) {
        return;
    }
    var languageRole = CSL.LangPrefsMap[variable];
    if (languageRole) {
        var localeType = this.opt["cite-lang-prefs"][languageRole][0];
        val = this.transform.getTextSubField(ItemObject, variable, "locale-"+localeType, true);
        val = val.name;
    } else {
        val = ItemObject[variable];
    }
    if (val && this.sys.getAbbreviation) {
        var jurisdiction = this.transform.loadAbbreviation(ItemObject.jurisdiction, "number", val);
        if (this.transform.abbrevs[jurisdiction].number) {
            if (this.transform.abbrevs[jurisdiction].number[val]) {
                val = this.transform.abbrevs[jurisdiction].number[val];
            } else {
                if ("undefined" !== typeof this.transform.abbrevs[jurisdiction].number[val]) {
                    delete this.transform.abbrevs[jurisdiction].number[val];
                }
            }
        }
    }
    if ("undefined" !== typeof val && ("string" === typeof val || "number" === typeof val)) {
        if ("number" === typeof val) {
            val = "" + val;
        }
        var defaultLabel = CSL.STATUTE_SUBDIV_STRINGS_REVERSE[variable];
        if (!this.tmp.shadow_numbers.values) {
            var values = parseString(val, defaultLabel);
            setSpaces(values);
            setPluralsAndNumerics(values);
            this.tmp.shadow_numbers[variable].values = values;
        }
        if (node) {
            fixRanges(values);
            this.tmp.shadow_numbers[variable].masterStyling = setStyling(values)
        }
        setVariableParams(this.tmp.shadow_numbers, variable, values);
    }
};
CSL.Util.outputNumericField = function(state, varname, itemID) {
    state.output.openLevel(state.tmp.shadow_numbers[varname].masterStyling);
    var nums = state.tmp.shadow_numbers[varname].values;
    var masterLabel = nums.length ? nums[0].label : null;
    var labelForm = state.tmp.shadow_numbers[varname].labelForm;
    var embeddedLabelForm;
    if (labelForm) {
        embeddedLabelForm = labelForm
    } else {
        embeddedLabelForm = "short";
    }
    var labelDecorations = state.tmp.shadow_numbers[varname].labelDecorations;
    var lastLabelName = null;
    for (var i=0,ilen=nums.length;i<ilen;i++) {
        var num = nums[i];
        var label = "";
        if (num.label) {
            var labelName;
            if ('var:' === num.label.slice(0,4)) {
                labelName = num.label.slice(4);
            } else {
                labelName = CSL.STATUTE_SUBDIV_STRINGS[num.label];
            }
            if (labelName) {
                if (num.label === masterLabel) {
                    label = state.getTerm(labelName, labelForm, num.plural);
                } else {
                    label = state.getTerm(labelName, embeddedLabelForm, num.plural);
                }
            }
        }
        var labelPlaceholderPos = -1;
        if (label) {
            labelPlaceholderPos = label.indexOf("%s");
        }
        var numStyling = CSL.Util.cloneToken(num.styling);
        numStyling.formatter = num.styling.formatter;
        numStyling.type = num.styling.type;
        numStyling.num = num.styling.num;
        numStyling.gender = num.styling.gender;
        if (labelPlaceholderPos > 0 && labelPlaceholderPos < (label.length-2)) {
            numStyling.strings.prefix += label.slice(0,labelPlaceholderPos);
            numStyling.strings.suffix = label.slice(labelPlaceholderPos+2) + numStyling.strings.suffix;
        } else if (num.labelVisibility) {
            if (!label) {
                label = num.label;
                labelName = num.label;
            }
            if (labelPlaceholderPos > 0) {
                var prefixLabelStyling = new CSL.Token();
                prefixLabelStyling.decorations = labelDecorations;
                state.output.append(label.slice(0,labelPlaceholderPos), prefixLabelStyling);
            } else if (labelPlaceholderPos === (label.length-2) || labelPlaceholderPos === -1) {
                state.output.append(label+num.labelSuffix, "empty");
            }
        }
        if (num.collapsible) {
            if (num.value.match(/^[0-9]+$/)) {
                var blob = new CSL.NumericBlob(num.particle, parseInt(num.value, 10), numStyling, itemID);
            } else {
                var blob = new CSL.NumericBlob(num.particle, num.value, numStyling, itemID);
            }
            if ("undefined" === typeof blob.gender) {
                blob.gender = state.locale[state.opt.lang]["noun-genders"][varname];
            }
            state.output.append(blob, "literal");
        } else {
            state.output.append(num.particle + num.value, numStyling)
        }
        if (labelPlaceholderPos === 0 && labelPlaceholderPos < (label.length-2)) {
            if (lastLabelName === null) {
                lastLabelName = labelName;
            }
            if (labelName !== lastLabelName || i === (nums.length-1)) {
                var suffixLabelStyling = new CSL.Token();
                suffixLabelStyling.decorations = labelDecorations;
                state.output.append(label.slice(labelPlaceholderPos+2), suffixLabelStyling);
            }
        }
        lastLabelName === labelName;
    }
    state.output.closeLevel();
}
module.exports = CSL;
CSL.Util.PageRangeMangler = {};
CSL.Util.PageRangeMangler.getFunction = function (state, rangeType) {
    var rangerex, pos, len, stringify, listify, expand, minimize, minimize_internal, chicago, lst, m, b, e, ret, begin, end, ret_func, ppos, llen;
    var range_delimiter = state.getTerm(rangeType + "-range-delimiter");
    rangerex = /([a-zA-Z]*)([0-9]+)\s*(?:\u2013|-)\s*([a-zA-Z]*)([0-9]+)/;
    stringify = function (lst) {
        len = lst.length;
        for (pos = 1; pos < len; pos += 2) {
            if ("object" === typeof lst[pos]) {
                lst[pos] = lst[pos].join("");
            }
        }
        var ret = lst.join("");
        ret = ret.replace(/([^\\])\-/g, "$1"+state.getTerm(rangeType + "-range-delimiter"));
        return ret;
    };
    listify = function (str) {
        var m, lst, ret;
        var hyphens = "\\s+\\-\\s+";
        var this_range_delimiter = range_delimiter === "-" ? "" : range_delimiter;
        var delimRex = new RegExp("([^\\\\])[-" + this_range_delimiter + "\\u2013]", "g");
        str = str.replace(delimRex, "$1 - ").replace(/\s+-\s+/g, " - ");
        var rexm = new RegExp("([a-zA-Z]*[0-9]+" + hyphens + "[a-zA-Z]*[0-9]+)", "g");
        var rexlst = new RegExp("[a-zA-Z]*[0-9]+" + hyphens + "[a-zA-Z]*[0-9]+");
        m = str.match(rexm);
        lst = str.split(rexlst);
        if (lst.length === 0) {
            ret = m;
        } else {
            ret = [lst[0]];
            for (pos = 1, len = lst.length; pos < len; pos += 1) {
                ret.push(m[pos - 1].replace(/\s*\-\s*/g, "-"));
                ret.push(lst[pos]);
            }
        }
        return ret;
    };
    expand = function (str) {
        str = "" + str;
        lst = listify(str);
        len = lst.length;
        for (pos = 1; pos < len; pos += 2) {
            m = lst[pos].match(rangerex);
            if (m) {
                if (!m[3] || m[1] === m[3]) {
                    if (m[4].length < m[2].length) {
                        m[4] = m[2].slice(0, (m[2].length - m[4].length)) + m[4];
                    }
                    if (parseInt(m[2], 10) < parseInt(m[4], 10)) {
                        m[3] = range_delimiter + m[1];
                        lst[pos] = m.slice(1);
                    }
                }
            }
            if ("string" === typeof lst[pos]) {
                lst[pos] = lst[pos].replace(/\-/g, range_delimiter);
            }
        }
        return lst;
    };
    minimize = function (lst, minchars, isyear) {
        len = lst.length;
        for (var i = 1, ilen = lst.length; i < ilen; i += 2) {
            lst[i][3] = minimize_internal(lst[i][1], lst[i][3], minchars, isyear);
            if (lst[i][2].slice(1) === lst[i][0]) {
                lst[i][2] = range_delimiter;
            }
        }
        return stringify(lst);
    };
    minimize_internal = function (begin, end, minchars, isyear) {
        if (!minchars) {
            minchars = 0;
        }
        b = ("" + begin).split("");
        e = ("" + end).split("");
        ret = e.slice();
        ret.reverse();
        if (b.length === e.length) {
            for (var i = 0, ilen = b.length; i < ilen; i += 1) {
                if (b[i] === e[i] && ret.length > minchars) {
                    ret.pop();
                } else {
                    if (minchars && isyear && ret.length === 3) {
                        var front = b.slice(0, i);
                        front.reverse();
                        ret = ret.concat(front);
                    }
                    break;
                }
            }
        }
        ret.reverse();
        return ret.join("");
    };
    chicago = function (lst) {
        len = lst.length;
        for (pos = 1; pos < len; pos += 2) {
            if ("object" === typeof lst[pos]) {
                m = lst[pos];
                begin = parseInt(m[1], 10);
                end = parseInt(m[3], 10);
                if (begin > 100 && begin % 100 && parseInt((begin / 100), 10) === parseInt((end / 100), 10)) {
                    m[3] = "" + (end % 100);
                } else if (begin >= 10000) {
                    m[3] = "" + (end % 1000);
                }
            }
            if (m[2].slice(1) === m[0]) {
                m[2] = range_delimiter;
            }
        }
        return stringify(lst);
    };
    var sniff = function (str, func, minchars, isyear) {
        var ret;
		str = "" + str;
		var lst = expand(str);
        var ret = func(lst, minchars, isyear);
        return ret;
    }
    if (!state.opt[rangeType + "-range-format"]) {
        ret_func = function (str) {
            return sniff(str, stringify);
        };
    } else if (state.opt[rangeType + "-range-format"] === "expanded") {
        ret_func = function (str) {
            return sniff(str, stringify);
        };
    } else if (state.opt[rangeType + "-range-format"] === "minimal") {
        ret_func = function (str) {
            return sniff(str, minimize);
        };
    } else if (state.opt[rangeType + "-range-format"] === "minimal-two") {
        ret_func = function (str, isyear) {
            return sniff(str, minimize, 2, isyear);
        };
    } else if (state.opt[rangeType + "-range-format"] === "chicago") {
        ret_func = function (str) {
            return sniff(str, chicago);
        };
    }
    return ret_func;
};
module.exports = CSL;
CSL.Util.FlipFlopper = function(state) {
    this.processTags = processTags;
    var _nestingState = [];
    var _nestingData = {
        "<span class=\"nocase\">": {
            type: "nocase",
            opener: "<span class=\"nocase\">",
            closer: "</span>",
            attr: null,
            outer: null,
            flipflop: null
        },
        "<span class=\"nodecor\">": {
            type: "nodecor",
            opener: "<span class=\"nodecor\">",
            closer: "</span>",
            attr: "@class",
            outer: "nodecor",
            flipflop: {
                "nodecor": "nodecor"
            }
        },
        "<span style=\"font-variant:small-caps;\">": {
            type: "tag",
            opener: "<span style=\"font-variant:small-caps;\">",
            closer: "</span>",
            attr: "@font-variant",
            outer: "small-caps",
            flipflop: {
                "small-caps": "normal",
                "normal": "small-caps"
            }
        },
        "<sc>": {
            type: "tag",
            opener: "<sc>",
            closer: "</sc>",
            attr: "@font-variant",
            outer: "small-caps",
            flipflop: {
                "small-caps": "normal",
                "normal": "small-caps"
            }
        },
        "<i>": {
            type: "tag",
            opener: "<i>",
            closer: "</i>",
            attr: "@font-style",
            outer: "italic",
            flipflop: {
                "italic": "normal",
                "normal": "italic"
            }
        },
        "<b>": {
            type: "tag",
            opener: "<b>",
            closer: "</b>",
            attr: "@font-weight",
            outer: "bold",
            flipflop: {
                "bold": "normal",
                "normal": "bold"
            }
        },
        "<sup>": {
            type: "tag",
            opener: "<sup>",
            closer: "</sup>",
            attr: "@vertical-align",
            outer: "sup",
            flipflop: {
                "sub": "sup",
                "sup": "sup"
            }
        },
        "<sub>": {
            type: "tag",
            opener: "<sub>",
            closer: "</sub>",
            attr: "@vertical-align",
            outer: "sub",
            flipflop: {
                "sup": "sub",
                "sub": "sub"
            }
        },
        " \"": {
            type: "quote",
            opener: " \"",
            closer: "\"",
            attr: "@quotes",
            outer: "true",
            flipflop: {
                "true": "inner",
                "inner": "true",
                "false": "true"
            }
        },
        " \'": {
            type: "quote",
            opener: " \'",
            closer: "\'",
            attr: "@quotes",
            outer: "inner",
            flipflop: {
                "true": "inner",
                "inner": "true",
                "false": "true"
            }
        }
    }
    _nestingData["(\""] = _nestingData[" \""]
    _nestingData["(\'"] = _nestingData[" \'"]
    var localeOpenQuote = state.getTerm("open-quote");
    var localeCloseQuote = state.getTerm("close-quote");
    var localeOpenInnerQuote = state.getTerm("open-inner-quote");
    var localeCloseInnerQuote = state.getTerm("close-inner-quote");
    if (localeOpenQuote && localeCloseQuote && [" \""," \'","\"","\'"].indexOf(localeOpenQuote) === -1) {
        _nestingData[localeOpenQuote] = JSON.parse(JSON.stringify(_nestingData[" \""]));
        _nestingData[localeOpenQuote].opener = localeOpenQuote;
        _nestingData[localeOpenQuote].closer = localeCloseQuote;
    }
    if (localeOpenInnerQuote && localeCloseInnerQuote && [" \""," \'","\"","\'"].indexOf(localeOpenInnerQuote) === -1) {
        _nestingData[localeOpenInnerQuote] = JSON.parse(JSON.stringify(_nestingData[" \'"]));
        _nestingData[localeOpenInnerQuote].opener = localeOpenInnerQuote;
        _nestingData[localeOpenInnerQuote].closer = localeCloseInnerQuote;
    }
    var _nestingQuoteReverse = function() {
        var ret = {};
        var keys = Object.keys(_nestingData);
        for (var i = 0, l = keys.length; i < l; i++) {
            var key = keys[i];
            if (_nestingData[key].type === "quote") {
                ret[_nestingData[key].closer] = _nestingData[key];
            }
        }
        return ret;
    }();
    var _nestingDataAttr = function() {
        var ret = {};
        var keys = Object.keys(_nestingData);
        for (var i = 0, l = keys.length; i < l; i++) {
            var key = keys[i];
            if (_nestingData[key].type === "nocase") continue;
            var attr = _nestingData[key].attr;
            var outer = _nestingData[key].outer;
            var inner = _nestingData[key].flipflop[_nestingData[key].outer];
            ret[attr + "/" + outer] = _nestingData[key];
            ret[attr + "/" + inner] = _nestingData[key];
        }
        return ret;
    }();
    function _setOuterQuoteForm(quot) {
        var flip = {
            " \'": " \"",
            " \"": " \'",
            "(\"": "(\'",
            "(\'": "(\""
        }
        _nestingData[quot].outer = "true";
        _nestingData[flip[quot]].outer = "inner";
    }
    function _getNestingOpenerParams(opener) {
        var openers = [];
        var closer;
        var keys = Object.keys(_nestingData);
        for (var i = 0, l = keys.length; i < l; i++) {
            var key = keys[i];
            if (_nestingData[opener].type !== "quote" || !_nestingData[opener]) {
                openers.push(key);
            }
        }
        var ret = _nestingData[opener];
        ret.opener = new RegExp("^(?:" + openers.map(function(str){return str.replace("(", "\\(")}).join("|") + ")"); 
        return ret;
    }
    var _nestingParams = function() {
        var ret = {};
        var keys = Object.keys(_nestingData);
        for (var i = 0, l = keys.length; i < l; i++) {
            var key = keys[i];
            ret[key] = _getNestingOpenerParams(key);
        }
        return ret;
    }()
    var _tagRex = function() {
        var openers = [];
        var closers = [];
        var vals = {};
        for (var opener in _nestingParams) {
            openers.push(opener);
            vals[_nestingParams[opener].closer] = true;
        }
        var keys = Object.keys(vals);
        for (var i = 0, l = keys.length; i < l; i++) {
            var closer = keys[i];
            closers.push(closer);
        }
        var all = openers.concat(closers).map(function(str){return str.replace("(", "\\(")}).join("|");
        return {
            matchAll: new RegExp("((?:" + all + "))", "g"),
            splitAll: new RegExp("(?:" + all + ")", "g"),
            open: new RegExp("(^(?:" + openers.map(function(str){return str.replace("(", "\\(")}).join("|") + ")$)"),
            close: new RegExp("(^(?:" + closers.join("|") + ")$)"),
        }
    }();
    function _nestingFix (tag, pos) {
        return _pushNestingState(tag, pos);
    }
    function _pushNestingState(tag, pos) {
        if (tag.match(_tagRex.open)) {
            return _tryOpen(tag, pos);
        } else {
            return _tryClose(tag, pos);
        }
    }
    function _tryOpen(tag, pos) {
        var params = _nestingState[_nestingState.length - 1];
        if (!params || tag.match(params.opener)) {
            _nestingState.push({
                type: _nestingParams[tag].type,
                opener: _nestingParams[tag].opener,
                closer: _nestingParams[tag].closer,
                pos: pos
            });
            return false;
        } else {
            _nestingState.pop()
            _nestingState.push({
                type: _nestingParams[tag].type,
                opener: _nestingParams[tag].opener,
                closer: _nestingParams[tag].closer,
                pos: pos
            });
            return {
                fixtag: params.pos
            };
        }
    }
    function _tryClose(tag, pos) {
        var params = _nestingState[_nestingState.length - 1];
        if (params && tag === params.closer) {
            _nestingState.pop()
            if (params.type === "nocase") {
                return {
                    nocase: {
                        open: params.pos,
                        close: pos
                    }
                }
            } else {
                return false;
            }
        } else {
            if (params) {
                return {
                    fixtag: params.pos
                };
            } else {
                return {
                    fixtag: pos
                };
            }
        }
    }
    function _doppelString(str) {
        var forcedSpaces = [];
        str = str.replace(/(<span)\s+(style=\"font-variant:)\s*(small-caps);?\"[^>]*(>)/g, "$1 $2$3;\"$4");
        str = str.replace(/(<span)\s+(class=\"no(?:case|decor)\")[^>]*(>)/g, "$1 $2$3");
        var match = str.match(_tagRex.matchAll);
        if (!match) {
            return {
                tags: [],
                strings: [str],
                forcedSpaces: []
            };
        }
        var split = str.split(_tagRex.splitAll);
        for (var i=0,ilen=match.length-1;i<ilen;i++) {
            if (_nestingData[match[i]]) {
                if (split[i+1] === "" && ["\"", "'"].indexOf(match[i+1]) > -1) {
                    match[i+1] = " " + match[i+1]
                    forcedSpaces.push(true);
                } else {
                    forcedSpaces.push(false);
                }
            }
        }
        return {
            tags: match,
            strings: split,
            forcedSpaces: forcedSpaces
        }
    }
    function _undoppelString(obj) {
        var lst = obj.strings.slice(-1);
        for (var i=obj.tags.length-1; i>-1; i+=-1) {
            lst.push(obj.tags[i]);
            lst.push(obj.strings[i]);
        }
        lst.reverse();
        return lst.join("|");
    }
    var _TagReg = function(blob) {
        this.set = set;
        this.pair = pair;
        this.pop = pop;
        var _stack = [];
        function set(tag) {
            var attr = _nestingData[tag].attr;
            var decor = null;
            for (var i=_stack.length-1;i>-1;i--) {
                var _decor = _stack[i];
                if (_decor[0] === attr) {
                    decor = _decor;
                    break;
                }
            }
            if (!decor) {
                var allTheDecor = [state[state.tmp.area].opt.layout_decorations].concat(blob.alldecor)
                outer:
                for (var i=allTheDecor.length-1;i>-1;i--) {
                    var decorset = allTheDecor[i];
                    if (!decorset) continue;
                    for (var j=decorset.length-1;j>-1;j--) {
                        var _decor = decorset[j];
                        if (_decor[0] === attr) {
                            decor = _decor;
                            break outer;
                        }
                    }
                }
            }
            if (!decor) {
                decor = [attr, _nestingData[tag].outer];
            } else {
                decor = [attr, _nestingData[tag].flipflop[decor[1]]];
            }
            _stack.push(decor);
        }
        function pair() {
            return _stack[_stack.length-1];
        }
        function pop() {
            _stack.pop();
        }
    }
    function _apostropheForce(tag, str) {
        if (tag === "\'") {
            if (str && str.match(/^[^\,\.\?\:\;\ ]/)) {
                return true;
            }
        } else if (tag === " \'" && str && str.match(/^[\ ]/)) {
            return true;
        }
        return false;
    }
    function _undoppelToQueue(blob, doppel, leadingSpace) {
        var TOP = blob;
        var firstString = true;
        var tagReg = new _TagReg(blob);
        blob.blobs = [];
        function Stack (blob) {
            this.stack = [blob];
            this.latest = blob;
            this.addStyling = function(str, decor, forcedSpace) {
                if (firstString) {
                    if (str.slice(0, 1) === " ") {
                        str = str.slice(1);
                    }
                    if (str.slice(0, 1) === " ") {
                        str = str.slice(1);
                    }
                    firstString = false;
                }
                this.latest = this.stack[this.stack.length-1];
                if (decor) {
                    if ("string" === typeof this.latest.blobs) {
                        var child = new CSL.Blob();
                        child.blobs = this.latest.blobs;
                        child.alldecor = this.latest.alldecor.slice();
                        this.latest.blobs = [child];
                    }
                    var tok = new CSL.Token();
                    var newblob = new CSL.Blob(null, tok);
                    newblob.alldecor = this.latest.alldecor.slice();
                    if (decor[0] === "@class" && decor[1] === "nodecor") {
                        var newdecorset = [];
                        var seen = {};
                        var allTheDecor = [state[state.tmp.area].opt.layout_decorations].concat(newblob.alldecor)
                        for (var i=allTheDecor.length-1;i>-1;i--) {
                            var _decorset = allTheDecor[i];
                            if (!_decorset) continue;
                            for (var j=_decorset.length-1;j>-1;j--) {
                                var _olddecor = _decorset[j];
                                if (["@font-weight", "@font-style", "@font-variant"].indexOf(_olddecor[0]) > -1
                                    && !seen[_olddecor[0]]) {
                                    if (decor[1] !== "normal") {
                                        newblob.decorations.push([_olddecor[0], "normal"]);
                                        newdecorset.push([_olddecor[0], "normal"])
                                    }
                                    seen[_olddecor[0]] = true;
                                }
                            }
                        }
                        newblob.alldecor.push(newdecorset);
                    } else {
                        newblob.decorations.push(decor);
                        newblob.alldecor.push([decor]);
                    }
                    this.latest.blobs.push(newblob);
                    this.stack.push(newblob);
                    this.latest = newblob;
                    if (str) {
                        var tok = new CSL.Token();
                        var newblob = new CSL.Blob(null, tok);
                        newblob.blobs = str;
                        newblob.alldecor = this.latest.alldecor.slice();
                        this.latest.blobs.push(newblob);
                    }
                } else {
                    if (str) {
                        var child = new CSL.Blob();
                        child.blobs = str;
                        child.alldecor = this.latest.alldecor.slice();
                        this.latest.blobs.push(child);
                    }
                }
            }
            this.popStyling = function() {
                this.stack.pop();
            }
        };
        var stack = new Stack(blob);
        if (doppel.strings.length) {
            var str = doppel.strings[0];
            if (leadingSpace) {
                str = " " + str;
            }
            stack.addStyling(str);
        }
        for (var i=0,ilen=doppel.tags.length;i<ilen;i++) {
            var tag = doppel.tags[i];
            var str = doppel.strings[i+1];
            if (tag.match(_tagRex.open)) {
                tagReg.set(tag);
                stack.addStyling(str, tagReg.pair());
            } else {
                tagReg.pop();
                stack.popStyling();
                stack.addStyling(str);
            }
        }
    }
    function processTags(blob) {
        var str = blob.blobs;
        var leadingSpace = false;
        if (str.slice(0, 1) === " " && !str.match(/^\s+[\'\"]/)) {
            leadingSpace = true;
        }
        var str = " " + str;
        var doppel = _doppelString(str);
        if (doppel.tags.length === 0) return;
        var quoteFormSeen = false;
    	for (var i=0,ilen=doppel.tags.length;i<ilen;i++) {
            var tag = doppel.tags[i];
            var str = doppel.strings[i+1];
            if (_apostropheForce(tag, str)) {
                if (tag === " \'") {
                    doppel.strings[i+1] = " \u2019" + doppel.strings[i+1];
                } else {
                    doppel.strings[i+1] = "\u2019" + doppel.strings[i+1];
                }
                doppel.tags[i] = "";
            } else {
                var tagInfo;
                while (true) {
                    tagInfo = _nestingFix(tag, i);
                    if (tagInfo) {
                        if (Object.keys(tagInfo).indexOf("fixtag") > -1) {
                            if (tag.match(_tagRex.close)
                                && tag === "\'") {
                                doppel.strings[i+1] = "\u2019" + doppel.strings[i+1];
                                doppel.tags[i] = "";
                            } else {
                                var failedTag = doppel.tags[tagInfo.fixtag];
                                if (doppel.forcedSpaces[tagInfo.fixtag-1]) {
                                    failedTag = failedTag.slice(1);
                                }
                                doppel.strings[tagInfo.fixtag+1] = failedTag + doppel.strings[tagInfo.fixtag+1];
                                doppel.tags[tagInfo.fixtag] = "";
                            }
                            if (_nestingState.length > 0) {
                                _nestingState.pop();
                            } else {
                                break;
                            }
                        } else if (tagInfo.nocase) {
                            doppel.tags[tagInfo.nocase.open] = "";
                            doppel.tags[tagInfo.nocase.close] = "";
                            break;
                        } else {
                            break;
                        }
                    } else {
                        break;
                    }
                }
                if (tagInfo && (tagInfo.fixtag|| tagInfo.fixtag === 0)) {
                    doppel.strings[i+1] = doppel.tags[i] + doppel.strings[i+1];
                    doppel.tags[i] = "";
                }
            }
        }
        for (var i=_nestingState.length-1;i>-1;i--) {
            var tagPos = _nestingState[i].pos
            var tag = doppel.tags[tagPos];
            if (tag === " \'" || tag === "\'") {
                doppel.strings[tagPos+1] = " \u2019" + doppel.strings[tagPos+1];
            } else {
                doppel.strings[tagPos+1] = doppel.tags[tagPos] + doppel.strings[tagPos+1];
            }
            doppel.tags[tagPos] = "";
            _nestingState.pop();
        }
        for (var i=doppel.tags.length-1;i>-1;i--) {
            if (!doppel.tags[i]) {
                doppel.tags = doppel.tags.slice(0,i).concat(doppel.tags.slice(i+1));
                doppel.strings[i] = doppel.strings[i] + doppel.strings[i+1];
                doppel.strings = doppel.strings.slice(0,i+1).concat(doppel.strings.slice(i+2));
            }
        }
        for (var i=0,ilen=doppel.tags.length;i<ilen;i++) {
            var tag = doppel.tags[i];
            var forcedSpace = doppel.forcedSpaces[i-1];
            if ([" \"", " \'", "(\"", "(\'"].indexOf(tag) > -1) {
                if (!quoteFormSeen) {
                    _setOuterQuoteForm(tag);
                    quoteFormSeen = true;
                }
                if (!forcedSpace) {
                    doppel.strings[i] += tag.slice(0, 1);
                }
            }
        }
        _undoppelToQueue(blob, doppel, leadingSpace);
    }
}
module.exports = CSL;
CSL.Output.Formatters = new function () {
    this.passthrough = passthrough;
    this.lowercase = lowercase;
    this.uppercase = uppercase;
    this.sentence = sentence;
    this.title = title;
    this["capitalize-first"] = capitalizeFirst;
    this["capitalize-all"] = capitalizeAll;
    var rexStr = "(?:\u2018|\u2019|\u201C|\u201D| \"| \'|\"|\'|[-\–\—\/.,;?!:]|\\[|\\]|\\(|\\)|<span style=\"font-variant: small-caps;\">|<span class=\"no(?:case|decor)\">|<\/span>|<\/?(?:i|sc|b|sub|sup)>)";
    var tagDoppel = new CSL.Doppeler(rexStr, function(str) {
        return str.replace(/(<span)\s+(class=\"no(?:case|decor)\")[^>]*(>)/g, "$1 $2$3").replace(/(<span)\s+(style=\"font-variant:)\s*(small-caps);?(\")[^>]*(>)/g, "$1 $2 $3;$4$5");
    });
    var wordDoppel = new CSL.Doppeler("(?:[\u0020\u00A0\u2000-\u200B\u205F\u3000]+)");
    var _tagParams = {
        "<span style=\"font-variant: small-caps;\">": "</span>",
        "<span class=\"nocase\">": "</span>",
        "<span class=\"nodecor\">": "</span>"
    }
    function _capitalise (word, force) {
        var m = word.match(/(^\s*)((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]))(.*)/);
        if (m && !(m[2].match(/^[\u0370-\u03FF]$/) && !m[3])) {
            return m[1] + m[2].toUpperCase() + m[3];
        }
        return word;
    }
    function _textcaseEngine(config, string) {
        if (!string) {
            return "";
        }
        config.doppel = tagDoppel.split(string);
        var quoteParams = {
            " \"": {
                opener: " \'",
                closer: "\""
            },
            " \'": {
                opener: " \"",
                closer: "\'"
            },
            "\u2018": {
                opener: "\u2018",
                closer: "\u2019"
            },
            "\u201C": {
                opener: "\u201C",
                closer: "\u201D"
            },
        }
        function quoteFix (tag, positions) {
            var m = tag.match(/(^(?:\u2018|\u2019|\u201C|\u201D|\"|\')|(?: \"| \')$)/);
            if (m) {
                return pushQuoteState(m[1], positions);
            }
        }
        function pushQuoteState(tag, pos) {
            var isOpener = ["\u201C", "\u2018", " \"", " \'"].indexOf(tag) > -1 ? true : false;
            if (isOpener) {
                return tryOpen(tag, pos);
            } else {
                return tryClose(tag, pos);
            }
        }
        function tryOpen(tag, pos) {
            if (config.quoteState.length === 0 || tag === config.quoteState[config.quoteState.length - 1].opener) {
                config.quoteState.push({
                    opener: quoteParams[tag].opener,
                    closer: quoteParams[tag].closer,
                    pos: pos
                });
                return false;
            } else {
                var prevPos = config.quoteState[config.quoteState.length-1].pos;
                config.quoteState.pop()
                config.quoteState.push({
                    opener: quoteParams[tag].opener,
                    closer: quoteParams[tag].closer,
                    positions: pos
                });
                return prevPos;
            }
        }
        function tryClose(tag, pos) {
            if (config.quoteState.length > 0 && tag === config.quoteState[config.quoteState.length - 1].closer) {
                config.quoteState.pop()
            } else {
                return pos;
            }
        }
        if (config.doppel.strings.length && config.doppel.strings[0].trim()) {
            config.doppel.strings[0] = config.capitaliseWords(config.doppel.strings[0], 0, config.doppel.tags[0]);
        }
    	for (var i=0,ilen=config.doppel.tags.length;i<ilen;i++) {
            var tag = config.doppel.tags[i];
            var str = config.doppel.strings[i+1];
            if (config.tagState !== null) {
                if (_tagParams[tag]) {
                    config.tagState.push(_tagParams[tag]);
                } else if (config.tagState.length && tag === config.tagState[config.tagState.length - 1]) {
                    config.tagState.pop();
                }
            }
            if (config.afterPunct !== null) {
                if (tag.match(/[\!\?\:]$/)) {
                    config.afterPunct = true;
                }
            }
            if (config.tagState.length === 0) {
                config.doppel.strings[i+1] = config.capitaliseWords(str, i+1, config.doppel,config.doppel.tags[i+1]);
            } else if (config.doppel.strings[i+1].trim()) {
                config.lastWordPos = null;
            }
            if (config.quoteState !== null) {
                var quotePos = quoteFix(tag, i);
                if (quotePos || quotePos === 0) {
                    var origChar = config.doppel.origStrings[quotePos+1].slice(0, 1);
                    config.doppel.strings[quotePos+1] = origChar + config.doppel.strings[quotePos+1].slice(1);
                    config.lastWordPos = null;
                }
            }
            if (config.isFirst) {
                if (str.trim()) {
                    config.isFirst = false;
                }
            }
            if (config.afterPunct) {
                if (str.trim()) {
                    config.afterPunct = false;
                }
            }
        }
        if (config.quoteState) {
            for (var i=0,ilen=config.quoteState.length;i<ilen;i++) {
                var quotePos = config.quoteState[i].pos;
                if (typeof quotePos !== 'undefined') {
                    var origChar = config.doppel.origStrings[quotePos+1].slice(0, 1);
                    config.doppel.strings[quotePos+1] = origChar + config.doppel.strings[quotePos+1].slice(1);
                }
            }
        }
        if (config.lastWordPos) {
            var lastWords = wordDoppel.split(config.doppel.strings[config.lastWordPos.strings]);
            var lastWord = _capitalise(lastWords.strings[config.lastWordPos.words]);
            lastWords.strings[config.lastWordPos.words] = lastWord;
            config.doppel.strings[config.lastWordPos.strings] = wordDoppel.join(lastWords);
        }
        return tagDoppel.join(config.doppel);
    }
    function passthrough (state, str) {
        return str;
    }
    function lowercase(state, string) {
        var config = {
            quoteState: null,
            capitaliseWords: function(str) {
                var words = str.split(" ");
                for (var i=0,ilen=words.length;i<ilen;i++) {
                    var word = words[i];
                    if (word) {
                        words[i] = word.toLowerCase();
                    }
                }
                return words.join(" ");
            },
            skipWordsRex: null,
            tagState: [],
            afterPunct: null,
            isFirst: null
        }
        return _textcaseEngine(config, string);
    }
    function uppercase(state, string) {
        var config = {
            quoteState: null,
            capitaliseWords: function(str) {
                var words = str.split(" ");
                for (var i=0,ilen=words.length;i<ilen;i++) {
                    var word = words[i];
                    if (word) {
                        words[i] = word.toUpperCase();
                    }
                }
                return words.join(" ");
            },
            skipWordsRex: null,
            tagState: [],
            afterPunct: null,
            isFirst: null
        }
        return _textcaseEngine(config, string);
    }
    function sentence(state, string) {
        var config = {
            quoteState: [],
            capitaliseWords: function(str) {
                var words = str.split(" ");
                for (var i=0,ilen=words.length;i<ilen;i++) {
                    var word = words[i];
                    if (word) {
                        if (config.isFirst) {
                            words[i] = _capitalise(word);
                            config.isFirst = false;
                        } else {
                            words[i] = word.toLowerCase();
                        }
                    }
                }
                return words.join(" ");
            },
            skipWordsRex: null,
            tagState: [],
            afterPunct: null,
            isFirst: true
        }
        return _textcaseEngine(config, string);
    }
    function title(state, string) {
        var config = {
            quoteState: [],
            capitaliseWords: function(str, i, followingTag) {
                if (str.trim()) {
                    var words = str.split(/[ \u00A0]+/);
                    var wordle = wordDoppel.split(str);
                    var words = wordle.strings;
                    for (var j=0,jlen=words.length;j<jlen;j++) {
                        var word = words[j];
                        if (!word) continue;
                        if (word.length > 1 && !word.toLowerCase().match(config.skipWordsRex)) {
                            words[j] = _capitalise(words[j]);
                        } else if (j === (words.length - 1) && followingTag === "-") {
                            words[j] = _capitalise(words[j]);
                        } else if (config.isFirst) {
                            words[j] = _capitalise(words[j]);
                        } else if (config.afterPunct) {
                            words[j] = _capitalise(words[j]);
                        }
                        config.afterPunct = false;
                        config.isFirst = false;
                        config.lastWordPos = {
                            strings: i,
                            words: j
                        }
                    }
                    str = wordDoppel.join(wordle);
                }
                return str;
            },
            skipWordsRex: state.locale[state.opt.lang].opts["skip-words-regexp"],
            tagState: [],
            afterPunct: false,
            isFirst: true
        }
        return _textcaseEngine(config, string);
    }
    function capitalizeFirst(state, string) {
        var config = {
            quoteState: [],
            capitaliseWords: function(str) {
                var words = str.split(" ");
                for (var i=0,ilen=words.length;i<ilen;i++) {
                    var word = words[i];
                    if (word) {
                        if (config.isFirst) {
                            words[i] = _capitalise(word);
                            config.isFirst = false;
                            break;
                        }
                    }
                }
                return words.join(" ");
            },
            skipWordsRex: null,
            tagState: [],
            afterPunct: null,
            isFirst: true
        }
        return _textcaseEngine(config, string);
    }
    function capitalizeAll (state, string) {
        var config = {
            quoteState: [],
            capitaliseWords: function(str) {
                var words = str.split(" ");
                for (var i=0,ilen=words.length;i<ilen;i++) {
                    var word = words[i];
                    if (word) {
                        words[i] = _capitalise(word);
                    }
                }
                return words.join(" ");
            },
            skipWordsRex: null,
            tagState: [],
            afterPunct: null,
            isFirst: null
        }
        return _textcaseEngine(config, string);
    }
}
module.exports = CSL;
CSL.Output.Formats = function () {};
CSL.Output.Formats.prototype.html = {
    "text_escape": function (text) {
        if (!text) {
            text = "";
        }
        return text.replace(/&/g, "&#38;")
            .replace(/</g, "&#60;")
            .replace(/>/g, "&#62;")
            .replace(/\s\s/g, "\u00A0 ")
            .replace(CSL.SUPERSCRIPTS_REGEXP,
                     function(aChar) {
                         return "<sup>" + CSL.SUPERSCRIPTS[aChar] + "</sup>";
                     });
    },
    "bibstart": "<div class=\"csl-bib-body\">\n",
    "bibend": "</div>",
    "@font-style/italic": "<i>%%STRING%%</i>",
    "@font-style/oblique": "<em>%%STRING%%</em>",
    "@font-style/normal": "<span style=\"font-style:normal;\">%%STRING%%</span>",
    "@font-variant/small-caps": "<span style=\"font-variant:small-caps;\">%%STRING%%</span>",
    "@passthrough/true": CSL.Output.Formatters.passthrough,
    "@font-variant/normal": "<span style=\"font-variant:normal;\">%%STRING%%</span>",
    "@font-weight/bold": "<b>%%STRING%%</b>",
    "@font-weight/normal": "<span style=\"font-weight:normal;\">%%STRING%%</span>",
    "@font-weight/light": false,
    "@text-decoration/none": "<span style=\"text-decoration:none;\">%%STRING%%</span>",
    "@text-decoration/underline": "<span style=\"text-decoration:underline;\">%%STRING%%</span>",
    "@vertical-align/sup": "<sup>%%STRING%%</sup>",
    "@vertical-align/sub": "<sub>%%STRING%%</sub>",
    "@vertical-align/baseline": "<span style=\"baseline\">%%STRING%%</span>",
    "@strip-periods/true": CSL.Output.Formatters.passthrough,
    "@strip-periods/false": CSL.Output.Formatters.passthrough,
    "@quotes/true": function (state, str) {
        if ("undefined" === typeof str) {
            return state.getTerm("open-quote");
        }
        return state.getTerm("open-quote") + str + state.getTerm("close-quote");
    },
    "@quotes/inner": function (state, str) {
        if ("undefined" === typeof str) {
            return "\u2019";
        }
        return state.getTerm("open-inner-quote") + str + state.getTerm("close-inner-quote");
    },
    "@quotes/false": false,
    "@cite/entry": function (state, str) {
        return state.sys.wrapCitationEntry(str, this.item_id, this.locator_txt, this.suffix_txt);
	},
    "@bibliography/entry": function (state, str) {
        var insert = "";
        if (state.sys.embedBibliographyEntry) {
            insert = state.sys.embedBibliographyEntry(this.item_id) + "\n";
        }
        return "  <div class=\"csl-entry\">" + str + "</div>\n" + insert;
    },
    "@display/block": function (state, str) {
        return "\n\n    <div class=\"csl-block\">" + str + "</div>\n";
    },
    "@display/left-margin": function (state, str) {
        return "\n    <div class=\"csl-left-margin\">" + str + "</div>";
    },
    "@display/right-inline": function (state, str) {
        return "<div class=\"csl-right-inline\">" + str + "</div>\n  ";
    },
    "@display/indent": function (state, str) {
        return "<div class=\"csl-indent\">" + str + "</div>\n  ";
    },
    "@showid/true": function (state, str, cslid) {
        if (!state.tmp.just_looking && ! state.tmp.suppress_decorations) {
            if (cslid) {
                return "<span class=\"" + state.opt.nodenames[cslid] + "\" cslid=\"" + cslid + "\">" + str + "</span>";
            } else if (this.params && "string" === typeof str) {
                var prePunct = "";
                if (str) {
                    var m = str.match(CSL.VARIABLE_WRAPPER_PREPUNCT_REX);
                    prePunct = m[1];
                    str = m[2];
                }
                var postPunct = "";
                if (str && CSL.SWAPPING_PUNCTUATION.indexOf(str.slice(-1)) > -1) {
                    postPunct = str.slice(-1);
                    str = str.slice(0,-1);
                }
                return state.sys.variableWrapper(this.params, prePunct, str, postPunct);
            } else {
                return str;
            }
        } else {
            return str;
        }
    },
    "@URL/true": function (state, str) {
        return "<a href=\"" + str + "\">" + str + "</a>";
    },
    "@DOI/true": function (state, str) {
        return "<a href=\"https://doi.org/" + str + "\">" + str + "</a>";
    }
};
CSL.Output.Formats.prototype.text = {
    "text_escape": function (text) {
        if (!text) {
            text = "";
        }
        return text;
    },
    "bibstart": "",
    "bibend": "",
    "@font-style/italic": false,
    "@font-style/oblique": false,
    "@font-style/normal": false,
    "@font-variant/small-caps": false,
    "@passthrough/true": CSL.Output.Formatters.passthrough,
    "@font-variant/normal": false,
    "@font-weight/bold": false,
    "@font-weight/normal": false,
    "@font-weight/light": false,
    "@text-decoration/none": false,
    "@text-decoration/underline": false,
    "@vertical-align/baseline": false,
    "@vertical-align/sup": false,
    "@vertical-align/sub": false,
    "@strip-periods/true": CSL.Output.Formatters.passthrough,
    "@strip-periods/false": CSL.Output.Formatters.passthrough,
    "@quotes/true": function (state, str) {
        if ("undefined" === typeof str) {
            return state.getTerm("open-quote");
        }
        return state.getTerm("open-quote") + str + state.getTerm("close-quote");
    },
    "@quotes/inner": function (state, str) {
        if ("undefined" === typeof str) {
            return "\u2019";
        }
        return state.getTerm("open-inner-quote") + str + state.getTerm("close-inner-quote");
    },
    "@quotes/false": false,
    "@cite/entry": function (state, str) {
		return state.sys.wrapCitationEntry(str, this.item_id, this.locator_txt, this.suffix_txt);
	},
    "@bibliography/entry": function (state, str) {
        return str+"\n";
    },
    "@display/block": function (state, str) {
        return "\n"+str;
    },
    "@display/left-margin": function (state, str) {
        return str;
    },
    "@display/right-inline": function (state, str) {
        return str;
    },
    "@display/indent": function (state, str) {
        return "\n    "+str;
    },
    "@showid/true": function (state, str, cslid) {
        return str;
    },
    "@URL/true": function (state, str) {
        return str;
    },
    "@DOI/true": function (state, str) {
        return str;
    }
};
CSL.Output.Formats.prototype.rtf = {
    "text_escape": function (text) {
        if (!text) {
            text = "";
        }
        return text
        .replace(/([\\{}])/g, "\\$1")
        .replace(CSL.SUPERSCRIPTS_REGEXP,
                 function(aChar) {
                     return "\\super " + CSL.SUPERSCRIPTS[aChar] + "\\nosupersub{}";
                 })
        .replace(/[\u007F-\uFFFF]/g,
                 function(aChar) { return "\\uc0\\u"+aChar.charCodeAt(0).toString()+"{}"; })
        .split("\t").join("\\tab{}");
    },
    "@passthrough/true": CSL.Output.Formatters.passthrough,
    "@font-style/italic":"{\\i{}%%STRING%%}",
    "@font-style/normal":"{\\i0{}%%STRING%%}",
    "@font-style/oblique":"{\\i{}%%STRING%%}",
    "@font-variant/small-caps":"{\\scaps %%STRING%%}",
    "@font-variant/normal":"{\\scaps0{}%%STRING%%}",
    "@font-weight/bold":"{\\b{}%%STRING%%}",
    "@font-weight/normal":"{\\b0{}%%STRING%%}",
    "@font-weight/light":false,
    "@text-decoration/none":false,
    "@text-decoration/underline":"{\\ul{}%%STRING%%}",
    "@vertical-align/baseline":false,
    "@vertical-align/sup":"\\super %%STRING%%\\nosupersub{}",
    "@vertical-align/sub":"\\sub %%STRING%%\\nosupersub{}",
    "@strip-periods/true": CSL.Output.Formatters.passthrough,
    "@strip-periods/false": CSL.Output.Formatters.passthrough,
    "@quotes/true": function (state, str) {
        if ("undefined" === typeof str) {
            return CSL.Output.Formats.rtf.text_escape(state.getTerm("open-quote"));
        }
        return CSL.Output.Formats.rtf.text_escape(state.getTerm("open-quote")) + str + CSL.Output.Formats.rtf.text_escape(state.getTerm("close-quote"));
    },
    "@quotes/inner": function (state, str) {
        if ("undefined" === typeof str) {
            return CSL.Output.Formats.rtf.text_escape("\u2019");
        }
        return CSL.Output.Formats.rtf.text_escape(state.getTerm("open-inner-quote")) + str + CSL.Output.Formats.rtf.text_escape(state.getTerm("close-inner-quote"));
    },
    "@quotes/false": false,
    "bibstart":"{\\rtf ",
    "bibend":"}",
    "@display/block": "\\line{}%%STRING%%\\line\r\n",
    "@cite/entry": function (state, str) {
		return state.sys.wrapCitationEntry(str, this.item_id, this.locator_txt, this.suffix_txt);
	},
    "@bibliography/entry": function(state,str){
        return str;
    },
    "@display/left-margin": function(state,str){
        return str+"\\tab ";
    },
    "@display/right-inline": function (state, str) {
        return str+"\r\n";
    },
    "@display/indent": function (state, str) {
        return "\n\\tab "+str+"\\line\r\n";
    },
    "@showid/true": function (state, str, cslid) {
        if (!state.tmp.just_looking && ! state.tmp.suppress_decorations) {
            var prePunct = "";
            if (str) {
                var m = str.match(CSL.VARIABLE_WRAPPER_PREPUNCT_REX);
                prePunct = m[1];
                str = m[2];
            }
            var postPunct = "";
            if (str && CSL.SWAPPING_PUNCTUATION.indexOf(str.slice(-1)) > -1) {
                postPunct = str.slice(-1);
                str = str.slice(0,-1);
            }
            return state.sys.variableWrapper(this.params, prePunct, str, postPunct);
        } else {
            return str;
        }
    },
    "@URL/true": function (state, str) {
        return str;
    },
    "@DOI/true": function (state, str) {
        return str;
    }
};
CSL.Output.Formats = new CSL.Output.Formats();
module.exports = CSL;
CSL.Registry = function (state) {
    var pos, len, ret, i, ilen;
    this.debug = false;
    this.state = state;
    this.registry = {};
    this.reflist = [];
    this.refhash = {};
    this.namereg = new CSL.Registry.NameReg(state);
    this.citationreg = new CSL.Registry.CitationReg(state);
    this.authorstrings = {};
    this.mylist = [];
    this.myhash = {};
    this.deletes = [];
    this.inserts = [];
    this.uncited = {};
    this.refreshes = {};
    this.akeys = {};
    this.oldseq = {};
    this.return_data = {};
    this.ambigcites = {};
    this.ambigresets = {};
    this.sorter = new CSL.Registry.Comparifier(state, "bibliography_sort");
    this.getSortedIds = function () {
        var ret = [];
        for (var i = 0, ilen = this.reflist.length; i < ilen; i += 1) {
            ret.push("" + this.reflist[i].id);
        }
        return ret;
    };
    this.getSortedRegistryItems = function () {
        var ret = [];
        for (var i = 0, ilen = this.reflist.length; i < ilen; i += 1) {
            ret.push(this.reflist[i]);
        }
        return ret;
    };
};
CSL.Registry.prototype.init = function (itemIDs, uncited_flag) {
    var i, ilen;
    this.oldseq = {};
    if (uncited_flag) {
        this.uncited = {};
        for (var i=0,ilen=itemIDs.length;i<ilen; i += 1) {
            if (!this.myhash[itemIDs[i]]) {
                this.mylist.push("" + itemIDs[i]);
            }
            this.uncited[itemIDs[i]] = true;
            this.myhash[itemIDs[i]] = true;
        }
    } else {
        for (var key in this.uncited) {
            itemIDs.push(key);
        }
        var myhash = {};
        for (i=itemIDs.length-1;i>-1; i += -1) {
            if (myhash[itemIDs[i]]) {
                itemIDs = itemIDs.slice(0, i).concat(itemIDs.slice(i + 1));
            } else {
                myhash[itemIDs[i]] = true;
            }
        }
        this.mylist = [];
        for (var i=0,ilen=itemIDs.length;i<ilen;i+=1) {
            this.mylist.push("" + itemIDs[i]);
        }
        this.myhash = myhash;
    }
    this.refreshes = {};
    this.touched = {};
    this.ambigsTouched = {};
    this.ambigresets = {};
};
CSL.Registry.prototype.dopurge = function (myhash) {
    for (var i=this.mylist.length-1;i>-1;i+=-1) {
        if (this.citationreg.citationsByItemId) {
            if (!this.citationreg.citationsByItemId[this.mylist[i]] && !myhash[this.mylist[i]]) {
                delete this.myhash[this.mylist[i]];
                this.mylist = this.mylist.slice(0,i).concat(this.mylist.slice(i+1));
            }
        }
    }
    this.dodeletes(this.myhash);
};
CSL.Registry.prototype.dodeletes = function (myhash) {
    var otheritems, key, ambig, pos, len, items, kkey, mypos, id;
    if ("string" === typeof myhash) {
        myhash = {};
        myhash[myhash] = true;
    }
    for (var key in this.registry) {
        if (!myhash[key]) {
            if (this.uncited[key]) {
                continue;
            }
            otheritems = this.namereg.delitems(key);
            for (kkey in otheritems) {
                this.refreshes[kkey] = true;
            }
            ambig = this.registry[key].ambig;
            mypos = this.ambigcites[ambig].indexOf(key);
            if (mypos > -1) {
                items = this.ambigcites[ambig].slice();
                this.ambigcites[ambig] = items.slice(0, mypos).concat(items.slice(mypos+1, items.length));
                this.ambigresets[ambig] = this.ambigcites[ambig].length;
            }
            len = this.ambigcites[ambig].length;
            for (pos = 0; pos < len; pos += 1) {
                id = "" + this.ambigcites[ambig][pos];
                this.refreshes[id] = true;
            }
            if (this.registry[key].siblings) {
                if (this.registry[key].siblings.length == 1) {
                    var loneSiblingID = this.registry[key].siblings[0];
                    this.registry[loneSiblingID].master = true;
                    this.registry[loneSiblingID].siblings.pop();
                    this.registry[loneSiblingID].parallel = false;
                } else if (this.registry[key].siblings.length > 1) {
                    var removeIDs = [key];
                    if (this.registry[key].master) {
                        var newmasterID = this.registry[key].siblings[0];
                        var newmaster = this.registry[newmasterID];
                        newmaster.master = true;
                        newmaster.parallel = false;
                        removeIDs.push(newmasterID);
                        for (var k = 0, klen = this.registry[key].siblings.length; k < klen; k += 1) {
                            this.registry[this.registry[key].siblings[k]].parallel = newmasterID;
                        }
                    }
                    var buffer = [];
                    for (var k = this.registry[key].siblings.length - 1; k > -1; k += -1) {
                        var siblingID = this.registry[key].siblings.pop();
                        if (removeIDs.indexOf(siblingID) === -1) {
                            buffer.push(siblingID)
                        }
                    }
                    for (var k = buffer.length - 1; k > -1; k += -1) {
                        this.registry[key].siblings.push(buffer[k]);
                    }
                }
            }
            delete this.registry[key];
            delete this.refhash[key];
            this.return_data.bibchange = true;
        }
    }
};
CSL.Registry.prototype.doinserts = function (mylist) {
    var len, pos, item, Item, akey, newitem, abase, j, jlen, k, klen, i, ilen;
    if ("string" === typeof mylist) {
        mylist = [mylist];
    }
    for (var i = 0, ilen = mylist.length; i < ilen; i += 1) {
        item = mylist[i];
        if (!this.registry[item]) {
            Item = this.state.retrieveItem(item);
            akey = CSL.getAmbiguousCite.call(this.state, Item);
            this.ambigsTouched[akey] = true;
            if (!Item.legislation_id) {
                this.akeys[akey] = true;
            }
            newitem = {
                "id": "" + item,
                "seq": 0,
                "offset": 0,
                "sortkeys": false,
                "ambig": false,
                "rendered": false,
                "disambig": false,
                "ref": Item
            };
            this.registry[item] = newitem;
            if (this.citationreg.citationsByItemId && this.citationreg.citationsByItemId[item]) {
                this.registry[item]["first-reference-note-number"] = this.citationreg.citationsByItemId[item][0].properties.noteIndex;
            }
            abase = CSL.getAmbigConfig.call(this.state);
            this.registerAmbigToken(akey, item, abase);
            this.touched[item] = true;
            this.return_data.bibchange = true;
        }
    }
};
CSL.Registry.prototype.rebuildlist = function () {
    var count, len, pos, item;
    this.reflist = [];
    if (this.state.opt.citation_number_sort_direction === CSL.DESCENDING
       && this.state.opt.citation_number_sort_used) {
    }
    len = this.mylist.length;
    for (pos = 0; pos < len; pos += 1) {
        item = this.mylist[pos];
        this.reflist.push(this.registry[item]);
        this.oldseq[item] = this.registry[item].seq;
        this.registry[item].seq = (pos + 1);
    }
    if (this.state.opt.citation_number_sort_direction === CSL.DESCENDING
       && this.state.opt.citation_number_sort_used) {
    }
};
CSL.Registry.prototype.dorefreshes = function () {
    var key, regtoken, Item, old_akey, akey, abase;
    for (var key in this.refreshes) {
        regtoken = this.registry[key];
        if (!regtoken) {
            continue;
        }
        regtoken.sortkeys = undefined;
        Item = this.state.retrieveItem(key);
        var akey = regtoken.ambig;
        if ("undefined" === typeof akey) {
            this.state.tmp.disambig_settings = false;
            akey = CSL.getAmbiguousCite.call(this.state, Item);
            abase = CSL.getAmbigConfig.call(this.state);
            this.registerAmbigToken(akey, key, abase);
        }
        for (var akkey in this.ambigresets) {
            if (this.ambigresets[akkey] === 1) {
                var loneKey = this.ambigcites[akey][0];
                var Item = this.state.retrieveItem(loneKey);
                this.registry[loneKey].disambig = new CSL.AmbigConfig;
                this.state.tmp.disambig_settings = false;
                var akey = CSL.getAmbiguousCite.call(this.state, Item);
                var abase = CSL.getAmbigConfig.call(this.state);
                this.registerAmbigToken(akey, loneKey, abase);
            }
        }
        this.state.tmp.taintedItemIDs[key] = true;
        this.ambigsTouched[akey] = true;
        if (!Item.legislation_id) {
            this.akeys[akey] = true;
        }
        this.touched[key] = true;
    }
};
CSL.Registry.prototype.setdisambigs = function () {
    var akey, leftovers, key, pos, len, id;
    this.leftovers = [];
    for (akey in this.ambigsTouched) {
        this.state.disambiguate.run(akey);
    }
    this.ambigsTouched = {};
    this.akeys = {};
};
CSL.Registry.prototype.renumber = function () {
    var len, pos, item;
    if (this.state.opt.citation_number_sort_direction === CSL.DESCENDING
       && this.state.opt.citation_number_sort_used) {
    }
    len = this.reflist.length;
    for (pos = 0; pos < len; pos += 1) {
        item = this.reflist[pos];
        item.seq = (pos + 1);
        if (this.state.opt.update_mode === CSL.NUMERIC && item.seq != this.oldseq[item.id]) {
            this.state.tmp.taintedItemIDs[item.id] = true;
        }
        if (this.state.opt.bib_mode === CSL.NUMERIC && item.seq != this.oldseq[item.id]) {
            this.return_data.bibchange = true;
        }
    }
    if (this.state.opt.citation_number_sort_direction === CSL.DESCENDING
       && this.state.opt.citation_number_sort_used) {
        this.reflist.reverse();
    }
};
CSL.Registry.prototype.setsortkeys = function () {
    var key;
    for (var i = 0, ilen = this.mylist.length; i < ilen; i += 1) {
        var key = this.mylist[i];
        if (this.touched[key] || this.state.tmp.taintedItemIDs[key] || !this.registry[key].sortkeys) {
            this.registry[key].sortkeys = CSL.getSortKeys.call(this.state, this.state.retrieveItem(key), "bibliography_sort");
        }
    }
};
CSL.Registry.prototype.sorttokens = function () {
    this.reflist.sort(this.sorter.compareKeys);
};
CSL.Registry.Comparifier = function (state, keyset) {
    var sort_directions, len, pos, compareKeys;
    var sortCompare = CSL.getSortCompare(state.opt["default-locale-sort"]);
    sort_directions = state[keyset].opt.sort_directions;
    this.compareKeys = function (a, b) {
        len = a.sortkeys ? a.sortkeys.length : 0;
        for (pos = 0; pos < len; pos += 1) {
            var cmp = 0;
            if (a.sortkeys[pos] === b.sortkeys[pos]) {
                cmp = 0;
            } else if ("undefined" === typeof a.sortkeys[pos]) {
                cmp = sort_directions[pos][1];
            } else if ("undefined" === typeof b.sortkeys[pos]) {
                cmp = sort_directions[pos][0];
            } else {
                cmp = sortCompare(a.sortkeys[pos], b.sortkeys[pos]);
            }
            if (0 < cmp) {
                return sort_directions[pos][1];
            } else if (0 > cmp) {
                return sort_directions[pos][0];
            }
        }
        if (a.seq > b.seq) {
            return 1;
        } else if (a.seq < b.seq) {
            return -1;
        }
        return 0;
    };
    compareKeys = this.compareKeys;
    this.compareCompositeKeys = function (a, b) {
        return compareKeys(a[1], b[1]);
    };
};
CSL.Registry.prototype.compareRegistryTokens = function (a, b) {
    if (a.seq > b.seq) {
        return 1;
    } else if (a.seq < b.seq) {
        return -1;
    }
    return 0;
};
CSL.Registry.prototype.registerAmbigToken = function (akey, id, ambig_config) {
    if (this.registry[id] && this.registry[id].disambig && this.registry[id].disambig.names) {
        for (var i = 0, ilen = ambig_config.names.length; i < ilen; i += 1) {
            var new_names_params = ambig_config.names[i];
            var old_names_params = this.registry[id].disambig.names[i];
            if (new_names_params !== old_names_params) {
                this.state.tmp.taintedItemIDs[id] = true;
            } else if (ambig_config.givens[i]) {
                for (var j=0,jlen=ambig_config.givens[i].length;j<jlen;j+=1) {
                    var new_gnames_params = ambig_config.givens[i][j];
                    var old_gnames_params = this.registry[id].disambig.givens[i][j];
                    if (new_gnames_params !== old_gnames_params) {
                        this.state.tmp.taintedItemIDs[id] = true;
                    }
                }
            }
        }
    }
    if (!this.ambigcites[akey]) {
        this.ambigcites[akey] = [];
    }
    if (this.ambigcites[akey].indexOf("" + id) === -1) {
        this.ambigcites[akey].push("" + id);
    }
    this.registry[id].ambig = akey;
    var dome = false;
    this.registry[id].disambig = CSL.cloneAmbigConfig(ambig_config);
};
CSL.getSortKeys = function (Item, key_type) {
    var area, root, extension, strip_prepositions, use_parallels, len, pos;
    area = this.tmp.area;
    root = this.tmp.root;
    extension = this.tmp.extension;
    strip_prepositions = CSL.Util.Sort.strip_prepositions;
    this.tmp.area = key_type;
    this.tmp.root = key_type.indexOf("_") > -1 ? key_type.slice(0,-5) : key_type;
    this.tmp.extension = "_sort";
    this.tmp.disambig_override = true;
    this.tmp.disambig_request = false;
    this.parallel.use_parallels = (this.parallel.use_parallels === true || this.parallel.use_parallels === null) ? null : false;
    this.tmp.suppress_decorations = true;
    CSL.getCite.call(this, Item);
    this.tmp.suppress_decorations = false;
    this.parallel.use_parallels = this.parallel.use_parallels === null ? true : false;
    this.tmp.disambig_override = false;
    len = this[key_type].keys.length;
    for (pos = 0; pos < len; pos += 1) {
        this[key_type].keys[pos] = strip_prepositions(this[key_type].keys[pos]);
    }
    this.tmp.area = area;
    this.tmp.root = root;
    this.tmp.extension = extension;
    return this[key_type].keys;
};
module.exports = CSL;
CSL.Registry.NameReg = function (state) {
    var pkey, ikey, skey, floor, ceiling, dagopt, gdropt, ret, pos, items, strip_periods, set_keys, evalname, delitems, addname, key, myitems, i, ilen;
    this.state = state;
    this.namereg = {};
    this.nameind = {};
    this.nameindpkeys = {};
    this.itemkeyreg = {};
    strip_periods = function (str) {
        if (!str) {
            str = "";
        }
        return str.replace(/\./g, " ").replace(/\s+/g, " ").replace(/\s+$/,"");
    };
    set_keys = function (state, itemid, nameobj) {
        pkey = strip_periods(nameobj.family);
        skey = strip_periods(nameobj.given);
        var m = skey.match(/[,\!]* ([^,]+)$/);
        if (m && m[1] === m[1].toLowerCase()) {
            skey = skey.replace(/[,\!]* [^,]+$/, "");
        }
        ikey = CSL.Util.Names.initializeWith(state, skey, "%s");
        if (state.citation.opt["givenname-disambiguation-rule"] === "by-cite") {
            pkey = "" + itemid + pkey;
        }
    };
    evalname = function (item_id, nameobj, namenum, request_base, form, initials) {
        var pos, len, items, param;
        if (state.tmp.area.slice(0, 12) === "bibliography" && !form) {
            if ("string" === typeof initials) {
                return 1;
            } else {
                return 2;
            }
        }
        var res = state.nameOutput.getName(nameobj, "locale-translit", true);
        nameobj = res.name;
        set_keys(this.state, "" + item_id, nameobj);
        param = 2;
        dagopt = state.opt["disambiguate-add-givenname"];
        gdropt = state.citation.opt["givenname-disambiguation-rule"];
        var gdropt_orig = gdropt;
        if (gdropt === "by-cite") {
            gdropt = "all-names";
        }
        if ("short" === form) {
            param = 0;
        } else if ("string" === typeof initials) {
            param = 1;
        }
        if ("undefined" === typeof this.namereg[pkey] || "undefined" === typeof this.namereg[pkey].ikey[ikey]) {
            return param;
        }
        if (gdropt_orig === "by-cite" && param <= request_base) {
            return request_base;
        }
        if (!dagopt) {
            return param;
        }
        if ("string" === typeof gdropt && gdropt.slice(0, 12) === "primary-name" && namenum > 0) {
            return param;
        }
        if (!gdropt || gdropt === "all-names" || gdropt === "primary-name") {
            if (this.namereg[pkey].count > 1) {
                param = 1;
            }
            if ((this.namereg[pkey].ikey 
                 && this.namereg[pkey].ikey[ikey].count > 1)
                || (this.namereg[pkey].count > 1 
                    && "string" !== typeof initials)) {
                param = 2;
            }
        } else if (gdropt === "all-names-with-initials" || gdropt === "primary-name-with-initials") {
            if (this.namereg[pkey].count > 1) {
                param = 1;
            } else {
                param = 0;
            }
        }
        if (!state.registry.registry[item_id]) {
            if (form == "short") {
                return 0;
            } else if ("string" == typeof initials) {
                return 1;
            }
        } else {
            return param;
        }
    };
    delitems = function (ids) {
        var item, pos, len, posA, posB, id, fullkey, llen, ppos, otherid;
        if ("string" === typeof ids || "number" === typeof ids) {
            ids = ["" + ids];
        }
        var ret = {};
        len = ids.length;
        for (pos = 0; pos < len; pos += 1) {
            id = "" + ids[pos];
            if (!this.nameind[id]) {
                continue;
            }
            for (fullkey in this.nameind[id]) {
                if (this.nameind[id].hasOwnProperty(fullkey)) {
                    var key = fullkey.split("::");
                    pkey = key[0];
                    ikey = key[1];
                    skey = key[2];
                    if ("undefined" === typeof this.namereg[pkey]) {
                        continue;
                    }
                    items = this.namereg[pkey].items;
                    if (skey && this.namereg[pkey].ikey[ikey] && this.namereg[pkey].ikey[ikey].skey[skey]) {
                        myitems = this.namereg[pkey].ikey[ikey].skey[skey].items;
                        posB = myitems.indexOf("" + id);
                        if (posB > -1) {
                            this.namereg[pkey].ikey[ikey].skey[skey].items = myitems.slice(0, posB).concat(myitems.slice([(posB + 1)]));
                        }
                        if (this.namereg[pkey].ikey[ikey].skey[skey].items.length === 0) {
                            delete this.namereg[pkey].ikey[ikey].skey[skey];
                            this.namereg[pkey].ikey[ikey].count += -1;
                            if (this.namereg[pkey].ikey[ikey].count < 2) {
                                for (var i = 0, ilen = this.namereg[pkey].ikey[ikey].items.length; i < ilen; i += 1) {
                                    state.tmp.taintedItemIDs[this.namereg[pkey].ikey[ikey].items[i]] = true;
                                }
                            }
                        }
                    }
                    if (ikey && this.namereg[pkey].ikey[ikey]) {
                        posB = this.namereg[pkey].ikey[ikey].items.indexOf("" + id);
                        if (posB > -1) {
                            items = this.namereg[pkey].ikey[ikey].items.slice();
                            this.namereg[pkey].ikey[ikey].items = items.slice(0, posB).concat(items.slice([posB + 1]));
                        }
                        if (this.namereg[pkey].ikey[ikey].items.length === 0) {
                            delete this.namereg[pkey].ikey[ikey];
                            this.namereg[pkey].count += -1;
                            if (this.namereg[pkey].count < 2) {
                                for (var i = 0, ilen = this.namereg[pkey].items.length; i < ilen; i += 1) {
                                    state.tmp.taintedItemIDs[this.namereg[pkey].items[i]] = true;
                                }
                            }
                        }
                    }
                    if (pkey) {
                        posB = this.namereg[pkey].items.indexOf("" + id);
                        if (posB > -1) {
                            items = this.namereg[pkey].items.slice();
                            this.namereg[pkey].items = items.slice(0, posB).concat(items.slice([posB + 1], items.length));
                        }
                        if (this.namereg[pkey].items.length < 2) {
                            delete this.namereg[pkey];
                        }
                    }
                    delete this.nameind[id][fullkey];
                }
            }
            delete this.nameind[id];
            delete this.nameindpkeys[id];
        }
        return ret;
    };
    addname = function (item_id, nameobj, pos) {
        var i, ilen;
        var res = state.nameOutput.getName(nameobj, "locale-translit", true);
        nameobj = res.name;
        if (state.citation.opt["givenname-disambiguation-rule"]
            && state.citation.opt["givenname-disambiguation-rule"].slice(0, 8) === "primary-"
            && pos !== 0) {
                return;
        }
        set_keys(this.state, "" + item_id, nameobj);
        if (pkey) {
            if ("undefined" === typeof this.namereg[pkey]) {
                this.namereg[pkey] = {};
                this.namereg[pkey].count = 0;
                this.namereg[pkey].ikey = {};
                this.namereg[pkey].items = [item_id];
            } else if (this.namereg[pkey].items.indexOf(item_id) === -1) {
                this.namereg[pkey].items.push(item_id);
            }
        }
        if (pkey && ikey) {
            if ("undefined" === typeof this.namereg[pkey].ikey[ikey]) {
                this.namereg[pkey].ikey[ikey] = {};
                this.namereg[pkey].ikey[ikey].count = 0;
                this.namereg[pkey].ikey[ikey].skey = {};
                this.namereg[pkey].ikey[ikey].items = [item_id];
                this.namereg[pkey].count += 1;
                if (this.namereg[pkey].count === 2) {
                    for (var i = 0, ilen = this.namereg[pkey].items.length; i < ilen; i += 1) {
                        state.tmp.taintedItemIDs[this.namereg[pkey].items[i]] = true;
                    }
                }
            } else if (this.namereg[pkey].ikey[ikey].items.indexOf(item_id) === -1) {
                this.namereg[pkey].ikey[ikey].items.push(item_id);
            }
        }
        if (pkey && ikey && skey) {
            if ("undefined" === typeof this.namereg[pkey].ikey[ikey].skey[skey]) {
                this.namereg[pkey].ikey[ikey].skey[skey] = {};
                this.namereg[pkey].ikey[ikey].skey[skey].items = [item_id];
                this.namereg[pkey].ikey[ikey].count += 1;
                if (this.namereg[pkey].ikey[ikey].count === 2) {
                    for (var i = 0, ilen = this.namereg[pkey].ikey[ikey].items.length; i < ilen; i += 1) {
                        state.tmp.taintedItemIDs[this.namereg[pkey].ikey[ikey].items[i]] = true;
                    }
                }
            } else if (this.namereg[pkey].ikey[ikey].skey[skey].items.indexOf(item_id) === -1) {
                this.namereg[pkey].ikey[ikey].skey[skey].items.push(item_id);
            }
        }
        if ("undefined" === typeof this.nameind[item_id]) {
            this.nameind[item_id] = {};
            this.nameindpkeys[item_id] = {};
        }
        if (pkey) {
            this.nameind[item_id][pkey + "::" + ikey + "::" + skey] = true;
            this.nameindpkeys[item_id][pkey] = this.namereg[pkey];
        }
    };
    this.addname = addname;
    this.delitems = delitems;
    this.evalname = evalname;
};
module.exports = CSL;
CSL.Registry.CitationReg = function (state) {
    this.citationById = {};
    this.citationByIndex = [];
};
module.exports = CSL;
CSL.Disambiguation = function (state) {
    this.state = state;
    this.sys = this.state.sys;
    this.registry = state.registry.registry;
    this.ambigcites = state.registry.ambigcites;
    this.configModes();
    this.debug = false;
};
CSL.Disambiguation.prototype.run = function(akey) {
    if (!this.modes.length) {
        return;
    }
    this.akey = akey;
    if (this.initVars(akey)) {
        this.runDisambig();
    }
};
CSL.Disambiguation.prototype.runDisambig = function () {
    var pos, len, ppos, llen, pppos, lllen, ismax;
    this.initGivens = true;
    while (this.lists.length) {
        this.gnameset = 0;
        this.gname = 0;
        this.clashes = [1, 0];
        while(this.lists[0][1].length) {
            this.listpos = 0;
            if (!this.base) {
                this.base = this.lists[0][0];
            }
            var names_used = [];
            ismax = this.incrementDisambig();
            this.scanItems(this.lists[0]);
            this.evalScan(ismax);
        }
        this.lists = this.lists.slice(1);
    }
};
CSL.Disambiguation.prototype.scanItems = function (list) {
    var pos, len, Item, otherItem, ItemCite, ignore, base;
    this.Item = list[1][0];
    this.ItemCite = CSL.getAmbiguousCite.call(this.state, this.Item, this.base, true);
    this.scanlist = list[1];
    this.partners = [];
    this.partners.push(this.Item);
    this.nonpartners = [];
    var clashes = 0;
    for (var pos = 1, len = list[1].length; pos < len; pos += 1) {
        otherItem = list[1][pos];
        var otherItemCite = CSL.getAmbiguousCite.call(this.state, otherItem, this.base, true);
        if (this.ItemCite === otherItemCite) {
            clashes += 1;
            this.partners.push(otherItem);
        } else {
            this.nonpartners.push(otherItem);
        }
    }
    this.clashes[0] = this.clashes[1];
    this.clashes[1] = clashes;
};
CSL.Disambiguation.prototype.evalScan = function (maxed) {
    this[this.modes[this.modeindex]](maxed);
    if (maxed) {
        if (this.modeindex < this.modes.length - 1) {
            this.modeindex += 1;
        } else {
            this.lists[this.listpos + 1] = [this.base, []];
        }
    }
};
CSL.Disambiguation.prototype.disNames = function (ismax) {
    var pos, len, mybase, i, ilen;
    if (this.clashes[1] === 0 && this.nonpartners.length === 1) {
        this.captureStepToBase();
        this.state.registry.registerAmbigToken(this.akey, "" + this.nonpartners[0].id, this.betterbase);
        this.state.registry.registerAmbigToken(this.akey, "" + this.partners[0].id, this.betterbase);
        this.lists[this.listpos] = [this.betterbase, []];
    } else if (this.clashes[1] === 0) {
        this.captureStepToBase();
        this.state.registry.registerAmbigToken(this.akey, "" + this.partners[0].id, this.betterbase);
        this.lists[this.listpos] = [this.betterbase, this.nonpartners];
        if (this.nonpartners.length) {
            this.initGivens = true;
        }
    } else if (this.nonpartners.length === 1) {
        this.captureStepToBase();
        this.state.registry.registerAmbigToken(this.akey, "" + this.nonpartners[0].id, this.betterbase);
        this.lists[this.listpos] = [this.betterbase, this.partners];
    } else if (this.clashes[1] < this.clashes[0]) {
        this.captureStepToBase();
        this.lists[this.listpos] = [this.betterbase, this.partners];
        this.lists.push([this.betterbase, this.nonpartners]);
    } else {
        if (ismax) {
            this.lists[this.listpos] = [this.betterbase, this.nonpartners];
            this.lists.push([this.betterbase, this.partners]);
            if (this.modeindex === this.modes.length - 1) {
                for (var i = 0, ilen = this.partners.length; i < ilen; i += 1) {
                    this.state.registry.registerAmbigToken(this.akey, "" + this.partners[i].id, this.betterbase);
                }
                this.lists[this.listpos] = [this.betterbase, []];
            }
        }
    }
};
CSL.Disambiguation.prototype.disExtraText = function () {
    var pos, len, mybase;
    var done = false;
    if (this.clashes[1] === 0 && this.nonpartners.length < 2) {
        done = true;
    }
    if (!done && (!this.base.disambiguate || this.state.tmp.disambiguate_count !== this.state.tmp.disambiguate_maxMax)) {
        this.modeindex = 0;
        this.base.disambiguate = this.state.tmp.disambiguate_count;
        this.betterbase.disambiguate = this.state.tmp.disambiguate_count;
        if (!this.base.disambiguate) {
            this.initGivens = true;
            this.base.disambiguate = 1;
            for (var i = 0, ilen = this.lists[this.listpos][1].length; i < ilen; i += 1) {
                this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id] = true;
            }
        } else {
            this.disNames();
        }
    } else if (done || this.state.tmp.disambiguate_count === this.state.tmp.disambiguate_maxMax) {
        if (done || this.modeindex === this.modes.length - 1) {
            var base = this.lists[this.listpos][0];
            for (var i = 0, ilen = this.lists[this.listpos][1].length; i < ilen; i += 1) {
                this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id] = true;
                this.state.registry.registerAmbigToken(this.akey, "" + this.lists[this.listpos][1][i].id, base);
            }
            this.lists[this.listpos] = [this.betterbase, []];
        } else {
            this.modeindex = this.modes.length - 1;
            var base = this.lists[this.listpos][0];
            base.disambiguate = true;
            for (var i = 0, ilen = this.lists[this.listpos][1].length; i < ilen; i += 1) {
                this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id] = true;
                this.state.registry.registerAmbigToken(this.akey, "" + this.lists[this.listpos][1][i].id, base);
            }
        }
    }
};
CSL.Disambiguation.prototype.disYears = function () {
    var pos, len, tokens, token, item;
    tokens = [];
    var base = this.lists[this.listpos][0];
    if (this.clashes[1]) {
		for (var i = 0, ilen = this.state.registry.mylist.length; i < ilen; i += 1) {
			var origid = this.state.registry.mylist[i];
			for (var j = 0, jlen = this.lists[this.listpos][1].length; j < jlen; j += 1) {
				var token = this.lists[this.listpos][1][j];
				if (token.id == origid) {
					tokens.push(this.registry[token.id]);
					break;
				}
			}
		}
    }
    tokens.sort(this.state.registry.sorter.compareKeys);
    for (var pos = 0, len = tokens.length; pos < len; pos += 1) {
        base.year_suffix = ""+pos;
        var oldBase = this.state.registry.registry[tokens[pos].id].disambig;
        this.state.registry.registerAmbigToken(this.akey, "" + tokens[pos].id, base);
        if (CSL.ambigConfigDiff(oldBase,base)) {
            this.state.tmp.taintedItemIDs[tokens[pos].id] = true;
        }
    }
    this.lists[this.listpos] = [this.betterbase, []];
};
CSL.Disambiguation.prototype.incrementDisambig = function () {
    var val;
    if (this.initGivens) {
        this.initGivens = false;
        return false;
    }
    var maxed = false;
    var increment_names = true;
    var increment_givens = true;
    if ("disNames" === this.modes[this.modeindex]) {
        increment_names = false;
        if ("number" !== typeof this.givensMax) {
            increment_names = true;
        }
        var increment_namesets = false;
        if ("number" !== typeof this.namesMax) {
            increment_namesets = true;
        }
        if ("number" === typeof this.givensMax) {
            if (this.base.givens.length && this.base.givens[this.gnameset][this.gname] < this.givensMax) {
                this.base.givens[this.gnameset][this.gname] += 1;
            } else {
                increment_names = true;
            }
        }
        if ("number" === typeof this.namesMax 
            && increment_names) {
            if (this.state.opt["disambiguate-add-names"]) {
                increment_namesets = false;
                if (this.gname < this.namesMax) {
                    this.base.names[this.gnameset] += 1;
                    this.gname += 1;
                } else {
                    increment_namesets = true;
                }
            } else {
                increment_namesets = true;
            }
        }
        if ("number" === typeof this.namesetsMax && increment_namesets) {
            if (this.gnameset < this.namesetsMax) {
                this.gnameset += 1;
                this.base.names[this.gnameset] = 1;
                this.gname = 0;
            } else {
                var increment_mode = true;
            }
        }
        if (("number" !== typeof this.namesetsMax || this.namesetsMax === -1 || this.gnameset === this.namesetsMax)
            && (!this.state.opt["disambiguate-add-names"] || "number" !== typeof this.namesMax || this.gname === this.namesMax)
            && ("number" != typeof this.givensMax || "undefined" === typeof this.base.givens[this.gnameset] || "undefined" === typeof this.base.givens[this.gnameset][this.gname] || this.base.givens[this.gnameset][this.gname] === this.givensMax)) {
            maxed = true;
        }
    } else if ("disExtraText" === this.modes[this.modeindex]) {
        this.base.disambiguate += 1;
        this.betterbase.disambiguate += 1;
    }
    return maxed;
};
CSL.Disambiguation.prototype.initVars = function (akey) {
    var i, ilen, myIds, myItemBundles, myItems;
    this.lists = [];
    this.base = false;
    this.betterbase = false;
    this.akey = akey;
    this.maxNamesByItemId = {};
    myItemBundles = [];
    myIds = this.ambigcites[akey];
    if (!myIds || !myIds.length) {
        return false;
    }
    var Item = false;
    var myItem = this.state.retrieveItem("" + myIds[0]);
    this.getCiteData(myItem);
    this.base = CSL.getAmbigConfig.call(this.state);
    if (myIds && myIds.length > 1) {
        myItemBundles.push([this.maxNamesByItemId[myItem.id], myItem]);
        for (var i = 1, ilen = myIds.length; i < ilen; i += 1) {
            myItem = this.state.retrieveItem("" + myIds[i]);
            this.getCiteData(myItem, this.base);
            myItemBundles.push([this.maxNamesByItemId[myItem.id], myItem]);
        }
        myItemBundles.sort(
            function (a, b) {
                if (a[0] > b[0]) {
                    return 1;
                } else if (a[0] < b[0]) {
                    return -1;
                } else {
                    if (a[1].id > b[1].id) {
                        return 1;
                    } else if (a[1].id < b[1].id) {
                        return -1;
                    } else {
                        return 0;
                    }
                }
            }
        );
        myItems = [];
        for (var i = 0, ilen = myItemBundles.length; i < ilen; i += 1) {
            myItems.push(myItemBundles[i][1]);
        }
        this.lists.push([this.base, myItems]);
        this.Item = this.lists[0][1][0];
    } else {
        this.Item = this.state.retrieveItem("" + myIds[0]);
    }
    this.modeindex = 0;
    if (this.state.citation.opt["disambiguate-add-names"] || true) {
        this.namesMax = this.maxNamesByItemId[this.Item.id][0];
    } else {
        var namesMax = this.base.names[0];
        for (var i=1,ilen=this.base.names.length;i<ilen;i+=1){
            namesMax = Math.max(namesMax,this.base.names.names[i]);
        }
    }
    this.padBase(this.base);
    this.padBase(this.betterbase);
    this.base.year_suffix = false;
    this.base.disambiguate = false;
    this.betterbase.year_suffix = false;
    this.betterbase.disambiguate = false;
    if (this.state.citation.opt["givenname-disambiguation-rule"] === "by-cite"
       && this.state.opt["disambiguate-add-givenname"]) {
        this.givensMax = 2;
    }
    return true;
};
CSL.Disambiguation.prototype.padBase = function (base) {
    for (var i = 0, ilen = base.names.length; i < ilen; i += 1) {
        if (!base.givens[i]) {
            base.givens[i] = [];
        }
        for (var j=0,jlen=base.names[i];j<jlen;j+=1) {
            if (!base.givens[i][j]) {
                base.givens[i][j] = 0;
            }
        }
    }
}
CSL.Disambiguation.prototype.configModes = function () {
    var dagopt, gdropt;
    this.modes = [];
    dagopt = this.state.opt["disambiguate-add-givenname"];
    gdropt = this.state.citation.opt["givenname-disambiguation-rule"];
    if (this.state.opt['disambiguate-add-names'] || (dagopt && gdropt === "by-cite")) {
        this.modes.push("disNames");
    }
    if (this.state.opt.has_disambiguate) {
        this.modes.push("disExtraText");
    }
    if (this.state.opt["disambiguate-add-year-suffix"]) {
        this.modes.push("disYears");
    }
};
CSL.Disambiguation.prototype.getCiteData = function(Item, base) {
    if (!this.maxNamesByItemId[Item.id]) {
        CSL.getAmbiguousCite.call(this.state, Item, base);
        base = CSL.getAmbigConfig.call(this.state);
        this.maxNamesByItemId[Item.id] = CSL.getMaxVals.call(this.state);
        this.state.registry.registry[Item.id].disambig.givens = this.state.tmp.disambig_settings.givens.slice();
        for (var i=0,ilen=this.state.registry.registry[Item.id].disambig.givens.length;i<ilen;i+=1) {
            this.state.registry.registry[Item.id].disambig.givens[i] = this.state.tmp.disambig_settings.givens[i].slice();
        }
        this.namesetsMax = this.state.registry.registry[Item.id].disambig.names.length - 1;
        if (!this.base) {
            this.base = base;
            this.betterbase = CSL.cloneAmbigConfig(base);
        }
        if (base.names.length < this.base.names.length) {
            this.base = base;
        }
        var update = false;
        for (var i = 0, ilen = base.names.length; i < ilen; i += 1) {
            if (base.names[i] > this.base.names[i]) {
                this.base.givens[i] = base.givens[i].slice();
                this.base.names[i] = base.names[i];
                this.betterbase.names = this.base.names.slice();
                this.betterbase.givens = this.base.givens.slice();
                this.padBase(this.base);
                this.padBase(this.betterbase);
            }
        }
        this.betterbase.givens = this.base.givens.slice();
        for (var j = 0, jlen = this.base.givens.length; j < jlen; j += 1) {
            this.betterbase.givens[j] = this.base.givens[j].slice();
        }
    }
};
CSL.Disambiguation.prototype.captureStepToBase = function() {
    if (this.state.citation.opt["givenname-disambiguation-rule"] === "by-cite"
        && this.base.givens && this.base.givens.length) {
        if ("undefined" !== typeof this.base.givens[this.gnameset][this.gname]) {
            this.betterbase.givens[this.gnameset][this.gname] = this.base.givens[this.gnameset][this.gname];
        }
    }
    this.betterbase.names[this.gnameset] = this.base.names[this.gnameset];
};
module.exports = CSL;
CSL.Engine.prototype.getJurisdictionList = function (jurisdiction) {
    var jurisdictionList = [];
    var jurisdictionElems = jurisdiction.split(":");
    for (var j=jurisdictionElems.length;j>0;j--) {
        jurisdictionList.push(jurisdictionElems.slice(0,j).join(":"));
    }
    if (jurisdictionList.indexOf("us") === -1) {
        jurisdictionList.push("us");
    }
    return jurisdictionList;
}
CSL.Engine.prototype.retrieveAllStyleModules = function (jurisdictionList) {
    var ret = {};
    var preferences = this.locale[this.opt.lang].opts["jurisdiction-preference"];
    preferences = preferences ? preferences : [];
    preferences = [""].concat(preferences);
    for (var i=preferences.length-1;i>-1;i--) {
        var preference = preferences[i];
        for (var j=0,jlen=jurisdictionList.length;j<jlen;j++) {
            var jurisdiction = jurisdictionList[j];
            if (this.opt.jurisdictions_seen[jurisdiction]) continue;
            var res = this.sys.retrieveStyleModule(jurisdiction, preference);
            if ((!res && !preference) || res) {
                this.opt.jurisdictions_seen[jurisdiction] = true;
            }
            if (!res) continue;
            ret[jurisdiction] = res;
        }
    }
    return ret;
}
module.exports = CSL;
CSL.ParticleList = function() {
	var always_dropping_1 = [[[0,1], null]];
	var always_dropping_2 = [[[0,2], null]];
	var always_dropping_3 = [[[0,3], null]]
	var always_non_dropping_1 = [[null, [0,1]]];
	var always_non_dropping_2 = [[null, [0,2]]];
	var always_non_dropping_3 = [[null, [0,3]]];
	var either_1 = [[null, [0,1]],[[0,1],null]];
	var either_2 = [[null, [0,2]],[[0,2],null]];
	var either_1_dropping_best = [[[0,1],null],[null, [0,1]]];
	var either_2_dropping_best = [[[0,2],null],[null, [0,2]]];
	var either_3_dropping_best = [[[0,3],null],[null, [0,3]]];
	var non_dropping_2_alt_dropping_1_non_dropping_1 = [[null, [0,2]], [[0,1], [1,2]]];
	var PARTICLES = [
		["'s", always_non_dropping_1],
		["'s-", always_non_dropping_1],
		["'t", always_non_dropping_1],
		["a", 	always_non_dropping_1],
		["aan 't", always_non_dropping_2],
		["aan de", always_non_dropping_2],
		["aan den", always_non_dropping_2],
		["aan der", always_non_dropping_2],
		["aan het", always_non_dropping_2],
		["aan t", always_non_dropping_2],
		["aan", always_non_dropping_1],
		["ad-", either_1],
		["adh-", either_1],
		["af", either_1],
		["al", either_1],
		["al-", either_1],
		["am de", always_non_dropping_2],
		["am", always_non_dropping_1],
		["an-", either_1],
		["ar-", either_1],
		["as-", either_1],
		["ash-", either_1],
		["at-", either_1],
		["ath-", either_1],
		["auf dem", either_2_dropping_best],
		["auf den", either_2_dropping_best],
		["auf der", either_2_dropping_best],
		["auf ter", always_non_dropping_2],
		["auf", either_1_dropping_best],
		["aus 'm", either_2_dropping_best],
		["aus dem", either_2_dropping_best],
		["aus den", either_2_dropping_best],
		["aus der", either_2_dropping_best],
		["aus m", either_2_dropping_best],
		["aus", either_1_dropping_best],
		["aus'm", either_2_dropping_best],
		["az-", either_1],
		["aš-", either_1],
		["aḍ-", either_1],
		["aḏ-", either_1],
		["aṣ-", either_1],
		["aṭ-", either_1],
		["aṯ-", either_1],
		["aẓ-", either_1],
		["ben", always_non_dropping_1],
		["bij 't", always_non_dropping_2],
		["bij de", always_non_dropping_2],
		["bij den", always_non_dropping_2],
		["bij het", always_non_dropping_2],
		["bij t", always_non_dropping_2],
		["bij", always_non_dropping_1],
		["bin", always_non_dropping_1],
		["boven d", always_non_dropping_2],
		["boven d'", always_non_dropping_2],
		["d", always_non_dropping_1],
		["d'", either_1],
		["da", either_1],
		["dal", always_non_dropping_1],
		["dal'", always_non_dropping_1],
		["dall'", always_non_dropping_1],
		["dalla", always_non_dropping_1],
		["das", either_1],
		["de die le", always_non_dropping_3],
		["de die", always_non_dropping_2],
		["de l", always_non_dropping_2],
		["de l'", always_non_dropping_2],
		["de la", non_dropping_2_alt_dropping_1_non_dropping_1],
		["de las", non_dropping_2_alt_dropping_1_non_dropping_1],
		["de le", always_non_dropping_2],
		["de li", either_2],
		["de van der", always_non_dropping_3],
		["de", either_1],
		["de'", either_1],
		["deca", always_non_dropping_1],
		["degli", either_1],
		["dei", either_1],
		["del", either_1],
		["dela", always_dropping_1],
		["dell'", either_1],
		["della", either_1],
		["delle", either_1],
		["dello", either_1],
		["den", either_1],
		["der", either_1],
		["des", either_1],
		["di", either_1],
		["die le", always_non_dropping_2],
		["do", always_non_dropping_1],
		["don", always_non_dropping_1],
		["dos", either_1],
		["du", either_1],
		["ed-", either_1],
		["edh-", either_1],
		["el", either_1],
		["el-", either_1],
		["en-", either_1],
		["er-", either_1],
		["es-", either_1],
		["esh-", either_1],
		["et-", either_1],
		["eth-", either_1],
		["ez-", either_1],
		["eš-", either_1],
		["eḍ-", either_1],
		["eḏ-", either_1],
		["eṣ-", either_1],
		["eṭ-", either_1],
		["eṯ-", either_1],
		["eẓ-", either_1],
		["het", always_non_dropping_1],
		["i", always_non_dropping_1],
		["il", always_dropping_1],
		["im", always_non_dropping_1],
		["in 't", always_non_dropping_2],
		["in de", always_non_dropping_2],
		["in den", always_non_dropping_2],
		["in der", either_2],
		["in het", always_non_dropping_2],
		["in t", always_non_dropping_2],
		["in", always_non_dropping_1],
		["l", always_non_dropping_1],
		["l'", always_non_dropping_1],
		["la", always_non_dropping_1],
		["las", always_non_dropping_1],
		["le", always_non_dropping_1],
		["les", either_1],
		["lo", either_1],
		["los", always_non_dropping_1],
		["lou", always_non_dropping_1],
		["of", always_non_dropping_1],
		["onder 't", always_non_dropping_2],
		["onder de", always_non_dropping_2],
		["onder den", always_non_dropping_2],
		["onder het", always_non_dropping_2],
		["onder t", always_non_dropping_2],
		["onder", always_non_dropping_1],
		["op 't", always_non_dropping_2],
		["op de", either_2],
		["op den", always_non_dropping_2],
		["op der", always_non_dropping_2],
		["op gen", always_non_dropping_2],
		["op het", always_non_dropping_2],
		["op t", always_non_dropping_2],
		["op ten", always_non_dropping_2],
		["op", always_non_dropping_1],
		["over 't", always_non_dropping_2],
		["over de", always_non_dropping_2],
		["over den", always_non_dropping_2],
		["over het", always_non_dropping_2],
		["over t", always_non_dropping_2],
		["over", always_non_dropping_1],
		["s", always_non_dropping_1],
		["s'", always_non_dropping_1],
		["sen", always_dropping_1],
		["t", always_non_dropping_1],
		["te", always_non_dropping_1],
		["ten", always_non_dropping_1],
		["ter", always_non_dropping_1],
		["tho", always_non_dropping_1],
		["thoe", always_non_dropping_1],
		["thor", always_non_dropping_1],
		["to", always_non_dropping_1],
		["toe", always_non_dropping_1],
		["tot", always_non_dropping_1],
		["uijt 't", always_non_dropping_2],
		["uijt de", always_non_dropping_2],
		["uijt den", always_non_dropping_2],
		["uijt te de", always_non_dropping_3],
		["uijt ten", always_non_dropping_2],
		["uijt", always_non_dropping_1],
		["uit 't", always_non_dropping_2],
		["uit de", always_non_dropping_2],
		["uit den", always_non_dropping_2],
		["uit het", always_non_dropping_2],
		["uit t", always_non_dropping_2],
		["uit te de", always_non_dropping_3],
		["uit ten", always_non_dropping_2],
		["uit", always_non_dropping_1],
		["unter", always_non_dropping_1],
		["v", always_non_dropping_1],
		["v.", always_non_dropping_1],
		["v.d.", always_non_dropping_1],
		["van 't", always_non_dropping_2],
		["van de l", always_non_dropping_3],
		["van de l'", always_non_dropping_3],
		["van de", always_non_dropping_2],
		["van de", always_non_dropping_2],
		["van den", always_non_dropping_2],
		["van der", always_non_dropping_2],
		["van gen", always_non_dropping_2],
		["van het", always_non_dropping_2],
		["van la", always_non_dropping_2],
		["van t", always_non_dropping_2],
		["van ter", always_non_dropping_2],
		["van van de", always_non_dropping_3],
		["van", either_1],
		["vander", always_non_dropping_1],
		["vd", always_non_dropping_1],
		["ver", always_non_dropping_1],
		["vom und zum", always_dropping_3],
		["vom", either_1],
		["von 't", always_non_dropping_2],
		["von dem", either_2_dropping_best],
		["von den", either_2_dropping_best],
		["von der", either_2_dropping_best],
		["von t", always_non_dropping_2],
		["von und zu", either_3_dropping_best],
		["von zu", either_2_dropping_best],
		["von", either_1_dropping_best],
		["voor 't", always_non_dropping_2],
		["voor de", always_non_dropping_2],
		["voor den", always_non_dropping_2],
		["voor in 't", always_non_dropping_3],
		["voor in t", always_non_dropping_3],
		["voor", always_non_dropping_1],
		["vor der", either_2_dropping_best],
		["vor", either_1_dropping_best],
		["z", always_dropping_1],
		["ze", always_dropping_1],
		["zu", either_1_dropping_best],
		["zum", either_1],
		["zur", either_1]
	];
    return PARTICLES;
}();
CSL.parseParticles = function(){
    function splitParticles(nameValue, firstNameFlag, caseOverride) {
		var origNameValue = nameValue;
		nameValue = caseOverride ? nameValue.toLowerCase() : nameValue;
		var particleList = [];
		var apostrophe;
		var rex;
		if (firstNameFlag) {
			nameValue = nameValue.split("").reverse().join("");
			rex = CSL.PARTICLE_GIVEN_REGEXP;
		} else {
			rex = CSL.PARTICLE_FAMILY_REGEXP;
		}
		var m = nameValue.match(rex);
		while (m) {
			var m1 = firstNameFlag ? m[1].split("").reverse().join("") : m[1];
			var firstChar = m ? m1 : false;
			var firstChar = firstChar ? m1.replace(/^[-\'\u02bb\u2019\s]*(.).*$/, "$1") : false;
			var hasParticle = firstChar ? firstChar.toUpperCase() !== firstChar : false;
			if (!hasParticle) break;
			if (firstNameFlag) {
				particleList.push(origNameValue.slice(m1.length * -1));
				origNameValue = origNameValue.slice(0,m1.length * -1);
			} else {
				particleList.push(origNameValue.slice(0,m1.length));
				origNameValue = origNameValue.slice(m1.length);
			}
			nameValue = m[2];
			m = nameValue.match(rex);
		}
		if (firstNameFlag) {
			nameValue = nameValue.split("").reverse().join("");
			particleList.reverse();
			for (var i=1,ilen=particleList.length;i<ilen;i++) {
				if (particleList[i].slice(0, 1) == " ") {
					particleList[i-1] += " ";
				}
			}
			for (var i=0,ilen=particleList.length;i<ilen;i++) {
				if (particleList[i].slice(0, 1) == " ") {
					particleList[i] = particleList[i].slice(1);
				}
			}
			nameValue = origNameValue.slice(0, nameValue.length);
		} else {
			nameValue = origNameValue.slice(nameValue.length * -1);
		}
		return [hasParticle, nameValue, particleList];
	}
    function trimLast(str) {
        var lastChar = str.slice(-1);
        str = str.trim();
        if (lastChar === " " && ["\'", "\u2019"].indexOf(str.slice(-1)) > -1) {
            str += " ";
        }
        return str;
    }
    function parseSuffix(nameObj) {
        if (!nameObj.suffix && nameObj.given) {
            var m = nameObj.given.match(/(\s*,!*\s*)/);
            if (m) {
                var idx = nameObj.given.indexOf(m[1]);
                var possible_suffix = nameObj.given.slice(idx + m[1].length);
                var possible_comma = nameObj.given.slice(idx, idx + m[1].length).replace(/\s*/g, "");
                if (possible_suffix.replace(/\./g, "") === 'et al' && !nameObj["dropping-particle"]) {
                    nameObj["dropping-particle"] = possible_suffix;
                    nameObj["comma-dropping-particle"] = ",";
                } else {
                    if (possible_comma.length === 2) {
                        nameObj["comma-suffix"] = true;
                    }
                    nameObj.suffix = possible_suffix;
                }
                nameObj.given = nameObj.given.slice(0, idx);
            }
        }
    }
    return function(nameObj) {
        var res = splitParticles(nameObj.family);
        var hasLastParticle = res[0];
        var lastNameValue = res[1];
        var lastParticleList = res[2];
        nameObj.family = lastNameValue;
        var nonDroppingParticle = trimLast(lastParticleList.join(""));
        if (nonDroppingParticle) {
            nameObj['non-dropping-particle'] = nonDroppingParticle;
        }
        parseSuffix(nameObj);
        var res = splitParticles(nameObj.given, true);
        var hasFirstParticle = res[0];
        var firstNameValue = res[1];
        var firstParticleList = res[2];
        nameObj.given = firstNameValue;
        var droppingParticle = firstParticleList.join("").trim();
        if (droppingParticle) {
            nameObj['dropping-particle'] = droppingParticle;
        }
    }
}();
module.exports = CSL;

},{}],3:[function(require,module,exports){
// This file can be required in Browserify and Node.js for automatic polyfill
// To use it:  require('es6-promise/auto');
'use strict';
module.exports = require('./').polyfill();

},{"./":4}],4:[function(require,module,exports){
(function (process,global){
/*!
 * @overview es6-promise - a tiny implementation of Promises/A+.
 * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
 * @license   Licensed under MIT license
 *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
 * @version   4.1.1
 */

(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
	typeof define === 'function' && define.amd ? define(factory) :
	(global.ES6Promise = factory());
}(this, (function () { 'use strict';

function objectOrFunction(x) {
  var type = typeof x;
  return x !== null && (type === 'object' || type === 'function');
}

function isFunction(x) {
  return typeof x === 'function';
}

var _isArray = undefined;
if (Array.isArray) {
  _isArray = Array.isArray;
} else {
  _isArray = function (x) {
    return Object.prototype.toString.call(x) === '[object Array]';
  };
}

var isArray = _isArray;

var len = 0;
var vertxNext = undefined;
var customSchedulerFn = undefined;

var asap = function asap(callback, arg) {
  queue[len] = callback;
  queue[len + 1] = arg;
  len += 2;
  if (len === 2) {
    // If len is 2, that means that we need to schedule an async flush.
    // If additional callbacks are queued before the queue is flushed, they
    // will be processed by this flush that we are scheduling.
    if (customSchedulerFn) {
      customSchedulerFn(flush);
    } else {
      scheduleFlush();
    }
  }
};

function setScheduler(scheduleFn) {
  customSchedulerFn = scheduleFn;
}

function setAsap(asapFn) {
  asap = asapFn;
}

var browserWindow = typeof window !== 'undefined' ? window : undefined;
var browserGlobal = browserWindow || {};
var BrowserMutationObserver = browserGlobal.MutationObserver || browserGlobal.WebKitMutationObserver;
var isNode = typeof self === 'undefined' && typeof process !== 'undefined' && ({}).toString.call(process) === '[object process]';

// test for web worker but not in IE10
var isWorker = typeof Uint8ClampedArray !== 'undefined' && typeof importScripts !== 'undefined' && typeof MessageChannel !== 'undefined';

// node
function useNextTick() {
  // node version 0.10.x displays a deprecation warning when nextTick is used recursively
  // see https://github.com/cujojs/when/issues/410 for details
  return function () {
    return process.nextTick(flush);
  };
}

// vertx
function useVertxTimer() {
  if (typeof vertxNext !== 'undefined') {
    return function () {
      vertxNext(flush);
    };
  }

  return useSetTimeout();
}

function useMutationObserver() {
  var iterations = 0;
  var observer = new BrowserMutationObserver(flush);
  var node = document.createTextNode('');
  observer.observe(node, { characterData: true });

  return function () {
    node.data = iterations = ++iterations % 2;
  };
}

// web worker
function useMessageChannel() {
  var channel = new MessageChannel();
  channel.port1.onmessage = flush;
  return function () {
    return channel.port2.postMessage(0);
  };
}

function useSetTimeout() {
  // Store setTimeout reference so es6-promise will be unaffected by
  // other code modifying setTimeout (like sinon.useFakeTimers())
  var globalSetTimeout = setTimeout;
  return function () {
    return globalSetTimeout(flush, 1);
  };
}

var queue = new Array(1000);
function flush() {
  for (var i = 0; i < len; i += 2) {
    var callback = queue[i];
    var arg = queue[i + 1];

    callback(arg);

    queue[i] = undefined;
    queue[i + 1] = undefined;
  }

  len = 0;
}

function attemptVertx() {
  try {
    var r = require;
    var vertx = r('vertx');
    vertxNext = vertx.runOnLoop || vertx.runOnContext;
    return useVertxTimer();
  } catch (e) {
    return useSetTimeout();
  }
}

var scheduleFlush = undefined;
// Decide what async method to use to triggering processing of queued callbacks:
if (isNode) {
  scheduleFlush = useNextTick();
} else if (BrowserMutationObserver) {
  scheduleFlush = useMutationObserver();
} else if (isWorker) {
  scheduleFlush = useMessageChannel();
} else if (browserWindow === undefined && typeof require === 'function') {
  scheduleFlush = attemptVertx();
} else {
  scheduleFlush = useSetTimeout();
}

function then(onFulfillment, onRejection) {
  var _arguments = arguments;

  var parent = this;

  var child = new this.constructor(noop);

  if (child[PROMISE_ID] === undefined) {
    makePromise(child);
  }

  var _state = parent._state;

  if (_state) {
    (function () {
      var callback = _arguments[_state - 1];
      asap(function () {
        return invokeCallback(_state, child, callback, parent._result);
      });
    })();
  } else {
    subscribe(parent, child, onFulfillment, onRejection);
  }

  return child;
}

/**
  `Promise.resolve` returns a promise that will become resolved with the
  passed `value`. It is shorthand for the following:

  ```javascript
  let promise = new Promise(function(resolve, reject){
    resolve(1);
  });

  promise.then(function(value){
    // value === 1
  });
  ```

  Instead of writing the above, your code now simply becomes the following:

  ```javascript
  let promise = Promise.resolve(1);

  promise.then(function(value){
    // value === 1
  });
  ```

  @method resolve
  @static
  @param {Any} value value that the returned promise will be resolved with
  Useful for tooling.
  @return {Promise} a promise that will become fulfilled with the given
  `value`
*/
function resolve$1(object) {
  /*jshint validthis:true */
  var Constructor = this;

  if (object && typeof object === 'object' && object.constructor === Constructor) {
    return object;
  }

  var promise = new Constructor(noop);
  resolve(promise, object);
  return promise;
}

var PROMISE_ID = Math.random().toString(36).substring(16);

function noop() {}

var PENDING = void 0;
var FULFILLED = 1;
var REJECTED = 2;

var GET_THEN_ERROR = new ErrorObject();

function selfFulfillment() {
  return new TypeError("You cannot resolve a promise with itself");
}

function cannotReturnOwn() {
  return new TypeError('A promises callback cannot return that same promise.');
}

function getThen(promise) {
  try {
    return promise.then;
  } catch (error) {
    GET_THEN_ERROR.error = error;
    return GET_THEN_ERROR;
  }
}

function tryThen(then$$1, value, fulfillmentHandler, rejectionHandler) {
  try {
    then$$1.call(value, fulfillmentHandler, rejectionHandler);
  } catch (e) {
    return e;
  }
}

function handleForeignThenable(promise, thenable, then$$1) {
  asap(function (promise) {
    var sealed = false;
    var error = tryThen(then$$1, thenable, function (value) {
      if (sealed) {
        return;
      }
      sealed = true;
      if (thenable !== value) {
        resolve(promise, value);
      } else {
        fulfill(promise, value);
      }
    }, function (reason) {
      if (sealed) {
        return;
      }
      sealed = true;

      reject(promise, reason);
    }, 'Settle: ' + (promise._label || ' unknown promise'));

    if (!sealed && error) {
      sealed = true;
      reject(promise, error);
    }
  }, promise);
}

function handleOwnThenable(promise, thenable) {
  if (thenable._state === FULFILLED) {
    fulfill(promise, thenable._result);
  } else if (thenable._state === REJECTED) {
    reject(promise, thenable._result);
  } else {
    subscribe(thenable, undefined, function (value) {
      return resolve(promise, value);
    }, function (reason) {
      return reject(promise, reason);
    });
  }
}

function handleMaybeThenable(promise, maybeThenable, then$$1) {
  if (maybeThenable.constructor === promise.constructor && then$$1 === then && maybeThenable.constructor.resolve === resolve$1) {
    handleOwnThenable(promise, maybeThenable);
  } else {
    if (then$$1 === GET_THEN_ERROR) {
      reject(promise, GET_THEN_ERROR.error);
      GET_THEN_ERROR.error = null;
    } else if (then$$1 === undefined) {
      fulfill(promise, maybeThenable);
    } else if (isFunction(then$$1)) {
      handleForeignThenable(promise, maybeThenable, then$$1);
    } else {
      fulfill(promise, maybeThenable);
    }
  }
}

function resolve(promise, value) {
  if (promise === value) {
    reject(promise, selfFulfillment());
  } else if (objectOrFunction(value)) {
    handleMaybeThenable(promise, value, getThen(value));
  } else {
    fulfill(promise, value);
  }
}

function publishRejection(promise) {
  if (promise._onerror) {
    promise._onerror(promise._result);
  }

  publish(promise);
}

function fulfill(promise, value) {
  if (promise._state !== PENDING) {
    return;
  }

  promise._result = value;
  promise._state = FULFILLED;

  if (promise._subscribers.length !== 0) {
    asap(publish, promise);
  }
}

function reject(promise, reason) {
  if (promise._state !== PENDING) {
    return;
  }
  promise._state = REJECTED;
  promise._result = reason;

  asap(publishRejection, promise);
}

function subscribe(parent, child, onFulfillment, onRejection) {
  var _subscribers = parent._subscribers;
  var length = _subscribers.length;

  parent._onerror = null;

  _subscribers[length] = child;
  _subscribers[length + FULFILLED] = onFulfillment;
  _subscribers[length + REJECTED] = onRejection;

  if (length === 0 && parent._state) {
    asap(publish, parent);
  }
}

function publish(promise) {
  var subscribers = promise._subscribers;
  var settled = promise._state;

  if (subscribers.length === 0) {
    return;
  }

  var child = undefined,
      callback = undefined,
      detail = promise._result;

  for (var i = 0; i < subscribers.length; i += 3) {
    child = subscribers[i];
    callback = subscribers[i + settled];

    if (child) {
      invokeCallback(settled, child, callback, detail);
    } else {
      callback(detail);
    }
  }

  promise._subscribers.length = 0;
}

function ErrorObject() {
  this.error = null;
}

var TRY_CATCH_ERROR = new ErrorObject();

function tryCatch(callback, detail) {
  try {
    return callback(detail);
  } catch (e) {
    TRY_CATCH_ERROR.error = e;
    return TRY_CATCH_ERROR;
  }
}

function invokeCallback(settled, promise, callback, detail) {
  var hasCallback = isFunction(callback),
      value = undefined,
      error = undefined,
      succeeded = undefined,
      failed = undefined;

  if (hasCallback) {
    value = tryCatch(callback, detail);

    if (value === TRY_CATCH_ERROR) {
      failed = true;
      error = value.error;
      value.error = null;
    } else {
      succeeded = true;
    }

    if (promise === value) {
      reject(promise, cannotReturnOwn());
      return;
    }
  } else {
    value = detail;
    succeeded = true;
  }

  if (promise._state !== PENDING) {
    // noop
  } else if (hasCallback && succeeded) {
      resolve(promise, value);
    } else if (failed) {
      reject(promise, error);
    } else if (settled === FULFILLED) {
      fulfill(promise, value);
    } else if (settled === REJECTED) {
      reject(promise, value);
    }
}

function initializePromise(promise, resolver) {
  try {
    resolver(function resolvePromise(value) {
      resolve(promise, value);
    }, function rejectPromise(reason) {
      reject(promise, reason);
    });
  } catch (e) {
    reject(promise, e);
  }
}

var id = 0;
function nextId() {
  return id++;
}

function makePromise(promise) {
  promise[PROMISE_ID] = id++;
  promise._state = undefined;
  promise._result = undefined;
  promise._subscribers = [];
}

function Enumerator$1(Constructor, input) {
  this._instanceConstructor = Constructor;
  this.promise = new Constructor(noop);

  if (!this.promise[PROMISE_ID]) {
    makePromise(this.promise);
  }

  if (isArray(input)) {
    this.length = input.length;
    this._remaining = input.length;

    this._result = new Array(this.length);

    if (this.length === 0) {
      fulfill(this.promise, this._result);
    } else {
      this.length = this.length || 0;
      this._enumerate(input);
      if (this._remaining === 0) {
        fulfill(this.promise, this._result);
      }
    }
  } else {
    reject(this.promise, validationError());
  }
}

function validationError() {
  return new Error('Array Methods must be provided an Array');
}

Enumerator$1.prototype._enumerate = function (input) {
  for (var i = 0; this._state === PENDING && i < input.length; i++) {
    this._eachEntry(input[i], i);
  }
};

Enumerator$1.prototype._eachEntry = function (entry, i) {
  var c = this._instanceConstructor;
  var resolve$$1 = c.resolve;

  if (resolve$$1 === resolve$1) {
    var _then = getThen(entry);

    if (_then === then && entry._state !== PENDING) {
      this._settledAt(entry._state, i, entry._result);
    } else if (typeof _then !== 'function') {
      this._remaining--;
      this._result[i] = entry;
    } else if (c === Promise$2) {
      var promise = new c(noop);
      handleMaybeThenable(promise, entry, _then);
      this._willSettleAt(promise, i);
    } else {
      this._willSettleAt(new c(function (resolve$$1) {
        return resolve$$1(entry);
      }), i);
    }
  } else {
    this._willSettleAt(resolve$$1(entry), i);
  }
};

Enumerator$1.prototype._settledAt = function (state, i, value) {
  var promise = this.promise;

  if (promise._state === PENDING) {
    this._remaining--;

    if (state === REJECTED) {
      reject(promise, value);
    } else {
      this._result[i] = value;
    }
  }

  if (this._remaining === 0) {
    fulfill(promise, this._result);
  }
};

Enumerator$1.prototype._willSettleAt = function (promise, i) {
  var enumerator = this;

  subscribe(promise, undefined, function (value) {
    return enumerator._settledAt(FULFILLED, i, value);
  }, function (reason) {
    return enumerator._settledAt(REJECTED, i, reason);
  });
};

/**
  `Promise.all` accepts an array of promises, and returns a new promise which
  is fulfilled with an array of fulfillment values for the passed promises, or
  rejected with the reason of the first passed promise to be rejected. It casts all
  elements of the passed iterable to promises as it runs this algorithm.

  Example:

  ```javascript
  let promise1 = resolve(1);
  let promise2 = resolve(2);
  let promise3 = resolve(3);
  let promises = [ promise1, promise2, promise3 ];

  Promise.all(promises).then(function(array){
    // The array here would be [ 1, 2, 3 ];
  });
  ```

  If any of the `promises` given to `all` are rejected, the first promise
  that is rejected will be given as an argument to the returned promises's
  rejection handler. For example:

  Example:

  ```javascript
  let promise1 = resolve(1);
  let promise2 = reject(new Error("2"));
  let promise3 = reject(new Error("3"));
  let promises = [ promise1, promise2, promise3 ];

  Promise.all(promises).then(function(array){
    // Code here never runs because there are rejected promises!
  }, function(error) {
    // error.message === "2"
  });
  ```

  @method all
  @static
  @param {Array} entries array of promises
  @param {String} label optional string for labeling the promise.
  Useful for tooling.
  @return {Promise} promise that is fulfilled when all `promises` have been
  fulfilled, or rejected if any of them become rejected.
  @static
*/
function all$1(entries) {
  return new Enumerator$1(this, entries).promise;
}

/**
  `Promise.race` returns a new promise which is settled in the same way as the
  first passed promise to settle.

  Example:

  ```javascript
  let promise1 = new Promise(function(resolve, reject){
    setTimeout(function(){
      resolve('promise 1');
    }, 200);
  });

  let promise2 = new Promise(function(resolve, reject){
    setTimeout(function(){
      resolve('promise 2');
    }, 100);
  });

  Promise.race([promise1, promise2]).then(function(result){
    // result === 'promise 2' because it was resolved before promise1
    // was resolved.
  });
  ```

  `Promise.race` is deterministic in that only the state of the first
  settled promise matters. For example, even if other promises given to the
  `promises` array argument are resolved, but the first settled promise has
  become rejected before the other promises became fulfilled, the returned
  promise will become rejected:

  ```javascript
  let promise1 = new Promise(function(resolve, reject){
    setTimeout(function(){
      resolve('promise 1');
    }, 200);
  });

  let promise2 = new Promise(function(resolve, reject){
    setTimeout(function(){
      reject(new Error('promise 2'));
    }, 100);
  });

  Promise.race([promise1, promise2]).then(function(result){
    // Code here never runs
  }, function(reason){
    // reason.message === 'promise 2' because promise 2 became rejected before
    // promise 1 became fulfilled
  });
  ```

  An example real-world use case is implementing timeouts:

  ```javascript
  Promise.race([ajax('foo.json'), timeout(5000)])
  ```

  @method race
  @static
  @param {Array} promises array of promises to observe
  Useful for tooling.
  @return {Promise} a promise which settles in the same way as the first passed
  promise to settle.
*/
function race$1(entries) {
  /*jshint validthis:true */
  var Constructor = this;

  if (!isArray(entries)) {
    return new Constructor(function (_, reject) {
      return reject(new TypeError('You must pass an array to race.'));
    });
  } else {
    return new Constructor(function (resolve, reject) {
      var length = entries.length;
      for (var i = 0; i < length; i++) {
        Constructor.resolve(entries[i]).then(resolve, reject);
      }
    });
  }
}

/**
  `Promise.reject` returns a promise rejected with the passed `reason`.
  It is shorthand for the following:

  ```javascript
  let promise = new Promise(function(resolve, reject){
    reject(new Error('WHOOPS'));
  });

  promise.then(function(value){
    // Code here doesn't run because the promise is rejected!
  }, function(reason){
    // reason.message === 'WHOOPS'
  });
  ```

  Instead of writing the above, your code now simply becomes the following:

  ```javascript
  let promise = Promise.reject(new Error('WHOOPS'));

  promise.then(function(value){
    // Code here doesn't run because the promise is rejected!
  }, function(reason){
    // reason.message === 'WHOOPS'
  });
  ```

  @method reject
  @static
  @param {Any} reason value that the returned promise will be rejected with.
  Useful for tooling.
  @return {Promise} a promise rejected with the given `reason`.
*/
function reject$1(reason) {
  /*jshint validthis:true */
  var Constructor = this;
  var promise = new Constructor(noop);
  reject(promise, reason);
  return promise;
}

function needsResolver() {
  throw new TypeError('You must pass a resolver function as the first argument to the promise constructor');
}

function needsNew() {
  throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");
}

/**
  Promise objects represent the eventual result of an asynchronous operation. The
  primary way of interacting with a promise is through its `then` method, which
  registers callbacks to receive either a promise's eventual value or the reason
  why the promise cannot be fulfilled.

  Terminology
  -----------

  - `promise` is an object or function with a `then` method whose behavior conforms to this specification.
  - `thenable` is an object or function that defines a `then` method.
  - `value` is any legal JavaScript value (including undefined, a thenable, or a promise).
  - `exception` is a value that is thrown using the throw statement.
  - `reason` is a value that indicates why a promise was rejected.
  - `settled` the final resting state of a promise, fulfilled or rejected.

  A promise can be in one of three states: pending, fulfilled, or rejected.

  Promises that are fulfilled have a fulfillment value and are in the fulfilled
  state.  Promises that are rejected have a rejection reason and are in the
  rejected state.  A fulfillment value is never a thenable.

  Promises can also be said to *resolve* a value.  If this value is also a
  promise, then the original promise's settled state will match the value's
  settled state.  So a promise that *resolves* a promise that rejects will
  itself reject, and a promise that *resolves* a promise that fulfills will
  itself fulfill.


  Basic Usage:
  ------------

  ```js
  let promise = new Promise(function(resolve, reject) {
    // on success
    resolve(value);

    // on failure
    reject(reason);
  });

  promise.then(function(value) {
    // on fulfillment
  }, function(reason) {
    // on rejection
  });
  ```

  Advanced Usage:
  ---------------

  Promises shine when abstracting away asynchronous interactions such as
  `XMLHttpRequest`s.

  ```js
  function getJSON(url) {
    return new Promise(function(resolve, reject){
      let xhr = new XMLHttpRequest();

      xhr.open('GET', url);
      xhr.onreadystatechange = handler;
      xhr.responseType = 'json';
      xhr.setRequestHeader('Accept', 'application/json');
      xhr.send();

      function handler() {
        if (this.readyState === this.DONE) {
          if (this.status === 200) {
            resolve(this.response);
          } else {
            reject(new Error('getJSON: `' + url + '` failed with status: [' + this.status + ']'));
          }
        }
      };
    });
  }

  getJSON('/posts.json').then(function(json) {
    // on fulfillment
  }, function(reason) {
    // on rejection
  });
  ```

  Unlike callbacks, promises are great composable primitives.

  ```js
  Promise.all([
    getJSON('/posts'),
    getJSON('/comments')
  ]).then(function(values){
    values[0] // => postsJSON
    values[1] // => commentsJSON

    return values;
  });
  ```

  @class Promise
  @param {function} resolver
  Useful for tooling.
  @constructor
*/
function Promise$2(resolver) {
  this[PROMISE_ID] = nextId();
  this._result = this._state = undefined;
  this._subscribers = [];

  if (noop !== resolver) {
    typeof resolver !== 'function' && needsResolver();
    this instanceof Promise$2 ? initializePromise(this, resolver) : needsNew();
  }
}

Promise$2.all = all$1;
Promise$2.race = race$1;
Promise$2.resolve = resolve$1;
Promise$2.reject = reject$1;
Promise$2._setScheduler = setScheduler;
Promise$2._setAsap = setAsap;
Promise$2._asap = asap;

Promise$2.prototype = {
  constructor: Promise$2,

  /**
    The primary way of interacting with a promise is through its `then` method,
    which registers callbacks to receive either a promise's eventual value or the
    reason why the promise cannot be fulfilled.
  
    ```js
    findUser().then(function(user){
      // user is available
    }, function(reason){
      // user is unavailable, and you are given the reason why
    });
    ```
  
    Chaining
    --------
  
    The return value of `then` is itself a promise.  This second, 'downstream'
    promise is resolved with the return value of the first promise's fulfillment
    or rejection handler, or rejected if the handler throws an exception.
  
    ```js
    findUser().then(function (user) {
      return user.name;
    }, function (reason) {
      return 'default name';
    }).then(function (userName) {
      // If `findUser` fulfilled, `userName` will be the user's name, otherwise it
      // will be `'default name'`
    });
  
    findUser().then(function (user) {
      throw new Error('Found user, but still unhappy');
    }, function (reason) {
      throw new Error('`findUser` rejected and we're unhappy');
    }).then(function (value) {
      // never reached
    }, function (reason) {
      // if `findUser` fulfilled, `reason` will be 'Found user, but still unhappy'.
      // If `findUser` rejected, `reason` will be '`findUser` rejected and we're unhappy'.
    });
    ```
    If the downstream promise does not specify a rejection handler, rejection reasons will be propagated further downstream.
  
    ```js
    findUser().then(function (user) {
      throw new PedagogicalException('Upstream error');
    }).then(function (value) {
      // never reached
    }).then(function (value) {
      // never reached
    }, function (reason) {
      // The `PedgagocialException` is propagated all the way down to here
    });
    ```
  
    Assimilation
    ------------
  
    Sometimes the value you want to propagate to a downstream promise can only be
    retrieved asynchronously. This can be achieved by returning a promise in the
    fulfillment or rejection handler. The downstream promise will then be pending
    until the returned promise is settled. This is called *assimilation*.
  
    ```js
    findUser().then(function (user) {
      return findCommentsByAuthor(user);
    }).then(function (comments) {
      // The user's comments are now available
    });
    ```
  
    If the assimliated promise rejects, then the downstream promise will also reject.
  
    ```js
    findUser().then(function (user) {
      return findCommentsByAuthor(user);
    }).then(function (comments) {
      // If `findCommentsByAuthor` fulfills, we'll have the value here
    }, function (reason) {
      // If `findCommentsByAuthor` rejects, we'll have the reason here
    });
    ```
  
    Simple Example
    --------------
  
    Synchronous Example
  
    ```javascript
    let result;
  
    try {
      result = findResult();
      // success
    } catch(reason) {
      // failure
    }
    ```
  
    Errback Example
  
    ```js
    findResult(function(result, err){
      if (err) {
        // failure
      } else {
        // success
      }
    });
    ```
  
    Promise Example;
  
    ```javascript
    findResult().then(function(result){
      // success
    }, function(reason){
      // failure
    });
    ```
  
    Advanced Example
    --------------
  
    Synchronous Example
  
    ```javascript
    let author, books;
  
    try {
      author = findAuthor();
      books  = findBooksByAuthor(author);
      // success
    } catch(reason) {
      // failure
    }
    ```
  
    Errback Example
  
    ```js
  
    function foundBooks(books) {
  
    }
  
    function failure(reason) {
  
    }
  
    findAuthor(function(author, err){
      if (err) {
        failure(err);
        // failure
      } else {
        try {
          findBoooksByAuthor(author, function(books, err) {
            if (err) {
              failure(err);
            } else {
              try {
                foundBooks(books);
              } catch(reason) {
                failure(reason);
              }
            }
          });
        } catch(error) {
          failure(err);
        }
        // success
      }
    });
    ```
  
    Promise Example;
  
    ```javascript
    findAuthor().
      then(findBooksByAuthor).
      then(function(books){
        // found books
    }).catch(function(reason){
      // something went wrong
    });
    ```
  
    @method then
    @param {Function} onFulfilled
    @param {Function} onRejected
    Useful for tooling.
    @return {Promise}
  */
  then: then,

  /**
    `catch` is simply sugar for `then(undefined, onRejection)` which makes it the same
    as the catch block of a try/catch statement.
  
    ```js
    function findAuthor(){
      throw new Error('couldn't find that author');
    }
  
    // synchronous
    try {
      findAuthor();
    } catch(reason) {
      // something went wrong
    }
  
    // async with promises
    findAuthor().catch(function(reason){
      // something went wrong
    });
    ```
  
    @method catch
    @param {Function} onRejection
    Useful for tooling.
    @return {Promise}
  */
  'catch': function _catch(onRejection) {
    return this.then(null, onRejection);
  }
};

/*global self*/
function polyfill$1() {
    var local = undefined;

    if (typeof global !== 'undefined') {
        local = global;
    } else if (typeof self !== 'undefined') {
        local = self;
    } else {
        try {
            local = Function('return this')();
        } catch (e) {
            throw new Error('polyfill failed because global object is unavailable in this environment');
        }
    }

    var P = local.Promise;

    if (P) {
        var promiseToString = null;
        try {
            promiseToString = Object.prototype.toString.call(P.resolve());
        } catch (e) {
            // silently ignored
        }

        if (promiseToString === '[object Promise]' && !P.cast) {
            return;
        }
    }

    local.Promise = Promise$2;
}

// Strange compat..
Promise$2.polyfill = polyfill$1;
Promise$2.Promise = Promise$2;

return Promise$2;

})));



}).call(this,require('_process'),typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})

},{"_process":6}],5:[function(require,module,exports){
// the whatwg-fetch polyfill installs the fetch() function
// on the global object (window or self)
//
// Return that as the export for use in Webpack, Browserify etc.
require('whatwg-fetch');
module.exports = self.fetch.bind(self);

},{"whatwg-fetch":7}],6:[function(require,module,exports){
// shim for using process in browser
var process = module.exports = {};

// cached from whatever global is present so that test runners that stub it
// don't break things.  But we need to wrap it in a try catch in case it is
// wrapped in strict mode code which doesn't define any globals.  It's inside a
// function because try/catches deoptimize in certain engines.

var cachedSetTimeout;
var cachedClearTimeout;

function defaultSetTimout() {
    throw new Error('setTimeout has not been defined');
}
function defaultClearTimeout () {
    throw new Error('clearTimeout has not been defined');
}
(function () {
    try {
        if (typeof setTimeout === 'function') {
            cachedSetTimeout = setTimeout;
        } else {
            cachedSetTimeout = defaultSetTimout;
        }
    } catch (e) {
        cachedSetTimeout = defaultSetTimout;
    }
    try {
        if (typeof clearTimeout === 'function') {
            cachedClearTimeout = clearTimeout;
        } else {
            cachedClearTimeout = defaultClearTimeout;
        }
    } catch (e) {
        cachedClearTimeout = defaultClearTimeout;
    }
} ())
function runTimeout(fun) {
    if (cachedSetTimeout === setTimeout) {
        //normal enviroments in sane situations
        return setTimeout(fun, 0);
    }
    // if setTimeout wasn't available but was latter defined
    if ((cachedSetTimeout === defaultSetTimout || !cachedSetTimeout) && setTimeout) {
        cachedSetTimeout = setTimeout;
        return setTimeout(fun, 0);
    }
    try {
        // when when somebody has screwed with setTimeout but no I.E. maddness
        return cachedSetTimeout(fun, 0);
    } catch(e){
        try {
            // When we are in I.E. but the script has been evaled so I.E. doesn't trust the global object when called normally
            return cachedSetTimeout.call(null, fun, 0);
        } catch(e){
            // same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error
            return cachedSetTimeout.call(this, fun, 0);
        }
    }


}
function runClearTimeout(marker) {
    if (cachedClearTimeout === clearTimeout) {
        //normal enviroments in sane situations
        return clearTimeout(marker);
    }
    // if clearTimeout wasn't available but was latter defined
    if ((cachedClearTimeout === defaultClearTimeout || !cachedClearTimeout) && clearTimeout) {
        cachedClearTimeout = clearTimeout;
        return clearTimeout(marker);
    }
    try {
        // when when somebody has screwed with setTimeout but no I.E. maddness
        return cachedClearTimeout(marker);
    } catch (e){
        try {
            // When we are in I.E. but the script has been evaled so I.E. doesn't  trust the global object when called normally
            return cachedClearTimeout.call(null, marker);
        } catch (e){
            // same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error.
            // Some versions of I.E. have different rules for clearTimeout vs setTimeout
            return cachedClearTimeout.call(this, marker);
        }
    }



}
var queue = [];
var draining = false;
var currentQueue;
var queueIndex = -1;

function cleanUpNextTick() {
    if (!draining || !currentQueue) {
        return;
    }
    draining = false;
    if (currentQueue.length) {
        queue = currentQueue.concat(queue);
    } else {
        queueIndex = -1;
    }
    if (queue.length) {
        drainQueue();
    }
}

function drainQueue() {
    if (draining) {
        return;
    }
    var timeout = runTimeout(cleanUpNextTick);
    draining = true;

    var len = queue.length;
    while(len) {
        currentQueue = queue;
        queue = [];
        while (++queueIndex < len) {
            if (currentQueue) {
                currentQueue[queueIndex].run();
            }
        }
        queueIndex = -1;
        len = queue.length;
    }
    currentQueue = null;
    draining = false;
    runClearTimeout(timeout);
}

process.nextTick = function (fun) {
    var args = new Array(arguments.length - 1);
    if (arguments.length > 1) {
        for (var i = 1; i < arguments.length; i++) {
            args[i - 1] = arguments[i];
        }
    }
    queue.push(new Item(fun, args));
    if (queue.length === 1 && !draining) {
        runTimeout(drainQueue);
    }
};

// v8 likes predictible objects
function Item(fun, array) {
    this.fun = fun;
    this.array = array;
}
Item.prototype.run = function () {
    this.fun.apply(null, this.array);
};
process.title = 'browser';
process.browser = true;
process.env = {};
process.argv = [];
process.version = ''; // empty string to avoid regexp issues
process.versions = {};

function noop() {}

process.on = noop;
process.addListener = noop;
process.once = noop;
process.off = noop;
process.removeListener = noop;
process.removeAllListeners = noop;
process.emit = noop;
process.prependListener = noop;
process.prependOnceListener = noop;

process.listeners = function (name) { return [] }

process.binding = function (name) {
    throw new Error('process.binding is not supported');
};

process.cwd = function () { return '/' };
process.chdir = function (dir) {
    throw new Error('process.chdir is not supported');
};
process.umask = function() { return 0; };

},{}],7:[function(require,module,exports){
(function(self) {
  'use strict';

  if (self.fetch) {
    return
  }

  var support = {
    searchParams: 'URLSearchParams' in self,
    iterable: 'Symbol' in self && 'iterator' in Symbol,
    blob: 'FileReader' in self && 'Blob' in self && (function() {
      try {
        new Blob()
        return true
      } catch(e) {
        return false
      }
    })(),
    formData: 'FormData' in self,
    arrayBuffer: 'ArrayBuffer' in self
  }

  if (support.arrayBuffer) {
    var viewClasses = [
      '[object Int8Array]',
      '[object Uint8Array]',
      '[object Uint8ClampedArray]',
      '[object Int16Array]',
      '[object Uint16Array]',
      '[object Int32Array]',
      '[object Uint32Array]',
      '[object Float32Array]',
      '[object Float64Array]'
    ]

    var isDataView = function(obj) {
      return obj && DataView.prototype.isPrototypeOf(obj)
    }

    var isArrayBufferView = ArrayBuffer.isView || function(obj) {
      return obj && viewClasses.indexOf(Object.prototype.toString.call(obj)) > -1
    }
  }

  function normalizeName(name) {
    if (typeof name !== 'string') {
      name = String(name)
    }
    if (/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(name)) {
      throw new TypeError('Invalid character in header field name')
    }
    return name.toLowerCase()
  }

  function normalizeValue(value) {
    if (typeof value !== 'string') {
      value = String(value)
    }
    return value
  }

  // Build a destructive iterator for the value list
  function iteratorFor(items) {
    var iterator = {
      next: function() {
        var value = items.shift()
        return {done: value === undefined, value: value}
      }
    }

    if (support.iterable) {
      iterator[Symbol.iterator] = function() {
        return iterator
      }
    }

    return iterator
  }

  function Headers(headers) {
    this.map = {}

    if (headers instanceof Headers) {
      headers.forEach(function(value, name) {
        this.append(name, value)
      }, this)
    } else if (Array.isArray(headers)) {
      headers.forEach(function(header) {
        this.append(header[0], header[1])
      }, this)
    } else if (headers) {
      Object.getOwnPropertyNames(headers).forEach(function(name) {
        this.append(name, headers[name])
      }, this)
    }
  }

  Headers.prototype.append = function(name, value) {
    name = normalizeName(name)
    value = normalizeValue(value)
    var oldValue = this.map[name]
    this.map[name] = oldValue ? oldValue+','+value : value
  }

  Headers.prototype['delete'] = function(name) {
    delete this.map[normalizeName(name)]
  }

  Headers.prototype.get = function(name) {
    name = normalizeName(name)
    return this.has(name) ? this.map[name] : null
  }

  Headers.prototype.has = function(name) {
    return this.map.hasOwnProperty(normalizeName(name))
  }

  Headers.prototype.set = function(name, value) {
    this.map[normalizeName(name)] = normalizeValue(value)
  }

  Headers.prototype.forEach = function(callback, thisArg) {
    for (var name in this.map) {
      if (this.map.hasOwnProperty(name)) {
        callback.call(thisArg, this.map[name], name, this)
      }
    }
  }

  Headers.prototype.keys = function() {
    var items = []
    this.forEach(function(value, name) { items.push(name) })
    return iteratorFor(items)
  }

  Headers.prototype.values = function() {
    var items = []
    this.forEach(function(value) { items.push(value) })
    return iteratorFor(items)
  }

  Headers.prototype.entries = function() {
    var items = []
    this.forEach(function(value, name) { items.push([name, value]) })
    return iteratorFor(items)
  }

  if (support.iterable) {
    Headers.prototype[Symbol.iterator] = Headers.prototype.entries
  }

  function consumed(body) {
    if (body.bodyUsed) {
      return Promise.reject(new TypeError('Already read'))
    }
    body.bodyUsed = true
  }

  function fileReaderReady(reader) {
    return new Promise(function(resolve, reject) {
      reader.onload = function() {
        resolve(reader.result)
      }
      reader.onerror = function() {
        reject(reader.error)
      }
    })
  }

  function readBlobAsArrayBuffer(blob) {
    var reader = new FileReader()
    var promise = fileReaderReady(reader)
    reader.readAsArrayBuffer(blob)
    return promise
  }

  function readBlobAsText(blob) {
    var reader = new FileReader()
    var promise = fileReaderReady(reader)
    reader.readAsText(blob)
    return promise
  }

  function readArrayBufferAsText(buf) {
    var view = new Uint8Array(buf)
    var chars = new Array(view.length)

    for (var i = 0; i < view.length; i++) {
      chars[i] = String.fromCharCode(view[i])
    }
    return chars.join('')
  }

  function bufferClone(buf) {
    if (buf.slice) {
      return buf.slice(0)
    } else {
      var view = new Uint8Array(buf.byteLength)
      view.set(new Uint8Array(buf))
      return view.buffer
    }
  }

  function Body() {
    this.bodyUsed = false

    this._initBody = function(body) {
      this._bodyInit = body
      if (!body) {
        this._bodyText = ''
      } else if (typeof body === 'string') {
        this._bodyText = body
      } else if (support.blob && Blob.prototype.isPrototypeOf(body)) {
        this._bodyBlob = body
      } else if (support.formData && FormData.prototype.isPrototypeOf(body)) {
        this._bodyFormData = body
      } else if (support.searchParams && URLSearchParams.prototype.isPrototypeOf(body)) {
        this._bodyText = body.toString()
      } else if (support.arrayBuffer && support.blob && isDataView(body)) {
        this._bodyArrayBuffer = bufferClone(body.buffer)
        // IE 10-11 can't handle a DataView body.
        this._bodyInit = new Blob([this._bodyArrayBuffer])
      } else if (support.arrayBuffer && (ArrayBuffer.prototype.isPrototypeOf(body) || isArrayBufferView(body))) {
        this._bodyArrayBuffer = bufferClone(body)
      } else {
        throw new Error('unsupported BodyInit type')
      }

      if (!this.headers.get('content-type')) {
        if (typeof body === 'string') {
          this.headers.set('content-type', 'text/plain;charset=UTF-8')
        } else if (this._bodyBlob && this._bodyBlob.type) {
          this.headers.set('content-type', this._bodyBlob.type)
        } else if (support.searchParams && URLSearchParams.prototype.isPrototypeOf(body)) {
          this.headers.set('content-type', 'application/x-www-form-urlencoded;charset=UTF-8')
        }
      }
    }

    if (support.blob) {
      this.blob = function() {
        var rejected = consumed(this)
        if (rejected) {
          return rejected
        }

        if (this._bodyBlob) {
          return Promise.resolve(this._bodyBlob)
        } else if (this._bodyArrayBuffer) {
          return Promise.resolve(new Blob([this._bodyArrayBuffer]))
        } else if (this._bodyFormData) {
          throw new Error('could not read FormData body as blob')
        } else {
          return Promise.resolve(new Blob([this._bodyText]))
        }
      }

      this.arrayBuffer = function() {
        if (this._bodyArrayBuffer) {
          return consumed(this) || Promise.resolve(this._bodyArrayBuffer)
        } else {
          return this.blob().then(readBlobAsArrayBuffer)
        }
      }
    }

    this.text = function() {
      var rejected = consumed(this)
      if (rejected) {
        return rejected
      }

      if (this._bodyBlob) {
        return readBlobAsText(this._bodyBlob)
      } else if (this._bodyArrayBuffer) {
        return Promise.resolve(readArrayBufferAsText(this._bodyArrayBuffer))
      } else if (this._bodyFormData) {
        throw new Error('could not read FormData body as text')
      } else {
        return Promise.resolve(this._bodyText)
      }
    }

    if (support.formData) {
      this.formData = function() {
        return this.text().then(decode)
      }
    }

    this.json = function() {
      return this.text().then(JSON.parse)
    }

    return this
  }

  // HTTP methods whose capitalization should be normalized
  var methods = ['DELETE', 'GET', 'HEAD', 'OPTIONS', 'POST', 'PUT']

  function normalizeMethod(method) {
    var upcased = method.toUpperCase()
    return (methods.indexOf(upcased) > -1) ? upcased : method
  }

  function Request(input, options) {
    options = options || {}
    var body = options.body

    if (input instanceof Request) {
      if (input.bodyUsed) {
        throw new TypeError('Already read')
      }
      this.url = input.url
      this.credentials = input.credentials
      if (!options.headers) {
        this.headers = new Headers(input.headers)
      }
      this.method = input.method
      this.mode = input.mode
      if (!body && input._bodyInit != null) {
        body = input._bodyInit
        input.bodyUsed = true
      }
    } else {
      this.url = String(input)
    }

    this.credentials = options.credentials || this.credentials || 'omit'
    if (options.headers || !this.headers) {
      this.headers = new Headers(options.headers)
    }
    this.method = normalizeMethod(options.method || this.method || 'GET')
    this.mode = options.mode || this.mode || null
    this.referrer = null

    if ((this.method === 'GET' || this.method === 'HEAD') && body) {
      throw new TypeError('Body not allowed for GET or HEAD requests')
    }
    this._initBody(body)
  }

  Request.prototype.clone = function() {
    return new Request(this, { body: this._bodyInit })
  }

  function decode(body) {
    var form = new FormData()
    body.trim().split('&').forEach(function(bytes) {
      if (bytes) {
        var split = bytes.split('=')
        var name = split.shift().replace(/\+/g, ' ')
        var value = split.join('=').replace(/\+/g, ' ')
        form.append(decodeURIComponent(name), decodeURIComponent(value))
      }
    })
    return form
  }

  function parseHeaders(rawHeaders) {
    var headers = new Headers()
    rawHeaders.split(/\r?\n/).forEach(function(line) {
      var parts = line.split(':')
      var key = parts.shift().trim()
      if (key) {
        var value = parts.join(':').trim()
        headers.append(key, value)
      }
    })
    return headers
  }

  Body.call(Request.prototype)

  function Response(bodyInit, options) {
    if (!options) {
      options = {}
    }

    this.type = 'default'
    this.status = 'status' in options ? options.status : 200
    this.ok = this.status >= 200 && this.status < 300
    this.statusText = 'statusText' in options ? options.statusText : 'OK'
    this.headers = new Headers(options.headers)
    this.url = options.url || ''
    this._initBody(bodyInit)
  }

  Body.call(Response.prototype)

  Response.prototype.clone = function() {
    return new Response(this._bodyInit, {
      status: this.status,
      statusText: this.statusText,
      headers: new Headers(this.headers),
      url: this.url
    })
  }

  Response.error = function() {
    var response = new Response(null, {status: 0, statusText: ''})
    response.type = 'error'
    return response
  }

  var redirectStatuses = [301, 302, 303, 307, 308]

  Response.redirect = function(url, status) {
    if (redirectStatuses.indexOf(status) === -1) {
      throw new RangeError('Invalid status code')
    }

    return new Response(null, {status: status, headers: {location: url}})
  }

  self.Headers = Headers
  self.Request = Request
  self.Response = Response

  self.fetch = function(input, init) {
    return new Promise(function(resolve, reject) {
      var request = new Request(input, init)
      var xhr = new XMLHttpRequest()

      xhr.onload = function() {
        var options = {
          status: xhr.status,
          statusText: xhr.statusText,
          headers: parseHeaders(xhr.getAllResponseHeaders() || '')
        }
        options.url = 'responseURL' in xhr ? xhr.responseURL : options.headers.get('X-Request-URL')
        var body = 'response' in xhr ? xhr.response : xhr.responseText
        resolve(new Response(body, options))
      }

      xhr.onerror = function() {
        reject(new TypeError('Network request failed'))
      }

      xhr.ontimeout = function() {
        reject(new TypeError('Network request failed'))
      }

      xhr.open(request.method, request.url, true)

      if (request.credentials === 'include') {
        xhr.withCredentials = true
      }

      if ('responseType' in xhr && support.blob) {
        xhr.responseType = 'blob'
      }

      request.headers.forEach(function(value, name) {
        xhr.setRequestHeader(name, value)
      })

      xhr.send(typeof request._bodyInit === 'undefined' ? null : request._bodyInit)
    })
  }
  self.fetch.polyfill = true
})(typeof self !== 'undefined' ? self : this);

},{}],8:[function(require,module,exports){
'use strict';var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var utils=require('./utils'),defaults=require('./defaults'),itemToCSLJSON=require('../zotero-shim/item-to-csl-json'),dateToSql=require('../zotero-shim/date-to-sql'),ZoteroBib=function(){function a(b){if(_classCallCheck(this,a),this.opts=Object.assign({sessionid:utils.uuid4()},defaults(),b),this.opts.persist&&this.opts.storage){if(!('getItem'in this.opts.storage||'setItem'in this.opts.storage||'clear'in this.opts.storage))throw new Error('Invalid storage engine provided');this.opts.override&&this.clearItems(),this.items=[].concat(_toConsumableArray(this.opts.initialItems),_toConsumableArray(this.getItemsStorage())),this.setItemsStorage(this.items)}else this.items=[].concat(_toConsumableArray(this.opts.initialItems))}return _createClass(a,[{key:'getItemsStorage',value:function getItemsStorage(){var a=this.opts.storage.getItem(this.opts.storagePrefix+'-items');return a?JSON.parse(a):[]}},{key:'setItemsStorage',value:function setItemsStorage(a){this.opts.storage.setItem(this.opts.storagePrefix+'-items',JSON.stringify(a))}},{key:'addItem',value:function addItem(a){this.items.push(a),this.opts.persist&&this.setItemsStorage(this.items)}},{key:'updateItem',value:function updateItem(a,b){this.items[a]=b,this.opts.persist&&this.setItemsStorage(this.items)}},{key:'removeItem',value:function removeItem(a){var b=this.items.indexOf(a);return-1!==b&&(this.items.splice(b,1),this.opts.persist&&this.setItemsStorage(this.items),!0)}},{key:'clearItems',value:function clearItems(){this.items=[],this.opts.persist&&this.setItemsStorage(this.items)}},{key:'translateUrl',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d,e,f,g,h,i=this,j=1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=this.opts.translationServerUrl+'/'+this.opts.translationServerPrefix+'web',d=this.opts.sessionid,e=Object.assign({url:b,sessionid:d},this.opts.request),f=Object.assign({method:'POST',headers:{"Content-Type":'application/json'},body:JSON.stringify(e)},this.opts.init),a.next=6,fetch(c,f);case 6:return g=a.sent,a.next=9,g.json();case 9:return h=a.sent,Array.isArray(h)&&h.forEach(function(a){if('CURRENT_TIMESTAMP'===a.accessDate){var b=new Date(Date.now());a.accessDate=dateToSql(b,!0)}j&&i.addItem(a)}),a.abrupt('return',Array.isArray(h)&&h||!1);case 12:case'end':return a.stop();}},a,this)}));return function translateUrl(){return a.apply(this,arguments)}}()},{key:'itemsCSL',get:function get(){return this.items.map(function(a){return itemToCSLJSON(a)})}},{key:'itemsRaw',get:function get(){return this.items}}]),a}();module.exports=ZoteroBib;

},{"../zotero-shim/date-to-sql":14,"../zotero-shim/item-to-csl-json":17,"./defaults":9,"./utils":10}],9:[function(require,module,exports){
'use strict';module.exports=function(){return{translationServerUrl:'undefined'!=typeof window&&window.location.origin||'',translationServerPrefix:'',fetchConfig:{},initialItems:[],request:{},storage:'undefined'!=typeof window&&'localStorage'in window&&window.localStorage||{},persist:!0,override:!1,storagePrefix:'zotero-bib'}};

},{}],10:[function(require,module,exports){
'use strict';module.exports={uuid4:function uuid4(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(a){var b=0|16*Math.random(),c='x'==a?b:8|3&b;return c.toString(16)})}};

},{}],11:[function(require,module,exports){
'use strict';require('es6-promise/auto'),require('isomorphic-fetch'),require('babel-regenerator-runtime');var ZoteroBib=require('./bib/bib');module.exports=ZoteroBib;

},{"./bib/bib":8,"babel-regenerator-runtime":1,"es6-promise/auto":3,"isomorphic-fetch":5}],12:[function(require,module,exports){
'use strict';var creatorTypes={1:'author',2:'contributor',3:'editor',4:'translator',5:'seriesEditor',6:'interviewee',7:'interviewer',8:'director',9:'scriptwriter',10:'producer',11:'castMember',12:'sponsor',13:'counsel',14:'inventor',15:'attorneyAgent',16:'recipient',17:'performer',18:'composer',19:'wordsBy',20:'cartographer',21:'programmer',22:'artist',23:'commenter',24:'presenter',25:'guest',26:'podcaster',27:'reviewedAuthor',28:'cosponsor',29:'bookAuthor'};Object.keys(creatorTypes).map(function(a){return creatorTypes[creatorTypes[a]]=a}),module.exports=creatorTypes;

},{}],13:[function(require,module,exports){
'use strict';module.exports={CSL_NAMES_MAPPINGS:{author:'author',editor:'editor',bookAuthor:'container-author',composer:'composer',director:'director',interviewer:'interviewer',recipient:'recipient',reviewedAuthor:'reviewed-author',seriesEditor:'collection-editor',translator:'translator'},CSL_TEXT_MAPPINGS:{title:['title'],"container-title":['publicationTitle','reporter','code'],"collection-title":['seriesTitle','series'],"collection-number":['seriesNumber'],publisher:['publisher','distributor'],"publisher-place":['place'],authority:['court','legislativeBody','issuingAuthority'],page:['pages'],volume:['volume','codeNumber'],issue:['issue','priorityNumbers'],"number-of-volumes":['numberOfVolumes'],"number-of-pages":['numPages'],edition:['edition'],version:['versionNumber'],section:['section','committee'],genre:['type','programmingLanguage'],source:['libraryCatalog'],dimensions:['artworkSize','runningTime'],medium:['medium','system'],scale:['scale'],archive:['archive'],archive_location:['archiveLocation'],event:['meetingName','conferenceName'],"event-place":['place'],abstract:['abstractNote'],URL:['url'],DOI:['DOI'],ISBN:['ISBN'],ISSN:['ISSN'],"call-number":['callNumber','applicationNumber'],note:['extra'],number:['number'],"chapter-number":['session'],references:['history','references'],shortTitle:['shortTitle'],journalAbbreviation:['journalAbbreviation'],status:['legalStatus'],language:['language']},CSL_DATE_MAPPINGS:{issued:'date',accessed:'accessDate',submitted:'filingDate'},CSL_TYPE_MAPPINGS:{book:'book',bookSection:'chapter',journalArticle:'article-journal',magazineArticle:'article-magazine',newspaperArticle:'article-newspaper',thesis:'thesis',encyclopediaArticle:'entry-encyclopedia',dictionaryEntry:'entry-dictionary',conferencePaper:'paper-conference',letter:'personal_communication',manuscript:'manuscript',interview:'interview',film:'motion_picture',artwork:'graphic',webpage:'webpage',report:'report',bill:'bill',case:'legal_case',hearing:'bill',patent:'patent',statute:'legislation',email:'personal_communication',map:'map',blogPost:'post-weblog',instantMessage:'personal_communication',forumPost:'post',audioRecording:'song',presentation:'speech',videoRecording:'motion_picture',tvBroadcast:'broadcast',radioBroadcast:'broadcast',podcast:'song',computerProgram:'book',document:'article',note:'article',attachment:'article'}};

},{}],14:[function(require,module,exports){
'use strict';var lpad=require('./lpad');module.exports=function(a,b){var c,d,e,f,g,h;try{return b?(c=a.getUTCFullYear(),d=a.getUTCMonth(),e=a.getUTCDate(),f=a.getUTCHours(),g=a.getUTCMinutes(),h=a.getUTCSeconds()):(c=a.getFullYear(),d=a.getMonth(),e=a.getDate(),f=a.getHours(),g=a.getMinutes(),h=a.getSeconds()),c=lpad(c,'0',4),d=lpad(d+1,'0',2),e=lpad(e,'0',2),f=lpad(f,'0',2),g=lpad(g,'0',2),h=lpad(h,'0',2),c+'-'+d+'-'+e+' '+f+':'+g+':'+h}catch(a){return''}};

},{"./lpad":19}],15:[function(require,module,exports){
'use strict';var _module$exports;function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var itemTypes=require('./item-types'),creatorTypes=require('./creator-types');module.exports=(_module$exports={},_defineProperty(_module$exports,itemTypes[2],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[3],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[4],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[5],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[6],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[7],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[8],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[9],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[10],creatorTypes[6]),_defineProperty(_module$exports,itemTypes[11],creatorTypes[8]),_defineProperty(_module$exports,itemTypes[12],creatorTypes[22]),_defineProperty(_module$exports,itemTypes[13],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[15],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[16],creatorTypes[12]),_defineProperty(_module$exports,itemTypes[17],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[18],creatorTypes[2]),_defineProperty(_module$exports,itemTypes[19],creatorTypes[14]),_defineProperty(_module$exports,itemTypes[20],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[21],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[22],creatorTypes[20]),_defineProperty(_module$exports,itemTypes[23],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[24],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[25],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[26],creatorTypes[17]),_defineProperty(_module$exports,itemTypes[27],creatorTypes[24]),_defineProperty(_module$exports,itemTypes[28],creatorTypes[8]),_defineProperty(_module$exports,itemTypes[29],creatorTypes[8]),_defineProperty(_module$exports,itemTypes[30],creatorTypes[8]),_defineProperty(_module$exports,itemTypes[31],creatorTypes[26]),_defineProperty(_module$exports,itemTypes[32],creatorTypes[21]),_defineProperty(_module$exports,itemTypes[33],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[34],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[35],creatorTypes[1]),_defineProperty(_module$exports,itemTypes[36],creatorTypes[1]),_module$exports);

},{"./creator-types":12,"./item-types":18}],16:[function(require,module,exports){
'use strict';var fields={1:'url',2:'rights',3:'series',4:'volume',5:'issue',6:'edition',7:'place',8:'publisher',10:'pages',11:'ISBN',12:'publicationTitle',13:'ISSN',14:'date',15:'section',18:'callNumber',19:'archiveLocation',21:'distributor',22:'extra',25:'journalAbbreviation',26:'DOI',27:'accessDate',28:'seriesTitle',29:'seriesText',30:'seriesNumber',31:'institution',32:'reportType',36:'code',40:'session',41:'legislativeBody',42:'history',43:'reporter',44:'court',45:'numberOfVolumes',46:'committee',48:'assignee',50:'patentNumber',51:'priorityNumbers',52:'issueDate',53:'references',54:'legalStatus',55:'codeNumber',59:'artworkMedium',60:'number',61:'artworkSize',62:'libraryCatalog',63:'videoRecordingFormat',64:'interviewMedium',65:'letterType',66:'manuscriptType',67:'mapType',68:'scale',69:'thesisType',70:'websiteType',71:'audioRecordingFormat',72:'label',74:'presentationType',75:'meetingName',76:'studio',77:'runningTime',78:'network',79:'postType',80:'audioFileType',81:'versionNumber',82:'system',83:'company',84:'conferenceName',85:'encyclopediaTitle',86:'dictionaryTitle',87:'language',88:'programmingLanguage',89:'university',90:'abstractNote',91:'websiteTitle',92:'reportNumber',93:'billNumber',94:'codeVolume',95:'codePages',96:'dateDecided',97:'reporterVolume',98:'firstPage',99:'documentNumber',100:'dateEnacted',101:'publicLawNumber',102:'country',103:'applicationNumber',104:'forumTitle',105:'episodeNumber',107:'blogTitle',108:'type',109:'medium',110:'title',111:'caseName',112:'nameOfAct',113:'subject',114:'proceedingsTitle',115:'bookTitle',116:'shortTitle',117:'docketNumber',118:'numPages',119:'programTitle',120:'issuingAuthority',121:'filingDate',122:'genre',123:'archive'};Object.keys(fields).map(function(a){return fields[fields[a]]=a}),module.exports=fields;

},{}],17:[function(require,module,exports){
'use strict';var _require=require('./csl-mappings'),CSL_NAMES_MAPPINGS=_require.CSL_NAMES_MAPPINGS,CSL_TEXT_MAPPINGS=_require.CSL_TEXT_MAPPINGS,CSL_DATE_MAPPINGS=_require.CSL_DATE_MAPPINGS,CSL_TYPE_MAPPINGS=_require.CSL_TYPE_MAPPINGS,CSL=require('citeproc'),_require2=require('./type-specific-field-map'),getFieldIDFromTypeAndBase=_require2.getFieldIDFromTypeAndBase,fields=require('./fields'),itemTypes=require('./item-types'),strToDate=require('./str-to-date'),defaultItemTypeCreatorTypeLookup=require('./default-item-type-creator-type-lookup');module.exports=function(a){var b=CSL_TYPE_MAPPINGS[a.itemType];if(!b)throw new Error('Unexpected Zotero Item type "'+a.itemType+'"');var c=itemTypes[a.itemType],d={id:a.itemKey,type:b};for(var f in CSL_TEXT_MAPPINGS)for(var g=CSL_TEXT_MAPPINGS[f],h=0,i=g.length;h<i;h++){var j=g[h],k=null;if(j in a&&(k=a[j]),k&&'string'==typeof k){if('ISBN'==j){var e=k.match(/^(?:97[89]-?)?(?:\d-?){9}[\dx](?!-)\b/i);e&&(k=e[0])}'"'==k.charAt(0)&&k.indexOf('"',1)==k.length-1&&(k=k.substring(1,k.length-1)),d[f]=k;break}}if('attachment'!=a.type&&'note'!=a.type)for(var l=defaultItemTypeCreatorTypeLookup[c],m=a.creators,n=0;m&&n<m.length;n++){var o=m[n],p=o.creatorType,q=void 0;(p==l&&(p='author'),p=CSL_NAMES_MAPPINGS[p],!!p)&&('lastName'in o||'firstName'in o?(q={family:o.lastName||'',given:o.firstName||''},q.family&&q.given&&(1<q.family.length&&'"'==q.family.charAt(0)&&'"'==q.family.charAt(q.family.length-1)?q.family=q.family.substr(1,q.family.length-2):CSL.parseParticles(q,!0))):'name'in o&&(q={literal:o.name}),d[p]?d[p].push(q):d[p]=[q])}for(var r in CSL_DATE_MAPPINGS){var s=a[CSL_DATE_MAPPINGS[r]];if(!s){var t=getFieldIDFromTypeAndBase(c,CSL_DATE_MAPPINGS[r]);t&&(s=a[fields[t]])}if(s){var u=strToDate(s),v=[];u.year?(v.push(u.year),void 0!==u.month&&(v.push(u.month+1),u.day&&v.push(u.day)),d[r]={"date-parts":[v]},u.part&&void 0===u.month&&(d[r].season=u.part)):d[r]={literal:s}}}return d};

},{"./csl-mappings":13,"./default-item-type-creator-type-lookup":15,"./fields":16,"./item-types":18,"./str-to-date":20,"./type-specific-field-map":21,"citeproc":2}],18:[function(require,module,exports){
'use strict';var itemTypes={1:'note',2:'book',3:'bookSection',4:'journalArticle',5:'magazineArticle',6:'newspaperArticle',7:'thesis',8:'letter',9:'manuscript',10:'interview',11:'film',12:'artwork',13:'webpage',14:'attachment',15:'report',16:'bill',17:'case',18:'hearing',19:'patent',20:'statute',21:'email',22:'map',23:'blogPost',24:'instantMessage',25:'forumPost',26:'audioRecording',27:'presentation',28:'videoRecording',29:'tvBroadcast',30:'radioBroadcast',31:'podcast',32:'computerProgram',33:'conferencePaper',34:'document',35:'encyclopediaArticle',36:'dictionaryEntry'};Object.keys(itemTypes).map(function(a){return itemTypes[itemTypes[a]]=a}),module.exports=itemTypes;

},{}],19:[function(require,module,exports){
'use strict';module.exports=function(a,b,c){for(a=a?a+'':'';a.length<c;)a=b+a;return a};

},{}],20:[function(require,module,exports){
'use strict';var dateToSQL=require('./date-to-sql'),months=['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec','january','february','march','april','may','june','july','august','september','october','november','december'],_slashRe=/^(.*?)\b([0-9]{1,4})(?:([\-\/\.\u5e74])([0-9]{1,2}))?(?:([\-\/\.\u6708])([0-9]{1,4}))?((?:\b|[^0-9]).*?)$/,_yearRe=/^(.*?)\b((?:circa |around |about |c\.? ?)?[0-9]{1,4}(?: ?B\.? ?C\.?(?: ?E\.?)?| ?C\.? ?E\.?| ?A\.? ?D\.?)|[0-9]{3,4})\b(.*?)$/i,_monthRe=new RegExp('^(.*)\\b('+months.join('|')+')[^ ]*(?: (.*)$|$)','i'),_dayRe=/\b([0-9]{1,2})(?:st|nd|rd|th)?\b(.*)/i,_insertDateOrderPart=function(a,b,c){if(!a)return b;if(!0===c.before)return b+a;if(!0===c.after)return a+b;if(c.before){var d=a.indexOf(c.before);return-1==d?a:a.replace(new RegExp('('+c.before+')'),b+'$1')}if(c.after){var e=a.indexOf(c.after);return-1==e?a+b:a.replace(new RegExp('('+c.after+')'),'$1'+b)}return a+b};module.exports=function(a){var b={order:''};if(!a)return b;var c=[],d=(a+'').toLowerCase();a='yesterday'==d?dateToSQL(new Date(Date.now()-86400000)).substr(0,10):'today'==d?dateToSQL(new Date).substr(0,10):'tomorrow'==d?dateToSQL(new Date(Date.now()+86400000)).substr(0,10):a.toString().replace(/^\s+|\s+$/g,'').replace(/\s+/,' ');var e=_slashRe.exec(a);if(e&&(!e[5]||!e[3]||e[3]==e[5]||'\u5E74'==e[3]&&'\u6708'==e[5])&&(e[2]&&e[4]&&e[6]||!e[1]&&!e[7])){if(3==e[2].length||4==e[2].length||'\u5E74'==e[3])b.year=e[2],b.month=e[4],b.day=e[6],b.order+=e[2]?'y':'',b.order+=e[4]?'m':'',b.order+=e[6]?'d':'';else if(e[2]&&!e[4]&&e[6])b.month=e[2],b.year=e[6],b.order+=e[2]?'m':'',b.order+=e[6]?'y':'';else{var f=window.navigator.language?window.navigator.language.substr(3):'US';'US'==f||'FM'==f||'PW'==f||'PH'==f?(b.month=e[2],b.day=e[4],b.order+=e[2]?'m':'',b.order+=e[4]?'d':''):(b.month=e[4],b.day=e[2],b.order+=e[2]?'d':'',b.order+=e[4]?'m':''),b.year=e[6],b.order+='y'}if(b.year&&(b.year=parseInt(b.year,10)),b.day&&(b.day=parseInt(b.day,10)),b.month&&(b.month=parseInt(b.month,10),12<b.month)){var g=b.day;b.day=b.month,b.month=g,b.order=b.order.replace('m','D').replace('d','M').replace('D','d').replace('M','m')}if((!b.month||12>=b.month)&&(!b.day||31>=b.day)){if(b.year&&100>b.year){var h=new Date,j=h.getFullYear(),k=j%100,l=j-k;b.year=b.year<=k?l+b.year:l-100+b.year}b.month?b.month--:delete b.month,c.push({part:e[1],before:!0},{part:e[7]})}else{var b={order:''};c.push({part:a})}}else c.push({part:a});if(!b.year)for(var i in c){var p=_yearRe.exec(c[i].part);if(p){b.year=p[2],b.order=_insertDateOrderPart(b.order,'y',c[i]),c.splice(i,1,{part:p[1],before:!0},{part:p[3]});break}}if(void 0===b.month)for(var q in c){var r=_monthRe.exec(c[q].part);if(r){b.month=months.indexOf(r[2].toLowerCase())%12,b.order=_insertDateOrderPart(b.order,'m',c[q]),c.splice(q,1,{part:r[1],before:'m'},{part:r[3],after:'m'});break}}if(!b.day)for(var s in c){var t=_dayRe.exec(c[s].part);if(t){var m,n=parseInt(t[1],10);if(31>=n){b.day=n,b.order=_insertDateOrderPart(b.order,'d',c[s]),0<t.index?(m=c[s].part.substr(0,t.index),t[2]&&(m+=' '+t[2])):m=t[2],c.splice(s,1,{part:m});break}}}for(var o in b.part='',c)b.part+=c[o].part+' ';return b.part&&(b.part=b.part.replace(/^[^A-Za-z0-9]+|[^A-Za-z0-9]+$/g,'')),(''===b.part||void 0==b.part)&&delete b.part,(b.year||0===b.year)&&(b.year+=''),b};

},{"./date-to-sql":14}],21:[function(require,module,exports){
'use strict';var _typeSpecificFieldMap;function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var fields=require('./fields'),itemTypes=require('./item-types'),typeSpecificFieldMap=(_typeSpecificFieldMap={},_defineProperty(_typeSpecificFieldMap,4100,94),_defineProperty(_typeSpecificFieldMap,4356,97),_defineProperty(_typeSpecificFieldMap,1800,89),_defineProperty(_typeSpecificFieldMap,2824,21),_defineProperty(_typeSpecificFieldMap,3848,31),_defineProperty(_typeSpecificFieldMap,6664,72),_defineProperty(_typeSpecificFieldMap,7176,76),_defineProperty(_typeSpecificFieldMap,7432,78),_defineProperty(_typeSpecificFieldMap,7688,78),_defineProperty(_typeSpecificFieldMap,8200,83),_defineProperty(_typeSpecificFieldMap,4106,95),_defineProperty(_typeSpecificFieldMap,4362,98),_defineProperty(_typeSpecificFieldMap,780,115),_defineProperty(_typeSpecificFieldMap,8460,114),_defineProperty(_typeSpecificFieldMap,3340,91),_defineProperty(_typeSpecificFieldMap,5900,107),_defineProperty(_typeSpecificFieldMap,6412,104),_defineProperty(_typeSpecificFieldMap,7436,119),_defineProperty(_typeSpecificFieldMap,7692,119),_defineProperty(_typeSpecificFieldMap,8972,85),_defineProperty(_typeSpecificFieldMap,9228,86),_defineProperty(_typeSpecificFieldMap,4366,96),_defineProperty(_typeSpecificFieldMap,4878,52),_defineProperty(_typeSpecificFieldMap,5134,100),_defineProperty(_typeSpecificFieldMap,3900,92),_defineProperty(_typeSpecificFieldMap,4156,93),_defineProperty(_typeSpecificFieldMap,4412,117),_defineProperty(_typeSpecificFieldMap,4668,99),_defineProperty(_typeSpecificFieldMap,4924,50),_defineProperty(_typeSpecificFieldMap,5180,101),_defineProperty(_typeSpecificFieldMap,7484,105),_defineProperty(_typeSpecificFieldMap,7740,105),_defineProperty(_typeSpecificFieldMap,7996,105),_defineProperty(_typeSpecificFieldMap,1900,69),_defineProperty(_typeSpecificFieldMap,2156,65),_defineProperty(_typeSpecificFieldMap,2412,66),_defineProperty(_typeSpecificFieldMap,2924,122),_defineProperty(_typeSpecificFieldMap,3436,70),_defineProperty(_typeSpecificFieldMap,3948,32),_defineProperty(_typeSpecificFieldMap,5740,67),_defineProperty(_typeSpecificFieldMap,5996,70),_defineProperty(_typeSpecificFieldMap,6508,79),_defineProperty(_typeSpecificFieldMap,7020,74),_defineProperty(_typeSpecificFieldMap,2669,64),_defineProperty(_typeSpecificFieldMap,2925,63),_defineProperty(_typeSpecificFieldMap,3181,59),_defineProperty(_typeSpecificFieldMap,6765,71),_defineProperty(_typeSpecificFieldMap,7277,63),_defineProperty(_typeSpecificFieldMap,7533,63),_defineProperty(_typeSpecificFieldMap,7789,71),_defineProperty(_typeSpecificFieldMap,8045,80),_defineProperty(_typeSpecificFieldMap,4462,111),_defineProperty(_typeSpecificFieldMap,5230,112),_defineProperty(_typeSpecificFieldMap,5486,113),_typeSpecificFieldMap);module.exports={map:typeSpecificFieldMap,getFieldIDFromTypeAndBase:function getFieldIDFromTypeAndBase(a,b){return a='number'==typeof a?a:itemTypes[a],b='number'==typeof b?b:fields[b],typeSpecificFieldMap[(a<<8)+b]}};

},{"./fields":16,"./item-types":18}]},{},[11])(11)
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJub2RlX21vZHVsZXMvYmFiZWwtcmVnZW5lcmF0b3ItcnVudGltZS9ydW50aW1lLmpzIiwibm9kZV9tb2R1bGVzL2NpdGVwcm9jL2NpdGVwcm9jX2NvbW1vbmpzLmpzIiwibm9kZV9tb2R1bGVzL2VzNi1wcm9taXNlL2F1dG8uanMiLCJub2RlX21vZHVsZXMvZXM2LXByb21pc2UvZGlzdC9lczYtcHJvbWlzZS5qcyIsIm5vZGVfbW9kdWxlcy9pc29tb3JwaGljLWZldGNoL2ZldGNoLW5wbS1icm93c2VyaWZ5LmpzIiwibm9kZV9tb2R1bGVzL3Byb2Nlc3MvYnJvd3Nlci5qcyIsIm5vZGVfbW9kdWxlcy93aGF0d2ctZmV0Y2gvZmV0Y2guanMiLCJzcmMvanMvYmliL2JpYi5qcyIsInNyYy9qcy9iaWIvZGVmYXVsdHMuanMiLCJzcmMvanMvYmliL3V0aWxzLmpzIiwic3JjL2pzL21haW4tY29tcGF0LmpzIiwic3JjL2pzL3pvdGVyby1zaGltL2NyZWF0b3ItdHlwZXMuanMiLCJzcmMvanMvem90ZXJvLXNoaW0vY3NsLW1hcHBpbmdzLmpzIiwic3JjL2pzL3pvdGVyby1zaGltL2RhdGUtdG8tc3FsLmpzIiwic3JjL2pzL3pvdGVyby1zaGltL2RlZmF1bHQtaXRlbS10eXBlLWNyZWF0b3ItdHlwZS1sb29rdXAuanMiLCJzcmMvanMvem90ZXJvLXNoaW0vZmllbGRzLmpzIiwic3JjL2pzL3pvdGVyby1zaGltL2l0ZW0tdG8tY3NsLWpzb24uanMiLCJzcmMvanMvem90ZXJvLXNoaW0vaXRlbS10eXBlcy5qcyIsInNyYy9qcy96b3Rlcm8tc2hpbS9scGFkLmpzIiwic3JjL2pzL3pvdGVyby1zaGltL3N0ci10by1kYXRlLmpzIiwic3JjL2pzL3pvdGVyby1zaGltL3R5cGUtc3BlY2lmaWMtZmllbGQtbWFwLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztBQ0FBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7O0FDanBCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQy9oaEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQ0pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7OztBQ3JvQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDTkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN4TEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzdjQSxhLGt5QkFFQSxHQUFNLE9BQVEsUUFBUSxTQUFSLENBQWQsQ0FDTSxTQUFXLFFBQVEsWUFBUixDQURqQixDQUVNLGNBQWdCLFFBQVEsaUNBQVIsQ0FGdEIsQ0FHTSxVQUFZLFFBQVEsNEJBQVIsQ0FIbEIsQ0FLTSxTQUxOLFlBTUMsYUFBa0IsQ0FLakIsMkJBSkEsS0FBSyxJQUFMLENBQVksT0FBTyxNQUFQLENBQWMsQ0FDekIsVUFBVyxNQUFNLEtBQU4sRUFEYyxDQUFkLENBRVQsVUFGUyxHQUlaLENBQUcsS0FBSyxJQUFMLENBQVUsT0FBVixFQUFxQixLQUFLLElBQUwsQ0FBVSxPQUFsQyxDQUEyQyxDQUMxQyxHQUFHLEVBQUUsV0FBYSxNQUFLLElBQUwsQ0FBVSxPQUF2QixFQUNKLFdBQWEsTUFBSyxJQUFMLENBQVUsT0FEbkIsRUFFSixTQUFXLE1BQUssSUFBTCxDQUFVLE9BRm5CLENBQUgsQ0FJQyxLQUFNLElBQUksTUFBSixDQUFVLGlDQUFWLENBQU4sQ0FFRSxLQUFLLElBQUwsQ0FBVSxRQVA2QixFQVF6QyxLQUFLLFVBQUwsRUFSeUMsQ0FVMUMsS0FBSyxLQUFMLDhCQUFpQixLQUFLLElBQUwsQ0FBVSxZQUEzQixxQkFBNEMsS0FBSyxlQUFMLEVBQTVDLEVBVjBDLENBVzFDLEtBQUssZUFBTCxDQUFxQixLQUFLLEtBQTFCLENBQ0EsQ0FaRCxJQWFDLE1BQUssS0FBTCw4QkFBaUIsS0FBSyxJQUFMLENBQVUsWUFBM0IsRUFFRCxDQTFCRiw4RUE0Qm1CLENBQ2pCLEdBQUksR0FBUSxLQUFLLElBQUwsQ0FBVSxPQUFWLENBQWtCLE9BQWxCLENBQTZCLEtBQUssSUFBTCxDQUFVLGFBQXZDLFVBQVosQ0FDQSxNQUFPLEdBQVEsS0FBSyxLQUFMLEdBQVIsR0FDUCxDQS9CRiwwREFpQ3dCLENBQ3RCLEtBQUssSUFBTCxDQUFVLE9BQVYsQ0FBa0IsT0FBbEIsQ0FDSSxLQUFLLElBQUwsQ0FBVSxhQURkLFVBRUMsS0FBSyxTQUFMLEdBRkQsQ0FJQSxDQXRDRiwwQ0F3Q2UsQ0FDYixLQUFLLEtBQUwsQ0FBVyxJQUFYLEdBRGEsQ0FFVixLQUFLLElBQUwsQ0FBVSxPQUZBLEVBR1osS0FBSyxlQUFMLENBQXFCLEtBQUssS0FBMUIsQ0FFRCxDQTdDRixrREErQ3lCLENBQ3ZCLEtBQUssS0FBTCxLQUR1QixDQUVwQixLQUFLLElBQUwsQ0FBVSxPQUZVLEVBR3RCLEtBQUssZUFBTCxDQUFxQixLQUFLLEtBQTFCLENBRUQsQ0FwREYsZ0RBc0RrQixDQUNoQixHQUFJLEdBQVEsS0FBSyxLQUFMLENBQVcsT0FBWCxHQUFaLENBRGdCLE1BRUgsQ0FBQyxDQUFYLElBRmEsR0FHZixLQUFLLEtBQUwsQ0FBVyxNQUFYLEdBQXlCLENBQXpCLENBSGUsQ0FJWixLQUFLLElBQUwsQ0FBVSxPQUpFLEVBS2QsS0FBSyxlQUFMLENBQXFCLEtBQUssS0FBMUIsQ0FMYyxJQVVoQixDQWhFRiwrQ0FrRWMsQ0FDWixLQUFLLEtBQUwsR0FEWSxDQUVULEtBQUssSUFBTCxDQUFVLE9BRkQsRUFHWCxLQUFLLGVBQUwsQ0FBcUIsS0FBSyxLQUExQixDQUVELENBdkVGLGdSQWtGZ0MsS0FBSyxJQUFMLENBQVUsb0JBbEYxQyxLQWtGa0UsS0FBSyxJQUFMLENBQVUsdUJBbEY1RSxTQW1Ga0IsS0FBSyxJQUFMLENBQVUsU0FuRjVCLEdBb0ZhLE9BQU8sTUFBUCxDQUFjLENBQUUsS0FBRixDQUFPLFdBQVAsQ0FBZCxDQUFrQyxLQUFLLElBQUwsQ0FBVSxPQUE1QyxDQXBGYixHQXNGYSxPQUFPLE1BQVAsQ0FBYyxDQUN4QixPQUFRLE1BRGdCLENBRXhCLDJDQUZ3QixDQUt4QixLQUFNLEtBQUssU0FBTCxHQUxrQixDQUFkLENBTVIsS0FBSyxJQUFMLENBQVUsSUFORixDQXRGYixVQThGdUIsVUE5RnZCLGlDQStGb0IsRUFBUyxJQUFULEVBL0ZwQix3QkFnR0ssTUFBTSxPQUFOLEdBaEdMLEVBaUdHLEVBQU0sT0FBTixDQUFjLFdBQVEsQ0FDckIsR0FBdUIsbUJBQXBCLEtBQUssVUFBUixDQUE0QyxDQUMzQyxHQUFNLEdBQUssR0FBSSxLQUFKLENBQVMsS0FBSyxHQUFMLEVBQVQsQ0FBWCxDQUNBLEVBQUssVUFBTCxDQUFrQixlQUNsQixDQUpvQixHQU9wQixFQUFLLE9BQUwsR0FFRCxDQVRELENBakdILG1CQTZHUyxNQUFNLE9BQU4sVUE3R1QsdUpBeUVnQixDQUNkLE1BQU8sTUFBSyxLQUFMLENBQVcsR0FBWCxDQUFlLGtCQUFLLGlCQUFMLENBQWYsQ0FDUCxDQTNFRixvQ0E2RWdCLENBQ2QsTUFBTyxNQUFLLEtBQ1osQ0EvRUYsU0FpSEEsT0FBTyxPQUFQLENBQWlCLFM7OztBQ25IakIsYUFFQSxPQUFPLE9BQVAsQ0FBaUIsaUJBQU8sQ0FDdkIscUJBQXVDLFdBQWpCLFFBQU8sT0FBUCxFQUFnQyxPQUFPLFFBQVAsQ0FBZ0IsTUFBaEQsRUFBMEQsRUFEekQsQ0FFdkIsd0JBQXlCLEVBRkYsQ0FHdkIsY0FIdUIsQ0FJdkIsZUFKdUIsQ0FLdkIsVUFMdUIsQ0FNdkIsUUFBMEIsV0FBakIsUUFBTyxPQUFQLEVBQWdDLGdCQUFrQixPQUFsRCxFQUE0RCxPQUFPLFlBQW5FLElBTmMsQ0FPdkIsVUFQdUIsQ0FRdkIsV0FSdUIsQ0FTdkIsY0FBZSxZQVRRLENBQVAsQzs7O0FDRmpCLGFBRUEsT0FBTyxPQUFQLENBQWlCLENBQ2hCLE1BQU8sdUJBQU0sdUNBQXVDLE9BQXZDLENBQStDLE9BQS9DLENBQXdELFdBQUssQ0FDeEUsR0FBSSxHQUF1QixDQUFuQixDQUFnQixFQUFoQixNQUFLLE1BQUwsRUFBUixDQUNDLEVBQVMsR0FBTCxNQUFnQixLQURyQixDQUdBLE1BQU8sR0FBRSxRQUFGLENBQVcsRUFBWCxDQUNQLENBTFcsQ0FBTixDQURTLEM7OztBQ0ZqQixhQUVBLFFBQVEsa0JBQVIsQyxDQUNBLFFBQVEsa0JBQVIsQyxDQUNBLFFBQVEsMkJBQVIsQyxDQUNBLEdBQU0sV0FBWSxRQUFRLFdBQVIsQ0FBbEIsQ0FFQSxPQUFPLE9BQVAsQ0FBaUIsUzs7O0FDUGpCLGFBRUEsR0FBTSw4YkFBTixDQWtDQSxPQUFPLElBQVAsQ0FBWSxZQUFaLEVBQTBCLEdBQTFCLENBQThCLGtCQUFLLGNBQWEsZUFBYixHQUFMLENBQTlCLEMsQ0FDQSxPQUFPLE9BQVAsQ0FBaUIsWTs7O2FDckNqQixPQUFPLE9BQVAsQ0FBaUIsQ0FDaEIsb1FBRGdCLENBaUJoQiw0bUNBakJnQixDQXlEaEIsOEVBekRnQixDQThEaEIsNjFCQTlEZ0IsQzs7O2FDQWpCLEdBQU0sTUFBTyxRQUFRLFFBQVIsQ0FBYixDQUVBLE9BQU8sT0FBUCxDQUFpQixhQUFpQixDQUNqQyxHQUFJLEVBQUosQ0FBVSxDQUFWLENBQWlCLENBQWpCLENBQXNCLENBQXRCLENBQTZCLENBQTdCLENBQXNDLENBQXRDLENBQ0EsR0FBSSxDQXdCSCxVQXRCQyxFQUFPLEVBQUssY0FBTCxFQXNCUixDQXJCQyxFQUFRLEVBQUssV0FBTCxFQXFCVCxDQXBCQyxFQUFNLEVBQUssVUFBTCxFQW9CUCxDQW5CQyxFQUFRLEVBQUssV0FBTCxFQW1CVCxDQWxCQyxFQUFVLEVBQUssYUFBTCxFQWtCWCxDQWpCQyxFQUFVLEVBQUssYUFBTCxFQWlCWCxHQWZDLEVBQU8sRUFBSyxXQUFMLEVBZVIsQ0FkQyxFQUFRLEVBQUssUUFBTCxFQWNULENBYkMsRUFBTSxFQUFLLE9BQUwsRUFhUCxDQVpDLEVBQVEsRUFBSyxRQUFMLEVBWVQsQ0FYQyxFQUFVLEVBQUssVUFBTCxFQVdYLENBVkMsRUFBVSxFQUFLLFVBQUwsRUFVWCxFQVBBLEVBQU8sT0FBVyxHQUFYLENBQWdCLENBQWhCLENBT1AsQ0FOQSxFQUFRLEtBQUssRUFBUSxDQUFiLENBQWdCLEdBQWhCLENBQXFCLENBQXJCLENBTVIsQ0FMQSxFQUFNLE9BQVUsR0FBVixDQUFlLENBQWYsQ0FLTixDQUpBLEVBQVEsT0FBWSxHQUFaLENBQWlCLENBQWpCLENBSVIsQ0FIQSxFQUFVLE9BQWMsR0FBZCxDQUFtQixDQUFuQixDQUdWLENBRkEsRUFBVSxPQUFjLEdBQWQsQ0FBbUIsQ0FBbkIsQ0FFVixDQUFPLEVBQU8sR0FBUCxHQUFxQixHQUFyQixHQUFpQyxHQUFqQyxHQUNJLEdBREosR0FDb0IsR0FEcEIsRUFFUCxDQUNELFFBQVUsQ0FDVCxNQUFPLEVBQ1AsQ0FDRCxDOzs7dUtDbENELEdBQU0sV0FBWSxRQUFRLGNBQVIsQ0FBbEIsQ0FDTSxhQUFlLFFBQVEsaUJBQVIsQ0FEckIsQ0FHQSxPQUFPLE9BQVAscURBQ0UsVUFBVSxDQUFWLENBREYsQ0FDaUIsYUFBYSxDQUFiLENBRGpCLGtDQUVFLFVBQVUsQ0FBVixDQUZGLENBRWlCLGFBQWEsQ0FBYixDQUZqQixrQ0FHRSxVQUFVLENBQVYsQ0FIRixDQUdpQixhQUFhLENBQWIsQ0FIakIsa0NBSUUsVUFBVSxDQUFWLENBSkYsQ0FJaUIsYUFBYSxDQUFiLENBSmpCLGtDQUtFLFVBQVUsQ0FBVixDQUxGLENBS2lCLGFBQWEsQ0FBYixDQUxqQixrQ0FNRSxVQUFVLENBQVYsQ0FORixDQU1pQixhQUFhLENBQWIsQ0FOakIsa0NBT0UsVUFBVSxDQUFWLENBUEYsQ0FPaUIsYUFBYSxDQUFiLENBUGpCLGtDQVFFLFVBQVUsQ0FBVixDQVJGLENBUWlCLGFBQWEsQ0FBYixDQVJqQixrQ0FTRSxVQUFVLEVBQVYsQ0FURixDQVNrQixhQUFhLENBQWIsQ0FUbEIsa0NBVUUsVUFBVSxFQUFWLENBVkYsQ0FVa0IsYUFBYSxDQUFiLENBVmxCLGtDQVdFLFVBQVUsRUFBVixDQVhGLENBV2tCLGFBQWEsRUFBYixDQVhsQixrQ0FZRSxVQUFVLEVBQVYsQ0FaRixDQVlrQixhQUFhLENBQWIsQ0FabEIsa0NBYUUsVUFBVSxFQUFWLENBYkYsQ0Fha0IsYUFBYSxDQUFiLENBYmxCLGtDQWNFLFVBQVUsRUFBVixDQWRGLENBY2tCLGFBQWEsRUFBYixDQWRsQixrQ0FlRSxVQUFVLEVBQVYsQ0FmRixDQWVrQixhQUFhLENBQWIsQ0FmbEIsa0NBZ0JFLFVBQVUsRUFBVixDQWhCRixDQWdCa0IsYUFBYSxDQUFiLENBaEJsQixrQ0FpQkUsVUFBVSxFQUFWLENBakJGLENBaUJrQixhQUFhLEVBQWIsQ0FqQmxCLGtDQWtCRSxVQUFVLEVBQVYsQ0FsQkYsQ0FrQmtCLGFBQWEsQ0FBYixDQWxCbEIsa0NBbUJFLFVBQVUsRUFBVixDQW5CRixDQW1Ca0IsYUFBYSxDQUFiLENBbkJsQixrQ0FvQkUsVUFBVSxFQUFWLENBcEJGLENBb0JrQixhQUFhLEVBQWIsQ0FwQmxCLGtDQXFCRSxVQUFVLEVBQVYsQ0FyQkYsQ0FxQmtCLGFBQWEsQ0FBYixDQXJCbEIsa0NBc0JFLFVBQVUsRUFBVixDQXRCRixDQXNCa0IsYUFBYSxDQUFiLENBdEJsQixrQ0F1QkUsVUFBVSxFQUFWLENBdkJGLENBdUJrQixhQUFhLENBQWIsQ0F2QmxCLGtDQXdCRSxVQUFVLEVBQVYsQ0F4QkYsQ0F3QmtCLGFBQWEsRUFBYixDQXhCbEIsa0NBeUJFLFVBQVUsRUFBVixDQXpCRixDQXlCa0IsYUFBYSxFQUFiLENBekJsQixrQ0EwQkUsVUFBVSxFQUFWLENBMUJGLENBMEJrQixhQUFhLENBQWIsQ0ExQmxCLGtDQTJCRSxVQUFVLEVBQVYsQ0EzQkYsQ0EyQmtCLGFBQWEsQ0FBYixDQTNCbEIsa0NBNEJFLFVBQVUsRUFBVixDQTVCRixDQTRCa0IsYUFBYSxDQUFiLENBNUJsQixrQ0E2QkUsVUFBVSxFQUFWLENBN0JGLENBNkJrQixhQUFhLEVBQWIsQ0E3QmxCLGtDQThCRSxVQUFVLEVBQVYsQ0E5QkYsQ0E4QmtCLGFBQWEsRUFBYixDQTlCbEIsa0NBK0JFLFVBQVUsRUFBVixDQS9CRixDQStCa0IsYUFBYSxDQUFiLENBL0JsQixrQ0FnQ0UsVUFBVSxFQUFWLENBaENGLENBZ0NrQixhQUFhLENBQWIsQ0FoQ2xCLGtDQWlDRSxVQUFVLEVBQVYsQ0FqQ0YsQ0FpQ2tCLGFBQWEsQ0FBYixDQWpDbEIsa0NBa0NFLFVBQVUsRUFBVixDQWxDRixDQWtDa0IsYUFBYSxDQUFiLENBbENsQixrQjs7O0FDSEEsYUFFQSxHQUFNLHdwREFBTixDQTRHQSxPQUFPLElBQVAsQ0FBWSxNQUFaLEVBQW9CLEdBQXBCLENBQXdCLGtCQUFLLFFBQU8sU0FBUCxHQUFMLENBQXhCLEMsQ0FFQSxPQUFPLE9BQVAsQ0FBaUIsTTs7O0FDaEhqQixhLGFBT0ksUUFBUSxnQkFBUixDLENBSkgsa0IsVUFBQSxrQixDQUNBLGlCLFVBQUEsaUIsQ0FDQSxpQixVQUFBLGlCLENBQ0EsaUIsVUFBQSxpQixDQUdLLElBQU0sUUFBUSxVQUFSLEMsV0FDMEIsUUFBUSwyQkFBUixDLENBQTlCLHlCLFdBQUEseUIsQ0FDRixPQUFTLFFBQVEsVUFBUixDLENBQ1QsVUFBWSxRQUFRLGNBQVIsQyxDQUNaLFVBQVksUUFBUSxlQUFSLEMsQ0FDWixpQ0FBbUMsUUFBUSx5Q0FBUixDLENBRXpDLE9BQU8sT0FBUCxDQUFpQixXQUFjLENBQzlCLEdBQUksR0FBVSxrQkFBa0IsRUFBVyxRQUE3QixDQUFkLENBQ0EsR0FBSSxFQUFKLENBQ0MsS0FBTSxJQUFJLE1BQUosQ0FBVSxnQ0FBa0MsRUFBVyxRQUE3QyxDQUF3RCxHQUFsRSxDQUFOLENBR0QsR0FBSSxHQUFhLFVBQVUsRUFBVyxRQUFyQixDQUFqQixDQUVJLEVBQVUsQ0FFYixHQUFJLEVBQVcsT0FGRixDQUdiLE1BSGEsQ0FGZCxDQVNBLElBQUksR0FBSSxFQUFSLEdBQW9CLGtCQUFwQixDQUVDLElBQUksR0FEQSxHQUFTLG9CQUNULENBQUksRUFBRSxDQUFOLENBQVMsRUFBRSxFQUFPLE1BQXRCLENBQThCLEdBQTlCLENBQW1DLEdBQW5DLENBQXdDLENBQ3ZDLEdBQUksR0FBUSxJQUFaLENBQ0MsRUFBUSxJQURULENBbUJBLEdBaEJHLE1BZ0JILEdBZkMsRUFBUSxJQWVULEtBRW9CLFFBQWhCLFVBRkosQ0FFOEIsQ0FDN0IsR0FBYSxNQUFULEdBQUosQ0FBcUIsQ0FFcEIsR0FBSSxHQUFPLEVBQU0sS0FBTixDQUFZLHdDQUFaLENBQVgsQ0FGb0IsSUFJbkIsRUFBUSxFQUFLLENBQUwsQ0FKVyxDQU1wQixDQUdxQixHQUFuQixJQUFNLE1BQU4sQ0FBYSxDQUFiLEdBQTBCLEVBQU0sT0FBTixDQUFjLEdBQWQsQ0FBbUIsQ0FBbkIsR0FBeUIsRUFBTSxNQUFOLENBQWUsQ0FWeEMsR0FXNUIsRUFBUSxFQUFNLFNBQU4sQ0FBZ0IsQ0FBaEIsQ0FBbUIsRUFBTSxNQUFOLENBQWUsQ0FBbEMsQ0FYb0IsRUFhN0IsTUFiNkIsQ0FjN0IsS0FDQSxDQUNELENBSUYsR0FBdUIsWUFBbkIsSUFBVyxJQUFYLEVBQXNELE1BQW5CLElBQVcsSUFBbEQsQ0FJQyxJQUFJLEdBRkEsR0FBUyxtQ0FFVCxDQURBLEVBQVcsRUFBVyxRQUN0QixDQUFJLEVBQUksQ0FBWixDQUFlLEdBQVksRUFBSSxFQUFTLE1BQXhDLENBQWdELEdBQWhELENBQXFELENBQ3BELEdBQUksR0FBVSxJQUFkLENBQ0ksRUFBYyxFQUFRLFdBRDFCLENBRUksUUFGSixDQURvRCxDQUtqRCxJQUxpRCxHQU1uRCxFQUFjLFFBTnFDLEVBU3BELEVBQWMscUJBVHNDLEVBVWpELEVBVmlELElBY2hELGdCQUF5QixlQWR1QixFQWVuRCxFQUFVLENBQ1QsT0FBUSxFQUFRLFFBQVIsRUFBb0IsRUFEbkIsQ0FFVCxNQUFPLEVBQVEsU0FBUixFQUFxQixFQUZuQixDQWZ5QyxDQXVCL0MsRUFBUSxNQUFSLEVBQWtCLEVBQVEsS0F2QnFCLEdBeUJ0QixDQUF4QixHQUFRLE1BQVIsQ0FBZSxNQUFmLEVBQzRCLEdBQTVCLElBQVEsTUFBUixDQUFlLE1BQWYsQ0FBc0IsQ0FBdEIsQ0FEQSxFQUVvRCxHQUFwRCxJQUFRLE1BQVIsQ0FBZSxNQUFmLENBQXNCLEVBQVEsTUFBUixDQUFlLE1BQWYsQ0FBd0IsQ0FBOUMsQ0EzQjhDLENBNkJqRCxFQUFRLE1BQVIsQ0FBaUIsRUFBUSxNQUFSLENBQWUsTUFBZixDQUFzQixDQUF0QixDQUF5QixFQUFRLE1BQVIsQ0FBZSxNQUFmLENBQXdCLENBQWpELENBN0JnQyxDQStCakQsSUFBSSxjQUFKLE1BL0JpRCxHQWtDekMsVUFsQ3lDLEdBbUNuRCxFQUFVLENBQUMsUUFBVyxFQUFRLElBQXBCLENBbkN5QyxFQXNDakQsSUF0Q2lELENBdUNuRCxLQUFxQixJQUFyQixHQXZDbUQsQ0F5Q25ELEtBQXVCLEdBekM0QixDQTJDcEQsQ0FJRixJQUFJLEdBQUksRUFBUixHQUFvQixrQkFBcEIsQ0FBdUMsQ0FDdEMsR0FBSSxHQUFPLEVBQVcsb0JBQVgsQ0FBWCxDQUNBLEdBQUksRUFBSixDQUFXLENBRVYsR0FBSSxHQUFzQiw0QkFBc0Msb0JBQXRDLENBQTFCLENBRlUsSUFJVCxFQUFPLEVBQVcsU0FBWCxDQUpFLENBTVYsQ0FFRCxLQUFTLENBQ1IsR0FBSSxHQUFVLFlBQWQsQ0FFSSxJQUZKLENBR0csRUFBUSxJQUpILEVBTVAsRUFBVSxJQUFWLENBQWUsRUFBUSxJQUF2QixDQU5PLENBT0osV0FBUSxLQVBKLEdBUU4sRUFBVSxJQUFWLENBQWUsRUFBUSxLQUFSLENBQWMsQ0FBN0IsQ0FSTSxDQVNILEVBQVEsR0FUTCxFQVVMLEVBQVUsSUFBVixDQUFlLEVBQVEsR0FBdkIsQ0FWSyxFQWFQLEtBQW9CLENBQUMsYUFBYSxHQUFkLENBYmIsQ0FnQkosRUFBUSxJQUFSLEVBQWdCLFdBQVEsS0FoQnBCLEdBaUJOLEtBQWtCLE1BQWxCLENBQTJCLEVBQVEsSUFqQjdCLEdBcUJQLEtBQW9CLENBQUMsU0FBRCxDQUVyQixDQUNELENBU0QsUUFDQSxDOzs7QUMxS0QsYUFFQSxHQUFNLCtpQkFBTixDQXdDQSxPQUFPLElBQVAsQ0FBWSxTQUFaLEVBQXVCLEdBQXZCLENBQTJCLGtCQUFLLFdBQVUsWUFBVixHQUFMLENBQTNCLEMsQ0FDQSxPQUFPLE9BQVAsQ0FBaUIsUzs7O0FDM0NqQixhQUVBLE9BQU8sT0FBUCxDQUFpQixlQUF5QixLQUN6QyxFQUFTLEVBQVMsRUFBUyxFQUFsQixDQUF1QixFQURTLENBRW5DLEVBQU8sTUFBUCxFQUZtQyxFQUd4QyxFQUFTLEdBQVQsQ0FFRCxRQUNBLEM7OztBQ1JELGFBRUEsR0FBTSxXQUFZLFFBQVEsZUFBUixDQUFsQixDQUVNLDhMQUZOLENBSU0sU0FBVywyR0FKakIsQ0FLTSxRQUFVLGdJQUxoQixDQU1NLFNBQVcsR0FBSSxPQUFKLENBQVcsWUFBYyxPQUFPLElBQVAsQ0FBWSxHQUFaLENBQWQsQ0FBaUMsb0JBQTVDLENBQWtFLEdBQWxFLENBTmpCLENBT00sOENBUE4sQ0FTTSxxQkFBdUIsZUFBZ0MsQ0FDM0QsR0FBSSxFQUFKLENBQ0MsU0FFRCxHQUFJLE9BQVUsTUFBZCxDQUNDLE1BQU8sSUFBUCxDQUVELEdBQUksT0FBVSxLQUFkLENBQ0MsTUFBTyxJQUFQLENBRUQsR0FBSSxFQUFVLE1BQWQsQ0FBc0IsQ0FDckIsR0FBSSxHQUFNLEVBQVUsT0FBVixDQUFrQixFQUFVLE1BQTVCLENBQVYsQ0FEcUIsTUFFVixDQUFDLENBQVIsR0FGaUIsR0FLZCxFQUFVLE9BQVYsQ0FBa0IsR0FBSSxPQUFKLENBQVcsSUFBTSxFQUFVLE1BQWhCLENBQXlCLEdBQXBDLENBQWxCLENBQTRELEVBQU8sSUFBbkUsQ0FDUCxDQUNELEdBQUksRUFBVSxLQUFkLENBQXFCLENBQ3BCLEdBQUksR0FBTSxFQUFVLE9BQVYsQ0FBa0IsRUFBVSxLQUE1QixDQUFWLENBRG9CLE1BRVQsQ0FBQyxDQUFSLEdBRmdCLENBR1osR0FIWSxDQUtiLEVBQVUsT0FBVixDQUFrQixHQUFJLE9BQUosQ0FBVyxJQUFNLEVBQVUsS0FBaEIsQ0FBd0IsR0FBbkMsQ0FBbEIsQ0FBMkQsTUFBM0QsQ0FDUCxDQUNELE1BQU8sSUFDUixDQWxDRCxDQW9DQSxPQUFPLE9BQVAsQ0FBaUIsV0FBVSxDQUMxQixHQUFJLEdBQU8sQ0FDVixNQUFPLEVBREcsQ0FBWCxDQUtBLEdBQUcsRUFBSCxDQUNDLFNBR0QsR0FBSSxLQUFKLENBR0ksRUFBSyxDQUFDLEVBQVMsRUFBVixFQUFjLFdBQWQsRUFIVCxDQVYwQixFQWNoQixXQUFOLEdBZHNCLENBZWhCLFVBQVUsR0FBSSxLQUFKLENBQVMsS0FBSyxHQUFMLFdBQVQsQ0FBVixFQUFnRCxNQUFoRCxDQUF1RCxDQUF2RCxDQUEwRCxFQUExRCxDQWZnQixDQWlCWCxPQUFOLEdBakJpQixDQWtCaEIsVUFBVSxHQUFJLEtBQWQsRUFBc0IsTUFBdEIsQ0FBNkIsQ0FBN0IsQ0FBZ0MsRUFBaEMsQ0FsQmdCLENBb0JYLFVBQU4sR0FwQmlCLENBcUJoQixVQUFVLEdBQUksS0FBSixDQUFTLEtBQUssR0FBTCxXQUFULENBQVYsRUFBZ0QsTUFBaEQsQ0FBdUQsQ0FBdkQsQ0FBMEQsRUFBMUQsQ0FyQmdCLENBd0JoQixFQUFPLFFBQVAsR0FBa0IsT0FBbEIsQ0FBMEIsWUFBMUIsQ0FBd0MsRUFBeEMsRUFBNEMsT0FBNUMsQ0FBb0QsS0FBcEQsQ0FBMkQsR0FBM0QsQ0F4QmdCLENBNEIxQixHQUFJLEdBQUksU0FBUyxJQUFULEdBQVIsQ0FDQSxHQUFHLElBQ0EsQ0FBQyxFQUFFLENBQUYsQ0FBRCxFQUFTLENBQUMsRUFBRSxDQUFGLENBQVgsRUFBb0IsRUFBRSxDQUFGLEdBQVEsRUFBRSxDQUFGLENBQTVCLEVBQTZDLFFBQVIsSUFBRSxDQUFGLEdBQTRCLFFBQVIsSUFBRSxDQUFGLENBRHhELElBRUEsRUFBRSxDQUFGLEdBQVEsRUFBRSxDQUFGLENBQVIsRUFBZ0IsRUFBRSxDQUFGLENBQWpCLEVBQTJCLENBQUMsRUFBRSxDQUFGLENBQUQsRUFBUyxDQUFDLEVBQUUsQ0FBRixDQUZwQyxDQUFILENBRStDLENBRzlDLEdBQWtCLENBQWYsSUFBRSxDQUFGLEVBQUssTUFBTCxFQUFtQyxDQUFmLElBQUUsQ0FBRixFQUFLLE1BQXpCLEVBQWdELFFBQVIsSUFBRSxDQUFGLENBQTNDLENBRUMsRUFBSyxJQUFMLENBQVksRUFBRSxDQUFGLENBRmIsQ0FHQyxFQUFLLEtBQUwsQ0FBYSxFQUFFLENBQUYsQ0FIZCxDQUlDLEVBQUssR0FBTCxDQUFXLEVBQUUsQ0FBRixDQUpaLENBS0MsRUFBSyxLQUFMLEVBQWMsRUFBRSxDQUFGLEVBQU8sR0FBUCxDQUFhLEVBTDVCLENBTUMsRUFBSyxLQUFMLEVBQWMsRUFBRSxDQUFGLEVBQU8sR0FBUCxDQUFhLEVBTjVCLENBT0MsRUFBSyxLQUFMLEVBQWMsRUFBRSxDQUFGLEVBQU8sR0FBUCxDQUFhLEVBUDVCLEtBUU8sSUFBRyxFQUFFLENBQUYsR0FBUSxDQUFDLEVBQUUsQ0FBRixDQUFULEVBQWlCLEVBQUUsQ0FBRixDQUFwQixDQUNOLEVBQUssS0FBTCxDQUFhLEVBQUUsQ0FBRixDQURQLENBRU4sRUFBSyxJQUFMLENBQVksRUFBRSxDQUFGLENBRk4sQ0FHTixFQUFLLEtBQUwsRUFBYyxFQUFFLENBQUYsRUFBTyxHQUFQLENBQWEsRUFIckIsQ0FJTixFQUFLLEtBQUwsRUFBYyxFQUFFLENBQUYsRUFBTyxHQUFQLENBQWEsRUFKckIsS0FLQSxDQUVOLEdBQUksR0FBVSxPQUFPLFNBQVAsQ0FBaUIsUUFBakIsQ0FBNEIsT0FBTyxTQUFQLENBQWlCLFFBQWpCLENBQTBCLE1BQTFCLENBQWlDLENBQWpDLENBQTVCLENBQWtFLElBQWhGLENBQ2MsSUFBWCxLQUNTLElBQVgsR0FERSxFQUVTLElBQVgsR0FGRSxFQUdTLElBQVgsR0FOSyxFQU9KLEVBQUssS0FBTCxDQUFhLEVBQUUsQ0FBRixDQVBULENBUUosRUFBSyxHQUFMLENBQVcsRUFBRSxDQUFGLENBUlAsQ0FTSixFQUFLLEtBQUwsRUFBYyxFQUFFLENBQUYsRUFBTyxHQUFQLENBQWEsRUFUdkIsQ0FVSixFQUFLLEtBQUwsRUFBYyxFQUFFLENBQUYsRUFBTyxHQUFQLENBQWEsRUFWdkIsR0FZTCxFQUFLLEtBQUwsQ0FBYSxFQUFFLENBQUYsQ0FaUixDQWFMLEVBQUssR0FBTCxDQUFXLEVBQUUsQ0FBRixDQWJOLENBY0wsRUFBSyxLQUFMLEVBQWMsRUFBRSxDQUFGLEVBQU8sR0FBUCxDQUFhLEVBZHRCLENBZUwsRUFBSyxLQUFMLEVBQWMsRUFBRSxDQUFGLEVBQU8sR0FBUCxDQUFhLEVBZnRCLEVBaUJOLEVBQUssSUFBTCxDQUFZLEVBQUUsQ0FBRixDQWpCTixDQWtCTixFQUFLLEtBQUwsRUFBYyxHQUNkLENBUUQsR0FORyxFQUFLLElBTVIsR0FMQyxFQUFLLElBQUwsQ0FBWSxTQUFTLEVBQUssSUFBZCxDQUFvQixFQUFwQixDQUtiLEVBSEcsRUFBSyxHQUdSLEdBRkMsRUFBSyxHQUFMLENBQVcsU0FBUyxFQUFLLEdBQWQsQ0FBbUIsRUFBbkIsQ0FFWixFQUFHLEVBQUssS0FBUixHQUNDLEVBQUssS0FBTCxDQUFhLFNBQVMsRUFBSyxLQUFkLENBQXFCLEVBQXJCLENBRGQsQ0FHaUIsRUFBYixHQUFLLEtBSFQsRUFHcUIsQ0FFbkIsR0FBSSxHQUFNLEVBQUssR0FBZixDQUNBLEVBQUssR0FBTCxDQUFXLEVBQUssS0FIRyxDQUluQixFQUFLLEtBQUwsRUFKbUIsQ0FLbkIsRUFBSyxLQUFMLENBQWEsRUFBSyxLQUFMLENBQVcsT0FBWCxDQUFtQixHQUFuQixDQUF3QixHQUF4QixFQUNYLE9BRFcsQ0FDSCxHQURHLENBQ0UsR0FERixFQUVYLE9BRlcsQ0FFSCxHQUZHLENBRUUsR0FGRixFQUdYLE9BSFcsQ0FHSCxHQUhHLENBR0UsR0FIRixDQUliLENBR0YsR0FBRyxDQUFDLENBQUMsRUFBSyxLQUFOLEVBQTZCLEVBQWQsSUFBSyxLQUFyQixJQUFzQyxDQUFDLEVBQUssR0FBTixFQUF5QixFQUFaLElBQUssR0FBeEQsQ0FBSCxDQUF1RSxDQUN0RSxHQUFHLEVBQUssSUFBTCxFQUF5QixHQUFaLEdBQUssSUFBckIsQ0FBaUMsQ0FFaEMsR0FBSSxHQUFRLEdBQUksS0FBaEIsQ0FDSSxFQUFPLEVBQU0sV0FBTixFQURYLENBRUksRUFBZSxFQUFPLEdBRjFCLENBR0ksRUFBVSxHQUhkLENBT0MsRUFBSyxJQVQwQixDQU83QixFQUFLLElBQUwsR0FQNkIsQ0FTbkIsRUFBVSxFQUFLLElBVEksQ0FZbkIsRUFBVSxHQUFWLENBQWdCLEVBQUssSUFFbEMsQ0FFRSxFQUFLLEtBakI4RCxDQWtCckUsRUFBSyxLQUFMLEVBbEJxRSxDQW9CckUsTUFBTyxHQUFLLEtBcEJ5RCxDQXVCdEUsRUFBTSxJQUFOLENBQ0MsQ0FBRSxLQUFNLEVBQUUsQ0FBRixDQUFSLENBQWMsU0FBZCxDQURELENBRUMsQ0FBRSxLQUFNLEVBQUUsQ0FBRixDQUFSLENBRkQsQ0FJQSxDQTNCRCxJQTJCTyxDQUNOLEdBQUksR0FBTyxDQUNWLE1BQU8sRUFERyxDQUFYLENBR0EsRUFBTSxJQUFOLENBQVcsQ0FBRSxNQUFGLENBQVgsQ0FDQSxDQUNELENBN0ZELElBOEZDLEdBQU0sSUFBTixDQUFXLENBQUUsTUFBRixDQUFYLENBOUZELENBbUdBLEdBQUcsQ0FBQyxFQUFLLElBQVQsQ0FDQyxJQUFLLEdBQUksRUFBVCxNQUFxQixDQUNwQixHQUFJLEdBQUksUUFBUSxJQUFSLENBQWEsS0FBUyxJQUF0QixDQUFSLENBQ0EsS0FBTyxDQUNOLEVBQUssSUFBTCxDQUFZLEVBQUUsQ0FBRixDQUROLENBRU4sRUFBSyxLQUFMLENBQWEscUJBQXFCLEVBQUssS0FBMUIsQ0FBaUMsR0FBakMsQ0FBc0MsSUFBdEMsQ0FGUCxDQUdOLEVBQU0sTUFBTixHQUNJLENBREosQ0FFQyxDQUFFLEtBQU0sRUFBRSxDQUFGLENBQVIsQ0FBYyxTQUFkLENBRkQsQ0FHQyxDQUFFLEtBQU0sRUFBRSxDQUFGLENBQVIsQ0FIRCxDQUhNLENBUU4sS0FDQSxDQUNELENBSUYsR0FBRyxXQUFLLEtBQVIsQ0FDQyxJQUFLLEdBQUksRUFBVCxNQUFxQixDQUNwQixHQUFJLEdBQUksU0FBUyxJQUFULENBQWMsS0FBUyxJQUF2QixDQUFSLENBQ0EsS0FBTyxDQUVOLEVBQUssS0FBTCxDQUFhLE9BQU8sT0FBUCxDQUFlLEVBQUUsQ0FBRixFQUFLLFdBQUwsRUFBZixFQUFxQyxFQUY1QyxDQUdOLEVBQUssS0FBTCxDQUFhLHFCQUFxQixFQUFLLEtBQTFCLENBQWlDLEdBQWpDLENBQXNDLElBQXRDLENBSFAsQ0FJTixFQUFNLE1BQU4sR0FDSSxDQURKLENBRUMsQ0FBRSxLQUFNLEVBQUUsQ0FBRixDQUFSLENBQWMsT0FBUSxHQUF0QixDQUZELENBR0MsQ0FBRSxLQUFNLEVBQUUsQ0FBRixDQUFSLENBQWMsTUFBTyxHQUFyQixDQUhELENBSk0sQ0FTTixLQUNBLENBQ0QsQ0FJRixHQUFHLENBQUMsRUFBSyxHQUFULENBRUMsSUFBSyxHQUFJLEVBQVQsTUFBcUIsQ0FDcEIsR0FBSSxHQUFJLE9BQU8sSUFBUCxDQUFZLEtBQVMsSUFBckIsQ0FBUixDQUNBLEtBQU8sQ0FDTixHQUNDLEVBREQsQ0FBSSxFQUFNLFNBQVMsRUFBRSxDQUFGLENBQVQsQ0FBZSxFQUFmLENBQVYsQ0FHQSxHQUFXLEVBQVAsR0FBSixDQUFlLENBQ2QsRUFBSyxHQUFMLEVBRGMsQ0FFZCxFQUFLLEtBQUwsQ0FBYSxxQkFBcUIsRUFBSyxLQUExQixDQUFpQyxHQUFqQyxDQUFzQyxJQUF0QyxDQUZDLENBR0QsQ0FBVixHQUFFLEtBSFMsRUFJYixFQUFPLEtBQVMsSUFBVCxDQUFjLE1BQWQsQ0FBcUIsQ0FBckIsQ0FBd0IsRUFBRSxLQUExQixDQUpNLENBS1YsRUFBRSxDQUFGLENBTFUsR0FNWixHQUFRLElBQU0sRUFBRSxDQUFGLENBTkYsR0FTYixFQUFPLEVBQUUsQ0FBRixDQVRNLENBV2QsRUFBTSxNQUFOLEdBQ0ksQ0FESixDQUVDLENBQUUsTUFBRixDQUZELENBWGMsQ0FlZCxLQUNBLENBQ0QsQ0FDRCxDQUtGLElBQUssR0FBSSxFQUFULEdBREEsR0FBSyxJQUFMLENBQVksRUFDWixHQUNDLEVBQUssSUFBTCxFQUFhLEtBQVMsSUFBVCxDQUFnQixHQUE3QixDQWVELE1BWEcsR0FBSyxJQVdSLEdBVkMsRUFBSyxJQUFMLENBQVksRUFBSyxJQUFMLENBQVUsT0FBVixDQUFrQixnQ0FBbEIsQ0FBb0QsRUFBcEQsQ0FVYixHQVBpQixFQUFkLEtBQUssSUFBTCxFQUFvQixVQUFLLElBTzVCLEdBTkMsTUFBTyxHQUFLLElBTWIsRUFGRyxFQUFLLElBQUwsRUFBMkIsQ0FBZCxLQUFLLElBRXJCLElBRmlDLEVBQUssSUFBTCxFQUFhLEVBRTlDLEdBQ0EsQzs7OzZLQ3pQRCxHQUFNLFFBQVMsUUFBUSxVQUFSLENBQWYsQ0FDTSxVQUFZLFFBQVEsY0FBUixDQURsQixDQUdNLDBGQUNZLEVBRFosNkNBRVksRUFGWiw2Q0FHVyxFQUhYLDZDQUlZLEVBSlosNkNBS1ksRUFMWiw2Q0FNWSxFQU5aLDZDQU9ZLEVBUFosNkNBUVksRUFSWiw2Q0FTWSxFQVRaLDZDQVVZLEVBVlosNkNBV2EsRUFYYiw2Q0FZYSxFQVpiLDRDQWFZLEdBYlosNkNBY2EsR0FkYiw2Q0FlYSxFQWZiLDZDQWdCYSxHQWhCYiw2Q0FpQmEsR0FqQmIsNkNBa0JhLEdBbEJiLDZDQW1CYSxHQW5CYiw2Q0FvQmEsRUFwQmIsNkNBcUJhLEVBckJiLDZDQXNCYSxFQXRCYiw2Q0F1QmEsRUF2QmIsNkNBd0JhLEdBeEJiLDZDQXlCYSxFQXpCYiw2Q0EwQmEsRUExQmIsNkNBMkJhLEdBM0JiLDZDQTRCYSxFQTVCYiw2Q0E2QmEsRUE3QmIsNkNBOEJhLEdBOUJiLDZDQStCYSxHQS9CYiw2Q0FnQ2EsR0FoQ2IsNkNBaUNhLEdBakNiLDZDQWtDYSxFQWxDYiw2Q0FtQ2EsRUFuQ2IsNkNBb0NhLEVBcENiLDZDQXFDYyxHQXJDZCw2Q0FzQ2MsRUF0Q2QsNkNBdUNjLEVBdkNkLDZDQXdDYyxFQXhDZCw2Q0F5Q2MsRUF6Q2QsNkNBMENjLEVBMUNkLDZDQTJDYyxFQTNDZCw2Q0E0Q2MsRUE1Q2QsNkNBNkNjLEVBN0NkLDZDQThDYyxFQTlDZCw2Q0ErQ2MsRUEvQ2QsNkNBZ0RjLEVBaERkLDZDQWlEYyxFQWpEZCw2Q0FrRGMsRUFsRGQsNkNBbURjLEVBbkRkLDZDQW9EYyxHQXBEZCw2Q0FxRGMsR0FyRGQsNkNBc0RjLEdBdERkLHdCQUhOLENBNERBLE9BQU8sT0FBUCxDQUFpQixDQUNoQixJQUFLLG9CQURXLENBRWhCLDBCQUEyQix1Q0FBcUIsQ0FHL0MsTUFGQSxHQUEyQixRQUFsQixhQUFzQyxZQUUvQyxDQURBLEVBQTZCLFFBQW5CLGFBQXdDLFNBQ2xELENBQU8scUJBQXFCLENBQUMsR0FBVSxDQUFYLEdBQXJCLENBQ1AsQ0FOZSxDIiwiZmlsZSI6ImdlbmVyYXRlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3ZhciBmPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIrbytcIidcIik7dGhyb3cgZi5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGZ9dmFyIGw9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGwuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sbCxsLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSIsIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE0LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIGh0dHBzOi8vcmF3LmdpdGh1Yi5jb20vZmFjZWJvb2svcmVnZW5lcmF0b3IvbWFzdGVyL0xJQ0VOU0UgZmlsZS4gQW5cbiAqIGFkZGl0aW9uYWwgZ3JhbnQgb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpblxuICogdGhlIHNhbWUgZGlyZWN0b3J5LlxuICovXG5cbiEoZnVuY3Rpb24oZ2xvYmFsKSB7XG4gIFwidXNlIHN0cmljdFwiO1xuXG4gIHZhciBoYXNPd24gPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5O1xuICB2YXIgdW5kZWZpbmVkOyAvLyBNb3JlIGNvbXByZXNzaWJsZSB0aGFuIHZvaWQgMC5cbiAgdmFyIGl0ZXJhdG9yU3ltYm9sID1cbiAgICB0eXBlb2YgU3ltYm9sID09PSBcImZ1bmN0aW9uXCIgJiYgU3ltYm9sLml0ZXJhdG9yIHx8IFwiQEBpdGVyYXRvclwiO1xuXG4gIHZhciBpbk1vZHVsZSA9IHR5cGVvZiBtb2R1bGUgPT09IFwib2JqZWN0XCI7XG4gIHZhciBydW50aW1lID0gZ2xvYmFsLnJlZ2VuZXJhdG9yUnVudGltZTtcbiAgaWYgKHJ1bnRpbWUpIHtcbiAgICBpZiAoaW5Nb2R1bGUpIHtcbiAgICAgIC8vIElmIHJlZ2VuZXJhdG9yUnVudGltZSBpcyBkZWZpbmVkIGdsb2JhbGx5IGFuZCB3ZSdyZSBpbiBhIG1vZHVsZSxcbiAgICAgIC8vIG1ha2UgdGhlIGV4cG9ydHMgb2JqZWN0IGlkZW50aWNhbCB0byByZWdlbmVyYXRvclJ1bnRpbWUuXG4gICAgICBtb2R1bGUuZXhwb3J0cyA9IHJ1bnRpbWU7XG4gICAgfVxuICAgIC8vIERvbid0IGJvdGhlciBldmFsdWF0aW5nIHRoZSByZXN0IG9mIHRoaXMgZmlsZSBpZiB0aGUgcnVudGltZSB3YXNcbiAgICAvLyBhbHJlYWR5IGRlZmluZWQgZ2xvYmFsbHkuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gRGVmaW5lIHRoZSBydW50aW1lIGdsb2JhbGx5IChhcyBleHBlY3RlZCBieSBnZW5lcmF0ZWQgY29kZSkgYXMgZWl0aGVyXG4gIC8vIG1vZHVsZS5leHBvcnRzIChpZiB3ZSdyZSBpbiBhIG1vZHVsZSkgb3IgYSBuZXcsIGVtcHR5IG9iamVjdC5cbiAgcnVudGltZSA9IGdsb2JhbC5yZWdlbmVyYXRvclJ1bnRpbWUgPSBpbk1vZHVsZSA/IG1vZHVsZS5leHBvcnRzIDoge307XG5cbiAgZnVuY3Rpb24gd3JhcChpbm5lckZuLCBvdXRlckZuLCBzZWxmLCB0cnlMb2NzTGlzdCkge1xuICAgIC8vIElmIG91dGVyRm4gcHJvdmlkZWQsIHRoZW4gb3V0ZXJGbi5wcm90b3R5cGUgaW5zdGFuY2VvZiBHZW5lcmF0b3IuXG4gICAgdmFyIGdlbmVyYXRvciA9IE9iamVjdC5jcmVhdGUoKG91dGVyRm4gfHwgR2VuZXJhdG9yKS5wcm90b3R5cGUpO1xuICAgIHZhciBjb250ZXh0ID0gbmV3IENvbnRleHQodHJ5TG9jc0xpc3QgfHwgW10pO1xuXG4gICAgLy8gVGhlIC5faW52b2tlIG1ldGhvZCB1bmlmaWVzIHRoZSBpbXBsZW1lbnRhdGlvbnMgb2YgdGhlIC5uZXh0LFxuICAgIC8vIC50aHJvdywgYW5kIC5yZXR1cm4gbWV0aG9kcy5cbiAgICBnZW5lcmF0b3IuX2ludm9rZSA9IG1ha2VJbnZva2VNZXRob2QoaW5uZXJGbiwgc2VsZiwgY29udGV4dCk7XG5cbiAgICByZXR1cm4gZ2VuZXJhdG9yO1xuICB9XG4gIHJ1bnRpbWUud3JhcCA9IHdyYXA7XG5cbiAgLy8gVHJ5L2NhdGNoIGhlbHBlciB0byBtaW5pbWl6ZSBkZW9wdGltaXphdGlvbnMuIFJldHVybnMgYSBjb21wbGV0aW9uXG4gIC8vIHJlY29yZCBsaWtlIGNvbnRleHQudHJ5RW50cmllc1tpXS5jb21wbGV0aW9uLiBUaGlzIGludGVyZmFjZSBjb3VsZFxuICAvLyBoYXZlIGJlZW4gKGFuZCB3YXMgcHJldmlvdXNseSkgZGVzaWduZWQgdG8gdGFrZSBhIGNsb3N1cmUgdG8gYmVcbiAgLy8gaW52b2tlZCB3aXRob3V0IGFyZ3VtZW50cywgYnV0IGluIGFsbCB0aGUgY2FzZXMgd2UgY2FyZSBhYm91dCB3ZVxuICAvLyBhbHJlYWR5IGhhdmUgYW4gZXhpc3RpbmcgbWV0aG9kIHdlIHdhbnQgdG8gY2FsbCwgc28gdGhlcmUncyBubyBuZWVkXG4gIC8vIHRvIGNyZWF0ZSBhIG5ldyBmdW5jdGlvbiBvYmplY3QuIFdlIGNhbiBldmVuIGdldCBhd2F5IHdpdGggYXNzdW1pbmdcbiAgLy8gdGhlIG1ldGhvZCB0YWtlcyBleGFjdGx5IG9uZSBhcmd1bWVudCwgc2luY2UgdGhhdCBoYXBwZW5zIHRvIGJlIHRydWVcbiAgLy8gaW4gZXZlcnkgY2FzZSwgc28gd2UgZG9uJ3QgaGF2ZSB0byB0b3VjaCB0aGUgYXJndW1lbnRzIG9iamVjdC4gVGhlXG4gIC8vIG9ubHkgYWRkaXRpb25hbCBhbGxvY2F0aW9uIHJlcXVpcmVkIGlzIHRoZSBjb21wbGV0aW9uIHJlY29yZCwgd2hpY2hcbiAgLy8gaGFzIGEgc3RhYmxlIHNoYXBlIGFuZCBzbyBob3BlZnVsbHkgc2hvdWxkIGJlIGNoZWFwIHRvIGFsbG9jYXRlLlxuICBmdW5jdGlvbiB0cnlDYXRjaChmbiwgb2JqLCBhcmcpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHsgdHlwZTogXCJub3JtYWxcIiwgYXJnOiBmbi5jYWxsKG9iaiwgYXJnKSB9O1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIHsgdHlwZTogXCJ0aHJvd1wiLCBhcmc6IGVyciB9O1xuICAgIH1cbiAgfVxuXG4gIHZhciBHZW5TdGF0ZVN1c3BlbmRlZFN0YXJ0ID0gXCJzdXNwZW5kZWRTdGFydFwiO1xuICB2YXIgR2VuU3RhdGVTdXNwZW5kZWRZaWVsZCA9IFwic3VzcGVuZGVkWWllbGRcIjtcbiAgdmFyIEdlblN0YXRlRXhlY3V0aW5nID0gXCJleGVjdXRpbmdcIjtcbiAgdmFyIEdlblN0YXRlQ29tcGxldGVkID0gXCJjb21wbGV0ZWRcIjtcblxuICAvLyBSZXR1cm5pbmcgdGhpcyBvYmplY3QgZnJvbSB0aGUgaW5uZXJGbiBoYXMgdGhlIHNhbWUgZWZmZWN0IGFzXG4gIC8vIGJyZWFraW5nIG91dCBvZiB0aGUgZGlzcGF0Y2ggc3dpdGNoIHN0YXRlbWVudC5cbiAgdmFyIENvbnRpbnVlU2VudGluZWwgPSB7fTtcblxuICAvLyBEdW1teSBjb25zdHJ1Y3RvciBmdW5jdGlvbnMgdGhhdCB3ZSB1c2UgYXMgdGhlIC5jb25zdHJ1Y3RvciBhbmRcbiAgLy8gLmNvbnN0cnVjdG9yLnByb3RvdHlwZSBwcm9wZXJ0aWVzIGZvciBmdW5jdGlvbnMgdGhhdCByZXR1cm4gR2VuZXJhdG9yXG4gIC8vIG9iamVjdHMuIEZvciBmdWxsIHNwZWMgY29tcGxpYW5jZSwgeW91IG1heSB3aXNoIHRvIGNvbmZpZ3VyZSB5b3VyXG4gIC8vIG1pbmlmaWVyIG5vdCB0byBtYW5nbGUgdGhlIG5hbWVzIG9mIHRoZXNlIHR3byBmdW5jdGlvbnMuXG4gIGZ1bmN0aW9uIEdlbmVyYXRvcigpIHt9XG4gIGZ1bmN0aW9uIEdlbmVyYXRvckZ1bmN0aW9uKCkge31cbiAgZnVuY3Rpb24gR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGUoKSB7fVxuXG4gIHZhciBHcCA9IEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlLnByb3RvdHlwZSA9IEdlbmVyYXRvci5wcm90b3R5cGU7XG4gIEdlbmVyYXRvckZ1bmN0aW9uLnByb3RvdHlwZSA9IEdwLmNvbnN0cnVjdG9yID0gR2VuZXJhdG9yRnVuY3Rpb25Qcm90b3R5cGU7XG4gIEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlLmNvbnN0cnVjdG9yID0gR2VuZXJhdG9yRnVuY3Rpb247XG4gIEdlbmVyYXRvckZ1bmN0aW9uLmRpc3BsYXlOYW1lID0gXCJHZW5lcmF0b3JGdW5jdGlvblwiO1xuXG4gIC8vIEhlbHBlciBmb3IgZGVmaW5pbmcgdGhlIC5uZXh0LCAudGhyb3csIGFuZCAucmV0dXJuIG1ldGhvZHMgb2YgdGhlXG4gIC8vIEl0ZXJhdG9yIGludGVyZmFjZSBpbiB0ZXJtcyBvZiBhIHNpbmdsZSAuX2ludm9rZSBtZXRob2QuXG4gIGZ1bmN0aW9uIGRlZmluZUl0ZXJhdG9yTWV0aG9kcyhwcm90b3R5cGUpIHtcbiAgICBbXCJuZXh0XCIsIFwidGhyb3dcIiwgXCJyZXR1cm5cIl0uZm9yRWFjaChmdW5jdGlvbihtZXRob2QpIHtcbiAgICAgIHByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oYXJnKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pbnZva2UobWV0aG9kLCBhcmcpO1xuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIHJ1bnRpbWUuaXNHZW5lcmF0b3JGdW5jdGlvbiA9IGZ1bmN0aW9uKGdlbkZ1bikge1xuICAgIHZhciBjdG9yID0gdHlwZW9mIGdlbkZ1biA9PT0gXCJmdW5jdGlvblwiICYmIGdlbkZ1bi5jb25zdHJ1Y3RvcjtcbiAgICByZXR1cm4gY3RvclxuICAgICAgPyBjdG9yID09PSBHZW5lcmF0b3JGdW5jdGlvbiB8fFxuICAgICAgICAvLyBGb3IgdGhlIG5hdGl2ZSBHZW5lcmF0b3JGdW5jdGlvbiBjb25zdHJ1Y3RvciwgdGhlIGJlc3Qgd2UgY2FuXG4gICAgICAgIC8vIGRvIGlzIHRvIGNoZWNrIGl0cyAubmFtZSBwcm9wZXJ0eS5cbiAgICAgICAgKGN0b3IuZGlzcGxheU5hbWUgfHwgY3Rvci5uYW1lKSA9PT0gXCJHZW5lcmF0b3JGdW5jdGlvblwiXG4gICAgICA6IGZhbHNlO1xuICB9O1xuXG4gIHJ1bnRpbWUubWFyayA9IGZ1bmN0aW9uKGdlbkZ1bikge1xuICAgIGlmIChPYmplY3Quc2V0UHJvdG90eXBlT2YpIHtcbiAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihnZW5GdW4sIEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZ2VuRnVuLl9fcHJvdG9fXyA9IEdlbmVyYXRvckZ1bmN0aW9uUHJvdG90eXBlO1xuICAgIH1cbiAgICBnZW5GdW4ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShHcCk7XG4gICAgcmV0dXJuIGdlbkZ1bjtcbiAgfTtcblxuICAvLyBXaXRoaW4gdGhlIGJvZHkgb2YgYW55IGFzeW5jIGZ1bmN0aW9uLCBgYXdhaXQgeGAgaXMgdHJhbnNmb3JtZWQgdG9cbiAgLy8gYHlpZWxkIHJlZ2VuZXJhdG9yUnVudGltZS5hd3JhcCh4KWAsIHNvIHRoYXQgdGhlIHJ1bnRpbWUgY2FuIHRlc3RcbiAgLy8gYHZhbHVlIGluc3RhbmNlb2YgQXdhaXRBcmd1bWVudGAgdG8gZGV0ZXJtaW5lIGlmIHRoZSB5aWVsZGVkIHZhbHVlIGlzXG4gIC8vIG1lYW50IHRvIGJlIGF3YWl0ZWQuIFNvbWUgbWF5IGNvbnNpZGVyIHRoZSBuYW1lIG9mIHRoaXMgbWV0aG9kIHRvb1xuICAvLyBjdXRlc3ksIGJ1dCB0aGV5IGFyZSBjdXJtdWRnZW9ucy5cbiAgcnVudGltZS5hd3JhcCA9IGZ1bmN0aW9uKGFyZykge1xuICAgIHJldHVybiBuZXcgQXdhaXRBcmd1bWVudChhcmcpO1xuICB9O1xuXG4gIGZ1bmN0aW9uIEF3YWl0QXJndW1lbnQoYXJnKSB7XG4gICAgdGhpcy5hcmcgPSBhcmc7XG4gIH1cblxuICBmdW5jdGlvbiBBc3luY0l0ZXJhdG9yKGdlbmVyYXRvcikge1xuICAgIC8vIFRoaXMgaW52b2tlIGZ1bmN0aW9uIGlzIHdyaXR0ZW4gaW4gYSBzdHlsZSB0aGF0IGFzc3VtZXMgc29tZVxuICAgIC8vIGNhbGxpbmcgZnVuY3Rpb24gKG9yIFByb21pc2UpIHdpbGwgaGFuZGxlIGV4Y2VwdGlvbnMuXG4gICAgZnVuY3Rpb24gaW52b2tlKG1ldGhvZCwgYXJnKSB7XG4gICAgICB2YXIgcmVzdWx0ID0gZ2VuZXJhdG9yW21ldGhvZF0oYXJnKTtcbiAgICAgIHZhciB2YWx1ZSA9IHJlc3VsdC52YWx1ZTtcbiAgICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIEF3YWl0QXJndW1lbnRcbiAgICAgICAgPyBQcm9taXNlLnJlc29sdmUodmFsdWUuYXJnKS50aGVuKGludm9rZU5leHQsIGludm9rZVRocm93KVxuICAgICAgICA6IFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihmdW5jdGlvbih1bndyYXBwZWQpIHtcbiAgICAgICAgICAgIC8vIFdoZW4gYSB5aWVsZGVkIFByb21pc2UgaXMgcmVzb2x2ZWQsIGl0cyBmaW5hbCB2YWx1ZSBiZWNvbWVzXG4gICAgICAgICAgICAvLyB0aGUgLnZhbHVlIG9mIHRoZSBQcm9taXNlPHt2YWx1ZSxkb25lfT4gcmVzdWx0IGZvciB0aGVcbiAgICAgICAgICAgIC8vIGN1cnJlbnQgaXRlcmF0aW9uLiBJZiB0aGUgUHJvbWlzZSBpcyByZWplY3RlZCwgaG93ZXZlciwgdGhlXG4gICAgICAgICAgICAvLyByZXN1bHQgZm9yIHRoaXMgaXRlcmF0aW9uIHdpbGwgYmUgcmVqZWN0ZWQgd2l0aCB0aGUgc2FtZVxuICAgICAgICAgICAgLy8gcmVhc29uLiBOb3RlIHRoYXQgcmVqZWN0aW9ucyBvZiB5aWVsZGVkIFByb21pc2VzIGFyZSBub3RcbiAgICAgICAgICAgIC8vIHRocm93biBiYWNrIGludG8gdGhlIGdlbmVyYXRvciBmdW5jdGlvbiwgYXMgaXMgdGhlIGNhc2VcbiAgICAgICAgICAgIC8vIHdoZW4gYW4gYXdhaXRlZCBQcm9taXNlIGlzIHJlamVjdGVkLiBUaGlzIGRpZmZlcmVuY2UgaW5cbiAgICAgICAgICAgIC8vIGJlaGF2aW9yIGJldHdlZW4geWllbGQgYW5kIGF3YWl0IGlzIGltcG9ydGFudCwgYmVjYXVzZSBpdFxuICAgICAgICAgICAgLy8gYWxsb3dzIHRoZSBjb25zdW1lciB0byBkZWNpZGUgd2hhdCB0byBkbyB3aXRoIHRoZSB5aWVsZGVkXG4gICAgICAgICAgICAvLyByZWplY3Rpb24gKHN3YWxsb3cgaXQgYW5kIGNvbnRpbnVlLCBtYW51YWxseSAudGhyb3cgaXQgYmFja1xuICAgICAgICAgICAgLy8gaW50byB0aGUgZ2VuZXJhdG9yLCBhYmFuZG9uIGl0ZXJhdGlvbiwgd2hhdGV2ZXIpLiBXaXRoXG4gICAgICAgICAgICAvLyBhd2FpdCwgYnkgY29udHJhc3QsIHRoZXJlIGlzIG5vIG9wcG9ydHVuaXR5IHRvIGV4YW1pbmUgdGhlXG4gICAgICAgICAgICAvLyByZWplY3Rpb24gcmVhc29uIG91dHNpZGUgdGhlIGdlbmVyYXRvciBmdW5jdGlvbiwgc28gdGhlXG4gICAgICAgICAgICAvLyBvbmx5IG9wdGlvbiBpcyB0byB0aHJvdyBpdCBmcm9tIHRoZSBhd2FpdCBleHByZXNzaW9uLCBhbmRcbiAgICAgICAgICAgIC8vIGxldCB0aGUgZ2VuZXJhdG9yIGZ1bmN0aW9uIGhhbmRsZSB0aGUgZXhjZXB0aW9uLlxuICAgICAgICAgICAgcmVzdWx0LnZhbHVlID0gdW53cmFwcGVkO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHByb2Nlc3MgPT09IFwib2JqZWN0XCIgJiYgcHJvY2Vzcy5kb21haW4pIHtcbiAgICAgIGludm9rZSA9IHByb2Nlc3MuZG9tYWluLmJpbmQoaW52b2tlKTtcbiAgICB9XG5cbiAgICB2YXIgaW52b2tlTmV4dCA9IGludm9rZS5iaW5kKGdlbmVyYXRvciwgXCJuZXh0XCIpO1xuICAgIHZhciBpbnZva2VUaHJvdyA9IGludm9rZS5iaW5kKGdlbmVyYXRvciwgXCJ0aHJvd1wiKTtcbiAgICB2YXIgaW52b2tlUmV0dXJuID0gaW52b2tlLmJpbmQoZ2VuZXJhdG9yLCBcInJldHVyblwiKTtcbiAgICB2YXIgcHJldmlvdXNQcm9taXNlO1xuXG4gICAgZnVuY3Rpb24gZW5xdWV1ZShtZXRob2QsIGFyZykge1xuICAgICAgZnVuY3Rpb24gY2FsbEludm9rZVdpdGhNZXRob2RBbmRBcmcoKSB7XG4gICAgICAgIHJldHVybiBpbnZva2UobWV0aG9kLCBhcmcpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcHJldmlvdXNQcm9taXNlID1cbiAgICAgICAgLy8gSWYgZW5xdWV1ZSBoYXMgYmVlbiBjYWxsZWQgYmVmb3JlLCB0aGVuIHdlIHdhbnQgdG8gd2FpdCB1bnRpbFxuICAgICAgICAvLyBhbGwgcHJldmlvdXMgUHJvbWlzZXMgaGF2ZSBiZWVuIHJlc29sdmVkIGJlZm9yZSBjYWxsaW5nIGludm9rZSxcbiAgICAgICAgLy8gc28gdGhhdCByZXN1bHRzIGFyZSBhbHdheXMgZGVsaXZlcmVkIGluIHRoZSBjb3JyZWN0IG9yZGVyLiBJZlxuICAgICAgICAvLyBlbnF1ZXVlIGhhcyBub3QgYmVlbiBjYWxsZWQgYmVmb3JlLCB0aGVuIGl0IGlzIGltcG9ydGFudCB0b1xuICAgICAgICAvLyBjYWxsIGludm9rZSBpbW1lZGlhdGVseSwgd2l0aG91dCB3YWl0aW5nIG9uIGEgY2FsbGJhY2sgdG8gZmlyZSxcbiAgICAgICAgLy8gc28gdGhhdCB0aGUgYXN5bmMgZ2VuZXJhdG9yIGZ1bmN0aW9uIGhhcyB0aGUgb3Bwb3J0dW5pdHkgdG8gZG9cbiAgICAgICAgLy8gYW55IG5lY2Vzc2FyeSBzZXR1cCBpbiBhIHByZWRpY3RhYmxlIHdheS4gVGhpcyBwcmVkaWN0YWJpbGl0eVxuICAgICAgICAvLyBpcyB3aHkgdGhlIFByb21pc2UgY29uc3RydWN0b3Igc3luY2hyb25vdXNseSBpbnZva2VzIGl0c1xuICAgICAgICAvLyBleGVjdXRvciBjYWxsYmFjaywgYW5kIHdoeSBhc3luYyBmdW5jdGlvbnMgc3luY2hyb25vdXNseVxuICAgICAgICAvLyBleGVjdXRlIGNvZGUgYmVmb3JlIHRoZSBmaXJzdCBhd2FpdC4gU2luY2Ugd2UgaW1wbGVtZW50IHNpbXBsZVxuICAgICAgICAvLyBhc3luYyBmdW5jdGlvbnMgaW4gdGVybXMgb2YgYXN5bmMgZ2VuZXJhdG9ycywgaXQgaXMgZXNwZWNpYWxseVxuICAgICAgICAvLyBpbXBvcnRhbnQgdG8gZ2V0IHRoaXMgcmlnaHQsIGV2ZW4gdGhvdWdoIGl0IHJlcXVpcmVzIGNhcmUuXG4gICAgICAgIHByZXZpb3VzUHJvbWlzZSA/IHByZXZpb3VzUHJvbWlzZS50aGVuKFxuICAgICAgICAgIGNhbGxJbnZva2VXaXRoTWV0aG9kQW5kQXJnLFxuICAgICAgICAgIC8vIEF2b2lkIHByb3BhZ2F0aW5nIGZhaWx1cmVzIHRvIFByb21pc2VzIHJldHVybmVkIGJ5IGxhdGVyXG4gICAgICAgICAgLy8gaW52b2NhdGlvbnMgb2YgdGhlIGl0ZXJhdG9yLlxuICAgICAgICAgIGNhbGxJbnZva2VXaXRoTWV0aG9kQW5kQXJnXG4gICAgICAgICkgOiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkge1xuICAgICAgICAgIHJlc29sdmUoY2FsbEludm9rZVdpdGhNZXRob2RBbmRBcmcoKSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIERlZmluZSB0aGUgdW5pZmllZCBoZWxwZXIgbWV0aG9kIHRoYXQgaXMgdXNlZCB0byBpbXBsZW1lbnQgLm5leHQsXG4gICAgLy8gLnRocm93LCBhbmQgLnJldHVybiAoc2VlIGRlZmluZUl0ZXJhdG9yTWV0aG9kcykuXG4gICAgdGhpcy5faW52b2tlID0gZW5xdWV1ZTtcbiAgfVxuXG4gIGRlZmluZUl0ZXJhdG9yTWV0aG9kcyhBc3luY0l0ZXJhdG9yLnByb3RvdHlwZSk7XG5cbiAgLy8gTm90ZSB0aGF0IHNpbXBsZSBhc3luYyBmdW5jdGlvbnMgYXJlIGltcGxlbWVudGVkIG9uIHRvcCBvZlxuICAvLyBBc3luY0l0ZXJhdG9yIG9iamVjdHM7IHRoZXkganVzdCByZXR1cm4gYSBQcm9taXNlIGZvciB0aGUgdmFsdWUgb2ZcbiAgLy8gdGhlIGZpbmFsIHJlc3VsdCBwcm9kdWNlZCBieSB0aGUgaXRlcmF0b3IuXG4gIHJ1bnRpbWUuYXN5bmMgPSBmdW5jdGlvbihpbm5lckZuLCBvdXRlckZuLCBzZWxmLCB0cnlMb2NzTGlzdCkge1xuICAgIHZhciBpdGVyID0gbmV3IEFzeW5jSXRlcmF0b3IoXG4gICAgICB3cmFwKGlubmVyRm4sIG91dGVyRm4sIHNlbGYsIHRyeUxvY3NMaXN0KVxuICAgICk7XG5cbiAgICByZXR1cm4gcnVudGltZS5pc0dlbmVyYXRvckZ1bmN0aW9uKG91dGVyRm4pXG4gICAgICA/IGl0ZXIgLy8gSWYgb3V0ZXJGbiBpcyBhIGdlbmVyYXRvciwgcmV0dXJuIHRoZSBmdWxsIGl0ZXJhdG9yLlxuICAgICAgOiBpdGVyLm5leHQoKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgIHJldHVybiByZXN1bHQuZG9uZSA/IHJlc3VsdC52YWx1ZSA6IGl0ZXIubmV4dCgpO1xuICAgICAgICB9KTtcbiAgfTtcblxuICBmdW5jdGlvbiBtYWtlSW52b2tlTWV0aG9kKGlubmVyRm4sIHNlbGYsIGNvbnRleHQpIHtcbiAgICB2YXIgc3RhdGUgPSBHZW5TdGF0ZVN1c3BlbmRlZFN0YXJ0O1xuXG4gICAgcmV0dXJuIGZ1bmN0aW9uIGludm9rZShtZXRob2QsIGFyZykge1xuICAgICAgaWYgKHN0YXRlID09PSBHZW5TdGF0ZUV4ZWN1dGluZykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJHZW5lcmF0b3IgaXMgYWxyZWFkeSBydW5uaW5nXCIpO1xuICAgICAgfVxuXG4gICAgICBpZiAoc3RhdGUgPT09IEdlblN0YXRlQ29tcGxldGVkKSB7XG4gICAgICAgIGlmIChtZXRob2QgPT09IFwidGhyb3dcIikge1xuICAgICAgICAgIHRocm93IGFyZztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEJlIGZvcmdpdmluZywgcGVyIDI1LjMuMy4zLjMgb2YgdGhlIHNwZWM6XG4gICAgICAgIC8vIGh0dHBzOi8vcGVvcGxlLm1vemlsbGEub3JnL35qb3JlbmRvcmZmL2VzNi1kcmFmdC5odG1sI3NlYy1nZW5lcmF0b3JyZXN1bWVcbiAgICAgICAgcmV0dXJuIGRvbmVSZXN1bHQoKTtcbiAgICAgIH1cblxuICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgdmFyIGRlbGVnYXRlID0gY29udGV4dC5kZWxlZ2F0ZTtcbiAgICAgICAgaWYgKGRlbGVnYXRlKSB7XG4gICAgICAgICAgaWYgKG1ldGhvZCA9PT0gXCJyZXR1cm5cIiB8fFxuICAgICAgICAgICAgICAobWV0aG9kID09PSBcInRocm93XCIgJiYgZGVsZWdhdGUuaXRlcmF0b3JbbWV0aG9kXSA9PT0gdW5kZWZpbmVkKSkge1xuICAgICAgICAgICAgLy8gQSByZXR1cm4gb3IgdGhyb3cgKHdoZW4gdGhlIGRlbGVnYXRlIGl0ZXJhdG9yIGhhcyBubyB0aHJvd1xuICAgICAgICAgICAgLy8gbWV0aG9kKSBhbHdheXMgdGVybWluYXRlcyB0aGUgeWllbGQqIGxvb3AuXG4gICAgICAgICAgICBjb250ZXh0LmRlbGVnYXRlID0gbnVsbDtcblxuICAgICAgICAgICAgLy8gSWYgdGhlIGRlbGVnYXRlIGl0ZXJhdG9yIGhhcyBhIHJldHVybiBtZXRob2QsIGdpdmUgaXQgYVxuICAgICAgICAgICAgLy8gY2hhbmNlIHRvIGNsZWFuIHVwLlxuICAgICAgICAgICAgdmFyIHJldHVybk1ldGhvZCA9IGRlbGVnYXRlLml0ZXJhdG9yW1wicmV0dXJuXCJdO1xuICAgICAgICAgICAgaWYgKHJldHVybk1ldGhvZCkge1xuICAgICAgICAgICAgICB2YXIgcmVjb3JkID0gdHJ5Q2F0Y2gocmV0dXJuTWV0aG9kLCBkZWxlZ2F0ZS5pdGVyYXRvciwgYXJnKTtcbiAgICAgICAgICAgICAgaWYgKHJlY29yZC50eXBlID09PSBcInRocm93XCIpIHtcbiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgcmV0dXJuIG1ldGhvZCB0aHJldyBhbiBleGNlcHRpb24sIGxldCB0aGF0XG4gICAgICAgICAgICAgICAgLy8gZXhjZXB0aW9uIHByZXZhaWwgb3ZlciB0aGUgb3JpZ2luYWwgcmV0dXJuIG9yIHRocm93LlxuICAgICAgICAgICAgICAgIG1ldGhvZCA9IFwidGhyb3dcIjtcbiAgICAgICAgICAgICAgICBhcmcgPSByZWNvcmQuYXJnO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChtZXRob2QgPT09IFwicmV0dXJuXCIpIHtcbiAgICAgICAgICAgICAgLy8gQ29udGludWUgd2l0aCB0aGUgb3V0ZXIgcmV0dXJuLCBub3cgdGhhdCB0aGUgZGVsZWdhdGVcbiAgICAgICAgICAgICAgLy8gaXRlcmF0b3IgaGFzIGJlZW4gdGVybWluYXRlZC5cbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFyIHJlY29yZCA9IHRyeUNhdGNoKFxuICAgICAgICAgICAgZGVsZWdhdGUuaXRlcmF0b3JbbWV0aG9kXSxcbiAgICAgICAgICAgIGRlbGVnYXRlLml0ZXJhdG9yLFxuICAgICAgICAgICAgYXJnXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGlmIChyZWNvcmQudHlwZSA9PT0gXCJ0aHJvd1wiKSB7XG4gICAgICAgICAgICBjb250ZXh0LmRlbGVnYXRlID0gbnVsbDtcblxuICAgICAgICAgICAgLy8gTGlrZSByZXR1cm5pbmcgZ2VuZXJhdG9yLnRocm93KHVuY2F1Z2h0KSwgYnV0IHdpdGhvdXQgdGhlXG4gICAgICAgICAgICAvLyBvdmVyaGVhZCBvZiBhbiBleHRyYSBmdW5jdGlvbiBjYWxsLlxuICAgICAgICAgICAgbWV0aG9kID0gXCJ0aHJvd1wiO1xuICAgICAgICAgICAgYXJnID0gcmVjb3JkLmFyZztcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIERlbGVnYXRlIGdlbmVyYXRvciByYW4gYW5kIGhhbmRsZWQgaXRzIG93biBleGNlcHRpb25zIHNvXG4gICAgICAgICAgLy8gcmVnYXJkbGVzcyBvZiB3aGF0IHRoZSBtZXRob2Qgd2FzLCB3ZSBjb250aW51ZSBhcyBpZiBpdCBpc1xuICAgICAgICAgIC8vIFwibmV4dFwiIHdpdGggYW4gdW5kZWZpbmVkIGFyZy5cbiAgICAgICAgICBtZXRob2QgPSBcIm5leHRcIjtcbiAgICAgICAgICBhcmcgPSB1bmRlZmluZWQ7XG5cbiAgICAgICAgICB2YXIgaW5mbyA9IHJlY29yZC5hcmc7XG4gICAgICAgICAgaWYgKGluZm8uZG9uZSkge1xuICAgICAgICAgICAgY29udGV4dFtkZWxlZ2F0ZS5yZXN1bHROYW1lXSA9IGluZm8udmFsdWU7XG4gICAgICAgICAgICBjb250ZXh0Lm5leHQgPSBkZWxlZ2F0ZS5uZXh0TG9jO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdGF0ZSA9IEdlblN0YXRlU3VzcGVuZGVkWWllbGQ7XG4gICAgICAgICAgICByZXR1cm4gaW5mbztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb250ZXh0LmRlbGVnYXRlID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtZXRob2QgPT09IFwibmV4dFwiKSB7XG4gICAgICAgICAgY29udGV4dC5fc2VudCA9IGFyZztcblxuICAgICAgICAgIGlmIChzdGF0ZSA9PT0gR2VuU3RhdGVTdXNwZW5kZWRZaWVsZCkge1xuICAgICAgICAgICAgY29udGV4dC5zZW50ID0gYXJnO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb250ZXh0LnNlbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gXCJ0aHJvd1wiKSB7XG4gICAgICAgICAgaWYgKHN0YXRlID09PSBHZW5TdGF0ZVN1c3BlbmRlZFN0YXJ0KSB7XG4gICAgICAgICAgICBzdGF0ZSA9IEdlblN0YXRlQ29tcGxldGVkO1xuICAgICAgICAgICAgdGhyb3cgYXJnO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChjb250ZXh0LmRpc3BhdGNoRXhjZXB0aW9uKGFyZykpIHtcbiAgICAgICAgICAgIC8vIElmIHRoZSBkaXNwYXRjaGVkIGV4Y2VwdGlvbiB3YXMgY2F1Z2h0IGJ5IGEgY2F0Y2ggYmxvY2ssXG4gICAgICAgICAgICAvLyB0aGVuIGxldCB0aGF0IGNhdGNoIGJsb2NrIGhhbmRsZSB0aGUgZXhjZXB0aW9uIG5vcm1hbGx5LlxuICAgICAgICAgICAgbWV0aG9kID0gXCJuZXh0XCI7XG4gICAgICAgICAgICBhcmcgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuXG4gICAgICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSBcInJldHVyblwiKSB7XG4gICAgICAgICAgY29udGV4dC5hYnJ1cHQoXCJyZXR1cm5cIiwgYXJnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN0YXRlID0gR2VuU3RhdGVFeGVjdXRpbmc7XG5cbiAgICAgICAgdmFyIHJlY29yZCA9IHRyeUNhdGNoKGlubmVyRm4sIHNlbGYsIGNvbnRleHQpO1xuICAgICAgICBpZiAocmVjb3JkLnR5cGUgPT09IFwibm9ybWFsXCIpIHtcbiAgICAgICAgICAvLyBJZiBhbiBleGNlcHRpb24gaXMgdGhyb3duIGZyb20gaW5uZXJGbiwgd2UgbGVhdmUgc3RhdGUgPT09XG4gICAgICAgICAgLy8gR2VuU3RhdGVFeGVjdXRpbmcgYW5kIGxvb3AgYmFjayBmb3IgYW5vdGhlciBpbnZvY2F0aW9uLlxuICAgICAgICAgIHN0YXRlID0gY29udGV4dC5kb25lXG4gICAgICAgICAgICA/IEdlblN0YXRlQ29tcGxldGVkXG4gICAgICAgICAgICA6IEdlblN0YXRlU3VzcGVuZGVkWWllbGQ7XG5cbiAgICAgICAgICB2YXIgaW5mbyA9IHtcbiAgICAgICAgICAgIHZhbHVlOiByZWNvcmQuYXJnLFxuICAgICAgICAgICAgZG9uZTogY29udGV4dC5kb25lXG4gICAgICAgICAgfTtcblxuICAgICAgICAgIGlmIChyZWNvcmQuYXJnID09PSBDb250aW51ZVNlbnRpbmVsKSB7XG4gICAgICAgICAgICBpZiAoY29udGV4dC5kZWxlZ2F0ZSAmJiBtZXRob2QgPT09IFwibmV4dFwiKSB7XG4gICAgICAgICAgICAgIC8vIERlbGliZXJhdGVseSBmb3JnZXQgdGhlIGxhc3Qgc2VudCB2YWx1ZSBzbyB0aGF0IHdlIGRvbid0XG4gICAgICAgICAgICAgIC8vIGFjY2lkZW50YWxseSBwYXNzIGl0IG9uIHRvIHRoZSBkZWxlZ2F0ZS5cbiAgICAgICAgICAgICAgYXJnID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gaW5mbztcbiAgICAgICAgICB9XG5cbiAgICAgICAgfSBlbHNlIGlmIChyZWNvcmQudHlwZSA9PT0gXCJ0aHJvd1wiKSB7XG4gICAgICAgICAgc3RhdGUgPSBHZW5TdGF0ZUNvbXBsZXRlZDtcbiAgICAgICAgICAvLyBEaXNwYXRjaCB0aGUgZXhjZXB0aW9uIGJ5IGxvb3BpbmcgYmFjayBhcm91bmQgdG8gdGhlXG4gICAgICAgICAgLy8gY29udGV4dC5kaXNwYXRjaEV4Y2VwdGlvbihhcmcpIGNhbGwgYWJvdmUuXG4gICAgICAgICAgbWV0aG9kID0gXCJ0aHJvd1wiO1xuICAgICAgICAgIGFyZyA9IHJlY29yZC5hcmc7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgLy8gRGVmaW5lIEdlbmVyYXRvci5wcm90b3R5cGUue25leHQsdGhyb3cscmV0dXJufSBpbiB0ZXJtcyBvZiB0aGVcbiAgLy8gdW5pZmllZCAuX2ludm9rZSBoZWxwZXIgbWV0aG9kLlxuICBkZWZpbmVJdGVyYXRvck1ldGhvZHMoR3ApO1xuXG4gIEdwW2l0ZXJhdG9yU3ltYm9sXSA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIEdwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIFwiW29iamVjdCBHZW5lcmF0b3JdXCI7XG4gIH07XG5cbiAgZnVuY3Rpb24gcHVzaFRyeUVudHJ5KGxvY3MpIHtcbiAgICB2YXIgZW50cnkgPSB7IHRyeUxvYzogbG9jc1swXSB9O1xuXG4gICAgaWYgKDEgaW4gbG9jcykge1xuICAgICAgZW50cnkuY2F0Y2hMb2MgPSBsb2NzWzFdO1xuICAgIH1cblxuICAgIGlmICgyIGluIGxvY3MpIHtcbiAgICAgIGVudHJ5LmZpbmFsbHlMb2MgPSBsb2NzWzJdO1xuICAgICAgZW50cnkuYWZ0ZXJMb2MgPSBsb2NzWzNdO1xuICAgIH1cblxuICAgIHRoaXMudHJ5RW50cmllcy5wdXNoKGVudHJ5KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHJlc2V0VHJ5RW50cnkoZW50cnkpIHtcbiAgICB2YXIgcmVjb3JkID0gZW50cnkuY29tcGxldGlvbiB8fCB7fTtcbiAgICByZWNvcmQudHlwZSA9IFwibm9ybWFsXCI7XG4gICAgZGVsZXRlIHJlY29yZC5hcmc7XG4gICAgZW50cnkuY29tcGxldGlvbiA9IHJlY29yZDtcbiAgfVxuXG4gIGZ1bmN0aW9uIENvbnRleHQodHJ5TG9jc0xpc3QpIHtcbiAgICAvLyBUaGUgcm9vdCBlbnRyeSBvYmplY3QgKGVmZmVjdGl2ZWx5IGEgdHJ5IHN0YXRlbWVudCB3aXRob3V0IGEgY2F0Y2hcbiAgICAvLyBvciBhIGZpbmFsbHkgYmxvY2spIGdpdmVzIHVzIGEgcGxhY2UgdG8gc3RvcmUgdmFsdWVzIHRocm93biBmcm9tXG4gICAgLy8gbG9jYXRpb25zIHdoZXJlIHRoZXJlIGlzIG5vIGVuY2xvc2luZyB0cnkgc3RhdGVtZW50LlxuICAgIHRoaXMudHJ5RW50cmllcyA9IFt7IHRyeUxvYzogXCJyb290XCIgfV07XG4gICAgdHJ5TG9jc0xpc3QuZm9yRWFjaChwdXNoVHJ5RW50cnksIHRoaXMpO1xuICAgIHRoaXMucmVzZXQodHJ1ZSk7XG4gIH1cblxuICBydW50aW1lLmtleXMgPSBmdW5jdGlvbihvYmplY3QpIHtcbiAgICB2YXIga2V5cyA9IFtdO1xuICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHtcbiAgICAgIGtleXMucHVzaChrZXkpO1xuICAgIH1cbiAgICBrZXlzLnJldmVyc2UoKTtcblxuICAgIC8vIFJhdGhlciB0aGFuIHJldHVybmluZyBhbiBvYmplY3Qgd2l0aCBhIG5leHQgbWV0aG9kLCB3ZSBrZWVwXG4gICAgLy8gdGhpbmdzIHNpbXBsZSBhbmQgcmV0dXJuIHRoZSBuZXh0IGZ1bmN0aW9uIGl0c2VsZi5cbiAgICByZXR1cm4gZnVuY3Rpb24gbmV4dCgpIHtcbiAgICAgIHdoaWxlIChrZXlzLmxlbmd0aCkge1xuICAgICAgICB2YXIga2V5ID0ga2V5cy5wb3AoKTtcbiAgICAgICAgaWYgKGtleSBpbiBvYmplY3QpIHtcbiAgICAgICAgICBuZXh0LnZhbHVlID0ga2V5O1xuICAgICAgICAgIG5leHQuZG9uZSA9IGZhbHNlO1xuICAgICAgICAgIHJldHVybiBuZXh0O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFRvIGF2b2lkIGNyZWF0aW5nIGFuIGFkZGl0aW9uYWwgb2JqZWN0LCB3ZSBqdXN0IGhhbmcgdGhlIC52YWx1ZVxuICAgICAgLy8gYW5kIC5kb25lIHByb3BlcnRpZXMgb2ZmIHRoZSBuZXh0IGZ1bmN0aW9uIG9iamVjdCBpdHNlbGYuIFRoaXNcbiAgICAgIC8vIGFsc28gZW5zdXJlcyB0aGF0IHRoZSBtaW5pZmllciB3aWxsIG5vdCBhbm9ueW1pemUgdGhlIGZ1bmN0aW9uLlxuICAgICAgbmV4dC5kb25lID0gdHJ1ZTtcbiAgICAgIHJldHVybiBuZXh0O1xuICAgIH07XG4gIH07XG5cbiAgZnVuY3Rpb24gdmFsdWVzKGl0ZXJhYmxlKSB7XG4gICAgaWYgKGl0ZXJhYmxlKSB7XG4gICAgICB2YXIgaXRlcmF0b3JNZXRob2QgPSBpdGVyYWJsZVtpdGVyYXRvclN5bWJvbF07XG4gICAgICBpZiAoaXRlcmF0b3JNZXRob2QpIHtcbiAgICAgICAgcmV0dXJuIGl0ZXJhdG9yTWV0aG9kLmNhbGwoaXRlcmFibGUpO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZW9mIGl0ZXJhYmxlLm5leHQgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICByZXR1cm4gaXRlcmFibGU7XG4gICAgICB9XG5cbiAgICAgIGlmICghaXNOYU4oaXRlcmFibGUubGVuZ3RoKSkge1xuICAgICAgICB2YXIgaSA9IC0xLCBuZXh0ID0gZnVuY3Rpb24gbmV4dCgpIHtcbiAgICAgICAgICB3aGlsZSAoKytpIDwgaXRlcmFibGUubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwoaXRlcmFibGUsIGkpKSB7XG4gICAgICAgICAgICAgIG5leHQudmFsdWUgPSBpdGVyYWJsZVtpXTtcbiAgICAgICAgICAgICAgbmV4dC5kb25lID0gZmFsc2U7XG4gICAgICAgICAgICAgIHJldHVybiBuZXh0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIG5leHQudmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgbmV4dC5kb25lID0gdHJ1ZTtcblxuICAgICAgICAgIHJldHVybiBuZXh0O1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBuZXh0Lm5leHQgPSBuZXh0O1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFJldHVybiBhbiBpdGVyYXRvciB3aXRoIG5vIHZhbHVlcy5cbiAgICByZXR1cm4geyBuZXh0OiBkb25lUmVzdWx0IH07XG4gIH1cbiAgcnVudGltZS52YWx1ZXMgPSB2YWx1ZXM7XG5cbiAgZnVuY3Rpb24gZG9uZVJlc3VsdCgpIHtcbiAgICByZXR1cm4geyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH07XG4gIH1cblxuICBDb250ZXh0LnByb3RvdHlwZSA9IHtcbiAgICBjb25zdHJ1Y3RvcjogQ29udGV4dCxcblxuICAgIHJlc2V0OiBmdW5jdGlvbihza2lwVGVtcFJlc2V0KSB7XG4gICAgICB0aGlzLnByZXYgPSAwO1xuICAgICAgdGhpcy5uZXh0ID0gMDtcbiAgICAgIHRoaXMuc2VudCA9IHVuZGVmaW5lZDtcbiAgICAgIHRoaXMuZG9uZSA9IGZhbHNlO1xuICAgICAgdGhpcy5kZWxlZ2F0ZSA9IG51bGw7XG5cbiAgICAgIHRoaXMudHJ5RW50cmllcy5mb3JFYWNoKHJlc2V0VHJ5RW50cnkpO1xuXG4gICAgICBpZiAoIXNraXBUZW1wUmVzZXQpIHtcbiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiB0aGlzKSB7XG4gICAgICAgICAgLy8gTm90IHN1cmUgYWJvdXQgdGhlIG9wdGltYWwgb3JkZXIgb2YgdGhlc2UgY29uZGl0aW9uczpcbiAgICAgICAgICBpZiAobmFtZS5jaGFyQXQoMCkgPT09IFwidFwiICYmXG4gICAgICAgICAgICAgIGhhc093bi5jYWxsKHRoaXMsIG5hbWUpICYmXG4gICAgICAgICAgICAgICFpc05hTigrbmFtZS5zbGljZSgxKSkpIHtcbiAgICAgICAgICAgIHRoaXNbbmFtZV0gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSxcblxuICAgIHN0b3A6IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5kb25lID0gdHJ1ZTtcblxuICAgICAgdmFyIHJvb3RFbnRyeSA9IHRoaXMudHJ5RW50cmllc1swXTtcbiAgICAgIHZhciByb290UmVjb3JkID0gcm9vdEVudHJ5LmNvbXBsZXRpb247XG4gICAgICBpZiAocm9vdFJlY29yZC50eXBlID09PSBcInRocm93XCIpIHtcbiAgICAgICAgdGhyb3cgcm9vdFJlY29yZC5hcmc7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLnJ2YWw7XG4gICAgfSxcblxuICAgIGRpc3BhdGNoRXhjZXB0aW9uOiBmdW5jdGlvbihleGNlcHRpb24pIHtcbiAgICAgIGlmICh0aGlzLmRvbmUpIHtcbiAgICAgICAgdGhyb3cgZXhjZXB0aW9uO1xuICAgICAgfVxuXG4gICAgICB2YXIgY29udGV4dCA9IHRoaXM7XG4gICAgICBmdW5jdGlvbiBoYW5kbGUobG9jLCBjYXVnaHQpIHtcbiAgICAgICAgcmVjb3JkLnR5cGUgPSBcInRocm93XCI7XG4gICAgICAgIHJlY29yZC5hcmcgPSBleGNlcHRpb247XG4gICAgICAgIGNvbnRleHQubmV4dCA9IGxvYztcbiAgICAgICAgcmV0dXJuICEhY2F1Z2h0O1xuICAgICAgfVxuXG4gICAgICBmb3IgKHZhciBpID0gdGhpcy50cnlFbnRyaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7XG4gICAgICAgIHZhciBlbnRyeSA9IHRoaXMudHJ5RW50cmllc1tpXTtcbiAgICAgICAgdmFyIHJlY29yZCA9IGVudHJ5LmNvbXBsZXRpb247XG5cbiAgICAgICAgaWYgKGVudHJ5LnRyeUxvYyA9PT0gXCJyb290XCIpIHtcbiAgICAgICAgICAvLyBFeGNlcHRpb24gdGhyb3duIG91dHNpZGUgb2YgYW55IHRyeSBibG9jayB0aGF0IGNvdWxkIGhhbmRsZVxuICAgICAgICAgIC8vIGl0LCBzbyBzZXQgdGhlIGNvbXBsZXRpb24gdmFsdWUgb2YgdGhlIGVudGlyZSBmdW5jdGlvbiB0b1xuICAgICAgICAgIC8vIHRocm93IHRoZSBleGNlcHRpb24uXG4gICAgICAgICAgcmV0dXJuIGhhbmRsZShcImVuZFwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlbnRyeS50cnlMb2MgPD0gdGhpcy5wcmV2KSB7XG4gICAgICAgICAgdmFyIGhhc0NhdGNoID0gaGFzT3duLmNhbGwoZW50cnksIFwiY2F0Y2hMb2NcIik7XG4gICAgICAgICAgdmFyIGhhc0ZpbmFsbHkgPSBoYXNPd24uY2FsbChlbnRyeSwgXCJmaW5hbGx5TG9jXCIpO1xuXG4gICAgICAgICAgaWYgKGhhc0NhdGNoICYmIGhhc0ZpbmFsbHkpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnByZXYgPCBlbnRyeS5jYXRjaExvYykge1xuICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlKGVudHJ5LmNhdGNoTG9jLCB0cnVlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5wcmV2IDwgZW50cnkuZmluYWxseUxvYykge1xuICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlKGVudHJ5LmZpbmFsbHlMb2MpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgfSBlbHNlIGlmIChoYXNDYXRjaCkge1xuICAgICAgICAgICAgaWYgKHRoaXMucHJldiA8IGVudHJ5LmNhdGNoTG9jKSB7XG4gICAgICAgICAgICAgIHJldHVybiBoYW5kbGUoZW50cnkuY2F0Y2hMb2MsIHRydWUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgfSBlbHNlIGlmIChoYXNGaW5hbGx5KSB7XG4gICAgICAgICAgICBpZiAodGhpcy5wcmV2IDwgZW50cnkuZmluYWxseUxvYykge1xuICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlKGVudHJ5LmZpbmFsbHlMb2MpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInRyeSBzdGF0ZW1lbnQgd2l0aG91dCBjYXRjaCBvciBmaW5hbGx5XCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG5cbiAgICBhYnJ1cHQ6IGZ1bmN0aW9uKHR5cGUsIGFyZykge1xuICAgICAgZm9yICh2YXIgaSA9IHRoaXMudHJ5RW50cmllcy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkge1xuICAgICAgICB2YXIgZW50cnkgPSB0aGlzLnRyeUVudHJpZXNbaV07XG4gICAgICAgIGlmIChlbnRyeS50cnlMb2MgPD0gdGhpcy5wcmV2ICYmXG4gICAgICAgICAgICBoYXNPd24uY2FsbChlbnRyeSwgXCJmaW5hbGx5TG9jXCIpICYmXG4gICAgICAgICAgICB0aGlzLnByZXYgPCBlbnRyeS5maW5hbGx5TG9jKSB7XG4gICAgICAgICAgdmFyIGZpbmFsbHlFbnRyeSA9IGVudHJ5O1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChmaW5hbGx5RW50cnkgJiZcbiAgICAgICAgICAodHlwZSA9PT0gXCJicmVha1wiIHx8XG4gICAgICAgICAgIHR5cGUgPT09IFwiY29udGludWVcIikgJiZcbiAgICAgICAgICBmaW5hbGx5RW50cnkudHJ5TG9jIDw9IGFyZyAmJlxuICAgICAgICAgIGFyZyA8PSBmaW5hbGx5RW50cnkuZmluYWxseUxvYykge1xuICAgICAgICAvLyBJZ25vcmUgdGhlIGZpbmFsbHkgZW50cnkgaWYgY29udHJvbCBpcyBub3QganVtcGluZyB0byBhXG4gICAgICAgIC8vIGxvY2F0aW9uIG91dHNpZGUgdGhlIHRyeS9jYXRjaCBibG9jay5cbiAgICAgICAgZmluYWxseUVudHJ5ID0gbnVsbDtcbiAgICAgIH1cblxuICAgICAgdmFyIHJlY29yZCA9IGZpbmFsbHlFbnRyeSA/IGZpbmFsbHlFbnRyeS5jb21wbGV0aW9uIDoge307XG4gICAgICByZWNvcmQudHlwZSA9IHR5cGU7XG4gICAgICByZWNvcmQuYXJnID0gYXJnO1xuXG4gICAgICBpZiAoZmluYWxseUVudHJ5KSB7XG4gICAgICAgIHRoaXMubmV4dCA9IGZpbmFsbHlFbnRyeS5maW5hbGx5TG9jO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5jb21wbGV0ZShyZWNvcmQpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gQ29udGludWVTZW50aW5lbDtcbiAgICB9LFxuXG4gICAgY29tcGxldGU6IGZ1bmN0aW9uKHJlY29yZCwgYWZ0ZXJMb2MpIHtcbiAgICAgIGlmIChyZWNvcmQudHlwZSA9PT0gXCJ0aHJvd1wiKSB7XG4gICAgICAgIHRocm93IHJlY29yZC5hcmc7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZWNvcmQudHlwZSA9PT0gXCJicmVha1wiIHx8XG4gICAgICAgICAgcmVjb3JkLnR5cGUgPT09IFwiY29udGludWVcIikge1xuICAgICAgICB0aGlzLm5leHQgPSByZWNvcmQuYXJnO1xuICAgICAgfSBlbHNlIGlmIChyZWNvcmQudHlwZSA9PT0gXCJyZXR1cm5cIikge1xuICAgICAgICB0aGlzLnJ2YWwgPSByZWNvcmQuYXJnO1xuICAgICAgICB0aGlzLm5leHQgPSBcImVuZFwiO1xuICAgICAgfSBlbHNlIGlmIChyZWNvcmQudHlwZSA9PT0gXCJub3JtYWxcIiAmJiBhZnRlckxvYykge1xuICAgICAgICB0aGlzLm5leHQgPSBhZnRlckxvYztcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgZmluaXNoOiBmdW5jdGlvbihmaW5hbGx5TG9jKSB7XG4gICAgICBmb3IgKHZhciBpID0gdGhpcy50cnlFbnRyaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7XG4gICAgICAgIHZhciBlbnRyeSA9IHRoaXMudHJ5RW50cmllc1tpXTtcbiAgICAgICAgaWYgKGVudHJ5LmZpbmFsbHlMb2MgPT09IGZpbmFsbHlMb2MpIHtcbiAgICAgICAgICB0aGlzLmNvbXBsZXRlKGVudHJ5LmNvbXBsZXRpb24sIGVudHJ5LmFmdGVyTG9jKTtcbiAgICAgICAgICByZXNldFRyeUVudHJ5KGVudHJ5KTtcbiAgICAgICAgICByZXR1cm4gQ29udGludWVTZW50aW5lbDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG5cbiAgICBcImNhdGNoXCI6IGZ1bmN0aW9uKHRyeUxvYykge1xuICAgICAgZm9yICh2YXIgaSA9IHRoaXMudHJ5RW50cmllcy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkge1xuICAgICAgICB2YXIgZW50cnkgPSB0aGlzLnRyeUVudHJpZXNbaV07XG4gICAgICAgIGlmIChlbnRyeS50cnlMb2MgPT09IHRyeUxvYykge1xuICAgICAgICAgIHZhciByZWNvcmQgPSBlbnRyeS5jb21wbGV0aW9uO1xuICAgICAgICAgIGlmIChyZWNvcmQudHlwZSA9PT0gXCJ0aHJvd1wiKSB7XG4gICAgICAgICAgICB2YXIgdGhyb3duID0gcmVjb3JkLmFyZztcbiAgICAgICAgICAgIHJlc2V0VHJ5RW50cnkoZW50cnkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdGhyb3duO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFRoZSBjb250ZXh0LmNhdGNoIG1ldGhvZCBtdXN0IG9ubHkgYmUgY2FsbGVkIHdpdGggYSBsb2NhdGlvblxuICAgICAgLy8gYXJndW1lbnQgdGhhdCBjb3JyZXNwb25kcyB0byBhIGtub3duIGNhdGNoIGJsb2NrLlxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaWxsZWdhbCBjYXRjaCBhdHRlbXB0XCIpO1xuICAgIH0sXG5cbiAgICBkZWxlZ2F0ZVlpZWxkOiBmdW5jdGlvbihpdGVyYWJsZSwgcmVzdWx0TmFtZSwgbmV4dExvYykge1xuICAgICAgdGhpcy5kZWxlZ2F0ZSA9IHtcbiAgICAgICAgaXRlcmF0b3I6IHZhbHVlcyhpdGVyYWJsZSksXG4gICAgICAgIHJlc3VsdE5hbWU6IHJlc3VsdE5hbWUsXG4gICAgICAgIG5leHRMb2M6IG5leHRMb2NcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBDb250aW51ZVNlbnRpbmVsO1xuICAgIH1cbiAgfTtcbn0pKFxuICAvLyBBbW9uZyB0aGUgdmFyaW91cyB0cmlja3MgZm9yIG9idGFpbmluZyBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsXG4gIC8vIG9iamVjdCwgdGhpcyBzZWVtcyB0byBiZSB0aGUgbW9zdCByZWxpYWJsZSB0ZWNobmlxdWUgdGhhdCBkb2VzIG5vdFxuICAvLyB1c2UgaW5kaXJlY3QgZXZhbCAod2hpY2ggdmlvbGF0ZXMgQ29udGVudCBTZWN1cml0eSBQb2xpY3kpLlxuICB0eXBlb2YgZ2xvYmFsID09PSBcIm9iamVjdFwiID8gZ2xvYmFsIDpcbiAgdHlwZW9mIHdpbmRvdyA9PT0gXCJvYmplY3RcIiA/IHdpbmRvdyA6XG4gIHR5cGVvZiBzZWxmID09PSBcIm9iamVjdFwiID8gc2VsZiA6IHRoaXNcbik7XG4iLCIvKlxuICogQ29weXJpZ2h0IChjKSAyMDA5LTIwMTYgRnJhbmsgQmVubmV0dFxuICogXG4gKiBcdFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3JcbiAqIFx0bW9kaWZ5IGl0IHVuZGVyIEVJVEhFUlxuICogXG4gKiAgICAgICAqIHRoZSB0ZXJtcyBvZiB0aGUgQ29tbW9uIFB1YmxpYyBBdHRyaWJ1dGlvbiBMaWNlbnNlIChDUEFMKSBhc1xuICogXHQgICAgcHVibGlzaGVkIGJ5IHRoZSBPcGVuIFNvdXJjZSBJbml0aWF0aXZlLCBlaXRoZXIgdmVyc2lvbiAxIG9mXG4gKiBcdCAgICB0aGUgQ1BBTCwgb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbjsgT1JcbiAqIFxuICogICAgICAgKiB0aGUgdGVybXMgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSAoQUdQTClcbiAqICAgICAgICAgYXMgcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uXG4gKiAgICAgICAgIDMgb2YgdGhlIEFHUEwsIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKiBcbiAqIFx0VGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBcdGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBcdE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUgR05VXG4gKiBcdEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKiBcbiAqIFx0WW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGNvcGllcyBvZiB0aGUgQ29tbW9uIFB1YmxpYyBBdHRyaWJ1dGlvblxuICogICAgIExpY2Vuc2UgYW5kIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aFxuICogICAgIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwczovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzLz4gb3JcbiAqICAgICA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4gcmVzcGVjdGl2ZWx5LlxuICovXG5cbnZhciBDU0wgPSB7XG4gICAgUFJPQ0VTU09SX1ZFUlNJT046IFwiMS4xLjE3OFwiLFxuICAgIENPTkRJVElPTl9MRVZFTF9UT1A6IDEsXG4gICAgQ09ORElUSU9OX0xFVkVMX0JPVFRPTTogMixcbiAgICBQTEFJTl9IWVBIRU5fUkVHRVg6IC8oPzpbXlxcXFxdLXxcXHUyMDEzKS8sXG4gICAgTE9DQVRPUl9MQUJFTFNfUkVHRVhQOiBuZXcgUmVnRXhwKFwiXigoYXJ0fGNofHN1YmNofGNvbHxmaWd8bHxufG5vfG9wfHB8cHB8cGFyYXxzdWJwYXJhfHB0fHJ8c2VjfHN1YnNlY3xzdnxzY2h8dGl0fHZyc3x2b2wpXFxcXC4pXFxcXHMrKC4qKVwiKSxcbiAgICBTVEFUVVRFX1NVQkRJVl9HUk9VUEVEX1JFR0VYOiAvKCg/Ol58ICkoPzphcnR8Ymt8Y2h8c3ViY2h8Y29sfGZpZ3xmb2x8bHxufG5vfG9wfHB8cHB8cGFyYXxzdWJwYXJhfHB0fHJ8c2VjfHN1YnNlY3xzdnxzY2h8dGl0fHZyc3x2b2wpXFwuICopL2csXG4gICAgU1RBVFVURV9TVUJESVZfUExBSU5fUkVHRVg6IC8oPzooPzpefCApKD86YXJ0fGJrfGNofHN1YmNofGNvbHxmaWd8Zm9sfGx8bnxub3xvcHxwfHBwfHBhcmF8c3VicGFyYXxwdHxyfHNlY3xzdWJzZWN8c3Z8c2NofHRpdHx2cnN8dm9sKVxcLiAqKS8sXG4gICAgU1RBVFVURV9TVUJESVZfU1RSSU5HUzoge1xuICAgICAgICBcImFydC5cIjogXCJhcnRpY2xlXCIsXG4gICAgICAgIFwiYmsuXCI6IFwiYm9va1wiLFxuICAgICAgICBcImNoLlwiOiBcImNoYXB0ZXJcIixcbiAgICAgICAgXCJzdWJjaC5cIjogXCJzdWJjaGFwdGVyXCIsXG4gICAgICAgIFwicC5cIjogXCJwYWdlXCIsXG4gICAgICAgIFwicHAuXCI6IFwicGFnZVwiLFxuICAgICAgICBcInBhcmEuXCI6IFwicGFyYWdyYXBoXCIsXG4gICAgICAgIFwic3VicGFyYS5cIjogXCJzdWJwYXJhZ3JhcGhcIixcbiAgICAgICAgXCJwdC5cIjogXCJwYXJ0XCIsXG4gICAgICAgIFwici5cIjogXCJydWxlXCIsXG4gICAgICAgIFwic2VjLlwiOiBcInNlY3Rpb25cIixcbiAgICAgICAgXCJzdWJzZWMuXCI6IFwic3Vic2VjdGlvblwiLFxuICAgICAgICBcInNjaC5cIjogXCJzY2hlZHVsZVwiLFxuICAgICAgICBcInRpdC5cIjogXCJ0aXRsZVwiLFxuICAgICAgICBcImNvbC5cIjogXCJjb2x1bW5cIixcbiAgICAgICAgXCJmaWcuXCI6IFwiZmlndXJlXCIsXG4gICAgICAgIFwiZm9sLlwiOiBcImZvbGlvXCIsXG4gICAgICAgIFwibC5cIjogXCJsaW5lXCIsXG4gICAgICAgIFwibi5cIjogXCJub3RlXCIsXG4gICAgICAgIFwibm8uXCI6IFwiaXNzdWVcIixcbiAgICAgICAgXCJvcC5cIjogXCJvcHVzXCIsXG4gICAgICAgIFwic3YuXCI6IFwic3ViLXZlcmJvXCIsXG4gICAgICAgIFwidnJzLlwiOiBcInZlcnNlXCIsXG4gICAgICAgIFwidm9sLlwiOiBcInZvbHVtZVwiXG4gICAgfSxcbiAgICBTVEFUVVRFX1NVQkRJVl9TVFJJTkdTX1JFVkVSU0U6IHtcbiAgICAgICAgXCJhcnRpY2xlXCI6IFwiYXJ0LlwiLFxuICAgICAgICBcImJvb2tcIjogXCJiay5cIixcbiAgICAgICAgXCJjaGFwdGVyXCI6IFwiY2guXCIsXG4gICAgICAgIFwic3ViY2hhcHRlclwiOiBcInN1YmNoLlwiLFxuICAgICAgICBcInBhZ2VcIjogXCJwLlwiLFxuICAgICAgICBcInBhcmFncmFwaFwiOiBcInBhcmEuXCIsXG4gICAgICAgIFwic3VicGFyYWdyYXBoXCI6IFwic3VicGFyYS5cIixcbiAgICAgICAgXCJwYXJ0XCI6IFwicHQuXCIsXG4gICAgICAgIFwicnVsZVwiOiBcInIuXCIsXG4gICAgICAgIFwic2VjdGlvblwiOiBcInNlYy5cIixcbiAgICAgICAgXCJzdWJzZWN0aW9uXCI6IFwic3Vic2VjLlwiLFxuICAgICAgICBcInNjaGVkdWxlXCI6IFwic2NoLlwiLFxuICAgICAgICBcInRpdGxlXCI6IFwidGl0LlwiLFxuICAgICAgICBcImNvbHVtblwiOiBcImNvbC5cIixcbiAgICAgICAgXCJmaWd1cmVcIjogXCJmaWcuXCIsXG4gICAgICAgIFwiZm9saW9cIjogXCJmb2wuXCIsXG4gICAgICAgIFwibGluZVwiOiBcImwuXCIsXG4gICAgICAgIFwibm90ZVwiOiBcIm4uXCIsXG4gICAgICAgIFwiaXNzdWVcIjogXCJuby5cIixcbiAgICAgICAgXCJvcHVzXCI6IFwib3AuXCIsXG4gICAgICAgIFwic3ViLXZlcmJvXCI6IFwic3YuXCIsXG4gICAgICAgIFwic3ViIHZlcmJvXCI6IFwic3YuXCIsXG4gICAgICAgIFwidmVyc2VcIjogXCJ2cnMuXCIsXG4gICAgICAgIFwidm9sdW1lXCI6IFwidm9sLlwiXG4gICAgfSxcbiAgICBMT0NBVE9SX0xBQkVMU19NQVA6IHtcbiAgICAgICAgXCJhcnRcIjogXCJhcnRpY2xlXCIsXG4gICAgICAgIFwiYmtcIjogXCJib29rXCIsXG4gICAgICAgIFwiY2hcIjogXCJjaGFwdGVyXCIsXG4gICAgICAgIFwic3ViY2hcIjogXCJzdWJjaGFwdGVyXCIsXG4gICAgICAgIFwiY29sXCI6IFwiY29sdW1uXCIsXG4gICAgICAgIFwiZmlnXCI6IFwiZmlndXJlXCIsXG4gICAgICAgIFwiZm9sXCI6IFwiZm9saW9cIixcbiAgICAgICAgXCJsXCI6IFwibGluZVwiLFxuICAgICAgICBcIm5cIjogXCJub3RlXCIsXG4gICAgICAgIFwibm9cIjogXCJpc3N1ZVwiLFxuICAgICAgICBcIm9wXCI6IFwib3B1c1wiLFxuICAgICAgICBcInBcIjogXCJwYWdlXCIsXG4gICAgICAgIFwicHBcIjogXCJwYWdlXCIsXG4gICAgICAgIFwicGFyYVwiOiBcInBhcmFncmFwaFwiLFxuICAgICAgICBcInN1YnBhcmFcIjogXCJzdWJwYXJhZ3JhcGhcIixcbiAgICAgICAgXCJwdFwiOiBcInBhcnRcIixcbiAgICAgICAgXCJyXCI6IFwicnVsZVwiLFxuXHRcdFwic2VjXCI6IFwic2VjdGlvblwiLFxuXHRcdFwic3Vic2VjXCI6IFwic3Vic2VjdGlvblwiLFxuXHRcdFwic3ZcIjogXCJzdWItdmVyYm9cIixcbiAgICAgICAgXCJzY2hcIjogXCJzY2hlZHVsZVwiLFxuICAgICAgICBcInRpdFwiOiBcInRpdGxlXCIsXG4gICAgICAgIFwidnJzXCI6IFwidmVyc2VcIixcbiAgICAgICAgXCJ2b2xcIjogXCJ2b2x1bWVcIlxuICAgIH0sXG4gICAgTU9EVUxFX01BQ1JPUzoge1xuICAgICAgICBcImp1cmlzLXByZXRpdGxlXCI6IHRydWUsXG4gICAgICAgIFwianVyaXMtdGl0bGVcIjogdHJ1ZSxcbiAgICAgICAgXCJqdXJpcy1wcmV0aXRsZS1zaG9ydFwiOiB0cnVlLFxuICAgICAgICBcImp1cmlzLXRpdGxlLXNob3J0XCI6IHRydWUsXG4gICAgICAgIFwianVyaXMtbWFpblwiOiB0cnVlLFxuICAgICAgICBcImp1cmlzLW1haW4tc2hvcnRcIjogdHJ1ZSxcbiAgICAgICAgXCJqdXJpcy10YWlsXCI6IHRydWUsXG4gICAgICAgIFwianVyaXMtdGFpbC1zaG9ydFwiOiB0cnVlLFxuICAgICAgICBcImp1cmlzLWxvY2F0b3JcIjogdHJ1ZVxuICAgIH0sXG4gICAgTU9EVUxFX1RZUEVTOiB7XG4gICAgICAgIFwibGVnYWxfY2FzZVwiOiB0cnVlLFxuICAgICAgICBcImxlZ2lzbGF0aW9uXCI6IHRydWUsXG4gICAgICAgIFwiYmlsbFwiOiB0cnVlLFxuICAgICAgICBcImhlYXJpbmdcIjogdHJ1ZSxcbiAgICAgICAgXCJnYXpldHRlXCI6IHRydWUsXG4gICAgICAgIFwicmVwb3J0XCI6IHRydWUsXG4gICAgICAgIFwicmVndWxhdGlvblwiOiB0cnVlLFxuICAgICAgICBcInN0YW5kYXJkXCI6IHRydWVcbiAgICB9LFxuICAgIE5lc3RlZEJyYWNlczogW1xuICAgICAgICBbXCIoXCIsIFwiW1wiXSxcbiAgICAgICAgW1wiKVwiLCBcIl1cIl1cbiAgICBdLFxuICAgIGNoZWNrTmVzdGVkQnJhY2U6IGZ1bmN0aW9uKHN0YXRlKSB7XG4gICAgICAgIGlmIChzdGF0ZS5vcHQueGNsYXNzID09PSBcIm5vdGVcIikge1xuICAgICAgICAgICAgdGhpcy5kZXB0aCA9IDA7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSA9IGZ1bmN0aW9uKHN0cikge1xuICAgICAgICAgICAgICAgIHZhciBzdHIgPSBzdHIgPyBzdHIgOiAnJztcbiAgICAgICAgICAgICAgICB2YXIgbHN0ID0gc3RyLnNwbGl0KC8oW1xcKFxcKV0pLyk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaT0xLGlsZW49bHN0Lmxlbmd0aDtpPGlsZW47aSArPSAyKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsc3RbaV0gPT09ICcoJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKDEgPT09ICh0aGlzLmRlcHRoICUgMikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsc3RbaV0gPSAnWydcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVwdGggKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChsc3RbaV0gPT09ICcpJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKDAgPT09ICh0aGlzLmRlcHRoICUgMikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsc3RbaV0gPSAnXSdcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVwdGggLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgcmV0ID0gbHN0LmpvaW4oXCJcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlID0gZnVuY3Rpb24oc3RyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9LFxuICAgIE1VTFRJX0ZJRUxEUzogW1wiZXZlbnRcIiwgXCJwdWJsaXNoZXJcIiwgXCJwdWJsaXNoZXItcGxhY2VcIiwgXCJldmVudC1wbGFjZVwiLCBcInRpdGxlXCIsIFwiY29udGFpbmVyLXRpdGxlXCIsIFwiY29sbGVjdGlvbi10aXRsZVwiLCBcImF1dGhvcml0eVwiLFwiZ2VucmVcIixcInRpdGxlLXNob3J0XCIsXCJtZWRpdW1cIixcImp1cmlzZGljdGlvblwiLFwiYXJjaGl2ZVwiLFwiYXJjaGl2ZS1wbGFjZVwiXSxcbiAgICBMYW5nUHJlZnNNYXA6IHtcbiAgICAgICAgXCJ0aXRsZVwiOlwidGl0bGVzXCIsXG4gICAgICAgIFwidGl0bGUtc2hvcnRcIjpcInRpdGxlc1wiLFxuICAgICAgICBcImV2ZW50XCI6XCJ0aXRsZXNcIixcbiAgICAgICAgXCJnZW5yZVwiOlwidGl0bGVzXCIsXG4gICAgICAgIFwibWVkaXVtXCI6XCJ0aXRsZXNcIixcbiAgICAgICAgXCJjb250YWluZXItdGl0bGVcIjpcImpvdXJuYWxzXCIsXG4gICAgICAgIFwiY29sbGVjdGlvbi10aXRsZVwiOlwiam91cm5hbHNcIixcbiAgICAgICAgXCJhcmNoaXZlXCI6XCJqb3VybmFsc1wiLFxuICAgICAgICBcInB1Ymxpc2hlclwiOlwicHVibGlzaGVyc1wiLFxuICAgICAgICBcImF1dGhvcml0eVwiOlwicHVibGlzaGVyc1wiLFxuICAgICAgICBcInB1Ymxpc2hlci1wbGFjZVwiOiBcInBsYWNlc1wiLFxuICAgICAgICBcImV2ZW50LXBsYWNlXCI6IFwicGxhY2VzXCIsXG4gICAgICAgIFwiYXJjaGl2ZS1wbGFjZVwiOiBcInBsYWNlc1wiLFxuICAgICAgICBcImp1cmlzZGljdGlvblwiOiBcInBsYWNlc1wiLFxuICAgICAgICBcIm51bWJlclwiOiBcIm51bWJlclwiLFxuICAgICAgICBcImVkaXRpb25cIjpcIm51bWJlclwiLFxuICAgICAgICBcImlzc3VlXCI6XCJudW1iZXJcIixcbiAgICAgICAgXCJ2b2x1bWVcIjpcIm51bWJlclwiXG4gICAgfSxcbiAgICBBYmJyZXZpYXRpb25TZWdtZW50czogZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzW1wiY29udGFpbmVyLXRpdGxlXCJdID0ge307XG4gICAgICAgIHRoaXNbXCJjb2xsZWN0aW9uLXRpdGxlXCJdID0ge307XG4gICAgICAgIHRoaXNbXCJpbnN0aXR1dGlvbi1lbnRpcmVcIl0gPSB7fTtcbiAgICAgICAgdGhpc1tcImluc3RpdHV0aW9uLXBhcnRcIl0gPSB7fTtcbiAgICAgICAgdGhpcy5uaWNrbmFtZSA9IHt9O1xuICAgICAgICB0aGlzLm51bWJlciA9IHt9O1xuICAgICAgICB0aGlzLnRpdGxlID0ge307XG4gICAgICAgIHRoaXMucGxhY2UgPSB7fTtcbiAgICAgICAgdGhpcy5oZXJlaW5hZnRlciA9IHt9O1xuICAgICAgICB0aGlzLmNsYXNzaWMgPSB7fTtcbiAgICAgICAgdGhpc1tcImNvbnRhaW5lci1waHJhc2VcIl0gPSB7fTtcbiAgICAgICAgdGhpc1tcInRpdGxlLXBocmFzZVwiXSA9IHt9O1xuICAgIH0sXG4gICAgRklFTERfQ0FURUdPUllfUkVNQVA6IHtcbiAgICAgICAgXCJ0aXRsZVwiOiBcInRpdGxlXCIsXG4gICAgICAgIFwiY29udGFpbmVyLXRpdGxlXCI6IFwiY29udGFpbmVyLXRpdGxlXCIsXG4gICAgICAgIFwiY29sbGVjdGlvbi10aXRsZVwiOiBcImNvbGxlY3Rpb24tdGl0bGVcIixcbiAgICAgICAgXCJudW1iZXJcIjogXCJudW1iZXJcIixcbiAgICAgICAgXCJwbGFjZVwiOiBcInBsYWNlXCIsXG4gICAgICAgIFwiYXJjaGl2ZVwiOiBcImNvbGxlY3Rpb24tdGl0bGVcIixcbiAgICAgICAgXCJ0aXRsZS1zaG9ydFwiOiBcInRpdGxlXCIsXG4gICAgICAgIFwiZ2VucmVcIjogXCJ0aXRsZVwiLFxuICAgICAgICBcImV2ZW50XCI6IFwidGl0bGVcIixcbiAgICAgICAgXCJtZWRpdW1cIjogXCJ0aXRsZVwiLFxuXHRcdFwiYXJjaGl2ZS1wbGFjZVwiOiBcInBsYWNlXCIsXG5cdFx0XCJwdWJsaXNoZXItcGxhY2VcIjogXCJwbGFjZVwiLFxuXHRcdFwiZXZlbnQtcGxhY2VcIjogXCJwbGFjZVwiLFxuXHRcdFwianVyaXNkaWN0aW9uXCI6IFwicGxhY2VcIixcblx0XHRcImxhbmd1YWdlLW5hbWVcIjogXCJwbGFjZVwiLFxuXHRcdFwibGFuZ3VhZ2UtbmFtZS1vcmlnaW5hbFwiOiBcInBsYWNlXCIsXG4gICAgICAgIFwiY2FsbC1udW1iZXJcIjogXCJudW1iZXJcIixcbiAgICAgICAgXCJjaGFwdGVyLW51bWJlclwiOiBcIm51bWJlclwiLFxuICAgICAgICBcImNvbGxlY3Rpb24tbnVtYmVyXCI6IFwibnVtYmVyXCIsXG4gICAgICAgIFwiZWRpdGlvblwiOiBcIm51bWJlclwiLFxuICAgICAgICBcInBhZ2VcIjogXCJudW1iZXJcIixcbiAgICAgICAgXCJpc3N1ZVwiOiBcIm51bWJlclwiLFxuICAgICAgICBcImxvY2F0b3JcIjogXCJudW1iZXJcIixcbiAgICAgICAgXCJudW1iZXItb2YtcGFnZXNcIjogXCJudW1iZXJcIixcbiAgICAgICAgXCJudW1iZXItb2Ytdm9sdW1lc1wiOiBcIm51bWJlclwiLFxuICAgICAgICBcInZvbHVtZVwiOiBcIm51bWJlclwiLFxuICAgICAgICBcImNpdGF0aW9uLW51bWJlclwiOiBcIm51bWJlclwiLFxuICAgICAgICBcInB1Ymxpc2hlclwiOiBcImluc3RpdHV0aW9uLXBhcnRcIlxuICAgIH0sXG4gICAgcGFyc2VMb2NhdG9yOiBmdW5jdGlvbihpdGVtKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmxvY2F0b3JfZGF0ZV9hbmRfcmV2aXNpb24pIHtcbiAgICAgICAgICAgIGlmIChpdGVtLmxvY2F0b3IpIHtcbiAgICAgICAgICAgICAgICBpdGVtLmxvY2F0b3IgPSBcIlwiICsgaXRlbS5sb2NhdG9yO1xuICAgICAgICAgICAgICAgIHZhciBpZHggPSBpdGVtLmxvY2F0b3IuaW5kZXhPZihcInxcIik7XG4gICAgICAgICAgICAgICAgaWYgKGlkeCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByYXdfbG9jYXRvciA9IGl0ZW0ubG9jYXRvcjtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gcmF3X2xvY2F0b3Iuc2xpY2UoMCwgaWR4KTtcbiAgICAgICAgICAgICAgICAgICAgcmF3X2xvY2F0b3IgPSByYXdfbG9jYXRvci5zbGljZShpZHggKyAxKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG0gPSByYXdfbG9jYXRvci5tYXRjaCgvXihbMC05XXs0fS1bMC05XXsyfS1bMC05XXsyfSkuKi8pO1xuICAgICAgICAgICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVtcImxvY2F0b3ItZGF0ZVwiXSA9IHRoaXMuZnVuLmRhdGVwYXJzZXIucGFyc2VEYXRlVG9PYmplY3QobVsxXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByYXdfbG9jYXRvciA9IHJhd19sb2NhdG9yLnNsaWNlKG1bMV0ubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpdGVtW1wibG9jYXRvci1leHRyYVwiXSA9IHJhd19sb2NhdG9yLnJlcGxhY2UoL15cXHMrLywgXCJcIikucmVwbGFjZSgvXFxzKyQvLCBcIlwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGl0ZW0ubG9jYXRvcikge1xuICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gKFwiXCIgKyBpdGVtLmxvY2F0b3IpLnJlcGxhY2UoL1xccyskLywgJycpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpdGVtO1xuICAgIH0sXG4gICAgbm9ybWFsaXplTG9jYWxlU3RyOiBmdW5jdGlvbihzdHIpIHtcbiAgICAgICAgaWYgKCFzdHIpIHJldHVybjtcbiAgICAgICAgdmFyIGxzdCA9IHN0ci5zcGxpdCgnLScpO1xuICAgICAgICBsc3RbMF0gPSBsc3RbMF0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKGxzdFsxXSkge1xuICAgICAgICAgICAgbHN0WzFdID0gbHN0WzFdLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxzdC5qb2luKFwiLVwiKTtcbiAgICB9LFxuICAgIHBhcnNlTm90ZUZpZWxkSGFja3M6IGZ1bmN0aW9uKEl0ZW0sIHZhbGlkRmllbGRzRm9yVHlwZSwgYWxsb3dEYXRlT3ZlcnJpZGUpIHtcbiAgICAgICAgaWYgKFwic3RyaW5nXCIgIT09IHR5cGVvZiBJdGVtLm5vdGUpIHJldHVybjtcbiAgICAgICAgdmFyIGVsZW1zID0gW107XG4gICAgICAgIHZhciBsaW5lcyA9IEl0ZW0ubm90ZS5zcGxpdCgnXFxuJyk7XG4gICAgICAgIHZhciBsYXN0bGluZSA9IFwiXCI7XG4gICAgICAgIGZvciAodmFyIGk9MCwgaWxlbj1saW5lcy5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgbGluZSA9IGxpbmVzW2ldO1xuICAgICAgICAgICAgdmFyIGVsZW1zID0gW107XG4gICAgICAgICAgICB2YXIgbSA9IGxpbmUubWF0Y2goQ1NMLk5PVEVfRklFTERTX1JFR0VYUCk7XG4gICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgIHZhciBzcGx0ID0gbGluZS5zcGxpdChDU0wuTk9URV9GSUVMRFNfUkVHRVhQKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBqPTAsamxlbj0oc3BsdC5sZW5ndGgtMSk7ajxqbGVuO2orKykge1xuICAgICAgICAgICAgICAgICAgICBlbGVtcy5wdXNoKHNwbHRbal0pO1xuICAgICAgICAgICAgICAgICAgICBlbGVtcy5wdXNoKG1bal0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbGVtcy5wdXNoKHNwbHRbc3BsdC5sZW5ndGgtMV0pXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaj0xLGpsZW49ZWxlbXMubGVuZ3RoO2o8amxlbjtqICs9IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1zW2otMV0udHJpbSgpICYmIChpPjAgfHwgaj4xKSAmJiAhZWxlbXNbai0xXS5tYXRjaChDU0wuTk9URV9GSUVMRF9SRUdFWFApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxlbXNbal0gPSAnXFxuJyArIGVsZW1zW2pdLnNsaWNlKDIsLTEpLnRyaW0oKSArICdcXG4nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxpbmVzW2ldID0gZWxlbXMuam9pbignJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGluZXMgPSBsaW5lcy5qb2luKCdcXG4nKS5zcGxpdCgnXFxuJyk7XG4gICAgICAgIHZhciBvZmZzZXQgPSAwO1xuICAgICAgICB2YXIgbmFtZXMgPSB7fTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bGluZXMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIHZhciBsaW5lID0gbGluZXNbaV07XG4gICAgICAgICAgICB2YXIgbW0gPSBsaW5lLm1hdGNoKENTTC5OT1RFX0ZJRUxEX1JFR0VYUCk7XG4gICAgICAgICAgICBpZiAoIWxpbmUudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFtbSkge1xuICAgICAgICAgICAgICAgIGlmIChpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IGk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBrZXkgPSBtbVsxXTtcbiAgICAgICAgICAgIHZhciB2YWwgPSBtbVsyXS5yZXBsYWNlKC9eXFxzKy8sIFwiXCIpLnJlcGxhY2UoL1xccyskLywgXCJcIik7XG4gICAgICAgICAgICBpZiAoa2V5ID09PSBcInR5cGVcIikge1xuICAgICAgICAgICAgICAgIEl0ZW0udHlwZSA9IHZhbDtcbiAgICAgICAgICAgICAgICBsaW5lc1tpXSA9IFwiXCI7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKENTTC5EQVRFX1ZBUklBQkxFUy5pbmRleE9mKGtleSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIGlmIChhbGxvd0RhdGVPdmVycmlkZSkge1xuICAgICAgICAgICAgICAgICAgICBJdGVtW2tleV0gPSB7cmF3OiB2YWx9O1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkRmllbGRzRm9yVHlwZSB8fCAodmFsaWRGaWVsZHNGb3JUeXBlW2tleV0gJiYgdmFsLm1hdGNoKC9eWzAtOV17NH0oPzotWzAtOV17MSwyfSg/Oi1bMC05XXsxLDJ9KSopKiQvKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzW2ldID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIUl0ZW1ba2V5XSkge1xuICAgICAgICAgICAgICAgIGlmIChDU0wuTkFNRV9WQVJJQUJMRVMuaW5kZXhPZihrZXkpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFuYW1lc1trZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lc1trZXldID0gW107XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGxzdCA9IHZhbC5zcGxpdCgvXFxzKlxcfFxcfFxccyovKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxzdC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVzW2tleV0ucHVzaCh7bGl0ZXJhbDpsc3RbMF19KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChsc3QubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IHtmYW1pbHk6bHN0WzBdLGdpdmVuOmxzdFsxXX07XG4gICAgICAgICAgICAgICAgICAgICAgICBDU0wucGFyc2VQYXJ0aWNsZXMobmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lc1trZXldLnB1c2gobmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBJdGVtW2tleV0gPSB2YWw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghdmFsaWRGaWVsZHNGb3JUeXBlIHx8IHZhbGlkRmllbGRzRm9yVHlwZVtrZXldKSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmVzW2ldID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIga2V5IGluIG5hbWVzKSB7XG4gICAgICAgICAgICBJdGVtW2tleV0gPSBuYW1lc1trZXldO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YWxpZEZpZWxkc0ZvclR5cGUpIHtcbiAgICAgICAgICAgIGlmIChsaW5lc1tvZmZzZXRdLnRyaW0oKSkge1xuICAgICAgICAgICAgICAgIGxpbmVzW29mZnNldF0gPSAnXFxuJyArIGxpbmVzW29mZnNldF1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIGk9b2Zmc2V0LTE7aT4tMTtpLS0pIHtcbiAgICAgICAgICAgICAgICBpZiAoIWxpbmVzW2ldLnRyaW0oKSkge1xuICAgICAgICAgICAgICAgICAgICBsaW5lcyA9IGxpbmVzLnNsaWNlKDAsIGkpLmNvbmNhdChsaW5lcy5zbGljZShpICsgMSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBJdGVtLm5vdGUgPSBsaW5lcy5qb2luKFwiXFxuXCIpLnRyaW0oKTtcbiAgICB9LFxuICAgIEdFTkRFUlM6IFtcIm1hc2N1bGluZVwiLCBcImZlbWluaW5lXCJdLFxuICAgIEVSUk9SX05PX1JFTkRFUkVEX0ZPUk06IDEsXG4gICAgUFJFVklFVzogXCJKdXN0IGZvciBsYXVnaHMuXCIsXG4gICAgQVNTVU1FX0FMTF9JVEVNU19SRUdJU1RFUkVEOiAyLFxuICAgIFNUQVJUOiAwLFxuICAgIEVORDogMSxcbiAgICBTSU5HTEVUT046IDIsXG4gICAgU0VFTjogNixcbiAgICBTVUNDRVNTT1I6IDMsXG4gICAgU1VDQ0VTU09SX09GX1NVQ0NFU1NPUjogNCxcbiAgICBTVVBQUkVTUzogNSxcbiAgICBTSU5HVUxBUjogMCxcbiAgICBQTFVSQUw6IDEsXG4gICAgTElURVJBTDogdHJ1ZSxcbiAgICBCRUZPUkU6IDEsXG4gICAgQUZURVI6IDIsXG4gICAgREVTQ0VORElORzogMSxcbiAgICBBU0NFTkRJTkc6IDIsXG4gICAgT05MWV9GSVJTVDogMSxcbiAgICBBTFdBWVM6IDIsXG4gICAgT05MWV9MQVNUOiAzLFxuICAgIEZJTklTSDogMSxcbiAgICBQT1NJVElPTl9GSVJTVDogMCxcbiAgICBQT1NJVElPTl9TVUJTRVFVRU5UOiAxLFxuICAgIFBPU0lUSU9OX0lCSUQ6IDIsXG4gICAgUE9TSVRJT05fSUJJRF9XSVRIX0xPQ0FUT1I6IDMsXG4gICAgTUFSS19UUkFJTElOR19OQU1FUzogdHJ1ZSxcbiAgICBQT1NJVElPTl9URVNUX1ZBUlM6IFtcInBvc2l0aW9uXCIsIFwiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCIsIFwibmVhci1ub3RlXCJdLFxuICAgIEFSRUFTOiBbXCJjaXRhdGlvblwiLCBcImNpdGF0aW9uX3NvcnRcIiwgXCJiaWJsaW9ncmFwaHlcIiwgXCJiaWJsaW9ncmFwaHlfc29ydFwiXSxcbiAgICBDSVRFX0ZJRUxEUzogW1wiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCIsIFwibG9jYXRvclwiLCBcImxvY2F0b3ItZXh0cmFcIl0sXG4gICAgTUlOSU1BTF9OQU1FX0ZJRUxEUzogW1wibGl0ZXJhbFwiLCBcImZhbWlseVwiXSxcbiAgICBTV0FQUElOR19QVU5DVFVBVElPTjogW1wiLlwiLCBcIiFcIiwgXCI/XCIsIFwiOlwiLCBcIixcIl0sXG4gICAgVEVSTUlOQUxfUFVOQ1RVQVRJT046IFtcIjpcIiwgXCIuXCIsIFwiO1wiLCBcIiFcIiwgXCI/XCIsIFwiIFwiXSxcbiAgICBOT05FOiAwLFxuICAgIE5VTUVSSUM6IDEsXG4gICAgUE9TSVRJT046IDIsXG4gICAgQ09MTEFQU0VfVkFMVUVTOiBbXCJjaXRhdGlvbi1udW1iZXJcIiwgXCJ5ZWFyXCIsIFwieWVhci1zdWZmaXhcIl0sXG4gICAgREFURV9QQVJUUzogW1wieWVhclwiLCBcIm1vbnRoXCIsIFwiZGF5XCJdLFxuICAgIERBVEVfUEFSVFNfQUxMOiBbXCJ5ZWFyXCIsIFwibW9udGhcIiwgXCJkYXlcIiwgXCJzZWFzb25cIl0sXG4gICAgREFURV9QQVJUU19JTlRFUk5BTDogW1wieWVhclwiLCBcIm1vbnRoXCIsIFwiZGF5XCIsIFwieWVhcl9lbmRcIiwgXCJtb250aF9lbmRcIiwgXCJkYXlfZW5kXCJdLFxuICAgIE5BTUVfUEFSVFM6IFtcIm5vbi1kcm9wcGluZy1wYXJ0aWNsZVwiLCBcImZhbWlseVwiLCBcImdpdmVuXCIsIFwiZHJvcHBpbmctcGFydGljbGVcIiwgXCJzdWZmaXhcIiwgXCJsaXRlcmFsXCJdLFxuICAgIERFQ09SQUJMRV9OQU1FX1BBUlRTOiBbXCJnaXZlblwiLCBcImZhbWlseVwiLCBcInN1ZmZpeFwiXSxcbiAgICBESVNBTUJJR1VBVEVfT1BUSU9OUzogW1xuICAgICAgICBcImRpc2FtYmlndWF0ZS1hZGQtbmFtZXNcIixcbiAgICAgICAgXCJkaXNhbWJpZ3VhdGUtYWRkLWdpdmVubmFtZVwiLFxuICAgICAgICBcImRpc2FtYmlndWF0ZS1hZGQteWVhci1zdWZmaXhcIlxuICAgIF0sXG4gICAgR0lWRU5OQU1FX0RJU0FNQklHVUFUSU9OX1JVTEVTOiBbXG4gICAgICAgIFwiYWxsLW5hbWVzXCIsXG4gICAgICAgIFwiYWxsLW5hbWVzLXdpdGgtaW5pdGlhbHNcIixcbiAgICAgICAgXCJwcmltYXJ5LW5hbWVcIixcbiAgICAgICAgXCJwcmltYXJ5LW5hbWUtd2l0aC1pbml0aWFsc1wiLFxuICAgICAgICBcImJ5LWNpdGVcIlxuICAgIF0sXG4gICAgTkFNRV9BVFRSSUJVVEVTOiBbXG4gICAgICAgIFwiYW5kXCIsXG4gICAgICAgIFwiZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIixcbiAgICAgICAgXCJkZWxpbWl0ZXItcHJlY2VkZXMtZXQtYWxcIixcbiAgICAgICAgXCJpbml0aWFsaXplLXdpdGhcIixcbiAgICAgICAgXCJpbml0aWFsaXplXCIsXG4gICAgICAgIFwibmFtZS1hcy1zb3J0LW9yZGVyXCIsXG4gICAgICAgIFwic29ydC1zZXBhcmF0b3JcIixcbiAgICAgICAgXCJldC1hbC1taW5cIixcbiAgICAgICAgXCJldC1hbC11c2UtZmlyc3RcIixcbiAgICAgICAgXCJldC1hbC1zdWJzZXF1ZW50LW1pblwiLFxuICAgICAgICBcImV0LWFsLXN1YnNlcXVlbnQtdXNlLWZpcnN0XCIsXG4gICAgICAgIFwiZm9ybVwiLFxuICAgICAgICBcInByZWZpeFwiLFxuICAgICAgICBcInN1ZmZpeFwiLFxuICAgICAgICBcImRlbGltaXRlclwiXG4gICAgXSxcbiAgICBQQVJBTExFTF9NQVRDSF9WQVJTOiBbXCJjb250YWluZXItdGl0bGVcIl0sXG4gICAgUEFSQUxMRUxfVFlQRVM6IFtcImJpbGxcIixcImdhemV0dGVcIixcInJlZ3VsYXRpb25cIixcImxlZ2lzbGF0aW9uXCIsXCJsZWdhbF9jYXNlXCIsXCJ0cmVhdHlcIixcImFydGljbGUtbWFnYXppbmVcIixcImFydGljbGUtam91cm5hbFwiXSxcbiAgICBQQVJBTExFTF9DT0xMQVBTSU5HX01JRF9WQVJTRVQ6IFtcInZvbHVtZVwiLCBcImlzc3VlXCIsIFwiY29udGFpbmVyLXRpdGxlXCIsIFwic2VjdGlvblwiLCBcImNvbGxlY3Rpb24tbnVtYmVyXCJdLFxuICAgIExPT1NFOiAwLFxuICAgIFNUUklDVDogMSxcbiAgICBUT0xFUkFOVDogMixcbiAgICBQUkVGSVhfUFVOQ1RVQVRJT046IC9bLjs6XVxccyokLyxcbiAgICBTVUZGSVhfUFVOQ1RVQVRJT046IC9eXFxzKlsuOzosXFwoXFwpXS8sXG4gICAgTlVNQkVSX1JFR0VYUDogLyg/Ol5cXGQrfFxcZCskKS8sXG4gICAgTkFNRV9JTklUSUFMX1JFR0VYUDogL14oW0EtWlxcdTA1OTAtXFx1MDVmZlxcdTAwYzAtXFx1MDE3ZlxcdTA0MDAtXFx1MDQyZlxcdTA2MDAtXFx1MDZmZlxcdTAzNzBcXHUwMzcyXFx1MDM3NlxcdTAzODZcXHUwMzg4LVxcdTAzYWJcXHUwM2UyXFx1MDNlNFxcdTAzZTZcXHUwM2U4XFx1MDNlYVxcdTAzZWNcXHUwM2VlXFx1MDNmNFxcdTAzZjdcXHUwM2ZkLVxcdTAzZmZdKShbYS16QS1aXFx1MDBjMC1cXHUwMTdmXFx1MDQwMC1cXHUwNTJmXFx1MDYwMC1cXHUwNmZmXFx1MDM3MC1cXHUwM2ZmXFx1MWYwMC1cXHUxZmZmXSp8KS8sXG4gICAgUk9NQU5FU1FVRV9SRUdFWFA6IC9bLTAtOWEtekEtWlxcdTA1OTAtXFx1MDVkNFxcdTA1ZDYtXFx1MDVmZlxcdTAwODAtXFx1MDE3ZlxcdTA0MDAtXFx1MDUyZlxcdTAzNzAtXFx1MDNmZlxcdTFmMDAtXFx1MWZmZlxcdTA2MDAtXFx1MDZmZlxcdTIwMGNcXHUyMDBkXFx1MjAwZVxcdTAyMThcXHUwMjE5XFx1MDIxYVxcdTAyMWJcXHUyMDJhLVxcdTIwMmVdLyxcbiAgICBST01BTkVTUVVFX05PVF9SRUdFWFA6IC9bXmEtekEtWlxcdTA1OTAtXFx1MDVmZlxcdTAwYzAtXFx1MDE3ZlxcdTA0MDAtXFx1MDUyZlxcdTAzNzAtXFx1MDNmZlxcdTFmMDAtXFx1MWZmZlxcdTA2MDAtXFx1MDZmZlxcdTIwMGNcXHUyMDBkXFx1MjAwZVxcdTAyMThcXHUwMjE5XFx1MDIxYVxcdTAyMWJcXHUyMDJhLVxcdTIwMmVdL2csXG4gICAgU1RBUlRTV0lUSF9ST01BTkVTUVVFX1JFR0VYUDogL15bJmEtekEtWlxcdTA1OTAtXFx1MDVkNFxcdTA1ZDYtXFx1MDVmZlxcdTAwYzAtXFx1MDE3ZlxcdTA0MDAtXFx1MDUyZlxcdTAzNzAtXFx1MDNmZlxcdTFmMDAtXFx1MWZmZlxcdTA2MDAtXFx1MDZmZlxcdTIwMGNcXHUyMDBkXFx1MjAwZVxcdTAyMThcXHUwMjE5XFx1MDIxYVxcdTAyMWJcXHUyMDJhLVxcdTIwMmVdLyxcbiAgICBFTkRTV0lUSF9ST01BTkVTUVVFX1JFR0VYUDogL1suOzomYS16QS1aXFx1MDU5MC1cXHUwNWQ0XFx1MDVkNi1cXHUwNWZmXFx1MDBjMC1cXHUwMTdmXFx1MDQwMC1cXHUwNTJmXFx1MDM3MC1cXHUwM2ZmXFx1MWYwMC1cXHUxZmZmXFx1MDYwMC1cXHUwNmZmXFx1MjAwY1xcdTIwMGRcXHUyMDBlXFx1MDIxOFxcdTAyMTlcXHUwMjFhXFx1MDIxYlxcdTIwMmEtXFx1MjAyZV0kLyxcbiAgICBBTExfUk9NQU5FU1FVRV9SRUdFWFA6IC9eW2EtekEtWlxcdTA1OTAtXFx1MDVmZlxcdTAwYzAtXFx1MDE3ZlxcdTA0MDAtXFx1MDUyZlxcdTAzNzAtXFx1MDNmZlxcdTFmMDAtXFx1MWZmZlxcdTA2MDAtXFx1MDZmZlxcdTIwMGNcXHUyMDBkXFx1MjAwZVxcdTAyMThcXHUwMjE5XFx1MDIxYVxcdTAyMWJcXHUyMDJhLVxcdTIwMmVdKyQvLFxuICAgIFZJRVROQU1FU0VfU1BFQ0lBTFM6IC9bXFx1MDBjMC1cXHUwMGMzXFx1MDBjOC1cXHUwMGNhXFx1MDBjY1xcdTAwY2RcXHUwMGQyLVxcdTAwZDVcXHUwMGQ5XFx1MDBkYVxcdTAwZGRcXHUwMGUwLVxcdTAwZTNcXHUwMGU4LVxcdTAwZWFcXHUwMGVjXFx1MDBlZFxcdTAwZjItXFx1MDBmNVxcdTAwZjlcXHUwMGZhXFx1MDBmZFxcdTAxMDFcXHUwMTAzXFx1MDExMFxcdTAxMTFcXHUwMTI4XFx1MDEyOVxcdTAxNjhcXHUwMTY5XFx1MDFhMFxcdTAxYTFcXHUwMWFmXFx1MDFiMFxcdTFlYTAtXFx1MWVmOV0vLFxuICAgIFZJRVROQU1FU0VfTkFNRVM6IC9eKD86KD86Wy5BYUJiQ2NEZEVlR2dIaElpS2tMbE1tTm5Pb1BwUXFSclNzVHRVdVZ2WHhZeSBcXHUwMGMwLVxcdTAwYzNcXHUwMGM4LVxcdTAwY2FcXHUwMGNjXFx1MDBjZFxcdTAwZDItXFx1MDBkNVxcdTAwZDlcXHUwMGRhXFx1MDBkZFxcdTAwZTAtXFx1MDBlM1xcdTAwZTgtXFx1MDBlYVxcdTAwZWNcXHUwMGVkXFx1MDBmMi1cXHUwMGY1XFx1MDBmOVxcdTAwZmFcXHUwMGZkXFx1MDEwMVxcdTAxMDNcXHUwMTEwXFx1MDExMVxcdTAxMjhcXHUwMTI5XFx1MDE2OFxcdTAxNjlcXHUwMWEwXFx1MDFhMVxcdTAxYWZcXHUwMWIwXFx1MWVhMC1cXHUxZWY5XXsyLDZ9KShcXHMrfCQpKSskLyxcbiAgICBOT1RFX0ZJRUxEU19SRUdFWFA6IC9cXHs6KD86W1xcLV9hLXpdK3xbQS1aXSspOlteXFx9XStcXH0vZyxcbiAgICBOT1RFX0ZJRUxEX1JFR0VYUDogL14oW1xcLV9hLXpdK3xbQS1aXSspOlxccyooW15cXH1dKykkLyxcblx0UEFSVElDTEVfR0lWRU5fUkVHRVhQOiAvXihbXiBdKyg/OlxcdTAyYmIgfFxcdTIwMTkgfCB8XFwnICkgKikoLispJC8sXG5cdFBBUlRJQ0xFX0ZBTUlMWV9SRUdFWFA6IC9eKFteIF0rKD86XFwtfFxcdTAyYmJ8XFx1MjAxOXwgfFxcJykgKikoLispJC8sXG4gICAgRElTUExBWV9DTEFTU0VTOiBbXCJibG9ja1wiLCBcImxlZnQtbWFyZ2luXCIsIFwicmlnaHQtaW5saW5lXCIsIFwiaW5kZW50XCJdLFxuICAgIE5BTUVfVkFSSUFCTEVTOiBbXG4gICAgICAgIFwiYXV0aG9yXCIsXG4gICAgICAgIFwiZWRpdG9yXCIsXG4gICAgICAgIFwidHJhbnNsYXRvclwiLFxuICAgICAgICBcImNvbnRyaWJ1dG9yXCIsXG4gICAgICAgIFwiY29sbGVjdGlvbi1lZGl0b3JcIixcbiAgICAgICAgXCJjb21wb3NlclwiLFxuICAgICAgICBcImNvbnRhaW5lci1hdXRob3JcIixcbiAgICAgICAgXCJkaXJlY3RvclwiLFxuICAgICAgICBcImVkaXRvcmlhbC1kaXJlY3RvclwiLFxuICAgICAgICBcImludGVydmlld2VyXCIsXG4gICAgICAgIFwib3JpZ2luYWwtYXV0aG9yXCIsXG4gICAgICAgIFwicmVjaXBpZW50XCJcbiAgICBdLFxuICAgIE5VTUVSSUNfVkFSSUFCTEVTOiBbXG4gICAgICAgIFwiY2FsbC1udW1iZXJcIixcbiAgICAgICAgXCJjaGFwdGVyLW51bWJlclwiLFxuICAgICAgICBcImNvbGxlY3Rpb24tbnVtYmVyXCIsXG4gICAgICAgIFwiZWRpdGlvblwiLFxuICAgICAgICBcInBhZ2VcIixcbiAgICAgICAgXCJpc3N1ZVwiLFxuICAgICAgICBcImxvY2F0b3JcIixcbiAgICAgICAgXCJudW1iZXJcIixcbiAgICAgICAgXCJudW1iZXItb2YtcGFnZXNcIixcbiAgICAgICAgXCJudW1iZXItb2Ytdm9sdW1lc1wiLFxuICAgICAgICBcInZvbHVtZVwiLFxuICAgICAgICBcImNpdGF0aW9uLW51bWJlclwiXG4gICAgXSxcbiAgICBEQVRFX1ZBUklBQkxFUzogW1xuICAgICAgICBcImxvY2F0b3ItZGF0ZVwiLCBcbiAgICAgICAgXCJpc3N1ZWRcIiwgXG4gICAgICAgIFwiZXZlbnQtZGF0ZVwiLCBcbiAgICAgICAgXCJhY2Nlc3NlZFwiLCBcbiAgICAgICAgXCJjb250YWluZXJcIiwgXG4gICAgICAgIFwib3JpZ2luYWwtZGF0ZVwiLFxuICAgICAgICBcInB1YmxpY2F0aW9uLWRhdGVcIixcbiAgICAgICAgXCJvcmlnaW5hbC1kYXRlXCIsXG4gICAgICAgIFwiYXZhaWxhYmxlLWRhdGVcIixcbiAgICAgICAgXCJzdWJtaXR0ZWRcIlxuICAgIF0sXG4gICAgVElUTEVfRklFTERfU1BMSVRTOiBmdW5jdGlvbihzZWcpIHtcbiAgICAgICAgdmFyIGtleXMgPSBbXCJ0aXRsZVwiLCBcInNob3J0XCIsIFwibWFpblwiLCBcInN1YlwiXTtcbiAgICAgICAgdmFyIHJldCA9IHt9O1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1rZXlzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICByZXRba2V5c1tpXV0gPSBzZWcgKyBcInRpdGxlXCIgKyAoa2V5c1tpXSA9PT0gXCJ0aXRsZVwiID8gXCJcIiA6IFwiLVwiICsga2V5c1tpXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9LFxuICAgIFRBR19VU0VBTEw6IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgdmFyIHJldCwgb3BlbiwgY2xvc2UsIGVuZDtcbiAgICAgICAgcmV0ID0gW1wiXCJdO1xuICAgICAgICBvcGVuID0gc3RyLmluZGV4T2YoXCI8XCIpO1xuICAgICAgICBjbG9zZSA9IHN0ci5pbmRleE9mKFwiPlwiKTtcbiAgICAgICAgd2hpbGUgKG9wZW4gPiAtMSAmJiBjbG9zZSA+IC0xKSB7XG4gICAgICAgICAgICBpZiAob3BlbiA+IGNsb3NlKSB7XG4gICAgICAgICAgICAgICAgZW5kID0gb3BlbiArIDE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGVuZCA9IGNsb3NlICsgMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvcGVuIDwgY2xvc2UgJiYgc3RyLnNsaWNlKG9wZW4gKyAxLCBjbG9zZSkuaW5kZXhPZihcIjxcIikgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgcmV0W3JldC5sZW5ndGggLSAxXSArPSBzdHIuc2xpY2UoMCwgb3Blbik7XG4gICAgICAgICAgICAgICAgcmV0LnB1c2goc3RyLnNsaWNlKG9wZW4sIGNsb3NlICsgMSkpO1xuICAgICAgICAgICAgICAgIHJldC5wdXNoKFwiXCIpO1xuICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zbGljZShlbmQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXRbcmV0Lmxlbmd0aCAtIDFdICs9IHN0ci5zbGljZSgwLCBjbG9zZSArIDEpO1xuICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zbGljZShlbmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgb3BlbiA9IHN0ci5pbmRleE9mKFwiPFwiKTtcbiAgICAgICAgICAgIGNsb3NlID0gc3RyLmluZGV4T2YoXCI+XCIpO1xuICAgICAgICB9XG4gICAgICAgIHJldFtyZXQubGVuZ3RoIC0gMV0gKz0gc3RyO1xuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH0sXG4gICAgZGVtb3RlTm9pc2VXb3JkczogZnVuY3Rpb24gKHN0YXRlLCBmbGQsIGRyb3Bfb3JfZGVtb3RlKSB7XG4gICAgICAgIHZhciBTS0lQX1dPUkRTID0gc3RhdGUubG9jYWxlW3N0YXRlLm9wdC5sYW5nXS5vcHRzW1wibGVhZGluZy1ub2lzZS13b3Jkc1wiXTtcbiAgICAgICAgaWYgKGZsZCAmJiBkcm9wX29yX2RlbW90ZSkge1xuICAgICAgICAgICAgZmxkID0gZmxkLnNwbGl0KC9cXHMrLyk7XG4gICAgICAgICAgICBmbGQucmV2ZXJzZSgpO1xuICAgICAgICAgICAgdmFyIHRvRW5kID0gW107XG4gICAgICAgICAgICBmb3IgKHZhciBqICA9IGZsZC5sZW5ndGggLSAxOyBqID4gLTE7IGogKz0gLTEpIHtcbiAgICAgICAgICAgICAgICBpZiAoU0tJUF9XT1JEUy5pbmRleE9mKGZsZFtqXS50b0xvd2VyQ2FzZSgpKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHRvRW5kLnB1c2goZmxkLnBvcCgpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmbGQucmV2ZXJzZSgpO1xuICAgICAgICAgICAgdmFyIHN0YXJ0ID0gZmxkLmpvaW4oXCIgXCIpO1xuICAgICAgICAgICAgdmFyIGVuZCA9IHRvRW5kLmpvaW4oXCIgXCIpO1xuICAgICAgICAgICAgaWYgKFwiZHJvcFwiID09PSBkcm9wX29yX2RlbW90ZSB8fCAhZW5kKSB7XG4gICAgICAgICAgICAgICAgZmxkID0gc3RhcnQ7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKFwiZGVtb3RlXCIgPT09IGRyb3Bfb3JfZGVtb3RlKSB7XG4gICAgICAgICAgICAgICAgZmxkID0gW3N0YXJ0LCBlbmRdLmpvaW4oXCIsIFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmxkO1xuICAgIH0sXG4gICAgZXh0cmFjdFRpdGxlQW5kU3VidGl0bGU6IGZ1bmN0aW9uIChJdGVtKSB7XG4gICAgICAgIHZhciBzZWdtZW50cyA9IFtcIlwiLCBcImNvbnRhaW5lci1cIl07XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXNlZ21lbnRzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICB2YXIgc2VnID0gc2VnbWVudHNbaV07XG4gICAgICAgICAgICB2YXIgdGl0bGUgPSBDU0wuVElUTEVfRklFTERfU1BMSVRTKHNlZyk7XG4gICAgICAgICAgICB2YXIgbGFuZ3MgPSBbZmFsc2VdO1xuICAgICAgICAgICAgaWYgKEl0ZW0ubXVsdGkpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBsYW5nIGluIEl0ZW0ubXVsdGkuX2tleXNbdGl0bGUuc2hvcnRdKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhbmdzLnB1c2gobGFuZyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49bGFuZ3MubGVuZ3RoO2o8aWxlbjtqKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgbGFuZyA9IGxhbmdzW2pdO1xuICAgICAgICAgICAgICAgIHZhciB2YWxzID0ge307XG4gICAgICAgICAgICAgICAgaWYgKGxhbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKEl0ZW0ubXVsdGkuX2tleXNbdGl0bGUudGl0bGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWxzW3RpdGxlLnRpdGxlXSA9IEl0ZW0ubXVsdGkuX2tleXNbdGl0bGUudGl0bGVdW2xhbmddO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChJdGVtLm11bHRpLl9rZXlzW3RpdGxlW1wic2hvcnRcIl1dKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWxzW3RpdGxlW1wic2hvcnRcIl1dID0gSXRlbS5tdWx0aS5fa2V5c1t0aXRsZVtcInNob3J0XCJdXVtsYW5nXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHNbdGl0bGUudGl0bGVdID0gSXRlbVt0aXRsZS50aXRsZV07XG4gICAgICAgICAgICAgICAgICAgIHZhbHNbdGl0bGVbXCJzaG9ydFwiXV0gPSBJdGVtW3RpdGxlW1wic2hvcnRcIl1dO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YWxzW3RpdGxlLm1haW5dID0gdmFsc1t0aXRsZS50aXRsZV07XG4gICAgICAgICAgICAgICAgdmFsc1t0aXRsZS5zdWJdID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHNbdGl0bGUudGl0bGVdICYmIHZhbHNbdGl0bGVbXCJzaG9ydFwiXV0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNob3J0VGl0bGUgPSB2YWxzW3RpdGxlW1wic2hvcnRcIl1dO1xuICAgICAgICAgICAgICAgICAgICB2YXIgb2Zmc2V0ID0gc2hvcnRUaXRsZS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWxzW3RpdGxlLnRpdGxlXS5zbGljZSgwLG9mZnNldCkgPT09IHNob3J0VGl0bGUgJiYgdmFsc1t0aXRsZS50aXRsZV0uc2xpY2Uob2Zmc2V0KS5tYXRjaCgvXlxccyo6LykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHNbdGl0bGUubWFpbl0gPSB2YWxzW3RpdGxlLnRpdGxlXS5zbGljZSgwLG9mZnNldCkucmVwbGFjZSgvXFxzKyQvLFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsc1t0aXRsZS5zdWJdID0gdmFsc1t0aXRsZS50aXRsZV0uc2xpY2Uob2Zmc2V0KS5yZXBsYWNlKC9eXFxzKjpcXHMqLyxcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobGFuZykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFscykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFJdGVtLm11bHRpLl9rZXlzW2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJdGVtLm11bHRpLl9rZXlzW2tleV0gPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIEl0ZW0ubXVsdGkuX2tleXNba2V5XVtsYW5nXSA9IHZhbHNba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB2YWxzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBJdGVtW2tleV0gPSB2YWxzW2tleV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9LFxuICAgIHRpdGxlY2FzZVNlbnRlbmNlT3JOb3JtYWw6IGZ1bmN0aW9uKHN0YXRlLCBJdGVtLCBzZWcsIGxhbmcsIHNlbnRlbmNlQ2FzZSkge1xuICAgICAgICB2YXIgdGl0bGUgPSBDU0wuVElUTEVfRklFTERfU1BMSVRTKHNlZyk7XG4gICAgICAgIHZhciB2YWxzID0ge307XG4gICAgICAgIGlmIChsYW5nICYmIEl0ZW0ubXVsdGkpIHtcbiAgICAgICAgICAgIGlmIChJdGVtLm11bHRpLl9rZXlzW3RpdGxlLnRpdGxlXSkge1xuICAgICAgICAgICAgICAgIHZhbHNbdGl0bGUudGl0bGVdID0gSXRlbS5tdWx0aS5fa2V5c1t0aXRsZS50aXRsZV1bbGFuZ107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoSXRlbS5tdWx0aS5fa2V5c1t0aXRsZS5tYWluXSkge1xuICAgICAgICAgICAgICAgIHZhbHNbdGl0bGUubWFpbl0gPSBJdGVtLm11bHRpLl9rZXlzW3RpdGxlLm1haW5dW2xhbmddO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKEl0ZW0ubXVsdGkuX2tleXNbdGl0bGUuc3ViXSkge1xuICAgICAgICAgICAgICAgIHZhbHNbdGl0bGUuc3ViXSA9IEl0ZW0ubXVsdGkuX2tleXNbdGl0bGUuc3ViXVtsYW5nXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhbHNbdGl0bGUudGl0bGVdID0gSXRlbVt0aXRsZS50aXRsZV07XG4gICAgICAgICAgICB2YWxzW3RpdGxlLm1haW5dID0gSXRlbVt0aXRsZS5tYWluXTtcbiAgICAgICAgICAgIHZhbHNbdGl0bGUuc3ViXSA9IEl0ZW1bdGl0bGUuc3ViXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodmFsc1t0aXRsZS5tYWluXSAmJiB2YWxzW3RpdGxlLnN1Yl0pIHtcbiAgICAgICAgICAgIHZhciBtYWluVGl0bGUgPSB2YWxzW3RpdGxlLm1haW5dO1xuICAgICAgICAgICAgdmFyIHN1YlRpdGxlID0gdmFsc1t0aXRsZS5zdWJdO1xuICAgICAgICAgICAgaWYgKHNlbnRlbmNlQ2FzZSkge1xuICAgICAgICAgICAgICAgIG1haW5UaXRsZSA9IENTTC5PdXRwdXQuRm9ybWF0dGVycy5zZW50ZW5jZShzdGF0ZSwgbWFpblRpdGxlKTtcbiAgICAgICAgICAgICAgICBzdWJUaXRsZSA9IENTTC5PdXRwdXQuRm9ybWF0dGVycy5zZW50ZW5jZShzdGF0ZSwgc3ViVGl0bGUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdWJUaXRsZSA9IENTTC5PdXRwdXQuRm9ybWF0dGVyc1tcImNhcGl0YWxpemUtZmlyc3RcIl0oc3RhdGUsIHN1YlRpdGxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBbbWFpblRpdGxlLCBzdWJUaXRsZV0uam9pbih2YWxzW3RpdGxlLnRpdGxlXS5zbGljZShtYWluVGl0bGUubGVuZ3RoLCAtMSAqIHN1YlRpdGxlLmxlbmd0aCkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHNlbnRlbmNlQ2FzZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBDU0wuT3V0cHV0LkZvcm1hdHRlcnMuc2VudGVuY2Uoc3RhdGUsIHZhbHNbdGl0bGUudGl0bGVdKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHNbdGl0bGUudGl0bGVdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcbiAgICBnZXRTYWZlRXNjYXBlOiBmdW5jdGlvbihzdGF0ZSkge1xuICAgICAgICBpZiAoW1wiYmlibGlvZ3JhcGh5XCIsIFwiY2l0YXRpb25cIl0uaW5kZXhPZihzdGF0ZS50bXAuYXJlYSkgPiAtMSkge1xuICAgICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IFtdO1xuICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnRoaW5fbm9uX2JyZWFraW5nX3NwYWNlX2h0bWxfaGFjayAmJiBzdGF0ZS5vcHQubW9kZSA9PT0gXCJodG1sXCIpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFja3MucHVzaChmdW5jdGlvbiAodHh0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0eHQucmVwbGFjZSgvXFx1MjAyZi9nLCAnPHNwYW4gc3R5bGU9XCJ3aGl0ZS1zcGFjZTpub3dyYXBcIj4mdGhpbnNwOzwvc3Bhbj4nKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjYWxsYmFja3MubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0eHQpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBjYWxsYmFja3MubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eHQgPSBjYWxsYmFja3NbaV0odHh0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gQ1NMLk91dHB1dC5Gb3JtYXRzW3N0YXRlLm9wdC5tb2RlXS50ZXh0X2VzY2FwZSh0eHQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIENTTC5PdXRwdXQuRm9ybWF0c1tzdGF0ZS5vcHQubW9kZV0udGV4dF9lc2NhcGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHR4dCkgeyByZXR1cm4gdHh0OyB9O1xuICAgICAgICB9XG4gICAgfSxcbiAgICBTS0lQX1dPUkRTOiBbXCJhYm91dFwiLFwiYWJvdmVcIixcImFjcm9zc1wiLFwiYWZvcmVcIixcImFmdGVyXCIsXCJhZ2FpbnN0XCIsXCJhbG9uZ1wiLFwiYWxvbmdzaWRlXCIsXCJhbWlkXCIsXCJhbWlkc3RcIixcImFtb25nXCIsXCJhbW9uZ3N0XCIsXCJhbmVuc3RcIixcImFwcm9wb3NcIixcImFwdWRcIixcImFyb3VuZFwiLFwiYXNcIixcImFzaWRlXCIsXCJhc3RyaWRlXCIsXCJhdFwiLFwiYXRod2FydFwiLFwiYXRvcFwiLFwiYmFycmluZ1wiLFwiYmVmb3JlXCIsXCJiZWhpbmRcIixcImJlbG93XCIsXCJiZW5lYXRoXCIsXCJiZXNpZGVcIixcImJlc2lkZXNcIixcImJldHdlZW5cIixcImJleW9uZFwiLFwiYnV0XCIsXCJieVwiLFwiY2lyY2FcIixcImRlc3BpdGVcIixcImRvd25cIixcImR1cmluZ1wiLFwiZXhjZXB0XCIsXCJmb3JcIixcImZvcmVuZW5zdFwiLFwiZnJvbVwiLFwiZ2l2ZW5cIixcImluXCIsXCJpbnNpZGVcIixcImludG9cIixcImxlc3RcIixcImxpa2VcIixcIm1vZHVsb1wiLFwibmVhclwiLFwibmV4dFwiLFwibm90d2l0aHN0YW5kaW5nXCIsXCJvZlwiLFwib2ZmXCIsXCJvblwiLFwib250b1wiLFwib3V0XCIsXCJvdmVyXCIsXCJwZXJcIixcInBsdXNcIixcInByb1wiLFwicXVhXCIsXCJzYW5zXCIsXCJzaW5jZVwiLFwidGhhblwiLFwidGhyb3VnaFwiLFwiIHRocnVcIixcInRocm91Z2hvdXRcIixcInRocnVvdXRcIixcInRpbGxcIixcInRvXCIsXCJ0b3dhcmRcIixcInRvd2FyZHNcIixcInVuZGVyXCIsXCJ1bmRlcm5lYXRoXCIsXCJ1bnRpbFwiLFwidW50b1wiLFwidXBcIixcInVwb25cIixcInZlcnN1c1wiLFwidnMuXCIsXCJ2LlwiLFwidnNcIixcInZcIixcInZpYVwiLFwidmlzLcOgLXZpc1wiLFwid2l0aFwiLFwid2l0aGluXCIsXCJ3aXRob3V0XCIsXCJhY2NvcmRpbmcgdG9cIixcImFoZWFkIG9mXCIsXCJhcGFydCBmcm9tXCIsXCJhcyBmb3JcIixcImFzIG9mXCIsXCJhcyBwZXJcIixcImFzIHJlZ2FyZHNcIixcImFzaWRlIGZyb21cIixcImJhY2sgdG9cIixcImJlY2F1c2Ugb2ZcIixcImNsb3NlIHRvXCIsXCJkdWUgdG9cIixcImV4Y2VwdCBmb3JcIixcImZhciBmcm9tXCIsXCJpbnNpZGUgb2ZcIixcImluc3RlYWQgb2ZcIixcIm5lYXIgdG9cIixcIm5leHQgdG9cIixcIm9uIHRvXCIsXCJvdXQgZnJvbVwiLFwib3V0IG9mXCIsXCJvdXRzaWRlIG9mXCIsXCJwcmlvciB0b1wiLFwicHVyc3VhbnQgdG9cIixcInJhdGhlciB0aGFuXCIsXCJyZWdhcmRsZXNzIG9mXCIsXCJzdWNoIGFzXCIsXCJ0aGF0IG9mXCIsXCJ1cCB0b1wiLFwid2hlcmUgYXNcIixcIm9yXCIsIFwieWV0XCIsIFwic29cIiwgXCJmb3JcIiwgXCJhbmRcIiwgXCJub3JcIiwgXCJhXCIsIFwiYW5cIiwgXCJ0aGVcIiwgXCJkZVwiLCBcImQnXCIsIFwidm9uXCIsIFwidmFuXCIsIFwiY1wiLCBcImV0XCIsIFwiY2FcIl0sXG4gICAgRk9STUFUX0tFWV9TRVFVRU5DRTogW1xuICAgICAgICBcIkBzdHJpcC1wZXJpb2RzXCIsXG4gICAgICAgIFwiQGZvbnQtc3R5bGVcIixcbiAgICAgICAgXCJAZm9udC12YXJpYW50XCIsXG4gICAgICAgIFwiQGZvbnQtd2VpZ2h0XCIsXG4gICAgICAgIFwiQHRleHQtZGVjb3JhdGlvblwiLFxuICAgICAgICBcIkB2ZXJ0aWNhbC1hbGlnblwiLFxuICAgICAgICBcIkBxdW90ZXNcIlxuICAgIF0sXG4gICAgSU5TVElUVVRJT05fS0VZUzogW1xuICAgICAgICBcImZvbnQtc3R5bGVcIixcbiAgICAgICAgXCJmb250LXZhcmlhbnRcIixcbiAgICAgICAgXCJmb250LXdlaWdodFwiLFxuICAgICAgICBcInRleHQtZGVjb3JhdGlvblwiLFxuICAgICAgICBcInRleHQtY2FzZVwiXG4gICAgXSxcbiAgICBTVUZGSVhfQ0hBUlM6IFwiYSxiLGMsZCxlLGYsZyxoLGksaixrLGwsbSxuLG8scCxxLHIscyx0LHUsdix3LHgseSx6XCIsXG4gICAgUk9NQU5fTlVNRVJBTFM6IFtcbiAgICAgICAgWyBcIlwiLCBcImlcIiwgXCJpaVwiLCBcImlpaVwiLCBcIml2XCIsIFwidlwiLCBcInZpXCIsIFwidmlpXCIsIFwidmlpaVwiLCBcIml4XCIgXSxcbiAgICAgICAgWyBcIlwiLCBcInhcIiwgXCJ4eFwiLCBcInh4eFwiLCBcInhsXCIsIFwibFwiLCBcImx4XCIsIFwibHh4XCIsIFwibHh4eFwiLCBcInhjXCIgXSxcbiAgICAgICAgWyBcIlwiLCBcImNcIiwgXCJjY1wiLCBcImNjY1wiLCBcImNkXCIsIFwiZFwiLCBcImRjXCIsIFwiZGNjXCIsIFwiZGNjY1wiLCBcImNtXCIgXSxcbiAgICAgICAgWyBcIlwiLCBcIm1cIiwgXCJtbVwiLCBcIm1tbVwiLCBcIm1tbW1cIiwgXCJtbW1tbVwiXVxuICAgIF0sXG4gICAgQ1JFQVRPUlM6IFtcbiAgICAgICAgXCJhdXRob3JcIixcbiAgICAgICAgXCJlZGl0b3JcIixcbiAgICAgICAgXCJjb250cmlidXRvclwiLFxuICAgICAgICBcInRyYW5zbGF0b3JcIixcbiAgICAgICAgXCJyZWNpcGllbnRcIixcbiAgICAgICAgXCJpbnRlcnZpZXdlclwiLFxuICAgICAgICBcImNvbXBvc2VyXCIsXG4gICAgICAgIFwib3JpZ2luYWwtYXV0aG9yXCIsXG4gICAgICAgIFwiY29udGFpbmVyLWF1dGhvclwiLFxuICAgICAgICBcImNvbGxlY3Rpb24tZWRpdG9yXCJcbiAgICBdLFxuICAgIExBTkdTOiB7XG4gICAgICAgIFwiYWYtWkFcIjpcIkFmcmlrYWFuc1wiLFxuICAgICAgICBcImFyXCI6XCJBcmFiaWNcIixcbiAgICAgICAgXCJiZy1CR1wiOlwiQnVsZ2FyaWFuXCIsXG4gICAgICAgIFwiY2EtQURcIjpcIkNhdGFsYW5cIixcbiAgICAgICAgXCJjcy1DWlwiOlwiQ3plY2hcIixcbiAgICAgICAgXCJkYS1ES1wiOlwiRGFuaXNoXCIsXG4gICAgICAgIFwiZGUtQVRcIjpcIkF1c3RyaWFuXCIsXG4gICAgICAgIFwiZGUtQ0hcIjpcIkdlcm1hbiAoQ0gpXCIsXG4gICAgICAgIFwiZGUtREVcIjpcIkdlcm1hbiAoREUpXCIsXG4gICAgICAgIFwiZWwtR1JcIjpcIkdyZWVrXCIsXG4gICAgICAgIFwiZW4tR0JcIjpcIkVuZ2xpc2ggKEdCKVwiLFxuICAgICAgICBcImVuLVVTXCI6XCJFbmdsaXNoIChVUylcIixcbiAgICAgICAgXCJlcy1FU1wiOlwiU3BhbmlzaFwiLFxuICAgICAgICBcImV0LUVFXCI6XCJFc3RvbmlhblwiLFxuICAgICAgICBcImV1XCI6XCJFdXJvcGVhblwiLFxuICAgICAgICBcImZhLUlSXCI6XCJQZXJzaWFuXCIsXG4gICAgICAgIFwiZmktRklcIjpcIkZpbm5pc2hcIixcbiAgICAgICAgXCJmci1DQVwiOlwiRnJlbmNoIChDQSlcIixcbiAgICAgICAgXCJmci1GUlwiOlwiRnJlbmNoIChGUilcIixcbiAgICAgICAgXCJoZS1JTFwiOlwiSGVicmV3XCIsXG4gICAgICAgIFwiaHItSFJcIjpcIkNyb2F0aWFuXCIsXG4gICAgICAgIFwiaHUtSFVcIjpcIkh1bmdhcmlhblwiLFxuICAgICAgICBcImlzLUlTXCI6XCJJY2VsYW5kaWNcIixcbiAgICAgICAgXCJpdC1JVFwiOlwiSXRhbGlhblwiLFxuICAgICAgICBcImphLUpQXCI6XCJKYXBhbmVzZVwiLFxuICAgICAgICBcImttLUtIXCI6XCJLaG1lclwiLFxuICAgICAgICBcImtvLUtSXCI6XCJLb3JlYW5cIixcbiAgICAgICAgXCJsdC1MVFwiOlwiTGl0aHVhbmlhblwiLFxuICAgICAgICBcImx2LUxWXCI6XCJMYXR2aWFuXCIsXG4gICAgICAgIFwibW4tTU5cIjpcIk1vbmdvbGlhblwiLFxuICAgICAgICBcIm5iLU5PXCI6XCJOb3J3ZWdpYW4gKEJva23DpWwpXCIsXG4gICAgICAgIFwibmwtTkxcIjpcIkR1dGNoXCIsXG4gICAgICAgIFwibm4tTk9cIjpcIk5vcndlZ2lhbiAoTnlub3JzaylcIixcbiAgICAgICAgXCJwbC1QTFwiOlwiUG9saXNoXCIsXG4gICAgICAgIFwicHQtQlJcIjpcIlBvcnR1Z3Vlc2UgKEJSKVwiLFxuICAgICAgICBcInB0LVBUXCI6XCJQb3J0dWd1ZXNlIChQVClcIixcbiAgICAgICAgXCJyby1ST1wiOlwiUm9tYW5pYW5cIixcbiAgICAgICAgXCJydS1SVVwiOlwiUnVzc2lhblwiLFxuICAgICAgICBcInNrLVNLXCI6XCJTbG92YWtcIixcbiAgICAgICAgXCJzbC1TSVwiOlwiU2xvdmVuaWFuXCIsXG4gICAgICAgIFwic3ItUlNcIjpcIlNlcmJpYW5cIixcbiAgICAgICAgXCJzdi1TRVwiOlwiU3dlZGlzaFwiLFxuICAgICAgICBcInRoLVRIXCI6XCJUaGFpXCIsXG4gICAgICAgIFwidHItVFJcIjpcIlR1cmtpc2hcIixcbiAgICAgICAgXCJ1ay1VQVwiOlwiVWtyYW5pYW5cIixcbiAgICAgICAgXCJ2aS1WTlwiOlwiVmlldG5hbWVzZVwiLFxuICAgICAgICBcInpoLUNOXCI6XCJDaGluZXNlIChDTilcIixcbiAgICAgICAgXCJ6aC1UV1wiOlwiQ2hpbmVzZSAoVFcpXCJcbiAgICB9LFxuICAgIExBTkdfQkFTRVM6IHtcbiAgICAgICAgYWY6IFwiYWZfWkFcIixcbiAgICAgICAgYXI6IFwiYXJcIixcbiAgICAgICAgYmc6IFwiYmdfQkdcIixcbiAgICAgICAgY2E6IFwiY2FfQURcIixcbiAgICAgICAgY3M6IFwiY3NfQ1pcIixcbiAgICAgICAgZGE6IFwiZGFfREtcIixcbiAgICAgICAgZGU6IFwiZGVfREVcIixcbiAgICAgICAgZWw6IFwiZWxfR1JcIixcbiAgICAgICAgZW46IFwiZW5fVVNcIixcbiAgICAgICAgZXM6IFwiZXNfRVNcIixcbiAgICAgICAgZXQ6IFwiZXRfRUVcIixcbiAgICAgICAgZXU6IFwiZXVcIixcbiAgICAgICAgZmE6IFwiZmFfSVJcIixcbiAgICAgICAgZmk6IFwiZmlfRklcIixcbiAgICAgICAgZnI6IFwiZnJfRlJcIixcbiAgICAgICAgaGU6IFwiaGVfSUxcIixcbiAgICAgICAgaHI6IFwiaHItSFJcIixcbiAgICAgICAgaHU6IFwiaHVfSFVcIixcbiAgICAgICAgaXM6IFwiaXNfSVNcIixcbiAgICAgICAgaXQ6IFwiaXRfSVRcIixcbiAgICAgICAgamE6IFwiamFfSlBcIixcbiAgICAgICAga206IFwia21fS0hcIixcbiAgICAgICAga286IFwia29fS1JcIixcbiAgICAgICAgbHQ6IFwibHRfTFRcIixcbiAgICAgICAgbHY6IFwibHYtTFZcIixcbiAgICAgICAgbW46IFwibW5fTU5cIixcbiAgICAgICAgbmI6IFwibmJfTk9cIixcbiAgICAgICAgbmw6IFwibmxfTkxcIixcbiAgICAgICAgbm46IFwibm4tTk9cIixcbiAgICAgICAgcGw6IFwicGxfUExcIixcbiAgICAgICAgcHQ6IFwicHRfUFRcIixcbiAgICAgICAgcm86IFwicm9fUk9cIixcbiAgICAgICAgcnU6IFwicnVfUlVcIixcbiAgICAgICAgc2s6IFwic2tfU0tcIixcbiAgICAgICAgc2w6IFwic2xfU0lcIixcbiAgICAgICAgc3I6IFwic3JfUlNcIixcbiAgICAgICAgc3Y6IFwic3ZfU0VcIixcbiAgICAgICAgdGg6IFwidGhfVEhcIixcbiAgICAgICAgdHI6IFwidHJfVFJcIixcbiAgICAgICAgdWs6IFwidWtfVUFcIixcbiAgICAgICAgdmk6IFwidmlfVk5cIixcbiAgICAgICAgemg6IFwiemhfQ05cIlxuICAgIH0sXG4gICAgU1VQRVJTQ1JJUFRTOiB7XG4gICAgICAgIFwiXFx1MDBBQVwiOiBcIlxcdTAwNjFcIixcbiAgICAgICAgXCJcXHUwMEIyXCI6IFwiXFx1MDAzMlwiLFxuICAgICAgICBcIlxcdTAwQjNcIjogXCJcXHUwMDMzXCIsXG4gICAgICAgIFwiXFx1MDBCOVwiOiBcIlxcdTAwMzFcIixcbiAgICAgICAgXCJcXHUwMEJBXCI6IFwiXFx1MDA2RlwiLFxuICAgICAgICBcIlxcdTAyQjBcIjogXCJcXHUwMDY4XCIsXG4gICAgICAgIFwiXFx1MDJCMVwiOiBcIlxcdTAyNjZcIixcbiAgICAgICAgXCJcXHUwMkIyXCI6IFwiXFx1MDA2QVwiLFxuICAgICAgICBcIlxcdTAyQjNcIjogXCJcXHUwMDcyXCIsXG4gICAgICAgIFwiXFx1MDJCNFwiOiBcIlxcdTAyNzlcIixcbiAgICAgICAgXCJcXHUwMkI1XCI6IFwiXFx1MDI3QlwiLFxuICAgICAgICBcIlxcdTAyQjZcIjogXCJcXHUwMjgxXCIsXG4gICAgICAgIFwiXFx1MDJCN1wiOiBcIlxcdTAwNzdcIixcbiAgICAgICAgXCJcXHUwMkI4XCI6IFwiXFx1MDA3OVwiLFxuICAgICAgICBcIlxcdTAyRTBcIjogXCJcXHUwMjYzXCIsXG4gICAgICAgIFwiXFx1MDJFMVwiOiBcIlxcdTAwNkNcIixcbiAgICAgICAgXCJcXHUwMkUyXCI6IFwiXFx1MDA3M1wiLFxuICAgICAgICBcIlxcdTAyRTNcIjogXCJcXHUwMDc4XCIsXG4gICAgICAgIFwiXFx1MDJFNFwiOiBcIlxcdTAyOTVcIixcbiAgICAgICAgXCJcXHUxRDJDXCI6IFwiXFx1MDA0MVwiLFxuICAgICAgICBcIlxcdTFEMkRcIjogXCJcXHUwMEM2XCIsXG4gICAgICAgIFwiXFx1MUQyRVwiOiBcIlxcdTAwNDJcIixcbiAgICAgICAgXCJcXHUxRDMwXCI6IFwiXFx1MDA0NFwiLFxuICAgICAgICBcIlxcdTFEMzFcIjogXCJcXHUwMDQ1XCIsXG4gICAgICAgIFwiXFx1MUQzMlwiOiBcIlxcdTAxOEVcIixcbiAgICAgICAgXCJcXHUxRDMzXCI6IFwiXFx1MDA0N1wiLFxuICAgICAgICBcIlxcdTFEMzRcIjogXCJcXHUwMDQ4XCIsXG4gICAgICAgIFwiXFx1MUQzNVwiOiBcIlxcdTAwNDlcIixcbiAgICAgICAgXCJcXHUxRDM2XCI6IFwiXFx1MDA0QVwiLFxuICAgICAgICBcIlxcdTFEMzdcIjogXCJcXHUwMDRCXCIsXG4gICAgICAgIFwiXFx1MUQzOFwiOiBcIlxcdTAwNENcIixcbiAgICAgICAgXCJcXHUxRDM5XCI6IFwiXFx1MDA0RFwiLFxuICAgICAgICBcIlxcdTFEM0FcIjogXCJcXHUwMDRFXCIsXG4gICAgICAgIFwiXFx1MUQzQ1wiOiBcIlxcdTAwNEZcIixcbiAgICAgICAgXCJcXHUxRDNEXCI6IFwiXFx1MDIyMlwiLFxuICAgICAgICBcIlxcdTFEM0VcIjogXCJcXHUwMDUwXCIsXG4gICAgICAgIFwiXFx1MUQzRlwiOiBcIlxcdTAwNTJcIixcbiAgICAgICAgXCJcXHUxRDQwXCI6IFwiXFx1MDA1NFwiLFxuICAgICAgICBcIlxcdTFENDFcIjogXCJcXHUwMDU1XCIsXG4gICAgICAgIFwiXFx1MUQ0MlwiOiBcIlxcdTAwNTdcIixcbiAgICAgICAgXCJcXHUxRDQzXCI6IFwiXFx1MDA2MVwiLFxuICAgICAgICBcIlxcdTFENDRcIjogXCJcXHUwMjUwXCIsXG4gICAgICAgIFwiXFx1MUQ0NVwiOiBcIlxcdTAyNTFcIixcbiAgICAgICAgXCJcXHUxRDQ2XCI6IFwiXFx1MUQwMlwiLFxuICAgICAgICBcIlxcdTFENDdcIjogXCJcXHUwMDYyXCIsXG4gICAgICAgIFwiXFx1MUQ0OFwiOiBcIlxcdTAwNjRcIixcbiAgICAgICAgXCJcXHUxRDQ5XCI6IFwiXFx1MDA2NVwiLFxuICAgICAgICBcIlxcdTFENEFcIjogXCJcXHUwMjU5XCIsXG4gICAgICAgIFwiXFx1MUQ0QlwiOiBcIlxcdTAyNUJcIixcbiAgICAgICAgXCJcXHUxRDRDXCI6IFwiXFx1MDI1Q1wiLFxuICAgICAgICBcIlxcdTFENERcIjogXCJcXHUwMDY3XCIsXG4gICAgICAgIFwiXFx1MUQ0RlwiOiBcIlxcdTAwNkJcIixcbiAgICAgICAgXCJcXHUxRDUwXCI6IFwiXFx1MDA2RFwiLFxuICAgICAgICBcIlxcdTFENTFcIjogXCJcXHUwMTRCXCIsXG4gICAgICAgIFwiXFx1MUQ1MlwiOiBcIlxcdTAwNkZcIixcbiAgICAgICAgXCJcXHUxRDUzXCI6IFwiXFx1MDI1NFwiLFxuICAgICAgICBcIlxcdTFENTRcIjogXCJcXHUxRDE2XCIsXG4gICAgICAgIFwiXFx1MUQ1NVwiOiBcIlxcdTFEMTdcIixcbiAgICAgICAgXCJcXHUxRDU2XCI6IFwiXFx1MDA3MFwiLFxuICAgICAgICBcIlxcdTFENTdcIjogXCJcXHUwMDc0XCIsXG4gICAgICAgIFwiXFx1MUQ1OFwiOiBcIlxcdTAwNzVcIixcbiAgICAgICAgXCJcXHUxRDU5XCI6IFwiXFx1MUQxRFwiLFxuICAgICAgICBcIlxcdTFENUFcIjogXCJcXHUwMjZGXCIsXG4gICAgICAgIFwiXFx1MUQ1QlwiOiBcIlxcdTAwNzZcIixcbiAgICAgICAgXCJcXHUxRDVDXCI6IFwiXFx1MUQyNVwiLFxuICAgICAgICBcIlxcdTFENURcIjogXCJcXHUwM0IyXCIsXG4gICAgICAgIFwiXFx1MUQ1RVwiOiBcIlxcdTAzQjNcIixcbiAgICAgICAgXCJcXHUxRDVGXCI6IFwiXFx1MDNCNFwiLFxuICAgICAgICBcIlxcdTFENjBcIjogXCJcXHUwM0M2XCIsXG4gICAgICAgIFwiXFx1MUQ2MVwiOiBcIlxcdTAzQzdcIixcbiAgICAgICAgXCJcXHUyMDcwXCI6IFwiXFx1MDAzMFwiLFxuICAgICAgICBcIlxcdTIwNzFcIjogXCJcXHUwMDY5XCIsXG4gICAgICAgIFwiXFx1MjA3NFwiOiBcIlxcdTAwMzRcIixcbiAgICAgICAgXCJcXHUyMDc1XCI6IFwiXFx1MDAzNVwiLFxuICAgICAgICBcIlxcdTIwNzZcIjogXCJcXHUwMDM2XCIsXG4gICAgICAgIFwiXFx1MjA3N1wiOiBcIlxcdTAwMzdcIixcbiAgICAgICAgXCJcXHUyMDc4XCI6IFwiXFx1MDAzOFwiLFxuICAgICAgICBcIlxcdTIwNzlcIjogXCJcXHUwMDM5XCIsXG4gICAgICAgIFwiXFx1MjA3QVwiOiBcIlxcdTAwMkJcIixcbiAgICAgICAgXCJcXHUyMDdCXCI6IFwiXFx1MjIxMlwiLFxuICAgICAgICBcIlxcdTIwN0NcIjogXCJcXHUwMDNEXCIsXG4gICAgICAgIFwiXFx1MjA3RFwiOiBcIlxcdTAwMjhcIixcbiAgICAgICAgXCJcXHUyMDdFXCI6IFwiXFx1MDAyOVwiLFxuICAgICAgICBcIlxcdTIwN0ZcIjogXCJcXHUwMDZFXCIsXG4gICAgICAgIFwiXFx1MjEyMFwiOiBcIlxcdTAwNTNcXHUwMDREXCIsXG4gICAgICAgIFwiXFx1MjEyMlwiOiBcIlxcdTAwNTRcXHUwMDREXCIsXG4gICAgICAgIFwiXFx1MzE5MlwiOiBcIlxcdTRFMDBcIixcbiAgICAgICAgXCJcXHUzMTkzXCI6IFwiXFx1NEU4Q1wiLFxuICAgICAgICBcIlxcdTMxOTRcIjogXCJcXHU0RTA5XCIsXG4gICAgICAgIFwiXFx1MzE5NVwiOiBcIlxcdTU2REJcIixcbiAgICAgICAgXCJcXHUzMTk2XCI6IFwiXFx1NEUwQVwiLFxuICAgICAgICBcIlxcdTMxOTdcIjogXCJcXHU0RTJEXCIsXG4gICAgICAgIFwiXFx1MzE5OFwiOiBcIlxcdTRFMEJcIixcbiAgICAgICAgXCJcXHUzMTk5XCI6IFwiXFx1NzUzMlwiLFxuICAgICAgICBcIlxcdTMxOUFcIjogXCJcXHU0RTU5XCIsXG4gICAgICAgIFwiXFx1MzE5QlwiOiBcIlxcdTRFMTlcIixcbiAgICAgICAgXCJcXHUzMTlDXCI6IFwiXFx1NEUwMVwiLFxuICAgICAgICBcIlxcdTMxOURcIjogXCJcXHU1OTI5XCIsXG4gICAgICAgIFwiXFx1MzE5RVwiOiBcIlxcdTU3MzBcIixcbiAgICAgICAgXCJcXHUzMTlGXCI6IFwiXFx1NEVCQVwiLFxuICAgICAgICBcIlxcdTAyQzBcIjogXCJcXHUwMjk0XCIsXG4gICAgICAgIFwiXFx1MDJDMVwiOiBcIlxcdTAyOTVcIixcbiAgICAgICAgXCJcXHUwNkU1XCI6IFwiXFx1MDY0OFwiLFxuICAgICAgICBcIlxcdTA2RTZcIjogXCJcXHUwNjRBXCJcbiAgICB9LFxuICAgIFNVUEVSU0NSSVBUU19SRUdFWFA6IG5ldyBSZWdFeHAoXCJbXFx1MDBBQVxcdTAwQjJcXHUwMEIzXFx1MDBCOVxcdTAwQkFcXHUwMkIwXFx1MDJCMVxcdTAyQjJcXHUwMkIzXFx1MDJCNFxcdTAyQjVcXHUwMkI2XFx1MDJCN1xcdTAyQjhcXHUwMkUwXFx1MDJFMVxcdTAyRTJcXHUwMkUzXFx1MDJFNFxcdTFEMkNcXHUxRDJEXFx1MUQyRVxcdTFEMzBcXHUxRDMxXFx1MUQzMlxcdTFEMzNcXHUxRDM0XFx1MUQzNVxcdTFEMzZcXHUxRDM3XFx1MUQzOFxcdTFEMzlcXHUxRDNBXFx1MUQzQ1xcdTFEM0RcXHUxRDNFXFx1MUQzRlxcdTFENDBcXHUxRDQxXFx1MUQ0MlxcdTFENDNcXHUxRDQ0XFx1MUQ0NVxcdTFENDZcXHUxRDQ3XFx1MUQ0OFxcdTFENDlcXHUxRDRBXFx1MUQ0QlxcdTFENENcXHUxRDREXFx1MUQ0RlxcdTFENTBcXHUxRDUxXFx1MUQ1MlxcdTFENTNcXHUxRDU0XFx1MUQ1NVxcdTFENTZcXHUxRDU3XFx1MUQ1OFxcdTFENTlcXHUxRDVBXFx1MUQ1QlxcdTFENUNcXHUxRDVEXFx1MUQ1RVxcdTFENUZcXHUxRDYwXFx1MUQ2MVxcdTIwNzBcXHUyMDcxXFx1MjA3NFxcdTIwNzVcXHUyMDc2XFx1MjA3N1xcdTIwNzhcXHUyMDc5XFx1MjA3QVxcdTIwN0JcXHUyMDdDXFx1MjA3RFxcdTIwN0VcXHUyMDdGXFx1MjEyMFxcdTIxMjJcXHUzMTkyXFx1MzE5M1xcdTMxOTRcXHUzMTk1XFx1MzE5NlxcdTMxOTdcXHUzMTk4XFx1MzE5OVxcdTMxOUFcXHUzMTlCXFx1MzE5Q1xcdTMxOURcXHUzMTlFXFx1MzE5RlxcdTAyQzBcXHUwMkMxXFx1MDZFNVxcdTA2RTZdXCIsIFwiZ1wiKSxcbiAgICBVUERBVEVfR1JPVVBfQ09OVEVYVF9DT05ESVRJT046IGZ1bmN0aW9uIChzdGF0ZSwgdGVybXR4dCwgdmFsdWVUZXJtKSB7XG4gICAgICAgIGlmIChzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuY29uZGl0aW9uKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmNvbmRpdGlvbi50ZXN0KSB7XG4gICAgICAgICAgICAgICAgdmFyIHRlc3RyZXM7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24udGVzdCA9PT0gXCJlbXB0eS1sYWJlbFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRlc3RyZXMgPSAhdGVybXR4dDtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24udGVzdCA9PT0gXCJjb21tYS1zYWZlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVtcHR5ID0gIXRlcm10eHQ7XG4gICAgICAgICAgICAgICAgICAgIHZhciBhbHBoYSA9IHRlcm10eHQuc2xpY2UoMCwxKS5tYXRjaChDU0wuQUxMX1JPTUFORVNRVUVfUkVHRVhQKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG51bSA9IHN0YXRlLnRtcC5qdXN0X2RpZF9udW1iZXI7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbXB0eSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGVzdHJlcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobnVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxwaGEgJiYgIXZhbHVlVGVybSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RyZXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0cmVzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWxwaGEgJiYgIXZhbHVlVGVybSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RyZXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0cmVzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRlc3RyZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmZvcmNlX3N1cHByZXNzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmZvcmNlX3N1cHByZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24ubm90KSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5mb3JjZV9zdXBwcmVzcyA9ICFzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuZm9yY2Vfc3VwcHJlc3M7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRlcm10eHQuc2xpY2UoLTEpLm1hdGNoKC9bMC05XS8pKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmp1c3RfZGlkX251bWJlciA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5qdXN0X2RpZF9udW1iZXIgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG4gICAgbG9jYWxlOiB7fSxcbiAgICBsb2NhbGVfb3B0czoge30sXG4gICAgbG9jYWxlX2RhdGVzOiB7fVxufTtcbmlmICh0eXBlb2YgcmVxdWlyZSAhPT0gXCJ1bmRlZmluZWRcIiAmJiB0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBcImV4cG9ydHNcIiBpbiBtb2R1bGUpIHtcbiAgICB2YXIgQ1NMX0lTX05PREVKUyA9IHRydWU7XG4gICAgZXhwb3J0cy5DU0wgPSBDU0w7XG59XG5DU0wuVEVSTUlOQUxfUFVOQ1RVQVRJT05fUkVHRVhQID0gbmV3IFJlZ0V4cChcIl4oW1wiICsgQ1NMLlRFUk1JTkFMX1BVTkNUVUFUSU9OLnNsaWNlKDAsIC0xKS5qb2luKFwiXCIpICsgXCJdKSguKilcIik7XG5DU0wuQ0xPU1VSRVMgPSBuZXcgUmVnRXhwKFwiLipbXFxcXF1cXFxcKV1cIik7XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbmlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgY29uc29sZSkge1xuICAgIENTTC5kZWJ1ZyA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgZHVtcChcIkNTTDogXCIgKyBzdHIgKyBcIlxcblwiKTtcbiAgICB9O1xuICAgIENTTC5lcnJvciA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgZHVtcChcIkNTTCBlcnJvcjogXCIgKyBzdHIgKyBcIlxcblwiKTtcbiAgICB9O1xufSBlbHNlIHtcbiAgICBDU0wuZGVidWcgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ1NMOiBcIiArIHN0cik7XG4gICAgfTtcbiAgICBDU0wuZXJyb3IgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ1NMIGVycm9yOiBcIiArIHN0cik7XG4gICAgfTtcbn1cbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlhtbEpTT04gPSBmdW5jdGlvbiAoZGF0YU9iaikge1xuICAgIHRoaXMuZGF0YU9iaiA9IGRhdGFPYmo7XG4gICAgdGhpcy5pbnN0aXR1dGlvbiA9IHtcbiAgICAgICAgbmFtZTpcImluc3RpdHV0aW9uXCIsXG4gICAgICAgIGF0dHJzOntcbiAgICAgICAgICAgIFwiaW5zdGl0dXRpb24tcGFydHNcIjpcImxvbmdcIixcbiAgICAgICAgICAgIFwiZGVsaW1pdGVyXCI6XCIsIFwiLFxuICAgICAgICAgICAgXCJzdWJzdGl0dXRlLXVzZS1maXJzdFwiOlwiMVwiLFxuICAgICAgICAgICAgXCJ1c2UtbGFzdFwiOlwiMVwiXG4gICAgICAgIH0sXG4gICAgICAgIGNoaWxkcmVuOltcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOlwiaW5zdGl0dXRpb24tcGFydFwiLFxuICAgICAgICAgICAgICAgIGF0dHJzOntcbiAgICAgICAgICAgICAgICAgICAgbmFtZTpcImxvbmdcIlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgY2hpbGRyZW46W11cbiAgICAgICAgICAgIH1cbiAgICAgICAgXVxuICAgIH07XG59O1xuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmNsZWFuID0gZnVuY3Rpb24gKGpzb24pIHtcbiAgICByZXR1cm4ganNvbjtcbn07XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuZ2V0U3R5bGVJZCA9IGZ1bmN0aW9uIChteWpzb24sIHN0eWxlTmFtZSkge1xuICAgIHZhciB0YWdOYW1lID0gJ2lkJztcbiAgICBpZiAoc3R5bGVOYW1lKSB7XG4gICAgICAgIHRhZ05hbWUgPSAndGl0bGUnO1xuICAgIH1cbiAgICB2YXIgcmV0ID0gXCJcIjtcbiAgICB2YXIgY2hpbGRyZW4gPSBteWpzb24uY2hpbGRyZW47XG4gICAgZm9yICh2YXIgaT0wLGlsZW49Y2hpbGRyZW4ubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgaWYgKGNoaWxkcmVuW2ldLm5hbWUgPT09ICdpbmZvJykge1xuICAgICAgICAgICAgdmFyIGdyYW5ka2lkcyA9IGNoaWxkcmVuW2ldLmNoaWxkcmVuO1xuICAgICAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49Z3JhbmRraWRzLmxlbmd0aDtqPGpsZW47aisrKSB7XG4gICAgICAgICAgICAgICAgaWYgKGdyYW5ka2lkc1tqXS5uYW1lID09PSB0YWdOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldCA9IGdyYW5ka2lkc1tqXS5jaGlsZHJlblswXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuY2hpbGRyZW4gPSBmdW5jdGlvbiAobXlqc29uKSB7XG4gICAgaWYgKG15anNvbiAmJiBteWpzb24uY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBteWpzb24uY2hpbGRyZW4uc2xpY2UoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufTtcbkNTTC5YbWxKU09OLnByb3RvdHlwZS5ub2RlbmFtZSA9IGZ1bmN0aW9uIChteWpzb24pIHtcbiAgICByZXR1cm4gbXlqc29uID8gbXlqc29uLm5hbWUgOiBudWxsO1xufTtcbkNTTC5YbWxKU09OLnByb3RvdHlwZS5hdHRyaWJ1dGVzID0gZnVuY3Rpb24gKG15anNvbikge1xuICAgIHZhciByZXQgPSB7fTtcbiAgICBmb3IgKHZhciBhdHRybmFtZSBpbiBteWpzb24uYXR0cnMpIHtcbiAgICAgICAgcmV0W1wiQFwiK2F0dHJuYW1lXSA9IG15anNvbi5hdHRyc1thdHRybmFtZV07XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmNvbnRlbnQgPSBmdW5jdGlvbiAobXlqc29uKSB7XG4gICAgdmFyIHJldCA9IFwiXCI7XG4gICAgaWYgKCFteWpzb24gfHwgIW15anNvbi5jaGlsZHJlbikge1xuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgICBmb3IgKHZhciBpPTAsIGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG15anNvbi5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgcmV0ICs9IG15anNvbi5jaGlsZHJlbltpXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5YbWxKU09OLnByb3RvdHlwZS5uYW1lc3BhY2UgPSB7fVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLm51bWJlcm9mbm9kZXMgPSBmdW5jdGlvbiAobXlqc29uKSB7XG4gICAgaWYgKG15anNvbiAmJiBcIm51bWJlclwiID09IHR5cGVvZiBteWpzb24ubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBteWpzb24ubGVuZ3RoO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbn07XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuZ2V0QXR0cmlidXRlVmFsdWUgPSBmdW5jdGlvbiAobXlqc29uLG5hbWUsbmFtZXNwYWNlKSB7XG4gICAgdmFyIHJldCA9IFwiXCI7XG4gICAgaWYgKG5hbWVzcGFjZSkge1xuICAgICAgICBuYW1lID0gbmFtZXNwYWNlK1wiOlwiK25hbWU7XG4gICAgfVxuICAgIGlmIChteWpzb24pIHtcbiAgICAgICAgaWYgKG15anNvbi5hdHRycykge1xuICAgICAgICAgICAgaWYgKG15anNvbi5hdHRyc1tuYW1lXSkge1xuICAgICAgICAgICAgICAgIHJldCA9IG15anNvbi5hdHRyc1tuYW1lXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gXCJcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmdldE5vZGVWYWx1ZSA9IGZ1bmN0aW9uIChteWpzb24sbmFtZSkge1xuICAgIHZhciByZXQgPSBcIlwiO1xuICAgIGlmIChuYW1lKXtcbiAgICAgICAgZm9yICh2YXIgaT0wLCBpbGVuPW15anNvbi5jaGlsZHJlbi5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChteWpzb24uY2hpbGRyZW5baV0ubmFtZSA9PT0gbmFtZSkge1xuICAgICAgICAgICAgICAgIGlmIChteWpzb24uY2hpbGRyZW5baV0uY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldCA9IG15anNvbi5jaGlsZHJlbltpXTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXQgPSBcIlwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gZWxzZSBpZiAobXlqc29uKSB7XG4gICAgICAgIHJldCA9IG15anNvbjtcbiAgICB9XG4gICAgaWYgKHJldCAmJiByZXQuY2hpbGRyZW4gJiYgcmV0LmNoaWxkcmVuLmxlbmd0aCA9PSAxICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiByZXQuY2hpbGRyZW5bMF0pIHtcbiAgICAgICAgcmV0ID0gcmV0LmNoaWxkcmVuWzBdO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLnNldEF0dHJpYnV0ZU9uTm9kZUlkZW50aWZpZWRCeU5hbWVBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobXlqc29uLG5vZGVuYW1lLHBhcnRuYW1lLGF0dHJuYW1lLHZhbCkge1xuICAgIHZhciBwb3MsIGxlbiwgeG1sLCBub2Rlcywgbm9kZTtcbiAgICBpZiAoYXR0cm5hbWUuc2xpY2UoMCwxKSA9PT0gJ0AnKXtcbiAgICAgICAgYXR0cm5hbWUgPSBhdHRybmFtZS5zbGljZSgxKTtcbiAgICB9XG4gICAgZm9yICh2YXIgaT0wLGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDsgaTxpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKG15anNvbi5jaGlsZHJlbltpXS5uYW1lID09PSBub2RlbmFtZSAmJiBteWpzb24uY2hpbGRyZW5baV0uYXR0cnMubmFtZSA9PT0gcGFydG5hbWUpIHtcbiAgICAgICAgICAgIG15anNvbi5jaGlsZHJlbltpXS5hdHRyc1thdHRybmFtZV0gPSB2YWw7XG4gICAgICAgIH1cbiAgICB9XG59XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuZGVsZXRlTm9kZUJ5TmFtZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChteWpzb24sdmFsKSB7XG4gICAgdmFyIGksIGlsZW47XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IG15anNvbi5jaGlsZHJlbi5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKCFteWpzb24uY2hpbGRyZW5baV0gfHwgXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG15anNvbi5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG15anNvbi5jaGlsZHJlbltpXS5hdHRycy5uYW1lID09IHZhbCkge1xuICAgICAgICAgICAgbXlqc29uLmNoaWxkcmVuID0gbXlqc29uLmNoaWxkcmVuLnNsaWNlKDAsaSkuY29uY2F0KG15anNvbi5jaGlsZHJlbi5zbGljZShpKzEpKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbkNTTC5YbWxKU09OLnByb3RvdHlwZS5kZWxldGVBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobXlqc29uLGF0dHJuYW1lKSB7XG4gICAgdmFyIGksIGlsZW47XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiBteWpzb24uYXR0cnNbYXR0cm5hbWVdKSB7XG4gICAgICAgIG15anNvbi5hdHRycy5wb3AoYXR0cm5hbWUpO1xuICAgIH1cbn1cbkNTTC5YbWxKU09OLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobXlqc29uLGF0dHIsdmFsKSB7XG4gICAgbXlqc29uLmF0dHJzW2F0dHJdID0gdmFsO1xuICAgIHJldHVybiBmYWxzZTtcbn1cbkNTTC5YbWxKU09OLnByb3RvdHlwZS5ub2RlQ29weSA9IGZ1bmN0aW9uIChteWpzb24sY2xvbmUpIHtcbiAgICBpZiAoIWNsb25lKSB7XG4gICAgICAgIHZhciBjbG9uZSA9IHt9O1xuICAgIH1cbiAgICBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIGNsb25lICYmIFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBjbG9uZS5sZW5ndGgpIHtcbiAgICAgICAgZm9yICh2YXIga2V5IGluIG15anNvbikge1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBteWpzb25ba2V5XSkge1xuICAgICAgICAgICAgICAgIGNsb25lW2tleV0gPSBteWpzb25ba2V5XTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIG15anNvbltrZXldKSB7XG4gICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBteWpzb25ba2V5XS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xvbmVba2V5XSA9IHRoaXMubm9kZUNvcHkobXlqc29uW2tleV0se30pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNsb25lW2tleV0gPSB0aGlzLm5vZGVDb3B5KG15anNvbltrZXldLFtdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1teWpzb24ubGVuZ3RoO2k8aWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG15anNvbltpXSkge1xuICAgICAgICAgICAgICAgIGNsb25lW2ldID0gbXlqc29uW2ldO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjbG9uZVtpXSA9IHRoaXMubm9kZUNvcHkobXlqc29uW2ldLHt9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gY2xvbmU7XG59XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuZ2V0Tm9kZXNCeU5hbWUgPSBmdW5jdGlvbiAobXlqc29uLG5hbWUsbmFtZWF0dHJ2YWwscmV0KSB7XG4gICAgdmFyIG5vZGVzLCBub2RlLCBwb3MsIGxlbjtcbiAgICBpZiAoIXJldCkge1xuICAgICAgICB2YXIgcmV0ID0gW107XG4gICAgfVxuICAgIGlmICghbXlqc29uIHx8ICFteWpzb24uY2hpbGRyZW4pIHtcbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG4gICAgaWYgKG5hbWUgPT09IG15anNvbi5uYW1lKSB7XG4gICAgICAgIGlmIChuYW1lYXR0cnZhbCkge1xuICAgICAgICAgICAgaWYgKG5hbWVhdHRydmFsID09PSBteWpzb24uYXR0cnMubmFtZSkge1xuICAgICAgICAgICAgICAgIHJldC5wdXNoKG15anNvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXQucHVzaChteWpzb24pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPW15anNvbi5jaGlsZHJlbi5sZW5ndGg7aTxpbGVuO2krPTEpe1xuICAgICAgICBpZiAoXCJvYmplY3RcIiAhPT0gdHlwZW9mIG15anNvbi5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5nZXROb2Rlc0J5TmFtZShteWpzb24uY2hpbGRyZW5baV0sbmFtZSxuYW1lYXR0cnZhbCxyZXQpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLm5vZGVOYW1lSXMgPSBmdW5jdGlvbiAobXlqc29uLG5hbWUpIHtcbiAgICBpZiAodHlwZW9mIG15anNvbiA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChuYW1lID09IG15anNvbi5uYW1lKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUubWFrZVhtbCA9IGZ1bmN0aW9uIChteWpzb24pIHtcbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG15anNvbikge1xuICAgICAgICBpZiAobXlqc29uLnNsaWNlKDAsIDEpID09PSBcIjxcIikge1xuICAgICAgICAgICAgbXlqc29uID0gdGhpcy5qc29uU3RyaW5nV2Fsa2VyLndhbGtUb09iamVjdChteWpzb24pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbXlqc29uID0gSlNPTi5wYXJzZShteWpzb24pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBteWpzb247XG59O1xuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmluc2VydENoaWxkTm9kZUFmdGVyID0gZnVuY3Rpb24gKHBhcmVudCxub2RlLHBvcyxkYXRlanNvbikge1xuICAgIGZvciAodmFyIGk9MCxpbGVuPXBhcmVudC5jaGlsZHJlbi5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgaWYgKG5vZGUgPT09IHBhcmVudC5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuID0gcGFyZW50LmNoaWxkcmVuLnNsaWNlKDAsaSkuY29uY2F0KFtkYXRlanNvbl0pLmNvbmNhdChwYXJlbnQuY2hpbGRyZW4uc2xpY2UoaSsxKSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGFyZW50O1xufTtcbkNTTC5YbWxKU09OLnByb3RvdHlwZS5pbnNlcnRQdWJsaXNoZXJBbmRQbGFjZSA9IGZ1bmN0aW9uKG15anNvbikge1xuICAgIGlmIChteWpzb24ubmFtZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICAgIHZhciB1c2VtZSA9IHRydWU7XG4gICAgICAgIHZhciBtdXN0SGF2ZXMgPSBbXCJwdWJsaXNoZXJcIixcInB1Ymxpc2hlci1wbGFjZVwiXTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgdmFyIGhhdmVWYXJuYW1lID0gbXVzdEhhdmVzLmluZGV4T2YobXlqc29uLmNoaWxkcmVuW2ldLmF0dHJzLnZhcmlhYmxlKTtcbiAgICAgICAgICAgIHZhciBpc1RleHQgPSBteWpzb24uY2hpbGRyZW5baV0ubmFtZSA9PT0gXCJ0ZXh0XCI7XG4gICAgICAgICAgICBpZiAoaXNUZXh0ICYmIGhhdmVWYXJuYW1lID4gLTEgJiYgIW15anNvbi5jaGlsZHJlbltpXS5hdHRycy5wcmVmaXggJiYgIW15anNvbi5jaGlsZHJlbltpXS5hdHRycy5zdWZmaXgpIHtcbiAgICAgICAgICAgICAgICBtdXN0SGF2ZXMgPSBtdXN0SGF2ZXMuc2xpY2UoMCxoYXZlVmFybmFtZSkuY29uY2F0KG11c3RIYXZlcy5zbGljZShoYXZlVmFybmFtZSsxKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHVzZW1lID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHVzZW1lICYmICFtdXN0SGF2ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICBteWpzb24uYXR0cnNbXCJoYXMtcHVibGlzaGVyLWFuZC1wdWJsaXNoZXItcGxhY2VcIl0gPSB0cnVlO1xuICAgICAgIH1cbiAgICB9XG4gICAgZm9yICh2YXIgaT0wLGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIG15anNvbi5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgdGhpcy5pbnNlcnRQdWJsaXNoZXJBbmRQbGFjZShteWpzb24uY2hpbGRyZW5baV0pO1xuICAgICAgICB9XG4gICAgfSAgICBcbn1cbkNTTC5YbWxKU09OLnByb3RvdHlwZS5pc0NoaWxkT2ZTdWJzdGl0dXRlID0gZnVuY3Rpb24ocGFyZW50cykge1xuICAgIGlmIChwYXJlbnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdmFyIG15cGFyZW50cyA9IHBhcmVudHMuc2xpY2UoKTtcbiAgICAgICAgdmFyIHBhcmVudCA9IG15cGFyZW50cy5wb3AoKTtcbiAgICAgICAgaWYgKHBhcmVudCA9PT0gXCJzdWJzdGl0dXRlXCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNDaGlsZE9mU3Vic3RpdHV0ZShteXBhcmVudHMpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn07XG5DU0wuWG1sSlNPTi5wcm90b3R5cGUuYWRkTWlzc2luZ05hbWVOb2RlcyA9IGZ1bmN0aW9uKG15anNvbixwYXJlbnRzKSB7XG4gICAgaWYgKCFwYXJlbnRzKSB7XG4gICAgICAgIHBhcmVudHMgPSBbXTtcbiAgICB9XG4gICAgaWYgKG15anNvbi5uYW1lID09PSBcIm5hbWVzXCIpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzQ2hpbGRPZlN1YnN0aXR1dGUocGFyZW50cykpIHtcbiAgICAgICAgICAgIHZhciBhZGROYW1lID0gdHJ1ZTtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPW15anNvbi5jaGlsZHJlbi5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgICAgIGlmIChteWpzb24uY2hpbGRyZW5baV0ubmFtZSA9PT0gXCJuYW1lXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkTmFtZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYWRkTmFtZSkge1xuICAgICAgICAgICAgICAgIG15anNvbi5jaGlsZHJlbiA9IFt7bmFtZTpcIm5hbWVcIixhdHRyczp7fSxjaGlsZHJlbjpbXX1dLmNvbmNhdChteWpzb24uY2hpbGRyZW4pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHBhcmVudHMucHVzaChteWpzb24ubmFtZSk7XG4gICAgZm9yICh2YXIgaT0wLGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICBpZiAoXCJvYmplY3RcIiA9PT0gdHlwZW9mIG15anNvbi5jaGlsZHJlbltpXSkge1xuICAgICAgICAgICAgdGhpcy5hZGRNaXNzaW5nTmFtZU5vZGVzKG15anNvbi5jaGlsZHJlbltpXSxwYXJlbnRzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwYXJlbnRzLnBvcCgpO1xufVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmFkZEluc3RpdHV0aW9uTm9kZXMgPSBmdW5jdGlvbihteWpzb24pIHtcbiAgICB2YXIgbmFtZXMsIHRoZW5hbWVzLCBpbnN0aXR1dGlvbiwgdGhlaW5zdGl0dXRpb24sIG5hbWUsIHRoZW5hbWUsIHhtbCwgcG9zLCBsZW47XG4gICAgaWYgKG15anNvbi5uYW1lID09PSBcIm5hbWVzXCIpIHtcbiAgICAgICAgdmFyIGF0dHJpYnV0ZXMgPSB7fTtcbiAgICAgICAgdmFyIGluc2VydFBvcyA9IC0xO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1teWpzb24uY2hpbGRyZW4ubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICBpZiAobXlqc29uLmNoaWxkcmVuW2ldLm5hbWUgPT0gXCJuYW1lXCIpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbXlqc29uLmNoaWxkcmVuW2ldLmF0dHJzKSB7XG4gICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXNba2V5XSA9IG15anNvbi5jaGlsZHJlbltpXS5hdHRyc1trZXldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLmRlbGltaXRlciA9IG15anNvbi5jaGlsZHJlbltpXS5hdHRycy5kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgYXR0cmlidXRlcy5hbmQgPSBteWpzb24uY2hpbGRyZW5baV0uYXR0cnMuYW5kO1xuICAgICAgICAgICAgICAgIGluc2VydFBvcyA9IGk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaz0wLGtsZW49bXlqc29uLmNoaWxkcmVuW2ldLmNoaWxkcmVuLmxlbmd0aDtrPGtsZW47ays9MSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAobXlqc29uLmNoaWxkcmVuW2ldLmNoaWxkcmVuW2tdLmF0dHJzLm5hbWUgIT09ICdmYW1pbHknKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbXlqc29uLmNoaWxkcmVuW2ldLmNoaWxkcmVuW2tdLmF0dHJzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzW2tleV0gPSBteWpzb24uY2hpbGRyZW5baV0uY2hpbGRyZW5ba10uYXR0cnNba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChteWpzb24uY2hpbGRyZW5baV0ubmFtZSA9PSBcImluc3RpdHV0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICBpbnNlcnRQb3MgPSAtMTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoaW5zZXJ0UG9zID4gLTEpIHtcbiAgICAgICAgICAgIHZhciBpbnN0aXR1dGlvbiA9IHRoaXMubm9kZUNvcHkodGhpcy5pbnN0aXR1dGlvbik7XG4gICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbiA9IENTTC5JTlNUSVRVVElPTl9LRVlTLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgICAgIHZhciBhdHRybmFtZSA9IENTTC5JTlNUSVRVVElPTl9LRVlTW2ldO1xuICAgICAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgYXR0cmlidXRlc1thdHRybmFtZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGl0dXRpb24uY2hpbGRyZW5bMF0uYXR0cnNbYXR0cm5hbWVdID0gYXR0cmlidXRlc1thdHRybmFtZV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmRlbGltaXRlcikge1xuICAgICAgICAgICAgICAgICAgICBpbnN0aXR1dGlvbi5hdHRycy5kZWxpbWl0ZXIgPSBhdHRyaWJ1dGVzLmRlbGltaXRlcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuYW5kKSB7XG4gICAgICAgICAgICAgICAgICAgIGluc3RpdHV0aW9uLmF0dHJzLmFuZCA9IFwidGV4dFwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG15anNvbi5jaGlsZHJlbiA9IG15anNvbi5jaGlsZHJlbi5zbGljZSgwLGluc2VydFBvcysxKS5jb25jYXQoW2luc3RpdHV0aW9uXSkuY29uY2F0KG15anNvbi5jaGlsZHJlbi5zbGljZShpbnNlcnRQb3MrMSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPW15anNvbi5jaGlsZHJlbi5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBteWpzb24uY2hpbGRyZW5baV0pIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuYWRkSW5zdGl0dXRpb25Ob2RlcyhteWpzb24uY2hpbGRyZW5baV0pO1xuICAgIH1cbn1cbkNTTC5YbWxKU09OLnByb3RvdHlwZS5mbGFnRGF0ZU1hY3JvcyA9IGZ1bmN0aW9uKG15anNvbikge1xuICAgIGZvciAodmFyIGk9MCxpbGVuPW15anNvbi5jaGlsZHJlbi5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgaWYgKG15anNvbi5jaGlsZHJlbltpXS5uYW1lID09PSBcIm1hY3JvXCIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmluc3BlY3REYXRlTWFjcm9zKG15anNvbi5jaGlsZHJlbltpXSkpIHtcbiAgICAgICAgICAgICAgICBteWpzb24uY2hpbGRyZW5baV0uYXR0cnNbXCJtYWNyby1oYXMtZGF0ZVwiXSA9IFwidHJ1ZVwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuQ1NMLlhtbEpTT04ucHJvdG90eXBlLmluc3BlY3REYXRlTWFjcm9zID0gZnVuY3Rpb24obXlqc29uKSB7XG4gICAgaWYgKCFteWpzb24gfHwgIW15anNvbi5jaGlsZHJlbikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChteWpzb24ubmFtZSA9PT0gXCJkYXRlXCIpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bXlqc29uLmNoaWxkcmVuLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuaW5zcGVjdERhdGVNYWNyb3MobXlqc29uLmNoaWxkcmVuW2ldKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cbkNTTC5zdHJpcFhtbFByb2Nlc3NpbmdJbnN0cnVjdGlvbiA9IGZ1bmN0aW9uICh4bWwpIHtcbiAgICBpZiAoIXhtbCkge1xuICAgICAgICByZXR1cm4geG1sO1xuICAgIH1cbiAgICB4bWwgPSB4bWwucmVwbGFjZSgvXjxcXD9bXj9dK1xcPz4vLCBcIlwiKTtcbiAgICB4bWwgPSB4bWwucmVwbGFjZSgvPCEtLVtePl0rLS0+L2csIFwiXCIpO1xuICAgIHhtbCA9IHhtbC5yZXBsYWNlKC9eXFxzKy9nLCBcIlwiKTtcbiAgICB4bWwgPSB4bWwucmVwbGFjZSgvXFxzKyQvZywgXCJcIik7XG4gICAgcmV0dXJuIHhtbDtcbn07XG5DU0wucGFyc2VYbWwgPSBmdW5jdGlvbihzdHIpIHtcbiAgICB2YXIgX3BvcyA9IDA7XG4gICAgdmFyIF9vYmogPSB7Y2hpbGRyZW46W119O1xuICAgIHZhciBfc3RhY2sgPSBbX29iai5jaGlsZHJlbl07XG4gICAgZnVuY3Rpb24gX2xpc3RpZnlTdHJpbmcoc3RyKSB7XG4gICAgICAgIHN0ciA9IHN0ci5zcGxpdCgvKD86XFxyXFxufFxcbnxcXHIpLykuam9pbihcIiBcIikucmVwbGFjZSgvPltcdCBdKzwvZywgXCI+PFwiKS5yZXBsYWNlKC88XFwhLS0uKj8tLT4vZywgXCJcIik7XG4gICAgICAgIHZhciBsc3QgPSBzdHIuc3BsaXQoXCI+PFwiKTtcbiAgICAgICAgdmFyIHN0eWxlUG9zID0gbnVsbDtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bHN0Lmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICBpZiAoaSA+IDApIHtcbiAgICAgICAgICAgICAgICBsc3RbaV0gPSBcIjxcIiArIGxzdFtpXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpIDwgKGxzdC5sZW5ndGgtMSkpIHtcbiAgICAgICAgICAgICAgICBsc3RbaV0gPSBsc3RbaV0gKyBcIj5cIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChcIm51bWJlclwiICE9IHR5cGVvZiBzdHlsZVBvcykge1xuICAgICAgICAgICAgICAgIGlmIChsc3RbaV0uc2xpY2UoMCwgNykgPT09IFwiPHN0eWxlIFwiIHx8IGxzdFtpXS5zbGljZSgwLCA4KSA9PSBcIjxsb2NhbGUgXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgc3R5bGVQb3MgPSBpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsc3QgPSBsc3Quc2xpY2Uoc3R5bGVQb3MpO1xuICAgICAgICBmb3IgKHZhciBpPWxzdC5sZW5ndGgtMjtpPi0xO2ktLSkge1xuICAgICAgICAgICAgaWYgKGxzdFtpXS5zbGljZSgxKS5pbmRleE9mKFwiPFwiKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICB2YXIgc3R1YiA9IGxzdFtpXS5zbGljZSgwLCA1KTtcbiAgICAgICAgICAgICAgICBpZiAoc3R1YiA9PT0gXCI8dGVybVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsc3RbaSsxXS5zbGljZSgwLCA2KSA9PT0gXCI8L3Rlcm1cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbHN0W2ldID0gbHN0W2ldICsgbHN0W2krMV07XG4gICAgICAgICAgICAgICAgICAgICAgICBsc3QgPSBsc3Quc2xpY2UoMCwgaSsxKS5jb25jYXQobHN0LnNsaWNlKGkrMikpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChbXCI8c2luZ1wiLCBcIjxtdWx0XCJdLmluZGV4T2Yoc3R1YikgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAobHN0W2ldLnNsaWNlKC0yKSAhPT0gXCIvPlwiICYmIGxzdFtpKzFdLnNsaWNlKDAsIDEpID09PSBcIjxcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbHN0W2ldID0gbHN0W2ldICsgbHN0W2krMV07XG4gICAgICAgICAgICAgICAgICAgICAgICBsc3QgPSBsc3Quc2xpY2UoMCwgaSsxKS5jb25jYXQobHN0LnNsaWNlKGkrMikpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsc3Q7XG4gICAgfVxuICAgIGZ1bmN0aW9uIF9kZWNvZGVIdG1sRW50aXRpZXMoc3RyKSB7XG4gICAgICAgIHJldHVybiBzdHJcbiAgICAgICAgICAgIC5zcGxpdChcIiZhbXA7XCIpLmpvaW4oXCImXCIpXG4gICAgICAgICAgICAuc3BsaXQoXCImcXVvdDtcIikuam9pbihcIlxcXCJcIilcbiAgICAgICAgICAgIC5zcGxpdChcIiZndDtcIikuam9pbihcIj5cIikuc3BsaXQoXCImbHQ7XCIpLmpvaW4oXCI8XCIpXG4gICAgICAgICAgICAucmVwbGFjZSgvJiMoWzAtOV17MSw2fSk7L2dpLCBmdW5jdGlvbihtYXRjaCwgbnVtU3RyKSB7XG4gICAgICAgICAgICAgICAgdmFyIG51bSA9IHBhcnNlSW50KG51bVN0ciwgMTApOyAvLyByZWFkIG51bSBhcyBub3JtYWwgbnVtYmVyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUobnVtKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAucmVwbGFjZSgvJiN4KFthLWYwLTldezEsNn0pOy9naSwgZnVuY3Rpb24obWF0Y2gsIG51bVN0cil7XG4gICAgICAgICAgICAgICAgdmFyIG51bSA9IHBhcnNlSW50KG51bVN0ciwgMTYpOyAvLyByZWFkIG51bSBhcyBoZXhcbiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShudW0pO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIF9nZXRBdHRyaWJ1dGVzKGVsZW0pIHtcbiAgICAgICAgdmFyIG0gPSBlbGVtLm1hdGNoKC8oW15cXCdcXFwiPVx0IF0rKT0oPzpcXFwiW15cXFwiXSpcXFwifFxcJ1teXFwnXSpcXCcpL2cpO1xuICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bS5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgICAgIG1baV0gPSBtW2ldLnJlcGxhY2UoLz0uKi8sIFwiXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtO1xuICAgIH1cbiAgICBmdW5jdGlvbiBfZ2V0QXR0cmlidXRlKGVsZW0sIGF0dHIpIHtcbiAgICAgICAgdmFyIHJleCA9IFJlZ0V4cCgnXi4qW1x0IF0rJyArIGF0dHIgKyAnPShcXFwiKD86W15cXFwiXSopXFxcInxcXCcoPzpbXlxcJ10qKVxcJykuKiQnKTtcbiAgICAgICAgdmFyIG0gPSBlbGVtLm1hdGNoKHJleCk7XG4gICAgICAgIHJldHVybiBtID8gbVsxXS5zbGljZSgxLCAtMSkgOiBudWxsO1xuICAgIH1cbiAgICBmdW5jdGlvbiBfZ2V0VGFnTmFtZShlbGVtKSB7XG4gICAgICAgIHZhciByZXggPSBSZWdFeHAoXCJePChbXlx0IC8+XSspXCIpO1xuICAgICAgICB2YXIgbSA9IGVsZW0ubWF0Y2gocmV4KTtcbiAgICAgICAgcmV0dXJuIG0gPyBtWzFdIDogbnVsbDtcbiAgICB9XG4gICAgZnVuY3Rpb24gX2Nhc3RPYmplY3RGcm9tT3BlbmluZ1RhZyhlbGVtKSB7XG4gICAgICAgIHZhciBvYmogPSB7fTtcbiAgICAgICAgb2JqLm5hbWUgPSBfZ2V0VGFnTmFtZShlbGVtKTtcbiAgICAgICAgb2JqLmF0dHJzID0ge307XG4gICAgICAgIHZhciBhdHRyaWJ1dGVzID0gX2dldEF0dHJpYnV0ZXMoZWxlbSk7XG4gICAgICAgIGlmIChhdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1hdHRyaWJ1dGVzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIGF0dHIgPSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IGF0dHJpYnV0ZXNbaV0sXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBfZ2V0QXR0cmlidXRlKGVsZW0sIGF0dHJpYnV0ZXNbaV0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG9iai5hdHRyc1thdHRyLm5hbWVdID0gX2RlY29kZUh0bWxFbnRpdGllcyhhdHRyLnZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBvYmouY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgcmV0dXJuIG9iajtcbiAgICB9XG4gICAgZnVuY3Rpb24gX2V4dHJhY3RUZXh0RnJvbUNvbXBvc2l0ZUVsZW1lbnQoZWxlbSkge1xuICAgICAgICB2YXIgbSA9IGVsZW0ubWF0Y2goL14uKj4oW148XSopPC4qJC8pO1xuICAgICAgICByZXR1cm4gX2RlY29kZUh0bWxFbnRpdGllcyhtWzFdKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gX2FwcGVuZFRvQ2hpbGRyZW4ob2JqKSB7XG4gICAgICAgIF9zdGFjay5zbGljZSgtMSlbMF0ucHVzaChvYmopO1xuICAgIH1cbiAgICBmdW5jdGlvbiBfZXh0ZW5kU3RhY2tXaXRoTmV3Q2hpbGRyZW4ob2JqKSB7XG4gICAgICAgIF9zdGFjay5wdXNoKG9iai5jaGlsZHJlbik7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHByb2Nlc3NFbGVtZW50KGVsZW0pIHtcbiAgICAgICAgdmFyIG9iajtcbiAgICAgICAgaWYgKGVsZW0uc2xpY2UoMSkuaW5kZXhPZignPCcpID4gLTEpIHtcbiAgICAgICAgICAgIHZhciB0YWcgPSBlbGVtLnNsaWNlKDAsIGVsZW0uaW5kZXhPZignPicpKzEpO1xuICAgICAgICAgICAgb2JqID0gX2Nhc3RPYmplY3RGcm9tT3BlbmluZ1RhZyh0YWcpO1xuICAgICAgICAgICAgb2JqLmNoaWxkcmVuID0gW19leHRyYWN0VGV4dEZyb21Db21wb3NpdGVFbGVtZW50KGVsZW0pXTtcbiAgICAgICAgICAgIF9hcHBlbmRUb0NoaWxkcmVuKG9iaik7XG4gICAgICAgIH0gZWxzZSBpZiAoZWxlbS5zbGljZSgtMikgPT09ICcvPicpIHtcbiAgICAgICAgICAgIG9iaiA9IF9jYXN0T2JqZWN0RnJvbU9wZW5pbmdUYWcoZWxlbSk7XG4gICAgICAgICAgICBpZiAoX2dldFRhZ05hbWUoZWxlbSkgPT09ICd0ZXJtJykge1xuICAgICAgICAgICAgICAgIG9iai5jaGlsZHJlbi5wdXNoKCcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF9hcHBlbmRUb0NoaWxkcmVuKG9iaik7XG4gICAgICAgIH0gZWxzZSBpZiAoZWxlbS5zbGljZSgwLCAyKSA9PT0gJzwvJykge1xuICAgICAgICAgICAgX3N0YWNrLnBvcCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb2JqID0gX2Nhc3RPYmplY3RGcm9tT3BlbmluZ1RhZyhlbGVtKTtcbiAgICAgICAgICAgIF9hcHBlbmRUb0NoaWxkcmVuKG9iailcbiAgICAgICAgICAgIF9leHRlbmRTdGFja1dpdGhOZXdDaGlsZHJlbihvYmopO1xuICAgICAgICB9XG4gICAgfVxuICAgIHZhciBsc3QgPSBfbGlzdGlmeVN0cmluZyhzdHIpO1xuICAgIGZvciAodmFyIGk9MCxpbGVuPWxzdC5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICB2YXIgZWxlbSA9IGxzdFtpXTtcbiAgICAgICAgcHJvY2Vzc0VsZW1lbnQoZWxlbSk7XG4gICAgfVxuICAgIHJldHVybiBfb2JqLmNoaWxkcmVuWzBdO1xufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuWG1sRE9NID0gZnVuY3Rpb24gKGRhdGFPYmopIHtcbiAgICB0aGlzLmRhdGFPYmogPSBkYXRhT2JqO1xuICAgIGlmIChcInVuZGVmaW5lZFwiID09IHR5cGVvZiBET01QYXJzZXIpIHtcbiAgICAgICAgRE9NUGFyc2VyID0gZnVuY3Rpb24oKSB7fTtcbiAgICAgICAgRE9NUGFyc2VyLnByb3RvdHlwZS5wYXJzZUZyb21TdHJpbmcgPSBmdW5jdGlvbihzdHIsIGNvbnRlbnRUeXBlKSB7XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2YgQWN0aXZlWE9iamVjdCkge1xuICAgICAgICAgICAgICAgIHZhciB4bWxkYXRhID0gbmV3IEFjdGl2ZVhPYmplY3QoJ01TWE1MLkRvbURvY3VtZW50Jyk7XG4gICAgICAgICAgICAgICAgeG1sZGF0YS5hc3luYyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHhtbGRhdGEubG9hZFhNTChzdHIpO1xuICAgICAgICAgICAgICAgIHJldHVybiB4bWxkYXRhO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChcInVuZGVmaW5lZFwiICE9IHR5cGVvZiBYTUxIdHRwUmVxdWVzdCkge1xuICAgICAgICAgICAgICAgIHZhciB4bWxkYXRhID0gbmV3IFhNTEh0dHBSZXF1ZXN0O1xuICAgICAgICAgICAgICAgIGlmICghY29udGVudFR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudFR5cGUgPSAndGV4dC94bWwnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB4bWxkYXRhLm9wZW4oJ0dFVCcsICdkYXRhOicgKyBjb250ZW50VHlwZSArICc7Y2hhcnNldD11dGYtOCwnICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0ciksIGZhbHNlKTtcbiAgICAgICAgICAgICAgICBpZih4bWxkYXRhLm92ZXJyaWRlTWltZVR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgeG1sZGF0YS5vdmVycmlkZU1pbWVUeXBlKGNvbnRlbnRUeXBlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgeG1sZGF0YS5zZW5kKG51bGwpO1xuICAgICAgICAgICAgICAgIHJldHVybiB4bWxkYXRhLnJlc3BvbnNlWE1MO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChcInVuZGVmaW5lZFwiICE9IHR5cGVvZiBtYXJrbm90ZSkge1xuICAgICAgICAgICAgICAgIHZhciBwYXJzZXIgPSBuZXcgbWFya25vdGUuUGFyc2VyKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlci5wYXJzZShzdHIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmhhc0F0dHJpYnV0ZXMgPSBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICAgICAgdmFyIHJldDtcbiAgICAgICAgICAgIGlmIChub2RlLmF0dHJpYnV0ZXMgJiYgbm9kZS5hdHRyaWJ1dGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHJldCA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmhhc0F0dHJpYnV0ZXMgPSBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICAgICAgdmFyIHJldDtcbiAgICAgICAgICAgIGlmIChub2RlLmF0dHJpYnV0ZXMgJiYgbm9kZS5hdHRyaWJ1dGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHJldCA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgfTtcbiAgICB9XG4gICAgdGhpcy5pbXBvcnROb2RlID0gZnVuY3Rpb24gKGRvYywgc3JjRWxlbWVudCkge1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PSB0eXBlb2YgZG9jLmltcG9ydE5vZGUpIHtcbiAgICAgICAgICAgIHZhciByZXQgPSB0aGlzLl9pbXBvcnROb2RlKGRvYywgc3JjRWxlbWVudCwgdHJ1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YXIgcmV0ID0gZG9jLmltcG9ydE5vZGUoc3JjRWxlbWVudCwgdHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuICAgIHRoaXMuX2ltcG9ydE5vZGUgPSBmdW5jdGlvbihkb2MsIG5vZGUsIGFsbENoaWxkcmVuKSB7XG4gICAgICAgIHN3aXRjaCAobm9kZS5ub2RlVHlwZSkge1xuICAgICAgICAgICAgY2FzZSAxOlxuICAgICAgICAgICAgICAgIHZhciBuZXdOb2RlID0gZG9jLmNyZWF0ZUVsZW1lbnQobm9kZS5ub2RlTmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGUuYXR0cmlidXRlcyAmJiBub2RlLmF0dHJpYnV0ZXMubGVuZ3RoID4gMClcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsID0gbm9kZS5hdHRyaWJ1dGVzLmxlbmd0aDsgaSA8IGlsOylcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld05vZGUuc2V0QXR0cmlidXRlKG5vZGUuYXR0cmlidXRlc1tpXS5ub2RlTmFtZSwgbm9kZS5nZXRBdHRyaWJ1dGUobm9kZS5hdHRyaWJ1dGVzW2krK10ubm9kZU5hbWUpKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFsbENoaWxkcmVuICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoID4gMClcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbCA9IG5vZGUuY2hpbGROb2Rlcy5sZW5ndGg7IGkgPCBpbDspXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3Tm9kZS5hcHBlbmRDaGlsZCh0aGlzLl9pbXBvcnROb2RlKGRvYywgbm9kZS5jaGlsZE5vZGVzW2krK10sIGFsbENoaWxkcmVuKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ld05vZGU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDM6XG4gICAgICAgICAgICBjYXNlIDQ6XG4gICAgICAgICAgICBjYXNlIDg6XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMucGFyc2VyID0gbmV3IERPTVBhcnNlcigpO1xuICAgIHZhciBzdHIgPSBcIjxkb2Njbz48aW5zdGl0dXRpb24gaW5zdGl0dXRpb24tcGFydHM9XFxcImxvbmdcXFwiIGRlbGltaXRlcj1cXFwiLCBcXFwiIHN1YnN0aXR1dGUtdXNlLWZpcnN0PVxcXCIxXFxcIiB1c2UtbGFzdD1cXFwiMVxcXCI+PGluc3RpdHV0aW9uLXBhcnQgbmFtZT1cXFwibG9uZ1xcXCIvPjwvaW5zdGl0dXRpb24+PC9kb2Njbz5cIjtcbiAgICB2YXIgaW5zdF9kb2MgPSB0aGlzLnBhcnNlci5wYXJzZUZyb21TdHJpbmcoc3RyLCBcInRleHQveG1sXCIpO1xuICAgIHZhciBpbnN0X25vZGUgPSBpbnN0X2RvYy5nZXRFbGVtZW50c0J5VGFnTmFtZShcImluc3RpdHV0aW9uXCIpO1xuICAgIHRoaXMuaW5zdGl0dXRpb24gPSBpbnN0X25vZGUuaXRlbSgwKTtcbiAgICB2YXIgaW5zdF9wYXJ0X25vZGUgPSBpbnN0X2RvYy5nZXRFbGVtZW50c0J5VGFnTmFtZShcImluc3RpdHV0aW9uLXBhcnRcIik7XG4gICAgdGhpcy5pbnN0aXR1dGlvbnBhcnQgPSBpbnN0X3BhcnRfbm9kZS5pdGVtKDApO1xuICAgIHRoaXMubnMgPSBcImh0dHA6Ly9wdXJsLm9yZy9uZXQveGJpYmxpby9jc2xcIjtcbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5jbGVhbiA9IGZ1bmN0aW9uICh4bWwpIHtcbiAgICB4bWwgPSB4bWwucmVwbGFjZSgvPFxcP1teP10rXFw/Pi9nLCBcIlwiKTtcbiAgICB4bWwgPSB4bWwucmVwbGFjZSgvPCFbXj5dKz4vZywgXCJcIik7XG4gICAgeG1sID0geG1sLnJlcGxhY2UoL15cXHMrLywgXCJcIik7XG4gICAgeG1sID0geG1sLnJlcGxhY2UoL1xccyskLywgXCJcIik7XG4gICAgeG1sID0geG1sLnJlcGxhY2UoL15cXG4qLywgXCJcIik7XG4gICAgcmV0dXJuIHhtbDtcbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5nZXRTdHlsZUlkID0gZnVuY3Rpb24gKG15eG1sLCBzdHlsZU5hbWUpIHtcbiAgICB2YXIgdGV4dCA9IFwiXCI7XG4gICAgdmFyIHRhZ05hbWUgPSBcImlkXCI7XG4gICAgaWYgKHN0eWxlTmFtZSkge1xuICAgICAgICB0YWdOYW1lID0gXCJ0aXRsZVwiO1xuICAgIH1cbiAgICB2YXIgbm9kZSA9IG15eG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZ05hbWUpO1xuICAgIGlmIChub2RlICYmIG5vZGUubGVuZ3RoKSB7XG4gICAgICAgIG5vZGUgPSBub2RlLml0ZW0oMCk7XG4gICAgfVxuICAgIGlmIChub2RlKSB7XG4gICAgICAgIHRleHQgPSBub2RlLnRleHRDb250ZW50O1xuICAgIH1cbiAgICBpZiAoIXRleHQpIHtcbiAgICAgICAgdGV4dCA9IG5vZGUuaW5uZXJUZXh0O1xuICAgIH1cbiAgICBpZiAoIXRleHQpIHtcbiAgICAgICAgdGV4dCA9IG5vZGUuaW5uZXJIVE1MO1xuICAgIH1cbiAgICByZXR1cm4gdGV4dDtcbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5jaGlsZHJlbiA9IGZ1bmN0aW9uIChteXhtbCkge1xuICAgIHZhciBjaGlsZHJlbiwgcG9zLCBsZW4sIHJldDtcbiAgICBpZiAobXl4bWwpIHtcbiAgICAgICAgcmV0ID0gW107XG4gICAgICAgIGNoaWxkcmVuID0gbXl4bWwuY2hpbGROb2RlcztcbiAgICAgICAgZm9yIChwb3MgPSAwLCBsZW4gPSBjaGlsZHJlbi5sZW5ndGg7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChjaGlsZHJlbltwb3NdLm5vZGVOYW1lICE9IFwiI3RleHRcIikge1xuICAgICAgICAgICAgICAgIHJldC5wdXNoKGNoaWxkcmVuW3Bvc10pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5ub2RlbmFtZSA9IGZ1bmN0aW9uIChteXhtbCkge1xuICAgIHZhciByZXQgPSBteXhtbC5ub2RlTmFtZTtcbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5YbWxET00ucHJvdG90eXBlLmF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAobXl4bWwpIHtcbiAgICB2YXIgcmV0LCBhdHRycywgYXR0ciwga2V5LCB4bWwsIHBvcywgbGVuO1xuICAgIHJldCA9IG5ldyBPYmplY3QoKTtcbiAgICBpZiAobXl4bWwgJiYgdGhpcy5oYXNBdHRyaWJ1dGVzKG15eG1sKSkge1xuICAgICAgICBhdHRycyA9IG15eG1sLmF0dHJpYnV0ZXM7XG4gICAgICAgIGZvciAocG9zID0gMCwgbGVuPWF0dHJzLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgYXR0ciA9IGF0dHJzW3Bvc107XG4gICAgICAgICAgICByZXRbXCJAXCIgKyBhdHRyLm5hbWVdID0gYXR0ci52YWx1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5YbWxET00ucHJvdG90eXBlLmNvbnRlbnQgPSBmdW5jdGlvbiAobXl4bWwpIHtcbiAgICB2YXIgcmV0O1xuICAgIGlmIChcInVuZGVmaW5lZFwiICE9IHR5cGVvZiBteXhtbC50ZXh0Q29udGVudCkge1xuICAgICAgICByZXQgPSBteXhtbC50ZXh0Q29udGVudDtcbiAgICB9IGVsc2UgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mIG15eG1sLmlubmVyVGV4dCkge1xuICAgICAgICByZXQgPSBteXhtbC5pbm5lclRleHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0ID0gbXl4bWwudHh0O1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5YbWxET00ucHJvdG90eXBlLm5hbWVzcGFjZSA9IHtcbiAgICBcInhtbFwiOlwiaHR0cDovL3d3dy53My5vcmcvWE1MLzE5OTgvbmFtZXNwYWNlXCJcbn1cbkNTTC5YbWxET00ucHJvdG90eXBlLm51bWJlcm9mbm9kZXMgPSBmdW5jdGlvbiAobXl4bWwpIHtcbiAgICBpZiAobXl4bWwpIHtcbiAgICAgICAgcmV0dXJuIG15eG1sLmxlbmd0aDtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG59O1xuQ1NMLlhtbERPTS5wcm90b3R5cGUuZ2V0QXR0cmlidXRlTmFtZSA9IGZ1bmN0aW9uIChhdHRyKSB7XG4gICAgdmFyIHJldCA9IGF0dHIubmFtZTtcbiAgICByZXR1cm4gcmV0O1xufVxuQ1NMLlhtbERPTS5wcm90b3R5cGUuZ2V0QXR0cmlidXRlVmFsdWUgPSBmdW5jdGlvbiAobXl4bWwsbmFtZSxuYW1lc3BhY2UpIHtcbiAgICB2YXIgcmV0ID0gXCJcIjtcbiAgICBpZiAobmFtZXNwYWNlKSB7XG4gICAgICAgIG5hbWUgPSBuYW1lc3BhY2UrXCI6XCIrbmFtZTtcbiAgICB9XG4gICAgaWYgKG15eG1sICYmIHRoaXMuaGFzQXR0cmlidXRlcyhteXhtbCkgJiYgbXl4bWwuZ2V0QXR0cmlidXRlKG5hbWUpKSB7XG4gICAgICAgIHJldCA9IG15eG1sLmdldEF0dHJpYnV0ZShuYW1lKTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn1cbkNTTC5YbWxET00ucHJvdG90eXBlLmdldE5vZGVWYWx1ZSA9IGZ1bmN0aW9uIChteXhtbCxuYW1lKSB7XG4gICAgdmFyIHJldCA9IG51bGw7XG4gICAgaWYgKG5hbWUpe1xuICAgICAgICB2YXIgdmFscyA9IG15eG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKG5hbWUpO1xuICAgICAgICBpZiAodmFscy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2YgdmFsc1swXS50ZXh0Q29udGVudCkge1xuICAgICAgICAgICAgICAgIHJldCA9IHZhbHNbMF0udGV4dENvbnRlbnQ7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mIHZhbHNbMF0uaW5uZXJUZXh0KSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gdmFsc1swXS5pbm5lclRleHQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldCA9IHZhbHNbMF0udGV4dDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAocmV0ID09PSBudWxsICYmIG15eG1sICYmIG15eG1sLmNoaWxkTm9kZXMgJiYgKG15eG1sLmNoaWxkTm9kZXMubGVuZ3RoID09IDAgfHwgKG15eG1sLmNoaWxkTm9kZXMubGVuZ3RoID09IDEgJiYgbXl4bWwuZmlyc3RDaGlsZC5ub2RlTmFtZSA9PSBcIiN0ZXh0XCIpKSkge1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2YgbXl4bWwudGV4dENvbnRlbnQpIHtcbiAgICAgICAgICAgIHJldCA9IG15eG1sLnRleHRDb250ZW50O1xuICAgICAgICB9IGVsc2UgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mIG15eG1sLmlubmVyVGV4dCkge1xuICAgICAgICAgICAgcmV0ID0gbXl4bWwuaW5uZXJUZXh0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0ID0gbXl4bWwudGV4dDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAocmV0ID09PSBudWxsKSB7XG4gICAgICAgIHJldCA9IG15eG1sO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuQ1NMLlhtbERPTS5wcm90b3R5cGUuc2V0QXR0cmlidXRlT25Ob2RlSWRlbnRpZmllZEJ5TmFtZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChteXhtbCxub2RlbmFtZSxwYXJ0bmFtZSxhdHRybmFtZSx2YWwpIHtcbiAgICB2YXIgcG9zLCBsZW4sIHhtbCwgbm9kZXMsIG5vZGU7XG4gICAgaWYgKGF0dHJuYW1lLnNsaWNlKDAsMSkgPT09ICdAJyl7XG4gICAgICAgIGF0dHJuYW1lID0gYXR0cm5hbWUuc2xpY2UoMSk7XG4gICAgfVxuICAgIG5vZGVzID0gbXl4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUobm9kZW5hbWUpO1xuICAgIGZvciAocG9zID0gMCwgbGVuID0gbm9kZXMubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIG5vZGUgPSBub2Rlc1twb3NdO1xuICAgICAgICBpZiAobm9kZS5nZXRBdHRyaWJ1dGUoXCJuYW1lXCIpICE9IHBhcnRuYW1lKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBub2RlLnNldEF0dHJpYnV0ZShhdHRybmFtZSwgdmFsKTtcbiAgICB9XG59XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5kZWxldGVOb2RlQnlOYW1lQXR0cmlidXRlID0gZnVuY3Rpb24gKG15eG1sLHZhbCkge1xuICAgIHZhciBwb3MsIGxlbiwgbm9kZSwgbm9kZXM7XG4gICAgbm9kZXMgPSBteXhtbC5jaGlsZE5vZGVzO1xuICAgIGZvciAocG9zID0gMCwgbGVuID0gbm9kZXMubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIG5vZGUgPSBub2Rlc1twb3NdO1xuICAgICAgICBpZiAoIW5vZGUgfHwgbm9kZS5ub2RlVHlwZSA9PSBub2RlLlRFWFRfTk9ERSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuaGFzQXR0cmlidXRlcyhub2RlKSAmJiBub2RlLmdldEF0dHJpYnV0ZShcIm5hbWVcIikgPT0gdmFsKSB7XG4gICAgICAgICAgICBteXhtbC5yZW1vdmVDaGlsZChub2Rlc1twb3NdKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbkNTTC5YbWxET00ucHJvdG90eXBlLmRlbGV0ZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChteXhtbCxhdHRyKSB7XG4gICAgbXl4bWwucmVtb3ZlQXR0cmlidXRlKGF0dHIpO1xufVxuQ1NMLlhtbERPTS5wcm90b3R5cGUuc2V0QXR0cmlidXRlID0gZnVuY3Rpb24gKG15eG1sLGF0dHIsdmFsKSB7XG4gICAgaWYgKCFteXhtbC5vd25lckRvY3VtZW50KSB7XG4gICAgICAgIG15eG1sID0gbXl4bWwuZmlyc3RDaGlsZDtcbiAgICB9XG4gICAgaWYgKFtcImZ1bmN0aW9uXCIsIFwidW5rbm93blwiXS5pbmRleE9mKHR5cGVvZiBteXhtbC5zZXRBdHRyaWJ1dGUpID4gLTEpIHtcbiAgICAgICAgbXl4bWwuc2V0QXR0cmlidXRlKGF0dHIsIHZhbCk7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cbkNTTC5YbWxET00ucHJvdG90eXBlLm5vZGVDb3B5ID0gZnVuY3Rpb24gKG15eG1sKSB7XG4gICAgdmFyIGNsb25lZF9ub2RlID0gbXl4bWwuY2xvbmVOb2RlKHRydWUpO1xuICAgIHJldHVybiBjbG9uZWRfbm9kZTtcbn1cbkNTTC5YbWxET00ucHJvdG90eXBlLmdldE5vZGVzQnlOYW1lID0gZnVuY3Rpb24gKG15eG1sLG5hbWUsbmFtZWF0dHJ2YWwpIHtcbiAgICB2YXIgcmV0LCBub2Rlcywgbm9kZSwgcG9zLCBsZW47XG4gICAgcmV0ID0gW107XG4gICAgbm9kZXMgPSBteXhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKTtcbiAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IG5vZGVzLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBub2RlID0gbm9kZXMuaXRlbShwb3MpO1xuICAgICAgICBpZiAobmFtZWF0dHJ2YWwgJiYgISh0aGlzLmhhc0F0dHJpYnV0ZXMobm9kZSkgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoXCJuYW1lXCIpID09IG5hbWVhdHRydmFsKSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0LnB1c2gobm9kZSk7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5ub2RlTmFtZUlzID0gZnVuY3Rpb24gKG15eG1sLG5hbWUpIHtcbiAgICBpZiAobmFtZSA9PSBteXhtbC5ub2RlTmFtZSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuQ1NMLlhtbERPTS5wcm90b3R5cGUubWFrZVhtbCA9IGZ1bmN0aW9uIChteXhtbCkge1xuICAgIHZhciByZXQsIHRvcG5vZGU7XG4gICAgaWYgKCFteXhtbCkge1xuICAgICAgICBteXhtbCA9IFwiPGRvY2NvPjxib2d1cy8+PC9kb2Njbz5cIjtcbiAgICB9XG4gICAgbXl4bWwgPSBteXhtbC5yZXBsYWNlKC9cXHMqPFxcP1tePl0qXFw/PlxccypcXG4qL2csIFwiXCIpO1xuICAgIHZhciBub2RldHJlZSA9IHRoaXMucGFyc2VyLnBhcnNlRnJvbVN0cmluZyhteXhtbCwgXCJhcHBsaWNhdGlvbi94bWxcIik7XG4gICAgcmV0dXJuIG5vZGV0cmVlLmZpcnN0Q2hpbGQ7XG59O1xuQ1NMLlhtbERPTS5wcm90b3R5cGUuaW5zZXJ0Q2hpbGROb2RlQWZ0ZXIgPSBmdW5jdGlvbiAocGFyZW50LG5vZGUscG9zLGRhdGV4bWwpIHtcbiAgICB2YXIgbXl4bWwsIHhtbDtcbiAgICBteXhtbCA9IHRoaXMuaW1wb3J0Tm9kZShub2RlLm93bmVyRG9jdW1lbnQsIGRhdGV4bWwpO1xuICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobXl4bWwsIG5vZGUpO1xuICAgICByZXR1cm4gcGFyZW50O1xufTtcbkNTTC5YbWxET00ucHJvdG90eXBlLmluc2VydFB1Ymxpc2hlckFuZFBsYWNlID0gZnVuY3Rpb24obXl4bWwpIHtcbiAgICB2YXIgZ3JvdXAgPSBteXhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImdyb3VwXCIpO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gZ3JvdXAubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciBub2RlID0gZ3JvdXAuaXRlbShpKTtcbiAgICAgICAgdmFyIHNraXBwZXJzID0gW107XG4gICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gbm9kZS5jaGlsZE5vZGVzLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGROb2Rlcy5pdGVtKGopLm5vZGVUeXBlICE9PSAxKSB7XG4gICAgICAgICAgICAgICAgc2tpcHBlcnMucHVzaChqKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAobm9kZS5jaGlsZE5vZGVzLmxlbmd0aCAtIHNraXBwZXJzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgdmFyIHR3b3ZhcnMgPSBbXTtcbiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gMjsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgIGlmIChza2lwcGVycy5pbmRleE9mKGopID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGROb2Rlcy5pdGVtKGopOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIHN1YnNraXBwZXJzID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGtsZW4gPSBjaGlsZC5jaGlsZE5vZGVzLmxlbmd0aDsgayA8IGtsZW47IGsgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGQuY2hpbGROb2Rlcy5pdGVtKGspLm5vZGVUeXBlICE9PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJza2lwcGVycy5wdXNoKGspO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjaGlsZC5jaGlsZE5vZGVzLmxlbmd0aCAtIHN1YnNraXBwZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICB0d292YXJzLnB1c2goY2hpbGQuZ2V0QXR0cmlidXRlKCd2YXJpYWJsZScpKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmdldEF0dHJpYnV0ZSgnc3VmZml4JylcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IGNoaWxkLmdldEF0dHJpYnV0ZSgncHJlZml4JykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR3b3ZhcnMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHR3b3ZhcnMuaW5kZXhPZihcInB1Ymxpc2hlclwiKSA+IC0xICYmIHR3b3ZhcnMuaW5kZXhPZihcInB1Ymxpc2hlci1wbGFjZVwiKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoJ2hhcy1wdWJsaXNoZXItYW5kLXB1Ymxpc2hlci1wbGFjZScsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5YbWxET00ucHJvdG90eXBlLmlzQ2hpbGRPZlN1YnN0aXR1dGUgPSBmdW5jdGlvbihub2RlKSB7XG4gICAgaWYgKG5vZGUucGFyZW50Tm9kZSkge1xuICAgICAgICBpZiAobm9kZS5wYXJlbnROb2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gXCJzdWJzdGl0dXRlXCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNDaGlsZE9mU3Vic3RpdHV0ZShub2RlLnBhcmVudE5vZGUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5hZGRNaXNzaW5nTmFtZU5vZGVzID0gZnVuY3Rpb24obXl4bWwpIHtcbiAgICB2YXIgbmFtZXNsaXN0ID0gbXl4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJuYW1lc1wiKTtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG5hbWVzbGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIG5hbWVzID0gbmFtZXNsaXN0Lml0ZW0oaSk7XG4gICAgICAgIHZhciBuYW1lbGlzdCA9IG5hbWVzLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwibmFtZVwiKTtcbiAgICAgICAgaWYgKCghbmFtZWxpc3QgfHwgbmFtZWxpc3QubGVuZ3RoID09PSAwKVxuICAgICAgICAgICAgJiYgIXRoaXMuaXNDaGlsZE9mU3Vic3RpdHV0ZShuYW1lcykpIHtcbiAgICAgICAgICAgIHZhciBkb2MgPSBuYW1lcy5vd25lckRvY3VtZW50O1xuICAgICAgICAgICAgdmFyIG5hbWUgPSBkb2MuY3JlYXRlRWxlbWVudChcIm5hbWVcIik7XG4gICAgICAgICAgICBuYW1lcy5hcHBlbmRDaGlsZChuYW1lKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5hZGRJbnN0aXR1dGlvbk5vZGVzID0gZnVuY3Rpb24obXl4bWwpIHtcbiAgICB2YXIgbmFtZXMsIHRoZW5hbWVzLCBpbnN0aXR1dGlvbiwgdGhlaW5zdGl0dXRpb24sIG5hbWUsIHRoZW5hbWUsIHhtbCwgcG9zLCBsZW47XG4gICAgbmFtZXMgPSBteXhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZShcIm5hbWVzXCIpO1xuICAgIGZvciAocG9zID0gMCwgbGVuID0gbmFtZXMubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIHRoZW5hbWVzID0gbmFtZXMuaXRlbShwb3MpO1xuICAgICAgICBuYW1lID0gdGhlbmFtZXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJuYW1lXCIpO1xuICAgICAgICBpZiAobmFtZS5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgaW5zdGl0dXRpb24gPSB0aGVuYW1lcy5nZXRFbGVtZW50c0J5VGFnTmFtZShcImluc3RpdHV0aW9uXCIpO1xuICAgICAgICBpZiAoaW5zdGl0dXRpb24ubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgIHRoZWluc3RpdHV0aW9uID0gdGhpcy5pbXBvcnROb2RlKG15eG1sLm93bmVyRG9jdW1lbnQsIHRoaXMuaW5zdGl0dXRpb24pO1xuICAgICAgICAgICAgdGhlaW5zdGl0dXRpb25wYXJ0ID0gdGhlaW5zdGl0dXRpb24uZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJpbnN0aXR1dGlvbi1wYXJ0XCIpLml0ZW0oMCk7XG4gICAgICAgICAgICB0aGVuYW1lID0gbmFtZS5pdGVtKDApO1xuICAgICAgICAgICAgdGhlbmFtZXMuaW5zZXJ0QmVmb3JlKHRoZWluc3RpdHV0aW9uLCB0aGVuYW1lLm5leHRTaWJsaW5nKTtcbiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gQ1NMLklOU1RJVFVUSU9OX0tFWVMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgdmFyIGF0dHJuYW1lID0gQ1NMLklOU1RJVFVUSU9OX0tFWVNbal07XG4gICAgICAgICAgICAgICAgdmFyIGF0dHJ2YWwgPSB0aGVuYW1lLmdldEF0dHJpYnV0ZShhdHRybmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKGF0dHJ2YWwpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhlaW5zdGl0dXRpb25wYXJ0LnNldEF0dHJpYnV0ZShhdHRybmFtZSwgYXR0cnZhbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG5hbWVwYXJ0cyA9IHRoZW5hbWUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJuYW1lLXBhcnRcIik7XG4gICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IG5hbWVwYXJ0cy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoJ2ZhbWlseScgPT09IG5hbWVwYXJ0c1tqXS5nZXRBdHRyaWJ1dGUoJ25hbWUnKSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMCwga2xlbiA9IENTTC5JTlNUSVRVVElPTl9LRVlTLmxlbmd0aDsgayA8IGtsZW47IGsgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJuYW1lID0gQ1NMLklOU1RJVFVUSU9OX0tFWVNba107XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0cnZhbCA9IG5hbWVwYXJ0c1tqXS5nZXRBdHRyaWJ1dGUoYXR0cm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJ2YWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVpbnN0aXR1dGlvbnBhcnQuc2V0QXR0cmlidXRlKGF0dHJuYW1lLCBhdHRydmFsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuWG1sRE9NLnByb3RvdHlwZS5mbGFnRGF0ZU1hY3JvcyA9IGZ1bmN0aW9uKG15eG1sKSB7XG4gICAgdmFyIHBvcywgbGVuLCB0aGVub2RlLCB0aGVkYXRlO1xuICAgIG5vZGVzID0gbXl4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJtYWNyb1wiKTtcbiAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IG5vZGVzLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICB0aGVub2RlID0gbm9kZXMuaXRlbShwb3MpO1xuICAgICAgICB0aGVkYXRlID0gdGhlbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZShcImRhdGVcIik7XG4gICAgICAgIGlmICh0aGVkYXRlLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhlbm9kZS5zZXRBdHRyaWJ1dGUoJ21hY3JvLWhhcy1kYXRlJywgJ3RydWUnKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbmlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgWE1MKSB7XG4gICAgdHJ5IHtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IFwiT09QUzogXCIrZTtcbiAgICB9XG59XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5zZXR1cFhtbCA9IGZ1bmN0aW9uKHhtbE9iamVjdCkge1xuICAgIHZhciBkYXRhT2JqID0ge307XG4gICAgdmFyIHBhcnNlciA9IG51bGw7XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB4bWxPYmplY3QpIHtcbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiB4bWxPYmplY3QpIHtcbiAgICAgICAgICAgIHhtbE9iamVjdCA9IHhtbE9iamVjdC5yZXBsYWNlKFwiXlxcdUZFRkZcIiwgXCJcIilcbiAgICAgICAgICAgICAgICAucmVwbGFjZSgvXlxccysvLCBcIlwiKTtcbiAgICAgICAgICAgIGlmICh4bWxPYmplY3Quc2xpY2UoMCwgMSkgPT09IFwiPFwiKSB7XG4gICAgICAgICAgICAgICAgZGF0YU9iaiA9IENTTC5wYXJzZVhtbCh4bWxPYmplY3QpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkYXRhT2JqID0gSlNPTi5wYXJzZSh4bWxPYmplY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFyc2VyID0gbmV3IENTTC5YbWxKU09OKGRhdGFPYmopO1xuICAgICAgICB9IGVsc2UgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB4bWxPYmplY3QuZ2V0QXR0cmlidXRlKSB7XG4gICAgICAgICAgICBwYXJzZXIgPSBuZXcgQ1NMLlhtbERPTSh4bWxPYmplY3QpO1xuICAgICAgICB9IGVsc2UgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB4bWxPYmplY3QudG9YTUxTdHJpbmcpIHtcbiAgICAgICAgICAgIHBhcnNlciA9IG5ldyBDU0wuWG1sRTRYKHhtbE9iamVjdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwYXJzZXIgPSBuZXcgQ1NMLlhtbEpTT04oeG1sT2JqZWN0KTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIENTTC5lcnJvcihcInVuYWJsZSB0byBwYXJzZSBYTUwgaW5wdXRcIik7XG4gICAgfVxuICAgIGlmICghcGFyc2VyKSB7XG4gICAgICAgIHRocm93IFwiY2l0ZXByb2MtanMgZXJyb3I6IHVuYWJsZSB0byBwYXJzZSBDU0wgc3R5bGUgb3IgbG9jYWxlIG9iamVjdFwiO1xuICAgIH1cbiAgICByZXR1cm4gcGFyc2VyO1xufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuZ2V0U29ydENvbXBhcmUgPSBmdW5jdGlvbiAoZGVmYXVsdF9sb2NhbGUpIHtcbiAgICBpZiAoQ1NMLnN0cmluZ0NvbXBhcmUpIHtcbiAgICAgICAgcmV0dXJuIENTTC5zdHJpbmdDb21wYXJlO1xuICAgIH1cbiAgICB2YXIgc3RyY21wO1xuICAgIHZhciBzdHJjbXBfb3B0cyA9IHtcbiAgICAgICAgc2Vuc2l0aXZpdHk6XCJiYXNlXCIsXG4gICAgICAgIGlnbm9yZVB1bmN0dWF0aW9uOnRydWUsXG4gICAgICAgIG51bWVyaWM6dHJ1ZVxuICAgfVxuICAgIGlmICghZGVmYXVsdF9sb2NhbGUpIHtcbiAgICAgICAgZGVmYXVsdF9sb2NhbGUgPSBcImVuLVVTXCI7XG4gICAgfVxuICAgIHN0cmNtcCA9IGZ1bmN0aW9uIChhLCBiKSB7XG4gICAgICAgIHJldHVybiBhLnRvTG9jYWxlTG93ZXJDYXNlKCkubG9jYWxlQ29tcGFyZShiLnRvTG9jYWxlTG93ZXJDYXNlKCksZGVmYXVsdF9sb2NhbGUsc3RyY21wX29wdHMpO1xuICAgIH07XG4gICAgdmFyIHN0cmlwUHVuY3QgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvXltcXFtcXF1cXCdcXFwiXSovZywgXCJcIik7XG4gICAgfVxuICAgIHZhciBnZXRCcmFja2V0UHJlU29ydCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKCFzdHJjbXAoXCJbeFwiLFwieFwiKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhLCBiKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0cmNtcChzdHJpcFB1bmN0KGEpLCBzdHJpcFB1bmN0KGIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgYnJhY2tldFByZVNvcnQgPSBnZXRCcmFja2V0UHJlU29ydCgpO1xuICAgIHZhciBzb3J0Q29tcGFyZSA9IGZ1bmN0aW9uIChhLCBiKSB7XG4gICAgICAgIGlmIChicmFja2V0UHJlU29ydCkge1xuICAgICAgICAgICAgcmV0dXJuIGJyYWNrZXRQcmVTb3J0KGEsIGIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHN0cmNtcChhLCBiKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc29ydENvbXBhcmU7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuYW1iaWdDb25maWdEaWZmID0gZnVuY3Rpb24oYSwgYikge1xuICAgIHZhciByZXQsIHBvcywgbGVuLCBwcG9zLCBsbGVuO1xuICAgIGlmIChhLm5hbWVzLmxlbmd0aCAhPT0gYi5uYW1lcy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZm9yIChwb3MgPSAwLCBsZW4gPSBhLm5hbWVzLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgaWYgKGEubmFtZXNbcG9zXSAhPT0gYi5uYW1lc1twb3NdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvciAocHBvcyA9IDAsIGxsZW4gPSBhLmdpdmVuc1twb3NdOyBwcG9zIDwgbGxlbjsgcHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhLmdpdmVuc1twb3NdW3Bwb3NdICE9PSBiLmdpdmVuc1twb3NdW3Bwb3NdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoYS5kaXNhbWJpZ3VhdGUgIT0gYi5kaXNhbWJpZ3VhdGUpIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgfVxuICAgIGlmIChhLnllYXJfc3VmZml4ICE9PSBiLnllYXJfc3VmZml4KSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICByZXR1cm4gMDtcbn07XG5DU0wuY2xvbmVBbWJpZ0NvbmZpZyA9IGZ1bmN0aW9uIChjb25maWcsIG9sZGNvbmZpZywgdGFpbnRlcnMpIHtcbiAgICB2YXIgaSwgaWxlbiwgaiwgamxlbiwgaywga2xlbiwgcGFyYW07XG4gICAgdmFyIHJldCA9IHt9O1xuICAgIHJldC5uYW1lcyA9IFtdO1xuICAgIHJldC5naXZlbnMgPSBbXTtcbiAgICByZXQueWVhcl9zdWZmaXggPSBmYWxzZTtcbiAgICByZXQuZGlzYW1iaWd1YXRlID0gZmFsc2U7XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IGNvbmZpZy5uYW1lcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgcGFyYW0gPSBjb25maWcubmFtZXNbaV07XG4gICAgICAgIHJldC5uYW1lc1tpXSA9IHBhcmFtO1xuICAgIH1cbiAgICBmb3IgKGkgID0gMCwgaWxlbiA9IGNvbmZpZy5naXZlbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHBhcmFtID0gW107XG4gICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBjb25maWcuZ2l2ZW5zW2ldLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgcGFyYW0ucHVzaChjb25maWcuZ2l2ZW5zW2ldW2pdKTtcbiAgICAgICAgfVxuICAgICAgICByZXQuZ2l2ZW5zLnB1c2gocGFyYW0pO1xuICAgIH1cbiAgICBpZiAob2xkY29uZmlnKSB7XG4gICAgICAgIHJldC55ZWFyX3N1ZmZpeCA9IG9sZGNvbmZpZy55ZWFyX3N1ZmZpeDtcbiAgICAgICAgcmV0LmRpc2FtYmlndWF0ZSA9IG9sZGNvbmZpZy5kaXNhbWJpZ3VhdGU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0LnllYXJfc3VmZml4ID0gY29uZmlnLnllYXJfc3VmZml4O1xuICAgICAgICByZXQuZGlzYW1iaWd1YXRlID0gY29uZmlnLmRpc2FtYmlndWF0ZTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuZ2V0QW1iaWdDb25maWcgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGNvbmZpZywgcmV0O1xuICAgIGNvbmZpZyA9IHRoaXMudG1wLmRpc2FtYmlnX3JlcXVlc3Q7XG4gICAgaWYgKCFjb25maWcpIHtcbiAgICAgICAgY29uZmlnID0gdGhpcy50bXAuZGlzYW1iaWdfc2V0dGluZ3M7XG4gICAgfVxuICAgIHZhciByZXQgPSBDU0wuY2xvbmVBbWJpZ0NvbmZpZyhjb25maWcpO1xuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLmdldE1heFZhbHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMudG1wLm5hbWVzX21heC5teXN0YWNrLnNsaWNlKCk7XG59O1xuQ1NMLmdldE1pblZhbCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy50bXBbXCJldC1hbC1taW5cIl07XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wudG9rZW5FeGVjID0gZnVuY3Rpb24gKHRva2VuLCBJdGVtLCBpdGVtKSB7XG4gICAgdmFyIG5leHQsIG1heWJlbmV4dCwgZXhlYywgZGVidWc7XG4gICAgZGVidWcgPSBmYWxzZTtcbiAgICBuZXh0ID0gdG9rZW4ubmV4dDtcbiAgICBtYXliZW5leHQgPSBmYWxzZTtcbiAgICB2YXIgcmVjb3JkID0gZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICB0aGlzLnRtcC5qdW1wLnJlcGxhY2UoXCJzdWNjZWVkXCIpO1xuICAgICAgICAgICAgcmV0dXJuIHRva2VuLnN1Y2NlZWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnRtcC5qdW1wLnJlcGxhY2UoXCJmYWlsXCIpO1xuICAgICAgICAgICAgcmV0dXJuIHRva2VuLmZhaWw7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRva2VuLnRlc3QpIHtcbiAgICAgICAgbmV4dCA9IHJlY29yZC5jYWxsKHRoaXMsdG9rZW4udGVzdChJdGVtLCBpdGVtKSk7XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPXRva2VuLmV4ZWNzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgIGV4ZWMgPSB0b2tlbi5leGVjc1tpXTtcbiAgICAgICAgbWF5YmVuZXh0ID0gZXhlYy5jYWxsKHRva2VuLCB0aGlzLCBJdGVtLCBpdGVtKTtcbiAgICAgICAgaWYgKG1heWJlbmV4dCkge1xuICAgICAgICAgICAgbmV4dCA9IG1heWJlbmV4dDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbmV4dDtcbn07XG5DU0wuZXhwYW5kTWFjcm8gPSBmdW5jdGlvbiAobWFjcm9fa2V5X3Rva2VuLCB0YXJnZXQpIHtcbiAgICB2YXIgbWtleSwgc3RhcnRfdG9rZW4sIGtleSwgZW5kX3Rva2VuLCBuYXZpLCBtYWNyb19ub2RlcywgbmV3b3V0cHV0LCBtZXJnZW91dHB1dCwgZW5kX29mX21hY3JvLCBmdW5jO1xuICAgIG1rZXkgPSBtYWNyb19rZXlfdG9rZW4ucG9zdHBvbmVkX21hY3JvO1xuICAgIG1hY3JvX2tleV90b2tlbiA9IG5ldyBDU0wuVG9rZW4oXCJncm91cFwiLCBDU0wuU1RBUlQpO1xuICAgIHZhciBoYXNEYXRlID0gZmFsc2U7XG4gICAgdmFyIG1hY3JvaWQgPSBmYWxzZTtcbiAgICBtYWNyb19ub2RlcyA9IHRoaXMuY3NsWG1sLmdldE5vZGVzQnlOYW1lKHRoaXMuY3NsWG1sLmRhdGFPYmosICdtYWNybycsIG1rZXkpO1xuICAgIGlmIChtYWNyb19ub2Rlcy5sZW5ndGgpIHtcbiAgICAgICAgbWFjcm9pZCA9IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG1hY3JvX25vZGVzWzBdLCdjc2xpZCcpO1xuICAgICAgICBoYXNEYXRlID0gdGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUobWFjcm9fbm9kZXNbMF0sIFwibWFjcm8taGFzLWRhdGVcIik7XG4gICAgfVxuICAgIGlmIChoYXNEYXRlKSB7XG4gICAgICAgIG1rZXkgPSBta2V5ICsgXCJAXCIgKyB0aGlzLmJ1aWxkLmN1cnJlbnRfZGVmYXVsdF9sb2NhbGU7XG4gICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZXh0ZW5zaW9uKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wW1wiZG9pbmctbWFjcm8td2l0aC1kYXRlXCJdID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgbWFjcm9fa2V5X3Rva2VuLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgfVxuICAgIGlmICh0aGlzLmJ1aWxkLm1hY3JvX3N0YWNrLmluZGV4T2YobWtleSkgPiAtMSkge1xuICAgICAgICB0aHJvdyBcIkNTTCBwcm9jZXNzb3IgZXJyb3I6IGNhbGwgdG8gbWFjcm8gXFxcIlwiICsgbWtleSArIFwiXFxcIiB3b3VsZCBjYXVzZSBhbiBpbmZpbml0ZSBsb29wXCI7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5idWlsZC5tYWNyb19zdGFjay5wdXNoKG1rZXkpO1xuICAgIH1cbiAgICBtYWNyb19rZXlfdG9rZW4uY3NsaWQgPSBtYWNyb2lkO1xuICAgIGlmIChDU0wuTU9EVUxFX01BQ1JPU1tta2V5XSkge1xuICAgICAgICBtYWNyb19rZXlfdG9rZW4uanVyaXMgPSBta2V5O1xuICAgICAgICB0aGlzLm9wdC51cGRhdGVfbW9kZSA9IENTTC5QT1NJVElPTjtcbiAgICB9XG4gICAgQ1NMLk5vZGUuZ3JvdXAuYnVpbGQuY2FsbChtYWNyb19rZXlfdG9rZW4sIHRoaXMsIHRhcmdldCwgdHJ1ZSk7XG4gICAgaWYgKCF0aGlzLmNzbFhtbC5nZXROb2RlVmFsdWUobWFjcm9fbm9kZXMpKSB7XG4gICAgICAgIHRocm93IFwiQ1NMIHN0eWxlIGVycm9yOiB1bmRlZmluZWQgbWFjcm8gXFxcIlwiICsgbWtleSArIFwiXFxcIlwiO1xuICAgIH1cbiAgICB2YXIgbXl0YXJnZXQgPSBDU0wuZ2V0TWFjcm9UYXJnZXQuY2FsbCh0aGlzLCBta2V5KTtcbiAgICBpZiAobXl0YXJnZXQpIHtcbiAgICAgICAgQ1NMLmJ1aWxkTWFjcm8uY2FsbCh0aGlzLCBteXRhcmdldCwgbWFjcm9fbm9kZXMpO1xuICAgICAgICBDU0wuY29uZmlndXJlTWFjcm8uY2FsbCh0aGlzLCBteXRhcmdldCk7XG4gICAgfVxuICAgIGlmICghdGhpcy5idWlsZC5leHRlbnNpb24pIHtcbiAgICAgICAgdmFyIGZ1bmMgPSBmdW5jdGlvbihtYWNyb19uYW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5leHQgPSAwO1xuICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0IDwgc3RhdGUubWFjcm9zW21hY3JvX25hbWVdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBuZXh0ID0gQ1NMLnRva2VuRXhlYy5jYWxsKHN0YXRlLCBzdGF0ZS5tYWNyb3NbbWFjcm9fbmFtZV1bbmV4dF0sIEl0ZW0sIGl0ZW0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfShta2V5KTtcbiAgICAgICAgdmFyIHRleHRfbm9kZSA9IG5ldyBDU0wuVG9rZW4oXCJ0ZXh0XCIsIENTTC5TSU5HTEVUT04pO1xuICAgICAgICB0ZXh0X25vZGUuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgdGFyZ2V0LnB1c2godGV4dF9ub2RlKTtcbiAgICB9XG4gICAgZW5kX29mX21hY3JvID0gbmV3IENTTC5Ub2tlbihcImdyb3VwXCIsIENTTC5FTkQpO1xuICAgIGlmIChoYXNEYXRlKSB7XG4gICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZXh0ZW5zaW9uKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wW1wiZG9pbmctbWFjcm8td2l0aC1kYXRlXCJdID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGVuZF9vZl9tYWNyby5leGVjcy5wdXNoKGZ1bmMpO1xuICAgIH1cbiAgICBpZiAobWFjcm9fa2V5X3Rva2VuLmp1cmlzKSB7XG4gICAgICAgIGVuZF9vZl9tYWNyby5qdXJpcyA9IG1rZXk7XG4gICAgIH1cbiAgICBDU0wuTm9kZS5ncm91cC5idWlsZC5jYWxsKGVuZF9vZl9tYWNybywgdGhpcywgdGFyZ2V0LCB0cnVlKTtcbiAgICB0aGlzLmJ1aWxkLm1hY3JvX3N0YWNrLnBvcCgpO1xufTtcbkNTTC5nZXRNYWNyb1RhcmdldCA9IGZ1bmN0aW9uIChta2V5KSB7XG4gICAgdmFyIG15dGFyZ2V0ID0gZmFsc2U7XG4gICAgaWYgKHRoaXMuYnVpbGQuZXh0ZW5zaW9uKSB7XG4gICAgICAgIG15dGFyZ2V0ID0gdGhpc1t0aGlzLmJ1aWxkLnJvb3QgKyB0aGlzLmJ1aWxkLmV4dGVuc2lvbl0udG9rZW5zO1xuICAgIH0gZWxzZSBpZiAoIXRoaXMubWFjcm9zW21rZXldKSB7XG4gICAgICAgIG15dGFyZ2V0ID0gW107XG4gICAgICAgIHRoaXMubWFjcm9zW21rZXldID0gbXl0YXJnZXQ7XG4gICAgfVxuICAgIHJldHVybiBteXRhcmdldDtcbn1cbkNTTC5idWlsZE1hY3JvID0gZnVuY3Rpb24gKG15dGFyZ2V0LCBtYWNyb19ub2Rlcykge1xuICAgIHZhciBidWlsZGVyID0gQ1NMLm1ha2VCdWlsZGVyKHRoaXMsIG15dGFyZ2V0KTtcbiAgICB2YXIgbXlub2RlO1xuICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgbWFjcm9fbm9kZXMubGVuZ3RoKSB7XG4gICAgICAgIG15bm9kZSA9IG1hY3JvX25vZGVzO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG15bm9kZSA9IG1hY3JvX25vZGVzWzBdO1xuICAgIH1cbiAgICBidWlsZGVyKG15bm9kZSk7XG59XG5DU0wuY29uZmlndXJlTWFjcm8gPSBmdW5jdGlvbiAobXl0YXJnZXQpIHtcbiAgICBpZiAoIXRoaXMuYnVpbGQuZXh0ZW5zaW9uKSB7XG4gICAgICAgIHRoaXMuY29uZmlndXJlVG9rZW5MaXN0KG15dGFyZ2V0KTtcbiAgICB9XG59XG5DU0wuWG1sVG9Ub2tlbiA9IGZ1bmN0aW9uIChzdGF0ZSwgdG9rZW50eXBlLCBleHBsaWNpdFRhcmdldCkge1xuICAgIHZhciBuYW1lLCB0eHQsIGF0dHJmdW5jcywgYXR0cmlidXRlcywgZGVjb3JhdGlvbnMsIHRva2VuLCBrZXksIHRhcmdldDtcbiAgICBuYW1lID0gc3RhdGUuY3NsWG1sLm5vZGVuYW1lKHRoaXMpO1xuICAgIGlmIChzdGF0ZS5idWlsZC5za2lwICYmIHN0YXRlLmJ1aWxkLnNraXAgIT09IG5hbWUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIW5hbWUpIHtcbiAgICAgICAgdHh0ID0gc3RhdGUuY3NsWG1sLmNvbnRlbnQodGhpcyk7XG4gICAgICAgIGlmICh0eHQpIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLnRleHQgPSB0eHQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIUNTTC5Ob2RlW3N0YXRlLmNzbFhtbC5ub2RlbmFtZSh0aGlzKV0pIHtcbiAgICAgICAgdGhyb3cgXCJVbmRlZmluZWQgbm9kZSBuYW1lIFxcXCJcIiArIG5hbWUgKyBcIlxcXCIuXCI7XG4gICAgfVxuICAgIGF0dHJmdW5jcyA9IFtdO1xuICAgIGF0dHJpYnV0ZXMgPSBzdGF0ZS5jc2xYbWwuYXR0cmlidXRlcyh0aGlzKTtcbiAgICBkZWNvcmF0aW9ucyA9IENTTC5zZXREZWNvcmF0aW9ucy5jYWxsKHRoaXMsIHN0YXRlLCBhdHRyaWJ1dGVzKTtcbiAgICB0b2tlbiA9IG5ldyBDU0wuVG9rZW4obmFtZSwgdG9rZW50eXBlKTtcbiAgICBpZiAodG9rZW50eXBlICE9PSBDU0wuRU5EIHx8IG5hbWUgPT09IFwiaWZcIiB8fCBuYW1lID09PSBcImVsc2UtaWZcIiB8fCBuYW1lID09PSBcImxheW91dFwiKSB7XG4gICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRva2VudHlwZSA9PT0gQ1NMLkVORCAmJiBrZXkgIT09IFwiQGxhbmd1YWdlXCIgJiYga2V5ICE9PSBcIkBsb2NhbGVcIikge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoQ1NMLkF0dHJpYnV0ZXNba2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDU0wuQXR0cmlidXRlc1trZXldLmNhbGwodG9rZW4sIHN0YXRlLCBcIlwiICsgYXR0cmlidXRlc1trZXldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDU0wuZXJyb3IoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgXCJDU0wgcHJvY2Vzc29yIGVycm9yLCBcIiArIGtleSArIFwiIGF0dHJpYnV0ZTogXCIgKyBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgQ1NMLmRlYnVnKFwid2FybmluZzogdW5kZWZpbmVkIGF0dHJpYnV0ZSBcXFwiXCIra2V5K1wiXFxcIiBpbiBzdHlsZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0b2tlbi5kZWNvcmF0aW9ucyA9IGRlY29yYXRpb25zO1xuICAgIH0gZWxzZSBpZiAodG9rZW50eXBlID09PSBDU0wuRU5EICYmIGF0dHJpYnV0ZXNbJ0B2YXJpYWJsZSddKSB7XG4gICAgICAgIHRva2VuLmhhc1ZhcmlhYmxlID0gdHJ1ZTtcbiAgICAgICAgaWYgKENTTC5EQVRFX1ZBUklBQkxFUy5pbmRleE9mKGF0dHJpYnV0ZXNbJ0B2YXJpYWJsZSddKSA+IC0xKSB7XG4gICAgICAgICAgICB0b2tlbi52YXJpYWJsZXMgPSBhdHRyaWJ1dGVzWydAdmFyaWFibGUnXS5zcGxpdCgvXFxzKy8pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChleHBsaWNpdFRhcmdldCkge1xuICAgICAgICB0YXJnZXQgPSBleHBsaWNpdFRhcmdldDtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0YXJnZXQgPSBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS50b2tlbnM7XG4gICAgfVxuICAgIENTTC5Ob2RlW25hbWVdLmJ1aWxkLmNhbGwodG9rZW4sIHN0YXRlLCB0YXJnZXQsIHRydWUpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkRhdGVQYXJzZXIgPSBuZXcgZnVuY3Rpb24gKCkge1xuICAgIHZhciBlcG9jaFBhaXJzID0gW1xuICAgICAgICBbXCJcXHU2NjBFXFx1NkNCQlwiLCAxODY3XSxcbiAgICAgICAgW1wiXFx1NTkyN1xcdTZCNjNcIiwgMTkxMV0sXG4gICAgICAgIFtcIlxcdTY2MkRcXHU1NDhDXCIsIDE5MjVdLFxuICAgICAgICBbXCJcXHU1RTczXFx1NjIxMFwiLCAxOTg4XVxuICAgIF07XG4gICAgdmFyIGVwb2NoWWVhckJ5TmFtZSA9IHt9O1xuICAgIGZvciAodmFyIGk9MCxpbGVuPWVwb2NoUGFpcnMubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICB2YXIga2V5ID0gZXBvY2hQYWlyc1tpXVswXTtcbiAgICAgICAgdmFyIHZhbCA9IGVwb2NoUGFpcnNbaV1bMV07XG4gICAgICAgIGVwb2NoWWVhckJ5TmFtZVtrZXldID0gdmFsO1xuICAgIH1cbiAgICB2YXIgZXBvY2hNYXRjaFN0cmluZ3MgPSBbXTtcbiAgICBmb3IgKHZhciBpPTAsaWxlbj1lcG9jaFBhaXJzLmxlbmd0aDsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgdmFyIHZhbCA9IGVwb2NoUGFpcnNbaV1bMF07XG4gICAgICAgIGVwb2NoTWF0Y2hTdHJpbmdzLnB1c2godmFsKTtcbiAgICB9XG4gICAgdmFyIGVwb2NoTWF0Y2hTdHJpbmcgPSBlcG9jaE1hdGNoU3RyaW5ncy5qb2luKFwifFwiKTtcbiAgICB2YXIgZXBvY2hTcGxpdHRlciA9IG5ldyBSZWdFeHAoXCIoPzpcIiArIGVwb2NoTWF0Y2hTdHJpbmcgKyBcIikoPzpbMC05XSspXCIpO1xuICAgIHZhciBlcG9jaE1hdGNoZXIgPSBuZXcgUmVnRXhwKFwiKD86XCIgKyBlcG9jaE1hdGNoU3RyaW5nICsgXCIpKD86WzAtOV0rKVwiLCBcImdcIik7XG4gICAgdmFyIGthbmppTW9udGhEYXkgPSAvKFxcdTY3MDh8XFx1NUU3NCkvZztcbiAgICB2YXIga2FuamlZZWFyID0gL1xcdTY1RTUvZztcbiAgICB2YXIga2FuamlSYW5nZSA9IC9cXHUzMDFjL2c7XG4gICAgdmFyIHllYXJMYXN0ID0gXCIoPzpbPzAtOV17MSwyfSUlTlVNRCUlKXswLDJ9Wz8wLTldezR9KD8hWzAtOV0pXCI7XG4gICAgdmFyIHllYXJGaXJzdCA9IFwiWz8wLTldezR9KD86JSVOVU1EJSVbPzAtOV17MSwyfSl7MCwyfSg/IVswLTldKVwiO1xuICAgIHZhciBudW1iZXJWYWwgPSBcIls/MC05XXsxLDN9XCI7XG4gICAgdmFyIHJhbmdlU2VwYXJhdG9yID0gXCJbJSVEQVRFRCUlXVwiO1xuICAgIHZhciBmdXp6eUNoYXIgPSBcIls/fl1cIjtcbiAgICB2YXIgY2hhcnMgPSBcIlteXFwtXFwvXFx+XFw/MC05XStcIjtcbiAgICB2YXIgcmV4U3RyaW5nID0gXCIoXCIgKyB5ZWFyRmlyc3QgKyBcInxcIiArIHllYXJMYXN0ICsgXCJ8XCIgKyBudW1iZXJWYWwgKyBcInxcIiArIHJhbmdlU2VwYXJhdG9yICsgXCJ8XCIgKyBmdXp6eUNoYXIgKyBcInxcIiArIGNoYXJzICsgXCIpXCI7XG4gICAgdmFyIHJleERhc2ggPSBuZXcgUmVnRXhwKHJleFN0cmluZy5yZXBsYWNlKC8lJU5VTUQlJS9nLCBcIi1cIikucmVwbGFjZSgvJSVEQVRFRCUlL2csIFwiLVwiKSk7XG4gICAgdmFyIHJleERhc2hTbGFzaCA9IG5ldyBSZWdFeHAocmV4U3RyaW5nLnJlcGxhY2UoLyUlTlVNRCUlL2csIFwiLVwiKS5yZXBsYWNlKC8lJURBVEVEJSUvZywgXCJcXC9cIikpO1xuICAgIHZhciByZXhTbGFzaERhc2ggPSBuZXcgUmVnRXhwKHJleFN0cmluZy5yZXBsYWNlKC8lJU5VTUQlJS9nLCBcIlxcL1wiKS5yZXBsYWNlKC8lJURBVEVEJSUvZywgXCItXCIpKTtcbiAgICB2YXIgbW9udGhTdHJpbmcgPSBcImphbnVhcnkgZmVicnVhcnkgbWFyY2ggYXByaWwgbWF5IGp1bmUganVseSBhdWd1c3Qgc2VwdGVtYmVyIG9jdG9iZXIgbm92ZW1iZXIgZGVjZW1iZXIgc3ByaW5nIHN1bW1lciBmYWxsIHdpbnRlciBzcHJpbmcgc3VtbWVyXCI7XG4gICAgdGhpcy5tb250aFN0cmluZ3MgPSBtb250aFN0cmluZy5zcGxpdChcIiBcIik7XG4gICAgdGhpcy5zZXRPcmRlckRheU1vbnRoID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMubW9udGhHdWVzcyA9IDE7XG4gICAgICAgIHRoaXMuZGF5R3Vlc3MgPSAwO1xuICAgIH07XG4gICAgdGhpcy5zZXRPcmRlck1vbnRoRGF5ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMubW9udGhHdWVzcyA9IDA7XG4gICAgICAgIHRoaXMuZGF5R3Vlc3MgPSAxO1xuICAgIH07XG4gICAgdGhpcy5yZXNldERhdGVQYXJzZXJNb250aHMgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5tb250aFNldHMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy5tb250aFN0cmluZ3MubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdGhpcy5tb250aFNldHMucHVzaChbdGhpcy5tb250aFN0cmluZ3NbaV1dKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vbnRoQWJicmV2cyA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj10aGlzLm1vbnRoU2V0cy5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICB0aGlzLm1vbnRoQWJicmV2cy5wdXNoKFtdKTtcbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPXRoaXMubW9udGhTZXRzW2ldLmxlbmd0aDsgajxqbGVuOyBqKyspIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoQWJicmV2c1tpXS5wdXNoKHRoaXMubW9udGhTZXRzW2ldWzBdLnNsaWNlKDAsIDMpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vbnRoUmV4ZXMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy5tb250aEFiYnJldnMubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdGhpcy5tb250aFJleGVzLnB1c2gobmV3IFJlZ0V4cChcIig/OlwiICsgdGhpcy5tb250aEFiYnJldnNbaV0uam9pbihcInxcIikgKyBcIilcIikpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmFkZERhdGVQYXJzZXJNb250aHMgPSBmdW5jdGlvbihsc3QpIHtcbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBsc3QpIHtcbiAgICAgICAgICAgIGxzdCA9IGxzdC5zcGxpdCgvXFxzKy8pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsc3QubGVuZ3RoICE9PSAxMiAmJiBsc3QubGVuZ3RoICE9PSAxNikge1xuICAgICAgICAgICAgQ1NMLmRlYnVnKFwibW9udGggWytzZWFzb25dIGxpc3Qgb2YgXCIrbHN0Lmxlbmd0aCtcIiwgZXhwZWN0ZWQgMTIgb3IgMTYuIElnbm9yaW5nLlwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgb3RoZXJNYXRjaCA9IFtdO1xuICAgICAgICB2YXIgdGhpc01hdGNoID0gW107XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWxzdC5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgYWJicmV2TGVuZ3RoID0gbnVsbDtcbiAgICAgICAgICAgIHZhciBza2lwID0gZmFsc2U7XG4gICAgICAgICAgICB2YXIgaW5zZXJ0ID0gMztcbiAgICAgICAgICAgIHZhciBleHRlbmRlZFNldHMgPSB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPXRoaXMubW9udGhBYmJyZXZzLmxlbmd0aDsgajxqbGVuOyBqKyspIHtcbiAgICAgICAgICAgICAgICBleHRlbmRlZFNldHNbal0gPSB7fTtcbiAgICAgICAgICAgICAgICBpZiAoaiA9PT0gaSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrPTAsa2xlbj10aGlzLm1vbnRoQWJicmV2c1tpXS5sZW5ndGg7IGs8a2xlbjsgaysrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tb250aEFiYnJldnNbaV1ba10gPT09IGxzdFtpXS5zbGljZSgwLCB0aGlzLm1vbnRoQWJicmV2c1tpXVtrXS5sZW5ndGgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2tpcCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrPTAsa2xlbj10aGlzLm1vbnRoQWJicmV2c1tqXS5sZW5ndGg7IGs8a2xlbjsgaysrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhYmJyZXZMZW5ndGggPSB0aGlzLm1vbnRoQWJicmV2c1tqXVtrXS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tb250aEFiYnJldnNbal1ba10gPT09IGxzdFtpXS5zbGljZSgwLCBhYmJyZXZMZW5ndGgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHRoaXMubW9udGhTZXRzW2pdW2tdLnNsaWNlKDAsIGFiYnJldkxlbmd0aCkgPT09IGxzdFtpXS5zbGljZSgwLCBhYmJyZXZMZW5ndGgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhYmJyZXZMZW5ndGggPiBsc3RbaV0ubGVuZ3RoIHx8IGFiYnJldkxlbmd0aCA+IHRoaXMubW9udGhTZXRzW2pdW2tdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ1NMLmRlYnVnKFwidW5hYmxlIHRvIGRpc2FtYmlndWF0ZSBtb250aCBzdHJpbmcgaW4gZGF0ZSBwYXJzZXI6IFwiK2xzdFtpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFiYnJldkxlbmd0aCArPSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydCA9IGFiYnJldkxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHRlbmRlZFNldHNbal1ba10gPSBhYmJyZXZMZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaktleSBpbiBleHRlbmRlZFNldHMpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChrS2V5IGluIGV4dGVuZGVkU2V0c1tqS2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWJicmV2TGVuZ3RoID0gZXh0ZW5kZWRTZXRzW2pLZXldW2tLZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgaktleSA9IHBhcnNlSW50KGpLZXksIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtLZXkgPSBwYXJzZUludChrS2V5LCAxMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vbnRoQWJicmV2c1tqS2V5XVtrS2V5XSA9IHRoaXMubW9udGhTZXRzW2pLZXldW2tLZXldLnNsaWNlKDAsIGFiYnJldkxlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXNraXApIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoU2V0c1tpXS5wdXNoKGxzdFtpXSk7XG4gICAgICAgICAgICAgICAgdGhpcy5tb250aEFiYnJldnNbaV0ucHVzaChsc3RbaV0uc2xpY2UoMCwgaW5zZXJ0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tb250aFJleGVzID0gW107XG4gICAgICAgIHRoaXMubW9udGhSZXhTdHJzID0gW107XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMubW9udGhBYmJyZXZzLmxlbmd0aDsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMubW9udGhSZXhlcy5wdXNoKG5ldyBSZWdFeHAoXCJeKD86XCIgKyB0aGlzLm1vbnRoQWJicmV2c1tpXS5qb2luKFwifFwiKSArIFwiKVwiKSk7XG4gICAgICAgICAgICB0aGlzLm1vbnRoUmV4U3Rycy5wdXNoKFwiXig/OlwiICsgdGhpcy5tb250aEFiYnJldnNbaV0uam9pbihcInxcIikgKyBcIilcIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubW9udGhBYmJyZXZzLmxlbmd0aCA9PT0gMTgpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MTIsaWxlbj0xNDsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoUmV4ZXNbaSs0XSA9IG5ldyBSZWdFeHAoXCJeKD86XCIgKyB0aGlzLm1vbnRoQWJicmV2c1tpXS5qb2luKFwifFwiKSArIFwiKVwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoUmV4U3Ryc1tpKzRdID0gXCJeKD86XCIgKyB0aGlzLm1vbnRoQWJicmV2c1tpXS5qb2luKFwifFwiKSArIFwiKVwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmNvbnZlcnREYXRlT2JqZWN0VG9BcnJheSA9IGZ1bmN0aW9uICh0aGVkYXRlKSB7XG4gICAgICAgIHRoZWRhdGVbXCJkYXRlLXBhcnRzXCJdID0gW107XG4gICAgICAgIHRoZWRhdGVbXCJkYXRlLXBhcnRzXCJdLnB1c2goW10pO1xuICAgICAgICB2YXIgc2xpY2VsZW4gPSAwO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj0zOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdmFyIHBhcnQgPSBbXCJ5ZWFyXCIsIFwibW9udGhcIiwgXCJkYXlcIl1baV07XG4gICAgICAgICAgICBpZiAoIXRoZWRhdGVbcGFydF0pIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNsaWNlbGVuICs9IDE7XG4gICAgICAgICAgICB0aGVkYXRlW1wiZGF0ZS1wYXJ0c1wiXVswXS5wdXNoKHRoZWRhdGVbcGFydF0pO1xuICAgICAgICAgICAgZGVsZXRlIHRoZWRhdGVbcGFydF07XG4gICAgICAgIH1cbiAgICAgICAgdGhlZGF0ZVtcImRhdGUtcGFydHNcIl0ucHVzaChbXSk7XG4gICAgICAgIGZvciAodmFyIGk9MCwgaWxlbj1zbGljZWxlbjsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgIHBhcnQgPSBbXCJ5ZWFyX2VuZFwiLCBcIm1vbnRoX2VuZFwiLCBcImRheV9lbmRcIl1baV07XG4gICAgICAgICAgICBpZiAoIXRoZWRhdGVbcGFydF0pIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoZWRhdGVbXCJkYXRlLXBhcnRzXCJdWzFdLnB1c2godGhlZGF0ZVtwYXJ0XSk7XG4gICAgICAgICAgICBkZWxldGUgdGhlZGF0ZVtwYXJ0XTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhlZGF0ZVtcImRhdGUtcGFydHNcIl1bMF0ubGVuZ3RoICE9PSB0aGVkYXRlW1wiZGF0ZS1wYXJ0c1wiXVsxXS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoZWRhdGVbXCJkYXRlLXBhcnRzXCJdLnBvcCgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGVkYXRlO1xuICAgIH07XG4gICAgdGhpcy5jb252ZXJ0RGF0ZU9iamVjdFRvU3RyaW5nID0gZnVuY3Rpb24odGhlZGF0ZSkge1xuICAgICAgICB2YXIgcmV0ID0gW107XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gMzsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgaWYgKHRoZWRhdGVbREFURV9QQVJUU19BTExbaV1dKSB7XG4gICAgICAgICAgICAgICAgcmV0LnB1c2godGhlZGF0ZVtEQVRFX1BBUlRTX0FMTFtpXV0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0LmpvaW4oXCItXCIpO1xuICAgIH1cbiAgICB0aGlzLl9wYXJzZU51bWVyaWNEYXRlID0gZnVuY3Rpb24gKHJldCwgZGVsaW0sIHN1ZmYsIHR4dCkge1xuICAgICAgICBpZiAoIXN1ZmYpIHN1ZmYgPSBcIlwiO1xuICAgICAgICB2YXIgbHN0ID0gdHh0LnNwbGl0KGRlbGltKTtcbiAgICAgICAgZm9yICh2YXIgaT0wLCBpbGVuPWxzdC5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICBpZiAobHN0W2ldLmxlbmd0aCA9PT0gNCkge1xuICAgICAgICAgICAgICAgIHJldFsoXCJ5ZWFyXCIgKyBzdWZmKV0gPSBsc3RbaV0ucmVwbGFjZSgvXjAqLywgXCJcIik7XG4gICAgICAgICAgICAgICAgaWYgKCFpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxzdCA9IGxzdC5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsc3QgPSBsc3Quc2xpY2UoMCwgaSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWxzdC5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICBsc3RbaV0gPSBwYXJzZUludChsc3RbaV0sIDEwKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobHN0Lmxlbmd0aCA9PT0gMSB8fCAobHN0Lmxlbmd0aCA9PT0gMiAmJiAhbHN0WzFdKSkge1xuICAgICAgICAgICAgcmV0WyhcIm1vbnRoXCIgKyBzdWZmKV0gPSBcIlwiICsgbHN0WzBdO1xuICAgICAgICB9IGVsc2UgaWYgKGxzdC5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgIGlmIChsc3RbdGhpcy5tb250aEd1ZXNzXSA+IDEyKSB7XG4gICAgICAgICAgICAgICAgcmV0WyhcIm1vbnRoXCIgKyBzdWZmKV0gPSBcIlwiICsgbHN0W3RoaXMuZGF5R3Vlc3NdO1xuICAgICAgICAgICAgICAgIHJldFsoXCJkYXlcIiArIHN1ZmYpXSA9IFwiXCIgKyBsc3RbdGhpcy5tb250aEd1ZXNzXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0WyhcIm1vbnRoXCIgKyBzdWZmKV0gPSBcIlwiICsgbHN0W3RoaXMubW9udGhHdWVzc107XG4gICAgICAgICAgICAgICAgcmV0WyhcImRheVwiICsgc3VmZildID0gXCJcIiArIGxzdFt0aGlzLmRheUd1ZXNzXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5wYXJzZURhdGVUb09iamVjdCA9IGZ1bmN0aW9uICh0eHQpIHtcbiAgICAgICAgdmFyIG9yaWcgPSB0eHQ7XG4gICAgICAgIHZhciBzbGFzaFBvcyA9IC0xO1xuICAgICAgICB2YXIgZGFzaFBvcyA9IC0xO1xuICAgICAgICB2YXIgeWVhcklzTmVnYXRpdmUgPSBmYWxzZTtcbiAgICAgICAgdmFyIGxzdDtcbiAgICAgICAgaWYgKHR4dCkge1xuICAgICAgICAgICAgaWYgKHR4dC5zbGljZSgwLCAxKSA9PT0gXCItXCIpIHtcbiAgICAgICAgICAgICAgICB5ZWFySXNOZWdhdGl2ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgdHh0ID0gdHh0LnNsaWNlKDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHR4dC5tYXRjaCgvXlswLTldezEsM30kLykpIHtcbiAgICAgICAgICAgICAgICB3aGlsZSAodHh0Lmxlbmd0aCA8IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgdHh0ID0gXCIwXCIgKyB0eHQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdHh0ID0gXCJcIiArIHR4dDtcbiAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXHMqWzAtOV17Mn06WzAtOV17Mn0oPzo6WzAtOV0rKS8sXCJcIik7XG4gICAgICAgICAgICB2YXIgbSA9IHR4dC5tYXRjaChrYW5qaU1vbnRoRGF5KTtcbiAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgdHh0ID0gdHh0LnJlcGxhY2UoL1xccysvZywgXCJcIik7XG4gICAgICAgICAgICAgICAgdHh0ID0gdHh0LnJlcGxhY2Uoa2FuamlZZWFyLCBcIlwiKTtcbiAgICAgICAgICAgICAgICB0eHQgPSB0eHQucmVwbGFjZShrYW5qaU1vbnRoRGF5LCBcIi1cIik7XG4gICAgICAgICAgICAgICAgdHh0ID0gdHh0LnJlcGxhY2Uoa2FuamlSYW5nZSwgXCIvXCIpO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXC1cXC8vZywgXCIvXCIpO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC8tJC9nLFwiXCIpO1xuICAgICAgICAgICAgICAgIHZhciBzbHN0ID0gdHh0LnNwbGl0KGVwb2NoU3BsaXR0ZXIpO1xuICAgICAgICAgICAgICAgIGxzdCA9IFtdO1xuICAgICAgICAgICAgICAgIHZhciBtbSA9IHR4dC5tYXRjaChlcG9jaE1hdGNoZXIpO1xuICAgICAgICAgICAgICAgIGlmIChtbSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbW14ID0gW107XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPW1tLmxlbmd0aDsgaTxpbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1teCA9IG1teC5jb25jYXQobW1baV0ubWF0Y2goLyhbXjAtOV0rKShbMC05XSspLykuc2xpY2UoMSkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXNsc3QubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbHN0LnB1c2goc2xzdFtpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSAhPT0gKGxlbiAtIDEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1tcG9zID0gKHBvcyAqIDIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxzdC5wdXNoKG1teFttbXBvc10pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxzdC5wdXNoKG1teFttbXBvcyArIDFdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxzdCA9IHNsc3Q7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MSxpbGVuPWxzdC5sZW5ndGg7IGk8aWxlbjsgaSs9Mykge1xuICAgICAgICAgICAgICAgICAgICBsc3RbaSArIDFdID0gaml5W2xzdFtpXV0gKyBwYXJzZUludChsc3RbaSArIDFdLCAxMCk7XG4gICAgICAgICAgICAgICAgICAgIGxzdFtpXSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHR4dCA9IGxzdC5qb2luKFwiXCIpO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXHMqLVxccyokLywgXCJcIikucmVwbGFjZSgvXFxzKi1cXHMqXFwvLywgXCIvXCIpO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXC5cXHMqJC8sIFwiXCIpO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXC4oPyEgKS8sIFwiXCIpO1xuICAgICAgICAgICAgICAgIHNsYXNoUG9zID0gdHh0LmluZGV4T2YoXCIvXCIpO1xuICAgICAgICAgICAgICAgIGRhc2hQb3MgPSB0eHQuaW5kZXhPZihcIi1cIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdHh0ID0gdHh0LnJlcGxhY2UoLyhbQS1aYS16XSlcXC4vZywgXCIkMVwiKTtcbiAgICAgICAgdmFyIG51bWJlciA9IFwiXCI7XG4gICAgICAgIHZhciBub3RlID0gXCJcIjtcbiAgICAgICAgdmFyIHRoZWRhdGUgPSB7fTtcbiAgICAgICAgdmFyIHJhbmdlRGVsaW07XG4gICAgICAgIHZhciBkYXRlRGVsaW07XG4gICAgICAgIGlmICh0eHQuc2xpY2UoMCwgMSkgPT09IFwiXFxcIlwiICYmIHR4dC5zbGljZSgtMSkgPT09IFwiXFxcIlwiKSB7XG4gICAgICAgICAgICB0aGVkYXRlLmxpdGVyYWwgPSB0eHQuc2xpY2UoMSwgLTEpO1xuICAgICAgICAgICAgcmV0dXJuIHRoZWRhdGU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNsYXNoUG9zID4gLTEgJiYgZGFzaFBvcyA+IC0xKSB7XG4gICAgICAgICAgICB2YXIgc2xhc2hDb3VudCA9IHR4dC5zcGxpdChcIi9cIik7XG4gICAgICAgICAgICBpZiAoc2xhc2hDb3VudC5sZW5ndGggPiAzKSB7XG4gICAgICAgICAgICAgICAgcmFuZ2VEZWxpbSA9IFwiLVwiO1xuICAgICAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXF8vZywgXCItXCIpO1xuICAgICAgICAgICAgICAgIGRhdGVEZWxpbSA9IFwiL1wiO1xuICAgICAgICAgICAgICAgIGxzdCA9IHR4dC5zcGxpdChyZXhTbGFzaERhc2gpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByYW5nZURlbGltID0gXCIvXCI7XG4gICAgICAgICAgICAgICAgdHh0ID0gdHh0LnJlcGxhY2UoL1xcXy9nLCBcIi9cIik7XG4gICAgICAgICAgICAgICAgZGF0ZURlbGltID0gXCItXCI7XG4gICAgICAgICAgICAgICAgbHN0ID0gdHh0LnNwbGl0KHJleERhc2hTbGFzaCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0eHQgPSB0eHQucmVwbGFjZSgvXFwvL2csIFwiLVwiKTtcbiAgICAgICAgICAgIHR4dCA9IHR4dC5yZXBsYWNlKC9cXF8vZywgXCItXCIpO1xuICAgICAgICAgICAgcmFuZ2VEZWxpbSA9IFwiLVwiO1xuICAgICAgICAgICAgZGF0ZURlbGltID0gXCItXCI7XG4gICAgICAgICAgICBsc3QgPSB0eHQuc3BsaXQocmV4RGFzaCk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHJldCA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1sc3QubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdmFyIG0gPSBsc3RbaV0ubWF0Y2goL15cXHMqKFtcXC1cXC9dfFteXFwtXFwvXFx+XFw/MC05XSt8W1xcLX4/MC05XSspXFxzKiQvKTtcbiAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgcmV0LnB1c2gobVsxXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGRlbGltUG9zID0gcmV0LmluZGV4T2YocmFuZ2VEZWxpbSk7XG4gICAgICAgIHZhciBkZWxpbXMgPSBbXTtcbiAgICAgICAgdmFyIGlzUmFuZ2UgPSBmYWxzZTtcbiAgICAgICAgaWYgKGRlbGltUG9zID4gLTEpIHtcbiAgICAgICAgICAgIGRlbGltcy5wdXNoKFswLCBkZWxpbVBvc10pO1xuICAgICAgICAgICAgZGVsaW1zLnB1c2goWyhkZWxpbVBvcyArIDEpLCByZXQubGVuZ3RoXSk7XG4gICAgICAgICAgICBpc1JhbmdlID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRlbGltcy5wdXNoKFswLCByZXQubGVuZ3RoXSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHN1ZmYgPSBcIlwiO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1kZWxpbXMubGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgdmFyIGRlbGltID0gZGVsaW1zW2ldO1xuICAgICAgICAgICAgdmFyIGRhdGUgPSByZXQuc2xpY2UoZGVsaW1bMF0sIGRlbGltWzFdKTtcbiAgICAgICAgICAgIG91dGVyOiBcbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPWRhdGUubGVuZ3RoOyBqPGpsZW47IGorKykge1xuICAgICAgICAgICAgICAgIHZhciBlbGVtZW50ID0gZGF0ZVtqXTtcbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5pbmRleE9mKGRhdGVEZWxpbSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJzZU51bWVyaWNEYXRlKHRoZWRhdGUsIGRhdGVEZWxpbSwgc3VmZiwgZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5tYXRjaCgvWzAtOV17NH0vKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGVkYXRlWyhcInllYXJcIiArIHN1ZmYpXSA9IGVsZW1lbnQucmVwbGFjZSgvXjAqLywgXCJcIik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBrPTAsa2xlbj10aGlzLm1vbnRoUmV4ZXMubGVuZ3RoOyBrPGtsZW47IGsrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC50b0xvY2FsZUxvd2VyQ2FzZSgpLm1hdGNoKHRoaXMubW9udGhSZXhlc1trXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoZWRhdGVbKFwibW9udGhcIiArIHN1ZmYpXSA9IFwiXCIgKyAocGFyc2VJbnQoaywgMTApICsgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBvdXRlcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5tYXRjaCgvXlswLTldKyQvKSkge1xuICAgICAgICAgICAgICAgICAgICBudW1iZXIgPSBlbGVtZW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC50b0xvY2FsZUxvd2VyQ2FzZSgpLm1hdGNoKC9eYmMvKSAmJiBudW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhlZGF0ZVsoXCJ5ZWFyXCIgKyBzdWZmKV0gPSBcIlwiICsgKG51bWJlciAqIC0xKTtcbiAgICAgICAgICAgICAgICAgICAgbnVtYmVyID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LnRvTG9jYWxlTG93ZXJDYXNlKCkubWF0Y2goL15hZC8pICYmIG51bWJlcikge1xuICAgICAgICAgICAgICAgICAgICB0aGVkYXRlWyhcInllYXJcIiArIHN1ZmYpXSA9IFwiXCIgKyBudW1iZXI7XG4gICAgICAgICAgICAgICAgICAgIG51bWJlciA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudCA9PT0gXCJ+XCIgfHwgZWxlbWVudCA9PT0gXCI/XCIgfHwgZWxlbWVudCA9PT0gXCJjXCIgfHwgZWxlbWVudC5tYXRjaCgvXmNpci8pKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoZWRhdGUuY2lyY2EgPSBcIlwiICsgMTtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LnRvTG9jYWxlTG93ZXJDYXNlKCkubWF0Y2goLyg/Om1pY3x0cml8aGlsfGVhcykvKSAmJiAhdGhlZGF0ZVsoXCJzZWFzb25cIiArIHN1ZmYpXSkge1xuICAgICAgICAgICAgICAgICAgICBub3RlID0gZWxlbWVudDtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG51bWJlcikge1xuICAgICAgICAgICAgICAgIHRoZWRhdGVbKFwiZGF5XCIgKyBzdWZmKV0gPSBudW1iZXI7XG4gICAgICAgICAgICAgICAgbnVtYmVyID0gXCJcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChub3RlICYmICF0aGVkYXRlWyhcInNlYXNvblwiICsgc3VmZildKSB7XG4gICAgICAgICAgICAgICAgdGhlZGF0ZVsoXCJzZWFzb25cIiArIHN1ZmYpXSA9IG5vdGU7XG4gICAgICAgICAgICAgICAgbm90ZSA9IFwiXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdWZmID0gXCJfZW5kXCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlzUmFuZ2UpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPUNTTC5EQVRFX1BBUlRTX0FMTC5sZW5ndGg7IGo8amxlbjsgaisrKSB7XG4gICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSBDU0wuREFURV9QQVJUU19BTExbal07XG4gICAgICAgICAgICAgICAgaWYgKHRoZWRhdGVbaXRlbV0gJiYgIXRoZWRhdGVbKGl0ZW0gKyBcIl9lbmRcIildKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoZWRhdGVbKGl0ZW0gKyBcIl9lbmRcIildID0gdGhlZGF0ZVtpdGVtXTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGVkYXRlW2l0ZW1dICYmIHRoZWRhdGVbKGl0ZW0gKyBcIl9lbmRcIildKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoZWRhdGVbaXRlbV0gPSB0aGVkYXRlWyhpdGVtICsgXCJfZW5kXCIpXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGVkYXRlLnllYXIgfHwgKHRoZWRhdGUueWVhciAmJiB0aGVkYXRlLmRheSAmJiAhdGhlZGF0ZS5tb250aCkpIHtcbiAgICAgICAgICAgIHRoZWRhdGUgPSB7IFwibGl0ZXJhbFwiOiBvcmlnIH07XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHBhcnRzID0gW1wieWVhclwiLCBcIm1vbnRoXCIsIFwiZGF5XCIsIFwieWVhcl9lbmRcIiwgXCJtb250aF9lbmRcIiwgXCJkYXlfZW5kXCJdO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1wYXJ0cy5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgcGFydCA9IHBhcnRzW2ldO1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiB0aGVkYXRlW3BhcnRdICYmIHRoZWRhdGVbcGFydF0ubWF0Y2goL15bMC05XSskLykpIHtcbiAgICAgICAgICAgICAgICB0aGVkYXRlW3BhcnRdID0gcGFyc2VJbnQodGhlZGF0ZVtwYXJ0XSwgMTApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh5ZWFySXNOZWdhdGl2ZSAmJiBPYmplY3Qua2V5cyh0aGVkYXRlKS5pbmRleE9mKFwieWVhclwiKSA+IC0xKSB7XG4gICAgICAgICAgICB0aGVkYXRlLnllYXIgPSAodGhlZGF0ZS55ZWFyICogLTEpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGVkYXRlO1xuICAgIH07XG4gICAgdGhpcy5wYXJzZURhdGVUb0FycmF5ID0gZnVuY3Rpb24odHh0KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnZlcnREYXRlT2JqZWN0VG9BcnJheSh0aGlzLnBhcnNlRGF0ZVRvT2JqZWN0KHR4dCkpOyAgICAgICAgICAgIFxuICAgIH1cbiAgICB0aGlzLnBhcnNlRGF0ZVRvU3RyaW5nID0gZnVuY3Rpb24odHh0KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnZlcnREYXRlT2JqZWN0VG9TdHJpbmcodGhpcy5wYXJzZURhdGVUb09iamVjdCh0eHQpKTtcbiAgICB9XG4gICAgdGhpcy5wYXJzZSA9IGZ1bmN0aW9uKHR4dCkge1xuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZURhdGVUb09iamVjdCh0eHQpO1xuICAgIH1cbiAgICB0aGlzLnNldE9yZGVyTW9udGhEYXkoKTtcbiAgICB0aGlzLnJlc2V0RGF0ZVBhcnNlck1vbnRocygpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkVuZ2luZSA9IGZ1bmN0aW9uIChzeXMsIHN0eWxlLCBsYW5nLCBmb3JjZUxhbmcpIHtcbiAgICB2YXIgYXR0cnMsIGxhbmdzcGVjLCBsb2NhbGV4bWwsIGxvY2FsZTtcbiAgICB0aGlzLnByb2Nlc3Nvcl92ZXJzaW9uID0gQ1NMLlBST0NFU1NPUl9WRVJTSU9OO1xuICAgIHRoaXMuY3NsX3ZlcnNpb24gPSBcIjEuMFwiO1xuICAgIHRoaXMuc3lzID0gc3lzO1xuICAgIGlmIChzeXMudmFyaWFibGVXcmFwcGVyKSB7XG4gICAgICAgIENTTC5WQVJJQUJMRV9XUkFQUEVSX1BSRVBVTkNUX1JFWCA9IG5ldyBSZWdFeHAoJ14oWycgKyBbXCIgXCJdLmNvbmNhdChDU0wuU1dBUFBJTkdfUFVOQ1RVQVRJT04pLmpvaW4oXCJcIikgKyAnXSopKC4qKScpO1xuICAgIH1cbiAgICBpZiAoQ1NMLnJldHJpZXZlU3R5bGVNb2R1bGUpIHtcbiAgICAgICAgdGhpcy5zeXMucmV0cmlldmVTdHlsZU1vZHVsZSA9IENTTC5yZXRyaWV2ZVN0eWxlTW9kdWxlO1xuICAgIH1cbiAgICBpZiAoQ1NMLmdldEFiYnJldmlhdGlvbikge1xuICAgICAgICB0aGlzLnN5cy5nZXRBYmJyZXZpYXRpb24gPSBDU0wuZ2V0QWJicmV2aWF0aW9uO1xuICAgIH1cbiAgICBpZiAodGhpcy5zeXMuc3RyaW5nQ29tcGFyZSkge1xuICAgICAgICBDU0wuc3RyaW5nQ29tcGFyZSA9IHRoaXMuc3lzLnN0cmluZ0NvbXBhcmU7XG4gICAgfVxuICAgIHRoaXMuc3lzLkFiYnJldmlhdGlvblNlZ21lbnRzID0gQ1NMLkFiYnJldmlhdGlvblNlZ21lbnRzO1xuICAgIHRoaXMucGFyYWxsZWwgPSBuZXcgQ1NMLlBhcmFsbGVsKHRoaXMpO1xuICAgIHRoaXMudHJhbnNmb3JtID0gbmV3IENTTC5UcmFuc2Zvcm0odGhpcyk7XG4gICAgdGhpcy5zZXRQYXJzZU5hbWVzID0gZnVuY3Rpb24gKHZhbCkge1xuICAgICAgICB0aGlzLm9wdFsncGFyc2UtbmFtZXMnXSA9IHZhbDtcbiAgICB9O1xuICAgIHRoaXMub3B0ID0gbmV3IENTTC5FbmdpbmUuT3B0KCk7XG4gICAgdGhpcy50bXAgPSBuZXcgQ1NMLkVuZ2luZS5UbXAoKTtcbiAgICB0aGlzLmJ1aWxkID0gbmV3IENTTC5FbmdpbmUuQnVpbGQoKTtcbiAgICB0aGlzLmZ1biA9IG5ldyBDU0wuRW5naW5lLkZ1bih0aGlzKTtcbiAgICB0aGlzLmNvbmZpZ3VyZSA9IG5ldyBDU0wuRW5naW5lLkNvbmZpZ3VyZSgpO1xuICAgIHRoaXMuY2l0YXRpb25fc29ydCA9IG5ldyBDU0wuRW5naW5lLkNpdGF0aW9uU29ydCgpO1xuICAgIHRoaXMuYmlibGlvZ3JhcGh5X3NvcnQgPSBuZXcgQ1NMLkVuZ2luZS5CaWJsaW9ncmFwaHlTb3J0KCk7XG4gICAgdGhpcy5jaXRhdGlvbiA9IG5ldyBDU0wuRW5naW5lLkNpdGF0aW9uKHRoaXMpO1xuICAgIHRoaXMuYmlibGlvZ3JhcGh5ID0gbmV3IENTTC5FbmdpbmUuQmlibGlvZ3JhcGh5KCk7XG4gICAgdGhpcy5vdXRwdXQgPSBuZXcgQ1NMLk91dHB1dC5RdWV1ZSh0aGlzKTtcbiAgICB0aGlzLmRhdGVwdXQgPSBuZXcgQ1NMLk91dHB1dC5RdWV1ZSh0aGlzKTtcbiAgICB0aGlzLmNzbFhtbCA9IENTTC5zZXR1cFhtbChzdHlsZSk7XG4gICAgaWYgKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuY3NsX3JldmVyc2VfbG9va3VwX3N1cHBvcnQgfHwgdGhpcy5zeXMuY3NsX3JldmVyc2VfbG9va3VwX3N1cHBvcnQpIHtcbiAgICAgICAgdGhpcy5idWlsZC5jc2xOb2RlSWQgPSAwO1xuICAgICAgICB0aGlzLnNldENzbE5vZGVJZHMgPSBmdW5jdGlvbihteXhtbCwgbm9kZW5hbWUpIHtcbiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY3NsWG1sLmNoaWxkcmVuKG15eG1sKTtcbiAgICAgICAgICAgIHRoaXMuY3NsWG1sLnNldEF0dHJpYnV0ZShteXhtbCwgJ2NzbGlkJywgdGhpcy5idWlsZC5jc2xOb2RlSWQpO1xuICAgICAgICAgICAgdGhpcy5vcHQubm9kZW5hbWVzLnB1c2gobm9kZW5hbWUpO1xuICAgICAgICAgICAgdGhpcy5idWlsZC5jc2xOb2RlSWQgKz0gMTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5jc2xYbWwubnVtYmVyb2Zub2RlcyhjaGlsZHJlbik7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBub2RlbmFtZSA9IHRoaXMuY3NsWG1sLm5vZGVuYW1lKGNoaWxkcmVuW2ldKTtcbiAgICAgICAgICAgICAgICBpZiAobm9kZW5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDc2xOb2RlSWRzKGNoaWxkcmVuW2ldLCBub2RlbmFtZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNldENzbE5vZGVJZHModGhpcy5jc2xYbWwuZGF0YU9iaiwgXCJzdHlsZVwiKTtcbiAgICB9XG4gICAgdGhpcy5jc2xYbWwuYWRkTWlzc2luZ05hbWVOb2Rlcyh0aGlzLmNzbFhtbC5kYXRhT2JqKTtcbiAgICB0aGlzLmNzbFhtbC5hZGRJbnN0aXR1dGlvbk5vZGVzKHRoaXMuY3NsWG1sLmRhdGFPYmopO1xuICAgIHRoaXMuY3NsWG1sLmluc2VydFB1Ymxpc2hlckFuZFBsYWNlKHRoaXMuY3NsWG1sLmRhdGFPYmopO1xuICAgIHRoaXMuY3NsWG1sLmZsYWdEYXRlTWFjcm9zKHRoaXMuY3NsWG1sLmRhdGFPYmopO1xuICAgIGF0dHJzID0gdGhpcy5jc2xYbWwuYXR0cmlidXRlcyh0aGlzLmNzbFhtbC5kYXRhT2JqKTtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGF0dHJzW1wiQHNvcnQtc2VwYXJhdG9yXCJdKSB7XG4gICAgICAgIHRoaXMuY3NsWG1sLnNldEF0dHJpYnV0ZSh0aGlzLmNzbFhtbC5kYXRhT2JqLCBcInNvcnQtc2VwYXJhdG9yXCIsIFwiLCBcIik7XG4gICAgfVxuICAgIHRoaXMub3B0W1wiaW5pdGlhbGl6ZS13aXRoLWh5cGhlblwiXSA9IHRydWU7XG4gICAgdGhpcy5zZXRTdHlsZUF0dHJpYnV0ZXMoKTtcbiAgICB0aGlzLm9wdC54Y2xhc3MgPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZSh0aGlzLmNzbFhtbC5kYXRhT2JqLCBcImNsYXNzXCIpO1xuICAgIHRoaXMub3B0W1wiY2xhc3NcIl0gPSB0aGlzLm9wdC54Y2xhc3M7XG4gICAgdGhpcy5vcHQuc3R5bGVJRCA9IHRoaXMuY3NsWG1sLmdldFN0eWxlSWQodGhpcy5jc2xYbWwuZGF0YU9iaik7XG4gICAgaWYgKENTTC5zZXRTdXBwcmVzc2VkSnVyaXNkaWN0aW9ucykge1xuICAgICAgICBDU0wuc2V0U3VwcHJlc3NlZEp1cmlzZGljdGlvbnModGhpcy5vcHQuc3R5bGVJRCwgdGhpcy5vcHQuc3VwcHJlc3NlZEp1cmlzZGljdGlvbnMpO1xuICAgIH1cbiAgICB0aGlzLm9wdC5zdHlsZU5hbWUgPSB0aGlzLmNzbFhtbC5nZXRTdHlsZUlkKHRoaXMuY3NsWG1sLmRhdGFPYmosIHRydWUpO1xuICAgIGlmICh0aGlzLm9wdC52ZXJzaW9uLnNsaWNlKDAsNCkgPT09IFwiMS4xbVwiKSB7XG4gICAgICAgIHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3RhdGljX3N0YXR1dGVfbG9jYXRvciA9IHRydWU7XG4gICAgICAgIHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuaGFuZGxlX3BhcmFsbGVsX2FydGljbGVzID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5tYWluX3RpdGxlX2Zyb21fc2hvcnRfdGl0bGUgPSB0cnVlO1xuICAgICAgICB0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnJ0bF9zdXBwb3J0ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5leHBlY3RfYW5kX3N5bWJvbF9mb3JtID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5yZXF1aXJlX2V4cGxpY2l0X2xlZ2FsX2Nhc2VfdGl0bGVfc2hvcnQgPSB0cnVlO1xuICAgICAgICB0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmZvcmNlX2p1cmlzZGljdGlvbiA9IHRydWU7XG4gICAgfVxuICAgIGlmIChsYW5nKSB7XG4gICAgICAgIGxhbmcgPSBsYW5nLnJlcGxhY2UoXCJfXCIsIFwiLVwiKTtcbiAgICAgICAgbGFuZyA9IENTTC5ub3JtYWxpemVMb2NhbGVTdHIobGFuZyk7XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdKSB7XG4gICAgICAgIHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0gPSB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdLnJlcGxhY2UoXCJfXCIsIFwiLVwiKTtcbiAgICAgICAgdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXSA9IENTTC5ub3JtYWxpemVMb2NhbGVTdHIodGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXSk7XG4gICAgfVxuICAgIGlmIChsYW5nICYmIGZvcmNlTGFuZykge1xuICAgICAgICB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdID0gW2xhbmddO1xuICAgIH1cbiAgICBpZiAobGFuZyAmJiAhZm9yY2VMYW5nICYmIHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0pIHtcbiAgICAgICAgbGFuZyA9IHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF07XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBpZiAoIWxhbmcpIHtcbiAgICAgICAgICAgIGxhbmcgPSBcImVuLVVTXCI7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXS5wdXNoKFwiZW4tVVNcIik7XG4gICAgfVxuICAgIGlmICghbGFuZykge1xuICAgICAgICBsYW5nID0gdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXTtcbiAgICB9XG4gICAgbGFuZ3NwZWMgPSBDU0wubG9jYWxlUmVzb2x2ZShsYW5nKTtcbiAgICB0aGlzLm9wdC5sYW5nID0gbGFuZ3NwZWMuYmVzdDtcbiAgICB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdID0gbGFuZ3NwZWMuYmVzdDtcbiAgICB0aGlzLmxvY2FsZSA9IHt9O1xuICAgIGlmICghdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZS1zb3J0XCJdKSB7XG4gICAgICAgIHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGUtc29ydFwiXSA9IHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF07XG4gICAgfVxuICAgIGlmICgnZGFsZXwnLmxvY2FsZUNvbXBhcmUoJ2RhbGViJywgdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZS1zb3J0XCJdKSA+IC0xKSB7XG4gICAgICAgIHRoaXMub3B0LnNvcnRfc2VwID0gXCJAXCI7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5vcHQuc29ydF9zZXAgPSBcInxcIjtcbiAgICB9XG4gICAgdGhpcy5sb2NhbGVDb25maWd1cmUobGFuZ3NwZWMpO1xuICAgIGZ1bmN0aW9uIG1ha2VSZWdFeHAobHN0KSB7XG4gICAgICAgIHZhciBsc3QgPSBsc3Quc2xpY2UoKTtcbiAgICAgICAgdmFyIHJldCA9IG5ldyBSZWdFeHAoIFwiKD86KD86Wz8hOl0qXFxcXHMrfC18XikoPzpcIiArIGxzdC5qb2luKFwifFwiKSArIFwiKSg/PVshPzpdKlxcXFxzK3wtfCQpKVwiLCBcImdcIik7XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuICAgIHRoaXMubG9jYWxlW3RoaXMub3B0LmxhbmddLm9wdHNbXCJza2lwLXdvcmRzLXJlZ2V4cFwiXSA9IG1ha2VSZWdFeHAodGhpcy5sb2NhbGVbdGhpcy5vcHQubGFuZ10ub3B0c1tcInNraXAtd29yZHNcIl0pO1xuICAgIHRoaXMub3V0cHV0LmFkanVzdCA9IG5ldyBDU0wuT3V0cHV0LlF1ZXVlLmFkanVzdCh0aGlzLmdldE9wdCgncHVuY3R1YXRpb24taW4tcXVvdGUnKSk7XG4gICAgdGhpcy5yZWdpc3RyeSA9IG5ldyBDU0wuUmVnaXN0cnkodGhpcyk7XG4gICAgdGhpcy5tYWNyb3MgPSB7fTtcbiAgICB0aGlzLmJ1aWxkLmFyZWEgPSBcImNpdGF0aW9uXCI7XG4gICAgdmFyIGFyZWFfbm9kZXMgPSB0aGlzLmNzbFhtbC5nZXROb2Rlc0J5TmFtZSh0aGlzLmNzbFhtbC5kYXRhT2JqLCB0aGlzLmJ1aWxkLmFyZWEpO1xuICAgIHRoaXMuYnVpbGRUb2tlbkxpc3RzKGFyZWFfbm9kZXMsIHRoaXNbdGhpcy5idWlsZC5hcmVhXS50b2tlbnMpO1xuICAgIHRoaXMuYnVpbGQuYXJlYSA9IFwiYmlibGlvZ3JhcGh5XCI7XG4gICAgdmFyIGFyZWFfbm9kZXMgPSB0aGlzLmNzbFhtbC5nZXROb2Rlc0J5TmFtZSh0aGlzLmNzbFhtbC5kYXRhT2JqLCB0aGlzLmJ1aWxkLmFyZWEpO1xuICAgIHRoaXMuYnVpbGRUb2tlbkxpc3RzKGFyZWFfbm9kZXMsIHRoaXNbdGhpcy5idWlsZC5hcmVhXS50b2tlbnMpO1xuICAgIHRoaXMuanVyaXMgPSB7fTtcbiAgICB0aGlzLmNvbmZpZ3VyZVRva2VuTGlzdHMoKTtcbiAgICB0aGlzLmRpc2FtYmlndWF0ZSA9IG5ldyBDU0wuRGlzYW1iaWd1YXRpb24odGhpcyk7XG4gICAgdGhpcy5zcGxpY2VfZGVsaW1pdGVyID0gZmFsc2U7XG4gICAgdGhpcy5mdW4uZGF0ZXBhcnNlciA9IENTTC5EYXRlUGFyc2VyO1xuICAgIHRoaXMuZnVuLmZsaXBmbG9wcGVyID0gbmV3IENTTC5VdGlsLkZsaXBGbG9wcGVyKHRoaXMpO1xuICAgIHRoaXMuc2V0Q2xvc2VRdW90ZXNBcnJheSgpO1xuICAgIHRoaXMuZnVuLm9yZGluYWxpemVyLmluaXQodGhpcyk7XG4gICAgdGhpcy5mdW4ubG9uZ19vcmRpbmFsaXplci5pbml0KHRoaXMpO1xuICAgIHRoaXMuZnVuLnBhZ2VfbWFuZ2xlciA9IENTTC5VdGlsLlBhZ2VSYW5nZU1hbmdsZXIuZ2V0RnVuY3Rpb24odGhpcywgXCJwYWdlXCIpO1xuICAgIHRoaXMuZnVuLnllYXJfbWFuZ2xlciA9IENTTC5VdGlsLlBhZ2VSYW5nZU1hbmdsZXIuZ2V0RnVuY3Rpb24odGhpcywgXCJ5ZWFyXCIpO1xuICAgIHRoaXMuc2V0T3V0cHV0Rm9ybWF0KFwiaHRtbFwiKTtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5zZXRDbG9zZVF1b3Rlc0FycmF5ID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciByZXQ7XG4gICAgcmV0ID0gW107XG4gICAgcmV0LnB1c2godGhpcy5nZXRUZXJtKFwiY2xvc2UtcXVvdGVcIikpO1xuICAgIHJldC5wdXNoKHRoaXMuZ2V0VGVybShcImNsb3NlLWlubmVyLXF1b3RlXCIpKTtcbiAgICByZXQucHVzaCgnXCInKTtcbiAgICByZXQucHVzaChcIidcIik7XG4gICAgdGhpcy5vcHQuY2xvc2VfcXVvdGVzX2FycmF5ID0gcmV0O1xufTtcbkNTTC5tYWtlQnVpbGRlciA9IGZ1bmN0aW9uIChtZSwgdGFyZ2V0KSB7XG4gICAgZnVuY3Rpb24gZW50ZXJGdW5jIChub2RlKSB7XG4gICAgICAgIENTTC5YbWxUb1Rva2VuLmNhbGwobm9kZSwgbWUsIENTTC5TVEFSVCwgdGFyZ2V0KTtcbiAgICB9O1xuICAgIGZ1bmN0aW9uIGxlYXZlRnVuYyAobm9kZSkge1xuICAgICAgICBDU0wuWG1sVG9Ub2tlbi5jYWxsKG5vZGUsIG1lLCBDU0wuRU5ELCB0YXJnZXQpO1xuICAgIH07XG4gICAgZnVuY3Rpb24gc2luZ2xldG9uRnVuYyAobm9kZSkge1xuICAgICAgICBDU0wuWG1sVG9Ub2tlbi5jYWxsKG5vZGUsIG1lLCBDU0wuU0lOR0xFVE9OLCB0YXJnZXQpO1xuICAgIH07XG4gICAgZnVuY3Rpb24gYnVpbGRTdHlsZSAobm9kZSkge1xuICAgICAgICB2YXIgc3RhcnR0YWcsIG9yaWdwYXJlbnQ7XG4gICAgICAgIGlmIChtZS5jc2xYbWwubnVtYmVyb2Zub2RlcyhtZS5jc2xYbWwuY2hpbGRyZW4obm9kZSkpKSB7XG4gICAgICAgICAgICBvcmlncGFyZW50ID0gbm9kZTtcbiAgICAgICAgICAgIGVudGVyRnVuYyhvcmlncGFyZW50KTtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MDtpPG1lLmNzbFhtbC5udW1iZXJvZm5vZGVzKG1lLmNzbFhtbC5jaGlsZHJlbihvcmlncGFyZW50KSk7aSs9MSkge1xuICAgICAgICAgICAgICAgIG5vZGUgPSBtZS5jc2xYbWwuY2hpbGRyZW4ob3JpZ3BhcmVudClbaV07XG4gICAgICAgICAgICAgICAgaWYgKG1lLmNzbFhtbC5ub2RlbmFtZShub2RlKSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG1lLmNzbFhtbC5ub2RlbmFtZShub2RlKSA9PT0gXCJkYXRlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgQ1NMLlV0aWwuZml4RGF0ZU5vZGUuY2FsbChtZSwgb3JpZ3BhcmVudCwgaSwgbm9kZSlcbiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG1lLmNzbFhtbC5jaGlsZHJlbihvcmlncGFyZW50KVtpXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnVpbGRTdHlsZShub2RlLCBlbnRlckZ1bmMsIGxlYXZlRnVuYywgc2luZ2xldG9uRnVuYyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZWF2ZUZ1bmMob3JpZ3BhcmVudCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzaW5nbGV0b25GdW5jKG5vZGUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBidWlsZFN0eWxlO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmJ1aWxkVG9rZW5MaXN0cyA9IGZ1bmN0aW9uIChhcmVhX25vZGVzLCB0YXJnZXQpIHtcbiAgICBpZiAoIXRoaXMuY3NsWG1sLmdldE5vZGVWYWx1ZShhcmVhX25vZGVzKSkgcmV0dXJuO1xuICAgIHZhciBidWlsZGVyID0gQ1NMLm1ha2VCdWlsZGVyKHRoaXMsIHRhcmdldCk7XG4gICAgdmFyIG15bm9kZTtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGFyZWFfbm9kZXMubGVuZ3RoKSB7XG4gICAgICAgIG15bm9kZSA9IGFyZWFfbm9kZXM7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbXlub2RlID0gYXJlYV9ub2Rlc1swXTtcbiAgICB9XG4gICAgYnVpbGRlcihteW5vZGUpO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldFN0eWxlQXR0cmlidXRlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgZHVtbXksIGF0dHIsIGtleSwgYXR0cmlidXRlcywgYXR0cm5hbWU7XG4gICAgdmFyIGR1bW15ID0ge307XG4gICAgZHVtbXkubmFtZSA9IHRoaXMuY3NsWG1sLm5vZGVuYW1lKHRoaXMuY3NsWG1sLmRhdGFPYmopO1xuICAgIGF0dHJpYnV0ZXMgPSB0aGlzLmNzbFhtbC5hdHRyaWJ1dGVzKHRoaXMuY3NsWG1sLmRhdGFPYmopO1xuICAgIGZvciAoYXR0cm5hbWUgaW4gYXR0cmlidXRlcykge1xuICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShhdHRybmFtZSkpIHtcbiAgICAgICAgICAgIENTTC5BdHRyaWJ1dGVzW2F0dHJuYW1lXS5jYWxsKGR1bW15LCB0aGlzLCBhdHRyaWJ1dGVzW2F0dHJuYW1lXSk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuZ2V0VGVybSA9IGZ1bmN0aW9uICh0ZXJtLCBmb3JtLCBwbHVyYWwsIGdlbmRlciwgbW9kZSwgZm9yY2VEZWZhdWx0TG9jYWxlKSB7XG4gICAgaWYgKHRlcm0gJiYgdGVybS5tYXRjaCgvW0EtWl0vKSAmJiB0ZXJtID09PSB0ZXJtLnRvVXBwZXJDYXNlKCkpIHtcbiAgICAgICAgQ1NMLmRlYnVnKFwiV2FybmluZzogdGVybSBrZXkgaXMgaW4gdXBwZXJjYXNlIGZvcm06IFwiK3Rlcm0pO1xuICAgICAgICB0ZXJtID0gdGVybS50b0xvd2VyQ2FzZSgpO1xuICAgIH1cbiAgICB2YXIgbGFuZztcbiAgICBpZiAoZm9yY2VEZWZhdWx0TG9jYWxlKSB7XG4gICAgICAgIGxhbmcgPSB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxhbmcgPSB0aGlzLm9wdC5sYW5nO1xuICAgIH1cbiAgICB2YXIgcmV0ID0gQ1NMLkVuZ2luZS5nZXRGaWVsZChDU0wuTE9PU0UsIHRoaXMubG9jYWxlW2xhbmddLnRlcm1zLCB0ZXJtLCBmb3JtLCBwbHVyYWwsIGdlbmRlcik7XG4gICAgaWYgKCFyZXQgJiYgdGVybSA9PT0gXCJyYW5nZS1kZWxpbWl0ZXJcIikge1xuICAgICAgICByZXQgPSBcIlxcdTIwMTNcIjtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiByZXQgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgaWYgKG1vZGUgPT09IENTTC5TVFJJQ1QpIHtcbiAgICAgICAgICAgIHRocm93IFwiRXJyb3IgaW4gZ2V0VGVybTogdGVybSBcXFwiXCIgKyB0ZXJtICsgXCJcXFwiIGRvZXMgbm90IGV4aXN0LlwiO1xuICAgICAgICB9IGVsc2UgaWYgKG1vZGUgPT09IENTTC5UT0xFUkFOVCkge1xuICAgICAgICAgICAgcmV0ID0gXCJcIjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAocmV0KSB7XG4gICAgICAgIHRoaXMudG1wLmNpdGVfcmVuZGVyc19jb250ZW50ID0gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5nZXREYXRlID0gZnVuY3Rpb24gKGZvcm0sIGZvcmNlRGVmYXVsdExvY2FsZSkge1xuICAgIHZhciBsYW5nO1xuICAgIGlmIChmb3JjZURlZmF1bHRMb2NhbGUpIHtcbiAgICAgICAgbGFuZyA9IHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbGFuZyA9IHRoaXMub3B0Lmxhbmc7XG4gICAgfVxuICAgIGlmICh0aGlzLmxvY2FsZVtsYW5nXS5kYXRlc1tmb3JtXSkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVbbGFuZ10uZGF0ZXNbZm9ybV07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5nZXRPcHQgPSBmdW5jdGlvbiAoYXJnKSB7XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB0aGlzLmxvY2FsZVt0aGlzLm9wdC5sYW5nXS5vcHRzW2FyZ10pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlW3RoaXMub3B0LmxhbmddLm9wdHNbYXJnXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmdldFZhcmlhYmxlID0gZnVuY3Rpb24gKEl0ZW0sIHZhcm5hbWUsIGZvcm0sIHBsdXJhbCkge1xuICAgIHJldHVybiBDU0wuRW5naW5lLmdldEZpZWxkKENTTC5MT09TRSwgSXRlbSwgdmFybmFtZSwgZm9ybSwgcGx1cmFsKTtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5nZXREYXRlTnVtID0gZnVuY3Rpb24gKEl0ZW1GaWVsZCwgcGFydG5hbWUpIHtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIEl0ZW1GaWVsZCkge1xuICAgICAgICByZXR1cm4gMDtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gSXRlbUZpZWxkW3BhcnRuYW1lXTtcbiAgICB9XG59O1xuQ1NMLkVuZ2luZS5nZXRGaWVsZCA9IGZ1bmN0aW9uIChtb2RlLCBoYXNoLCB0ZXJtLCBmb3JtLCBwbHVyYWwsIGdlbmRlcikge1xuICAgIHZhciByZXQsIGZvcm1zLCBmLCBwb3MsIGxlbiwgaGFzaHRlcm07XG4gICAgcmV0ID0gXCJcIjtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGhhc2hbdGVybV0pIHtcbiAgICAgICAgaWYgKG1vZGUgPT09IENTTC5TVFJJQ1QpIHtcbiAgICAgICAgICAgIHRocm93IFwiRXJyb3IgaW4gZ2V0RmllbGQ6IHRlcm0gXFxcIlwiICsgdGVybSArIFwiXFxcIiBkb2VzIG5vdCBleGlzdC5cIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGdlbmRlciAmJiBoYXNoW3Rlcm1dW2dlbmRlcl0pIHtcbiAgICAgICAgaGFzaHRlcm0gPSBoYXNoW3Rlcm1dW2dlbmRlcl07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaGFzaHRlcm0gPSBoYXNoW3Rlcm1dO1xuICAgIH1cbiAgICBmb3JtcyA9IFtdO1xuICAgIGlmIChmb3JtID09PSBcInN5bWJvbFwiKSB7XG4gICAgICAgIGZvcm1zID0gW1wic3ltYm9sXCIsIFwic2hvcnRcIl07XG4gICAgfSBlbHNlIGlmIChmb3JtID09PSBcInZlcmItc2hvcnRcIikge1xuICAgICAgICBmb3JtcyA9IFtcInZlcmItc2hvcnRcIiwgXCJ2ZXJiXCJdO1xuICAgIH0gZWxzZSBpZiAoZm9ybSAhPT0gXCJsb25nXCIpIHtcbiAgICAgICAgZm9ybXMgPSBbZm9ybV07XG4gICAgfVxuICAgIGZvcm1zID0gZm9ybXMuY29uY2F0KFtcImxvbmdcIl0pO1xuICAgIGxlbiA9IGZvcm1zLmxlbmd0aDtcbiAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgZiA9IGZvcm1zW3Bvc107XG4gICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgaGFzaHRlcm0gfHwgXCJudW1iZXJcIiA9PT0gdHlwZW9mIGhhc2h0ZXJtKSB7XG4gICAgICAgICAgICByZXQgPSBoYXNodGVybTtcbiAgICAgICAgfSBlbHNlIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgaGFzaHRlcm1bZl0pIHtcbiAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgaGFzaHRlcm1bZl0gfHwgXCJudW1iZXJcIiA9PT0gdHlwZW9mIGhhc2h0ZXJtW2ZdKSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gaGFzaHRlcm1bZl07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChcIm51bWJlclwiID09PSB0eXBlb2YgcGx1cmFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldCA9IGhhc2h0ZXJtW2ZdW3BsdXJhbF07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0ID0gaGFzaHRlcm1bZl1bMF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5jb25maWd1cmVUb2tlbkxpc3RzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBkYXRlcGFydHNfbWFzdGVyLCBhcmVhLCBwb3MsIHRva2VuLCBkYXRlcGFydHMsIHBhcnQsIHBwb3MsIHBwcG9zLCBsZW4sIGxsZW4sIGxsbGVuO1xuICAgIGxlbiA9IENTTC5BUkVBUy5sZW5ndGg7XG4gICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIGFyZWEgPSBDU0wuQVJFQVNbcG9zXTtcbiAgICAgICAgdmFyIHRva2VucyA9IHRoaXNbYXJlYV0udG9rZW5zO1xuICAgICAgICB0aGlzLmNvbmZpZ3VyZVRva2VuTGlzdCh0b2tlbnMpO1xuICAgIH1cbiAgICB0aGlzLnZlcnNpb24gPSBDU0wudmVyc2lvbjtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZTtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5jb25maWd1cmVUb2tlbkxpc3QgPSBmdW5jdGlvbiAodG9rZW5zKSB7XG4gICAgdmFyIGRhdGVwYXJ0c19tYXN0ZXIsIGFyZWEsIHBvcywgdG9rZW4sIGRhdGVwYXJ0cywgcGFydCwgcHBvcywgcHBwb3MsIGxlbiwgbGxlbiwgbGxsZW47XG4gICAgZGF0ZXBhcnRzX21hc3RlciA9IFtcInllYXJcIiwgXCJtb250aFwiLCBcImRheVwiXTtcbiAgICBsbGVuID0gdG9rZW5zLmxlbmd0aCAtIDE7XG4gICAgZm9yIChwcG9zID0gbGxlbjsgcHBvcyA+IC0xOyBwcG9zICs9IC0xKSB7XG4gICAgICAgIHRva2VuID0gdG9rZW5zW3Bwb3NdO1xuICAgICAgICBpZiAoXCJkYXRlXCIgPT09IHRva2VuLm5hbWUgJiYgQ1NMLkVORCA9PT0gdG9rZW4udG9rZW50eXBlKSB7XG4gICAgICAgICAgICBkYXRlcGFydHMgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJkYXRlLXBhcnRcIiA9PT0gdG9rZW4ubmFtZSAmJiB0b2tlbi5zdHJpbmdzLm5hbWUpIHtcbiAgICAgICAgICAgIGxsbGVuID0gZGF0ZXBhcnRzX21hc3Rlci5sZW5ndGg7XG4gICAgICAgICAgICBmb3IgKHBwcG9zID0gMDsgcHBwb3MgPCBsbGxlbjsgcHBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgIHBhcnQgPSBkYXRlcGFydHNfbWFzdGVyW3BwcG9zXTtcbiAgICAgICAgICAgICAgICBpZiAocGFydCA9PT0gdG9rZW4uc3RyaW5ncy5uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGVwYXJ0cy5wdXNoKHRva2VuLnN0cmluZ3MubmFtZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChcImRhdGVcIiA9PT0gdG9rZW4ubmFtZSAmJiBDU0wuU1RBUlQgPT09IHRva2VuLnRva2VudHlwZSkge1xuICAgICAgICAgICAgZGF0ZXBhcnRzLnJldmVyc2UoKTtcbiAgICAgICAgICAgIHRva2VuLmRhdGVwYXJ0cyA9IGRhdGVwYXJ0cztcbiAgICAgICAgfVxuICAgICAgICB0b2tlbi5uZXh0ID0gKHBwb3MgKyAxKTtcbiAgICAgICAgaWYgKHRva2VuLm5hbWUgJiYgQ1NMLk5vZGVbdG9rZW4ubmFtZV0uY29uZmlndXJlKSB7XG4gICAgICAgICAgICBDU0wuTm9kZVt0b2tlbi5uYW1lXS5jb25maWd1cmUuY2FsbCh0b2tlbiwgdGhpcywgcHBvcyk7XG4gICAgICAgIH1cbiAgICB9XG59XG5DU0wuRW5naW5lLnByb3RvdHlwZS5yZXRyaWV2ZUl0ZW1zID0gZnVuY3Rpb24gKGlkcykge1xuICAgIHZhciByZXQsIHBvcywgbGVuO1xuICAgIHJldCA9IFtdO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gaWRzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICByZXQucHVzaCh0aGlzLnJldHJpZXZlSXRlbShcIlwiICsgaWRzW2ldKSk7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLklURVJBVElPTiA9IDA7XG5DU0wuRW5naW5lLnByb3RvdHlwZS5yZXRyaWV2ZUl0ZW0gPSBmdW5jdGlvbiAoaWQpIHtcbiAgICB2YXIgSXRlbSwgbSwgcG9zLCBsZW4sIG1tLCBpO1xuICAgIGlmICghdGhpcy50bXAubG9hZGVkSXRlbUlEc1tpZF0pIHtcbiAgICAgICAgdGhpcy50bXAubG9hZGVkSXRlbUlEc1tpZF0gPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlZ2lzdHJ5LnJlZmhhc2hbaWRdO1xuICAgIH1cbiAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ub3JtYWxpemVfbGFuZ19rZXlzX3RvX2xvd2VyY2FzZSAmJlxuICAgICAgICBcImJvb2xlYW5cIiA9PT0gdHlwZW9mIHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMubm9ybWFsaXplX2xhbmdfa2V5c190b19sb3dlcmNhc2UpIHtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXS5sZW5ndGg7IGk8aWxlbjsgaSs9MSkge1xuICAgICAgICAgICAgdGhpcy5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVtpXSA9IHRoaXMub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1baV0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj10aGlzLm9wdFtcImxvY2FsZS10cmFuc2xpdFwiXS5sZW5ndGg7IGk8aWxlbjsgaSs9MSkge1xuICAgICAgICAgICAgdGhpcy5vcHRbXCJsb2NhbGUtdHJhbnNsaXRcIl1baV0gPSB0aGlzLm9wdFtcImxvY2FsZS10cmFuc2xpdFwiXVtpXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMub3B0W1wibG9jYWxlLXRyYW5zbGF0XCJdLmxlbmd0aDsgaTxpbGVuOyBpKz0xKSB7XG4gICAgICAgICAgICB0aGlzLm9wdFtcImxvY2FsZS10cmFuc2xhdFwiXVtpXSA9IHRoaXMub3B0W1wibG9jYWxlLXRyYW5zbGF0XCJdW2ldLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ub3JtYWxpemVfbGFuZ19rZXlzX3RvX2xvd2VyY2FzZSA9IDEwMDtcbiAgICB9XG4gICAgQ1NMLklURVJBVElPTiArPSAxO1xuICAgIEl0ZW0gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuc3lzLnJldHJpZXZlSXRlbShcIlwiICsgaWQpKSk7XG4gICAgaWYgKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMubm9ybWFsaXplX2xhbmdfa2V5c190b19sb3dlcmNhc2UpIHtcbiAgICAgICAgaWYgKEl0ZW0ubXVsdGkpIHtcbiAgICAgICAgICAgIGlmIChJdGVtLm11bHRpLl9rZXlzKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgZmllbGQgaW4gSXRlbS5tdWx0aS5fa2V5cykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gSXRlbS5tdWx0aS5fa2V5c1tmaWVsZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgIT09IGtleS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgSXRlbS5tdWx0aS5fa2V5c1tmaWVsZF1ba2V5LnRvTG93ZXJDYXNlKCldID0gSXRlbS5tdWx0aS5fa2V5c1tmaWVsZF1ba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgSXRlbS5tdWx0aS5fa2V5c1tmaWVsZF1ba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChJdGVtLm11bHRpLm1haW4pIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBmaWVsZCBpbiBJdGVtLm11bHRpLm1haW4pIHtcbiAgICAgICAgICAgICAgICAgICAgSXRlbS5tdWx0aS5tYWluW2ZpZWxkXSA9IEl0ZW0ubXVsdGkubWFpbltmaWVsZF0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaT0wLCBpbGVuPUNTTC5DUkVBVE9SUy5sZW5ndGg7IGk+aWxlbjsgaSs9MSkge1xuICAgICAgICAgICAgdmFyIGN0eXBlID0gQ1NMLkNSRUFUT1JTW2ldO1xuICAgICAgICAgICAgaWYgKEl0ZW1bY3R5cGVdICYmIEl0ZW1bY3R5cGVdLm11bHRpKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaj0wLCBqbGVuPUl0ZW1bY3R5cGVdLmxlbmd0aDsgajxqbGVuOyBqKz0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjcmVhdG9yID0gSXRlbVtjdHlwZV1bal07XG4gICAgICAgICAgICAgICAgICAgIGlmIChjcmVhdG9yLm11bHRpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3JlYXRvci5tdWx0aS5fa2V5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGNyZWF0b3IubXVsdGkuX2tleSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBrZXkudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRvci5tdWx0aS5fa2V5W2tleS50b0xvd2VyQ2FzZSgpXSA9IGNyZWF0b3IubXVsdGkuX2tleVtrZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNyZWF0b3IubXVsdGkuX2tleVtrZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNyZWF0b3IubXVsdGkubWFpbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0b3IubXVsdGkubWFpbiA9IGNyZWF0b3IubXVsdGkubWFpbi50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLnN5cy5nZXRMYW5ndWFnZU5hbWUgJiYgSXRlbS5sYW5ndWFnZSkge1xuXHRcdGlmIChJdGVtLmxhbmd1YWdlKSB7XG4gICAgICAgICAgICBJdGVtLmxhbmd1YWdlID0gSXRlbS5sYW5ndWFnZS50b0xvd2VyQ2FzZSgpO1xuXHRcdFx0dmFyIGxzdCA9IEl0ZW0ubGFuZ3VhZ2Uuc3BsaXQoXCI8XCIpO1xuICAgICAgICAgICAgaWYgKGxzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxhbmd1YWdlTmFtZSA9IHRoaXMuc3lzLmdldExhbmd1YWdlTmFtZShsc3RbMF0pO1xuICAgICAgICAgICAgICAgIGlmIChsYW5ndWFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgSXRlbVtcImxhbmd1YWdlLW5hbWVcIl0gPSBsYW5ndWFnZU5hbWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXHRcdFx0aWYgKGxzdC5sZW5ndGggPT09IDIpIHtcblx0XHRcdFx0dmFyIG9yaWdpbmFsTGFuZ3VhZ2UgPSB0aGlzLnN5cy5nZXRMYW5ndWFnZU5hbWUobHN0WzFdKTtcblx0XHRcdFx0aWYgKG9yaWdpbmFsTGFuZ3VhZ2UpIHtcblx0XHRcdFx0XHRJdGVtW1wibGFuZ3VhZ2UtbmFtZS1vcmlnaW5hbFwiXSA9IG9yaWdpbmFsTGFuZ3VhZ2U7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG4gICAgfVxuICAgIGlmIChJdGVtLnBhZ2UpIHtcbiAgICAgICAgSXRlbVtcInBhZ2UtZmlyc3RcIl0gPSBJdGVtLnBhZ2U7XG4gICAgICAgIHZhciBudW0gPSBcIlwiICsgSXRlbS5wYWdlO1xuICAgICAgICB2YXIgbSA9IG51bS5zcGxpdCgvXFxzKig/OiZ8LCB8LXxcXHUyMDEzKVxccyovKTtcbiAgICAgICAgaWYgKG1bMF0uc2xpY2UoLTEpICE9PSBcIlxcXFxcIikge1xuICAgICAgICAgICAgSXRlbVtcInBhZ2UtZmlyc3RcIl0gPSBtWzBdO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmZpZWxkX2hhY2sgJiYgSXRlbS5ub3RlKSB7XG4gICAgICAgIENTTC5wYXJzZU5vdGVGaWVsZEhhY2tzKEl0ZW0sIGZhbHNlLCB0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmFsbG93X2ZpZWxkX2hhY2tfZGF0ZV9vdmVycmlkZSk7XG4gICAgfVxuICAgIGZvciAodmFyIGkgPSAxLCBpbGVuID0gQ1NMLkRBVEVfVkFSSUFCTEVTLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgZGF0ZW9iaiA9IEl0ZW1bQ1NMLkRBVEVfVkFSSUFCTEVTW2ldXTtcbiAgICAgICAgaWYgKGRhdGVvYmopIHtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnJhd19kYXRlX3BhcnNpbmcpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0ZW9iai5yYXcpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0ZW9iaiA9IHRoaXMuZnVuLmRhdGVwYXJzZXIucGFyc2VEYXRlVG9PYmplY3QoZGF0ZW9iai5yYXcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIEl0ZW1bQ1NMLkRBVEVfVkFSSUFCTEVTW2ldXSA9IHRoaXMuZGF0ZVBhcnNlQXJyYXkoZGF0ZW9iaik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3RhdGljX3N0YXR1dGVfbG9jYXRvcikge1xuICAgICAgICBpZiAoSXRlbS50eXBlICYmIFtcImJpbGxcIixcImdhemV0dGVcIixcImxlZ2lzbGF0aW9uXCIsXCJyZWd1bGF0aW9uXCIsXCJ0cmVhdHlcIl0uaW5kZXhPZihJdGVtLnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgIHZhciB2YXJuYW1lO1xuICAgICAgICAgICAgdmFyIGVsZW1lbnRzID0gW1widHlwZVwiLCBcInRpdGxlXCIsIFwianVyaXNkaWN0aW9uXCIsIFwiZ2VucmVcIiwgXCJ2b2x1bWVcIiwgXCJjb250YWluZXItdGl0bGVcIl07XG4gICAgICAgICAgICB2YXIgbGVnaXNsYXRpb25faWQgPSBbXTtcbiAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBlbGVtZW50cy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICB2YXJuYW1lID0gZWxlbWVudHNbaV07XG5cdFx0XHRcdGlmIChJdGVtW3Zhcm5hbWVdKSB7XG5cdFx0XHRcdFx0bGVnaXNsYXRpb25faWQucHVzaChJdGVtW3Zhcm5hbWVdKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuICAgICAgICAgICAgZWxlbWVudHMgPSBbXCJvcmlnaW5hbC1kYXRlXCIsIFwiaXNzdWVkXCJdO1xuXHRcdFx0Zm9yIChpID0gMCwgZWxlbWVudHMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgdmFybmFtZSA9IGVsZW1lbnRzW2ldO1xuXHRcdFx0XHRpZiAoSXRlbVt2YXJuYW1lXSAmJiBJdGVtW3Zhcm5hbWVdLnllYXIpIHtcblx0XHRcdFx0XHR2YXIgdmFsdWUgPSBJdGVtW3Zhcm5hbWVdLnllYXI7XG5cdFx0XHRcdFx0bGVnaXNsYXRpb25faWQucHVzaCh2YWx1ZSk7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdEl0ZW0ubGVnaXNsYXRpb25faWQgPSBsZWdpc2xhdGlvbl9pZC5qb2luKFwiOjpcIik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZm9yY2VfanVyaXNkaWN0aW9uKSB7XG4gICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgSXRlbS5hdXRob3JpdHkpIHtcbiAgICAgICAgICAgIEl0ZW0uYXV0aG9yaXR5ID0gW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbGl0ZXJhbDogSXRlbS5hdXRob3JpdHlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdXG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFJdGVtW1widGl0bGUtc2hvcnRcIl0pIHtcbiAgICAgICAgSXRlbVtcInRpdGxlLXNob3J0XCJdID0gSXRlbS5zaG9ydFRpdGxlO1xuICAgIH1cbiAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5tYWluX3RpdGxlX2Zyb21fc2hvcnRfdGl0bGUpIHtcbiAgICAgICAgQ1NMLmV4dHJhY3RUaXRsZUFuZFN1YnRpdGxlKEl0ZW0pO1xuICAgIH1cbiAgICB2YXIgaXNMZWdhbFR5cGUgPSBbXCJiaWxsXCIsXCJsZWdhbF9jYXNlXCIsXCJsZWdpc2xhdGlvblwiLFwiZ2F6ZXR0ZVwiLFwicmVndWxhdGlvblwiXS5pbmRleE9mKEl0ZW0udHlwZSkgPiAtMTtcbiAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5mb3JjZV9qdXJpc2RpY3Rpb24gJiYgaXNMZWdhbFR5cGUpIHtcbiAgICAgICAgaWYgKCFJdGVtLmp1cmlzZGljdGlvbikge1xuICAgICAgICAgICAgSXRlbS5qdXJpc2RpY3Rpb24gPSBcInVzXCI7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFpc0xlZ2FsVHlwZSAmJiBJdGVtLnRpdGxlICYmIHRoaXMuc3lzLmdldEFiYnJldmlhdGlvbikge1xuICAgICAgICB2YXIgbm9IaW50cyA9IGZhbHNlO1xuICAgICAgICBpZiAoIUl0ZW0uanVyaXNkaWN0aW9uKSB7XG4gICAgICAgICAgICBub0hpbnRzID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIganVyaXNkaWN0aW9uID0gdGhpcy50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbihJdGVtLmp1cmlzZGljdGlvbiwgXCJ0aXRsZVwiLCBJdGVtLnRpdGxlLCBJdGVtLnR5cGUsIHRydWUpO1xuICAgICAgICBpZiAodGhpcy50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dLnRpdGxlKSB7XG4gICAgICAgICAgICBpZiAodGhpcy50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dLnRpdGxlW0l0ZW0udGl0bGVdKSB7XG4gICAgICAgICAgICAgICAgSXRlbVtcInRpdGxlLXNob3J0XCJdID0gdGhpcy50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dLnRpdGxlW0l0ZW0udGl0bGVdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghSXRlbVtcImNvbnRhaW5lci10aXRsZS1zaG9ydFwiXSkge1xuICAgICAgICBJdGVtW1wiY29udGFpbmVyLXRpdGxlLXNob3J0XCJdID0gSXRlbS5qb3VybmFsQWJicmV2aWF0aW9uO1xuICAgIH1cbiAgICBpZiAoSXRlbVtcImNvbnRhaW5lci10aXRsZVwiXSAmJiB0aGlzLnN5cy5nZXRBYmJyZXZpYXRpb24pIHtcbiAgICAgICAgdmFyIGp1cmlzZGljdGlvbiA9IHRoaXMudHJhbnNmb3JtLmxvYWRBYmJyZXZpYXRpb24oSXRlbS5qdXJpc2RpY3Rpb24sIFwiY29udGFpbmVyLXRpdGxlXCIsIEl0ZW1bXCJjb250YWluZXItdGl0bGVcIl0pO1xuICAgICAgICBpZiAodGhpcy50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dW1wiY29udGFpbmVyLXRpdGxlXCJdKSB7XG4gICAgICAgICAgICBpZiAodGhpcy50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dW1wiY29udGFpbmVyLXRpdGxlXCJdW0l0ZW1bXCJjb250YWluZXItdGl0bGVcIl1dKSB7XG4gICAgICAgICAgICAgICAgSXRlbVtcImNvbnRhaW5lci10aXRsZS1zaG9ydFwiXSA9IHRoaXMudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXVtcImNvbnRhaW5lci10aXRsZVwiXVtJdGVtW1wiY29udGFpbmVyLXRpdGxlXCJdXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnJlZ2lzdHJ5LnJlZmhhc2hbaWRdID0gSXRlbTtcbiAgICByZXR1cm4gSXRlbTtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5zZXRPcHQgPSBmdW5jdGlvbiAodG9rZW4sIG5hbWUsIHZhbHVlKSB7XG4gICAgaWYgKHRva2VuLm5hbWUgPT09IFwic3R5bGVcIiB8fCB0b2tlbi5uYW1lID09PSBcImNzbHN0eWxlXCIpIHtcbiAgICAgICAgdGhpcy5vcHQuaW5oZXJpdGVkQXR0cmlidXRlc1tuYW1lXSA9IHZhbHVlO1xuICAgICAgICB0aGlzLmNpdGF0aW9uLm9wdC5pbmhlcml0ZWRBdHRyaWJ1dGVzW25hbWVdID0gdmFsdWU7XG4gICAgICAgIHRoaXMuYmlibGlvZ3JhcGh5Lm9wdC5pbmhlcml0ZWRBdHRyaWJ1dGVzW25hbWVdID0gdmFsdWU7XG4gICAgfSBlbHNlIGlmIChbXCJjaXRhdGlvblwiLCBcImJpYmxpb2dyYXBoeVwiXS5pbmRleE9mKHRva2VuLm5hbWUpID4gLTEpIHtcbiAgICAgICAgdGhpc1t0b2tlbi5uYW1lXS5vcHQuaW5oZXJpdGVkQXR0cmlidXRlc1tuYW1lXSA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRva2VuLnN0cmluZ3NbbmFtZV0gPSB2YWx1ZTtcbiAgICB9XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuaW5oZXJpdE9wdCA9IGZ1bmN0aW9uICh0b2tlbiwgYXR0cm5hbWUsIHBhcmVudG5hbWUsIGRlZmF1bHRWYWx1ZSkge1xuICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgdG9rZW4uc3RyaW5nc1thdHRybmFtZV0pIHtcbiAgICAgICAgcmV0dXJuIHRva2VuLnN0cmluZ3NbYXR0cm5hbWVdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBwYXJlbnRWYWx1ZSA9IHRoaXNbdGhpcy50bXAucm9vdF0ub3B0LmluaGVyaXRlZEF0dHJpYnV0ZXNbcGFyZW50bmFtZSA/IHBhcmVudG5hbWUgOiBhdHRybmFtZV07XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgcGFyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXJlbnRWYWx1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuRW5naW5lLnByb3RvdHlwZS5yZW1hcFNlY3Rpb25WYXJpYWJsZSA9IGZ1bmN0aW9uIChpbnB1dExpc3QpIHtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGlucHV0TGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIEl0ZW0gPSBpbnB1dExpc3RbaV1bMF07XG4gICAgICAgIHZhciBpdGVtID0gaW5wdXRMaXN0W2ldWzFdO1xuICAgICAgICBpZiAoW1wiYmlsbFwiLFwiZ2F6ZXR0ZVwiLFwibGVnaXNsYXRpb25cIixcInJlZ3VsYXRpb25cIixcInRyZWF0eVwiXS5pbmRleE9mKEl0ZW0udHlwZSkgPiAtMSkge1xuICAgICAgICAgICAgaWYgKGl0ZW0ubG9jYXRvcikge1xuICAgICAgICAgICAgICAgIGl0ZW0ubG9jYXRvciA9IGl0ZW0ubG9jYXRvci50cmltKCk7XG4gICAgICAgICAgICAgICAgdmFyIG0gPSBpdGVtLmxvY2F0b3IubWF0Y2goQ1NMLlNUQVRVVEVfU1VCRElWX1BMQUlOX1JFR0VYKTtcbiAgICAgICAgICAgICAgICBpZiAoIW0pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ubGFiZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ubG9jYXRvciA9IENTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTX1JFVkVSU0VbaXRlbS5sYWJlbF0gKyBcIiBcIiArIGl0ZW0ubG9jYXRvcjtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ubG9jYXRvciA9IFwicC4gXCIgKyBpdGVtLmxvY2F0b3I7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgc2VjdGlvbk1hc3RlckxhYmVsID0gbnVsbDtcbiAgICAgICAgICAgIGlmIChJdGVtLnNlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBJdGVtLnNlY3Rpb24gPSBJdGVtLnNlY3Rpb24udHJpbSgpO1xuICAgICAgICAgICAgICAgIHZhciBtID0gSXRlbS5zZWN0aW9uLm1hdGNoKENTTC5TVEFUVVRFX1NVQkRJVl9QTEFJTl9SRUdFWCk7XG4gICAgICAgICAgICAgICAgaWYgKCFtKSB7XG4gICAgICAgICAgICAgICAgICAgIEl0ZW0uc2VjdGlvbiA9IFwic2VjLiBcIiArIEl0ZW0uc2VjdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgc2VjdGlvbk1hc3RlckxhYmVsID0gXCJzZWMuXCI7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc2VjdGlvbk1hc3RlckxhYmVsID0gbVswXS50cmltKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKEl0ZW0uc2VjdGlvbikge1xuICAgICAgICAgICAgICAgIGlmICghaXRlbS5sb2NhdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0ubG9jYXRvciA9IEl0ZW0uc2VjdGlvbjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbSA9IGl0ZW0ubG9jYXRvci5tYXRjaCgvXihbXiBdKilcXHMqKC4qKS8pO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3BhY2UgPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtWzFdID09PSBcInAuXCIgJiYgc2VjdGlvbk1hc3RlckxhYmVsICE9PSBcInAuXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmxvY2F0b3IgPSBtWzJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFtcIltcIiwgXCIoXCIsIFwiLlwiLCBcIixcIiwgXCI7XCIsIFwiOlwiLCBcIj9cIl0uaW5kZXhPZihpdGVtLmxvY2F0b3Iuc2xpY2UoMCwgMSkpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGFjZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgIHNwYWNlID0gXCJcIjsgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gSXRlbS5zZWN0aW9uICsgc3BhY2UgKyBpdGVtLmxvY2F0b3I7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaXRlbS5sYWJlbCA9IFwiXCI7XG4gICAgICAgIH1cbiAgICB9XG59XG5DU0wuRW5naW5lLnByb3RvdHlwZS5zZXROdW1iZXJMYWJlbHMgPSBmdW5jdGlvbiAoSXRlbSkge1xuICAgICBpZiAoSXRlbS5udW1iZXJcbiAgICAgICAgJiYgW1wiYmlsbFwiLCBcImdhemV0dGVcIiwgXCJsZWdpc2xhdGlvblwiLFwicmVndWxhdGlvblwiLFwidHJlYXR5XCJdLmluZGV4T2YoSXRlbS50eXBlKSA+IC0xXG4gICAgICAgICYmIHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3RhdGljX3N0YXR1dGVfbG9jYXRvclxuICAgICAgICAmJiAhdGhpcy50bXAuc2hhZG93X251bWJlcnNbXCJudW1iZXJcIl0pIHtcbiAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbXCJudW1iZXJcIl0gPSB7fTtcbiAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbXCJudW1iZXJcIl0udmFsdWVzID0gW107XG4gICAgICAgIHRoaXMudG1wLnNoYWRvd19udW1iZXJzW1wibnVtYmVyXCJdLnBsdXJhbCA9IDA7XG4gICAgICAgIHRoaXMudG1wLnNoYWRvd19udW1iZXJzW1wibnVtYmVyXCJdLm51bWVyaWMgPSBmYWxzZTtcbiAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbXCJudW1iZXJcIl0ubGFiZWwgPSBmYWxzZTtcbiAgICAgICAgdmFyIHZhbHVlID0gXCJcIiArIEl0ZW0ubnVtYmVyO1xuICAgICAgICB2YWx1ZSA9IHZhbHVlLnNwbGl0KFwiXFxcXFwiKS5qb2luKFwiXCIpO1xuICAgICAgICB2YXIgZmlyc3R3b3JkID0gdmFsdWUuc3BsaXQoL1xccysvKVswXTtcbiAgICAgICAgdmFyIGZpcnN0bGFiZWwgPSBDU0wuU1RBVFVURV9TVUJESVZfU1RSSU5HU1tmaXJzdHdvcmRdO1xuICAgICAgICBpZiAoZmlyc3RsYWJlbCkge1xuICAgICAgICAgICAgdmFyIG0gPSB2YWx1ZS5tYXRjaChDU0wuU1RBVFVURV9TVUJESVZfR1JPVVBFRF9SRUdFWCk7XG4gICAgICAgICAgICB2YXIgc3BsdCA9IHZhbHVlLnNwbGl0KENTTC5TVEFUVVRFX1NVQkRJVl9QTEFJTl9SRUdFWCk7XG4gICAgICAgICAgICBpZiAoc3BsdC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxzdCA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGo9MSwgamxlbj1zcGx0Lmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3ViZGl2ID0gbVtqIC0gMV0ucmVwbGFjZSgvXlxccyovLCBcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgbHN0LnB1c2goc3BsdFtqXS5yZXBsYWNlKC9cXHMqJC8sIFwiXCIpLnJlcGxhY2UoL15cXHMqLywgXCJcIikpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YWx1ZSA9IGxzdC5qb2luKFwiIFwiKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBzcGx0WzBdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbXCJudW1iZXJcIl0ubGFiZWwgPSBmaXJzdGxhYmVsO1xuICAgICAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbXCJudW1iZXJcIl0udmFsdWVzLnB1c2goW1wiQmxvYlwiLCB2YWx1ZSwgZmFsc2VdKTtcbiAgICAgICAgICAgIHRoaXMudG1wLnNoYWRvd19udW1iZXJzW1wibnVtYmVyXCJdLm51bWVyaWMgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudG1wLnNoYWRvd19udW1iZXJzW1wibnVtYmVyXCJdLnZhbHVlcy5wdXNoKFtcIkJsb2JcIiwgdmFsdWUsIGZhbHNlXSk7XG4gICAgICAgICAgICB0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1tcIm51bWJlclwiXS5udW1lcmljID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbn1cbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLnN1YnN0aXR1dGVPbmUgPSBmdW5jdGlvbiAodGVtcGxhdGUpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKHN0YXRlLCBsaXN0KSB7XG4gICAgICAgIGlmICghbGlzdCkge1xuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUucmVwbGFjZShcIiUlU1RSSU5HJSVcIiwgbGlzdCk7XG4gICAgICAgIH1cbiAgICB9O1xufTtcbkNTTC5zdWJzdGl0dXRlVHdvID0gZnVuY3Rpb24gKHRlbXBsYXRlKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIChwYXJhbSkge1xuICAgICAgICB2YXIgdGVtcGxhdGUyID0gdGVtcGxhdGUucmVwbGFjZShcIiUlUEFSQU0lJVwiLCBwYXJhbSk7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoc3RhdGUsIGxpc3QpIHtcbiAgICAgICAgICAgIGlmICghbGlzdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBcIlwiO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGVtcGxhdGUyLnJlcGxhY2UoXCIlJVNUUklORyUlXCIsIGxpc3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH07XG59O1xuQ1NMLk1vZGUgPSBmdW5jdGlvbiAobW9kZSkge1xuICAgIHZhciBkZWNvcmF0aW9ucywgcGFyYW1zLCBwYXJhbSwgZnVuYywgdmFsLCBhcmdzO1xuICAgIGRlY29yYXRpb25zID0ge307XG4gICAgcGFyYW1zID0gQ1NMLk91dHB1dC5Gb3JtYXRzW21vZGVdO1xuICAgIGZvciAocGFyYW0gaW4gcGFyYW1zKSB7XG4gICAgICAgIGlmICh0cnVlKSB7XG4gICAgICAgICAgICBpZiAoXCJAXCIgIT09IHBhcmFtLnNsaWNlKDAsIDEpKSB7XG4gICAgICAgICAgICAgICAgZGVjb3JhdGlvbnNbcGFyYW1dID0gcGFyYW1zW3BhcmFtXTtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmMgPSBmYWxzZTtcbiAgICAgICAgICAgIHZhbCA9IHBhcmFtc1twYXJhbV07XG4gICAgICAgICAgICBhcmdzID0gcGFyYW0uc3BsaXQoJy8nKTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsID09PSBcInN0cmluZ1wiICYmIHZhbC5pbmRleE9mKFwiJSVTVFJJTkclJVwiKSA+IC0xKSAge1xuICAgICAgICAgICAgICAgIGlmICh2YWwuaW5kZXhPZihcIiUlUEFSQU0lJVwiKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBDU0wuc3Vic3RpdHV0ZVR3byh2YWwpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBDU0wuc3Vic3RpdHV0ZU9uZSh2YWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gXCJib29sZWFuXCIgJiYgIXZhbCkge1xuICAgICAgICAgICAgICAgIGZ1bmMgPSBDU0wuT3V0cHV0LkZvcm1hdHRlcnMucGFzc3Rocm91Z2g7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgICAgIGZ1bmMgPSB2YWw7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IFwiQ1NMLkNvbXBpbGVyOiBCYWQgXCIgKyBtb2RlICsgXCIgY29uZmlnIGVudHJ5IGZvciBcIiArIHBhcmFtICsgXCI6IFwiICsgdmFsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgZGVjb3JhdGlvbnNbYXJnc1swXV0gPSBmdW5jO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgIGlmICghZGVjb3JhdGlvbnNbYXJnc1swXV0pIHtcbiAgICAgICAgICAgICAgICAgICAgZGVjb3JhdGlvbnNbYXJnc1swXV0gPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZGVjb3JhdGlvbnNbYXJnc1swXV1bYXJnc1sxXV0gPSBmdW5jO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBkZWNvcmF0aW9ucztcbn07XG5DU0wuc2V0RGVjb3JhdGlvbnMgPSBmdW5jdGlvbiAoc3RhdGUsIGF0dHJpYnV0ZXMpIHtcbiAgICB2YXIgcmV0LCBrZXksIHBvcztcbiAgICByZXQgPSBbXTtcbiAgICBmb3IgKHBvcyBpbiBDU0wuRk9STUFUX0tFWV9TRVFVRU5DRSkge1xuICAgICAgICBpZiAodHJ1ZSkge1xuICAgICAgICAgICAgdmFyIGtleSA9IENTTC5GT1JNQVRfS0VZX1NFUVVFTkNFW3Bvc107XG4gICAgICAgICAgICBpZiAoYXR0cmlidXRlc1trZXldKSB7XG4gICAgICAgICAgICAgICAgcmV0LnB1c2goW2tleSwgYXR0cmlidXRlc1trZXldXSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGF0dHJpYnV0ZXNba2V5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5Eb3BwZWxlciA9IGZ1bmN0aW9uKHJleFN0ciwgc3RyaW5nTWFuZ2xlcikge1xuICAgIHZhciBteCwgbHN0LCBsZW4sIHBvcywgbSwgYnVmMSwgYnVmMiwgaWR4LCByZXQsIG15cmV0O1xuICAgIHRoaXMuc3BsaXQgPSBzcGxpdDtcbiAgICB0aGlzLmpvaW4gPSBqb2luO1xuICAgIHZhciBtYXRjaFJleCA9IG5ldyBSZWdFeHAoXCIoXCIgKyByZXhTdHIgKyBcIilcIiwgXCJnXCIpO1xuICAgIHZhciBzcGxpdFJleCA9IG5ldyBSZWdFeHAocmV4U3RyLCBcImdcIik7XG4gICAgZnVuY3Rpb24gc3BsaXQoc3RyKSB7XG4gICAgICAgIGlmIChzdHJpbmdNYW5nbGVyKSB7XG4gICAgICAgICAgICBzdHIgPSBzdHJpbmdNYW5nbGVyKHN0cik7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1hdGNoID0gc3RyLm1hdGNoKG1hdGNoUmV4KTtcbiAgICAgICAgaWYgKCFtYXRjaCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB0YWdzOiBbXSxcbiAgICAgICAgICAgICAgICBzdHJpbmdzOiBbc3RyXVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgc3BsaXQgPSBzdHIuc3BsaXQoc3BsaXRSZXgpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGFnczogbWF0Y2gsXG4gICAgICAgICAgICBzdHJpbmdzOiBzcGxpdCxcbiAgICAgICAgICAgIG9yaWdTdHJpbmdzOiBzcGxpdC5zbGljZSgpXG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gam9pbihvYmopIHtcbiAgICAgICAgdmFyIGxzdCA9IG9iai5zdHJpbmdzLnNsaWNlKC0xKTtcbiAgICAgICAgZm9yICh2YXIgaT1vYmoudGFncy5sZW5ndGgtMTsgaT4tMTsgaS0tKSB7XG4gICAgICAgICAgICBsc3QucHVzaChvYmoudGFnc1tpXSk7XG4gICAgICAgICAgICBsc3QucHVzaChvYmouc3RyaW5nc1tpXSk7XG4gICAgICAgIH1cbiAgICAgICAgbHN0LnJldmVyc2UoKTtcbiAgICAgICAgcmV0dXJuIGxzdC5qb2luKFwiXCIpO1xuICAgIH1cbn1cbkNTTC5FbmdpbmUucHJvdG90eXBlLm5vcm1hbERlY29ySXNPcnBoYW4gPSBmdW5jdGlvbiAoYmxvYiwgcGFyYW1zKSB7XG4gICAgaWYgKHBhcmFtc1sxXSA9PT0gXCJub3JtYWxcIikge1xuICAgICAgICB2YXIgdXNlX3BhcmFtID0gZmFsc2U7XG4gICAgICAgIHZhciBhbGxfdGhlX2RlY29yO1xuICAgICAgICBpZiAodGhpcy50bXAuYXJlYSA9PT0gXCJjaXRhdGlvblwiKSB7XG4gICAgICAgICAgICBhbGxfdGhlX2RlY29yID0gW3RoaXMuY2l0YXRpb24ub3B0LmxheW91dF9kZWNvcmF0aW9uc10uY29uY2F0KGJsb2IuYWxsZGVjb3IpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWxsX3RoZV9kZWNvciA9IGJsb2IuYWxsZGVjb3I7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgayA9IGFsbF90aGVfZGVjb3IubGVuZ3RoIC0gMTsgayA+IC0xOyBrICs9IC0xKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBuID0gYWxsX3RoZV9kZWNvcltrXS5sZW5ndGggLSAxOyBuID4gLTE7IG4gKz0gLTEpIHtcbiAgICAgICAgICAgICAgICBpZiAoYWxsX3RoZV9kZWNvcltrXVtuXVswXSA9PT0gcGFyYW1zWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbGxfdGhlX2RlY29yW2tdW25dWzFdICE9PSBcIm5vcm1hbFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VfcGFyYW0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghdXNlX3BhcmFtKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59O1xuQ1NMLmdldEp1cmlzZGljdGlvbk5hbWVBbmRTdXBwcmVzcyA9IGZ1bmN0aW9uKHN0YXRlLCBqdXJpc2RpY3Rpb25JRCwganVyaXNkaWN0aW9uTmFtZSwgY2hvcFRvKSB7XG4gICAgdmFyIHJldCA9IG51bGw7XG4gICAgaWYgKGNob3BUbykge1xuICAgICAgICBqdXJpc2RpY3Rpb25JRCA9IGp1cmlzZGljdGlvbklELnNwbGl0KFwiOlwiKS5zbGljZSgwLCBjaG9wVG8pLmpvaW4oXCI6XCIpO1xuICAgICAgICBqdXJpc2RpY3Rpb25OYW1lID0gc3RhdGUuc3lzLmdldEh1bWFuRm9ybShqdXJpc2RpY3Rpb25JRCk7XG4gICAgfVxuICAgIGlmICghanVyaXNkaWN0aW9uTmFtZSkge1xuICAgICAgICBqdXJpc2RpY3Rpb25OYW1lID0gc3RhdGUuc3lzLmdldEh1bWFuRm9ybShqdXJpc2RpY3Rpb25JRCk7XG4gICAgfVxuICAgIGlmICghanVyaXNkaWN0aW9uTmFtZSkge1xuICAgICAgICByZXQgPSBqdXJpc2RpY3Rpb25JRDtcbiAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgY29kZSA9IGp1cmlzZGljdGlvbklELnNwbGl0KFwiOlwiKTtcbiAgICAgICAgdmFyIG5hbWUgPSBqdXJpc2RpY3Rpb25OYW1lLnNwbGl0KFwifFwiKTtcbiAgICAgICAgdmFyIHZhbGlkID0gZmFsc2U7XG4gICAgICAgIGlmIChjb2RlLmxlbmd0aCA9PT0gMSAmJiBuYW1lLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgdmFsaWQgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKGNvZGUubGVuZ3RoID4gMSAmJiBuYW1lLmxlbmd0aCA9PT0gY29kZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHZhbGlkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXZhbGlkKSB7XG4gICAgICAgICAgICByZXQgPSBuYW1lLmpvaW4oXCJ8XCIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIG1hc2sgPSAwO1xuICAgICAgICAgICAgdmFyIHN0dWI7XG4gICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1jb2RlLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgc3R1YiA9IGNvZGUuc2xpY2UoMCwgaSsxKS5qb2luKFwiOlwiKTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LnN1cHByZXNzZWRKdXJpc2RpY3Rpb25zW3N0dWJdKSB7XG4gICAgICAgICAgICAgICAgICAgIG1hc2sgPSAoaSsxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobWFzayA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGlmIChjb2RlLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICByZXQgPSBuYW1lWzBdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldCA9IG5hbWUuam9pbihcInxcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChtYXNrID09PSAxKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNvZGUubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0ID0gbmFtZS5zbGljZShtYXNrKS5qb2luKFwifFwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldCA9IG5hbWUuc2xpY2UobWFzaykuam9pbihcInxcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmdldENpdGF0aW9uTGFiZWwgPSBmdW5jdGlvbiAoSXRlbSkge1xuICAgIHZhciBsYWJlbCA9IFwiXCI7XG4gICAgdmFyIHBhcmFtcyA9IHRoaXMuZ2V0VHJpZ3JhcGhQYXJhbXMoKTtcbiAgICB2YXIgY29uZmlnID0gcGFyYW1zWzBdO1xuICAgIHZhciBteW5hbWUgPSB0aGlzLmdldFRlcm0oXCJyZWZlcmVuY2VcIiwgXCJzaG9ydFwiLCAwKTtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIG15bmFtZSkge1xuICAgICAgICBteW5hbWUgPSBcInJlZmVyZW5jZVwiO1xuICAgIH1cbiAgICBteW5hbWUgPSBteW5hbWUucmVwbGFjZShcIi5cIiwgXCJcIik7XG4gICAgbXluYW1lID0gbXluYW1lLnNsaWNlKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyBteW5hbWUuc2xpY2UoMSk7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBDU0wuQ1JFQVRPUlMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciBuID0gQ1NMLkNSRUFUT1JTW2ldO1xuICAgICAgICBpZiAoSXRlbVtuXSkge1xuICAgICAgICAgICAgdmFyIG5hbWVzID0gSXRlbVtuXTtcbiAgICAgICAgICAgIGlmIChuYW1lcy5sZW5ndGggPiBwYXJhbXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnID0gcGFyYW1zW3BhcmFtcy5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uZmlnID0gcGFyYW1zW25hbWVzLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSBuYW1lcy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoaiA9PT0gY29uZmlnLmF1dGhvcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5uYW1lT3V0cHV0LmdldE5hbWUobmFtZXNbal0sIFwibG9jYWxlLXRyYW5zbGl0XCIsIHRydWUpO1xuICAgICAgICAgICAgICAgIHZhciBuYW1lID0gcmVzLm5hbWU7XG4gICAgICAgICAgICAgICAgaWYgKG5hbWUgJiYgbmFtZS5mYW1pbHkpIHtcbiAgICAgICAgICAgICAgICAgICAgbXluYW1lID0gbmFtZS5mYW1pbHk7XG4gICAgICAgICAgICAgICAgICAgIG15bmFtZSA9IG15bmFtZS5yZXBsYWNlKC9eKFsgXFwnXFx1MjAxOWEtel0rXFxzKykvLCBcIlwiKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUgJiYgbmFtZS5saXRlcmFsKSB7XG4gICAgICAgICAgICAgICAgICAgIG15bmFtZSA9IG5hbWUubGl0ZXJhbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIG0gPSBteW5hbWUudG9Mb3dlckNhc2UoKS5tYXRjaCgvXihhXFxzK3x0aGVcXHMrfGFuXFxzKykvKTtcbiAgICAgICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgICAgICBteW5hbWUgPSBteW5hbWUuc2xpY2UobVsxXS5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBteW5hbWUgPSBteW5hbWUucmVwbGFjZShDU0wuUk9NQU5FU1FVRV9OT1RfUkVHRVhQLCBcIlwiKTtcbiAgICAgICAgICAgICAgICBpZiAoIW15bmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbXluYW1lID0gbXluYW1lLnNsaWNlKDAsIGNvbmZpZy5hdXRob3JzW2pdKTtcbiAgICAgICAgICAgICAgICBpZiAobXluYW1lLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgbXluYW1lID0gbXluYW1lLnNsaWNlKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyBteW5hbWUuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG15bmFtZS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgbXluYW1lID0gbXluYW1lLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxhYmVsICs9IG15bmFtZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghbGFiZWwpIHtcbiAgICAgICAgaWYgKEl0ZW0udGl0bGUpIHtcbiAgICAgICAgICAgIHZhciBza2lwV29yZHMgPSB0aGlzLmxvY2FsZVt0aGlzLm9wdC5sYW5nXS5vcHRzW1wic2tpcC13b3Jkc1wiXTtcbiAgICAgICAgICAgIHZhciBsc3QgPSBJdGVtLnRpdGxlLnNwbGl0KC9cXHMrLyk7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gbHN0Lmxlbmd0aCAtIDE7IGkgPiAtMTsgaS0tKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNraXBXb3Jkcy5pbmRleE9mKGxzdFtpXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBsc3QgPSBsc3Quc2xpY2UoMCwgaSkuY29uY2F0KGxzdC5zbGljZShpICsgMSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBzdHIgPSBsc3Quam9pbignJyk7XG4gICAgICAgICAgICBzdHIgPSBzdHIuc2xpY2UoMCwgcGFyYW1zWzBdLmF1dGhvcnNbMF0pO1xuICAgICAgICAgICAgaWYgKHN0ci5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgc3RyID0gc3RyLnNsaWNlKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHN0ciA9IHN0ci50b1VwcGVyQ2FzZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGFiZWwgPSBzdHI7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHllYXIgPSBcIjAwMDBcIjtcbiAgICBpZiAoSXRlbS5pc3N1ZWQpIHtcbiAgICAgICAgaWYgKEl0ZW0uaXNzdWVkLnllYXIpIHtcbiAgICAgICAgICAgIHllYXIgPSBcIlwiICsgSXRlbS5pc3N1ZWQueWVhcjtcbiAgICAgICAgfVxuICAgIH1cbiAgICB5ZWFyID0geWVhci5zbGljZSgoY29uZmlnLnllYXIgKiAtMSkpO1xuICAgIGxhYmVsID0gbGFiZWwgKyB5ZWFyO1xuICAgIHJldHVybiBsYWJlbDtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5nZXRUcmlncmFwaFBhcmFtcyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcGFyYW1zID0gW107XG4gICAgdmFyIGlsc3QgPSB0aGlzLm9wdC50cmlncmFwaC5zcGxpdChcIjpcIik7XG4gICAgaWYgKCF0aGlzLm9wdC50cmlncmFwaCB8fCB0aGlzLm9wdC50cmlncmFwaC5zbGljZSgwLDEpICE9PSBcIkFcIikge1xuICAgICAgICB0aHJvdyBcIkJhZCB0cmlncmFwaCBkZWZpbml0aW9uOiBcIit0aGlzLm9wdC50cmlncmFwaDtcbiAgICB9XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBpbHN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgc3RyID0gaWxzdFtpXTtcbiAgICAgICAgdmFyIGNvbmZpZyA9IHthdXRob3JzOltdLCB5ZWFyOjB9O1xuICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IHN0ci5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIHN3aXRjaCAoc3RyLnNsaWNlKGosaisxKSkge1xuICAgICAgICAgICAgY2FzZSBcIkFcIjpcbiAgICAgICAgICAgICAgICBjb25maWcuYXV0aG9ycy5wdXNoKDEpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcImFcIjpcbiAgICAgICAgICAgICAgICBjb25maWcuYXV0aG9yc1tjb25maWcuYXV0aG9ycy5sZW5ndGggLSAxXSArPSAxO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcIjBcIjpcbiAgICAgICAgICAgICAgICBjb25maWcueWVhciArPSAxO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB0aHJvdyBcIkludmFsaWQgY2hhcmFjdGVyIGluIHRyaWdyYXBoIGRlZmluaXRpb246IFwiK3RoaXMub3B0LnRyaWdyYXBoO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHBhcmFtcy5wdXNoKGNvbmZpZyk7XG4gICAgfVxuICAgIHJldHVybiBwYXJhbXM7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuRW5naW5lLnByb3RvdHlwZS5zZXRPdXRwdXRGb3JtYXQgPSBmdW5jdGlvbiAobW9kZSkge1xuICAgIHRoaXMub3B0Lm1vZGUgPSBtb2RlO1xuICAgIHRoaXMuZnVuLmRlY29yYXRlID0gQ1NMLk1vZGUobW9kZSk7XG4gICAgaWYgKCF0aGlzLm91dHB1dFttb2RlXSkge1xuICAgICAgICB0aGlzLm91dHB1dFttb2RlXSA9IHt9O1xuICAgICAgICB0aGlzLm91dHB1dFttb2RlXS50bXAgPSB7fTtcbiAgICB9XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUuZ2V0U29ydEZ1bmMgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIChhLGIpIHtcbiAgICAgICAgYSA9IGEuc3BsaXQoXCItXCIpO1xuICAgICAgICBiID0gYi5zcGxpdChcIi1cIik7XG4gICAgICAgIGlmIChhLmxlbmd0aCA8IGIubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gMVxuICAgICAgICB9IGVsc2UgaWYgKGEubGVuZ3RoID4gYi5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiAtMVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYSA9IGEuc2xpY2UoLTEpWzBdO1xuICAgICAgICAgICAgYiA9IGIuc2xpY2UoLTEpWzBdO1xuICAgICAgICAgICAgaWYgKGEubGVuZ3RoIDwgYi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYS5sZW5ndGggPiBiLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldExhbmdUYWdzRm9yQ3NsU29ydCA9IGZ1bmN0aW9uICh0YWdzKSB7XG4gICAgdmFyIGksIGlsZW47XG4gICAgaWYgKHRhZ3MpIHtcbiAgICAgICAgdGhpcy5vcHRbJ2xvY2FsZS1zb3J0J10gPSBbXTtcbiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHRhZ3MubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICB0aGlzLm9wdFsnbG9jYWxlLXNvcnQnXS5wdXNoKHRhZ3NbaV0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMub3B0Wydsb2NhbGUtc29ydCddLnNvcnQodGhpcy5nZXRTb3J0RnVuYygpKTtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5zZXRMYW5nVGFnc0ZvckNzbFRyYW5zbGl0ZXJhdGlvbiA9IGZ1bmN0aW9uICh0YWdzKSB7XG4gICAgdmFyIGksIGlsZW47XG4gICAgdGhpcy5vcHRbJ2xvY2FsZS10cmFuc2xpdCddID0gW107XG4gICAgaWYgKHRhZ3MpIHtcbiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHRhZ3MubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICB0aGlzLm9wdFsnbG9jYWxlLXRyYW5zbGl0J10ucHVzaCh0YWdzW2ldKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLm9wdFsnbG9jYWxlLXRyYW5zbGl0J10uc29ydCh0aGlzLmdldFNvcnRGdW5jKCkpO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldExhbmdUYWdzRm9yQ3NsVHJhbnNsYXRpb24gPSBmdW5jdGlvbiAodGFncykge1xuICAgIHZhciBpLCBpbGVuO1xuICAgIHRoaXMub3B0Wydsb2NhbGUtdHJhbnNsYXQnXSA9IFtdO1xuICAgIGlmICh0YWdzKSB7XG4gICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSB0YWdzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgdGhpcy5vcHRbJ2xvY2FsZS10cmFuc2xhdCddLnB1c2godGFnc1tpXSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5vcHRbJ2xvY2FsZS10cmFuc2xhdCddLnNvcnQodGhpcy5nZXRTb3J0RnVuYygpKTtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5zZXRMYW5nUHJlZnNGb3JDaXRlcyA9IGZ1bmN0aW9uIChvYmosIGNvbnYpIHtcbiAgICB2YXIgb3B0ID0gdGhpcy5vcHRbJ2NpdGUtbGFuZy1wcmVmcyddO1xuICAgIGlmICghY29udikge1xuICAgICAgICBjb252ID0gZnVuY3Rpb24gKGtleSkge1xuICAgICAgICAgICAgcmV0dXJuIGtleS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICB9O1xuICAgIH1cbiAgICB2YXIgc2VnbWVudHMgPSBbJ1BlcnNvbnMnLCAnSW5zdGl0dXRpb25zJywgJ1RpdGxlcycsICdKb3VybmFscycsICdQdWJsaXNoZXJzJywgJ1BsYWNlcyddO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gc2VnbWVudHMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciBjbGllbnRTZWdtZW50ID0gY29udihzZWdtZW50c1tpXSk7XG4gICAgICAgIHZhciBjaXRlcHJvY1NlZ21lbnQgPSBzZWdtZW50c1tpXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBpZiAoIW9ialtjbGllbnRTZWdtZW50XSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHN1cHBsZW1lbnRzID0gW107XG4gICAgICAgIHdoaWxlIChvYmpbY2xpZW50U2VnbWVudF0ubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgc3VwcGxlbWVudHMucHVzaChvYmpbY2xpZW50U2VnbWVudF0ucG9wKCkpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBzb3J0dmFsID0ge29yaWc6MSx0cmFuc2xpdDoyLHRyYW5zbGF0OjN9O1xuICAgICAgICBpZiAoc3VwcGxlbWVudHMubGVuZ3RoID09PSAyICYmIHNvcnR2YWxbc3VwcGxlbWVudHNbMF1dIDwgc29ydHZhbFtzdXBwbGVtZW50c1sxXV0pIHtcbiAgICAgICAgICAgIHN1cHBsZW1lbnRzLnJldmVyc2UoKTtcbiAgICAgICAgfVxuICAgICAgICB3aGlsZSAoc3VwcGxlbWVudHMubGVuZ3RoKSB7XG4gICAgICAgICAgICBvYmpbY2xpZW50U2VnbWVudF0ucHVzaChzdXBwbGVtZW50cy5wb3AoKSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGxzdCA9IG9wdFtjaXRlcHJvY1NlZ21lbnRdO1xuICAgICAgICB3aGlsZSAobHN0Lmxlbmd0aCkge1xuICAgICAgICAgICAgbHN0LnBvcCgpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gb2JqW2NsaWVudFNlZ21lbnRdLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgbHN0LnB1c2gob2JqW2NsaWVudFNlZ21lbnRdW2pdKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5zZXRMYW5nUHJlZnNGb3JDaXRlQWZmaXhlcyA9IGZ1bmN0aW9uIChhZmZpeExpc3QpIHtcbiAgICBpZiAoYWZmaXhMaXN0ICYmIGFmZml4TGlzdC5sZW5ndGggPT09IDQ4KSB7XG4gICAgICAgIHZhciBhZmZpeGVzID0gdGhpcy5vcHQuY2l0ZUFmZml4ZXM7XG4gICAgICAgIHZhciBjb3VudCA9IDA7XG4gICAgICAgIHZhciBzZXR0aW5ncyA9IFtcInBlcnNvbnNcIiwgXCJpbnN0aXR1dGlvbnNcIiwgXCJ0aXRsZXNcIiwgXCJqb3VybmFsc1wiLCBcInB1Ymxpc2hlcnNcIiwgXCJwbGFjZXNcIl07XG4gICAgICAgIHZhciBmb3JtcyA9IFtcInRyYW5zbGl0XCIsIFwib3JpZ1wiLCBcInRyYW5zbGl0XCIsIFwidHJhbnNsYXRcIl07XG4gICAgICAgIHZhciB2YWx1ZTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBzZXR0aW5ncy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gZm9ybXMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBcIlwiO1xuICAgICAgICAgICAgICAgIGlmICgoY291bnQgJSA4KSA9PT0gNCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWFmZml4ZXNbc2V0dGluZ3NbaV1dW1wibG9jYWxlLVwiK2Zvcm1zW2pdXS5wcmVmaXhcbiAgICAgICAgICAgICAgICAgICAgICAgICYmICFhZmZpeGVzW3NldHRpbmdzW2ldXVtcImxvY2FsZS1cIitmb3Jtc1tqXV0uc3VmZml4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFmZml4TGlzdFtjb3VudF0gPyBhZmZpeExpc3RbY291bnRdIDogXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFmZml4ZXNbc2V0dGluZ3NbaV1dW1wibG9jYWxlLVwiICsgZm9ybXNbal1dLnByZWZpeCA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBhZmZpeExpc3RbY291bnRdID8gYWZmaXhMaXN0W2NvdW50ICsgMV0gOiBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgYWZmaXhlc1tzZXR0aW5nc1tpXV1bXCJsb2NhbGUtXCIgKyBmb3Jtc1tqXV0uc3VmZml4ID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFmZml4TGlzdFtjb3VudF0gPyBhZmZpeExpc3RbY291bnRdIDogXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgYWZmaXhlc1tzZXR0aW5nc1tpXV1bXCJsb2NhbGUtXCIgKyBmb3Jtc1tqXV0ucHJlZml4ID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYWZmaXhMaXN0W2NvdW50XSA/IGFmZml4TGlzdFtjb3VudCArIDFdIDogXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgYWZmaXhlc1tzZXR0aW5nc1tpXV1bXCJsb2NhbGUtXCIgKyBmb3Jtc1tqXV0uc3VmZml4ID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvdW50ICs9IDI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5vcHQuY2l0ZUFmZml4ZXMgPSBhZmZpeGVzO1xuICAgIH1cbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5zZXRBdXRvVmlldG5hbWVzZU5hbWVzT3B0aW9uID0gZnVuY3Rpb24gKGFyZykge1xuICAgIGlmIChhcmcpIHtcbiAgICAgICAgdGhpcy5vcHRbXCJhdXRvLXZpZXRuYW1lc2UtbmFtZXNcIl0gPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMub3B0W1wiYXV0by12aWV0bmFtZXNlLW5hbWVzXCJdID0gZmFsc2U7XG4gICAgfVxufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnNldEFiYnJldmlhdGlvbnMgPSBmdW5jdGlvbiAoYXJnKSB7XG4gICAgaWYgKHRoaXMuc3lzLnNldEFiYnJldmlhdGlvbnMpIHtcbiAgICAgICAgdGhpcy5zeXMuc2V0QWJicmV2aWF0aW9ucyhhcmcpO1xuICAgIH1cbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5zZXRTdXBwcmVzc1RyYWlsaW5nUHVuY3R1YXRpb24gPSBmdW5jdGlvbiAoYXJnKSB7XG4gICAgdGhpcy5jaXRhdGlvbi5vcHQuc3VwcHJlc3NUcmFpbGluZ1B1bmN0dWF0aW9uID0gISFhcmc7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuT3V0cHV0ID0ge307XG5DU0wuT3V0cHV0LlF1ZXVlID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdGhpcy5sZXZlbG5hbWUgPSBbXCJ0b3BcIl07XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xuICAgIHRoaXMucXVldWUgPSBbXTtcbiAgICB0aGlzLmVtcHR5ID0gbmV3IENTTC5Ub2tlbihcImVtcHR5XCIpO1xuICAgIHZhciB0b2tlbnN0b3JlID0ge307XG4gICAgdG9rZW5zdG9yZS5lbXB0eSA9IHRoaXMuZW1wdHk7XG4gICAgdGhpcy5mb3JtYXRzID0gbmV3IENTTC5TdGFjayh0b2tlbnN0b3JlKTtcbiAgICB0aGlzLmN1cnJlbnQgPSBuZXcgQ1NMLlN0YWNrKHRoaXMucXVldWUpO1xufTtcbkNTTC5PdXRwdXQuUXVldWUucHJvdG90eXBlLnBvcCA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgZHJpcCA9IHRoaXMuY3VycmVudC52YWx1ZSgpO1xuICAgIGlmIChkcmlwLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gZHJpcC5wb3AoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZHJpcC5ibG9icy5wb3AoKTtcbiAgICB9XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUuZ2V0VG9rZW4gPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIHZhciByZXQgPSB0aGlzLmZvcm1hdHMudmFsdWUoKVtuYW1lXTtcbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5PdXRwdXQuUXVldWUucHJvdG90eXBlLm1lcmdlVG9rZW5TdHJpbmdzID0gZnVuY3Rpb24gKGJhc2UsIG1vZGlmaWVyKSB7XG4gICAgdmFyIGJhc2VfdG9rZW4sIG1vZGlmaWVyX3Rva2VuLCByZXQsIGtleTtcbiAgICBiYXNlX3Rva2VuID0gdGhpcy5mb3JtYXRzLnZhbHVlKClbYmFzZV07XG4gICAgbW9kaWZpZXJfdG9rZW4gPSB0aGlzLmZvcm1hdHMudmFsdWUoKVttb2RpZmllcl07XG4gICAgcmV0ID0gYmFzZV90b2tlbjtcbiAgICBpZiAobW9kaWZpZXJfdG9rZW4pIHtcbiAgICAgICAgaWYgKCFiYXNlX3Rva2VuKSB7XG4gICAgICAgICAgICBiYXNlX3Rva2VuID0gbmV3IENTTC5Ub2tlbihiYXNlLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgIGJhc2VfdG9rZW4uZGVjb3JhdGlvbnMgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICByZXQgPSBuZXcgQ1NMLlRva2VuKGJhc2UsIENTTC5TSU5HTEVUT04pO1xuICAgICAgICB2YXIga2V5ID0gXCJcIjtcbiAgICAgICAgZm9yICh2YXIga2V5IGluIGJhc2VfdG9rZW4uc3RyaW5ncykge1xuICAgICAgICAgICAgaWYgKGJhc2VfdG9rZW4uc3RyaW5ncy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgcmV0LnN0cmluZ3Nba2V5XSA9IGJhc2VfdG9rZW4uc3RyaW5nc1trZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGtleSBpbiBtb2RpZmllcl90b2tlbi5zdHJpbmdzKSB7XG4gICAgICAgICAgICBpZiAobW9kaWZpZXJfdG9rZW4uc3RyaW5ncy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgcmV0LnN0cmluZ3Nba2V5XSA9IG1vZGlmaWVyX3Rva2VuLnN0cmluZ3Nba2V5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXQuZGVjb3JhdGlvbnMgPSBiYXNlX3Rva2VuLmRlY29yYXRpb25zLmNvbmNhdChtb2RpZmllcl90b2tlbi5kZWNvcmF0aW9ucyk7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUuYWRkVG9rZW4gPSBmdW5jdGlvbiAobmFtZSwgbW9kaWZpZXIsIHRva2VuKSB7XG4gICAgdmFyIG5ld3RvaywgYXR0cjtcbiAgICBuZXd0b2sgPSBuZXcgQ1NMLlRva2VuKFwib3V0cHV0XCIpO1xuICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgdG9rZW4pIHtcbiAgICAgICAgdG9rZW4gPSB0aGlzLmZvcm1hdHMudmFsdWUoKVt0b2tlbl07XG4gICAgfVxuICAgIGlmICh0b2tlbiAmJiB0b2tlbi5zdHJpbmdzKSB7XG4gICAgICAgIGZvciAoYXR0ciBpbiB0b2tlbi5zdHJpbmdzKSB7XG4gICAgICAgICAgICBpZiAodG9rZW4uc3RyaW5ncy5oYXNPd25Qcm9wZXJ0eShhdHRyKSkge1xuICAgICAgICAgICAgICAgIG5ld3Rvay5zdHJpbmdzW2F0dHJdID0gdG9rZW4uc3RyaW5nc1thdHRyXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBuZXd0b2suZGVjb3JhdGlvbnMgPSB0b2tlbi5kZWNvcmF0aW9ucztcbiAgICB9XG4gICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBtb2RpZmllcikge1xuICAgICAgICBuZXd0b2suc3RyaW5ncy5kZWxpbWl0ZXIgPSBtb2RpZmllcjtcbiAgICB9XG4gICAgdGhpcy5mb3JtYXRzLnZhbHVlKClbbmFtZV0gPSBuZXd0b2s7XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUucHVzaEZvcm1hdHMgPSBmdW5jdGlvbiAodG9rZW5zdG9yZSkge1xuICAgIGlmICghdG9rZW5zdG9yZSkge1xuICAgICAgICB0b2tlbnN0b3JlID0ge307XG4gICAgfVxuICAgIHRva2Vuc3RvcmUuZW1wdHkgPSB0aGlzLmVtcHR5O1xuICAgIHRoaXMuZm9ybWF0cy5wdXNoKHRva2Vuc3RvcmUpO1xufTtcbkNTTC5PdXRwdXQuUXVldWUucHJvdG90eXBlLnBvcEZvcm1hdHMgPSBmdW5jdGlvbiAodG9rZW5zdG9yZSkge1xuICAgIHRoaXMuZm9ybWF0cy5wb3AoKTtcbn07XG5DU0wuT3V0cHV0LlF1ZXVlLnByb3RvdHlwZS5zdGFydFRhZyA9IGZ1bmN0aW9uIChuYW1lLCB0b2tlbikge1xuICAgIHZhciB0b2tlbnN0b3JlID0ge307XG4gICAgaWYgKHRoaXMuc3RhdGUudG1wW1wiZG9pbmctbWFjcm8td2l0aC1kYXRlXCJdICYmIHRoaXMuc3RhdGUudG1wLmV4dGVuc2lvbikge1xuICAgICAgICB0b2tlbiA9IHRoaXMuZW1wdHk7XG4gICAgICAgIG5hbWUgPSBcImVtcHR5XCI7XG4gICAgfVxuICAgIHRva2Vuc3RvcmVbbmFtZV0gPSB0b2tlbjtcbiAgICB0aGlzLnB1c2hGb3JtYXRzKHRva2Vuc3RvcmUpO1xuICAgIHRoaXMub3BlbkxldmVsKG5hbWUpO1xufTtcbkNTTC5PdXRwdXQuUXVldWUucHJvdG90eXBlLmVuZFRhZyA9IGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgdGhpcy5jbG9zZUxldmVsKG5hbWUpO1xuICAgIHRoaXMucG9wRm9ybWF0cygpO1xufTtcbkNTTC5PdXRwdXQuUXVldWUucHJvdG90eXBlLm9wZW5MZXZlbCA9IGZ1bmN0aW9uICh0b2tlbiwgZXBoZW1lcmFsKSB7XG4gICAgdmFyIGJsb2IsIGN1cnIsIHgsIGhhc19lcGhlbWVyYWw7XG4gICAgaWYgKFwib2JqZWN0XCIgPT09IHR5cGVvZiB0b2tlbikge1xuICAgICAgICBibG9iID0gbmV3IENTTC5CbG9iKHVuZGVmaW5lZCwgdG9rZW4pO1xuICAgIH0gZWxzZSBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRva2VuKSB7XG4gICAgICAgIGJsb2IgPSBuZXcgQ1NMLkJsb2IodW5kZWZpbmVkLCB0aGlzLmZvcm1hdHMudmFsdWUoKS5lbXB0eSwgXCJlbXB0eVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoIXRoaXMuZm9ybWF0cy52YWx1ZSgpIHx8ICF0aGlzLmZvcm1hdHMudmFsdWUoKVt0b2tlbl0pIHtcbiAgICAgICAgICAgIHRocm93IFwiQ1NMIHByb2Nlc3NvciBlcnJvcjogY2FsbCB0byBub25leGlzdGVudCBmb3JtYXQgdG9rZW4gXFxcIlwiICsgdG9rZW4gKyBcIlxcXCJcIjtcbiAgICAgICAgfVxuICAgICAgICBibG9iID0gbmV3IENTTC5CbG9iKHVuZGVmaW5lZCwgdGhpcy5mb3JtYXRzLnZhbHVlKClbdG9rZW5dLCB0b2tlbik7XG4gICAgfVxuICAgIGN1cnIgPSB0aGlzLmN1cnJlbnQudmFsdWUoKTtcbiAgICBpZiAoIXRoaXMuc3RhdGUudG1wLmp1c3RfbG9va2luZyAmJiB0aGlzLmNoZWNrTmVzdGVkQnJhY2UpIHtcbiAgICAgICAgYmxvYi5zdHJpbmdzLnByZWZpeCA9IHRoaXMuY2hlY2tOZXN0ZWRCcmFjZS51cGRhdGUoYmxvYi5zdHJpbmdzLnByZWZpeCk7XG4gICAgfVxuICAgIGN1cnIucHVzaChibG9iKTtcbiAgICB0aGlzLmN1cnJlbnQucHVzaChibG9iKTtcbn07XG5DU0wuT3V0cHV0LlF1ZXVlLnByb3RvdHlwZS5jbG9zZUxldmVsID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICBpZiAobmFtZSAmJiBuYW1lICE9PSB0aGlzLmN1cnJlbnQudmFsdWUoKS5sZXZlbG5hbWUpIHtcbiAgICAgICAgQ1NMLmVycm9yKFwiTGV2ZWwgbWlzbWF0Y2ggZXJyb3I6ICB3YW50ZWQgXCIgKyBuYW1lICsgXCIgYnV0IGZvdW5kIFwiICsgdGhpcy5jdXJyZW50LnZhbHVlKCkubGV2ZWxuYW1lKTtcbiAgICB9XG4gICAgdmFyIGJsb2IgPSB0aGlzLmN1cnJlbnQucG9wKCk7XG4gICAgaWYgKCF0aGlzLnN0YXRlLnRtcC5qdXN0X2xvb2tpbmcgJiYgdGhpcy5jaGVja05lc3RlZEJyYWNlKSB7XG4gICAgICAgIGJsb2Iuc3RyaW5ncy5zdWZmaXggPSB0aGlzLmNoZWNrTmVzdGVkQnJhY2UudXBkYXRlKGJsb2Iuc3RyaW5ncy5zdWZmaXgpO1xuICAgIH1cbn07XG5DU0wuT3V0cHV0LlF1ZXVlLnByb3RvdHlwZS5hcHBlbmQgPSBmdW5jdGlvbiAoc3RyLCB0b2tuYW1lLCBub3RTZXJpb3VzLCBpZ25vcmVQcmVkZWNlc3Nvciwgbm9TdHJpcFBlcmlvZHMpIHtcbiAgICB2YXIgdG9rZW4sIGJsb2IsIGN1cnI7XG4gICAgdmFyIHVzZWJsb2IgPSB0cnVlO1xuICAgIGlmIChub3RTZXJpb3VzKSB7XG4gICAgICAgIGlnbm9yZVByZWRlY2Vzc29yID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc3RhdGUudG1wW1wiZG9pbmctbWFjcm8td2l0aC1kYXRlXCJdICYmICFub3RTZXJpb3VzKSB7XG4gICAgICAgIGlmICh0b2tuYW1lICE9PSBcIm1hY3JvLXdpdGgtZGF0ZVwiKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRva25hbWUgPT09IFwibWFjcm8td2l0aC1kYXRlXCIpIHtcbiAgICAgICAgICAgIHRva25hbWUgPSBcImVtcHR5XCI7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBzdHIpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIHN0cikge1xuICAgICAgICBzdHIgPSBcIlwiICsgc3RyO1xuICAgIH1cbiAgICBpZiAoIW5vdFNlcmlvdXMgXG4gICAgICAgICYmIHRoaXMuc3RhdGUudG1wLmVsZW1lbnRfdHJhY2UgXG4gICAgICAgICYmIHRoaXMuc3RhdGUudG1wLmVsZW1lbnRfdHJhY2UudmFsdWUoKSA9PT0gXCJzdXBwcmVzcy1tZVwiKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgYmxvYiA9IGZhbHNlO1xuICAgIGlmICghdG9rbmFtZSkge1xuICAgICAgICB0b2tlbiA9IHRoaXMuZm9ybWF0cy52YWx1ZSgpLmVtcHR5O1xuICAgIH0gZWxzZSBpZiAodG9rbmFtZSA9PT0gXCJsaXRlcmFsXCIpIHtcbiAgICAgICAgdG9rZW4gPSB0cnVlO1xuICAgICAgICB1c2VibG9iID0gZmFsc2U7XG4gICAgfSBlbHNlIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgdG9rbmFtZSkge1xuICAgICAgICB0b2tlbiA9IHRoaXMuZm9ybWF0cy52YWx1ZSgpW3Rva25hbWVdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRva2VuID0gdG9rbmFtZTtcbiAgICB9XG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgICB0aHJvdyBcIkNTTCBwcm9jZXNzb3IgZXJyb3I6IHVua25vd24gZm9ybWF0IHRva2VuIG5hbWU6IFwiICsgdG9rbmFtZTtcbiAgICB9XG4gICAgaWYgKHRva2VuLnN0cmluZ3MgJiYgXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRva2VuLnN0cmluZ3MuZGVsaW1pdGVyKSB7XG4gICAgICAgIHRva2VuLnN0cmluZ3MuZGVsaW1pdGVyID0gXCJcIjtcbiAgICB9XG4gICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBzdHIgJiYgc3RyLmxlbmd0aCkge1xuICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSgvIChbOjs/IVxcdTAwYmJdKS9nLCBcIlxcdTIwMmYkMVwiKS5yZXBsYWNlKC9cXHUwMGFiIC9nLCBcIlxcdTAwYWJcXHUyMDJmXCIpO1xuICAgICAgICB0aGlzLmxhc3RfY2hhcl9yZW5kZXJlZCA9IHN0ci5zbGljZSgtMSk7XG4gICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC9cXHMrJy9nLCBcIiBcXCdcIik7XG4gICAgICAgIGlmICghbm90U2VyaW91cykge1xuICAgICAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoL14nL2csIFwiIFxcJ1wiKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWlnbm9yZVByZWRlY2Vzc29yKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC50ZXJtX3ByZWRlY2Vzc29yID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmluX2NpdGVfcHJlZGVjZXNzb3IgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKG5vdFNlcmlvdXMpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLnRlcm1fcHJlZGVjZXNzb3JfbmFtZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgYmxvYiA9IG5ldyBDU0wuQmxvYihzdHIsIHRva2VuKTtcbiAgICBjdXJyID0gdGhpcy5jdXJyZW50LnZhbHVlKCk7XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBjdXJyICYmIHRoaXMuY3VycmVudC5teXN0YWNrLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLmN1cnJlbnQubXlzdGFjay5wdXNoKFtdKTtcbiAgICAgICAgY3VyciA9IHRoaXMuY3VycmVudC52YWx1ZSgpO1xuICAgIH1cbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2IuYmxvYnMpIHtcbiAgICAgICAgaWYgKCFpZ25vcmVQcmVkZWNlc3Nvcikge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudGVybV9wcmVkZWNlc3NvciA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5pbl9jaXRlX3ByZWRlY2Vzc29yID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmIChub3RTZXJpb3VzKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC50ZXJtX3ByZWRlY2Vzc29yX25hbWUgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghbm90U2VyaW91cykge1xuICAgICAgICB0aGlzLnN0YXRlLnBhcmFsbGVsLkFwcGVuZEJsb2JQb2ludGVyKGN1cnIpO1xuICAgIH1cbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHN0cikge1xuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2IuYmxvYnMpIHtcbiAgICAgICAgICAgIGlmIChibG9iLmJsb2JzLnNsaWNlKDAsIDEpICE9PSBcIiBcIikge1xuICAgICAgICAgICAgICAgIHZhciBibG9iUHJlZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICB2YXIgYmxvYkJsb2JzID0gYmxvYi5ibG9icztcbiAgICAgICAgICAgICAgICB3aGlsZSAoQ1NMLlRFUk1JTkFMX1BVTkNUVUFUSU9OLmluZGV4T2YoYmxvYkJsb2JzLnNsaWNlKDAsIDEpKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGJsb2JQcmVmaXggPSBibG9iUHJlZml4ICsgYmxvYkJsb2JzLnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgICAgICBibG9iQmxvYnMgPSBibG9iQmxvYnMuc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChibG9iQmxvYnMgJiYgYmxvYlByZWZpeCkge1xuICAgICAgICAgICAgICAgICAgICBibG9iLnN0cmluZ3MucHJlZml4ID0gYmxvYi5zdHJpbmdzLnByZWZpeCArIGJsb2JQcmVmaXg7XG4gICAgICAgICAgICAgICAgICAgIGJsb2IuYmxvYnMgPSBibG9iQmxvYnM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChibG9iLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0pIHtcbiAgICAgICAgICAgIGJsb2IuYmxvYnMgPSBDU0wuT3V0cHV0LkZvcm1hdHRlcnNbYmxvYi5zdHJpbmdzW1widGV4dC1jYXNlXCJdXSh0aGlzLnN0YXRlLCBzdHIpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnRtcC5zdHJpcF9wZXJpb2RzICYmICFub1N0cmlwUGVyaW9kcykge1xuICAgICAgICAgICAgYmxvYi5ibG9icyA9IGJsb2IuYmxvYnMucmVwbGFjZSgvXFwuKFteYS16XXwkKS9nLCBcIiQxXCIpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGkgPSBibG9iLmRlY29yYXRpb25zLmxlbmd0aCAtIDE7IGkgPiAtMTsgaSArPSAtMSkge1xuICAgICAgICAgICAgaWYgKGJsb2IuZGVjb3JhdGlvbnNbaV1bMF0gPT09IFwiQHF1b3Rlc1wiICYmIGJsb2IuZGVjb3JhdGlvbnNbaV1bMV0gIT09IFwiZmFsc2VcIikge1xuICAgICAgICAgICAgICAgIGJsb2IucHVuY3R1YXRpb25faW5fcXVvdGUgPSB0aGlzLnN0YXRlLmdldE9wdChcInB1bmN0dWF0aW9uLWluLXF1b3RlXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFibG9iLmJsb2JzLm1hdGNoKENTTC5ST01BTkVTUVVFX1JFR0VYUCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoYmxvYi5kZWNvcmF0aW9uc1tpXVswXSA9PT0gXCJAZm9udC1zdHlsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGJsb2IuZGVjb3JhdGlvbnMgPSBibG9iLmRlY29yYXRpb25zLnNsaWNlKDAsIGkpLmNvbmNhdChibG9iLmRlY29yYXRpb25zLnNsaWNlKGkgKyAxKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGN1cnIucHVzaChibG9iKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5mdW4uZmxpcGZsb3BwZXIucHJvY2Vzc1RhZ3MoYmxvYik7XG4gICAgfSBlbHNlIGlmICh1c2VibG9iKSB7XG4gICAgICAgIGN1cnIucHVzaChibG9iKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjdXJyLnB1c2goc3RyKTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUuc3RyaW5nID0gZnVuY3Rpb24gKHN0YXRlLCBteWJsb2JzLCBibG9iKSB7XG4gICAgdmFyIGksIGlsZW4sIGosIGpsZW4sIGI7XG4gICAgdmFyIHR4dF9lc2MgPSBDU0wuZ2V0U2FmZUVzY2FwZSh0aGlzLnN0YXRlKTtcbiAgICB2YXIgYmxvYnMgPSBteWJsb2JzLnNsaWNlKCk7XG4gICAgdmFyIHJldCA9IFtdO1xuICAgIGlmIChibG9icy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG4gICAgdmFyIGJsb2JfZGVsaW1pdGVyID0gXCJcIjtcbiAgICBpZiAoYmxvYikge1xuICAgICAgICBibG9iX2RlbGltaXRlciA9IGJsb2Iuc3RyaW5ncy5kZWxpbWl0ZXI7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgc3RhdGUudG1wLmNvdW50X29mZnNldF9jaGFyYWN0ZXJzID0gZmFsc2U7XG4gICAgICAgIHN0YXRlLnRtcC5vZmZzZXRfY2hhcmFjdGVycyA9IDA7XG4gICAgfVxuICAgIGlmIChibG9iICYmIGJsb2IubmV3X2xvY2FsZSkge1xuICAgICAgICBibG9iLm9sZF9sb2NhbGUgPSBzdGF0ZS5vcHQubGFuZztcbiAgICAgICAgc3RhdGUub3B0LmxhbmcgPSBibG9iLm5ld19sb2NhbGU7XG4gICAgfVxuICAgIHZhciBibG9ianIsIHVzZV9zdWZmaXgsIHVzZV9wcmVmaXgsIHBhcmFtcztcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGJsb2JzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBibG9ianIgPSBibG9ic1tpXTtcbiAgICAgICAgaWYgKGJsb2Jqci5zdHJpbmdzLmZpcnN0X2Jsb2IpIHtcbiAgICAgICAgICAgIHN0YXRlLnRtcC5jb3VudF9vZmZzZXRfY2hhcmFjdGVycyA9IGJsb2Jqci5zdHJpbmdzLmZpcnN0X2Jsb2I7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBibG9ianIuYmxvYnMpIHtcbiAgICAgICAgICAgIGlmIChcIm51bWJlclwiID09PSB0eXBlb2YgYmxvYmpyLm51bSkge1xuICAgICAgICAgICAgICAgIHJldC5wdXNoKGJsb2Jqcik7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGJsb2Jqci5ibG9icykge1xuICAgICAgICAgICAgICAgIGIgPSB0eHRfZXNjKGJsb2Jqci5ibG9icyk7XG4gICAgICAgICAgICAgICAgdmFyIGJsZW4gPSBiLmxlbmd0aDtcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gYmxvYmpyLmRlY29yYXRpb25zLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gYmxvYmpyLmRlY29yYXRpb25zW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtc1swXSA9PT0gXCJAc2hvd2lkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5ub3JtYWxEZWNvcklzT3JwaGFuKGJsb2JqciwgcGFyYW1zKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYiA9IHN0YXRlLmZ1bi5kZWNvcmF0ZVtwYXJhbXNbMF1dW3BhcmFtc1sxXV0uY2FsbChibG9ianIsIHN0YXRlLCBiLCBwYXJhbXNbMl0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChiICYmIGIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGIgPSB0eHRfZXNjKGJsb2Jqci5zdHJpbmdzLnByZWZpeCkgKyBiICsgdHh0X2VzYyhibG9ianIuc3RyaW5ncy5zdWZmaXgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmNzbF9yZXZlcnNlX2xvb2t1cF9zdXBwb3J0IHx8IHN0YXRlLnN5cy5jc2xfcmV2ZXJzZV9sb29rdXBfc3VwcG9ydCkgJiYgIXN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IGJsb2Jqci5kZWNvcmF0aW9ucy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSBibG9ianIuZGVjb3JhdGlvbnNbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtc1swXSA9PT0gXCJAc2hvd2lkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYiA9IHN0YXRlLmZ1bi5kZWNvcmF0ZVtwYXJhbXNbMF1dW3BhcmFtc1sxXV0uY2FsbChibG9ianIsIHN0YXRlLCBiLCBwYXJhbXNbMl0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXQucHVzaChiKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5jb3VudF9vZmZzZXRfY2hhcmFjdGVycykge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLm9mZnNldF9jaGFyYWN0ZXJzICs9IChibGVuICsgYmxvYmpyLnN0cmluZ3Muc3VmZml4Lmxlbmd0aCArIGJsb2Jqci5zdHJpbmdzLnByZWZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGJsb2Jqci5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHZhciBhZGR0b3JldCA9IHN0YXRlLm91dHB1dC5zdHJpbmcoc3RhdGUsIGJsb2Jqci5ibG9icywgYmxvYmpyKTtcbiAgICAgICAgICAgIGlmIChibG9iKSB7XG4gICAgICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgIT09IGFkZHRvcmV0ICYmIGFkZHRvcmV0Lmxlbmd0aCA+IDEgJiYgYmxvYmpyLnN0cmluZ3MuZGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBudW1iZXJTZWVuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPWFkZHRvcmV0Lmxlbmd0aDtqPGpsZW47aisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiAhPT0gdHlwZW9mIGFkZHRvcmV0W2pdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyU2VlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG51bWJlclNlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGR0b3JldFtqXSA9IChibG9ianIuc3RyaW5ncy5kZWxpbWl0ZXIgKyBhZGR0b3JldFtqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXQgPSByZXQuY29uY2F0KGFkZHRvcmV0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYmxvYmpyLnN0cmluZ3MuZmlyc3RfYmxvYiAmJiBzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtibG9ianIuc3RyaW5ncy5maXJzdF9ibG9iXSkge1xuICAgICAgICAgICAgc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbYmxvYmpyLnN0cmluZ3MuZmlyc3RfYmxvYl0ub2Zmc2V0ID0gc3RhdGUudG1wLm9mZnNldF9jaGFyYWN0ZXJzO1xuICAgICAgICAgICAgc3RhdGUudG1wLmNvdW50X29mZnNldF9jaGFyYWN0ZXJzID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yIChpPTAsaWxlbj1yZXQubGVuZ3RoIC0gMTtpPGlsZW47aSs9MSkge1xuICAgICAgICBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIHJldFtpXS5udW0gJiYgXCJudW1iZXJcIiA9PT0gdHlwZW9mIHJldFtpKzFdLm51bSAmJiAhcmV0W2krMV0uVUdMWV9ERUxJTUlURVJfU1VQUFJFU1NfSEFDSykge1xuICAgICAgICAgICAgcmV0W2ldLnN0cmluZ3Muc3VmZml4ID0gcmV0W2ldLnN0cmluZ3Muc3VmZml4ICsgKGJsb2JfZGVsaW1pdGVyID8gYmxvYl9kZWxpbWl0ZXIgOiBcIlwiKTtcbiAgICAgICAgICAgIHJldFtpKzFdLnN1Y2Nlc3Nvcl9wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgcmV0W2krMV0uVUdMWV9ERUxJTUlURVJfU1VQUFJFU1NfSEFDSyA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHNwYW5fc3BsaXQgPSAwO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gcmV0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHJldFtpXSkge1xuICAgICAgICAgICAgc3Bhbl9zcGxpdCA9IChwYXJzZUludChpLCAxMCkgKyAxKTtcbiAgICAgICAgICAgIGlmIChpIDwgcmV0Lmxlbmd0aCAtIDEgICYmIFwib2JqZWN0XCIgPT09IHR5cGVvZiByZXRbaSArIDFdKSB7XG4gICAgICAgICAgICAgICAgaWYgKGJsb2JfZGVsaW1pdGVyICYmICFyZXRbaSArIDFdLlVHTFlfREVMSU1JVEVSX1NVUFBSRVNTX0hBQ0spIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0W2ldICs9IHR4dF9lc2MoYmxvYl9kZWxpbWl0ZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXRbaSArIDFdLlVHTFlfREVMSU1JVEVSX1NVUFBSRVNTX0hBQ0sgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChibG9iICYmIChibG9iLmRlY29yYXRpb25zLmxlbmd0aCB8fCBibG9iLnN0cmluZ3Muc3VmZml4KSkge1xuICAgICAgICBzcGFuX3NwbGl0ID0gcmV0Lmxlbmd0aDtcbiAgICB9IGVsc2UgaWYgKGJsb2IgJiYgYmxvYi5zdHJpbmdzLnByZWZpeCkge1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1yZXQubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgcmV0W2ldLm51bSkge1xuICAgICAgICAgICAgICAgIHNwYW5fc3BsaXQgPSBpO1xuICAgICAgICAgICAgICAgIGlmIChpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldFtpXS5zdHJpbmdzLnByZWZpeCA9IGJsb2Iuc3RyaW5ncy5wcmVmaXggKyByZXRbaV0uc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHZhciBibG9ic19zdGFydCA9IHN0YXRlLm91dHB1dC5yZW5kZXJCbG9icyhyZXQuc2xpY2UoMCwgc3Bhbl9zcGxpdCksIGJsb2JfZGVsaW1pdGVyLCBmYWxzZSwgYmxvYik7XG4gICAgaWYgKGJsb2JzX3N0YXJ0ICYmIGJsb2IgJiYgKGJsb2IuZGVjb3JhdGlvbnMubGVuZ3RoIHx8IGJsb2Iuc3RyaW5ncy5zdWZmaXggfHwgYmxvYi5zdHJpbmdzLnByZWZpeCkpIHtcbiAgICAgICAgaWYgKCFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gYmxvYi5kZWNvcmF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXMgPSBibG9iLmRlY29yYXRpb25zW2ldO1xuICAgICAgICAgICAgICAgIGlmIChbXCJAY2l0ZVwiLFwiQGJpYmxpb2dyYXBoeVwiLCBcIkBkaXNwbGF5XCIsIFwiQHNob3dpZFwiXS5pbmRleE9mKHBhcmFtc1swXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLm5vcm1hbERlY29ySXNPcnBoYW4oYmxvYmpyLCBwYXJhbXMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2JzX3N0YXJ0KSB7XG4gICAgICAgICAgICAgICAgICAgIGJsb2JzX3N0YXJ0ID0gc3RhdGUuZnVuLmRlY29yYXRlW3BhcmFtc1swXV1bcGFyYW1zWzFdXS5jYWxsKGJsb2IsIHN0YXRlLCBibG9ic19zdGFydCwgcGFyYW1zWzJdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYiA9IGJsb2JzX3N0YXJ0O1xuICAgICAgICB1c2Vfc3VmZml4ID0gYmxvYi5zdHJpbmdzLnN1ZmZpeDtcbiAgICAgICAgaWYgKGIgJiYgYi5sZW5ndGgpIHtcbiAgICAgICAgICAgIHVzZV9wcmVmaXggPSBibG9iLnN0cmluZ3MucHJlZml4O1xuICAgICAgICAgICAgYiA9IHR4dF9lc2ModXNlX3ByZWZpeCkgKyBiICsgdHh0X2VzYyh1c2Vfc3VmZml4KTtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY291bnRfb2Zmc2V0X2NoYXJhY3RlcnMpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAub2Zmc2V0X2NoYXJhY3RlcnMgKz0gKHVzZV9wcmVmaXgubGVuZ3RoICsgdXNlX3N1ZmZpeC5sZW5ndGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJsb2JzX3N0YXJ0ID0gYjtcbiAgICAgICAgaWYgKCFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gYmxvYi5kZWNvcmF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXMgPSBibG9iLmRlY29yYXRpb25zW2ldO1xuICAgICAgICAgICAgICAgIGlmIChbXCJAY2l0ZVwiLFwiQGJpYmxpb2dyYXBoeVwiLCBcIkBkaXNwbGF5XCIsIFwiQHNob3dpZFwiXS5pbmRleE9mKHBhcmFtc1swXSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2JzX3N0YXJ0KSB7XG4gICAgICAgICAgICAgICAgICAgIGJsb2JzX3N0YXJ0ID0gc3RhdGUuZnVuLmRlY29yYXRlW3BhcmFtc1swXV1bcGFyYW1zWzFdXS5jYWxsKGJsb2IsIHN0YXRlLCBibG9ic19zdGFydCwgcGFyYW1zWzJdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIGJsb2JzX2VuZCA9IHJldC5zbGljZShzcGFuX3NwbGl0LCByZXQubGVuZ3RoKTtcbiAgICBpZiAoIWJsb2JzX2VuZC5sZW5ndGggJiYgYmxvYnNfc3RhcnQpIHtcbiAgICAgICAgcmV0ID0gW2Jsb2JzX3N0YXJ0XTtcbiAgICB9IGVsc2UgaWYgKGJsb2JzX2VuZC5sZW5ndGggJiYgIWJsb2JzX3N0YXJ0KSB7XG4gICAgICAgIHJldCA9IGJsb2JzX2VuZDtcbiAgICB9IGVsc2UgaWYgKGJsb2JzX3N0YXJ0ICYmIGJsb2JzX2VuZC5sZW5ndGgpIHtcbiAgICAgICAgcmV0ID0gW2Jsb2JzX3N0YXJ0XS5jb25jYXQoYmxvYnNfZW5kKTtcbiAgICB9XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBibG9iKSB7XG4gICAgICAgIHRoaXMucXVldWUgPSBbXTtcbiAgICAgICAgdGhpcy5jdXJyZW50Lm15c3RhY2sgPSBbXTtcbiAgICAgICAgdGhpcy5jdXJyZW50Lm15c3RhY2sucHVzaCh0aGlzLnF1ZXVlKTtcbiAgICAgICAgaWYgKHN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgcmV0ID0gc3RhdGUub3V0cHV0LnJlbmRlckJsb2JzKHJldCwgdW5kZWZpbmVkLCBmYWxzZSk7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKFwiYm9vbGVhblwiID09PSB0eXBlb2YgYmxvYikge1xuICAgICAgICByZXQgPSBzdGF0ZS5vdXRwdXQucmVuZGVyQmxvYnMocmV0LCB1bmRlZmluZWQsIHRydWUpO1xuICAgIH1cbiAgICBpZiAoYmxvYiAmJiBibG9iLm5ld19sb2NhbGUpIHtcbiAgICAgICAgc3RhdGUub3B0LmxhbmcgPSBibG9iLm9sZF9sb2NhbGU7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLk91dHB1dC5RdWV1ZS5wcm90b3R5cGUuY2xlYXJsZXZlbCA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgYmxvYiwgcG9zLCBsZW47XG4gICAgYmxvYiA9IHRoaXMuY3VycmVudC52YWx1ZSgpO1xuICAgIGxlbiA9IGJsb2IuYmxvYnMubGVuZ3RoO1xuICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBibG9iLmJsb2JzLnBvcCgpO1xuICAgIH1cbn07XG5DU0wuT3V0cHV0LlF1ZXVlLnByb3RvdHlwZS5yZW5kZXJCbG9icyA9IGZ1bmN0aW9uIChibG9icywgZGVsaW0sIGluX2NpdGUsIHBhcmVudCkge1xuICAgIHZhciBzdGF0ZSwgcmV0LCByZXRfbGFzdF9jaGFyLCB1c2VfZGVsaW0sIGksIGJsb2IsIHBvcywgbGVuLCBwcG9zLCBsbGVuLCBwcHBvcywgbGxsZW4sIHJlcywgc3RyLCBwYXJhbXMsIHR4dF9lc2M7XG4gICAgdHh0X2VzYyA9IENTTC5nZXRTYWZlRXNjYXBlKHRoaXMuc3RhdGUpO1xuICAgIGlmICghZGVsaW0pIHtcbiAgICAgICAgZGVsaW0gPSBcIlwiO1xuICAgIH1cbiAgICBzdGF0ZSA9IHRoaXMuc3RhdGU7XG4gICAgcmV0ID0gXCJcIjtcbiAgICByZXRfbGFzdF9jaGFyID0gW107XG4gICAgdXNlX2RlbGltID0gXCJcIjtcbiAgICBsZW4gPSBibG9icy5sZW5ndGg7XG4gICAgaWYgKHRoaXMuc3RhdGUudG1wLmFyZWEgPT09IFwiY2l0YXRpb25cIiAmJiAhdGhpcy5zdGF0ZS50bXAuanVzdF9sb29raW5nICYmIGxlbiA9PT0gMSAmJiB0eXBlb2YgYmxvYnNbMF0gPT09IFwib2JqZWN0XCIgJiYgcGFyZW50KSB7XG4gICAgICAgIGJsb2JzWzBdLnN0cmluZ3MucHJlZml4ID0gcGFyZW50LnN0cmluZ3MucHJlZml4ICsgYmxvYnNbMF0uc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgIGJsb2JzWzBdLnN0cmluZ3Muc3VmZml4ID0gYmxvYnNbMF0uc3RyaW5ncy5zdWZmaXggKyBwYXJlbnQuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgIGJsb2JzWzBdLmRlY29yYXRpb25zID0gYmxvYnNbMF0uZGVjb3JhdGlvbnMuY29uY2F0KHBhcmVudC5kZWNvcmF0aW9ucyk7XG4gICAgICAgIGJsb2JzWzBdLnBhcmFtcyA9IHBhcmVudC5wYXJhbXM7XG4gICAgICAgIHJldHVybiBibG9ic1swXTtcbiAgICB9XG4gICAgdmFyIHN0YXJ0ID0gdHJ1ZTtcbiAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgaWYgKGJsb2JzW3Bvc10uY2hlY2tOZXh0KSB7XG4gICAgICAgICAgICBibG9ic1twb3NdLmNoZWNrTmV4dChibG9ic1twb3MgKyAxXSxzdGFydCk7XG4gICAgICAgICAgICBzdGFydCA9IGZhbHNlO1xuICAgICAgICB9IGVsc2UgaWYgKGJsb2JzW3BvcysxXSAmJiBibG9ic1twb3MrMV0uc3BsaWNlX3ByZWZpeCkge1xuICAgICAgICAgICAgc3RhcnQgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0YXJ0ID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgZG9pdCA9IHRydWU7XG4gICAgZm9yIChwb3MgPSBibG9icy5sZW5ndGggLSAxOyBwb3MgPiAwOyBwb3MgKz0gLTEpIHtcbiAgICAgICAgaWYgKGJsb2JzW3Bvc10uY2hlY2tMYXN0KSB7XG4gICAgICAgICAgICBpZiAoZG9pdCAmJiBibG9ic1twb3NdLmNoZWNrTGFzdChibG9ic1twb3MgLSAxXSkpIHtcbiAgICAgICAgICAgICAgICBkb2l0ID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkb2l0ID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBsZW4gPSBibG9icy5sZW5ndGg7XG4gICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIGJsb2IgPSBibG9ic1twb3NdO1xuICAgICAgICBpZiAocmV0KSB7XG4gICAgICAgICAgICB1c2VfZGVsaW0gPSBkZWxpbTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2IpIHtcbiAgICAgICAgICAgIHJldCArPSB0eHRfZXNjKHVzZV9kZWxpbSk7XG4gICAgICAgICAgICByZXQgKz0gYmxvYjtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY291bnRfb2Zmc2V0X2NoYXJhY3RlcnMpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAub2Zmc2V0X2NoYXJhY3RlcnMgKz0gKHVzZV9kZWxpbS5sZW5ndGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGluX2NpdGUpIHtcbiAgICAgICAgICAgIGlmIChyZXQpIHtcbiAgICAgICAgICAgICAgICByZXQgPSBbcmV0LCBibG9iXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gW2Jsb2JdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGJsb2Iuc3RhdHVzICE9PSBDU0wuU1VQUFJFU1MpIHtcbiAgICAgICAgICAgIGlmIChibG9iLnBhcnRpY2xlKSB7XG4gICAgICAgICAgICAgICAgc3RyID0gYmxvYi5wYXJ0aWNsZSArIGJsb2IubnVtO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdHIgPSBibG9iLmZvcm1hdHRlci5mb3JtYXQoYmxvYi5udW0sIGJsb2IuZ2VuZGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBzdHJsZW4gPSBzdHIucmVwbGFjZSgvPFtePl0qPi9nLCBcIlwiKS5sZW5ndGg7XG4gICAgICAgICAgICB0aGlzLmFwcGVuZChzdHIsIFwiZW1wdHlcIiwgdHJ1ZSk7XG4gICAgICAgICAgICB2YXIgc3RyX2Jsb2IgPSB0aGlzLnBvcCgpO1xuICAgICAgICAgICAgdmFyIGNvdW50X29mZnNldF9jaGFyYWN0ZXJzID0gc3RhdGUudG1wLmNvdW50X29mZnNldF9jaGFyYWN0ZXJzO1xuICAgICAgICAgICAgc3RyID0gdGhpcy5zdHJpbmcoc3RhdGUsIFtzdHJfYmxvYl0sIGZhbHNlKTtcbiAgICAgICAgICAgIHN0YXRlLnRtcC5jb3VudF9vZmZzZXRfY2hhcmFjdGVycyA9IGNvdW50X29mZnNldF9jaGFyYWN0ZXJzO1xuICAgICAgICAgICAgaWYgKGJsb2Iuc3RyaW5nc1tcInRleHQtY2FzZVwiXSkge1xuICAgICAgICAgICAgICAgIHN0ciA9IENTTC5PdXRwdXQuRm9ybWF0dGVyc1tibG9iLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl1dKHRoaXMuc3RhdGUsIHN0cik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc3RyICYmIHRoaXMuc3RhdGUudG1wLnN0cmlwX3BlcmlvZHMpIHtcbiAgICAgICAgICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSgvXFwuKFteYS16XXwkKS9nLCBcIiQxXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBsbGVuID0gYmxvYi5kZWNvcmF0aW9ucy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgZm9yIChwcG9zID0gMDsgcHBvcyA8IGxsZW47IHBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSBibG9iLmRlY29yYXRpb25zW3Bwb3NdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUubm9ybWFsRGVjb3JJc09ycGhhbihibG9iLCBwYXJhbXMpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdGF0ZS5mdW4uZGVjb3JhdGVbcGFyYW1zWzBdXVtwYXJhbXNbMV1dLmNhbGwoYmxvYiwgc3RhdGUsIHN0ciwgcGFyYW1zWzJdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdHIgPSB0eHRfZXNjKGJsb2Iuc3RyaW5ncy5wcmVmaXgpICsgc3RyICsgdHh0X2VzYyhibG9iLnN0cmluZ3Muc3VmZml4KTtcbiAgICAgICAgICAgIHZhciBhZGRtZSA9IFwiXCI7XG4gICAgICAgICAgICBpZiAoYmxvYi5zdGF0dXMgPT09IENTTC5FTkQpIHtcbiAgICAgICAgICAgICAgICBhZGRtZSA9IHR4dF9lc2MoYmxvYi5yYW5nZV9wcmVmaXgpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChibG9iLnN0YXR1cyA9PT0gQ1NMLlNVQ0NFU1NPUikge1xuICAgICAgICAgICAgICAgIGFkZG1lID0gdHh0X2VzYyhibG9iLnN1Y2Nlc3Nvcl9wcmVmaXgpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChibG9iLnN0YXR1cyA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBvcyA+IDAgJiYgIWJsb2Iuc3VwcHJlc3Nfc3BsaWNlX3ByZWZpeCkge1xuICAgICAgICAgICAgICAgICAgICBhZGRtZSA9IHR4dF9lc2MoYmxvYi5zcGxpY2VfcHJlZml4KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhZGRtZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChibG9iLnN0YXR1cyA9PT0gQ1NMLlNFRU4pIHtcbiAgICAgICAgICAgICAgICBhZGRtZSA9IHR4dF9lc2MoYmxvYi5zcGxpY2VfcHJlZml4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldCArPSBhZGRtZTtcbiAgICAgICAgICAgIHJldCArPSBzdHI7XG4gICAgICAgICAgICBpZiAoc3RhdGUudG1wLmNvdW50X29mZnNldF9jaGFyYWN0ZXJzKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLm9mZnNldF9jaGFyYWN0ZXJzICs9IChhZGRtZS5sZW5ndGggKyBibG9iLnN0cmluZ3MucHJlZml4Lmxlbmd0aCArIHN0cmxlbiArIGJsb2Iuc3RyaW5ncy5zdWZmaXgubGVuZ3RoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5PdXRwdXQuUXVldWUucHVyZ2VFbXB0eUJsb2JzID0gZnVuY3Rpb24gKHBhcmVudCkge1xuICAgIGlmIChcIm9iamVjdFwiICE9PSB0eXBlb2YgcGFyZW50IHx8IFwib2JqZWN0XCIgIT09IHR5cGVvZiBwYXJlbnQuYmxvYnMgfHwgIXBhcmVudC5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBmb3IgKHZhciBpPXBhcmVudC5ibG9icy5sZW5ndGgtMTtpPi0xO2ktLSkge1xuICAgICAgICBDU0wuT3V0cHV0LlF1ZXVlLnB1cmdlRW1wdHlCbG9icyhwYXJlbnQuYmxvYnNbaV0pO1xuICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnQuYmxvYnNbaV07XG4gICAgICAgIGlmICghY2hpbGQgfHwgIWNoaWxkLmJsb2JzIHx8ICFjaGlsZC5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHZhciBidWYgPSBbXTtcbiAgICAgICAgICAgIHdoaWxlICgocGFyZW50LmJsb2JzLmxlbmd0aC0xKSA+IGkpIHtcbiAgICAgICAgICAgICAgICBidWYucHVzaChwYXJlbnQuYmxvYnMucG9wKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFyZW50LmJsb2JzLnBvcCgpO1xuICAgICAgICAgICAgd2hpbGUgKGJ1Zi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBwYXJlbnQuYmxvYnMucHVzaChidWYucG9wKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5PdXRwdXQuUXVldWUuYWRqdXN0ID0gZnVuY3Rpb24gKHB1bmN0SW5RdW90ZSkge1xuICAgIHZhciBOT19TV0FQX0lOID0ge1xuICAgICAgICBcIjtcIjogdHJ1ZSxcbiAgICAgICAgXCI6XCI6IHRydWVcbiAgICB9XG4gICAgdmFyIE5PX1NXQVBfT1VUID0ge1xuICAgICAgICBcIi5cIjogdHJ1ZSxcbiAgICAgICAgXCIhXCI6IHRydWUsXG4gICAgICAgIFwiP1wiOiB0cnVlXG4gICAgfVxuICAgIHRoaXMudXB3YXJkID0gdXB3YXJkO1xuICAgIHRoaXMubGVmdHdhcmQgPSBsZWZ0d2FyZDtcbiAgICB0aGlzLmRvd253YXJkID0gZG93bndhcmQ7XG4gICAgdGhpcy5maXggPSBmaXg7XG4gICAgdmFyIEx0b1JfTUFQID0ge1xuICAgICAgICBcIiFcIjoge1xuICAgICAgICAgICAgXCIuXCI6IFwiIVwiLFxuICAgICAgICAgICAgXCI/XCI6IFwiIT9cIixcbiAgICAgICAgICAgIFwiOlwiOiBcIiFcIixcbiAgICAgICAgICAgIFwiLFwiOiBcIiEsXCIsXG4gICAgICAgICAgICBcIjtcIjogXCIhO1wiXG4gICAgICAgIH0sXG4gICAgICAgIFwiP1wiOiB7XG4gICAgICAgICAgICBcIiFcIjogXCI/IVwiLFxuICAgICAgICAgICAgXCIuXCI6IFwiP1wiLFxuICAgICAgICAgICAgXCI6XCI6IFwiP1wiLFxuICAgICAgICAgICAgXCIsXCI6IFwiPyxcIixcbiAgICAgICAgICAgIFwiO1wiOiBcIj87XCJcbiAgICAgICAgfSxcbiAgICAgICAgXCIuXCI6IHtcbiAgICAgICAgICAgIFwiIVwiOiBcIi4hXCIsXG4gICAgICAgICAgICBcIj9cIjogXCIuP1wiLFxuICAgICAgICAgICAgXCI6XCI6IFwiLjpcIixcbiAgICAgICAgICAgIFwiLFwiOiBcIi4sXCIsXG4gICAgICAgICAgICBcIjtcIjogXCIuO1wiXG4gICAgICAgIH0sXG4gICAgICAgIFwiOlwiOiB7XG4gICAgICAgICAgICBcIiFcIjogXCIhXCIsXG4gICAgICAgICAgICBcIj9cIjogXCI/XCIsXG4gICAgICAgICAgICBcIi5cIjogXCI6XCIsXG4gICAgICAgICAgICBcIixcIjogXCI6LFwiLFxuICAgICAgICAgICAgXCI7XCI6IFwiOjtcIlxuICAgICAgICB9LFxuICAgICAgICBcIixcIjoge1xuICAgICAgICAgICAgXCIhXCI6IFwiLCFcIixcbiAgICAgICAgICAgIFwiP1wiOiBcIiw/XCIsXG4gICAgICAgICAgICBcIjpcIjogXCIsOlwiLFxuICAgICAgICAgICAgXCIuXCI6IFwiLC5cIixcbiAgICAgICAgICAgIFwiO1wiOiBcIiw7XCJcbiAgICAgICAgfSxcbiAgICAgICAgXCI7XCI6IHtcbiAgICAgICAgICAgIFwiIVwiOiBcIiFcIixcbiAgICAgICAgICAgIFwiP1wiOiBcIj9cIixcbiAgICAgICAgICAgIFwiOlwiOiBcIjtcIixcbiAgICAgICAgICAgIFwiLFwiOiBcIjssXCIsXG4gICAgICAgICAgICBcIi5cIjogXCI7XCJcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgU1dBUF9JTiA9IHt9O1xuICAgIHZhciBTV0FQX09VVCA9IHt9O1xuICAgIHZhciBQVU5DVCA9IHt9O1xuICAgIHZhciBQVU5DVF9PUl9TUEFDRSA9IHt9O1xuICAgIGZvciAodmFyIGtleSBpbiBMdG9SX01BUCkge1xuICAgICAgICBQVU5DVFtrZXldID0gdHJ1ZTtcbiAgICAgICAgUFVOQ1RfT1JfU1BBQ0Vba2V5XSA9IHRydWU7XG4gICAgICAgIGlmICghTk9fU1dBUF9JTltrZXldKSB7XG4gICAgICAgICAgICBTV0FQX0lOW2tleV0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghTk9fU1dBUF9PVVRba2V5XSkge1xuICAgICAgICAgICAgU1dBUF9PVVRba2V5XSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgUFVOQ1RfT1JfU1BBQ0VbXCIgXCJdID0gdHJ1ZTtcbiAgICBQVU5DVF9PUl9TUEFDRVtcIsKgXCJdID0gdHJ1ZTtcbiAgICB2YXIgUnRvTF9NQVAgPSB7fTtcbiAgICBmb3IgKHZhciBrZXkgaW4gTHRvUl9NQVApIHtcbiAgICAgICAgZm9yICh2YXIgc3Via2V5IGluIEx0b1JfTUFQW2tleV0pIHtcbiAgICAgICAgICAgIGlmICghUnRvTF9NQVBbc3Via2V5XSkge1xuICAgICAgICAgICAgICAgIFJ0b0xfTUFQW3N1YmtleV0gPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFJ0b0xfTUFQW3N1YmtleV1ba2V5XSA9IEx0b1JfTUFQW2tleV1bc3Via2V5XTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBibG9iSXNOdW1iZXIoYmxvYikge1xuICAgICAgICByZXR1cm4gKFwibnVtYmVyXCIgPT09IHR5cGVvZiBibG9iLm51bSB8fCAoYmxvYi5ibG9icyAmJiBibG9iLmJsb2JzLmxlbmd0aCA9PT0gMSAmJiBcIm51bWJlclwiID09PSB0eXBlb2YgYmxvYi5ibG9ic1swXS5udW0pKTtcbiAgICB9O1xuICAgIGZ1bmN0aW9uIGJsb2JFbmRzSW5OdW1iZXIoYmxvYikge1xuICAgICAgICBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIGJsb2IubnVtKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWJsb2IuYmxvYnMgfHwgXCJvYmplY3RcIiAhPT0gIHR5cGVvZiBibG9iLmJsb2JzKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmIChibG9iRW5kc0luTnVtYmVyKGJsb2IuYmxvYnNbYmxvYi5ibG9icy5sZW5ndGgtMV0pKSByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgZnVuY3Rpb24gYmxvYkhhc0RlY29yYXRpb25zKGJsb2IsaW5jbHVkZVF1b3Rlcykge1xuICAgICAgICB2YXIgcmV0ID0gZmFsc2U7XG4gICAgICAgIHZhciBkZWNvcmxpc3QgPSBbJ0Bmb250LXN0eWxlJywnQGZvbnQtdmFyaWFudCcsJ0Bmb250LXdlaWdodCcsJ0B0ZXh0LWRlY29yYXRpb24nLCdAdmVydGljYWwtYWxpZ24nXTtcbiAgICAgICAgaWYgKGluY2x1ZGVRdW90ZXMpIHtcbiAgICAgICAgICAgIGRlY29ybGlzdC5wdXNoKCdAcXVvdGVzJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJsb2IuZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWJsb2IuZGVjb3JhdGlvbnMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoZGVjb3JsaXN0LmluZGV4T2YoYmxvYi5kZWNvcmF0aW9uc1tpXVswXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICByZXQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuICAgIGZ1bmN0aW9uIGJsb2JIYXNEZXNjZW5kYW50UXVvdGVzKGJsb2IpIHtcbiAgICAgICAgaWYgKGJsb2IuZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWJsb2IuZGVjb3JhdGlvbnMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoYmxvYi5kZWNvcmF0aW9uc1tpXVswXSA9PT0gJ0BxdW90ZXMnICYmIGJsb2IuZGVjb3JhdGlvbnNbaV1bMV0gIT09IFwiZmFsc2VcIikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwib2JqZWN0XCIgIT09IHR5cGVvZiBibG9iLmJsb2JzKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGJsb2JIYXNEZXNjZW5kYW50UXVvdGVzKGJsb2IuYmxvYnNbYmxvYi5ibG9icy5sZW5ndGgtMV0pO1xuICAgIH1cbiAgICBmdW5jdGlvbiBibG9iSGFzRGVzY2VuZGFudE1lcmdpbmdQdW5jdHVhdGlvbihwYXJlbnRDaGFyLGJsb2IpIHtcbiAgICAgICAgdmFyIGNoaWxkQ2hhciA9IGJsb2Iuc3RyaW5ncy5zdWZmaXguc2xpY2UoLTEpO1xuICAgICAgICBpZiAoIWNoaWxkQ2hhciAmJiBcInN0cmluZ1wiID09PSB0eXBlb2YgYmxvYi5ibG9icykge1xuICAgICAgICAgICAgY2hpbGRDaGFyID0gYmxvYi5ibG9icy5zbGljZSgtMSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1lcmdlZENoYXJzID0gUnRvTF9NQVBbcGFyZW50Q2hhcl1bY2hpbGRDaGFyXTtcbiAgICAgICAgaWYgKG1lcmdlZENoYXJzICYmIG1lcmdlZENoYXJzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwib2JqZWN0XCIgIT09IHR5cGVvZiBibG9iLmJsb2JzKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmIChibG9iSGFzRGVzY2VuZGFudE1lcmdpbmdQdW5jdHVhdGlvbihwYXJlbnRDaGFyLGJsb2IuYmxvYnNbYmxvYi5ibG9icy5sZW5ndGgtMV0pKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmdW5jdGlvbiBtYXRjaExhc3RDaGFyKGJsb2IsIGNocikge1xuICAgICAgICBpZiAoIVBVTkNUW2Nocl0pIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2IuYmxvYnMpIHtcbiAgICAgICAgICAgIGlmIChibG9iLmJsb2JzLnNsaWNlKC0xKSA9PT0gY2hyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBjaGlsZCA9IGJsb2IuYmxvYnNbYmxvYi5ibG9icy5sZW5ndGgtMV07XG4gICAgICAgICAgICBpZiAoY2hpbGQpIHtcbiAgICAgICAgICAgICAgICB2YXIgY2hpbGRDaGFyID0gY2hpbGQuc3RyaW5ncy5zdWZmaXguc2xpY2UoLTEpO1xuICAgICAgICAgICAgICAgIGlmICghY2hpbGRDaGFyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaExhc3RDaGFyKGNoaWxkLGNocik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGlsZC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSkgPT0gY2hyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgZnVuY3Rpb24gbWVyZ2VDaGFycyAoRmlyc3QsIGZpcnN0LCBTZWNvbmQsIHNlY29uZCwgbWVyZ2VfcmlnaHQpIHtcbiAgICAgICAgdmFyIEZpcnN0U3RyaW5ncyA9IFwiYmxvYnNcIiA9PT0gZmlyc3QgPyBGaXJzdCA6IEZpcnN0LnN0cmluZ3M7XG4gICAgICAgIHZhciBTZWNvbmRTdHJpbmdzID0gXCJibG9ic1wiID09PSBzZWNvbmQgPyBTZWNvbmQ6IFNlY29uZC5zdHJpbmdzO1xuICAgICAgICB2YXIgZmlyc3RDaGFyID0gRmlyc3RTdHJpbmdzW2ZpcnN0XS5zbGljZSgtMSk7XG4gICAgICAgIHZhciBzZWNvbmRDaGFyID0gU2Vjb25kU3RyaW5nc1tzZWNvbmRdLnNsaWNlKDAsMSk7XG4gICAgICAgIGZ1bmN0aW9uIGN1bGxSaWdodCAoKSB7XG4gICAgICAgICAgICBTZWNvbmRTdHJpbmdzW3NlY29uZF0gPSBTZWNvbmRTdHJpbmdzW3NlY29uZF0uc2xpY2UoMSk7XG4gICAgICAgIH07XG4gICAgICAgIGZ1bmN0aW9uIGN1bGxMZWZ0ICgpIHtcbiAgICAgICAgICAgIEZpcnN0U3RyaW5nc1tmaXJzdF0gPSBGaXJzdFN0cmluZ3NbZmlyc3RdLnNsaWNlKDAsLTEpO1xuICAgICAgICB9O1xuICAgICAgICBmdW5jdGlvbiBhZGRSaWdodCAoY2hyKSB7XG4gICAgICAgICAgICBTZWNvbmRTdHJpbmdzW3NlY29uZF0gPSBjaHIgKyBTZWNvbmRTdHJpbmdzW3NlY29uZF07XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gYWRkTGVmdCAoY2hyKSB7XG4gICAgICAgICAgICBGaXJzdFN0cmluZ3NbZmlyc3RdICs9IGNocjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgY3VsbCA9IG1lcmdlX3JpZ2h0ID8gY3VsbExlZnQgOiBjdWxsUmlnaHQ7XG4gICAgICAgIGZ1bmN0aW9uIG1hdGNoT25SaWdodCAoKSB7XG4gICAgICAgICAgICByZXR1cm4gUnRvTF9NQVBbc2Vjb25kQ2hhcl07XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gbWF0Y2hPbkxlZnQgKCkge1xuICAgICAgICAgICAgcmV0dXJuIEx0b1JfTUFQW2ZpcnN0Q2hhcl07XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1hdGNoID0gbWVyZ2VfcmlnaHQgPyBtYXRjaE9uTGVmdCA6IG1hdGNoT25SaWdodDtcbiAgICAgICAgZnVuY3Rpb24gbWVyZ2VUb1JpZ2h0ICgpIHtcbiAgICAgICAgICAgIHZhciBjaHIgPSBMdG9SX01BUFtmaXJzdENoYXJdW3NlY29uZENoYXJdO1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBjaHIpIHtcbiAgICAgICAgICAgICAgICBjdWxsTGVmdCgpO1xuICAgICAgICAgICAgICAgIGN1bGxSaWdodCgpO1xuICAgICAgICAgICAgICAgIGFkZFJpZ2h0KGNocik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFkZFJpZ2h0KGZpcnN0Q2hhcik7XG4gICAgICAgICAgICAgICAgY3VsbExlZnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiBtZXJnZVRvTGVmdCAoKSB7XG4gICAgICAgICAgICB2YXIgY2hyID0gUnRvTF9NQVBbc2Vjb25kQ2hhcl1bZmlyc3RDaGFyXTtcbiAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgY2hyKSB7XG4gICAgICAgICAgICAgICAgY3VsbExlZnQoKTtcbiAgICAgICAgICAgICAgICBjdWxsUmlnaHQoKTtcbiAgICAgICAgICAgICAgICBhZGRMZWZ0KGNocik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFkZExlZnQoc2Vjb25kQ2hhcik7XG4gICAgICAgICAgICAgICAgY3VsbFJpZ2h0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1lcmdlID0gbWVyZ2VfcmlnaHQgPyBtZXJnZVRvUmlnaHQ6IG1lcmdlVG9MZWZ0O1xuICAgICAgICB2YXIgaXNEdXBsaWNhdGUgPSBmaXJzdENoYXIgPT09IHNlY29uZENoYXI7XG4gICAgICAgIGlmIChpc0R1cGxpY2F0ZSkge1xuICAgICAgICAgICAgY3VsbCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKG1hdGNoKCkpIHtcbiAgICAgICAgICAgICAgICBtZXJnZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICBmdW5jdGlvbiB1cHdhcmQgKHBhcmVudCkge1xuICAgICAgICBpZiAocGFyZW50LmJsb2JzICYmIFwic3RyaW5nXCIgPT0gdHlwZW9mIHBhcmVudC5ibG9icykge1xuICAgICAgICAgICAgaWYgKFBVTkNUW3BhcmVudC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpXVxuICAgICAgICAgICAgICAgICYmIHBhcmVudC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpID09PSBwYXJlbnQuYmxvYnMuc2xpY2UoLTEpKSB7XG4gICAgICAgICAgICAgICAgcGFyZW50LnN0cmluZ3Muc3VmZml4ID0gcGFyZW50LnN0cmluZ3Muc3VmZml4LnNsaWNlKDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2UgaWYgKFwib2JqZWN0XCIgIT09IHR5cGVvZiBwYXJlbnQgfHwgXCJvYmplY3RcIiAhPT0gdHlwZW9mIHBhcmVudC5ibG9icyB8fCAhcGFyZW50LmJsb2JzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHZhciBwYXJlbnREZWNvcmF0aW9ucyA9IGJsb2JIYXNEZWNvcmF0aW9ucyhwYXJlbnQsdHJ1ZSk7XG4gICAgICAgIGZvciAodmFyIGk9cGFyZW50LmJsb2JzLmxlbmd0aC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICB2YXIgZW5kRmxhZyA9IGkgPT09IChwYXJlbnQuYmxvYnMubGVuZ3RoLTEpO1xuICAgICAgICAgICAgdGhpcy51cHdhcmQocGFyZW50LmJsb2JzW2ldKTtcbiAgICAgICAgICAgIHZhciBwYXJlbnRTdHJpbmdzID0gcGFyZW50LnN0cmluZ3M7XG4gICAgICAgICAgICB2YXIgY2hpbGRTdHJpbmdzID0gcGFyZW50LmJsb2JzW2ldLnN0cmluZ3M7XG4gICAgICAgICAgICBpZiAoaSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGlmIChcIiBcIiA9PT0gcGFyZW50U3RyaW5ncy5wcmVmaXguc2xpY2UoLTEpICYmIFwiIFwiID09PSBjaGlsZFN0cmluZ3MucHJlZml4LnNsaWNlKDAsIDEpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkU3RyaW5ncy5wcmVmaXggPSBjaGlsZFN0cmluZ3MucHJlZml4LnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgY2hpbGRDaGFyID0gY2hpbGRTdHJpbmdzLnByZWZpeC5zbGljZSgwLCAxKTtcbiAgICAgICAgICAgICAgICBpZiAoIXBhcmVudERlY29yYXRpb25zICYmIFBVTkNUX09SX1NQQUNFW2NoaWxkQ2hhcl0gJiYgIXBhcmVudFN0cmluZ3MucHJlZml4KSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmVudFN0cmluZ3MucHJlZml4ICs9IGNoaWxkQ2hhcjtcbiAgICAgICAgICAgICAgICAgICAgY2hpbGRTdHJpbmdzLnByZWZpeCA9IGNoaWxkU3RyaW5ncy5wcmVmaXguc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGkgPT09IChwYXJlbnQuYmxvYnMubGVuZ3RoIC0gMSkpIHtcbiAgICAgICAgICAgICAgICB2YXIgY2hpbGRDaGFyID0gY2hpbGRTdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSk7XG4gICAgICAgICAgICAgICAgaWYgKCFwYXJlbnREZWNvcmF0aW9ucyAmJiBbXCIgXCJdLmluZGV4T2YoY2hpbGRDaGFyKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRTdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpICE9PSBjaGlsZENoYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0cmluZ3Muc3VmZml4ID0gY2hpbGRDaGFyICsgcGFyZW50U3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2hpbGRTdHJpbmdzLnN1ZmZpeCA9IGNoaWxkU3RyaW5ncy5zdWZmaXguc2xpY2UoMCwgLTEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYXJlbnRTdHJpbmdzLmRlbGltaXRlciAmJiBpID4gMCkge1xuICAgICAgICAgICAgICAgIGlmIChQVU5DVF9PUl9TUEFDRVtwYXJlbnRTdHJpbmdzLmRlbGltaXRlci5zbGljZSgtMSldXG4gICAgICAgICAgICAgICAgICAgICYmIHBhcmVudFN0cmluZ3MuZGVsaW1pdGVyLnNsaWNlKC0xKSA9PT0gY2hpbGRTdHJpbmdzLnByZWZpeC5zbGljZSgwLCAxKSkge1xuICAgICAgICAgICAgICAgICAgICBjaGlsZFN0cmluZ3MucHJlZml4ID0gY2hpbGRTdHJpbmdzLnByZWZpeC5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGZ1bmN0aW9uIGxlZnR3YXJkIChwYXJlbnQpIHtcbiAgICAgICAgaWYgKFwib2JqZWN0XCIgIT09IHR5cGVvZiBwYXJlbnQgfHwgXCJvYmplY3RcIiAhPT0gdHlwZW9mIHBhcmVudC5ibG9icyB8fCAhcGFyZW50LmJsb2JzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGk9cGFyZW50LmJsb2JzLmxlbmd0aC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICB0aGlzLmxlZnR3YXJkKHBhcmVudC5ibG9ic1tpXSk7XG4gICAgICAgICAgICBpZiAoKGkgPCBwYXJlbnQuYmxvYnMubGVuZ3RoIC0xKSAmJiAhcGFyZW50LnN0cmluZ3MuZGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmJsb2JzW2ldO1xuICAgICAgICAgICAgICAgIHZhciBjaGlsZENoYXIgPSBjaGlsZC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSk7XG4gICAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBwYXJlbnQuYmxvYnNbaSsxXTtcbiAgICAgICAgICAgICAgICB2YXIgc2libGluZ0NoYXIgPSBzaWJsaW5nLnN0cmluZ3MucHJlZml4LnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgIHZhciBoYXNEZWNvcmF0aW9ucyA9IGJsb2JIYXNEZWNvcmF0aW9ucyhjaGlsZCkgfHwgYmxvYkhhc0RlY29yYXRpb25zKHNpYmxpbmcpO1xuICAgICAgICAgICAgICAgIHZhciBoYXNOdW1iZXIgPSBcIm51bWJlclwiID09PSB0eXBlb2YgY2hpbGRDaGFyIHx8IFwibnVtYmVyXCIgPT09IHR5cGVvZiBzaWJsaW5nQ2hhcjtcbiAgICAgICAgICAgICAgICBpZiAoIWhhc0RlY29yYXRpb25zICYmICFoYXNOdW1iZXIgJiYgUFVOQ1Rbc2libGluZ0NoYXJdICYmICFoYXNOdW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN1ZmZpeEFuZFByZWZpeE1hdGNoID0gc2libGluZ0NoYXIgPT09IGNoaWxkLnN0cmluZ3Muc3VmZml4LnNsaWNlKC0xKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN1ZmZpeEFuZEZpZWxkTWF0Y2ggPSAoIWNoaWxkLnN0cmluZ3Muc3VmZml4ICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiBjaGlsZC5ibG9icyAmJiBjaGlsZC5ibG9icy5zbGljZSgtMSkgPT09IHNpYmxpbmdDaGFyKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdWZmaXhBbmRQcmVmaXhNYXRjaCAmJiAhc3VmZml4QW5kRmllbGRNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VDaGFycyhjaGlsZCwgJ3N1ZmZpeCcsIHNpYmxpbmcsICdwcmVmaXgnKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpYmxpbmcuc3RyaW5ncy5wcmVmaXggPSBzaWJsaW5nLnN0cmluZ3MucHJlZml4LnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICBmdW5jdGlvbiBkb3dud2FyZCAocGFyZW50LCB0b3ApIHtcbiAgICAgICAgaWYgKHBhcmVudC5ibG9icyAmJiBcInN0cmluZ1wiID09IHR5cGVvZiBwYXJlbnQuYmxvYnMpIHtcbiAgICAgICAgICAgIGlmIChQVU5DVFtwYXJlbnQuc3RyaW5ncy5zdWZmaXguc2xpY2UoMCwxKV1cbiAgICAgICAgICAgICAgICAmJiBwYXJlbnQuc3RyaW5ncy5zdWZmaXguc2xpY2UoMCwxKSA9PT0gcGFyZW50LmJsb2JzLnNsaWNlKC0xKSkge1xuICAgICAgICAgICAgICAgIHBhcmVudC5zdHJpbmdzLnN1ZmZpeCA9IHBhcmVudC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfSBlbHNlIGlmIChcIm9iamVjdFwiICE9PSB0eXBlb2YgcGFyZW50IHx8IFwib2JqZWN0XCIgIT09IHR5cGVvZiBwYXJlbnQuYmxvYnMgfHwgIXBhcmVudC5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcGFyZW50U3RyaW5ncyA9IHBhcmVudC5zdHJpbmdzO1xuICAgICAgICB2YXIgc29tZUNoaWxkcmVuQXJlTnVtYmVycyA9IGZhbHNlO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1wYXJlbnQuYmxvYnMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIGlmIChibG9iSXNOdW1iZXIocGFyZW50LmJsb2JzW2ldKSkge1xuICAgICAgICAgICAgICAgIHNvbWVDaGlsZHJlbkFyZU51bWJlcnMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0cnVlIHx8ICFzb21lQ2hpbGRyZW5BcmVOdW1iZXJzKSB7XG4gICAgICAgICAgICBpZiAocGFyZW50U3RyaW5ncy5kZWxpbWl0ZXIgJiYgUFVOQ1RbcGFyZW50U3RyaW5ncy5kZWxpbWl0ZXIuc2xpY2UoMCwgMSldKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRlbGltQ2hhciA9IHBhcmVudFN0cmluZ3MuZGVsaW1pdGVyLnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9cGFyZW50LmJsb2JzLmxlbmd0aC0yO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZFN0cmluZ3MgPSBwYXJlbnQuYmxvYnNbaV0uc3RyaW5ncztcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkU3RyaW5ncy5zdWZmaXguc2xpY2UoLTEpICE9PSBkZWxpbUNoYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkU3RyaW5ncy5zdWZmaXggKz0gZGVsaW1DaGFyO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBhcmVudFN0cmluZ3MuZGVsaW1pdGVyID0gcGFyZW50U3RyaW5ncy5kZWxpbWl0ZXIuc2xpY2UoMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHBhcmVudERlY29yYXRpb25zID0gYmxvYkhhc0RlY29yYXRpb25zKHBhcmVudCwgdHJ1ZSk7XG4gICAgICAgIHZhciBwYXJlbnRJc051bWJlciA9IGJsb2JJc051bWJlcihwYXJlbnQpO1xuICAgICAgICBmb3IgKHZhciBpPXBhcmVudC5ibG9icy5sZW5ndGgtMTtpPi0xO2ktLSkge1xuICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmJsb2JzW2ldO1xuICAgICAgICAgICAgdmFyIGNoaWxkU3RyaW5ncyA9IHBhcmVudC5ibG9ic1tpXS5zdHJpbmdzO1xuICAgICAgICAgICAgdmFyIGNoaWxkRGVjb3JhdGlvbnMgPSBibG9iSGFzRGVjb3JhdGlvbnMoY2hpbGQsIHRydWUpO1xuICAgICAgICAgICAgdmFyIGNoaWxkSXNOdW1iZXIgPSBibG9iSXNOdW1iZXIoY2hpbGQpO1xuICAgICAgICAgICAgaWYgKGkgPT09IChwYXJlbnQuYmxvYnMubGVuZ3RoIC0gMSkpIHtcbiAgICAgICAgICAgICAgICBpZiAodHJ1ZSB8fCAhc29tZUNoaWxkcmVuQXJlTnVtYmVycykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Q2hhciA9IHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgYWxsb3dNaWdyYXRpb24gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFBVTkNUW3BhcmVudENoYXJdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd01pZ3JhdGlvbiA9IGJsb2JIYXNEZXNjZW5kYW50TWVyZ2luZ1B1bmN0dWF0aW9uKHBhcmVudENoYXIsY2hpbGQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhbGxvd01pZ3JhdGlvbiAmJiBwdW5jdEluUXVvdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd01pZ3JhdGlvbiA9IGJsb2JIYXNEZXNjZW5kYW50UXVvdGVzKGNoaWxkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoYWxsb3dNaWdyYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChQVU5DVFtwYXJlbnRDaGFyXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYmxvYkVuZHNJbk51bWJlcihjaGlsZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBjaGlsZC5ibG9icykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VDaGFycyhjaGlsZCwgJ2Jsb2JzJywgcGFyZW50LCAnc3VmZml4Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZUNoYXJzKGNoaWxkLCAnc3VmZml4JywgcGFyZW50LCAnc3VmZml4Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsMSkgPT09IFwiLlwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZFN0cmluZ3Muc3VmZml4ICs9IHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdHJpbmdzLnN1ZmZpeCA9IHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZFN0cmluZ3Muc3VmZml4LnNsaWNlKC0xKSA9PT0gXCLCoFwiICYmIHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsMSkgPT09IFwiIFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdHJpbmdzLnN1ZmZpeCA9IHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChQVU5DVF9PUl9TUEFDRVtjaGlsZFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsMSldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGNoaWxkLmJsb2JzICYmIGNoaWxkLmJsb2JzLnNsaWNlKC0xKSA9PT0gY2hpbGRTdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRTdHJpbmdzLnN1ZmZpeCA9IGNoaWxkU3RyaW5ncy5zdWZmaXguc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRTdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSkgPT09IHBhcmVudFN0cmluZ3Muc3VmZml4LnNsaWNlKDAsIDEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RyaW5ncy5zdWZmaXggPSBwYXJlbnRTdHJpbmdzLnN1ZmZpeC5zbGljZSgwLCAtMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG1hdGNoTGFzdENoYXIocGFyZW50LHBhcmVudC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpKSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJlbnQuc3RyaW5ncy5zdWZmaXggPSBwYXJlbnQuc3RyaW5ncy5zdWZmaXguc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJlbnRTdHJpbmdzLmRlbGltaXRlcikge1xuICAgICAgICAgICAgICAgIGlmIChQVU5DVF9PUl9TUEFDRVtwYXJlbnRTdHJpbmdzLmRlbGltaXRlci5zbGljZSgwLDEpXVxuICAgICAgICAgICAgICAgICAgICAmJiBwYXJlbnRTdHJpbmdzLmRlbGltaXRlci5zbGljZSgwLCAxKSA9PT0gY2hpbGRTdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50LmJsb2JzW2ldLnN0cmluZ3Muc3VmZml4ID0gcGFyZW50LmJsb2JzW2ldLnN0cmluZ3Muc3VmZml4LnNsaWNlKDAsIC0xKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBzaWJsaW5nU3RyaW5ncyA9IHBhcmVudC5ibG9ic1tpKzFdLnN0cmluZ3M7XG4gICAgICAgICAgICAgICAgaWYgKCFibG9iSXNOdW1iZXIoY2hpbGQpIFxuICAgICAgICAgICAgICAgICAgICAmJiAhY2hpbGREZWNvcmF0aW9uc1xuICAgICAgICAgICAgICAgICAgICAmJiBQVU5DVF9PUl9TUEFDRVtjaGlsZFN0cmluZ3Muc3VmZml4LnNsaWNlKC0xKV1cbiAgICAgICAgICAgICAgICAgICAgJiYgY2hpbGRTdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSkgPT09IHNpYmxpbmdTdHJpbmdzLnByZWZpeC5zbGljZSgwLCAxKSkge1xuICAgICAgICAgICAgICAgICAgICBzaWJsaW5nU3RyaW5ncy5wcmVmaXggPSBzaWJsaW5nU3RyaW5ncy5wcmVmaXguc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFjaGlsZElzTnVtYmVyICYmICFjaGlsZERlY29yYXRpb25zICYmIFBVTkNUW2NoaWxkU3RyaW5ncy5zdWZmaXguc2xpY2UoMCwxKV1cbiAgICAgICAgICAgICAgICAmJiBcInN0cmluZ1wiID09PSB0eXBlb2YgY2hpbGQuYmxvYnMpIHtcbiAgICAgICAgICAgICAgICBtZXJnZUNoYXJzKGNoaWxkLCAnYmxvYnMnLCBjaGlsZCwgJ3N1ZmZpeCcpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmRvd253YXJkKHBhcmVudC5ibG9ic1tpXSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGZ1bmN0aW9uIHN3YXBUb1RoZUxlZnQgKGNoaWxkKSB7XG4gICAgICAgIHZhciBjaGlsZENoYXIgPSBjaGlsZC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpO1xuICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGNoaWxkLmJsb2JzKSB7XG4gICAgICAgICAgICB3aGlsZSAoU1dBUF9JTltjaGlsZENoYXJdKSB7XG4gICAgICAgICAgICAgICAgbWVyZ2VDaGFycyhjaGlsZCwgJ2Jsb2JzJywgY2hpbGQsICdzdWZmaXgnKTtcbiAgICAgICAgICAgICAgICBjaGlsZENoYXIgPSBjaGlsZC5zdHJpbmdzLnN1ZmZpeC5zbGljZSgwLDEpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB3aGlsZSAoU1dBUF9JTltjaGlsZENoYXJdKSB7XG4gICAgICAgICAgICAgICAgbWVyZ2VDaGFycyhjaGlsZC5ibG9ic1tjaGlsZC5ibG9icy5sZW5ndGgtMV0sICdzdWZmaXgnLCBjaGlsZCwgJ3N1ZmZpeCcpO1xuICAgICAgICAgICAgICAgIGNoaWxkQ2hhciA9IGNoaWxkLnN0cmluZ3Muc3VmZml4LnNsaWNlKDAsMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gc3dhcFRvVGhlUmlnaHQgKGNoaWxkKSB7XG4gICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgY2hpbGQuYmxvYnMpIHtcbiAgICAgICAgICAgIHZhciBjaGlsZENoYXIgPSBjaGlsZC5ibG9icy5zbGljZSgtMSk7XG4gICAgICAgICAgICB3aGlsZSAoU1dBUF9PVVRbY2hpbGRDaGFyXSkge1xuICAgICAgICAgICAgICAgIG1lcmdlQ2hhcnMoY2hpbGQsICdibG9icycsIGNoaWxkLCAnc3VmZml4JywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgY2hpbGRDaGFyID0gY2hpbGQuYmxvYnMuc2xpY2UoLTEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIGNoaWxkQ2hhciA9IGNoaWxkLmJsb2JzW2NoaWxkLmJsb2JzLmxlbmd0aC0xXS5zdHJpbmdzLnN1ZmZpeC5zbGljZSgtMSk7XG4gICAgICAgICAgICB3aGlsZSAoU1dBUF9PVVRbY2hpbGRDaGFyXSkge1xuICAgICAgICAgICAgICAgIG1lcmdlQ2hhcnMoY2hpbGQuYmxvYnNbY2hpbGQuYmxvYnMubGVuZ3RoLTFdLCAnc3VmZml4JywgY2hpbGQsICdzdWZmaXgnLCB0cnVlKTtcbiAgICAgICAgICAgICAgICBjaGlsZENoYXIgPSBjaGlsZC5ibG9ic1tjaGlsZC5ibG9icy5sZW5ndGgtMV0uc3RyaW5ncy5zdWZmaXguc2xpY2UoLTEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZ1bmN0aW9uIGZpeCAocGFyZW50KSB7XG4gICAgICAgIGlmIChcIm9iamVjdFwiICE9PSB0eXBlb2YgcGFyZW50IHx8IFwib2JqZWN0XCIgIT09IHR5cGVvZiBwYXJlbnQuYmxvYnMgfHwgIXBhcmVudC5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbGFzdENoYXI7XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXBhcmVudC5ibG9icy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmJsb2JzW2ldO1xuICAgICAgICAgICAgdmFyIHF1b3RlU3dhcCA9IGZhbHNlO1xuICAgICAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49Y2hpbGQuZGVjb3JhdGlvbnMubGVuZ3RoO2o8amxlbjtqKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgZGVjb3JhdGlvbiA9IGNoaWxkLmRlY29yYXRpb25zW2pdO1xuICAgICAgICAgICAgICAgIGlmIChkZWNvcmF0aW9uWzBdID09PSBcIkBxdW90ZXNcIiAmJiBkZWNvcmF0aW9uWzFdICE9PSBcImZhbHNlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVvdGVTd2FwID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocXVvdGVTd2FwKSB7XG4gICAgICAgICAgICAgICAgaWYgKHB1bmN0SW5RdW90ZSkge1xuICAgICAgICAgICAgICAgICAgICBzd2FwVG9UaGVMZWZ0KGNoaWxkKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzd2FwVG9UaGVSaWdodChjaGlsZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGFzdENoYXIgPSB0aGlzLmZpeChwYXJlbnQuYmxvYnNbaV0pO1xuICAgICAgICAgICAgaWYgKGNoaWxkLmJsb2JzICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiBjaGlsZC5ibG9icykge1xuICAgICAgICAgICAgICAgIGxhc3RDaGFyID0gY2hpbGQuYmxvYnMuc2xpY2UoLTEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsYXN0Q2hhcjtcbiAgICB9O1xufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuRW5naW5lLk9wdCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmhhc19kaXNhbWJpZ3VhdGUgPSBmYWxzZTtcbiAgICB0aGlzLm1vZGUgPSBcImh0bWxcIjtcbiAgICB0aGlzLmRhdGVzID0ge307XG4gICAgdGhpcy5qdXJpc2RpY3Rpb25zX3NlZW4gPSB7fTtcbiAgICB0aGlzLnN1cHByZXNzZWRKdXJpc2RpY3Rpb25zID0ge307XG4gICAgdGhpcy5pbmhlcml0ZWRBdHRyaWJ1dGVzID0ge307XG4gICAgdGhpc1tcImxvY2FsZS1zb3J0XCJdID0gW107XG4gICAgdGhpc1tcImxvY2FsZS10cmFuc2xpdFwiXSA9IFtdO1xuICAgIHRoaXNbXCJsb2NhbGUtdHJhbnNsYXRcIl0gPSBbXTtcbiAgICB0aGlzLmNpdGVBZmZpeGVzID0ge1xuICAgICAgICBwZXJzb25zOntcbiAgICAgICAgICAgIFwibG9jYWxlLW9yaWdcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBcImxvY2FsZS10cmFuc2xpdFwiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwibG9jYWxlLXRyYW5zbGF0XCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGluc3RpdHV0aW9uczp7XG4gICAgICAgICAgICBcImxvY2FsZS1vcmlnXCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJsb2NhbGUtdHJhbnNsaXRcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBcImxvY2FsZS10cmFuc2xhdFwiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB0aXRsZXM6e1xuICAgICAgICAgICAgXCJsb2NhbGUtb3JpZ1wiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwibG9jYWxlLXRyYW5zbGl0XCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJsb2NhbGUtdHJhbnNsYXRcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgam91cm5hbHM6e1xuICAgICAgICAgICAgXCJsb2NhbGUtb3JpZ1wiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwibG9jYWxlLXRyYW5zbGl0XCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJsb2NhbGUtdHJhbnNsYXRcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgcHVibGlzaGVyczp7XG4gICAgICAgICAgICBcImxvY2FsZS1vcmlnXCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJsb2NhbGUtdHJhbnNsaXRcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBcImxvY2FsZS10cmFuc2xhdFwiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBwbGFjZXM6e1xuICAgICAgICAgICAgXCJsb2NhbGUtb3JpZ1wiOntcbiAgICAgICAgICAgICAgICBwcmVmaXg6XCJcIixcbiAgICAgICAgICAgICAgICBzdWZmaXg6XCJcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwibG9jYWxlLXRyYW5zbGl0XCI6e1xuICAgICAgICAgICAgICAgIHByZWZpeDpcIlwiLFxuICAgICAgICAgICAgICAgIHN1ZmZpeDpcIlwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJsb2NhbGUtdHJhbnNsYXRcIjp7XG4gICAgICAgICAgICAgICAgcHJlZml4OlwiXCIsXG4gICAgICAgICAgICAgICAgc3VmZml4OlwiXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgdGhpc1tcImRlZmF1bHQtbG9jYWxlXCJdID0gW107XG4gICAgdGhpcy51cGRhdGVfbW9kZSA9IENTTC5OT05FO1xuICAgIHRoaXMuYmliX21vZGUgPSBDU0wuTk9ORTtcbiAgICB0aGlzLnNvcnRfY2l0YXRpb25zID0gZmFsc2U7XG4gICAgdGhpc1tcImV0LWFsLW1pblwiXSA9IDA7XG4gICAgdGhpc1tcImV0LWFsLXVzZS1maXJzdFwiXSA9IDE7XG4gICAgdGhpc1tcImV0LWFsLXVzZS1sYXN0XCJdID0gZmFsc2U7XG4gICAgdGhpc1tcImV0LWFsLXN1YnNlcXVlbnQtbWluXCJdID0gZmFsc2U7XG4gICAgdGhpc1tcImV0LWFsLXN1YnNlcXVlbnQtdXNlLWZpcnN0XCJdID0gZmFsc2U7XG4gICAgdGhpc1tcImRlbW90ZS1ub24tZHJvcHBpbmctcGFydGljbGVcIl0gPSBcImRpc3BsYXktYW5kLXNvcnRcIjtcbiAgICB0aGlzW1wicGFyc2UtbmFtZXNcIl0gPSB0cnVlO1xuICAgIHRoaXMuY2l0YXRpb25fbnVtYmVyX3NsdWcgPSBmYWxzZTtcbiAgICB0aGlzLnRyaWdyYXBoID0gXCJBYWFhMDA6QWFBYTAwOkFhQUEwMDpBQUFBMDBcIjtcbiAgICB0aGlzLm5vZGVuYW1lcyA9IFtdO1xuICAgIHRoaXMuZ2VuZGVyID0ge307XG4gICAgdGhpc1snY2l0ZS1sYW5nLXByZWZzJ10gPSB7XG4gICAgICAgIHBlcnNvbnM6WydvcmlnJ10sXG4gICAgICAgIGluc3RpdHV0aW9uczpbJ29yaWcnXSxcbiAgICAgICAgdGl0bGVzOlsnb3JpZyddLFxuICAgICAgICBqb3VybmFsczpbJ29yaWcnXSxcbiAgICAgICAgcHVibGlzaGVyczpbJ29yaWcnXSxcbiAgICAgICAgcGxhY2VzOlsnb3JpZyddLFxuICAgICAgICBudW1iZXI6WydvcmlnJ11cbiAgICB9O1xuICAgIHRoaXMuaGFzX2xheW91dF9sb2NhbGUgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMgPSB7fTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZmllbGRfaGFjayA9IHRydWU7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLmFsbG93X2ZpZWxkX2hhY2tfZGF0ZV9vdmVycmlkZSA9IHRydWU7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLmxvY2F0b3JfZGF0ZV9hbmRfcmV2aXNpb24gPSB0cnVlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5sb2NhdG9yX3BhcnNpbmdfZm9yX3BsdXJhbHMgPSB0cnVlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5sb2NhdG9yX2xhYmVsX3BhcnNlID0gdHJ1ZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMucmF3X2RhdGVfcGFyc2luZyA9IHRydWU7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLmNsZWFuX3VwX2NzbF9mbGF3cyA9IHRydWU7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLmZsaXBfcGFyZW50aGVzZXNfdG9fYnJhY2VzID0gdHJ1ZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuanVyaXNkaWN0aW9uX3N1YmZpZWxkID0gdHJ1ZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3RhdGljX3N0YXR1dGVfbG9jYXRvciA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5jc2xfcmV2ZXJzZV9sb29rdXBfc3VwcG9ydCA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5jbG9iYmVyX2xvY2F0b3JfaWZfbm9fc3RhdHV0ZV9zZWN0aW9uID0gZmFsc2U7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLndyYXBfdXJsX2FuZF9kb2kgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuYWxsb3dfZm9yY2VfbG93ZXJjYXNlID0gZmFsc2U7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLmhhbmRsZV9wYXJhbGxlbF9hcnRpY2xlcyA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy50aGluX25vbl9icmVha2luZ19zcGFjZV9odG1sX2hhY2sgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuYXBwbHlfY2l0YXRpb25fd3JhcHBlciA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5tYWluX3RpdGxlX2Zyb21fc2hvcnRfdGl0bGUgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMudXBwZXJjYXNlX3N1YnRpdGxlcyA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ub3JtYWxpemVfbGFuZ19rZXlzX3RvX2xvd2VyY2FzZSA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5zdHJpY3RfdGV4dF9jYXNlX2xvY2FsZXMgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMucnRsX3N1cHBvcnQgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZXhwZWN0X2FuZF9zeW1ib2xfZm9ybSA9IGZhbHNlO1xuICAgIHRoaXMuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5yZXF1aXJlX2V4cGxpY2l0X2xlZ2FsX2Nhc2VfdGl0bGVfc2hvcnQgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3Bvb2ZfaW5zdGl0dXRpb25hbF9hZmZpbGlhdGlvbnMgPSBmYWxzZTtcbiAgICB0aGlzLmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZm9yY2VfanVyaXNkaWN0aW9uID0gZmFsc2U7XG4gICAgdGhpcy5kZXZlbG9wbWVudF9leHRlbnNpb25zLnBhcnNlX25hbWVzID0gdHJ1ZTtcbn07XG5DU0wuRW5naW5lLlRtcCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLm5hbWVzX21heCA9IG5ldyBDU0wuU3RhY2soKTtcbiAgICB0aGlzLm5hbWVzX2Jhc2UgPSBuZXcgQ1NMLlN0YWNrKCk7XG4gICAgdGhpcy5naXZlbnNfYmFzZSA9IG5ldyBDU0wuU3RhY2soKTtcbiAgICB0aGlzLnZhbHVlID0gW107XG4gICAgdGhpcy5uYW1lcGFydF9kZWNvcmF0aW9ucyA9IHt9O1xuICAgIHRoaXMubmFtZXBhcnRfdHlwZSA9IGZhbHNlO1xuICAgIHRoaXMuYXJlYSA9IFwiY2l0YXRpb25cIjtcbiAgICB0aGlzLnJvb3QgPSBcImNpdGF0aW9uXCI7XG4gICAgdGhpcy5leHRlbnNpb24gPSBcIlwiO1xuICAgIHRoaXMuY2FuX3N1YnN0aXR1dGUgPSBuZXcgQ1NMLlN0YWNrKDAsIENTTC5MSVRFUkFMKTtcbiAgICB0aGlzLmVsZW1lbnRfcmVuZGVyZWRfb2sgPSBmYWxzZTtcbiAgICB0aGlzLmVsZW1lbnRfdHJhY2UgPSBuZXcgQ1NMLlN0YWNrKFwic3R5bGVcIik7XG4gICAgdGhpcy5uYW1lc2V0X2NvdW50ZXIgPSAwO1xuICAgIHRoaXMuZ3JvdXBfY29udGV4dCA9IG5ldyBDU0wuU3RhY2soe1xuICAgICAgICB0ZXJtX2ludGVuZGVkOiBmYWxzZSxcbiAgICAgICAgdmFyaWFibGVfYXR0ZW1wdDogZmFsc2UsXG4gICAgICAgIHZhcmlhYmxlX3N1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBvdXRwdXRfdGlwOiB1bmRlZmluZWQsXG4gICAgICAgIGxhYmVsX2Zvcm06ICB1bmRlZmluZWQsXG4gICAgICAgIHBhcmFsbGVsX2NvbmRpdGlvbnM6IHVuZGVmaW5lZCxcbiAgICAgICAgY29uZGl0aW9uOiBmYWxzZSxcbiAgICAgICAgZm9yY2Vfc3VwcHJlc3M6IGZhbHNlLFxuICAgICAgICBkb25lX3ZhcnM6IFtdXG4gICAgfSk7XG4gICAgdGhpcy50ZXJtX3ByZWRlY2Vzc29yID0gZmFsc2U7XG4gICAgdGhpcy5pbl9jaXRlX3ByZWRlY2Vzc29yID0gZmFsc2U7XG4gICAgdGhpcy5qdW1wID0gbmV3IENTTC5TdGFjaygwLCBDU0wuTElURVJBTCk7XG4gICAgdGhpcy5kZWNvcmF0aW9ucyA9IG5ldyBDU0wuU3RhY2soKTtcbiAgICB0aGlzLnRva2Vuc3RvcmVfc3RhY2sgPSBuZXcgQ1NMLlN0YWNrKCk7XG4gICAgdGhpcy5sYXN0X3N1ZmZpeF91c2VkID0gXCJcIjtcbiAgICB0aGlzLmxhc3RfbmFtZXNfdXNlZCA9IFtdO1xuICAgIHRoaXMubGFzdF95ZWFyc191c2VkID0gW107XG4gICAgdGhpcy55ZWFyc191c2VkID0gW107XG4gICAgdGhpcy5uYW1lc191c2VkID0gW107XG4gICAgdGhpcy50YWludGVkSXRlbUlEcyA9IHt9O1xuICAgIHRoaXMudGFpbnRlZENpdGF0aW9uSURzID0ge307XG4gICAgdGhpcy5pbml0aWFsaXplX3dpdGggPSBuZXcgQ1NMLlN0YWNrKCk7XG4gICAgdGhpcy5kaXNhbWJpZ19yZXF1ZXN0ID0gZmFsc2U7XG4gICAgdGhpc1tcIm5hbWUtYXMtc29ydC1vcmRlclwiXSA9IGZhbHNlO1xuICAgIHRoaXMuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSBmYWxzZTtcbiAgICB0aGlzLmRpc2FtYmlnX3NldHRpbmdzID0gbmV3IENTTC5BbWJpZ0NvbmZpZygpO1xuICAgIHRoaXMuYmliX3NvcnRfa2V5cyA9IFtdO1xuICAgIHRoaXMucHJlZml4ID0gbmV3IENTTC5TdGFjayhcIlwiLCBDU0wuTElURVJBTCk7XG4gICAgdGhpcy5zdWZmaXggPSBuZXcgQ1NMLlN0YWNrKFwiXCIsIENTTC5MSVRFUkFMKTtcbiAgICB0aGlzLmRlbGltaXRlciA9IG5ldyBDU0wuU3RhY2soXCJcIiwgQ1NMLkxJVEVSQUwpO1xuICAgIHRoaXMuY2l0ZV9sb2NhbGVzID0gW107XG4gICAgdGhpcy5jaXRlX2FmZml4ZXMgPSB7XG4gICAgICAgIGNpdGF0aW9uOiBmYWxzZSwgXG4gICAgICAgIGJpYmxpb2dyYXBoeTogZmFsc2UsXG4gICAgICAgIGNpdGF0aW9uX3NvcnQ6IGZhbHNlLCBcbiAgICAgICAgYmlibGlvZ3JhcGh5X3NvcnQ6IGZhbHNlXG4gICAgfTtcbiAgICB0aGlzLnN0cmlwX3BlcmlvZHMgPSAwO1xuICAgIHRoaXMuc2hhZG93X251bWJlcnMgPSB7fTtcbiAgICB0aGlzLmF1dGhvcml0eV9zdG9wX2xhc3QgPSAwO1xuICAgIHRoaXMubG9hZGVkSXRlbUlEcyA9IHt9O1xufTtcbkNTTC5FbmdpbmUuRnVuID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdGhpcy5tYXRjaCA9IG5ldyBDU0wuVXRpbC5NYXRjaDtcbiAgICB0aGlzLnN1ZmZpeGF0b3IgPSBuZXcgQ1NMLlV0aWwuU3VmZml4YXRvcihDU0wuU1VGRklYX0NIQVJTKTtcbiAgICB0aGlzLnJvbWFuaXplciA9IG5ldyBDU0wuVXRpbC5Sb21hbml6ZXIoKTtcbiAgICB0aGlzLm9yZGluYWxpemVyID0gbmV3IENTTC5VdGlsLk9yZGluYWxpemVyKHN0YXRlKTtcbiAgICB0aGlzLmxvbmdfb3JkaW5hbGl6ZXIgPSBuZXcgQ1NMLlV0aWwuTG9uZ09yZGluYWxpemVyKCk7XG59O1xuQ1NMLkVuZ2luZS5CdWlsZCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzW1wiYWx0ZXJuYXRlLXRlcm1cIl0gPSBmYWxzZTtcbiAgICB0aGlzLmluX2JpYmxpb2dyYXBoeSA9IGZhbHNlO1xuICAgIHRoaXMuaW5fc3R5bGUgPSBmYWxzZTtcbiAgICB0aGlzLnNraXAgPSBmYWxzZTtcbiAgICB0aGlzLnBvc3Rwb25lZF9tYWNybyA9IGZhbHNlO1xuICAgIHRoaXMubGF5b3V0X2ZsYWcgPSBmYWxzZTtcbiAgICB0aGlzLm5hbWUgPSBmYWxzZTtcbiAgICB0aGlzLmZvcm0gPSBmYWxzZTtcbiAgICB0aGlzLnRlcm0gPSBmYWxzZTtcbiAgICB0aGlzLm1hY3JvID0ge307XG4gICAgdGhpcy5tYWNyb19zdGFjayA9IFtdO1xuICAgIHRoaXMudGV4dCA9IGZhbHNlO1xuICAgIHRoaXMubGFuZyA9IGZhbHNlO1xuICAgIHRoaXMuYXJlYSA9IFwiY2l0YXRpb25cIjtcbiAgICB0aGlzLnJvb3QgPSBcImNpdGF0aW9uXCI7XG4gICAgdGhpcy5leHRlbnNpb24gPSBcIlwiO1xuICAgIHRoaXMuc3Vic3RpdHV0ZV9sZXZlbCA9IG5ldyBDU0wuU3RhY2soMCwgQ1NMLkxJVEVSQUwpO1xuICAgIHRoaXMubmFtZXNfbGV2ZWwgPSAwO1xuICAgIHRoaXMucmVuZGVyX25lc3RpbmdfbGV2ZWwgPSAwO1xuICAgIHRoaXMucmVuZGVyX3NlZW4gPSBmYWxzZTtcbn07XG5DU0wuRW5naW5lLkNvbmZpZ3VyZSA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmZhaWwgPSBbXTtcbiAgICB0aGlzLnN1Y2NlZWQgPSBbXTtcbn07XG5DU0wuRW5naW5lLkNpdGF0aW9uID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdGhpcy5vcHQgPSB7XG4gICAgICAgIGluaGVyaXRlZEF0dHJpYnV0ZXM6IHt9XG4gICAgfTtcbiAgICB0aGlzLnRva2VucyA9IFtdO1xuICAgIHRoaXMuc3J0ID0gbmV3IENTTC5SZWdpc3RyeS5Db21wYXJpZmllcihzdGF0ZSwgXCJjaXRhdGlvbl9zb3J0XCIpO1xuICAgIHRoaXMub3B0LmNvbGxhcHNlID0gW107XG4gICAgdGhpcy5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLW5hbWVzXCJdID0gZmFsc2U7XG4gICAgdGhpcy5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLWdpdmVubmFtZVwiXSA9IGZhbHNlO1xuICAgIHRoaXMub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC15ZWFyLXN1ZmZpeFwiXSA9IGZhbHNlO1xuICAgIHRoaXMub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl0gPSBcImJ5LWNpdGVcIjtcbiAgICB0aGlzLm9wdFtcIm5lYXItbm90ZS1kaXN0YW5jZVwiXSA9IDU7XG4gICAgdGhpcy5vcHQudG9wZGVjb3IgPSBbXTtcbiAgICB0aGlzLm9wdC5sYXlvdXRfZGVjb3JhdGlvbnMgPSBbXTtcbiAgICB0aGlzLm9wdC5sYXlvdXRfcHJlZml4ID0gXCJcIjtcbiAgICB0aGlzLm9wdC5sYXlvdXRfc3VmZml4ID0gXCJcIjtcbiAgICB0aGlzLm9wdC5sYXlvdXRfZGVsaW1pdGVyID0gXCJcIjtcbiAgICB0aGlzLm9wdC5zb3J0X2xvY2FsZXMgPSBbXTtcbiAgICB0aGlzLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzID0gMDtcbiAgICB0aGlzLnJvb3QgPSBcImNpdGF0aW9uXCI7XG59O1xuQ1NMLkVuZ2luZS5CaWJsaW9ncmFwaHkgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5vcHQgPSB7XG4gICAgICAgIGluaGVyaXRlZEF0dHJpYnV0ZXM6IHt9XG4gICAgfTtcbiAgICB0aGlzLnRva2VucyA9IFtdO1xuICAgIHRoaXMub3B0LmNvbGxhcHNlID0gW107XG4gICAgdGhpcy5vcHQudG9wZGVjb3IgPSBbXTtcbiAgICB0aGlzLm9wdC5sYXlvdXRfZGVjb3JhdGlvbnMgPSBbXTtcbiAgICB0aGlzLm9wdC5sYXlvdXRfcHJlZml4ID0gXCJcIjtcbiAgICB0aGlzLm9wdC5sYXlvdXRfc3VmZml4ID0gXCJcIjtcbiAgICB0aGlzLm9wdC5sYXlvdXRfZGVsaW1pdGVyID0gXCJcIjtcbiAgICB0aGlzLm9wdFtcImxpbmUtc3BhY2luZ1wiXSA9IDE7XG4gICAgdGhpcy5vcHRbXCJlbnRyeS1zcGFjaW5nXCJdID0gMTtcbiAgICB0aGlzLm9wdC5zb3J0X2xvY2FsZXMgPSBbXTtcbiAgICB0aGlzLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzID0gMDtcbiAgICB0aGlzLnJvb3QgPSBcImJpYmxpb2dyYXBoeVwiO1xufTtcbkNTTC5FbmdpbmUuQmlibGlvZ3JhcGh5U29ydCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnRva2VucyA9IFtdO1xuICAgIHRoaXMub3B0ID0ge307XG4gICAgdGhpcy5vcHQuc29ydF9kaXJlY3Rpb25zID0gW107XG4gICAgdGhpcy5rZXlzID0gW107XG4gICAgdGhpcy5vcHQudG9wZGVjb3IgPSBbXTtcbiAgICB0aGlzLnJvb3QgPSBcImJpYmxpb2dyYXBoeVwiO1xufTtcbkNTTC5FbmdpbmUuQ2l0YXRpb25Tb3J0ID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMudG9rZW5zID0gW107XG4gICAgdGhpcy5vcHQgPSB7fTtcbiAgICB0aGlzLm9wdC5zb3J0X2RpcmVjdGlvbnMgPSBbXTtcbiAgICB0aGlzLmtleXMgPSBbXTtcbiAgICB0aGlzLm9wdC50b3BkZWNvciA9IFtdO1xuICAgIHRoaXMucm9vdCA9IFwiY2l0YXRpb25cIjtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnByZXZpZXdDaXRhdGlvbkNsdXN0ZXIgPSBmdW5jdGlvbiAoY2l0YXRpb24sIGNpdGF0aW9uc1ByZSwgY2l0YXRpb25zUG9zdCwgbmV3TW9kZSkge1xuICAgIHZhciBvbGRNb2RlID0gdGhpcy5vcHQubW9kZTtcbiAgICB0aGlzLnNldE91dHB1dEZvcm1hdChuZXdNb2RlKTtcbiAgICB2YXIgcmV0ID0gdGhpcy5wcm9jZXNzQ2l0YXRpb25DbHVzdGVyKGNpdGF0aW9uLCBjaXRhdGlvbnNQcmUsIGNpdGF0aW9uc1Bvc3QsIENTTC5QUkVWSUVXKTtcbiAgICB0aGlzLnNldE91dHB1dEZvcm1hdChvbGRNb2RlKTtcbiAgICByZXR1cm4gcmV0WzFdO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmFwcGVuZENpdGF0aW9uQ2x1c3RlciA9IGZ1bmN0aW9uIChjaXRhdGlvbikge1xuICAgIHZhciBjaXRhdGlvbnNQcmUgPSBbXTtcbiAgICB2YXIgbGVuID0gdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SW5kZXgubGVuZ3RoO1xuICAgIGZvciAodmFyIHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgdmFyIGMgPSB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJbmRleFtwb3NdO1xuICAgICAgICBjaXRhdGlvbnNQcmUucHVzaChbXCJcIiArIGMuY2l0YXRpb25JRCwgYy5wcm9wZXJ0aWVzLm5vdGVJbmRleF0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzQ2l0YXRpb25DbHVzdGVyKGNpdGF0aW9uLCBjaXRhdGlvbnNQcmUsIFtdKVsxXTtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5wcm9jZXNzQ2l0YXRpb25DbHVzdGVyID0gZnVuY3Rpb24gKGNpdGF0aW9uLCBjaXRhdGlvbnNQcmUsIGNpdGF0aW9uc1Bvc3QsIGZsYWcpIHtcbiAgICB2YXIgYywgaSwgaWxlbiwgaiwgamxlbiwgaywga2xlbiwgbiwgbmxlbiwga2V5LCBJdGVtLCBpdGVtLCBub3RlQ2l0YXRpb25zLCB0ZXh0Q2l0YXRpb25zLCBtLCBjaXRhdGlvbnNJbk5vdGU7XG4gICAgdGhpcy5kZWJ1ZyA9IGZhbHNlO1xuICAgIHRoaXMudG1wLmxvYWRlZEl0ZW1JRHMgPSB7fTtcbiAgICB0aGlzLnRtcC5jaXRhdGlvbl9lcnJvcnMgPSBbXTtcbiAgICB2YXIgcmV0dXJuX2RhdGEgPSB7XCJiaWJjaGFuZ2VcIjogZmFsc2V9O1xuICAgIHRoaXMuc2V0Q2l0YXRpb25JZChjaXRhdGlvbik7XG4gICAgdmFyIG9sZENpdGF0aW9uTGlzdDtcbiAgICB2YXIgb2xkSXRlbUxpc3Q7XG4gICAgdmFyIG9sZEFtYmlncztcbiAgICBpZiAoZmxhZyA9PT0gQ1NMLlBSRVZJRVcpIHtcbiAgICAgICAgb2xkQ2l0YXRpb25MaXN0ID0gdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SW5kZXguc2xpY2UoKTtcbiAgICAgICAgb2xkSXRlbUxpc3QgPSB0aGlzLnJlZ2lzdHJ5LnJlZmxpc3Quc2xpY2UoKTtcbiAgICAgICAgdmFyIG5ld0NpdGF0aW9uTGlzdCA9IGNpdGF0aW9uc1ByZS5jb25jYXQoW1tcIlwiICsgY2l0YXRpb24uY2l0YXRpb25JRCwgY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXhdXSkuY29uY2F0KGNpdGF0aW9uc1Bvc3QpO1xuICAgICAgICB2YXIgbmV3SXRlbUlkcyA9IHt9O1xuICAgICAgICB2YXIgbmV3SXRlbUlkc0xpc3QgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBuZXdDaXRhdGlvbkxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBjID0gdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SWRbbmV3Q2l0YXRpb25MaXN0W2ldWzBdXTtcbiAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBjLmNpdGF0aW9uSXRlbXMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgbmV3SXRlbUlkc1tjLmNpdGF0aW9uSXRlbXNbal0uaWRdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBuZXdJdGVtSWRzTGlzdC5wdXNoKFwiXCIgKyBjLmNpdGF0aW9uSXRlbXNbal0uaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG9sZEFtYmlncyA9IHt9O1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG9sZEl0ZW1MaXN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgaWYgKCFuZXdJdGVtSWRzW29sZEl0ZW1MaXN0W2ldLmlkXSkge1xuICAgICAgICAgICAgICAgIHZhciBvbGRBa2V5ID0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtvbGRJdGVtTGlzdFtpXS5pZF0uYW1iaWc7XG4gICAgICAgICAgICAgICAgdmFyIGlkcyA9IHRoaXMucmVnaXN0cnkuYW1iaWdjaXRlc1tvbGRBa2V5XTtcbiAgICAgICAgICAgICAgICBpZiAoaWRzKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBpZHMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvbGRBbWJpZ3NbaWRzW2pdXSA9IENTTC5jbG9uZUFtYmlnQ29uZmlnKHRoaXMucmVnaXN0cnkucmVnaXN0cnlbaWRzW2pdXS5kaXNhbWJpZyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy50bXAudGFpbnRlZENpdGF0aW9uSURzID0ge307XG4gICAgdmFyIHNvcnRlZEl0ZW1zID0gW107XG4gICAgdmFyIHJlcnVuQWtleXMgPSB7fTtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGNpdGF0aW9uLmNpdGF0aW9uSXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGl0ZW0gPSB7fTtcbiAgICAgICAgZm9yICh2YXIga2V5IGluIGNpdGF0aW9uLmNpdGF0aW9uSXRlbXNbaV0pIHtcbiAgICAgICAgICAgIGl0ZW1ba2V5XSA9IGNpdGF0aW9uLmNpdGF0aW9uSXRlbXNbaV1ba2V5XTtcbiAgICAgICAgfVxuICAgICAgICBJdGVtID0gdGhpcy5yZXRyaWV2ZUl0ZW0oXCJcIiArIGl0ZW0uaWQpO1xuICAgICAgICBpZiAoSXRlbS5pZCkge1xuICAgICAgICAgICAgdGhpcy50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbihcImRlZmF1bHRcIiwgXCJoZXJlaW5hZnRlclwiLCBJdGVtLmlkKTtcbiAgICAgICAgfVxuICAgICAgICBpdGVtID0gQ1NMLnBhcnNlTG9jYXRvci5jYWxsKHRoaXMsIGl0ZW0pO1xuICAgICAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5zdGF0aWNfc3RhdHV0ZV9sb2NhdG9yKSB7XG4gICAgICAgICAgICB0aGlzLnJlbWFwU2VjdGlvblZhcmlhYmxlKFtbSXRlbSxpdGVtXV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmxvY2F0b3JfbGFiZWxfcGFyc2UpIHtcbiAgICAgICAgICAgIGlmIChpdGVtLmxvY2F0b3IgJiYgW1wiYmlsbFwiLFwiZ2F6ZXR0ZVwiLFwibGVnaXNsYXRpb25cIixcInJlZ3VsYXRpb25cIixcInRyZWF0eVwiXS5pbmRleE9mKEl0ZW0udHlwZSkgPT09IC0xICYmICghaXRlbS5sYWJlbCB8fCBpdGVtLmxhYmVsID09PSAncGFnZScpKSB7XG4gICAgICAgICAgICAgICAgdmFyIG0gPSBDU0wuTE9DQVRPUl9MQUJFTFNfUkVHRVhQLmV4ZWMoaXRlbS5sb2NhdG9yKTtcbiAgICAgICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdHJ5TGFiZWwgPSBDU0wuTE9DQVRPUl9MQUJFTFNfTUFQW21bMl1dO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRUZXJtKHRyeUxhYmVsKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5sYWJlbCA9IHRyeUxhYmVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gbVszXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgbmV3aXRlbSA9IFtJdGVtLCBpdGVtXTtcbiAgICAgICAgc29ydGVkSXRlbXMucHVzaChuZXdpdGVtKTtcbiAgICAgICAgY2l0YXRpb24uY2l0YXRpb25JdGVtc1tpXS5pdGVtID0gSXRlbTtcbiAgICB9XG4gICAgY2l0YXRpb24uc29ydGVkSXRlbXMgPSBzb3J0ZWRJdGVtcztcbiAgICB2YXIgY2l0YXRpb25CeUluZGV4ID0gW107XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBjaXRhdGlvbnNQcmUubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGMgPSBjaXRhdGlvbnNQcmVbaV07XG4gICAgICAgIHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25CeUlkW2NbMF1dLnByb3BlcnRpZXMubm90ZUluZGV4ID0gY1sxXTtcbiAgICAgICAgY2l0YXRpb25CeUluZGV4LnB1c2godGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SWRbY1swXV0pO1xuICAgIH1cbiAgICBjaXRhdGlvbkJ5SW5kZXgucHVzaChjaXRhdGlvbik7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBjaXRhdGlvbnNQb3N0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBjID0gY2l0YXRpb25zUG9zdFtpXTtcbiAgICAgICAgdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SWRbY1swXV0ucHJvcGVydGllcy5ub3RlSW5kZXggPSBjWzFdO1xuICAgICAgICBjaXRhdGlvbkJ5SW5kZXgucHVzaCh0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJZFtjWzBdXSk7XG4gICAgfVxuICAgIHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25CeUluZGV4ID0gY2l0YXRpb25CeUluZGV4O1xuICAgIHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWQgPSB7fTtcbiAgICBpZiAodGhpcy5vcHQudXBkYXRlX21vZGUgPT09IENTTC5QT1NJVElPTikge1xuICAgICAgICB0ZXh0Q2l0YXRpb25zID0gW107XG4gICAgICAgIG5vdGVDaXRhdGlvbnMgPSBbXTtcbiAgICAgICAgY2l0YXRpb25zSW5Ob3RlID0ge307XG4gICAgfVxuICAgIHZhciB1cGRhdGVfaXRlbXMgPSBbXTtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGNpdGF0aW9uQnlJbmRleC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgY2l0YXRpb25CeUluZGV4W2ldLnByb3BlcnRpZXMuaW5kZXggPSBpO1xuICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gY2l0YXRpb25CeUluZGV4W2ldLnNvcnRlZEl0ZW1zLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgaXRlbSA9IGNpdGF0aW9uQnlJbmRleFtpXS5zb3J0ZWRJdGVtc1tqXTtcbiAgICAgICAgICAgIGlmICghdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtpdGVtWzFdLmlkXSkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbaXRlbVsxXS5pZF0gPSBbXTtcbiAgICAgICAgICAgICAgICB1cGRhdGVfaXRlbXMucHVzaChcIlwiICsgaXRlbVsxXS5pZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtpdGVtWzFdLmlkXS5pbmRleE9mKGNpdGF0aW9uQnlJbmRleFtpXSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtpdGVtWzFdLmlkXS5wdXNoKGNpdGF0aW9uQnlJbmRleFtpXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMub3B0LnVwZGF0ZV9tb2RlID09PSBDU0wuUE9TSVRJT04pIHtcbiAgICAgICAgICAgIGlmIChjaXRhdGlvbkJ5SW5kZXhbaV0ucHJvcGVydGllcy5ub3RlSW5kZXgpIHtcbiAgICAgICAgICAgICAgICBub3RlQ2l0YXRpb25zLnB1c2goY2l0YXRpb25CeUluZGV4W2ldKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2l0YXRpb25CeUluZGV4W2ldLnByb3BlcnRpZXMubm90ZUluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICB0ZXh0Q2l0YXRpb25zLnB1c2goY2l0YXRpb25CeUluZGV4W2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoZmxhZyAhPT0gQ1NMLkFTU1VNRV9BTExfSVRFTVNfUkVHSVNURVJFRCkge1xuICAgICAgICB0aGlzLnVwZGF0ZUl0ZW1zKHVwZGF0ZV9pdGVtcywgbnVsbCwgbnVsbCwgdHJ1ZSk7XG4gICAgfVxuICAgIGlmICghdGhpcy5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnQgJiYgc29ydGVkSXRlbXMgJiYgc29ydGVkSXRlbXMubGVuZ3RoID4gMSAmJiB0aGlzLmNpdGF0aW9uX3NvcnQudG9rZW5zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBzb3J0ZWRJdGVtcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHNvcnRlZEl0ZW1zW2ldWzFdLnNvcnRrZXlzID0gQ1NMLmdldFNvcnRLZXlzLmNhbGwodGhpcywgc29ydGVkSXRlbXNbaV1bMF0sIFwiY2l0YXRpb25fc29ydFwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5vcHQuZ3JvdXBlZF9zb3J0ICYmICAhY2l0YXRpb24ucHJvcGVydGllcy51bnNvcnRlZCkge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBzb3J0ZWRJdGVtcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICB2YXIgc29ydGtleXMgPSBzb3J0ZWRJdGVtc1tpXVsxXS5zb3J0a2V5cztcbiAgICAgICAgICAgICAgICB0aGlzLnRtcC5hdXRob3JzdHJpbmdfcmVxdWVzdCA9IHRydWU7XG4gICAgICAgICAgICAgICAgdmFyIG15ZGlzYW1iaWcgPSB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W3NvcnRlZEl0ZW1zW2ldWzBdLmlkXS5kaXNhbWJpZztcbiAgICAgICAgICAgICAgICB0aGlzLnRtcC5hdXRob3JzdHJpbmdfcmVxdWVzdCA9IHRydWU7XG4gICAgICAgICAgICAgICAgQ1NMLmdldEFtYmlndW91c0NpdGUuY2FsbCh0aGlzLCBzb3J0ZWRJdGVtc1tpXVswXSwgbXlkaXNhbWJpZyk7XG4gICAgICAgICAgICAgICAgdmFyIGF1dGhvcnN0cmluZyA9IHRoaXMucmVnaXN0cnkuYXV0aG9yc3RyaW5nc1tzb3J0ZWRJdGVtc1tpXVswXS5pZF07XG4gICAgICAgICAgICAgICAgdGhpcy50bXAuYXV0aG9yc3RyaW5nX3JlcXVlc3QgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBzb3J0ZWRJdGVtc1tpXVsxXS5zb3J0a2V5cyA9IFthdXRob3JzdHJpbmddLmNvbmNhdChzb3J0a2V5cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzb3J0ZWRJdGVtcy5zb3J0KHRoaXMuY2l0YXRpb24uc3J0LmNvbXBhcmVDb21wb3NpdGVLZXlzKTtcbiAgICAgICAgICAgIHZhciBsYXN0YXV0aG9yID0gZmFsc2U7XG4gICAgICAgICAgICB2YXIgdGhpc2tleSA9IGZhbHNlO1xuICAgICAgICAgICAgdmFyIHRoaXNhdXRob3IgPSBmYWxzZTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gc29ydGVkSXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNvcnRlZEl0ZW1zW2ldWzFdLnNvcnRrZXlzWzBdICE9PSBsYXN0YXV0aG9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXNhdXRob3IgPSBzb3J0ZWRJdGVtc1tpXVsxXS5zb3J0a2V5c1swXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpc2tleSA9ICBzb3J0ZWRJdGVtc1tpXVsxXS5zb3J0a2V5c1sxXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc29ydGVkSXRlbXNbaV1bMV0uc29ydGtleXNbMF0gPSBcIlwiICsgdGhpc2tleSArIGk7XG4gICAgICAgICAgICAgICAgbGFzdGF1dGhvciA9IHRoaXNhdXRob3I7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjaXRhdGlvbi5wcm9wZXJ0aWVzLnVuc29ydGVkKSB7XG4gICAgICAgICAgICBzb3J0ZWRJdGVtcy5zb3J0KHRoaXMuY2l0YXRpb24uc3J0LmNvbXBhcmVDb21wb3NpdGVLZXlzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgY2l0YXRpb25zO1xuICAgIGlmICh0aGlzLm9wdC51cGRhdGVfbW9kZSA9PT0gQ1NMLlBPU0lUSU9OKSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMjsgaSArPSAxKSB7XG4gICAgICAgICAgICBjaXRhdGlvbnMgPSBbdGV4dENpdGF0aW9ucywgbm90ZUNpdGF0aW9uc11baV07XG4gICAgICAgICAgICB2YXIgZmlyc3RfcmVmID0ge307XG4gICAgICAgICAgICB2YXIgbGFzdF9yZWYgPSB7fTtcbiAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBjaXRhdGlvbnMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgdmFyIG9uZWNpdGF0aW9uID0gY2l0YXRpb25zW2pdO1xuICAgICAgICAgICAgICAgIGlmICghY2l0YXRpb25zW2pdLnByb3BlcnRpZXMubm90ZUluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIGNpdGF0aW9uc1tqXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCA9IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNpdGF0aW9uc1tqXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCA9IHBhcnNlSW50KGNpdGF0aW9uc1tqXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCwgMTApO1xuICAgICAgICAgICAgICAgIGlmIChqID4gMCAmJiBjaXRhdGlvbnNbaiAtIDFdLnByb3BlcnRpZXMubm90ZUluZGV4ID4gY2l0YXRpb25zW2pdLnByb3BlcnRpZXMubm90ZUluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIGNpdGF0aW9uc0luTm90ZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICBmaXJzdF9yZWYgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgbGFzdF9yZWYgPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yIChrID0gMCwga2xlbiA9IG9uZWNpdGF0aW9uLnNvcnRlZEl0ZW1zLmxlbmd0aDsgayA8IGtsZW47IGsgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMucmVnaXN0cnkucmVnaXN0cnlbb25lY2l0YXRpb24uc29ydGVkSXRlbXNba11bMV0uaWRdLnBhcmFsbGVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNpdGF0aW9uc0luTm90ZVtvbmVjaXRhdGlvbi5wcm9wZXJ0aWVzLm5vdGVJbmRleF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaXRhdGlvbnNJbk5vdGVbb25lY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXhdID0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2l0YXRpb25zSW5Ob3RlW29uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4XSArPSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAoayA9IDAsIGtsZW4gPSBjaXRhdGlvbnNbal0uc29ydGVkSXRlbXMubGVuZ3RoOyBrIDwga2xlbjsgayArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0gPSBjaXRhdGlvbnNbal0uc29ydGVkSXRlbXNba107XG4gICAgICAgICAgICAgICAgICAgIHZhciBteWlkID0gaXRlbVswXS5pZDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG15bG9jYXRvciA9IGl0ZW1bMV0ubG9jYXRvcjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG15bGFiZWwgPSBpdGVtWzFdLmxhYmVsO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbVswXS5sZWdpc2xhdGlvbl9pZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbXlpZCA9IGl0ZW1bMF0ubGVnaXNsYXRpb25faWQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGluY2l0YXRpb25pZDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGsgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob25lY2l0YXRpb24uc29ydGVkSXRlbXNbayAtIDFdWzBdLmxlZ2lzbGF0aW9uX2lkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jaXRhdGlvbmlkID0gb25lY2l0YXRpb24uc29ydGVkSXRlbXNbayAtIDFdWzBdLmxlZ2lzbGF0aW9uX2lkO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNpdGF0aW9uaWQgPSBvbmVjaXRhdGlvbi5zb3J0ZWRJdGVtc1trIC0gMV1bMV0uaWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWcgPT09IENTTC5QUkVWSUVXKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob25lY2l0YXRpb24uY2l0YXRpb25JRCAhPSBjaXRhdGlvbi5jaXRhdGlvbklEKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBmaXJzdF9yZWZbaXRlbVsxXS5pZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RfcmVmW215aWRdID0gb25lY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfcmVmW215aWRdID0gb25lY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9yZWZbbXlpZF0gPSBvbmVjaXRhdGlvbi5wcm9wZXJ0aWVzLm5vdGVJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZHZhbHVlID0ge307XG4gICAgICAgICAgICAgICAgICAgIG9sZHZhbHVlLnBvc2l0aW9uID0gaXRlbVsxXS5wb3NpdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgb2xkdmFsdWVbXCJmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXJcIl0gPSBpdGVtWzFdW1wiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCJdO1xuICAgICAgICAgICAgICAgICAgICBvbGR2YWx1ZVtcIm5lYXItbm90ZVwiXSA9IGl0ZW1bMV1bXCJuZWFyLW5vdGVcIl07XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1bMV1bXCJmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXJcIl0gPSAwO1xuICAgICAgICAgICAgICAgICAgICBpdGVtWzFdW1wibmVhci1ub3RlXCJdID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW215aWRdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHQueGNsYXNzID09PSAnbm90ZScgJiYgdGhpcy5vcHQuaGFzX2Rpc2FtYmlndWF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvbGRDb3VudCA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbbXlpZF1bXCJjaXRhdGlvbi1jb3VudFwiXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdDb3VudCA9IHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbbXlpZF0ubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cnkucmVnaXN0cnlbbXlpZF1bXCJjaXRhdGlvbi1jb3VudFwiXSA9IHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbbXlpZF0ubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcIm51bWJlclwiID09PSB0eXBlb2Ygb2xkQ291bnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZENvdW50Q2hlY2sgPSAob2xkQ291bnQgPCAyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0NvdW50Q2hlY2sgPSAobmV3Q291bnQgPCAyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZENvdW50Q2hlY2sgIT09IG5ld0NvdW50Q2hlY2spIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGw9MCxsbGVuPXRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbbXlpZF0ubGVuZ3RoO2w8bGxlbjtsKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXJ1bkFrZXlzW3RoaXMucmVnaXN0cnkucmVnaXN0cnlbbXlpZF0uYW1iaWddID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRtcC50YWludGVkQ2l0YXRpb25JRHNbdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtteWlkXVtsXS5jaXRhdGlvbklEXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBsPTAsbGxlbj10aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW215aWRdLmxlbmd0aDtsPGxsZW47bCsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXJ1bkFrZXlzW3RoaXMucmVnaXN0cnkucmVnaXN0cnlbbXlpZF0uYW1iaWddID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG1wLnRhaW50ZWRDaXRhdGlvbklEc1t0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW215aWRdW2xdLmNpdGF0aW9uSURdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIgb2xkbGFzdGlkO1xuICAgICAgICAgICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGZpcnN0X3JlZltteWlkXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RfcmVmW215aWRdID0gb25lY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtteWlkXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cnkucmVnaXN0cnlbbXlpZF1bJ2ZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlciddID0gb25lY2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0X3JlZltteWlkXSA9IG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVsxXS5wb3NpdGlvbiA9IENTTC5QT1NJVElPTl9GSVJTVDtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpYmlkbWUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdXByYW1lID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRsYXN0aWQgPSAgY2l0YXRpb25zW2ogLSAxXS5zb3J0ZWRJdGVtcy5zbGljZSgtMSlbMF1bMV0uaWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNpdGF0aW9uc1tqIC0gMV0uc29ydGVkSXRlbXNbMF0uc2xpY2UoLTEpWzBdLmxlZ2lzbGF0aW9uX2lkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZGxhc3RpZCA9IGNpdGF0aW9uc1tqIC0gMV0uc29ydGVkSXRlbXNbMF0uc2xpY2UoLTEpWzBdLmxlZ2lzbGF0aW9uX2lkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID4gMCAmJiBwYXJzZUludChrLCAxMCkgPT09IDAgJiYgY2l0YXRpb25zW2ogLSAxXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCAhPT0gY2l0YXRpb25zW2pdLnByb3BlcnRpZXMubm90ZUluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1zID0gY2l0YXRpb25zWyhqIC0gMSldLnNvcnRlZEl0ZW1zO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1c2VtZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvbGRpZCA9IGNpdGF0aW9uc1tqIC0gMV0uc29ydGVkSXRlbXNbMF1bMF0uaWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNpdGF0aW9uc1tqIC0gMV0uc29ydGVkSXRlbXNbMF1bMF0ubGVnaXNsYXRpb25faWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkaWQgPSBjaXRhdGlvbnNbaiAtIDFdLnNvcnRlZEl0ZW1zWzBdWzBdLmxlZ2lzbGF0aW9uX2lkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9sZGlkICA9PSBteWlkICYmIGNpdGF0aW9uc1tqIC0gMV0ucHJvcGVydGllcy5ub3RlSW5kZXggPj0gKGNpdGF0aW9uc1tqXS5wcm9wZXJ0aWVzLm5vdGVJbmRleCAtIDEpKSB8fCBjaXRhdGlvbnNbaiAtIDFdLnNvcnRlZEl0ZW1zWzBdWzFdLmlkID09IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbaXRlbVsxXS5pZF0ucGFyYWxsZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNpdGF0aW9uc0luTm90ZVtjaXRhdGlvbnNbaiAtIDFdLnByb3BlcnRpZXMubm90ZUluZGV4XSA9PT0gMSB8fCBjaXRhdGlvbnNbaiAtIDFdLnByb3BlcnRpZXMubm90ZUluZGV4ID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VtZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChuID0gMCwgbmxlbiA9IGl0ZW1zLnNsaWNlKDEpLmxlbmd0aDsgbiA8IG5sZW47IG4gKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRtcCA9IGl0ZW1zLnNsaWNlKDEpW25dO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMucmVnaXN0cnkucmVnaXN0cnlbaXRtcFsxXS5pZF0ucGFyYWxsZWwgfHwgdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtpdG1wWzFdLmlkXS5wYXJhbGxlbCA9PSB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2l0bXBbMV0uaWRdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VtZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1c2VtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpYmlkbWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1cHJhbWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoayA+IDAgJiYgaW5jaXRhdGlvbmlkID09IG15aWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpYmlkbWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrID09PSAwICYmIGNpdGF0aW9uc1tqIC0gMV0ucHJvcGVydGllcy5ub3RlSW5kZXggPT0gY2l0YXRpb25zW2pdLnByb3BlcnRpZXMubm90ZUluZGV4XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGNpdGF0aW9uc1tqIC0gMV0uc29ydGVkSXRlbXMubGVuZ3RoIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBvbGRsYXN0aWQgPT0gbXlpZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGliaWRtZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1cHJhbWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXYsIHByZXZfbG9jYXRvciwgcHJldl9sYWJlbCwgY3Vycl9sb2NhdG9yLCBjdXJyX2xhYmVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGliaWRtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2ID0gb25lY2l0YXRpb24uc29ydGVkSXRlbXNbKGsgLSAxKV1bMV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldiA9IGNpdGF0aW9uc1soaiAtIDEpXS5zb3J0ZWRJdGVtc1swXVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXYubG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldi5sYWJlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldl9sYWJlbCA9IHByZXYubGFiZWw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2X2xhYmVsID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2X2xvY2F0b3IgPSBcIlwiICsgcHJldi5sb2NhdG9yICsgcHJldl9sYWJlbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2X2xvY2F0b3IgPSBwcmV2LmxvY2F0b3I7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChteWxvY2F0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG15bGFiZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJfbGFiZWwgPSBteWxhYmVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vycl9sYWJlbCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vycl9sb2NhdG9yID0gXCJcIiArIG15bG9jYXRvciArIGN1cnJfbGFiZWw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vycl9sb2NhdG9yID0gbXlsb2NhdG9yO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpYmlkbWUgJiYgcHJldl9sb2NhdG9yICYmICFjdXJyX2xvY2F0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpYmlkbWUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdXByYW1lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpYmlkbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXByZXZfbG9jYXRvciAmJiBjdXJyX2xvY2F0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVsxXS5wb3NpdGlvbiA9IENTTC5QT1NJVElPTl9JQklEX1dJVEhfTE9DQVRPUjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFwcmV2X2xvY2F0b3IgJiYgIWN1cnJfbG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtWzFdLnBvc2l0aW9uID0gQ1NMLlBPU0lUSU9OX0lCSUQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcmV2X2xvY2F0b3IgJiYgY3Vycl9sb2NhdG9yID09PSBwcmV2X2xvY2F0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVsxXS5wb3NpdGlvbiA9IENTTC5QT1NJVElPTl9JQklEO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJldl9sb2NhdG9yICYmIGN1cnJfbG9jYXRvciAmJiBjdXJyX2xvY2F0b3IgIT09IHByZXZfbG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtWzFdLnBvc2l0aW9uID0gQ1NMLlBPU0lUSU9OX0lCSURfV0lUSF9MT0NBVE9SO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGliaWRtZSA9IGZhbHNlOyAvLyBqdXN0IHRvIGJlIGNsZWFyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1cHJhbWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdXByYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVsxXS5wb3NpdGlvbiA9IENTTC5QT1NJVElPTl9TVUJTRVFVRU5UO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN1cHJhbWUgfHwgaWJpZG1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpcnN0X3JlZltteWlkXSAhPSBvbmVjaXRhdGlvbi5wcm9wZXJ0aWVzLm5vdGVJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtWzFdW1wiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCJdID0gZmlyc3RfcmVmW215aWRdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtteWlkXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZEZpcnN0ID0gdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtteWlkXVswXS5wcm9wZXJ0aWVzLm5vdGVJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdGaXJzdCA9IG9uZWNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtteWlkXVsnZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyJ10gPSBuZXdGaXJzdCA8IG9sZEZpcnN0ID8gbmV3Rmlyc3Q6IG9sZEZpcnN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChvbmVjaXRhdGlvbi5wcm9wZXJ0aWVzLm5vdGVJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vdGVfZGlzdGFuY2UgPSBwYXJzZUludChvbmVjaXRhdGlvbi5wcm9wZXJ0aWVzLm5vdGVJbmRleCwgMTApIC0gcGFyc2VJbnQobGFzdF9yZWZbbXlpZF0sIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtWzFdLnBvc2l0aW9uICE9PSBDU0wuUE9TSVRJT05fRklSU1QgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgbm90ZV9kaXN0YW5jZSA8PSB0aGlzLmNpdGF0aW9uLm9wdFtcIm5lYXItbm90ZS1kaXN0YW5jZVwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bMV1bXCJuZWFyLW5vdGVcIl0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9yZWZbbXlpZF0gPSBvbmVjaXRhdGlvbi5wcm9wZXJ0aWVzLm5vdGVJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAob25lY2l0YXRpb24uY2l0YXRpb25JRCAhPSBjaXRhdGlvbi5jaXRhdGlvbklEKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKG4gPSAwLCBubGVuID0gQ1NMLlBPU0lUSU9OX1RFU1RfVkFSUy5sZW5ndGg7IG4gPCBubGVuOyBuICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyYW0gPSBDU0wuUE9TSVRJT05fVEVTVF9WQVJTW25dO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtWzFdW3BhcmFtXSAhPT0gb2xkdmFsdWVbcGFyYW1dKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W215aWRdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW0gPT09ICdmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXInKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVydW5Ba2V5c1t0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W215aWRdLmFtYmlnXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50bXAudGFpbnRlZEl0ZW1JRHNbbXlpZF0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG1wLnRhaW50ZWRDaXRhdGlvbklEc1tvbmVjaXRhdGlvbi5jaXRhdGlvbklEXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN5cy52YXJpYWJsZVdyYXBwZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bMV0uaW5kZXggPSBvbmVjaXRhdGlvbi5wcm9wZXJ0aWVzLmluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVsxXS5ub3RlSW5kZXggPSBvbmVjaXRhdGlvbi5wcm9wZXJ0aWVzLm5vdGVJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnQgJiYgc29ydGVkSXRlbXMgJiYgc29ydGVkSXRlbXMubGVuZ3RoID4gMSAmJiB0aGlzLmNpdGF0aW9uX3NvcnQudG9rZW5zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgaWYgKCFjaXRhdGlvbi5wcm9wZXJ0aWVzLnVuc29ydGVkKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHNvcnRlZEl0ZW1zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIHNvcnRlZEl0ZW1zW2ldWzFdLnNvcnRrZXlzID0gQ1NMLmdldFNvcnRLZXlzLmNhbGwodGhpcywgc29ydGVkSXRlbXNbaV1bMF0sIFwiY2l0YXRpb25fc29ydFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNvcnRlZEl0ZW1zLnNvcnQodGhpcy5jaXRhdGlvbi5zcnQuY29tcGFyZUNvbXBvc2l0ZUtleXMpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnRtcC50YWludGVkSXRlbUlEcykge1xuICAgICAgICBpZiAodGhpcy50bXAudGFpbnRlZEl0ZW1JRHMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgY2l0YXRpb25zID0gdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtrZXldO1xuICAgICAgICAgICAgaWYgKGNpdGF0aW9ucykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gY2l0YXRpb25zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRtcC50YWludGVkQ2l0YXRpb25JRHNbY2l0YXRpb25zW2ldLmNpdGF0aW9uSURdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHJldCA9IFtdO1xuICAgIGlmIChmbGFnID09PSBDU0wuUFJFVklFVykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0ID0gdGhpcy5wcm9jZXNzX0NpdGF0aW9uQ2x1c3Rlci5jYWxsKHRoaXMsIGNpdGF0aW9uLnNvcnRlZEl0ZW1zLCBjaXRhdGlvbi5jaXRhdGlvbklEKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgQ1NMLmVycm9yKFwiRXJyb3IgcnVubmluZyBDU0wgcHJvY2Vzc29yIGZvciBwcmV2aWV3OiBcIitlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJbmRleCA9IG9sZENpdGF0aW9uTGlzdDtcbiAgICAgICAgdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SWQgPSB7fTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBvbGRDaXRhdGlvbkxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJZFtvbGRDaXRhdGlvbkxpc3RbaV0uY2l0YXRpb25JRF0gPSBvbGRDaXRhdGlvbkxpc3RbaV07XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG9sZEl0ZW1JZHMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBvbGRJdGVtTGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIG9sZEl0ZW1JZHMucHVzaChcIlwiICsgb2xkSXRlbUxpc3RbaV0uaWQpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudXBkYXRlSXRlbXMob2xkSXRlbUlkcywgbnVsbCwgbnVsbCwgdHJ1ZSk7XG4gICAgICAgIGZvciAodmFyIGtleSBpbiBvbGRBbWJpZ3MpIHtcbiAgICAgICAgICAgIGlmIChvbGRBbWJpZ3MuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cnkucmVnaXN0cnlba2V5XS5kaXNhbWJpZyA9IG9sZEFtYmlnc1trZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZm9yICh2YXIgcmVydW5Ba2V5IGluIHJlcnVuQWtleXMpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzYW1iaWd1YXRlLnJ1bihyZXJ1bkFrZXksIGNpdGF0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgb2JqO1xuICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy50bXAudGFpbnRlZENpdGF0aW9uSURzKSB7XG4gICAgICAgICAgICBpZiAoa2V5ID09IGNpdGF0aW9uLmNpdGF0aW9uSUQpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBteWNpdGF0aW9uID0gdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SWRba2V5XTtcbiAgICAgICAgICAgIGlmICghbXljaXRhdGlvbi5wcm9wZXJ0aWVzLnVuc29ydGVkKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBteWNpdGF0aW9uLnNvcnRlZEl0ZW1zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBteWNpdGF0aW9uLnNvcnRlZEl0ZW1zW2ldWzFdLnNvcnRrZXlzID0gQ1NMLmdldFNvcnRLZXlzLmNhbGwodGhpcywgbXljaXRhdGlvbi5zb3J0ZWRJdGVtc1tpXVswXSwgXCJjaXRhdGlvbl9zb3J0XCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBteWNpdGF0aW9uLnNvcnRlZEl0ZW1zLnNvcnQodGhpcy5jaXRhdGlvbi5zcnQuY29tcGFyZUNvbXBvc2l0ZUtleXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy50bXAuY2l0YXRpb25fcG9zID0gbXljaXRhdGlvbi5wcm9wZXJ0aWVzLmluZGV4O1xuICAgICAgICAgICAgdGhpcy50bXAuY2l0YXRpb25fbm90ZV9pbmRleCA9IG15Y2l0YXRpb24ucHJvcGVydGllcy5ub3RlSW5kZXg7XG4gICAgICAgICAgICB0aGlzLnRtcC5jaXRhdGlvbl9pZCA9IFwiXCIgKyBteWNpdGF0aW9uLmNpdGF0aW9uSUQ7XG4gICAgICAgICAgICBvYmogPSBbXTtcbiAgICAgICAgICAgIG9iai5wdXNoKG15Y2l0YXRpb24ucHJvcGVydGllcy5pbmRleCk7XG4gICAgICAgICAgICBvYmoucHVzaCh0aGlzLnByb2Nlc3NfQ2l0YXRpb25DbHVzdGVyLmNhbGwodGhpcywgbXljaXRhdGlvbi5zb3J0ZWRJdGVtcywgbXljaXRhdGlvbi5jaXRhdGlvbklEKSk7XG4gICAgICAgICAgICBvYmoucHVzaChteWNpdGF0aW9uLmNpdGF0aW9uSUQpO1xuICAgICAgICAgICAgcmV0LnB1c2gob2JqKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRtcC50YWludGVkSXRlbUlEcyA9IHt9O1xuICAgICAgICB0aGlzLnRtcC50YWludGVkQ2l0YXRpb25JRHMgPSB7fTtcbiAgICAgICAgdGhpcy50bXAuY2l0YXRpb25fcG9zID0gY2l0YXRpb24ucHJvcGVydGllcy5pbmRleDtcbiAgICAgICAgdGhpcy50bXAuY2l0YXRpb25fbm90ZV9pbmRleCA9IGNpdGF0aW9uLnByb3BlcnRpZXMubm90ZUluZGV4O1xuICAgICAgICB0aGlzLnRtcC5jaXRhdGlvbl9pZCA9IFwiXCIgKyBjaXRhdGlvbi5jaXRhdGlvbklEO1xuICAgICAgICBvYmogPSBbXTtcbiAgICAgICAgb2JqLnB1c2goY2l0YXRpb25zUHJlLmxlbmd0aCk7XG4gICAgICAgIG9iai5wdXNoKHRoaXMucHJvY2Vzc19DaXRhdGlvbkNsdXN0ZXIuY2FsbCh0aGlzLCBzb3J0ZWRJdGVtcywgY2l0YXRpb24uY2l0YXRpb25JRCkpO1xuICAgICAgICBvYmoucHVzaChjaXRhdGlvbi5jaXRhdGlvbklEKTtcbiAgICAgICAgcmV0LnB1c2gob2JqKTtcbiAgICAgICAgcmV0LnNvcnQoZnVuY3Rpb24gKGEsIGIpIHtcbiAgICAgICAgICAgIGlmIChhWzBdID4gYlswXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhWzBdIDwgYlswXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm5fZGF0YS5jaXRhdGlvbl9lcnJvcnMgPSB0aGlzLnRtcC5jaXRhdGlvbl9lcnJvcnMuc2xpY2UoKTtcbiAgICByZXR1cm4gW3JldHVybl9kYXRhLCByZXRdO1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLnByb2Nlc3NfQ2l0YXRpb25DbHVzdGVyID0gZnVuY3Rpb24gKHNvcnRlZEl0ZW1zLCBjaXRhdGlvbklEKSB7XG4gICAgdmFyIHN0cjtcbiAgICB0aGlzLnBhcmFsbGVsLlN0YXJ0Q2l0YXRpb24oc29ydGVkSXRlbXMpO1xuICAgIHN0ciA9IENTTC5nZXRDaXRhdGlvbkNsdXN0ZXIuY2FsbCh0aGlzLCBzb3J0ZWRJdGVtcywgY2l0YXRpb25JRCk7XG4gICAgcmV0dXJuIHN0cjtcbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5tYWtlQ2l0YXRpb25DbHVzdGVyID0gZnVuY3Rpb24gKHJhd0xpc3QpIHtcbiAgICB2YXIgaW5wdXRMaXN0LCBuZXdpdGVtLCBzdHIsIHBvcywgbGVuLCBpdGVtLCBJdGVtO1xuICAgIGlucHV0TGlzdCA9IFtdO1xuICAgIGxlbiA9IHJhd0xpc3QubGVuZ3RoO1xuICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBpdGVtID0ge307XG4gICAgICAgIGZvciAodmFyIGtleSBpbiByYXdMaXN0W3Bvc10pIHtcbiAgICAgICAgICAgIGl0ZW1ba2V5XSA9IHJhd0xpc3RbcG9zXVtrZXldO1xuICAgICAgICB9XG4gICAgICAgIEl0ZW0gPSB0aGlzLnJldHJpZXZlSXRlbShcIlwiICsgaXRlbS5pZCk7XG4gICAgICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmxvY2F0b3JfbGFiZWxfcGFyc2UpIHtcbiAgICAgICAgICAgIGlmIChpdGVtLmxvY2F0b3IgJiYgW1wiYmlsbFwiLFwiZ2F6ZXR0ZVwiLFwibGVnaXNsYXRpb25cIixcInJlZ3VsYXRpb25cIixcInRyZWF0eVwiXS5pbmRleE9mKEl0ZW0udHlwZSkgPT09IC0xICYmICghaXRlbS5sYWJlbCB8fCBpdGVtLmxhYmVsID09PSAncGFnZScpKSB7XG4gICAgICAgICAgICAgICAgdmFyIG0gPSBDU0wuTE9DQVRPUl9MQUJFTFNfUkVHRVhQLmV4ZWMoaXRlbS5sb2NhdG9yKTtcbiAgICAgICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdHJ5TGFiZWwgPSBDU0wuTE9DQVRPUl9MQUJFTFNfTUFQW21bMl1dO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRUZXJtKHRyeUxhYmVsKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5sYWJlbCA9IHRyeUxhYmVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5sb2NhdG9yID0gbVszXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoaXRlbS5sb2NhdG9yKSB7XG4gICAgICAgICAgICBpdGVtLmxvY2F0b3IgPSAoXCJcIiArIGl0ZW0ubG9jYXRvcikucmVwbGFjZSgvXFxzKyQvLCAnJyk7XG4gICAgICAgIH1cbiAgICAgICAgbmV3aXRlbSA9IFtJdGVtLCBpdGVtXTtcbiAgICAgICAgaW5wdXRMaXN0LnB1c2gobmV3aXRlbSk7XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnN0YXRpY19zdGF0dXRlX2xvY2F0b3IpIHtcbiAgICAgICAgdGhpcy5yZW1hcFNlY3Rpb25WYXJpYWJsZShpbnB1dExpc3QpO1xuICAgIH1cbiAgICBpZiAoaW5wdXRMaXN0ICYmIGlucHV0TGlzdC5sZW5ndGggPiAxICYmIHRoaXMuY2l0YXRpb25fc29ydC50b2tlbnMubGVuZ3RoID4gMCkge1xuICAgICAgICBsZW4gPSBpbnB1dExpc3QubGVuZ3RoO1xuICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgIGlucHV0TGlzdFtwb3NdWzFdLnNvcnRrZXlzID0gQ1NMLmdldFNvcnRLZXlzLmNhbGwodGhpcywgaW5wdXRMaXN0W3Bvc11bMF0sIFwiY2l0YXRpb25fc29ydFwiKTtcbiAgICAgICAgfVxuICAgICAgICBpbnB1dExpc3Quc29ydCh0aGlzLmNpdGF0aW9uLnNydC5jb21wYXJlQ29tcG9zaXRlS2V5cyk7XG4gICAgfVxuICAgIHRoaXMudG1wLmNpdGF0aW9uX2Vycm9ycyA9IFtdO1xuICAgIHRoaXMucGFyYWxsZWwuU3RhcnRDaXRhdGlvbihpbnB1dExpc3QpO1xuICAgIHN0ciA9IENTTC5nZXRDaXRhdGlvbkNsdXN0ZXIuY2FsbCh0aGlzLCBpbnB1dExpc3QpO1xuICAgIHJldHVybiBzdHI7XG59O1xuQ1NMLmdldEFtYmlndW91c0NpdGUgPSBmdW5jdGlvbiAoSXRlbSwgZGlzYW1iaWcsIHZpc3VhbEZvcm0sIGl0ZW0pIHtcbiAgICB2YXIgdXNlX3BhcmFsbGVscywgcmV0O1xuICAgIHZhciBmbGFncyA9IHRoaXMudG1wLmdyb3VwX2NvbnRleHQudGlwO1xuICAgIHZhciBvbGRUZXJtU2libGluZ0xheWVyID0ge1xuICAgICAgICB0ZXJtX2ludGVuZGVkOiBmbGFncy50ZXJtX2ludGVuZGVkLFxuICAgICAgICB2YXJpYWJsZV9hdHRlbXB0OiBmbGFncy52YXJpYWJsZV9hdHRlbXB0LFxuICAgICAgICB2YXJpYWJsZV9zdWNjZXNzOiBmbGFncy52YXJpYWJsZV9zdWNjZXNzLFxuICAgICAgICBvdXRwdXRfdGlwOiBmbGFncy5vdXRwdXRfdGlwLFxuICAgICAgICBsYWJlbF9mb3JtOiBmbGFncy5sYWJlbF9mb3JtLFxuICAgICAgICBwYXJhbGxlbF9jb25kaXRpb25zOiBmbGFncy5wYXJhbGxlbF9jb25kaXRpb25zLFxuICAgICAgICBjb25kaXRpb246IGZsYWdzLmNvbmRpdGlvbixcbiAgICAgICAgZm9yY2Vfc3VwcHJlc3M6IGZsYWdzLmZvcmNlX3N1cHByZXNzLFxuICAgICAgICBkb25lX3ZhcnM6IGZsYWdzLmRvbmVfdmFycy5zbGljZSgpXG4gICAgfVxuICAgIGlmIChkaXNhbWJpZykge1xuICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19yZXF1ZXN0ID0gZGlzYW1iaWc7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy50bXAuZGlzYW1iaWdfcmVxdWVzdCA9IGZhbHNlO1xuICAgIH1cbiAgICB2YXIgaXRlbVN1cHAgPSB7XG4gICAgICAgIHBvc2l0aW9uOiAxLFxuICAgICAgICBcIm5lYXItbm90ZVwiOiB0cnVlXG4gICAgfTtcbiAgICBpZiAoaXRlbSkge1xuICAgICAgICBpdGVtU3VwcC5sb2NhdG9yID0gaXRlbS5sb2NhdG9yO1xuICAgICAgICBpdGVtU3VwcC5sYWJlbCA9IGl0ZW0ubGFiZWw7XG4gICAgfVxuICAgIGlmICh0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdIFxuICAgICAgICAmJiB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkXG4gICAgICAgICYmIHRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbSXRlbS5pZF1cbiAgICAgICAgJiYgdGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtJdGVtLmlkXS5sZW5ndGggXG4gICAgICAgICYmIHZpc3VhbEZvcm0pIHtcbiAgICAgICAgaWYgKHRoaXMuY2l0YXRpb24ub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl0gPT09IFwiYnktY2l0ZVwiKSB7XG4gICAgICAgICAgICBpdGVtU3VwcFsnZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyJ10gPSB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdWydmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXInXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnRtcC5hcmVhID0gXCJjaXRhdGlvblwiO1xuICAgIHRoaXMudG1wLnJvb3QgPSBcImNpdGF0aW9uXCI7XG4gICAgdGhpcy5wYXJhbGxlbC51c2VfcGFyYWxsZWxzID0gKHRoaXMucGFyYWxsZWwudXNlX3BhcmFsbGVscyA9PT0gdHJ1ZSB8fCB0aGlzLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMgPT09IG51bGwpID8gbnVsbCA6IGZhbHNlO1xuICAgIHRoaXMudG1wLnN1cHByZXNzX2RlY29yYXRpb25zID0gdHJ1ZTtcbiAgICB0aGlzLnRtcC5qdXN0X2xvb2tpbmcgPSB0cnVlO1xuICAgIENTTC5nZXRDaXRlLmNhbGwodGhpcywgSXRlbSwgaXRlbVN1cHAsIG51bGwsIGZhbHNlKTtcbiAgICBmb3IgKHZhciBpPTAsaWxlbj10aGlzLm91dHB1dC5xdWV1ZS5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgQ1NMLk91dHB1dC5RdWV1ZS5wdXJnZUVtcHR5QmxvYnModGhpcy5vdXRwdXQucXVldWVbaV0pO1xuICAgIH1cbiAgICBpZiAodGhpcy5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5jbGVhbl91cF9jc2xfZmxhd3MpIHtcbiAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49dGhpcy5vdXRwdXQucXVldWUubGVuZ3RoO2o8amxlbjtqKz0xKSB7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QudXB3YXJkKHRoaXMub3V0cHV0LnF1ZXVlW2pdKTtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0LmFkanVzdC5sZWZ0d2FyZCh0aGlzLm91dHB1dC5xdWV1ZVtqXSk7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QuZG93bndhcmQodGhpcy5vdXRwdXQucXVldWVbal0pO1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQuYWRqdXN0LmZpeCh0aGlzLm91dHB1dC5xdWV1ZVtqXSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHJldCA9IHRoaXMub3V0cHV0LnN0cmluZyh0aGlzLCB0aGlzLm91dHB1dC5xdWV1ZSk7XG4gICAgdGhpcy50bXAuanVzdF9sb29raW5nID0gZmFsc2U7XG4gICAgdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSBmYWxzZTtcbiAgICB0aGlzLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMgPSB0aGlzLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMgPT09IG51bGwgPyB0cnVlIDogZmFsc2U7XG4gICAgdGhpcy50bXAuZ3JvdXBfY29udGV4dC5yZXBsYWNlKG9sZFRlcm1TaWJsaW5nTGF5ZXIpO1xuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLmdldFNwbGljZURlbGltaXRlciA9IGZ1bmN0aW9uIChsYXN0X2NvbGxhcHNlZCwgcG9zKSB7XG4gICAgaWYgKGxhc3RfY29sbGFwc2VkICYmICEgdGhpcy50bXAuaGF2ZV9jb2xsYXBzZWQgJiYgXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHRoaXMuY2l0YXRpb24ub3B0W1wiYWZ0ZXItY29sbGFwc2UtZGVsaW1pdGVyXCJdKSB7XG4gICAgICAgIHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIgPSB0aGlzLmNpdGF0aW9uLm9wdFtcImFmdGVyLWNvbGxhcHNlLWRlbGltaXRlclwiXTtcbiAgICB9IGVsc2UgaWYgKHRoaXMudG1wLnVzZV9jaXRlX2dyb3VwX2RlbGltaXRlcikge1xuICAgICAgICB0aGlzLnRtcC5zcGxpY2VfZGVsaW1pdGVyID0gdGhpcy5jaXRhdGlvbi5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXI7XG4gICAgfSBlbHNlIGlmICh0aGlzLnRtcC5oYXZlX2NvbGxhcHNlZCAmJiB0aGlzLm9wdC54Y2xhc3MgPT09IFwiaW4tdGV4dFwiICYmIHRoaXMub3B0LnVwZGF0ZV9tb2RlICE9PSBDU0wuTlVNRVJJQykge1xuICAgICAgICB0aGlzLnRtcC5zcGxpY2VfZGVsaW1pdGVyID0gXCIsIFwiO1xuICAgIH0gZWxzZSBpZiAodGhpcy50bXAuY2l0ZV9sb2NhbGVzW3BvcyAtIDFdKSB7XG4gICAgICAgIHZhciBhbHRfYWZmaXhlcyA9IHRoaXMudG1wLmNpdGVfYWZmaXhlc1t0aGlzLnRtcC5hcmVhXVt0aGlzLnRtcC5jaXRlX2xvY2FsZXNbcG9zIC0gMV1dO1xuICAgICAgICBpZiAoYWx0X2FmZml4ZXMgJiYgYWx0X2FmZml4ZXMuZGVsaW1pdGVyKSB7XG4gICAgICAgICAgICB0aGlzLnRtcC5zcGxpY2VfZGVsaW1pdGVyID0gYWx0X2FmZml4ZXMuZGVsaW1pdGVyO1xuICAgICAgICB9XG4gICAgfSBlbHNlIGlmICghdGhpcy50bXAuc3BsaWNlX2RlbGltaXRlcikge1xuICAgICAgICB0aGlzLnRtcC5zcGxpY2VfZGVsaW1pdGVyID0gXCJcIjtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXI7XG59O1xuQ1NMLmdldENpdGF0aW9uQ2x1c3RlciA9IGZ1bmN0aW9uIChpbnB1dExpc3QsIGNpdGF0aW9uSUQpIHtcbiAgICB2YXIgcmVzdWx0LCBvYmplY3RzLCBteXBhcmFtcywgbGVuLCBwb3MsIGl0ZW0sIGxhc3RfY29sbGFwc2VkLCBwYXJhbXMsIGVtcHRpZXMsIGNvbXBvc2l0ZSwgY29tcGllLCBteWJsb2JzLCBJdGVtLCBsbGVuLCBwcG9zLCBvYmosIHByZWNlZGluZ19pdGVtLCB0eHRfZXNjLCBlcnJvcl9vYmplY3Q7XG4gICAgaW5wdXRMaXN0ID0gaW5wdXRMaXN0ID8gaW5wdXRMaXN0IDogW107XG4gICAgdGhpcy50bXAubGFzdF9wcmltYXJ5X25hbWVzX3N0cmluZyA9IGZhbHNlO1xuICAgIHR4dF9lc2MgPSBDU0wuZ2V0U2FmZUVzY2FwZSh0aGlzKTtcbiAgICB0aGlzLnRtcC5hcmVhID0gXCJjaXRhdGlvblwiO1xuICAgIHRoaXMudG1wLnJvb3QgPSBcImNpdGF0aW9uXCI7XG4gICAgcmVzdWx0ID0gXCJcIjtcbiAgICBvYmplY3RzID0gW107XG4gICAgdGhpcy50bXAubGFzdF9zdWZmaXhfdXNlZCA9IFwiXCI7XG4gICAgdGhpcy50bXAubGFzdF9uYW1lc191c2VkID0gW107XG4gICAgdGhpcy50bXAubGFzdF95ZWFyc191c2VkID0gW107XG4gICAgdGhpcy50bXAuYmFja3JlZl9pbmRleCA9IFtdO1xuICAgIHRoaXMudG1wLmNpdGVfbG9jYWxlcyA9IFtdO1xuICAgIHRoaXMub3V0cHV0LmNoZWNrTmVzdGVkQnJhY2UgPSBuZXcgQ1NMLmNoZWNrTmVzdGVkQnJhY2UodGhpcyk7XG4gICAgdmFyIHVzZV9sYXlvdXRfcHJlZml4ID0gdGhpcy5vdXRwdXQuY2hlY2tOZXN0ZWRCcmFjZS51cGRhdGUodGhpcy5jaXRhdGlvbi5vcHQubGF5b3V0X3ByZWZpeCk7XG4gICAgdmFyIHN1cHByZXNzVHJhaWxpbmdQdW5jdHVhdGlvbiA9IGZhbHNlO1xuICAgIGlmICh0aGlzLm9wdC54Y2xhc3MgPT09IFwibm90ZVwiICYmIHRoaXMuY2l0YXRpb24ub3B0LnN1cHByZXNzVHJhaWxpbmdQdW5jdHVhdGlvbikge1xuICAgICAgICBzdXBwcmVzc1RyYWlsaW5nUHVuY3R1YXRpb24gPSB0cnVlO1xuICAgIH1cbiAgICBpZiAoY2l0YXRpb25JRCkge1xuICAgICAgICBpZiAodGhpcy5yZWdpc3RyeS5jaXRhdGlvbnJlZy5jaXRhdGlvbkJ5SWRbY2l0YXRpb25JRF0ucHJvcGVydGllc1tcInN1cHByZXNzLXRyYWlsaW5nLXB1bmN0dWF0aW9uXCJdKSB7XG4gICAgICAgICAgICBzdXBwcmVzc1RyYWlsaW5nUHVuY3R1YXRpb24gPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdC54Y2xhc3MgPT09IFwibm90ZVwiKSB7XG4gICAgICAgIHZhciBwYXJhc2V0cyA9IFtdO1xuICAgICAgICB2YXIgbGFzdFRpdGxlID0gZmFsc2U7XG4gICAgICAgIHZhciBsYXN0UG9zaXRpb24gPSBmYWxzZTtcbiAgICAgICAgdmFyIGxhc3RJRCA9IGZhbHNlO1xuICAgICAgICB2YXIgbHN0ID0gW107XG4gICAgICAgIGZvciAodmFyIGk9MCwgaWxlbiA9IGlucHV0TGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHZhciB0eXBlID0gaW5wdXRMaXN0W2ldWzBdLnR5cGU7XG4gICAgICAgICAgICB2YXIgdGl0bGUgPSBpbnB1dExpc3RbaV1bMF0udGl0bGU7XG4gICAgICAgICAgICB2YXIgcG9zaXRpb24gPSBpbnB1dExpc3RbaV1bMV0ucG9zaXRpb247XG4gICAgICAgICAgICB2YXIgaWQgPSBpbnB1dExpc3RbaV1bMF0uaWQ7XG4gICAgICAgICAgICBpZiAodGl0bGUgJiYgdHlwZSA9PT0gXCJsZWdhbF9jYXNlXCIgJiYgaWQgIT09IGxhc3RJRCAmJiBwb3NpdGlvbikge1xuICAgICAgICAgICAgICAgIGlmICh0aXRsZSAhPT0gbGFzdFRpdGxlIHx8IHBhcmFzZXRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBsc3QgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgcGFyYXNldHMucHVzaChsc3QpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBsc3QucHVzaChpbnB1dExpc3RbaV1bMV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGFzdFRpdGxlID0gdGl0bGU7XG4gICAgICAgICAgICBsYXN0UG9zaXRpb24gPSBwb3NpdGlvbjtcbiAgICAgICAgICAgIGxhc3RJRCA9IGlkO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoaT0wLCBpbGVuPXBhcmFzZXRzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgbHN0ID0gcGFyYXNldHNbaV07XG4gICAgICAgICAgICBpZiAobHN0Lmxlbmd0aCA8IDIpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBsb2NhdG9ySW5MYXN0UG9zaXRpb24gPSBsc3Quc2xpY2UoLTEpWzBdLmxvY2F0b3I7XG4gICAgICAgICAgICBpZiAobG9jYXRvckluTGFzdFBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaj0wLCBqbGVuPWxzdC5sZW5ndGggLSAxOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsc3Rbal0ubG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRvckluTGFzdFBvc2l0aW9uID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobG9jYXRvckluTGFzdFBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgbHN0WzBdLmxvY2F0b3IgPSBsb2NhdG9ySW5MYXN0UG9zaXRpb247XG4gICAgICAgICAgICAgICAgZGVsZXRlIGxzdC5zbGljZSgtMSlbMF0ubG9jYXRvcjtcbiAgICAgICAgICAgICAgICBsc3RbMF0ubGFiZWwgPSBsc3Quc2xpY2UoLTEpWzBdLmxhYmVsO1xuICAgICAgICAgICAgICAgIGlmIChsc3Quc2xpY2UoLTEpWzBdLmxhYmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBsc3Quc2xpY2UoLTEpWzBdLmxhYmVsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICB9XG4gICAgfVxuICAgIG15cGFyYW1zID0gW107XG4gICAgbGVuID0gaW5wdXRMaXN0Lmxlbmd0aDtcbiAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgSXRlbSA9IGlucHV0TGlzdFtwb3NdWzBdO1xuICAgICAgICBpdGVtID0gaW5wdXRMaXN0W3Bvc11bMV07XG4gICAgICAgIGl0ZW0gPSBDU0wucGFyc2VMb2NhdG9yLmNhbGwodGhpcywgaXRlbSk7XG4gICAgICAgIGxhc3RfY29sbGFwc2VkID0gdGhpcy50bXAuaGF2ZV9jb2xsYXBzZWQ7XG4gICAgICAgIHBhcmFtcyA9IHt9O1xuICAgICAgICB0aGlzLnRtcC5zaGFkb3dfbnVtYmVycyA9IHt9O1xuICAgICAgICBpZiAoIXRoaXMudG1wLmp1c3RfbG9va2luZyAmJiB0aGlzLm9wdC5oYXNQbGFjZWhvbGRlclRlcm0pIHtcbiAgICAgICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLm91dHB1dDtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0ID0gbmV3IENTTC5PdXRwdXQuUXVldWUodGhpcyk7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QgPSBuZXcgQ1NMLk91dHB1dC5RdWV1ZS5hZGp1c3QoKTtcbiAgICAgICAgICAgIENTTC5nZXRBbWJpZ3VvdXNDaXRlLmNhbGwodGhpcywgSXRlbSwgbnVsbCwgZmFsc2UsIGl0ZW0pO1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQgPSBvdXRwdXQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50bXAuaW5fY2l0ZV9wcmVkZWNlc3NvciA9IGZhbHNlO1xuICAgICAgICBpZiAocG9zID4gMCkge1xuICAgICAgICAgICAgQ1NMLmdldENpdGUuY2FsbCh0aGlzLCBJdGVtLCBpdGVtLCBcIlwiICsgaW5wdXRMaXN0Wyhwb3MgLSAxKV1bMF0uaWQsIHRydWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50bXAudGVybV9wcmVkZWNlc3NvciA9IGZhbHNlO1xuICAgICAgICAgICAgQ1NMLmdldENpdGUuY2FsbCh0aGlzLCBJdGVtLCBpdGVtLCBudWxsLCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMudG1wLmNpdGVfcmVuZGVyc19jb250ZW50KSB7XG4gICAgICAgICAgICBlcnJvcl9vYmplY3QgPSB7XG4gICAgICAgICAgICAgICAgY2l0YXRpb25JRDogXCJcIiArIHRoaXMudG1wLmNpdGF0aW9uX2lkLFxuICAgICAgICAgICAgICAgIGluZGV4OiB0aGlzLnRtcC5jaXRhdGlvbl9wb3MsXG4gICAgICAgICAgICAgICAgbm90ZUluZGV4OiB0aGlzLnRtcC5jaXRhdGlvbl9ub3RlX2luZGV4LFxuICAgICAgICAgICAgICAgIGl0ZW1JRDogXCJcIiArIEl0ZW0uaWQsXG4gICAgICAgICAgICAgICAgY2l0YXRpb25JdGVtc19wb3M6IHBvcyxcbiAgICAgICAgICAgICAgICBlcnJvcl9jb2RlOiBDU0wuRVJST1JfTk9fUkVOREVSRURfRk9STVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMudG1wLmNpdGF0aW9uX2Vycm9ycy5wdXNoKGVycm9yX29iamVjdCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBvcyA9PT0gKGlucHV0TGlzdC5sZW5ndGggLSAxKSkge1xuICAgICAgICAgICAgdGhpcy5wYXJhbGxlbC5Db21wb3NlU2V0KCk7XG4gICAgICAgIH1cbiAgICAgICAgcGFyYW1zLnNwbGljZV9kZWxpbWl0ZXIgPSBDU0wuZ2V0U3BsaWNlRGVsaW1pdGVyLmNhbGwodGhpcywgbGFzdF9jb2xsYXBzZWQsIHBvcyk7XG4gICAgICAgIGlmIChpdGVtICYmIGl0ZW1bXCJhdXRob3Itb25seVwiXSkge1xuICAgICAgICAgICAgdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwb3MgPiAwKSB7XG4gICAgICAgICAgICBwcmVjZWRpbmdfaXRlbSA9IGlucHV0TGlzdFtwb3MgLSAxXVsxXTtcbiAgICAgICAgICAgIHZhciBwcmVjZWRpbmdFbmRzSW5QZXJpb2RPckNvbW1hID0gcHJlY2VkaW5nX2l0ZW0uc3VmZml4ICYmIFtcIi5cIiwgXCIsXCJdLmluZGV4T2YocHJlY2VkaW5nX2l0ZW0uc3VmZml4LnNsaWNlKC0xKSkgPiAtMTtcbiAgICAgICAgICAgIHZhciBjdXJyZW50U3RhcnRzV2l0aFBlcmlvZE9yQ29tbWEgPSAhcHJlY2VkaW5nX2l0ZW0uc3VmZml4ICYmIGl0ZW0ucHJlZml4ICYmIFtcIi5cIiwgXCIsXCJdLmluZGV4T2YoaXRlbS5wcmVmaXguc2xpY2UoMCwgMSkpID4gLTE7XG4gICAgICAgICAgICBpZiAocHJlY2VkaW5nRW5kc0luUGVyaW9kT3JDb21tYSB8fCBjdXJyZW50U3RhcnRzV2l0aFBlcmlvZE9yQ29tbWEpIHtcbiAgICAgICAgICAgICAgICB2YXIgc3BhY2VpZHggPSBwYXJhbXMuc3BsaWNlX2RlbGltaXRlci5pbmRleE9mKFwiIFwiKTtcbiAgICAgICAgICAgICAgICBpZiAoc3BhY2VpZHggPiAtMSAmJiAhY3VycmVudFN0YXJ0c1dpdGhQZXJpb2RPckNvbW1hKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5zcGxpY2VfZGVsaW1pdGVyID0gcGFyYW1zLnNwbGljZV9kZWxpbWl0ZXIuc2xpY2Uoc3BhY2VpZHgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5zcGxpY2VfZGVsaW1pdGVyID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcGFyYW1zLnN1cHByZXNzX2RlY29yYXRpb25zID0gdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnM7XG4gICAgICAgIHBhcmFtcy5oYXZlX2NvbGxhcHNlZCA9IHRoaXMudG1wLmhhdmVfY29sbGFwc2VkO1xuICAgICAgICBteXBhcmFtcy5wdXNoKHBhcmFtcyk7XG4gICAgfVxuICAgIHRoaXMudG1wLmhhc19wdXJnZWRfcGFyYWxsZWwgPSBmYWxzZTtcbiAgICB0aGlzLnBhcmFsbGVsLlBydW5lT3V0cHV0UXVldWUodGhpcyk7XG4gICAgZW1wdGllcyA9IDA7XG4gICAgbXlibG9icyA9IHRoaXMub3V0cHV0LnF1ZXVlLnNsaWNlKCk7XG4gICAgdmFyIGZha2VibG9iID0ge1xuICAgICAgICBzdHJpbmdzOiB7XG4gICAgICAgICAgICBzdWZmaXg6IHRoaXMuY2l0YXRpb24ub3B0LmxheW91dF9zdWZmaXgsXG4gICAgICAgICAgICBkZWxpbWl0ZXI6IHRoaXMuY2l0YXRpb24ub3B0LmxheW91dF9kZWxpbWl0ZXIgICAgICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICB9O1xuICAgIHZhciBzdWZmaXggPSB0aGlzLmNpdGF0aW9uLm9wdC5sYXlvdXRfc3VmZml4O1xuICAgIHZhciBsYXN0X2xvY2FsZSA9IHRoaXMudG1wLmNpdGVfbG9jYWxlc1t0aGlzLnRtcC5jaXRlX2xvY2FsZXMubGVuZ3RoIC0gMV07XG4gICAgaWYgKGxhc3RfbG9jYWxlICYmIHRoaXMudG1wLmNpdGVfYWZmaXhlc1t0aGlzLnRtcC5hcmVhXVtsYXN0X2xvY2FsZV0gJiYgdGhpcy50bXAuY2l0ZV9hZmZpeGVzW3RoaXMudG1wLmFyZWFdW2xhc3RfbG9jYWxlXS5zdWZmaXgpIHtcbiAgICAgICAgc3VmZml4ID0gdGhpcy50bXAuY2l0ZV9hZmZpeGVzW3RoaXMudG1wLmFyZWFdW2xhc3RfbG9jYWxlXS5zdWZmaXg7XG4gICAgfVxuICAgIGlmIChDU0wuVEVSTUlOQUxfUFVOQ1RVQVRJT04uc2xpY2UoMCwgLTEpLmluZGV4T2Yoc3VmZml4LnNsaWNlKDAsIDEpKSA+IC0xKSB7XG4gICAgICAgIHN1ZmZpeCA9IHN1ZmZpeC5zbGljZSgwLCAxKTtcbiAgICB9XG4gICAgdmFyIGRlbGltaXRlciA9IHRoaXMuY2l0YXRpb24ub3B0LmxheW91dF9kZWxpbWl0ZXI7XG4gICAgaWYgKCFkZWxpbWl0ZXIpIHtcbiAgICAgICAgZGVsaW1pdGVyID0gXCJcIjtcbiAgICB9XG4gICAgaWYgKENTTC5URVJNSU5BTF9QVU5DVFVBVElPTi5zbGljZSgwLCAtMSkuaW5kZXhPZihkZWxpbWl0ZXIuc2xpY2UoMCwgMSkpID4gLTEpIHtcbiAgICAgICAgZGVsaW1pdGVyID0gZGVsaW1pdGVyLnNsaWNlKDAsIDEpO1xuICAgIH1cbiAgICBzdWZmaXggPSB0aGlzLm91dHB1dC5jaGVja05lc3RlZEJyYWNlLnVwZGF0ZShzdWZmaXgpO1xuICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMub3V0cHV0LnF1ZXVlLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICBDU0wuT3V0cHV0LlF1ZXVlLnB1cmdlRW1wdHlCbG9icyh0aGlzLm91dHB1dC5xdWV1ZVtpXSk7XG4gICAgfVxuICAgIGlmICghdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMgJiYgdGhpcy5vdXRwdXQucXVldWUubGVuZ3RoKSB7XG4gICAgICAgIGlmICghKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuYXBwbHlfY2l0YXRpb25fd3JhcHBlclxuICAgICAgICAgICAgICAmJiB0aGlzLnN5cy53cmFwQ2l0YXRpb25FbnRyeVxuICAgICAgICAgICAgICAgJiYgIXRoaXMudG1wLmp1c3RfbG9va2luZ1xuICAgICAgICAgICAgICAmJiB0aGlzLnRtcC5hcmVhID09PSBcImNpdGF0aW9uXCIpKSB7IFxuICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1RyYWlsaW5nUHVuY3R1YXRpb24pIHtcbiAgICAgICAgICAgICAgICB0aGlzLm91dHB1dC5xdWV1ZVt0aGlzLm91dHB1dC5xdWV1ZS5sZW5ndGggLSAxXS5zdHJpbmdzLnN1ZmZpeCA9IHN1ZmZpeDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMub3V0cHV0LnF1ZXVlWzBdLnN0cmluZ3MucHJlZml4ID0gdXNlX2xheW91dF9wcmVmaXg7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuY2xlYW5fdXBfY3NsX2ZsYXdzKSB7XG4gICAgICAgIGZvciAodmFyIGo9MCxqbGVuPXRoaXMub3V0cHV0LnF1ZXVlLmxlbmd0aDtqPGpsZW47ais9MSkge1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQuYWRqdXN0LnVwd2FyZCh0aGlzLm91dHB1dC5xdWV1ZVtqXSk7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QubGVmdHdhcmQodGhpcy5vdXRwdXQucXVldWVbal0pO1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQuYWRqdXN0LmRvd253YXJkKHRoaXMub3V0cHV0LnF1ZXVlW2pdKTtcbiAgICAgICAgICAgIHRoaXMudG1wLmxhc3RfY2hyID0gdGhpcy5vdXRwdXQuYWRqdXN0LmZpeCh0aGlzLm91dHB1dC5xdWV1ZVtqXSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yIChwb3MgPSAwLCBsZW4gPSBteWJsb2JzLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICB2YXIgYnVmZmVyID0gW107XG4gICAgICAgIHRoaXMub3V0cHV0LnF1ZXVlID0gW215YmxvYnNbcG9zXV07XG4gICAgICAgIHRoaXMudG1wLnN1cHByZXNzX2RlY29yYXRpb25zID0gbXlwYXJhbXNbcG9zXS5zdXBwcmVzc19kZWNvcmF0aW9ucztcbiAgICAgICAgdGhpcy50bXAuc3BsaWNlX2RlbGltaXRlciA9IG15cGFyYW1zW3Bvc10uc3BsaWNlX2RlbGltaXRlcjtcbiAgICAgICAgaWYgKG15YmxvYnNbcG9zXS5wYXJhbGxlbF9kZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgIHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIgPSBteWJsb2JzW3Bvc10ucGFyYWxsZWxfZGVsaW1pdGVyO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudG1wLmhhdmVfY29sbGFwc2VkID0gbXlwYXJhbXNbcG9zXS5oYXZlX2NvbGxhcHNlZDtcbiAgICAgICAgY29tcG9zaXRlID0gdGhpcy5vdXRwdXQuc3RyaW5nKHRoaXMsIHRoaXMub3V0cHV0LnF1ZXVlKTtcbiAgICAgICAgdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSBmYWxzZTtcbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBjb21wb3NpdGUpIHtcbiAgICAgICAgICAgIHRoaXMudG1wLnN1cHByZXNzX2RlY29yYXRpb25zID0gZmFsc2U7XG4gICAgICAgICAgICByZXR1cm4gY29tcG9zaXRlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcIm9iamVjdFwiID09PSB0eXBlb2YgY29tcG9zaXRlICYmIGNvbXBvc2l0ZS5sZW5ndGggPT09IDAgJiYgIWl0ZW1bXCJzdXBwcmVzcy1hdXRob3JcIl0pIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnRtcC5oYXNfcHVyZ2VkX3BhcmFsbGVsKSB7XG4gICAgICAgICAgICAgICAgY29tcG9zaXRlLnB1c2goXCJcIik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBlcnJTdHIgPSBcIltDU0wgU1RZTEUgRVJST1I6IHJlZmVyZW5jZSB3aXRoIG5vIHByaW50ZWQgZm9ybS5dXCI7XG4gICAgICAgICAgICAgICAgdmFyIHByZVN0ciA9IHBvcyA9PT0gMCA/IHR4dF9lc2ModGhpcy5jaXRhdGlvbi5vcHQubGF5b3V0X3ByZWZpeCkgOiBcIlwiO1xuICAgICAgICAgICAgICAgIHZhciBzdWZTdHIgPSBwb3MgPT09IChteWJsb2JzLmxlbmd0aCAtIDEpID8gdHh0X2VzYyh0aGlzLmNpdGF0aW9uLm9wdC5sYXlvdXRfc3VmZml4KSA6IFwiXCI7XG4gICAgICAgICAgICAgICAgY29tcG9zaXRlLnB1c2gocHJlU3RyICsgZXJyU3RyICsgc3VmU3RyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoYnVmZmVyLmxlbmd0aCAmJiBcInN0cmluZ1wiID09PSB0eXBlb2YgY29tcG9zaXRlWzBdKSB7XG4gICAgICAgICAgICBjb21wb3NpdGUucmV2ZXJzZSgpO1xuICAgICAgICAgICAgdmFyIHRtcHN0ciA9IGNvbXBvc2l0ZS5wb3AoKTtcbiAgICAgICAgICAgIGlmICh0bXBzdHIgJiYgdG1wc3RyLnNsaWNlKDAsIDEpID09PSBcIixcIikge1xuICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKHRtcHN0cik7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKFwic3RyaW5nXCIgPT0gdHlwZW9mIGJ1ZmZlci5zbGljZSgtMSlbMF0gJiYgYnVmZmVyLnNsaWNlKC0xKVswXS5zbGljZSgtMSkgPT09IFwiLFwiKSB7XG4gICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goXCIgXCIgKyB0bXBzdHIpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh0bXBzdHIpIHtcbiAgICAgICAgICAgICAgICBidWZmZXIucHVzaCh0eHRfZXNjKHRoaXMudG1wLnNwbGljZV9kZWxpbWl0ZXIpICsgdG1wc3RyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbXBvc2l0ZS5yZXZlcnNlKCk7XG4gICAgICAgICAgICBjb21waWUgPSBjb21wb3NpdGUucG9wKCk7XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIGNvbXBpZSkge1xuICAgICAgICAgICAgICAgIGlmIChidWZmZXIubGVuZ3RoICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiBidWZmZXJbYnVmZmVyLmxlbmd0aCAtIDFdKSB7XG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlcltidWZmZXIubGVuZ3RoIC0gMV0gKz0gY29tcGllLnN1Y2Nlc3Nvcl9wcmVmaXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGNvbXBpZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGxlbiA9IGNvbXBvc2l0ZS5sZW5ndGg7XG4gICAgICAgIGZvciAocHBvcyA9IDA7IHBwb3MgPCBsbGVuOyBwcG9zICs9IDEpIHtcbiAgICAgICAgICAgIG9iaiA9IGNvbXBvc2l0ZVtwcG9zXTtcbiAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2Ygb2JqKSB7XG4gICAgICAgICAgICAgICAgYnVmZmVyLnB1c2godHh0X2VzYyh0aGlzLnRtcC5zcGxpY2VfZGVsaW1pdGVyKSArIG9iaik7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb21waWUgPSBjb21wb3NpdGUucG9wKCk7XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIGNvbXBpZSkge1xuICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGNvbXBpZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJ1ZmZlci5sZW5ndGggPT09IDAgJiYgIWlucHV0TGlzdFtwb3NdWzFdW1wic3VwcHJlc3MtYXV0aG9yXCJdKSB7XG4gICAgICAgICAgICBlbXB0aWVzICs9IDE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJ1ZmZlci5sZW5ndGggPiAxICYmIHR5cGVvZiBidWZmZXJbMF0gIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIGJ1ZmZlciA9IFt0aGlzLm91dHB1dC5yZW5kZXJCbG9icyhidWZmZXIpXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYnVmZmVyLmxlbmd0aCkge1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBidWZmZXJbMF0pIHtcbiAgICAgICAgICAgICAgICBpZiAocG9zID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoKChteWJsb2JzLmxlbmd0aC0xKSA+IHBvcyAmJiBteXBhcmFtc1twb3MrMV0uaGF2ZV9jb2xsYXBzZWQpICYmICFteXBhcmFtc1twb3NdLmhhdmVfY29sbGFwc2VkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRtcC5zcGxpY2VfZGVsaW1pdGVyID0gbXlwYXJhbXNbcG9zLTFdLnNwbGljZV9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnVmZmVyWzBdID0gdHh0X2VzYyh0aGlzLnRtcC5zcGxpY2VfZGVsaW1pdGVyKSArIGJ1ZmZlclswXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChwb3MgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlclswXS5zcGxpY2VfcHJlZml4ID0gdGhpcy50bXAuc3BsaWNlX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBidWZmZXJbMF0uc3BsaWNlX3ByZWZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIG9iamVjdHMgPSBvYmplY3RzLmNvbmNhdChidWZmZXIpO1xuICAgIH1cbiAgICByZXN1bHQgKz0gdGhpcy5vdXRwdXQucmVuZGVyQmxvYnMob2JqZWN0cyk7XG4gICAgaWYgKHJlc3VsdCkge1xuICAgICAgICBpZiAoIXRoaXMudG1wLnN1cHByZXNzX2RlY29yYXRpb25zKSB7XG4gICAgICAgICAgICBsZW4gPSB0aGlzLmNpdGF0aW9uLm9wdC5sYXlvdXRfZGVjb3JhdGlvbnMubGVuZ3RoO1xuICAgICAgICAgICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1zID0gdGhpcy5jaXRhdGlvbi5vcHQubGF5b3V0X2RlY29yYXRpb25zW3Bvc107XG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtc1sxXSA9PT0gXCJub3JtYWxcIikge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFpdGVtIHx8ICFpdGVtW1wiYXV0aG9yLW9ubHlcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5mdW4uZGVjb3JhdGVbcGFyYW1zWzBdXVtwYXJhbXNbMV1dKHRoaXMsIHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMudG1wLnN1cHByZXNzX2RlY29yYXRpb25zID0gZmFsc2U7XG4gICAgcmV0dXJuIHJlc3VsdDtcbn07XG5DU0wuZ2V0Q2l0ZSA9IGZ1bmN0aW9uIChJdGVtLCBpdGVtLCBwcmV2SXRlbUlELCBibG9ja1NoYWRvd051bWJlclJlc2V0KSB7XG4gICAgdmFyIG5leHQsIGVycm9yX29iamVjdDtcbiAgICB0aGlzLnRtcC5jaXRlX3JlbmRlcnNfY29udGVudCA9IGZhbHNlO1xuICAgIHRoaXMucGFyYWxsZWwuU3RhcnRDaXRlKEl0ZW0sIGl0ZW0sIHByZXZJdGVtSUQpO1xuICAgIENTTC5jaXRlU3RhcnQuY2FsbCh0aGlzLCBJdGVtLCBpdGVtLCBibG9ja1NoYWRvd051bWJlclJlc2V0KTtcbiAgICBuZXh0ID0gMDtcbiAgICB0aGlzLnRtcC5uYW1lX25vZGUgPSB7fTtcbiAgICB0aGlzLm5hbWVPdXRwdXQgPSBuZXcgQ1NMLk5hbWVPdXRwdXQodGhpcywgSXRlbSwgaXRlbSk7XG4gICAgd2hpbGUgKG5leHQgPCB0aGlzW3RoaXMudG1wLmFyZWFdLnRva2Vucy5sZW5ndGgpIHtcbiAgICAgICAgbmV4dCA9IENTTC50b2tlbkV4ZWMuY2FsbCh0aGlzLCB0aGlzW3RoaXMudG1wLmFyZWFdLnRva2Vuc1tuZXh0XSwgSXRlbSwgaXRlbSk7XG4gICAgfVxuICAgIENTTC5jaXRlRW5kLmNhbGwodGhpcywgSXRlbSwgaXRlbSk7XG4gICAgdGhpcy5wYXJhbGxlbC5DbG9zZUNpdGUodGhpcyk7XG4gICAgaWYgKCF0aGlzLnRtcC5jaXRlX3JlbmRlcnNfY29udGVudCAmJiAhdGhpcy50bXAuanVzdF9sb29raW5nKSB7XG4gICAgICAgIGlmICh0aGlzLnRtcC5hcmVhID09PSBcImJpYmxpb2dyYXBoeVwiKSB7XG4gICAgICAgICAgICBlcnJvcl9vYmplY3QgPSB7XG4gICAgICAgICAgICAgICAgaW5kZXg6IHRoaXMudG1wLmJpYmxpb2dyYXBoeV9wb3MsXG4gICAgICAgICAgICAgICAgaXRlbUlEOiBcIlwiICsgSXRlbS5pZCxcbiAgICAgICAgICAgICAgICBlcnJvcl9jb2RlOiBDU0wuRVJST1JfTk9fUkVOREVSRURfRk9STVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMudG1wLmJpYmxpb2dyYXBoeV9lcnJvcnMucHVzaChlcnJvcl9vYmplY3QpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBcIlwiICsgSXRlbS5pZDtcbn07XG5DU0wuY2l0ZVN0YXJ0ID0gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0sIGJsb2NrU2hhZG93TnVtYmVyUmVzZXQpIHtcbiAgICBpZiAoIWJsb2NrU2hhZG93TnVtYmVyUmVzZXQpIHtcbiAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnMgPSB7fTtcbiAgICB9XG4gICAgdGhpcy50bXAuZGlzYW1iaWd1YXRlX2NvdW50ID0gMDtcbiAgICB0aGlzLnRtcC5kaXNhbWJpZ3VhdGVfbWF4TWF4ID0gMDtcbiAgICB0aGlzLnRtcC5zYW1lX2F1dGhvcl9hc19wcmV2aW91c19jaXRlID0gZmFsc2U7XG4gICAgaWYgKCF0aGlzLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICB0aGlzLnRtcC5zdWJzZXF1ZW50X2F1dGhvcl9zdWJzdGl0dXRlX29rID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRtcC5zdWJzZXF1ZW50X2F1dGhvcl9zdWJzdGl0dXRlX29rID0gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMudG1wLmxhc3RjaHIgPSBcIlwiO1xuICAgIGlmICh0aGlzLnRtcC5hcmVhID09PSBcImNpdGF0aW9uXCIgJiYgdGhpcy5jaXRhdGlvbi5vcHQuY29sbGFwc2UgJiYgdGhpcy5jaXRhdGlvbi5vcHQuY29sbGFwc2UubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMudG1wLmhhdmVfY29sbGFwc2VkID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRtcC5oYXZlX2NvbGxhcHNlZCA9IGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLnRtcC5yZW5kZXJfc2VlbiA9IGZhbHNlO1xuICAgIGlmICh0aGlzLnRtcC5kaXNhbWJpZ19yZXF1ZXN0ICAmJiAhIHRoaXMudG1wLmRpc2FtYmlnX292ZXJyaWRlKSB7XG4gICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3NldHRpbmdzID0gdGhpcy50bXAuZGlzYW1iaWdfcmVxdWVzdDtcbiAgICB9IGVsc2UgaWYgKHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0gJiYgISB0aGlzLnRtcC5kaXNhbWJpZ19vdmVycmlkZSkge1xuICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19yZXF1ZXN0ID0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZztcbiAgICAgICAgdGhpcy50bXAuZGlzYW1iaWdfc2V0dGluZ3MgPSB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3NldHRpbmdzID0gbmV3IENTTC5BbWJpZ0NvbmZpZygpO1xuICAgIH1cbiAgICBpZiAodGhpcy50bXAuYXJlYSAhPT0gJ2NpdGF0aW9uJykge1xuICAgICAgICBpZiAoIXRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0pIHtcbiAgICAgICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3Jlc3RvcmUgPSBuZXcgQ1NMLkFtYmlnQ29uZmlnKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19yZXN0b3JlID0gQ1NMLmNsb25lQW1iaWdDb25maWcodGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZyk7XG4gICAgICAgICAgICBpZiAodGhpcy50bXAuYXJlYSA9PT0gJ2JpYmxpb2dyYXBoeScgJiYgdGhpcy50bXAuZGlzYW1iaWdfc2V0dGluZ3MgJiYgdGhpcy50bXAuZGlzYW1iaWdfb3ZlcnJpZGUpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLW5hbWVzXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3NldHRpbmdzLm5hbWVzID0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy5uYW1lcy5zbGljZSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50bXAuZGlzYW1iaWdfcmVxdWVzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50bXAuZGlzYW1iaWdfcmVxdWVzdC5uYW1lcyA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcubmFtZXMuc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLWdpdmVubmFtZVwiXSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRtcC5kaXNhbWJpZ19yZXF1ZXN0ID0gdGhpcy50bXAuZGlzYW1iaWdfc2V0dGluZ3M7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVucyA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcuZ2l2ZW5zLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3JlcXVlc3QuZ2l2ZW5zID0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy5naXZlbnMuc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zW2ldID0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy5naXZlbnNbaV0uc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj10aGlzLnRtcC5kaXNhbWJpZ19yZXF1ZXN0LmdpdmVucy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG1wLmRpc2FtYmlnX3JlcXVlc3QuZ2l2ZW5zW2ldID0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy5naXZlbnNbaV0uc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnRtcC5uYW1lc191c2VkID0gW107XG4gICAgdGhpcy50bXAubmFtZXNldF9jb3VudGVyID0gMDtcbiAgICB0aGlzLnRtcC55ZWFyc191c2VkID0gW107XG4gICAgdGhpcy50bXAubmFtZXNfbWF4LmNsZWFyKCk7XG4gICAgdGhpcy50bXAuc3BsaWNlX2RlbGltaXRlciA9IHRoaXNbdGhpcy50bXAuYXJlYV0ub3B0LmxheW91dF9kZWxpbWl0ZXI7XG4gICAgdGhpcy5iaWJsaW9ncmFwaHlfc29ydC5rZXlzID0gW107XG4gICAgdGhpcy5jaXRhdGlvbl9zb3J0LmtleXMgPSBbXTtcbiAgICB0aGlzLnRtcC5oYXNfZG9uZV95ZWFyX3N1ZmZpeCA9IGZhbHNlO1xuICAgIHRoaXMudG1wLmxhc3RfY2l0ZV9sb2NhbGUgPSBmYWxzZTtcbiAgICBpZiAoIXRoaXMudG1wLmp1c3RfbG9va2luZyAmJiBpdGVtICYmICFpdGVtLnBvc2l0aW9uICYmIHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0pIHtcbiAgICAgICAgdGhpcy50bXAuZGlzYW1iaWdfcmVzdG9yZSA9IENTTC5jbG9uZUFtYmlnQ29uZmlnKHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcpO1xuICAgIH1cbiAgICB0aGlzLnRtcC5maXJzdF9uYW1lX3N0cmluZyA9IGZhbHNlO1xuICAgIHRoaXMudG1wLmF1dGhvcml0eV9zdG9wX2xhc3QgPSAwO1xufTtcbkNTTC5jaXRlRW5kID0gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICBpZiAodGhpcy50bXAuZGlzYW1iaWdfcmVzdG9yZSAmJiB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdKSB7XG4gICAgICAgIHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcubmFtZXMgPSB0aGlzLnRtcC5kaXNhbWJpZ19yZXN0b3JlLm5hbWVzLnNsaWNlKCk7XG4gICAgICAgIHRoaXMucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcuZ2l2ZW5zID0gdGhpcy50bXAuZGlzYW1iaWdfcmVzdG9yZS5naXZlbnMuc2xpY2UoKTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy5naXZlbnMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLmdpdmVuc1tpXSA9IHRoaXMudG1wLmRpc2FtYmlnX3Jlc3RvcmUuZ2l2ZW5zW2ldLnNsaWNlKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy50bXAuZGlzYW1iaWdfcmVzdG9yZSA9IGZhbHNlO1xuICAgIGlmIChpdGVtICYmIGl0ZW0uc3VmZml4KSB7XG4gICAgICAgIHRoaXMudG1wLmxhc3Rfc3VmZml4X3VzZWQgPSBpdGVtLnN1ZmZpeDtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRtcC5sYXN0X3N1ZmZpeF91c2VkID0gXCJcIjtcbiAgICB9XG4gICAgdGhpcy50bXAubGFzdF95ZWFyc191c2VkID0gdGhpcy50bXAueWVhcnNfdXNlZC5zbGljZSgpO1xuICAgIHRoaXMudG1wLmxhc3RfbmFtZXNfdXNlZCA9IHRoaXMudG1wLm5hbWVzX3VzZWQuc2xpY2UoKTtcbiAgICB0aGlzLnRtcC5jdXRfdmFyID0gZmFsc2U7XG4gICAgdGhpcy50bXAuZGlzYW1iaWdfcmVxdWVzdCA9IGZhbHNlO1xuICAgIHRoaXMudG1wLmNpdGVfbG9jYWxlcy5wdXNoKHRoaXMudG1wLmxhc3RfY2l0ZV9sb2NhbGUpO1xuICAgIGlmICh0aGlzLnRtcC5pc3N1ZWRfZGF0ZSAmJiB0aGlzLnRtcC5yZW5kZXJzX2NvbGxlY3Rpb25fbnVtYmVyKSB7XG4gICAgICAgIHZhciBidWYgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMudG1wLmlzc3VlZF9kYXRlLmxpc3QubGVuZ3RoIC0gMTsgaSA+IHRoaXMudG1wLmlzc3VlZF9kYXRlLnBvczsgaSArPSAtMSkge1xuICAgICAgICAgICAgYnVmLnB1c2godGhpcy50bXAuaXNzdWVkX2RhdGUubGlzdC5wb3AoKSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50bXAuaXNzdWVkX2RhdGUubGlzdC5wb3AoKTtcbiAgICAgICAgZm9yIChpID0gYnVmLmxlbmd0aCAtIDE7IGkgPiAtMTsgaSArPSAtMSkge1xuICAgICAgICAgICAgdGhpcy50bXAuaXNzdWVkX2RhdGUubGlzdC5wdXNoKGJ1Zi5wb3AoKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucGFyYWxsZWwudXNlX3BhcmFsbGVscykge1xuICAgICAgICAgICAgdGhpcy5wYXJhbGxlbC5jaXRlW1wiaXNzdWVkXCJdID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy50bXAuaXNzdWVkX2RhdGUgPSBmYWxzZTtcbiAgICB0aGlzLnRtcC5yZW5kZXJzX2NvbGxlY3Rpb25fbnVtYmVyID0gZmFsc2U7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuRW5naW5lLnByb3RvdHlwZS5tYWtlQmlibGlvZ3JhcGh5ID0gZnVuY3Rpb24gKGJpYnNlY3Rpb24pIHtcbiAgICB2YXIgZGVidWcsIHJldCwgcGFyYW1zLCBtYXhvZmZzZXQsIGl0ZW0sIGxlbiwgcG9zLCB0b2ssIHRva2ssIHRva2trLCBlbnRyeV9pZHMsIGVudHJ5X3N0cmluZ3MsIGJpYmxpb2dyYXBoeV9lcnJvcnM7XG4gICAgZGVidWcgPSBmYWxzZTtcbiAgICBpZiAoIXRoaXMuYmlibGlvZ3JhcGh5LnRva2Vucy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJpYnNlY3Rpb24pIHtcbiAgICAgICAgdGhpcy5vcHQuY2l0YXRpb25fbnVtYmVyX3NsdWcgPSBiaWJzZWN0aW9uO1xuICAgICAgICBiaWJzZWN0aW9uID0gZmFsc2U7XG4gICAgfVxuICAgIHJldCA9IENTTC5nZXRCaWJsaW9ncmFwaHlFbnRyaWVzLmNhbGwodGhpcywgYmlic2VjdGlvbik7XG4gICAgZW50cnlfaWRzID0gcmV0WzBdO1xuICAgIGVudHJ5X3N0cmluZ3MgPSByZXRbMV07XG4gICAgdmFyIGRvbmUgPSByZXRbMl07XG4gICAgcGFyYW1zID0ge1xuICAgICAgICBcIm1heG9mZnNldFwiOiAwLFxuICAgICAgICBcImVudHJ5c3BhY2luZ1wiOiB0aGlzLmJpYmxpb2dyYXBoeS5vcHRbXCJlbnRyeS1zcGFjaW5nXCJdLFxuICAgICAgICBcImxpbmVzcGFjaW5nXCI6IHRoaXMuYmlibGlvZ3JhcGh5Lm9wdFtcImxpbmUtc3BhY2luZ1wiXSxcbiAgICAgICAgXCJzZWNvbmQtZmllbGQtYWxpZ25cIjogZmFsc2UsXG4gICAgICAgIFwiZW50cnlfaWRzXCI6IGVudHJ5X2lkcyxcbiAgICAgICAgXCJiaWJsaW9ncmFwaHlfZXJyb3JzXCI6IHRoaXMudG1wLmJpYmxpb2dyYXBoeV9lcnJvcnMuc2xpY2UoKSxcbiAgICAgICAgXCJkb25lXCI6IGRvbmVcbiAgICB9O1xuICAgIGlmICh0aGlzLmJpYmxpb2dyYXBoeS5vcHRbXCJzZWNvbmQtZmllbGQtYWxpZ25cIl0pIHtcbiAgICAgICAgcGFyYW1zW1wic2Vjb25kLWZpZWxkLWFsaWduXCJdID0gdGhpcy5iaWJsaW9ncmFwaHkub3B0W1wic2Vjb25kLWZpZWxkLWFsaWduXCJdO1xuICAgIH1cbiAgICBtYXhvZmZzZXQgPSAwO1xuICAgIGxlbiA9IHRoaXMucmVnaXN0cnkucmVmbGlzdC5sZW5ndGg7XG4gICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIGl0ZW0gPSB0aGlzLnJlZ2lzdHJ5LnJlZmxpc3RbcG9zXTtcbiAgICAgICAgaWYgKGl0ZW0ub2Zmc2V0ID4gcGFyYW1zLm1heG9mZnNldCkge1xuICAgICAgICAgICAgcGFyYW1zLm1heG9mZnNldCA9IGl0ZW0ub2Zmc2V0O1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLmJpYmxpb2dyYXBoeS5vcHQuaGFuZ2luZ2luZGVudCkge1xuICAgICAgICBwYXJhbXMuaGFuZ2luZ2luZGVudCA9IHRoaXMuYmlibGlvZ3JhcGh5Lm9wdC5oYW5naW5naW5kZW50O1xuICAgIH1cbiAgICBwYXJhbXMuYmlic3RhcnQgPSB0aGlzLmZ1bi5kZWNvcmF0ZS5iaWJzdGFydDtcbiAgICBwYXJhbXMuYmliZW5kID0gdGhpcy5mdW4uZGVjb3JhdGUuYmliZW5kO1xuICAgIHRoaXMub3B0LmNpdGF0aW9uX251bWJlcl9zbHVnID0gZmFsc2U7XG4gICAgcmV0dXJuIFtwYXJhbXMsIGVudHJ5X3N0cmluZ3NdO1xufTtcbkNTTC5nZXRCaWJsaW9ncmFwaHlFbnRyaWVzID0gZnVuY3Rpb24gKGJpYnNlY3Rpb24pIHtcbiAgICB2YXIgcmV0LCBpbnB1dCwgaW5jbHVkZSwgYW55bWF0Y2gsIGFsbG1hdGNoLCBiaWJfZW50cnksIHJlcywgbGVuLCBwb3MsIGl0ZW0sIGxsZW4sIHBwb3MsIHNwZWMsIGxsbGVuLCBwcHBvcywgYmliX2xheW91dCwgdG9wYmxvYnMsIGFsbF9pdGVtX2lkcywgZW50cnlfaXRlbV9pZHMsIGRlYnVnLCBjb2xsYXBzZV9wYXJhbGxlbCwgaSwgaWxlbiwgc2libGluZ3MsIHNraXBzLCBzb3J0ZWRJdGVtcywgZXlldGVtLCBjaHIsIGVudHJ5X2l0ZW1fZGF0YSwgaiwgamxlbiwgbmV3SURzLCBvcmlnaW5hbElEcztcbiAgICByZXQgPSBbXTtcbiAgICBlbnRyeV9pdGVtX2RhdGEgPSBbXTtcbiAgICB0aGlzLnRtcC5hcmVhID0gXCJiaWJsaW9ncmFwaHlcIjtcbiAgICB0aGlzLnRtcC5yb290ID0gXCJiaWJsaW9ncmFwaHlcIjtcbiAgICB0aGlzLnRtcC5sYXN0X3JlbmRlcmVkX25hbWUgPSBmYWxzZTtcbiAgICB0aGlzLnRtcC5iaWJsaW9ncmFwaHlfZXJyb3JzID0gW107XG4gICAgdGhpcy50bXAuYmlibGlvZ3JhcGh5X3BvcyA9IDA7XG4gICAgaWYgKGJpYnNlY3Rpb24gJiYgYmlic2VjdGlvbi5wYWdlX3N0YXJ0ICYmIGJpYnNlY3Rpb24ucGFnZV9sZW5ndGgpIHtcbiAgICAgICAgaW5wdXQgPSB0aGlzLnJlZ2lzdHJ5LmdldFNvcnRlZElkcygpOyAgICAgICAgXG4gICAgfSBlbHNlIHtcbiAgICAgICAgaW5wdXQgPSB0aGlzLnJldHJpZXZlSXRlbXModGhpcy5yZWdpc3RyeS5nZXRTb3J0ZWRJZHMoKSk7XG4gICAgfVxuICAgIHRoaXMudG1wLmRpc2FtYmlnX292ZXJyaWRlID0gdHJ1ZTtcbiAgICBmdW5jdGlvbiBldmFsX3N0cmluZyhhLCBiKSB7XG4gICAgICAgIGlmIChhID09PSBiKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGV2YWxfbGlzdChhLCBsc3QpIHtcbiAgICAgICAgbGxsZW4gPSBsc3QubGVuZ3RoO1xuICAgICAgICBmb3IgKHBwcG9zID0gMDsgcHBwb3MgPCBsbGxlbjsgcHBwb3MgKz0gMSkge1xuICAgICAgICAgICAgaWYgKGV2YWxfc3RyaW5nKGEsIGxzdFtwcHBvc10pKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmdW5jdGlvbiBldmFsX3NwZWMoYSwgYikge1xuICAgICAgICBpZiAoKGEgPT09IFwibm9uZVwiIHx8ICFhKSAmJiAhYikge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBiKSB7XG4gICAgICAgICAgICByZXR1cm4gZXZhbF9zdHJpbmcoYSwgYik7XG4gICAgICAgIH0gZWxzZSBpZiAoIWIpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBldmFsX2xpc3QoYSwgYik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgc2tpcHMgPSB7fTtcbiAgICB2YXIgcGFnZV9pdGVtX2NvdW50O1xuICAgIGlmIChiaWJzZWN0aW9uICYmIGJpYnNlY3Rpb24ucGFnZV9zdGFydCAmJiBiaWJzZWN0aW9uLnBhZ2VfbGVuZ3RoKSB7XG4gICAgICAgIHBhZ2VfaXRlbV9jb3VudCA9IDA7XG4gICAgICAgIGlmIChiaWJzZWN0aW9uLnBhZ2Vfc3RhcnQgIT09IHRydWUpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gaW5wdXQubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgc2tpcHNbaW5wdXRbaV1dID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoYmlic2VjdGlvbi5wYWdlX3N0YXJ0ID09IGlucHV0W2ldKSB7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgcHJvY2Vzc2VkX2l0ZW1faWRzID0gW107XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBpbnB1dC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKGJpYnNlY3Rpb24gJiYgYmlic2VjdGlvbi5wYWdlX3N0YXJ0ICYmIGJpYnNlY3Rpb24ucGFnZV9sZW5ndGgpIHtcbiAgICAgICAgICAgIGlmIChza2lwc1tpbnB1dFtpXV0pIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGl0ZW0gPSB0aGlzLnJldHJpZXZlSXRlbShpbnB1dFtpXSk7XG4gICAgICAgICAgICBpZiAocGFnZV9pdGVtX2NvdW50ID09PSBiaWJzZWN0aW9uLnBhZ2VfbGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpdGVtID0gaW5wdXRbaV07XG4gICAgICAgICAgICBpZiAoc2tpcHNbaXRlbS5pZF0pIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoYmlic2VjdGlvbikge1xuICAgICAgICAgICAgaW5jbHVkZSA9IHRydWU7XG4gICAgICAgICAgICBpZiAoYmlic2VjdGlvbi5pbmNsdWRlKSB7XG4gICAgICAgICAgICAgICAgaW5jbHVkZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBiaWJzZWN0aW9uLmluY2x1ZGUubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHNwZWMgPSBiaWJzZWN0aW9uLmluY2x1ZGVbal07XG4gICAgICAgICAgICAgICAgICAgIGlmIChldmFsX3NwZWMoc3BlYy52YWx1ZSwgaXRlbVtzcGVjLmZpZWxkXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1ZGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGJpYnNlY3Rpb24uZXhjbHVkZSkge1xuICAgICAgICAgICAgICAgIGFueW1hdGNoID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IGJpYnNlY3Rpb24uZXhjbHVkZS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgc3BlYyA9IGJpYnNlY3Rpb24uZXhjbHVkZVtqXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV2YWxfc3BlYyhzcGVjLnZhbHVlLCBpdGVtW3NwZWMuZmllbGRdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYW55bWF0Y2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFueW1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIGluY2x1ZGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGJpYnNlY3Rpb24uc2VsZWN0KSB7XG4gICAgICAgICAgICAgICAgaW5jbHVkZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGFsbG1hdGNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gYmlic2VjdGlvbi5zZWxlY3QubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHNwZWMgPSBiaWJzZWN0aW9uLnNlbGVjdFtqXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFldmFsX3NwZWMoc3BlYy52YWx1ZSwgaXRlbVtzcGVjLmZpZWxkXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG1hdGNoID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFsbG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIGluY2x1ZGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChiaWJzZWN0aW9uLnF1YXNoKSB7XG4gICAgICAgICAgICAgICAgYWxsbWF0Y2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBiaWJzZWN0aW9uLnF1YXNoLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBzcGVjID0gYmlic2VjdGlvbi5xdWFzaFtqXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFldmFsX3NwZWMoc3BlYy52YWx1ZSwgaXRlbVtzcGVjLmZpZWxkXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG1hdGNoID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFsbG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIGluY2x1ZGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWluY2x1ZGUpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBiaWJfZW50cnkgPSBuZXcgQ1NMLlRva2VuKFwiZ3JvdXBcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgYmliX2VudHJ5LmRlY29yYXRpb25zID0gW1tcIkBiaWJsaW9ncmFwaHlcIiwgXCJlbnRyeVwiXV0uY29uY2F0KHRoaXMuYmlibGlvZ3JhcGh5Lm9wdC5sYXlvdXRfZGVjb3JhdGlvbnMpO1xuICAgICAgICB0aGlzLm91dHB1dC5zdGFydFRhZyhcImJpYl9lbnRyeVwiLCBiaWJfZW50cnkpO1xuICAgICAgICBpZiAoaXRlbS5zeXN0ZW1faWQgJiYgdGhpcy5zeXMuZW1iZWRCaWJsaW9ncmFwaHlFbnRyeSkge1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQuY3VycmVudC52YWx1ZSgpLml0ZW1faWQgPSBpdGVtLnN5c3RlbV9pZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5zeXN0ZW1faWQgPSBpdGVtLmlkO1xuICAgICAgICB9XG4gICAgICAgIHNvcnRlZEl0ZW1zID0gW1t7aWQ6IFwiXCIgKyBpdGVtLmlkfSwgaXRlbV1dO1xuICAgICAgICBlbnRyeV9pdGVtX2lkcyA9IFtdO1xuICAgICAgICBpZiAodGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtpdGVtLmlkXS5tYXN0ZXIgXG4gICAgICAgICAgICAmJiAhKGJpYnNlY3Rpb24gJiYgYmlic2VjdGlvbi5wYWdlX3N0YXJ0ICYmIGJpYnNlY3Rpb24ucGFnZV9sZW5ndGgpKSB7XG4gICAgICAgICAgICBjb2xsYXBzZV9wYXJhbGxlbCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnBhcmFsbGVsLlN0YXJ0Q2l0YXRpb24oc29ydGVkSXRlbXMpO1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQucXVldWVbMF0uc3RyaW5ncy5kZWxpbWl0ZXIgPSBcIiwgXCI7XG4gICAgICAgICAgICB0aGlzLnRtcC50ZXJtX3ByZWRlY2Vzc29yID0gZmFsc2U7XG4gICAgICAgICAgICBlbnRyeV9pdGVtX2lkcy5wdXNoKFwiXCIgKyBDU0wuZ2V0Q2l0ZS5jYWxsKHRoaXMsIGl0ZW0pKTtcbiAgICAgICAgICAgIHNraXBzW2l0ZW0uaWRdID0gdHJ1ZTtcbiAgICAgICAgICAgIHNpYmxpbmdzID0gdGhpcy5yZWdpc3RyeS5yZWdpc3RyeVtpdGVtLmlkXS5zaWJsaW5ncztcbiAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBzaWJsaW5ncy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICB2YXIgayA9IHRoaXMucmVnaXN0cnkucmVnaXN0cnlbaXRlbS5pZF0uc2libGluZ3Nbal07XG4gICAgICAgICAgICAgICAgZXlldGVtID0gdGhpcy5yZXRyaWV2ZUl0ZW0oayk7XG4gICAgICAgICAgICAgICAgZW50cnlfaXRlbV9pZHMucHVzaChcIlwiICsgQ1NMLmdldENpdGUuY2FsbCh0aGlzLCBleWV0ZW0pKTtcbiAgICAgICAgICAgICAgICBza2lwc1tleWV0ZW0uaWRdID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucGFyYWxsZWwuQ29tcG9zZVNldCgpO1xuICAgICAgICAgICAgdGhpcy5wYXJhbGxlbC5QcnVuZU91dHB1dFF1ZXVlKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMucmVnaXN0cnkucmVnaXN0cnlbaXRlbS5pZF0uc2libGluZ3MpIHtcbiAgICAgICAgICAgIHRoaXMucGFyYWxsZWwuU3RhcnRDaXRhdGlvbihzb3J0ZWRJdGVtcyk7XG4gICAgICAgICAgICB0aGlzLnRtcC50ZXJtX3ByZWRlY2Vzc29yID0gZmFsc2U7XG4gICAgICAgICAgICBlbnRyeV9pdGVtX2lkcy5wdXNoKFwiXCIgKyBDU0wuZ2V0Q2l0ZS5jYWxsKHRoaXMsIGl0ZW0pKTtcbiAgICAgICAgICAgIGlmIChiaWJzZWN0aW9uICYmIGJpYnNlY3Rpb24ucGFnZV9zdGFydCAmJiBiaWJzZWN0aW9uLnBhZ2VfbGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgcGFnZV9pdGVtX2NvdW50ICs9IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZW50cnlfaXRlbV9kYXRhLnB1c2goXCJcIik7XG4gICAgICAgIHRoaXMudG1wLmJpYmxpb2dyYXBoeV9wb3MgKz0gMTtcbiAgICAgICAgcHJvY2Vzc2VkX2l0ZW1faWRzLnB1c2goZW50cnlfaXRlbV9pZHMpO1xuICAgICAgICB0aGlzLm91dHB1dC5lbmRUYWcoXCJiaWJfZW50cnlcIik7XG4gICAgICAgIGlmICh0aGlzLm91dHB1dC5xdWV1ZVswXS5ibG9icy5sZW5ndGggJiYgdGhpcy5vdXRwdXQucXVldWVbMF0uYmxvYnNbMF0uYmxvYnMubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAoY29sbGFwc2VfcGFyYWxsZWwgfHwgIXRoaXMub3V0cHV0LnF1ZXVlWzBdLmJsb2JzWzBdLmJsb2JzWzBdLnN0cmluZ3MpIHtcbiAgICAgICAgICAgICAgICB0b3BibG9icyA9IHRoaXMub3V0cHV0LnF1ZXVlWzBdLmJsb2JzO1xuICAgICAgICAgICAgICAgIGNvbGxhcHNlX3BhcmFsbGVsID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRvcGJsb2JzID0gdGhpcy5vdXRwdXQucXVldWVbMF0uYmxvYnNbMF0uYmxvYnM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0b3BibG9ic1swXS5zdHJpbmdzLnByZWZpeCA9IHRoaXMuYmlibGlvZ3JhcGh5Lm9wdC5sYXlvdXRfcHJlZml4ICsgdG9wYmxvYnNbMF0uc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49dGhpcy5vdXRwdXQucXVldWUubGVuZ3RoO2o8amxlbjtqKz0xKSB7XG4gICAgICAgICAgICBDU0wuT3V0cHV0LlF1ZXVlLnB1cmdlRW1wdHlCbG9icyh0aGlzLm91dHB1dC5xdWV1ZVtqXSk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49dGhpcy5vdXRwdXQucXVldWUubGVuZ3RoO2o8amxlbjtqKz0xKSB7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QudXB3YXJkKHRoaXMub3V0cHV0LnF1ZXVlW2pdKTtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0LmFkanVzdC5sZWZ0d2FyZCh0aGlzLm91dHB1dC5xdWV1ZVtqXSk7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QuZG93bndhcmQodGhpcy5vdXRwdXQucXVldWVbal0sdHJ1ZSk7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hZGp1c3QuZml4KHRoaXMub3V0cHV0LnF1ZXVlW2pdKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcmVzID0gdGhpcy5vdXRwdXQuc3RyaW5nKHRoaXMsIHRoaXMub3V0cHV0LnF1ZXVlKVswXTtcbiAgICAgICAgaWYgKCFyZXMgJiYgdGhpcy5vcHQudXBkYXRlX21vZGUgPT09IENTTC5OVU1FUklDKSB7XG4gICAgICAgICAgICB2YXIgZXJyID0gKHJldC5sZW5ndGggKyAxKSArIFwiLiBbQ1NMIFNUWUxFIEVSUk9SOiByZWZlcmVuY2Ugd2l0aCBubyBwcmludGVkIGZvcm0uXVwiXG4gICAgICAgICAgICByZXMgPSBDU0wuT3V0cHV0LkZvcm1hdHNbdGhpcy5vcHQubW9kZV1bXCJAYmlibGlvZ3JhcGh5L2VudHJ5XCJdKHRoaXMsIGVycikgXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgcmV0LnB1c2gocmVzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgZG9uZSA9IGZhbHNlO1xuICAgIGlmIChiaWJzZWN0aW9uICYmIGJpYnNlY3Rpb24ucGFnZV9zdGFydCAmJiBiaWJzZWN0aW9uLnBhZ2VfbGVuZ3RoKSB7XG4gICAgICAgIHZhciBsYXN0X2V4cGVjdGVkX2lkID0gaW5wdXQuc2xpY2UoLTEpWzBdO1xuICAgICAgICB2YXIgbGFzdF9zZWVuX2lkID0gcHJvY2Vzc2VkX2l0ZW1faWRzLnNsaWNlKC0xKVswXTtcbiAgICAgICAgaWYgKCFsYXN0X2V4cGVjdGVkX2lkIHx8ICFsYXN0X3NlZW5faWQgfHwgbGFzdF9leHBlY3RlZF9pZCA9PSBsYXN0X3NlZW5faWQpIHtcbiAgICAgICAgICAgIGRvbmUgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMudG1wLmRpc2FtYmlnX292ZXJyaWRlID0gZmFsc2U7XG4gICAgcmV0dXJuIFtwcm9jZXNzZWRfaXRlbV9pZHMsIHJldCwgZG9uZV07XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuRW5naW5lLnByb3RvdHlwZS5zZXRDaXRhdGlvbklkID0gZnVuY3Rpb24gKGNpdGF0aW9uLCBmb3JjZSkge1xuICAgIHZhciByZXQsIGlkLCBkaXJlY3Rpb247XG4gICAgcmV0ID0gZmFsc2U7XG4gICAgaWYgKCFjaXRhdGlvbi5jaXRhdGlvbklEIHx8IGZvcmNlKSB7XG4gICAgICAgIGlkID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTAwMDAwMDAwMDAwMDAwKTtcbiAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgIGRpcmVjdGlvbiA9IDA7XG4gICAgICAgICAgICBpZiAoIXRoaXMucmVnaXN0cnkuY2l0YXRpb25yZWcuY2l0YXRpb25CeUlkW2lkXSkge1xuICAgICAgICAgICAgICAgIGNpdGF0aW9uLmNpdGF0aW9uSUQgPSBcImFcIiArIGlkLnRvU3RyaW5nKDMyKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWRpcmVjdGlvbiAmJiBpZCA8IDUwMDAwMDAwMDAwMDAwKSB7XG4gICAgICAgICAgICAgICAgZGlyZWN0aW9uID0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZGlyZWN0aW9uID0gLTE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAxKSB7XG4gICAgICAgICAgICAgICAgaWQgKz0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWQgKz0gLTE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0ID0gXCJcIiArIGlkO1xuICAgIH1cbiAgICB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJZFtjaXRhdGlvbi5jaXRhdGlvbklEXSA9IGNpdGF0aW9uO1xuICAgIHJldHVybiByZXQ7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuRW5naW5lLnByb3RvdHlwZS5yZWJ1aWxkUHJvY2Vzc29yU3RhdGUgPSBmdW5jdGlvbiAoY2l0YXRpb25zLCBtb2RlLCB1bmNpdGVkSXRlbUlEcykge1xuICAgIGlmICghY2l0YXRpb25zKSB7XG4gICAgICAgIGNpdGF0aW9ucyA9IFtdO1xuICAgIH1cbiAgICBpZiAoIW1vZGUpIHtcbiAgICAgICAgbW9kZSA9ICdodG1sJztcbiAgICB9XG4gICAgdmFyIGRvbmVJRHMgPSB7fTtcbiAgICB2YXIgaXRlbUlEcyA9IFtdO1xuICAgIGZvciAodmFyIGk9MCxpbGVuPWNpdGF0aW9ucy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49Y2l0YXRpb25zW2ldLmNpdGF0aW9uSXRlbXMubGVuZ3RoO2o8amxlbjtqKz0xKSB7XG4gICAgICAgICAgICB2YXIgaXRlbUlEID0gXCJcIiArIGNpdGF0aW9uc1tpXS5jaXRhdGlvbkl0ZW1zW2pdLmlkO1xuICAgICAgICAgICAgaWYgKCFkb25lSURzW2l0ZW1JRF0pIHtcbiAgICAgICAgICAgICAgICBpdGVtSURzLnB1c2goaXRlbUlEKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRvbmVJRHNbaXRlbUlEXSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy51cGRhdGVJdGVtcyhpdGVtSURzKTtcbiAgICB2YXIgcHJlID0gW107XG4gICAgdmFyIHBvc3QgPSBbXTtcbiAgICB2YXIgcmV0ID0gW107XG4gICAgdmFyIG9sZE1vZGUgPSB0aGlzLm9wdC5tb2RlO1xuICAgIHRoaXMuc2V0T3V0cHV0Rm9ybWF0KG1vZGUpO1xuICAgIGZvciAodmFyIGk9MCxpbGVuPWNpdGF0aW9ucy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgdmFyIHJlcyA9IHRoaXMucHJvY2Vzc0NpdGF0aW9uQ2x1c3RlcihjaXRhdGlvbnNbaV0scHJlLHBvc3QsQ1NMLkFTU1VNRV9BTExfSVRFTVNfUkVHSVNURVJFRCk7XG4gICAgICAgIHByZS5wdXNoKFtjaXRhdGlvbnNbaV0uY2l0YXRpb25JRCxjaXRhdGlvbnNbaV0ucHJvcGVydGllcy5ub3RlSW5kZXhdKTtcbiAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49cmVzWzFdLmxlbmd0aDtqPGpsZW47ais9MSkge1xuICAgICAgICAgICAgdmFyIGluZGV4ID0gcmVzWzFdW2pdWzBdO1xuICAgICAgICAgICAgcmV0W2luZGV4XSA9IFtcbiAgICAgICAgICAgICAgICBwcmVbaW5kZXhdWzBdLFxuICAgICAgICAgICAgICAgIHByZVtpbmRleF1bMV0sXG4gICAgICAgICAgICAgICAgcmVzWzFdW2pdWzFdXG4gICAgICAgICAgICBdO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMudXBkYXRlVW5jaXRlZEl0ZW1zKHVuY2l0ZWRJdGVtSURzKTtcbiAgICB0aGlzLnNldE91dHB1dEZvcm1hdChvbGRNb2RlKTtcbiAgICByZXR1cm4gcmV0O1xufVxuQ1NMLkVuZ2luZS5wcm90b3R5cGUucmVzdG9yZVByb2Nlc3NvclN0YXRlID0gZnVuY3Rpb24gKGNpdGF0aW9ucykge1xuICAgIHZhciBpLCBpbGVuLCBqLCBqbGVuLCBpdGVtLCBJdGVtLCBuZXdpdGVtLCBjaXRhdGlvbkxpc3QsIGl0ZW1MaXN0LCBzb3J0ZWRJdGVtcztcbiAgICBjaXRhdGlvbkxpc3QgPSBbXTtcbiAgICBpdGVtTGlzdCA9IFtdO1xuICAgIGlmICghY2l0YXRpb25zKSB7XG4gICAgICAgIGNpdGF0aW9ucyA9IFtdO1xuICAgIH1cbiAgICB2YXIgaW5kZXhOdW1iZXJzID0gW107XG4gICAgdmFyIGNpdGF0aW9uSWRzID0ge307XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IGNpdGF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKGNpdGF0aW9uSWRzW2NpdGF0aW9uc1tpXS5jaXRhdGlvbklEXSkge1xuICAgICAgICAgICAgdGhpcy5zZXRDaXRhdGlvbklkKGNpdGF0aW9uc1tpXSwgdHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgY2l0YXRpb25JZHNbY2l0YXRpb25zW2ldLmNpdGF0aW9uSURdID0gdHJ1ZTtcbiAgICAgICAgaW5kZXhOdW1iZXJzLnB1c2goY2l0YXRpb25zW2ldLnByb3BlcnRpZXMuaW5kZXgpO1xuICAgIH1cbiAgICB2YXIgb2xkQ2l0YXRpb25zID0gY2l0YXRpb25zLnNsaWNlKCk7XG4gICAgb2xkQ2l0YXRpb25zLnNvcnQoXG4gICAgICAgIGZ1bmN0aW9uIChhLGIpIHtcbiAgICAgICAgICAgIGlmIChhLnByb3BlcnRpZXMuaW5kZXggPCBiLnByb3BlcnRpZXMuaW5kZXgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGEucHJvcGVydGllcy5pbmRleCA+IGIucHJvcGVydGllcy5pbmRleCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICk7XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IG9sZENpdGF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgb2xkQ2l0YXRpb25zW2ldLnByb3BlcnRpZXMuaW5kZXggPSBpO1xuICAgIH1cbiAgICBmb3IgKGkgPSAwLCBpbGVuID0gb2xkQ2l0YXRpb25zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBzb3J0ZWRJdGVtcyA9IFtdO1xuICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gb2xkQ2l0YXRpb25zW2ldLmNpdGF0aW9uSXRlbXMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICBpdGVtID0gb2xkQ2l0YXRpb25zW2ldLmNpdGF0aW9uSXRlbXNbal07XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGl0ZW0uc29ydGtleXMpIHtcbiAgICAgICAgICAgICAgICBpdGVtLnNvcnRrZXlzID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBJdGVtID0gdGhpcy5yZXRyaWV2ZUl0ZW0oXCJcIiArIGl0ZW0uaWQpO1xuICAgICAgICAgICAgbmV3aXRlbSA9IFtJdGVtLCBpdGVtXTtcbiAgICAgICAgICAgIHNvcnRlZEl0ZW1zLnB1c2gobmV3aXRlbSk7XG4gICAgICAgICAgICBvbGRDaXRhdGlvbnNbaV0uY2l0YXRpb25JdGVtc1tqXS5pdGVtID0gSXRlbTtcbiAgICAgICAgICAgIGl0ZW1MaXN0LnB1c2goXCJcIiArIGl0ZW0uaWQpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghb2xkQ2l0YXRpb25zW2ldLnByb3BlcnRpZXMudW5zb3J0ZWQpIHtcbiAgICAgICAgICAgIHNvcnRlZEl0ZW1zLnNvcnQodGhpcy5jaXRhdGlvbi5zcnQuY29tcGFyZUNvbXBvc2l0ZUtleXMpO1xuICAgICAgICB9XG4gICAgICAgIG9sZENpdGF0aW9uc1tpXS5zb3J0ZWRJdGVtcyA9IHNvcnRlZEl0ZW1zO1xuICAgICAgICB0aGlzLnJlZ2lzdHJ5LmNpdGF0aW9ucmVnLmNpdGF0aW9uQnlJZFtvbGRDaXRhdGlvbnNbaV0uY2l0YXRpb25JRF0gPSBvbGRDaXRhdGlvbnNbaV07XG4gICAgfVxuICAgIHRoaXMudXBkYXRlSXRlbXMoaXRlbUxpc3QpO1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBjaXRhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGNpdGF0aW9uTGlzdC5wdXNoKFtcIlwiICsgY2l0YXRpb25zW2ldLmNpdGF0aW9uSUQsIGNpdGF0aW9uc1tpXS5wcm9wZXJ0aWVzLm5vdGVJbmRleF0pO1xuICAgIH1cbiAgICB2YXIgcmV0ID0gW107XG4gICAgaWYgKGNpdGF0aW9ucyAmJiBjaXRhdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgIHJldCA9IHRoaXMucHJvY2Vzc0NpdGF0aW9uQ2x1c3RlcihjaXRhdGlvbnNbMF0sIFtdLCBjaXRhdGlvbkxpc3Quc2xpY2UoMSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucmVnaXN0cnkgPSBuZXcgQ1NMLlJlZ2lzdHJ5KHRoaXMpO1xuICAgICAgICB0aGlzLnRtcCA9IG5ldyBDU0wuRW5naW5lLlRtcCgpO1xuICAgICAgICB0aGlzLmRpc2FtYmlndWF0ZSA9IG5ldyBDU0wuRGlzYW1iaWd1YXRpb24odGhpcyk7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUudXBkYXRlSXRlbXMgPSBmdW5jdGlvbiAoaWRMaXN0LCBub3NvcnQsIHJlcnVuX2FtYmlncywgaW1wbGljaXRVcGRhdGUpIHtcbiAgICB2YXIgZGVidWcgPSBmYWxzZTtcbiAgICB2YXIgb2xkQXJlYSA9IHRoaXMudG1wLmFyZWE7XG4gICAgdmFyIG9sZFJvb3QgPSB0aGlzLnRtcC5yb290O1xuICAgIHZhciBvbGRFeHRlbnNpb24gPSB0aGlzLnRtcC5leHRlbnNpb247XG4gICAgdGhpcy50bXAuYXJlYSA9IFwiY2l0YXRpb25cIjtcbiAgICB0aGlzLnRtcC5yb290ID0gXCJjaXRhdGlvblwiO1xuICAgIHRoaXMudG1wLmV4dGVuc2lvbiA9IFwiXCI7XG4gICAgaWYgKCFpbXBsaWNpdFVwZGF0ZSkge1xuICAgICAgICB0aGlzLnRtcC5sb2FkZWRJdGVtSURzID0ge307XG4gICAgfVxuICAgIHRoaXMucmVnaXN0cnkuaW5pdChpZExpc3QpO1xuXHRpZiAocmVydW5fYW1iaWdzKSB7XG5cdFx0Zm9yICh2YXIgYW1iaWcgaW4gdGhpcy5yZWdpc3RyeS5hbWJpZ2NpdGVzKSB7XG5cdFx0XHR0aGlzLnJlZ2lzdHJ5LmFtYmlnc1RvdWNoZWRbYW1iaWddID0gdHJ1ZTtcblx0XHR9XG5cdH1cbiAgICB0aGlzLnJlZ2lzdHJ5LmRvZGVsZXRlcyh0aGlzLnJlZ2lzdHJ5Lm15aGFzaCk7XG4gICAgdGhpcy5yZWdpc3RyeS5kb2luc2VydHModGhpcy5yZWdpc3RyeS5teWxpc3QpO1xuICAgIHRoaXMucmVnaXN0cnkuZG9yZWZyZXNoZXMoKTtcbiAgICB0aGlzLnJlZ2lzdHJ5LnJlYnVpbGRsaXN0KCk7XG4gICAgdGhpcy5yZWdpc3RyeS5zZXRzb3J0a2V5cygpO1xuICAgIHRoaXMucmVnaXN0cnkuc2V0ZGlzYW1iaWdzKCk7XG4gICAgaWYgKCFub3NvcnQpIHtcbiAgICAgICAgdGhpcy5yZWdpc3RyeS5zb3J0dG9rZW5zKCk7XG4gICAgfVxuICAgIHRoaXMucmVnaXN0cnkucmVudW1iZXIoKTtcbiAgICB0aGlzLnRtcC5leHRlbnNpb24gPSBvbGRFeHRlbnNpb247XG4gICAgdGhpcy50bXAuYXJlYSA9IG9sZEFyZWE7XG4gICAgdGhpcy50bXAucm9vdCA9IG9sZFJvb3Q7XG4gICAgcmV0dXJuIHRoaXMucmVnaXN0cnkuZ2V0U29ydGVkSWRzKCk7XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUudXBkYXRlVW5jaXRlZEl0ZW1zID0gZnVuY3Rpb24gKGlkTGlzdCwgbm9zb3J0KSB7XG4gICAgdmFyIGRlYnVnID0gZmFsc2U7XG4gICAgdmFyIG9sZEFyZWEgPSB0aGlzLnRtcC5hcmVhO1xuICAgIHZhciBvbGRSb290ID0gdGhpcy50bXAucm9vdDtcbiAgICB2YXIgb2xkRXh0ZW5zaW9uID0gdGhpcy50bXAuZXh0ZW5zaW9uO1xuICAgIHRoaXMudG1wLmFyZWEgPSBcImNpdGF0aW9uXCI7XG4gICAgdGhpcy50bXAucm9vdCA9IFwiY2l0YXRpb25cIlxuICAgIHRoaXMudG1wLmV4dGVuc2lvbiA9IFwiXCJcbiAgICB0aGlzLnRtcC5sb2FkZWRJdGVtSURzID0ge307XG4gICAgaWYgKCFpZExpc3QpIHtcbiAgICAgICAgaWRMaXN0ID0gW107XG4gICAgfVxuICAgIGlmIChcIm9iamVjdFwiID09IHR5cGVvZiBpZExpc3QpIHtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT0gdHlwZW9mIGlkTGlzdC5sZW5ndGgpIHtcbiAgICAgICAgICAgIHZhciBpZEhhc2ggPSBpZExpc3Q7XG4gICAgICAgICAgICBpZExpc3QgPSBbXTtcbiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBpZEhhc2gpIHtcbiAgICAgICAgICAgICAgICBpZExpc3QucHVzaChrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKFwibnVtYmVyXCIgPT0gdHlwZW9mIGlkTGlzdC5sZW5ndGgpIHtcbiAgICAgICAgICAgIHZhciBpZEhhc2ggPSB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWlkTGlzdC5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgICAgICBpZEhhc2hbaWRMaXN0W2ldXSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5yZWdpc3RyeS5pbml0KGlkTGlzdCwgdHJ1ZSk7XG4gICAgdGhpcy5yZWdpc3RyeS5kb3B1cmdlKGlkSGFzaCk7XG4gICAgdGhpcy5yZWdpc3RyeS5kb2luc2VydHModGhpcy5yZWdpc3RyeS5teWxpc3QpO1xuICAgIHRoaXMucmVnaXN0cnkuZG9yZWZyZXNoZXMoKTtcbiAgICB0aGlzLnJlZ2lzdHJ5LnJlYnVpbGRsaXN0KCk7XG4gICAgdGhpcy5yZWdpc3RyeS5zZXRzb3J0a2V5cygpO1xuICAgIHRoaXMucmVnaXN0cnkuc2V0ZGlzYW1iaWdzKCk7XG4gICAgaWYgKCFub3NvcnQpIHtcbiAgICAgICAgdGhpcy5yZWdpc3RyeS5zb3J0dG9rZW5zKCk7XG4gICAgfVxuICAgIHRoaXMucmVnaXN0cnkucmVudW1iZXIoKTtcbiAgICB0aGlzLnRtcC5leHRlbnNpb24gPSBvbGRFeHRlbnNpb247XG4gICAgdGhpcy50bXAuYXJlYSA9IG9sZEFyZWE7XG4gICAgdGhpcy50bXAucm9vdCA9IG9sZFJvb3Q7XG4gICAgcmV0dXJuIHRoaXMucmVnaXN0cnkuZ2V0U29ydGVkSWRzKCk7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wubG9jYWxlUmVzb2x2ZSA9IGZ1bmN0aW9uIChsYW5nc3RyLCBkZWZhdWx0TG9jYWxlKSB7XG4gICAgdmFyIHJldCwgbGFuZ2xzdDtcbiAgICBpZiAoIWRlZmF1bHRMb2NhbGUpIHtcbiAgICAgICAgZGVmYXVsdExvY2FsZSA9IFwiZW4tVVNcIjtcbiAgICB9XG4gICAgaWYgKCFsYW5nc3RyKSB7XG4gICAgICAgIGxhbmdzdHIgPSBkZWZhdWx0TG9jYWxlO1xuICAgIH1cbiAgICByZXQgPSB7fTtcbiAgICBsYW5nbHN0ID0gbGFuZ3N0ci5zcGxpdCgvW1xcLV9dLyk7XG4gICAgcmV0LmJhc2UgPSBDU0wuTEFOR19CQVNFU1tsYW5nbHN0WzBdXTtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHJldC5iYXNlKSB7XG4gICAgICAgIHJldHVybiB7YmFzZTpkZWZhdWx0TG9jYWxlLCBiZXN0OmxhbmdzdHIsIGJhcmU6bGFuZ2xzdFswXX07XG4gICAgfVxuICAgIGlmIChsYW5nbHN0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgICByZXQuZ2VuZXJpYyA9IHRydWU7XG4gICAgfVxuICAgIGlmIChsYW5nbHN0Lmxlbmd0aCA9PT0gMSB8fCBsYW5nbHN0WzFdID09PSBcInhcIikge1xuICAgICAgICByZXQuYmVzdCA9IHJldC5iYXNlLnJlcGxhY2UoXCJfXCIsIFwiLVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXQuYmVzdCA9IGxhbmdsc3Quc2xpY2UoMCwgMikuam9pbihcIi1cIik7XG4gICAgfVxuICAgIHJldC5iYXNlID0gcmV0LmJhc2UucmVwbGFjZShcIl9cIiwgXCItXCIpO1xuICAgIHJldC5iYXJlID0gbGFuZ2xzdFswXTtcbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmxvY2FsZUNvbmZpZ3VyZSA9IGZ1bmN0aW9uIChsYW5nc3BlYywgYmVTaHkpIHtcbiAgICB2YXIgbG9jYWxleG1sO1xuICAgIGlmIChiZVNoeSAmJiB0aGlzLmxvY2FsZVtsYW5nc3BlYy5iZXN0XSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChsYW5nc3BlYy5iZXN0ID09PSBcImVuLVVTXCIpIHtcbiAgICAgICAgbG9jYWxleG1sID0gQ1NMLnNldHVwWG1sKHRoaXMuc3lzLnJldHJpZXZlTG9jYWxlKFwiZW4tVVNcIikpO1xuICAgICAgICB0aGlzLmxvY2FsZVNldChsb2NhbGV4bWwsIFwiZW4tVVNcIiwgbGFuZ3NwZWMuYmVzdCk7XG4gICAgfSBlbHNlIGlmIChsYW5nc3BlYy5iZXN0ICE9PSBcImVuLVVTXCIpIHtcbiAgICAgICAgaWYgKGxhbmdzcGVjLmJhc2UgIT09IGxhbmdzcGVjLmJlc3QpIHtcbiAgICAgICAgICAgIGxvY2FsZXhtbCA9IENTTC5zZXR1cFhtbCh0aGlzLnN5cy5yZXRyaWV2ZUxvY2FsZShsYW5nc3BlYy5iYXNlKSk7XG4gICAgICAgICAgICB0aGlzLmxvY2FsZVNldChsb2NhbGV4bWwsIGxhbmdzcGVjLmJhc2UsIGxhbmdzcGVjLmJlc3QpO1xuICAgICAgICB9XG4gICAgICAgIGxvY2FsZXhtbCA9IENTTC5zZXR1cFhtbCh0aGlzLnN5cy5yZXRyaWV2ZUxvY2FsZShsYW5nc3BlYy5iZXN0KSk7XG4gICAgICAgIHRoaXMubG9jYWxlU2V0KGxvY2FsZXhtbCwgbGFuZ3NwZWMuYmVzdCwgbGFuZ3NwZWMuYmVzdCk7ICAgICAgICBcbiAgICB9XG4gICAgdGhpcy5sb2NhbGVTZXQodGhpcy5jc2xYbWwsIFwiXCIsIGxhbmdzcGVjLmJlc3QpO1xuICAgIHRoaXMubG9jYWxlU2V0KHRoaXMuY3NsWG1sLCBsYW5nc3BlYy5iYXJlLCBsYW5nc3BlYy5iZXN0KTtcbiAgICBpZiAobGFuZ3NwZWMuYmFzZSAhPT0gbGFuZ3NwZWMuYmVzdCkge1xuICAgICAgICB0aGlzLmxvY2FsZVNldCh0aGlzLmNzbFhtbCwgbGFuZ3NwZWMuYmFzZSwgbGFuZ3NwZWMuYmVzdCk7XG4gICAgfVxuICAgIHRoaXMubG9jYWxlU2V0KHRoaXMuY3NsWG1sLCBsYW5nc3BlYy5iZXN0LCBsYW5nc3BlYy5iZXN0KTtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMubG9jYWxlW2xhbmdzcGVjLmJlc3RdLnRlcm1zW1wicGFnZS1yYW5nZS1kZWxpbWl0ZXJcIl0pIHtcbiAgICAgICAgaWYgKFtcImZyXCIsIFwicHRcIl0uaW5kZXhPZihsYW5nc3BlYy5iZXN0LnNsaWNlKDAsIDIpLnRvTG93ZXJDYXNlKCkpID4gLTEpIHtcbiAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdzcGVjLmJlc3RdLnRlcm1zW1wicGFnZS1yYW5nZS1kZWxpbWl0ZXJcIl0gPSBcIi1cIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdzcGVjLmJlc3RdLnRlcm1zW1wicGFnZS1yYW5nZS1kZWxpbWl0ZXJcIl0gPSBcIlxcdTIwMTNcIjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMubG9jYWxlW2xhbmdzcGVjLmJlc3RdLnRlcm1zW1wieWVhci1yYW5nZS1kZWxpbWl0ZXJcIl0pIHtcbiAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ3NwZWMuYmVzdF0udGVybXNbXCJ5ZWFyLXJhbmdlLWRlbGltaXRlclwiXSA9IFwiXFx1MjAxM1wiO1xuICAgIH1cbiAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMubG9jYWxlW2xhbmdzcGVjLmJlc3RdLnRlcm1zW1wiY2l0YXRpb24tcmFuZ2UtZGVsaW1pdGVyXCJdKSB7XG4gICAgICAgIHRoaXMubG9jYWxlW2xhbmdzcGVjLmJlc3RdLnRlcm1zW1wiY2l0YXRpb24tcmFuZ2UtZGVsaW1pdGVyXCJdID0gXCJcXHUyMDEzXCI7XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLm5vcm1hbGl6ZV9sYW5nX2tleXNfdG9fbG93ZXJjYXNlKSB7XG4gICAgICAgIHZhciBsb2NhbGVMaXN0cyA9IFtcImRlZmF1bHQtbG9jYWxlXCIsXCJsb2NhbGUtc29ydFwiLFwibG9jYWxlLXRyYW5zbGl0XCIsXCJsb2NhbGUtdHJhbnNsYXRcIl07XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWxvY2FsZUxpc3RzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49dGhpcy5vcHRbbG9jYWxlTGlzdHNbaV1dLmxlbmd0aDtqPGpsZW47ais9MSkge1xuICAgICAgICAgICAgICAgIHRoaXMub3B0W2xvY2FsZUxpc3RzW2ldXVtqXSA9IHRoaXMub3B0W2xvY2FsZUxpc3RzW2ldXVtqXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMub3B0LmxhbmcgPSB0aGlzLm9wdC5sYW5nLnRvTG93ZXJDYXNlKCk7XG4gICAgfVxufTtcbkNTTC5FbmdpbmUucHJvdG90eXBlLmxvY2FsZVNldCA9IGZ1bmN0aW9uIChteXhtbCwgbGFuZ19pbiwgbGFuZ19vdXQpIHtcbiAgICB2YXIgYmxvYiwgbG9jYWxlLCBub2RlcywgYXR0cmlidXRlcywgcG9zLCBwcG9zLCB0ZXJtLCBmb3JtLCB0ZXJtbmFtZSwgc3R5bGVvcHRzLCBhdHRyLCBkYXRlLCBhdHRybmFtZSwgbGVuLCBnZW5kZXJmb3JtLCB0YXJnZXQsIGksIGlsZW47XG4gICAgbGFuZ19pbiA9IGxhbmdfaW4ucmVwbGFjZShcIl9cIiwgXCItXCIpO1xuICAgIGxhbmdfb3V0ID0gbGFuZ19vdXQucmVwbGFjZShcIl9cIiwgXCItXCIpO1xuICAgIGlmICh0aGlzLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLm5vcm1hbGl6ZV9sYW5nX2tleXNfdG9fbG93ZXJjYXNlKSB7XG4gICAgICAgIGxhbmdfaW4gPSBsYW5nX2luLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGxhbmdfb3V0ID0gbGFuZ19vdXQudG9Mb3dlckNhc2UoKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmxvY2FsZVtsYW5nX291dF0pIHtcbiAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdID0ge307XG4gICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtcyA9IHt9O1xuICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0cyA9IHt9O1xuICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1tcInNraXAtd29yZHNcIl0gPSBDU0wuU0tJUF9XT1JEUztcbiAgICAgICAgaWYgKCF0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1tcImxlYWRpbmctbm9pc2Utd29yZHNcIl0pIHtcbiAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcHRzW1wibGVhZGluZy1ub2lzZS13b3Jkc1wiXSA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5kYXRlcyA9IHt9O1xuICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3JkID0geycxLjAuMSc6ZmFsc2Usa2V5czp7fX07XG4gICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XVtcIm5vdW4tZ2VuZGVyc1wiXSA9IHt9O1xuICAgIH1cbiAgICBsb2NhbGUgPSBteXhtbC5tYWtlWG1sKCk7XG4gICAgaWYgKG15eG1sLm5vZGVOYW1lSXMobXl4bWwuZGF0YU9iaiwgJ2xvY2FsZScpKSB7XG4gICAgICAgIGxvY2FsZSA9IG15eG1sLmRhdGFPYmo7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbm9kZXMgPSBteXhtbC5nZXROb2Rlc0J5TmFtZShteXhtbC5kYXRhT2JqLCBcImxvY2FsZVwiKTtcbiAgICAgICAgZm9yIChwb3MgPSAwLCBsZW4gPSBteXhtbC5udW1iZXJvZm5vZGVzKG5vZGVzKTsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgYmxvYiA9IG5vZGVzW3Bvc107XG4gICAgICAgICAgICBpZiAobXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUoYmxvYiwgJ2xhbmcnLCAneG1sJykgPT09IGxhbmdfaW4pIHtcbiAgICAgICAgICAgICAgICBsb2NhbGUgPSBibG9iO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIG5vZGVzID0gbXl4bWwuZ2V0Tm9kZXNCeU5hbWUobG9jYWxlLCAndHlwZScpO1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBteXhtbC5udW1iZXJvZm5vZGVzKG5vZGVzKTsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgdHlwZW5vZGUgPSBub2Rlc1tpXTtcbiAgICAgICAgdmFyIHR5cGUgPSBteXhtbC5nZXRBdHRyaWJ1dGVWYWx1ZSh0eXBlbm9kZSwgJ25hbWUnKTtcbiAgICAgICAgdmFyIGdlbmRlciA9IG15eG1sLmdldEF0dHJpYnV0ZVZhbHVlKHR5cGVub2RlLCAnZ2VuZGVyJyk7XG4gICAgICAgIHRoaXMub3B0LmdlbmRlclt0eXBlXSA9IGdlbmRlcjtcbiAgICB9XG4gICAgdmFyIGhhc0NzbE9yZGluYWxzMTAxID0gbXl4bWwuZ2V0Tm9kZXNCeU5hbWUobG9jYWxlLCAndGVybScsICdvcmRpbmFsJykubGVuZ3RoO1xuICAgIGlmIChoYXNDc2xPcmRpbmFsczEwMSkge1xuICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9yZC5rZXlzKSB7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9yZCA9IHtcIjEuMC4xXCI6ZmFsc2Usa2V5czp7fX07XG4gICAgfVxuICAgIG5vZGVzID0gbXl4bWwuZ2V0Tm9kZXNCeU5hbWUobG9jYWxlLCAndGVybScpO1xuICAgIHZhciBvcmRpbmFsczEwMSA9IHtcImxhc3QtZGlnaXRcIjp7fSxcImxhc3QtdHdvLWRpZ2l0c1wiOnt9LFwid2hvbGUtbnVtYmVyXCI6e319O1xuICAgIHZhciBvcmRpbmFsczEwMV90b2dnbGUgPSBmYWxzZTtcbiAgICB2YXIgZ2VuZGVyaXplZF90ZXJtcyA9IHt9O1xuICAgIGZvciAocG9zID0gMCwgbGVuID0gbXl4bWwubnVtYmVyb2Zub2Rlcyhub2Rlcyk7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgdGVybSA9IG5vZGVzW3Bvc107XG4gICAgICAgIHRlcm1uYW1lID0gbXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUodGVybSwgJ25hbWUnKTtcbiAgICAgICAgaWYgKHRlcm1uYW1lID09PSBcInN1YiB2ZXJib1wiKSB7XG4gICAgICAgICAgICB0ZXJtbmFtZSA9IFwic3ViLXZlcmJvXCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRlcm1uYW1lLnNsaWNlKDAsNykgPT09IFwib3JkaW5hbFwiKSB7XG4gICAgICAgICAgICB2YXIgdGVybXN0cmluZyA9IG15eG1sLmdldE5vZGVWYWx1ZSh0ZXJtKTtcbiAgICAgICAgICAgIGlmICh0ZXJtbmFtZSA9PT0gXCJvcmRpbmFsXCIpIHtcbiAgICAgICAgICAgICAgICBvcmRpbmFsczEwMV90b2dnbGUgPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBteXhtbC5nZXRBdHRyaWJ1dGVWYWx1ZSh0ZXJtLCAnbWF0Y2gnKTtcbiAgICAgICAgICAgICAgICB2YXIgdGVybXN0dWIgPSB0ZXJtbmFtZS5zbGljZSg4KTtcbiAgICAgICAgICAgICAgICB2YXIgZ2VuZGVyZm9ybSA9IG15eG1sLmdldEF0dHJpYnV0ZVZhbHVlKHRlcm0sICdnZW5kZXItZm9ybScpO1xuICAgICAgICAgICAgICAgIGlmICghZ2VuZGVyZm9ybSkge1xuICAgICAgICAgICAgICAgICAgICBnZW5kZXJmb3JtID0gXCJuZXV0ZXJcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFtYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IFwibGFzdC10d28tZGlnaXRzXCI7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0ZXJtc3R1Yi5zbGljZSgwLDEpID09PSBcIjBcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBcImxhc3QtZGlnaXRcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGVybXN0dWIuc2xpY2UoMCwxKSA9PT0gXCIwXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGVybXN0dWIgPSB0ZXJtc3R1Yi5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFvcmRpbmFsczEwMVttYXRjaF1bdGVybXN0dWJdKSB7XG4gICAgICAgICAgICAgICAgICAgIG9yZGluYWxzMTAxW21hdGNoXVt0ZXJtc3R1Yl0gPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgb3JkaW5hbHMxMDFbbWF0Y2hdW3Rlcm1zdHViXVtnZW5kZXJmb3JtXSA9IHRlcm1uYW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLm9yZC5rZXlzW3Rlcm1uYW1lXSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLmxvY2FsZVtsYW5nX291dF0udGVybXNbdGVybW5hbWVdKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0udGVybXNbdGVybW5hbWVdID0ge307XG4gICAgICAgIH1cbiAgICAgICAgZm9ybSA9IFwibG9uZ1wiO1xuICAgICAgICBnZW5kZXJmb3JtID0gZmFsc2U7XG4gICAgICAgIGlmIChteXhtbC5nZXRBdHRyaWJ1dGVWYWx1ZSh0ZXJtLCAnZm9ybScpKSB7XG4gICAgICAgICAgICBmb3JtID0gbXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUodGVybSwgJ2Zvcm0nKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUodGVybSwgJ2dlbmRlci1mb3JtJykpIHtcbiAgICAgICAgICAgIGdlbmRlcmZvcm0gPSBteXhtbC5nZXRBdHRyaWJ1dGVWYWx1ZSh0ZXJtLCAnZ2VuZGVyLWZvcm0nKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUodGVybSwgJ2dlbmRlcicpKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF1bXCJub3VuLWdlbmRlcnNcIl1bdGVybW5hbWVdID0gbXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUodGVybSwgJ2dlbmRlcicpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChnZW5kZXJmb3JtKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0udGVybXNbdGVybW5hbWVdW2dlbmRlcmZvcm1dID0ge307XG4gICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0udGVybXNbdGVybW5hbWVdW2dlbmRlcmZvcm1dW2Zvcm1dID0gW107XG4gICAgICAgICAgICB0YXJnZXQgPSB0aGlzLmxvY2FsZVtsYW5nX291dF0udGVybXNbdGVybW5hbWVdW2dlbmRlcmZvcm1dO1xuICAgICAgICAgICAgZ2VuZGVyaXplZF90ZXJtc1t0ZXJtbmFtZV0gPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXVtmb3JtXSA9IFtdO1xuICAgICAgICAgICAgdGFyZ2V0ID0gdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobXl4bWwubnVtYmVyb2Zub2RlcyhteXhtbC5nZXROb2Rlc0J5TmFtZSh0ZXJtLCAnbXVsdGlwbGUnKSkpIHtcbiAgICAgICAgICAgIHRhcmdldFtmb3JtXVswXSA9IG15eG1sLmdldE5vZGVWYWx1ZSh0ZXJtLCAnc2luZ2xlJyk7XG4gICAgICAgICAgICBpZiAodGFyZ2V0W2Zvcm1dWzBdLmluZGV4T2YoXCIlc1wiKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHQuaGFzUGxhY2Vob2xkZXJUZXJtID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRhcmdldFtmb3JtXVsxXSA9IG15eG1sLmdldE5vZGVWYWx1ZSh0ZXJtLCAnbXVsdGlwbGUnKTtcbiAgICAgICAgICAgIGlmICh0YXJnZXRbZm9ybV1bMV0uaW5kZXhPZihcIiVzXCIpID4gLTEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wdC5oYXNQbGFjZWhvbGRlclRlcm0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGFyZ2V0W2Zvcm1dID0gbXl4bWwuZ2V0Tm9kZVZhbHVlKHRlcm0pO1xuICAgICAgICAgICAgaWYgKHRhcmdldFtmb3JtXS5pbmRleE9mKFwiJXNcIikgPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMub3B0Lmhhc1BsYWNlaG9sZGVyVGVybSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKG9yZGluYWxzMTAxX3RvZ2dsZSkge1xuICAgICAgICBmb3IgKHZhciBpa2V5IGluIGdlbmRlcml6ZWRfdGVybXMpIHtcbiAgICAgICAgICAgIHZhciBnZW5kZXJfc2VnbWVudHMgPSB7fTtcbiAgICAgICAgICAgIHZhciBmb3JtX3NlZ21lbnRzID0gMDtcbiAgICAgICAgICAgIGZvciAodmFyIGprZXkgaW4gdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW2lrZXldKSB7XG4gICAgICAgICAgICAgICAgaWYgKFtcIm1hc2N1bGluZVwiLFwiZmVtaW5pbmVcIl0uaW5kZXhPZihqa2V5KSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGdlbmRlcl9zZWdtZW50c1tqa2V5XSA9IHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1tpa2V5XVtqa2V5XTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmb3JtX3NlZ21lbnRzICs9IDE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFmb3JtX3NlZ21lbnRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGdlbmRlcl9zZWdtZW50cy5mZW1pbmluZSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqa2V5IGluIGdlbmRlcl9zZWdtZW50cy5mZW1pbmluZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW2lrZXldW2prZXldID0gZ2VuZGVyX3NlZ21lbnRzLmZlbWluaW5lW2prZXldO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChnZW5kZXJfc2VnbWVudHMubWFzY3VsaW5lKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGprZXkgaW4gZ2VuZGVyX3NlZ21lbnRzLm1hc2N1bGluZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW2lrZXldW2prZXldID0gZ2VuZGVyX3NlZ21lbnRzLm1hc2N1bGluZVtqa2V5XTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3JkWycxLjAuMSddID0gb3JkaW5hbHMxMDE7XG4gICAgfVxuICAgIGZvciAodGVybW5hbWUgaW4gdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zKSB7XG4gICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSAyOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBnZW5kZXJmb3JtID0gQ1NMLkdFTkRFUlNbaV07XG4gICAgICAgICAgICBpZiAodGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXVtnZW5kZXJmb3JtXSkge1xuICAgICAgICAgICAgICAgIGZvciAoZm9ybSBpbiB0aGlzLmxvY2FsZVtsYW5nX291dF0udGVybXNbdGVybW5hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXVtnZW5kZXJmb3JtXVtmb3JtXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVbbGFuZ19vdXRdLnRlcm1zW3Rlcm1uYW1lXVtnZW5kZXJmb3JtXVtmb3JtXSA9IHRoaXMubG9jYWxlW2xhbmdfb3V0XS50ZXJtc1t0ZXJtbmFtZV1bZm9ybV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgbm9kZXMgPSBteXhtbC5nZXROb2Rlc0J5TmFtZShsb2NhbGUsICdzdHlsZS1vcHRpb25zJyk7XG4gICAgZm9yIChwb3MgPSAwLCBsZW4gPSBteXhtbC5udW1iZXJvZm5vZGVzKG5vZGVzKTsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBpZiAodHJ1ZSkge1xuICAgICAgICAgICAgc3R5bGVvcHRzID0gbm9kZXNbcG9zXTtcbiAgICAgICAgICAgIGF0dHJpYnV0ZXMgPSBteXhtbC5hdHRyaWJ1dGVzKHN0eWxlb3B0cyk7XG4gICAgICAgICAgICBmb3IgKGF0dHJuYW1lIGluIGF0dHJpYnV0ZXMpIHtcbiAgICAgICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShhdHRybmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJuYW1lID09PSBcIkBwdW5jdHVhdGlvbi1pbi1xdW90ZVwiIHx8IGF0dHJuYW1lID09PSBcIkBsaW1pdC1kYXktb3JkaW5hbHMtdG8tZGF5LTFcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXNbYXR0cm5hbWVdID09PSBcInRydWVcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcHRzW2F0dHJuYW1lLnNsaWNlKDEpXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcHRzW2F0dHJuYW1lLnNsaWNlKDEpXSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF0dHJuYW1lID09PSBcIkBqdXJpc2RpY3Rpb24tcHJlZmVyZW5jZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIganVyaXNkaWN0aW9uX3ByZWZlcmVuY2UgPSBhdHRyaWJ1dGVzW2F0dHJuYW1lXS5zcGxpdCgvXFxzKixcXHMqLyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1thdHRybmFtZS5zbGljZSgxKV0gPSBqdXJpc2RpY3Rpb25fcHJlZmVyZW5jZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdHRybmFtZSA9PT0gXCJAc2tpcC13b3Jkc1wiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2tpcF93b3JkcyA9IGF0dHJpYnV0ZXNbYXR0cm5hbWVdLnNwbGl0KC9cXHMqLFxccyovKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcHRzW2F0dHJuYW1lLnNsaWNlKDEpXSA9IHNraXBfd29yZHM7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0cm5hbWUgPT09IFwiQGxlYWRpbmctbm9pc2Utd29yZHNcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IGF0dHJpYnV0ZXNbYXR0cm5hbWVdLnNwbGl0KC9cXHMqLFxccyovKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcHRzW1wibGVhZGluZy1ub2lzZS13b3Jkc1wiXSA9IHZhbDtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdHRybmFtZSA9PT0gXCJAbmFtZS1hcy1zb3J0LW9yZGVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcHRzW1wibmFtZS1hcy1zb3J0LW9yZGVyXCJdID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHN0ID0gYXR0cmlidXRlc1thdHRybmFtZV0uc3BsaXQoL1xccysvKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWxzdC5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1tcIm5hbWUtYXMtc29ydC1vcmRlclwiXVtsc3RbaV1dID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdHRybmFtZSA9PT0gXCJAbmFtZS1hcy1yZXZlcnNlLW9yZGVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcHRzW1wibmFtZS1hcy1yZXZlcnNlLW9yZGVyXCJdID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHN0ID0gYXR0cmlidXRlc1thdHRybmFtZV0uc3BsaXQoL1xccysvKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWxzdC5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1tcIm5hbWUtYXMtcmV2ZXJzZS1vcmRlclwiXVtsc3RbaV1dID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdHRybmFtZSA9PT0gXCJAbmFtZS1uZXZlci1zaG9ydFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0ub3B0c1tcIm5hbWUtbmV2ZXItc2hvcnRcIl0gPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsc3QgPSBhdHRyaWJ1dGVzW2F0dHJuYW1lXS5zcGxpdCgvXFxzKy8pO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bHN0Lmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlW2xhbmdfb3V0XS5vcHRzW1wibmFtZS1uZXZlci1zaG9ydFwiXVtsc3RbaV1dID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBub2RlcyA9IG15eG1sLmdldE5vZGVzQnlOYW1lKGxvY2FsZSwgJ2RhdGUnKTtcbiAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IG15eG1sLm51bWJlcm9mbm9kZXMobm9kZXMpOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIGlmICh0cnVlKSB7XG4gICAgICAgICAgICB2YXIgZGF0ZSA9IG5vZGVzW3Bvc107XG4gICAgICAgICAgICB0aGlzLmxvY2FsZVtsYW5nX291dF0uZGF0ZXNbbXl4bWwuZ2V0QXR0cmlidXRlVmFsdWUoZGF0ZSwgXCJmb3JtXCIpXSA9IGRhdGU7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuZ2V0TG9jYWxlTmFtZXMgPSBmdW5jdGlvbiAobXl4bWwsIHByZWZlcnJlZExvY2FsZSkge1xuICAgIHZhciBzdHlsZXhtbCA9IENTTC5zZXR1cFhtbChteXhtbCk7XG4gICAgZnVuY3Rpb24gZXh0ZW5kTG9jYWxlTGlzdChsb2NhbGVMaXN0LCBsb2NhbGUpIHtcbiAgICAgICAgdmFyIGZvcm1zID0gW1wiYmFzZVwiLCBcImJlc3RcIl07XG4gICAgICAgIGlmIChsb2NhbGUpIHtcbiAgICAgICAgICAgIG5vcm1hbGl6ZWRMb2NhbGUgPSBDU0wubG9jYWxlUmVzb2x2ZShsb2NhbGUpO1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49Zm9ybXMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAobm9ybWFsaXplZExvY2FsZVtmb3Jtc1tpXV0gJiYgbG9jYWxlTGlzdC5pbmRleE9mKG5vcm1hbGl6ZWRMb2NhbGVbZm9ybXNbaV1dKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9jYWxlTGlzdC5wdXNoKG5vcm1hbGl6ZWRMb2NhbGVbZm9ybXNbaV1dKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gc25pZmZMb2NhbGVPbk9uZU5vZGVOYW1lKG5vZGVOYW1lKSB7XG4gICAgICAgIHZhciBub2RlcyA9IHN0eWxleG1sLmdldE5vZGVzQnlOYW1lKHN0eWxleG1sLmRhdGFPYmosIG5vZGVOYW1lKTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49bm9kZXMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIHZhciBub2RlTG9jYWxlcyA9IHN0eWxleG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGVzW2ldLCBcImxvY2FsZVwiKTtcbiAgICAgICAgICAgIGlmIChub2RlTG9jYWxlcykge1xuICAgICAgICAgICAgICAgIG5vZGVMb2NhbGVzID0gbm9kZUxvY2FsZXMuc3BsaXQoLyArLyk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49bm9kZUxvY2FsZXMubGVuZ3RoO2o8amxlbjtqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leHRlbmRMb2NhbGVMaXN0KGxvY2FsZUlEcywgbm9kZUxvY2FsZXNbal0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgbG9jYWxlSURzID0gW1wiZW4tVVNcIl07XG4gICAgZXh0ZW5kTG9jYWxlTGlzdChsb2NhbGVJRHMsIHByZWZlcnJlZExvY2FsZSk7XG4gICAgdmFyIHN0eWxlTm9kZSA9IHN0eWxleG1sLmdldE5vZGVzQnlOYW1lKHN0eWxleG1sLmRhdGFPYmosIFwic3R5bGVcIilbMF07XG4gICAgdmFyIGRlZmF1bHRMb2NhbGUgPSBzdHlsZXhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShzdHlsZU5vZGUsIFwiZGVmYXVsdC1sb2NhbGVcIik7XG4gICAgZXh0ZW5kTG9jYWxlTGlzdChsb2NhbGVJRHMsIGRlZmF1bHRMb2NhbGUpO1xuICAgIHZhciBub2RlTmFtZXMgPSBbXCJsYXlvdXRcIiwgXCJpZlwiLCBcImVsc2UtaWZcIiwgXCJjb25kaXRpb25cIl07XG4gICAgZm9yICh2YXIgaT0wLGlsZW49bm9kZU5hbWVzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgIHNuaWZmTG9jYWxlT25PbmVOb2RlTmFtZShzdHlsZXhtbCwgbG9jYWxlSURzLCBub2RlTmFtZXNbaV0pO1xuICAgIH1cbiAgICByZXR1cm4gbG9jYWxlSURzO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUgPSB7fTtcbkNTTC5Ob2RlLmJpYmxpb2dyYXBoeSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmFyZWEgPSBcImJpYmxpb2dyYXBoeVwiO1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQucm9vdCA9IFwiYmlibGlvZ3JhcGh5XCI7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5leHRlbnNpb24gPSBcIlwiO1xuICAgICAgICAgICAgdmFyIGZ1bmMgPSBmdW5jdGlvbihzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5hcmVhID0gXCJiaWJsaW9ncmFwaHlcIjtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAucm9vdCA9IFwiYmlibGlvZ3JhcGh5XCI7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmV4dGVuc2lvbiA9IFwiXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIH1cbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUuY2hvb3NlID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB2YXIgZnVuYztcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuanVtcC5wdXNoKHVuZGVmaW5lZCwgQ1NMLkxJVEVSQUwpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQpIHtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuanVtcC5wb3AoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9LFxuICAgIGNvbmZpZ3VyZTogZnVuY3Rpb24gKHN0YXRlLCBwb3MpIHtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuRU5EKSB7XG4gICAgICAgICAgICBzdGF0ZS5jb25maWd1cmUuZmFpbC5wdXNoKChwb3MpKTtcbiAgICAgICAgICAgIHN0YXRlLmNvbmZpZ3VyZS5zdWNjZWVkLnB1c2goKHBvcykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RhdGUuY29uZmlndXJlLmZhaWwucG9wKCk7XG4gICAgICAgICAgICBzdGF0ZS5jb25maWd1cmUuc3VjY2VlZC5wb3AoKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlLmNpdGF0aW9uID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5TVEFSVCkge1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuYXJlYSA9IFwiY2l0YXRpb25cIjtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLnJvb3QgPSBcImNpdGF0aW9uXCI7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5leHRlbnNpb24gPSBcIlwiO1xuICAgICAgICAgICAgdmFyIGZ1bmMgPSBmdW5jdGlvbihzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5hcmVhID0gXCJjaXRhdGlvblwiO1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5yb290ID0gXCJjaXRhdGlvblwiO1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5leHRlbnNpb24gPSBcIlwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLkVORCkge1xuICAgICAgICAgICAgc3RhdGUub3B0Lmdyb3VwZWRfc29ydCA9IHN0YXRlLm9wdC54Y2xhc3MgPT09IFwiaW4tdGV4dFwiIFxuICAgICAgICAgICAgICAgICYmIChzdGF0ZS5jaXRhdGlvbi5vcHQuY29sbGFwc2UgXG4gICAgICAgICAgICAgICAgICAgICYmIHN0YXRlLmNpdGF0aW9uLm9wdC5jb2xsYXBzZS5sZW5ndGgpXG4gICAgICAgICAgICAgICAgfHwgKHN0YXRlLmNpdGF0aW9uLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlclxuICAgICAgICAgICAgICAgICAgICAmJiBzdGF0ZS5jaXRhdGlvbi5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXIubGVuZ3RoKVxuICAgICAgICAgICAgICAgICYmIHN0YXRlLm9wdC51cGRhdGVfbW9kZSAhPT0gQ1NMLlBPU0lUSU9OXG4gICAgICAgICAgICAgICAgJiYgc3RhdGUub3B0LnVwZGF0ZV9tb2RlICE9PSBDU0wuTlVNRVJJQztcbiAgICAgICAgICAgIGlmIChzdGF0ZS5vcHQuZ3JvdXBlZF9zb3J0IFxuICAgICAgICAgICAgICAgICYmIHN0YXRlLmNpdGF0aW9uX3NvcnQub3B0LnNvcnRfZGlyZWN0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB2YXIgZmlyc3RrZXkgPSBzdGF0ZS5jaXRhdGlvbl9zb3J0Lm9wdC5zb3J0X2RpcmVjdGlvbnNbMF0uc2xpY2UoKTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5jaXRhdGlvbl9zb3J0Lm9wdC5zb3J0X2RpcmVjdGlvbnMgPSBbZmlyc3RrZXldLmNvbmNhdChzdGF0ZS5jaXRhdGlvbl9zb3J0Lm9wdC5zb3J0X2RpcmVjdGlvbnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGUuY2l0YXRpb24uc3J0ID0gbmV3IENTTC5SZWdpc3RyeS5Db21wYXJpZmllcihzdGF0ZSwgXCJjaXRhdGlvbl9zb3J0XCIpO1xuICAgICAgICB9XG4gICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlW1wiI2NvbW1lbnRcIl0gPSB7XG4gICAgICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUuZGF0ZSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgdmFyIGZ1bmMsIGRhdGVfb2JqLCB0b2ssIGxlbiwgcG9zLCBwYXJ0LCBkcHgsIHBhcnRzLCBteXBvcywgc3RhcnQsIGVuZDtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQgfHwgdGhpcy50b2tlbnR5cGUgPT09IENTTC5TSU5HTEVUT04pIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmRhdGVfcGFydHMgPSBbXTtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmRhdGVfdmFyaWFibGVzID0gdGhpcy52YXJpYWJsZXM7XG4gICAgICAgICAgICBpZiAoIXN0YXRlLmJ1aWxkLmV4dGVuc2lvbikge1xuICAgICAgICAgICAgICAgIENTTC5VdGlsLnN1YnN0aXR1dGVTdGFydC5jYWxsKHRoaXMsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmV4dGVuc2lvbikge1xuICAgICAgICAgICAgICAgIGZ1bmMgPSBDU0wuZGF0ZU1hY3JvQXNTb3J0S2V5O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBrZXksIGRwO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZWxlbWVudF9yZW5kZXJlZF9vayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZG9uZXNpZXMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmRhdGVwYXJ0cyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBkcCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52YXJpYWJsZXMubGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiAhKHN0YXRlLnRtcC5qdXN0X2xvb2tpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgdGhpcy52YXJpYWJsZXNbMF0gPT09IFwiYWNjZXNzZWRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVfb2JqID0gSXRlbVt0aGlzLnZhcmlhYmxlc1swXV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGRhdGVfb2JqKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZV9vYmogPSB7XCJkYXRlLXBhcnRzXCI6IFtbMF1dIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmxvY2F0b3JfZGF0ZV9hbmRfcmV2aXNpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgdGhpcy52YXJpYWJsZXNbMF0gPT09IFwibG9jYXRvci1kYXRlXCIgJiYgaXRlbVtcImxvY2F0b3ItZGF0ZVwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZV9vYmogPSBpdGVtW1wibG9jYXRvci1kYXRlXCJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmRhdGVfb2JqZWN0ID0gZGF0ZV9vYmo7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZW4gPSB0aGlzLmRhdGVwYXJ0cy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gdGhpcy5kYXRlcGFydHNbcG9zXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIHN0YXRlLnRtcC5kYXRlX29iamVjdFsocGFydCArICBcIl9lbmRcIildKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRwLnB1c2gocGFydCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJ0ID09PSBcIm1vbnRoXCIgJiYgXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIHN0YXRlLnRtcC5kYXRlX29iamVjdC5zZWFzb25fZW5kKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRwLnB1c2gocGFydCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZHB4ID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IFtcInllYXJcIiwgXCJtb250aFwiLCBcImRheVwiXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IHBhcnRzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkcC5pbmRleE9mKHBhcnRzW3Bvc10pID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHB4LnB1c2gocGFydHNbcG9zXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZHAgPSBkcHguc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG15cG9zID0gMjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IGRwLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSBkcFtwb3NdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gc3RhdGUudG1wLmRhdGVfb2JqZWN0W3BhcnRdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IHN0YXRlLnRtcC5kYXRlX29iamVjdFsocGFydCArIFwiX2VuZFwiKV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0ICE9PSBlbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlwb3MgPSBwb3M7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5kYXRlX2NvbGxhcHNlX2F0ID0gZHAuc2xpY2UobXlwb3MpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmRhdGVfb2JqZWN0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIGlmICghSXRlbVt0aGlzLnZhcmlhYmxlc1swXV0pIHJldHVybjtcbiAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5TdGFydFZhcmlhYmxlKHRoaXMudmFyaWFibGVzWzBdKTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuc3RhcnRUYWcoXCJkYXRlXCIsIHRoaXMpO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnZhcmlhYmxlc1swXSA9PT0gXCJpc3N1ZWRcIlxuICAgICAgICAgICAgICAgICAgICAmJiBJdGVtLnR5cGUgPT09IFwibGVnYWxfY2FzZVwiXG4gICAgICAgICAgICAgICAgICAgICYmICFzdGF0ZS50bXAuZXh0ZW5zaW9uXG4gICAgICAgICAgICAgICAgICAgICYmIFwiXCIgKyBJdGVtW1wiY29sbGVjdGlvbi1udW1iZXJcIl0gPT09IFwiXCIgKyBzdGF0ZS50bXAuZGF0ZV9vYmplY3QueWVhclxuICAgICAgICAgICAgICAgICAgICAmJiB0aGlzLmRhdGVwYXJ0cy5sZW5ndGggPT09IDFcbiAgICAgICAgICAgICAgICAgICAgJiYgdGhpcy5kYXRlcGFydHNbMF0gPT09IFwieWVhclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzdGF0ZS50bXAuZGF0ZV9vYmplY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZGF0ZV9vYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkuc2xpY2UoMCwgNCkgPT09IFwieWVhclwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5pc3N1ZWRfZGF0ZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbHN0ID0gc3RhdGUub3V0cHV0LmN1cnJlbnQubXlzdGFjay5zbGljZSgtMilbMF0uYmxvYnM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5pc3N1ZWRfZGF0ZS5saXN0ID0gbHN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuaXNzdWVkX2RhdGUucG9zID0gbHN0Lmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXN0YXRlLmJ1aWxkLmV4dGVuc2lvbiAmJiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQgfHwgdGhpcy50b2tlbnR5cGUgPT09IENTTC5TSU5HTEVUT04pKSB7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFJdGVtW3RoaXMudmFyaWFibGVzWzBdXSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5lbmRUYWcoKTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5DbG9zZVZhcmlhYmxlKHRoaXMudmFyaWFibGVzWzBdKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIH1cbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLkVORCB8fCB0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNJTkdMRVRPTikge1xuICAgICAgICAgICAgaWYgKCFzdGF0ZS5idWlsZC5leHRlbnNpb24pIHtcbiAgICAgICAgICAgICAgICBDU0wuVXRpbC5zdWJzdGl0dXRlRW5kLmNhbGwodGhpcywgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZVtcImRhdGUtcGFydFwiXSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgdmFyIGZ1bmMsIHBvcywgbGVuLCBkZWNvciwgZmlyc3RfZGF0ZSwgdmFsdWUsIHZhbHVlX2VuZCwgcmVhbCwgaGF2ZV9jb2xsYXBzZWQsIGludm9rZWQsIHByZWNvbmRpdGlvbiwga25vd25feWVhciwgYmMsIGFkLCBiY19lbmQsIGFkX2VuZCwgcmVhZHksIGN1cnIsIGRjdXJyLCBudW1iZXIsIG51bSwgZm9ybWF0dGVyLCBpdGVtLCBpLCBpbGVuO1xuICAgICAgICBpZiAoIXRoaXMuc3RyaW5ncy5mb3JtKSB7XG4gICAgICAgICAgICB0aGlzLnN0cmluZ3MuZm9ybSA9IFwibG9uZ1wiO1xuICAgICAgICB9XG4gICAgICAgIHN0YXRlLmJ1aWxkLmRhdGVfcGFydHMucHVzaCh0aGlzLnN0cmluZ3MubmFtZSk7XG4gICAgICAgIHZhciBkYXRlX3ZhcmlhYmxlID0gc3RhdGUuYnVpbGQuZGF0ZV92YXJpYWJsZXNbMF07XG4gICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmRhdGVfb2JqZWN0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZmlyc3RfZGF0ZSA9IHRydWU7XG4gICAgICAgICAgICB2YWx1ZSA9IFwiXCI7XG4gICAgICAgICAgICB2YWx1ZV9lbmQgPSBcIlwiO1xuICAgICAgICAgICAgc3RhdGUudG1wLmRvbmVzaWVzLnB1c2godGhpcy5zdHJpbmdzLm5hbWUpO1xuICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5kYXRlX29iamVjdC5saXRlcmFsICYmIFwieWVhclwiID09PSB0aGlzLnN0cmluZ3MubmFtZSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLkFwcGVuZFRvVmFyaWFibGUoc3RhdGUudG1wLmRhdGVfb2JqZWN0LmxpdGVyYWwpO1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQoc3RhdGUudG1wLmRhdGVfb2JqZWN0LmxpdGVyYWwsIHRoaXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5kYXRlX29iamVjdCkge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gc3RhdGUudG1wLmRhdGVfb2JqZWN0W3RoaXMuc3RyaW5ncy5uYW1lXTtcbiAgICAgICAgICAgICAgICB2YWx1ZV9lbmQgPSBzdGF0ZS50bXAuZGF0ZV9vYmplY3RbKHRoaXMuc3RyaW5ncy5uYW1lICsgXCJfZW5kXCIpXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChcInllYXJcIiA9PT0gdGhpcy5zdHJpbmdzLm5hbWUgJiYgdmFsdWUgPT09IDAgJiYgIXN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZWFsID0gIXN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucztcbiAgICAgICAgICAgIGhhdmVfY29sbGFwc2VkID0gc3RhdGUudG1wLmhhdmVfY29sbGFwc2VkO1xuICAgICAgICAgICAgaW52b2tlZCA9IHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQuY29sbGFwc2UgPT09IFwieWVhci1zdWZmaXhcIiB8fCBzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0LmNvbGxhcHNlID09PSBcInllYXItc3VmZml4LXJhbmdlZFwiO1xuICAgICAgICAgICAgcHJlY29uZGl0aW9uID0gc3RhdGUub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC15ZWFyLXN1ZmZpeFwiXTtcbiAgICAgICAgICAgIGlmIChyZWFsICYmIHByZWNvbmRpdGlvbiAmJiBpbnZva2VkKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLnllYXJzX3VzZWQucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgICAgICAga25vd25feWVhciA9IHN0YXRlLnRtcC5sYXN0X3llYXJzX3VzZWQubGVuZ3RoID49IHN0YXRlLnRtcC55ZWFyc191c2VkLmxlbmd0aDtcbiAgICAgICAgICAgICAgICBpZiAoa25vd25feWVhciAmJiBoYXZlX2NvbGxhcHNlZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmxhc3RfeWVhcnNfdXNlZFsoc3RhdGUudG1wLnllYXJzX3VzZWQubGVuZ3RoIC0gMSldID09PSB2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICBiYyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGFkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYmNfZW5kID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYWRfZW5kID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKFwieWVhclwiID09PSB0aGlzLnN0cmluZ3MubmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFyc2VJbnQodmFsdWUsIDEwKSA8IDUwMCAmJiBwYXJzZUludCh2YWx1ZSwgMTApID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWQgPSBzdGF0ZS5nZXRUZXJtKFwiYWRcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlSW50KHZhbHVlLCAxMCkgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBiYyA9IHN0YXRlLmdldFRlcm0oXCJiY1wiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gKHBhcnNlSW50KHZhbHVlLCAxMCkgKiAtMSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlX2VuZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlSW50KHZhbHVlX2VuZCwgMTApIDwgNTAwICYmIHBhcnNlSW50KHZhbHVlX2VuZCwgMTApID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkX2VuZCA9IHN0YXRlLmdldFRlcm0oXCJhZFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJzZUludCh2YWx1ZV9lbmQsIDEwKSA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiY19lbmQgPSBzdGF0ZS5nZXRUZXJtKFwiYmNcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVfZW5kID0gKHBhcnNlSW50KHZhbHVlX2VuZCwgMTApICogLTEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLkFwcGVuZFRvVmFyaWFibGUodmFsdWUpO1xuICAgICAgICAgICAgICAgIHZhciBtb250aG5hbWVpZCA9IFwiXCIrc3RhdGUudG1wLmRhdGVfb2JqZWN0Lm1vbnRoO1xuICAgICAgICAgICAgICAgIHdoaWxlIChtb250aG5hbWVpZC5sZW5ndGggPCAyKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vbnRobmFtZWlkID0gXCIwXCIrbW9udGhuYW1laWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG1vbnRobmFtZWlkID0gXCJtb250aC1cIittb250aG5hbWVpZDtcbiAgICAgICAgICAgICAgICB2YXIgZ2VuZGVyID0gc3RhdGUubG9jYWxlW3N0YXRlLm9wdC5sYW5nXVtcIm5vdW4tZ2VuZGVyc1wiXVttb250aG5hbWVpZF07XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RyaW5ncy5mb3JtKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBteWZvcm0gPSB0aGlzLnN0cmluZ3MuZm9ybTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RyaW5ncy5uYW1lID09PSBcImRheVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobXlmb3JtID09PSBcIm9yZGluYWxcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIHN0YXRlLmxvY2FsZVtzdGF0ZS5vcHQubGFuZ10ub3B0c1tcImxpbWl0LWRheS1vcmRpbmFscy10by1kYXktMVwiXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIChcIlwiICsgdmFsdWUpICE9PSBcIjFcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15Zm9ybSA9IFwibnVtZXJpY1wiO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gQ1NMLlV0aWwuRGF0ZXNbdGhpcy5zdHJpbmdzLm5hbWVdW215Zm9ybV0oc3RhdGUsIHZhbHVlLCBnZW5kZXIsIHRoaXMuZGVmYXVsdF9sb2NhbGUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoXCJtb250aFwiID09PSB0aGlzLnN0cmluZ3MubmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5zdHJpcF9wZXJpb2RzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC9cXC4vZywgXCJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5kZWNvcmF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwiQHN0cmlwLXBlcmlvZHNcIiA9PT0gdGhpcy5kZWNvcmF0aW9uc1tpXVswXSAmJiBcInRydWVcIiA9PT0gdGhpcy5kZWNvcmF0aW9uc1tpXVsxXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC9cXC4vZywgXCJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWVfZW5kKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZV9lbmQgPSBDU0wuVXRpbC5EYXRlc1t0aGlzLnN0cmluZ3MubmFtZV1bbXlmb3JtXShzdGF0ZSwgdmFsdWVfZW5kLCBnZW5kZXIsIChcImFjY2Vzc2VkXCIgPT09IGRhdGVfdmFyaWFibGUpLCBcIl9lbmRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLnN0cmlwX3BlcmlvZHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZV9lbmQgPSB2YWx1ZV9lbmQucmVwbGFjZSgvXFwuL2csIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMuZGVjb3JhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcIkBzdHJpcC1wZXJpb2RzXCIgPT09IHRoaXMuZGVjb3JhdGlvbnNbaV1bMF0gJiYgXCJ0cnVlXCIgPT09IHRoaXMuZGVjb3JhdGlvbnNbaV1bMV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlX2VuZCA9IHZhbHVlX2VuZC5yZXBsYWNlKC9cXC4vZywgXCJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQub3BlbkxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5kYXRlX2NvbGxhcHNlX2F0Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICByZWFkeSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGxlbiA9IHN0YXRlLnRtcC5kYXRlX2NvbGxhcHNlX2F0Lmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtID0gc3RhdGUudG1wLmRhdGVfY29sbGFwc2VfYXRbcG9zXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZG9uZXNpZXMuaW5kZXhPZihpdGVtKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkeSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZWFkeSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwiXCIgKyB2YWx1ZV9lbmQgIT09IFwiMFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmRhdGVwdXQucXVldWUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2RhdGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0W1wieWVhci1yYW5nZS1mb3JtYXRcIl1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgc3RhdGUub3B0W1wieWVhci1yYW5nZS1mb3JtYXRcIl0gIT09IFwiZXhwYW5kZWRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAhc3RhdGUudG1wLmRhdGVfb2JqZWN0LmRheVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAhc3RhdGUudG1wLmRhdGVfb2JqZWN0Lm1vbnRoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmICFzdGF0ZS50bXAuZGF0ZV9vYmplY3Quc2Vhc29uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIHRoaXMuc3RyaW5ncy5uYW1lID09PSBcInllYXJcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiB2YWx1ZSAmJiB2YWx1ZV9lbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVfZW5kID0gc3RhdGUuZnVuLnllYXJfbWFuZ2xlcih2YWx1ZSArIFwiLVwiICsgdmFsdWVfZW5kLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmdlX2RlbGltaXRlciA9IHN0YXRlLmdldFRlcm0oXCJ5ZWFyLXJhbmdlLWRlbGltaXRlclwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVfZW5kID0gdmFsdWVfZW5kLnNsaWNlKHZhbHVlX2VuZC5pbmRleE9mKHJhbmdlX2RlbGltaXRlcikgKyAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuZGF0ZXB1dC5hcHBlbmQodmFsdWVfZW5kLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3RfZGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5kYXRlcHV0LmN1cnJlbnQudmFsdWUoKVswXS5zdHJpbmdzLnByZWZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh2YWx1ZSwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyID0gc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnIuYmxvYnNbKGN1cnIuYmxvYnMubGVuZ3RoIC0gMSldLnN0cmluZ3Muc3VmZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQoc3RhdGUuZ2V0VGVybShcInllYXItcmFuZ2UtZGVsaW1pdGVyXCIpLCBcImVtcHR5XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGN1cnIgPSBzdGF0ZS5kYXRlcHV0LmN1cnJlbnQudmFsdWUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnIuYmxvYnMgPSBjdXJyLmJsb2JzLmNvbmNhdChkY3Vycik7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5kYXRlcHV0LnN0cmluZyhzdGF0ZSwgc3RhdGUuZGF0ZXB1dC5xdWV1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZGF0ZV9jb2xsYXBzZV9hdCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh2YWx1ZSwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmRhdGVfY29sbGFwc2VfYXQuaW5kZXhPZih0aGlzLnN0cmluZ3MubmFtZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcIlwiICsgdmFsdWVfZW5kICE9PSBcIjBcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZGF0ZXB1dC5xdWV1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2RhdGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmRhdGVwdXQub3BlbkxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmRhdGVwdXQuYXBwZW5kKHZhbHVlX2VuZCwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdF9kYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5kYXRlcHV0LmN1cnJlbnQudmFsdWUoKS5ibG9ic1swXS5zdHJpbmdzLnByZWZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJjKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5kYXRlcHV0LmFwcGVuZChiYyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5kYXRlcHV0LmFwcGVuZChhZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuZGF0ZXB1dC5jbG9zZUxldmVsKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh2YWx1ZSwgdGhpcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChiYykge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKGJjKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFkKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQoYWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuY2xvc2VMZXZlbCgpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChcIm1vbnRoXCIgPT09IHRoaXMuc3RyaW5ncy5uYW1lKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5kYXRlX29iamVjdC5zZWFzb24pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBcIlwiICsgc3RhdGUudG1wLmRhdGVfb2JqZWN0LnNlYXNvbjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLm1hdGNoKC9eWzEtNF0kLykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC52YXJpYWJsZV9zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQoc3RhdGUuZ2V0VGVybSgoXCJzZWFzb24tMFwiICsgdmFsdWUpKSwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodmFsdWUsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGUudG1wLnZhbHVlID0gW107XG4gICAgICAgICAgICBpZiAoSXRlbVtkYXRlX3ZhcmlhYmxlXSAmJiAodmFsdWUgfHwgc3RhdGUudG1wLmhhdmVfY29sbGFwc2VkKSAmJiAhc3RhdGUub3B0Lmhhc195ZWFyX3N1ZmZpeCAmJiBcInllYXJcIiA9PT0gdGhpcy5zdHJpbmdzLm5hbWUgJiYgIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmcpIHtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0gJiYgc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcueWVhcl9zdWZmaXggIT09IGZhbHNlICYmICFzdGF0ZS50bXAuaGFzX2RvbmVfeWVhcl9zdWZmaXgpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmhhc19kb25lX3llYXJfc3VmZml4ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgbnVtID0gcGFyc2VJbnQoc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcueWVhcl9zdWZmaXgsIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgbnVtYmVyID0gbmV3IENTTC5OdW1lcmljQmxvYihmYWxzZSwgbnVtLCB0aGlzLCBJdGVtLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWNjZXNzb3JfcHJlZml4ID0gc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LmxheW91dF9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3BsaWNlX3ByZWZpeCA9IHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5sYXlvdXRfZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXIgPSBuZXcgQ1NMLlV0aWwuU3VmZml4YXRvcihDU0wuU1VGRklYX0NIQVJTKTtcbiAgICAgICAgICAgICAgICAgICAgbnVtYmVyLnNldEZvcm1hdHRlcihmb3JtYXR0ZXIpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdC5jb2xsYXBzZSA9PT0gXCJ5ZWFyLXN1ZmZpeC1yYW5nZWRcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLnJhbmdlX3ByZWZpeCA9IHN0YXRlLmdldFRlcm0oXCJjaXRhdGlvbi1yYW5nZS1kZWxpbWl0ZXJcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlci5zdWNjZXNzb3JfcHJlZml4ID0gc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0W1wieWVhci1zdWZmaXgtZGVsaW1pdGVyXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuc3VjY2Vzc29yX3ByZWZpeCA9IHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHRbXCJ5ZWFyLXN1ZmZpeC1kZWxpbWl0ZXJcIl07XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuc3VjY2Vzc29yX3ByZWZpeCA9IHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQubGF5b3V0X2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBudW1iZXIuVUdMWV9ERUxJTUlURVJfU1VQUFJFU1NfSEFDSyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQobnVtYmVyLCBcImxpdGVyYWxcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlW1wiZWxzZS1pZlwiXSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgQ1NMLkNvbmRpdGlvbnMuVG9wTm9kZS5jYWxsKHRoaXMsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9LFxuICAgIGNvbmZpZ3VyZTogZnVuY3Rpb24gKHN0YXRlLCBwb3MpIHtcbiAgICAgICAgQ1NMLkNvbmRpdGlvbnMuQ29uZmlndXJlLmNhbGwodGhpcywgc3RhdGUsIHBvcyk7XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGVbXCJlbHNlXCJdID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9LFxuICAgIGNvbmZpZ3VyZTogZnVuY3Rpb24gKHN0YXRlLCBwb3MpIHtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIHN0YXRlLmNvbmZpZ3VyZS5mYWlsWyhzdGF0ZS5jb25maWd1cmUuZmFpbC5sZW5ndGggLSAxKV0gPSBwb3M7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZVtcImV0LWFsXCJdID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICBpZiAoc3RhdGUuYnVpbGQuYXJlYSA9PT0gXCJjaXRhdGlvblwiIHx8IHN0YXRlLmJ1aWxkLmFyZWEgPT09IFwiYmlibGlvZ3JhcGh5XCIpIHtcbiAgICAgICAgICAgIHZhciBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmV0YWxfbm9kZSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiB0aGlzLnN0cmluZ3MudGVybSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZXRhbF90ZXJtID0gdGhpcy5zdHJpbmdzLnRlcm07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB9XG4gICAgICAgIHRhcmdldC5wdXNoKHRoaXMpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlLmdyb3VwID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCwgcmVhbEdyb3VwKSB7XG4gICAgICAgIHZhciBmdW5jLCBleGVjcywgZG9uZV92YXJzO1xuICAgICAgICB0aGlzLnJlYWxHcm91cCA9IHJlYWxHcm91cDtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIENTTC5VdGlsLnN1YnN0aXR1dGVTdGFydC5jYWxsKHRoaXMsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLnN1YnN0aXR1dGVfbGV2ZWwudmFsdWUoKSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLnN1YnN0aXR1dGVfbGV2ZWwucmVwbGFjZSgoc3RhdGUuYnVpbGQuc3Vic3RpdHV0ZV9sZXZlbC52YWx1ZSgpICsgMSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCF0aGlzLmp1cmlzKSB7XG4gICAgICAgICAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LnN0YXJ0VGFnKFwiZ3JvdXBcIiwgdGhpcyk7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RyaW5ncy5sYWJlbF9mb3JtX292ZXJyaWRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmxhYmVsX2Zvcm0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5sYWJlbF9mb3JtID0gdGhpcy5zdHJpbmdzLmxhYmVsX2Zvcm1fb3ZlcnJpZGU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucmVhbEdyb3VwKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjb25kaXRpb24gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZvcmNlX3N1cHByZXNzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC5teXN0YWNrLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5wYXJlbnQgPSBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAub3V0cHV0X3RpcDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIgbGFiZWxfZm9ybSA9IHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5sYWJlbF9mb3JtO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWxhYmVsX2Zvcm0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX2Zvcm0gPSB0aGlzLnN0cmluZ3MubGFiZWxfZm9ybV9vdmVycmlkZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmNvbmRpdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uID0gc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmNvbmRpdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmNlX3N1cHByZXNzID0gc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmZvcmNlX3N1cHByZXNzO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RyaW5ncy5yZWplY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbiA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0OiB0aGlzLnN0cmluZ3MucmVqZWN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdDogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2Vfc3VwcHJlc3MgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZV92YXJzID0gW107XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdHJpbmdzLnJlcXVpcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbiA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0OiB0aGlzLnN0cmluZ3MucmVxdWlyZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3Q6IGZhbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBkb25lX3ZhcnMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlcm1faW50ZW5kZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFibGVfYXR0ZW1wdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZV9zdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlX3N1Y2Nlc3NfcGFyZW50OiBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAudmFyaWFibGVfc3VjY2VzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dF90aXA6IHN0YXRlLm91dHB1dC5jdXJyZW50LnRpcCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX2Zvcm06IGxhYmVsX2Zvcm0sXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJhbGxlbF9jb25kaXRpb25zOiB0aGlzLnN0cmluZ3Muc2V0X3BhcmFsbGVsX2NvbmRpdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbjogY29uZGl0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2Vfc3VwcHJlc3M6IGZvcmNlX3N1cHByZXNzLFxuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZV92YXJzOiBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuZG9uZV92YXJzLnNsaWNlKClcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGV4ZWNzID0gW107XG4gICAgICAgICAgICBleGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgdGhpcy5leGVjcyA9IGV4ZWNzLmNvbmNhdCh0aGlzLmV4ZWNzKTtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0cmluZ3NbXCJoYXMtcHVibGlzaGVyLWFuZC1wdWJsaXNoZXItcGxhY2VcIl0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZFtcInB1Ymxpc2hlci1zcGVjaWFsXCJdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cmluZ3NbXCJzdWJncm91cC1kZWxpbWl0ZXJcIl1cbiAgICAgICAgICAgICAgICAgICAgICAgICYmIEl0ZW0ucHVibGlzaGVyICYmIEl0ZW1bXCJwdWJsaXNoZXItcGxhY2VcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwdWJsaXNoZXJfbHN0ID0gSXRlbS5wdWJsaXNoZXIuc3BsaXQoLztcXHMqLyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHVibGlzaGVyX3BsYWNlX2xzdCA9IEl0ZW1bXCJwdWJsaXNoZXItcGxhY2VcIl0uc3BsaXQoLztcXHMqLyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHVibGlzaGVyX2xzdC5sZW5ndGggPiAxXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgcHVibGlzaGVyX2xzdC5sZW5ndGggPT09IHB1Ymxpc2hlcl9wbGFjZV9sc3QubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucHVibGlzaGVyT3V0cHV0ID0gbmV3IENTTC5QdWJsaXNoZXJPdXRwdXQoc3RhdGUsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnB1Ymxpc2hlck91dHB1dFtcInB1Ymxpc2hlci1saXN0XCJdID0gcHVibGlzaGVyX2xzdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wdWJsaXNoZXJPdXRwdXRbXCJwdWJsaXNoZXItcGxhY2UtbGlzdFwiXSA9IHB1Ymxpc2hlcl9wbGFjZV9sc3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLmp1cmlzKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgeD0wLHhsZW49dGFyZ2V0Lmxlbmd0aDt4PHhsZW47eCsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRhcmdldFt4XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGNob29zZV9zdGFydCA9IG5ldyBDU0wuVG9rZW4oXCJjaG9vc2VcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgICAgICAgICBDU0wuTm9kZS5jaG9vc2UuYnVpbGQuY2FsbChjaG9vc2Vfc3RhcnQsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIHZhciBpZl9zdGFydCA9IG5ldyBDU0wuVG9rZW4oXCJpZlwiLCBDU0wuU1RBUlQpO1xuICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAobWFjcm9OYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5zeXMucmV0cmlldmVTdHlsZU1vZHVsZSB8fCAhQ1NMLk1PRFVMRV9NQUNST1NbbWFjcm9OYW1lXSB8fCAhSXRlbS5qdXJpc2RpY3Rpb24pIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqdXJpc2RpY3Rpb25MaXN0ID0gc3RhdGUuZ2V0SnVyaXNkaWN0aW9uTGlzdChJdGVtLmp1cmlzZGljdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLm9wdC5qdXJpc2RpY3Rpb25zX3NlZW5banVyaXNkaWN0aW9uTGlzdFswXV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzID0gc3RhdGUucmV0cmlldmVBbGxTdHlsZU1vZHVsZXMoanVyaXNkaWN0aW9uTGlzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIganVyaXNkaWN0aW9uIGluIHJlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWFjcm9Db3VudCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmp1cmlzW2p1cmlzZGljdGlvbl0gPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG15WG1sID0gQ1NMLnNldHVwWG1sKHJlc1tqdXJpc2RpY3Rpb25dKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG15Tm9kZXMgPSBteVhtbC5nZXROb2Rlc0J5TmFtZShteVhtbC5kYXRhT2JqLCBcImxhdy1tb2R1bGVcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPW15Tm9kZXMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBteVR5cGVzID0gbXlYbWwuZ2V0QXR0cmlidXRlVmFsdWUobXlOb2Rlc1tpXSxcInR5cGVzXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG15VHlwZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5qdXJpc1tqdXJpc2RpY3Rpb25dLnR5cGVzID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlUeXBlcyA9ICBteVR5cGVzLnNwbGl0KC9cXHMrLyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49bXlUeXBlcy5sZW5ndGg7ajxqbGVuO2orKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5qdXJpc1tqdXJpc2RpY3Rpb25dLnR5cGVzW215VHlwZXNbal1dID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5qdXJpc1tqdXJpc2RpY3Rpb25dLnR5cGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5qdXJpc1tqdXJpc2RpY3Rpb25dLnR5cGVzID0gQ1NMLk1PRFVMRV9UWVBFUztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbXlOb2RlcyA9IG15WG1sLmdldE5vZGVzQnlOYW1lKG15WG1sLmRhdGFPYmosIFwibWFjcm9cIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPW15Tm9kZXMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBteU5hbWUgPSBteVhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShteU5vZGVzW2ldLCBcIm5hbWVcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUNTTC5NT0RVTEVfTUFDUk9TW215TmFtZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDU0wuZGVidWcoXCJDU0w6IHNraXBwaW5nIG5vbi1tb2R1bGFyIG1hY3JvIG5hbWUgXFxcIlwiICsgbXlOYW1lICsgXCJcXFwiIGluIG1vZHVsZSBjb250ZXh0XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hY3JvQ291bnQrKztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmp1cmlzW2p1cmlzZGljdGlvbl1bbXlOYW1lXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuYnVpbGRUb2tlbkxpc3RzKG15Tm9kZXNbaV0sIHN0YXRlLmp1cmlzW2p1cmlzZGljdGlvbl1bbXlOYW1lXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jb25maWd1cmVUb2tlbkxpc3Qoc3RhdGUuanVyaXNbanVyaXNkaWN0aW9uXVtteU5hbWVdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWp1cmlzZGljdGlvbkxpc3QubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIganVyaXNkaWN0aW9uID0ganVyaXNkaWN0aW9uTGlzdFtpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzdGF0ZS5qdXJpc1tqdXJpc2RpY3Rpb25dICYmIHN0YXRlLmp1cmlzW2p1cmlzZGljdGlvbl0udHlwZXNbSXRlbS50eXBlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJdGVtW1wiYmVzdC1qdXJpc2RpY3Rpb25cIl0gPSBqdXJpc2RpY3Rpb247XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KHRoaXMuanVyaXMpO1xuICAgICAgICAgICAgICAgIGlmX3N0YXJ0LnRlc3RzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgaWZfc3RhcnQudGVzdCA9IHN0YXRlLmZ1bi5tYXRjaC5hbnkoaWZfc3RhcnQsIHN0YXRlLCBpZl9zdGFydC50ZXN0cyk7XG4gICAgICAgICAgICAgICAgdGFyZ2V0LnB1c2goaWZfc3RhcnQpO1xuICAgICAgICAgICAgICAgIHZhciB0ZXh0X25vZGUgPSBuZXcgQ1NMLlRva2VuKFwidGV4dFwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmp1cmlzW0l0ZW1bXCJiZXN0LWp1cmlzZGljdGlvblwiXV1bdGhpcy5qdXJpc10pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0IDwgc3RhdGUuanVyaXNbSXRlbVtcImJlc3QtanVyaXNkaWN0aW9uXCJdXVt0aGlzLmp1cmlzXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ID0gQ1NMLnRva2VuRXhlYy5jYWxsKHN0YXRlLCBzdGF0ZS5qdXJpc1tJdGVtW1wiYmVzdC1qdXJpc2RpY3Rpb25cIl1dW3RoaXMuanVyaXNdW25leHRdLCBJdGVtLCBpdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0ZXh0X25vZGUuanVyaXMgPSB0aGlzLmp1cmlzO1xuICAgICAgICAgICAgICAgIHRleHRfbm9kZS5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgICAgIHRhcmdldC5wdXNoKHRleHRfbm9kZSk7XG4gICAgICAgICAgICAgICAgdmFyIGlmX2VuZCA9IG5ldyBDU0wuVG9rZW4oXCJpZlwiLCBDU0wuRU5EKTtcbiAgICAgICAgICAgICAgICBDU0wuTm9kZVtcImlmXCJdLmJ1aWxkLmNhbGwoaWZfZW5kLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB2YXIgZWxzZV9zdGFydCA9IG5ldyBDU0wuVG9rZW4oXCJlbHNlXCIsIENTTC5TVEFSVCk7XG4gICAgICAgICAgICAgICAgQ1NMLk5vZGVbXCJlbHNlXCJdLmJ1aWxkLmNhbGwoZWxzZV9zdGFydCwgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuRU5EKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUuYnVpbGRbXCJwdWJsaXNoZXItc3BlY2lhbFwiXSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkW1wicHVibGlzaGVyLXNwZWNpYWxcIl0gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHN0YXRlW3N0YXRlLmJ1aWxkLnJvb3RdLm9wdFtcIm5hbWUtZGVsaW1pdGVyXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5wdWJsaXNoZXJPdXRwdXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wdWJsaXNoZXJPdXRwdXQucmVuZGVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucHVibGlzaGVyT3V0cHV0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmVuZFRhZygpO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlYWxHcm91cCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZmxhZ3MgPSBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5mb3JjZV9zdXBwcmVzcyA9IGZsYWdzLmZvcmNlX3N1cHByZXNzO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghZmxhZ3MuZm9yY2Vfc3VwcHJlc3MgJiYgKGZsYWdzLnZhcmlhYmxlX3N1Y2Nlc3MgfHwgKGZsYWdzLnRlcm1faW50ZW5kZWQgJiYgIWZsYWdzLnZhcmlhYmxlX2F0dGVtcHQpKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzSnVyaXNMb2NhdG9yTGFiZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAudmFyaWFibGVfc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmxvYnMgPSBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLmJsb2JzO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBvcyA9IHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkuYmxvYnMubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmp1c3RfbG9va2luZyAmJiBcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgZmxhZ3MucGFyYWxsZWxfY29uZGl0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJhbGxlbF9jb25kaXRpb25fb2JqZWN0ID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9iczogYmxvYnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbnM6IGZsYWdzLnBhcmFsbGVsX2NvbmRpdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBJdGVtLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3M6IHBvc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwucGFyYWxsZWxfY29uZGl0aW9uYWxfYmxvYnNfbGlzdC5wdXNoKHBhcmFsbGVsX2NvbmRpdGlvbl9vYmplY3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLnZhcmlhYmxlX2F0dGVtcHQgPSBmbGFncy52YXJpYWJsZV9hdHRlbXB0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzLmZvcmNlX3N1cHByZXNzICYmICFzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuY29uZGl0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLnZhcmlhYmxlX2F0dGVtcHQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC52YXJpYWJsZV9zdWNjZXNzID0gZmxhZ3MudmFyaWFibGVfc3VjY2Vzc19wYXJlbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49ZmxhZ3MuZG9uZV92YXJzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZG9uZV92YXJzLmluZGV4T2YoZmxhZ3MuZG9uZV92YXJzW2ldKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZG9uZV92YXJzID0gc3RhdGUudG1wLmRvbmVfdmFycy5zbGljZSgwLCBpKS5jb25jYXQoc3RhdGUudG1wLmRvbmVfdmFycy5zbGljZShpKzEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLmJsb2JzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5ibG9icy5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICBpZiAodGhpcy5qdXJpcykge1xuICAgICAgICAgICAgICAgIHZhciBlbHNlX2VuZCA9IG5ldyBDU0wuVG9rZW4oXCJlbHNlXCIsIENTTC5FTkQpO1xuICAgICAgICAgICAgICAgIENTTC5Ob2RlW1wiZWxzZVwiXS5idWlsZC5jYWxsKGVsc2VfZW5kLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB2YXIgY2hvb3NlX2VuZCA9IG5ldyBDU0wuVG9rZW4oXCJjaG9vc2VcIiwgQ1NMLkVORCk7XG4gICAgICAgICAgICAgICAgQ1NMLk5vZGUuY2hvb3NlLmJ1aWxkLmNhbGwoY2hvb3NlX2VuZCwgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuRU5EKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuanVyaXMpIHtcbiAgICAgICAgICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5zdWJzdGl0dXRlX2xldmVsLnZhbHVlKCkpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZC5zdWJzdGl0dXRlX2xldmVsLnJlcGxhY2UoKHN0YXRlLmJ1aWxkLnN1YnN0aXR1dGVfbGV2ZWwudmFsdWUoKSAtIDEpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIENTTC5VdGlsLnN1YnN0aXR1dGVFbmQuY2FsbCh0aGlzLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlW1wiaWZcIl0gPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIENTTC5Db25kaXRpb25zLlRvcE5vZGUuY2FsbCh0aGlzLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfSxcbiAgICBjb25maWd1cmU6IGZ1bmN0aW9uIChzdGF0ZSwgcG9zKSB7XG4gICAgICAgIENTTC5Db25kaXRpb25zLkNvbmZpZ3VyZS5jYWxsKHRoaXMsIHN0YXRlLCBwb3MpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlW1wiY29uZGl0aW9uc1wiXSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIHN0YXRlLnRtcC5jb25kaXRpb25zLmFkZE1hdGNoKHRoaXMubWF0Y2gpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLkVORCkge1xuICAgICAgICAgICAgc3RhdGUudG1wLmNvbmRpdGlvbnMubWF0Y2hDb21iaW5lKCk7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZVtcImNvbmRpdGlvblwiXSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU0lOR0xFVE9OKSB7XG4gICAgICAgICAgICB2YXIgdGVzdCA9IHN0YXRlLmZ1bi5tYXRjaFt0aGlzLm1hdGNoXSh0aGlzLCBzdGF0ZSwgdGhpcy50ZXN0cyk7XG4gICAgICAgICAgICBzdGF0ZS50bXAuY29uZGl0aW9ucy5hZGRUZXN0KHRlc3QpO1xuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLkNvbmRpdGlvbnMgPSB7fTtcbkNTTC5Db25kaXRpb25zLlRvcE5vZGUgPSBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgIHZhciBmdW5jO1xuICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUIHx8IHRoaXMudG9rZW50eXBlID09PSBDU0wuU0lOR0xFVE9OKSB7XG4gICAgICAgIGlmICh0aGlzLmxvY2FsZSkge1xuICAgICAgICAgICAgc3RhdGUub3B0LmxhbmcgPSB0aGlzLmxvY2FsZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMudGVzdHMgfHwgIXRoaXMudGVzdHMubGVuZ3RoKSB7XG4gICAgICAgICAgICBzdGF0ZS50bXAuY29uZGl0aW9ucyA9IG5ldyBDU0wuQ29uZGl0aW9ucy5FbmdpbmUoc3RhdGUsIHRoaXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50ZXN0ID0gc3RhdGUuZnVuLm1hdGNoW3RoaXMubWF0Y2hdKHRoaXMsIHN0YXRlLCB0aGlzLnRlc3RzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQgfHwgdGhpcy50b2tlbnR5cGUgPT09IENTTC5TSU5HTEVUT04pIHtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgaWYgKHRoaXMubG9jYWxlX2RlZmF1bHQpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLm9sZF9sb2NhbGUgPSB0aGlzLmxvY2FsZV9kZWZhdWx0O1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5jbG9zZUxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgICAgICAgICAgc3RhdGUub3B0LmxhbmcgPSB0aGlzLmxvY2FsZV9kZWZhdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG5leHQgPSB0aGlzW3N0YXRlLnRtcC5qdW1wLnZhbHVlKCldO1xuICAgICAgICAgICAgcmV0dXJuIG5leHQ7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgaWYgKHRoaXMubG9jYWxlX2RlZmF1bHQpIHtcbiAgICAgICAgICAgIHN0YXRlLm9wdC5sYW5nID0gdGhpcy5sb2NhbGVfZGVmYXVsdDtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuQ29uZGl0aW9ucy5Db25maWd1cmUgPSBmdW5jdGlvbiAoc3RhdGUsIHBvcykge1xuICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgIHRoaXMuZmFpbCA9IHN0YXRlLmNvbmZpZ3VyZS5mYWlsLnNsaWNlKC0xKVswXTtcbiAgICAgICAgdGhpcy5zdWNjZWVkID0gdGhpcy5uZXh0O1xuICAgICAgICBzdGF0ZS5jb25maWd1cmUuZmFpbFsoc3RhdGUuY29uZmlndXJlLmZhaWwubGVuZ3RoIC0gMSldID0gcG9zO1xuICAgIH0gZWxzZSBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5TSU5HTEVUT04pIHtcbiAgICAgICAgdGhpcy5mYWlsID0gdGhpcy5uZXh0O1xuICAgICAgICB0aGlzLnN1Y2NlZWQgPSBzdGF0ZS5jb25maWd1cmUuc3VjY2VlZC5zbGljZSgtMSlbMF07XG4gICAgICAgIHN0YXRlLmNvbmZpZ3VyZS5mYWlsWyhzdGF0ZS5jb25maWd1cmUuZmFpbC5sZW5ndGggLSAxKV0gPSBwb3M7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zdWNjZWVkID0gc3RhdGUuY29uZmlndXJlLnN1Y2NlZWQuc2xpY2UoLTEpWzBdO1xuICAgICAgICB0aGlzLmZhaWwgPSB0aGlzLm5leHQ7XG4gICAgfVxufTtcbkNTTC5Db25kaXRpb25zLkVuZ2luZSA9IGZ1bmN0aW9uIChzdGF0ZSwgdG9rZW4pIHtcbiAgICB0aGlzLnRva2VuID0gdG9rZW47XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xufTtcbkNTTC5Db25kaXRpb25zLkVuZ2luZS5wcm90b3R5cGUuYWRkVGVzdCA9IGZ1bmN0aW9uICh0ZXN0KSB7XG4gICAgdGhpcy50b2tlbi50ZXN0cy5wdXNoKHRlc3QpO1xufTtcbkNTTC5Db25kaXRpb25zLkVuZ2luZS5wcm90b3R5cGUuYWRkTWF0Y2ggPSBmdW5jdGlvbiAobWF0Y2gpIHtcbiAgICB0aGlzLnRva2VuLm1hdGNoID0gbWF0Y2g7XG59O1xuQ1NMLkNvbmRpdGlvbnMuRW5naW5lLnByb3RvdHlwZS5tYXRjaENvbWJpbmUgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy50b2tlbi50ZXN0ID0gdGhpcy5zdGF0ZS5mdW4ubWF0Y2hbdGhpcy50b2tlbi5tYXRjaF0odGhpcy50b2tlbiwgdGhpcy5zdGF0ZSwgdGhpcy50b2tlbi50ZXN0cyk7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS5pbmZvID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5TVEFSVCkge1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuc2tpcCA9IFwiaW5mb1wiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuc2tpcCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUuaW5zdGl0dXRpb24gPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIGlmIChbQ1NMLlNJTkdMRVRPTiwgQ1NMLlNUQVJUXS5pbmRleE9mKHRoaXMudG9rZW50eXBlKSA+IC0xKSB7XG4gICAgICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgdGhpcy5zdHJpbmdzLmRlbGltaXRlcikge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuaW5zdGl0dXRpb25fZGVsaW1pdGVyID0gdGhpcy5zdHJpbmdzLmRlbGltaXRlcjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuaW5zdGl0dXRpb25fZGVsaW1pdGVyID0gc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgbXlhbmQsIGFuZF9kZWZhdWx0X3ByZWZpeCwgYW5kX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICBpZiAoXCJ0ZXh0XCIgPT09IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJhbmRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfdGVybSA9IHN0YXRlLmdldFRlcm0oXCJhbmRcIiwgXCJsb25nXCIsIDApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJzeW1ib2xcIiA9PT0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImFuZFwiKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuZXhwZWN0X2FuZF9zeW1ib2xfZm9ybSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfdGVybSA9IHN0YXRlLmdldFRlcm0oXCJhbmRcIiwgXCJzeW1ib2xcIiwgMCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF90ZXJtID0gXCImXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwibm9uZVwiID09PSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiYW5kXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3Rlcm0gPSBzdGF0ZS50bXAuaW5zdGl0dXRpb25fZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMuYW5kX3Rlcm0gJiYgc3RhdGUudG1wLmFuZF90ZXJtKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3Rlcm0gPSBzdGF0ZS5nZXRUZXJtKFwiYW5kXCIsIFwibG9uZ1wiLCAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKENTTC5TVEFSVFNXSVRIX1JPTUFORVNRVUVfUkVHRVhQLnRlc3QodGhpcy5hbmRfdGVybSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X3NpbmdsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfbXVsdGlwbGUgPSBcIiwgXCI7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2Ygc3RhdGUudG1wLmluc3RpdHV0aW9uX2RlbGltaXRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X211bHRpcGxlID0gc3RhdGUudG1wLmluc3RpdHV0aW9uX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9zdWZmaXggPSBcIiBcIjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfc2luZ2xlID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X211bHRpcGxlID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfc3VmZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiKSA9PT0gXCJhbHdheXNcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfc2luZ2xlID0gc3RhdGUudG1wLmluc3RpdHV0aW9uX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiKSA9PT0gXCJuZXZlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZF9wcmVmaXhfbXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3ByZWZpeF9tdWx0aXBsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuYW5kID0ge307XG4gICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB0aGlzLmFuZF90ZXJtKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodGhpcy5hbmRfdGVybSwgXCJlbXB0eVwiLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQuc2luZ2xlID0gc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUuc3RyaW5ncy5wcmVmaXggPSB0aGlzLmFuZF9wcmVmaXhfc2luZ2xlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUuc3RyaW5ncy5zdWZmaXggPSB0aGlzLmFuZF9zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodGhpcy5hbmRfdGVybSwgXCJlbXB0eVwiLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQubXVsdGlwbGUgPSBzdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLm11bHRpcGxlLnN0cmluZ3MucHJlZml4ID0gdGhpcy5hbmRfcHJlZml4X211bHRpcGxlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5tdWx0aXBsZS5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuYW5kX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwidW5kZWZpbmVkXCIgIT09IHRoaXMuc3RyaW5ncy5kZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQuc2luZ2xlID0gbmV3IENTTC5CbG9iKHN0YXRlLnRtcC5pbnN0aXR1dGlvbl9kZWxpbWl0ZXIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUuc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUuc3RyaW5ncy5zdWZmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5tdWx0aXBsZSA9IG5ldyBDU0wuQmxvYihzdGF0ZS50bXAuaW5zdGl0dXRpb25fZGVsaW1pdGVyKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQubXVsdGlwbGUuc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5tdWx0aXBsZS5zdHJpbmdzLnN1ZmZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQuaW5zdGl0dXRpb24gPSB0aGlzO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9LFxuICAgIGNvbmZpZ3VyZTogZnVuY3Rpb24gKHN0YXRlLCBwb3MpIHtcbiAgICAgICAgaWYgKFtDU0wuU0lOR0xFVE9OLCBDU0wuU1RBUlRdLmluZGV4T2YodGhpcy50b2tlbnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmhhc19pbnN0aXR1dGlvbiA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZVtcImluc3RpdHV0aW9uLXBhcnRcIl0gPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIHZhciBmdW5jO1xuICAgICAgICBpZiAoXCJsb25nXCIgPT09IHRoaXMuc3RyaW5ncy5uYW1lKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zdHJpbmdzW1wiaWYtc2hvcnRcIl0pIHtcbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQuaW5zdGl0dXRpb25wYXJ0W1wibG9uZy13aXRoLXNob3J0XCJdID0gdGhpcztcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQuaW5zdGl0dXRpb25wYXJ0W1wibG9uZ1wiXSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChcInNob3J0XCIgPT09IHRoaXMuc3RyaW5ncy5uYW1lKSB7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dC5pbnN0aXR1dGlvbnBhcnRbXCJzaG9ydFwiXSA9IHRoaXM7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUua2V5ID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB0YXJnZXQgPSBzdGF0ZVtzdGF0ZS5idWlsZC5yb290ICsgXCJfc29ydFwiXS50b2tlbnM7XG4gICAgICAgIHZhciBmdW5jLCBpLCBpbGVuO1xuICAgICAgICB2YXIgZGVidWcgPSBmYWxzZTtcbiAgICAgICAgdmFyIHN0YXJ0X2tleSA9IG5ldyBDU0wuVG9rZW4oXCJrZXlcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgc3RhdGUudG1wLnJvb3QgPSBzdGF0ZS5idWlsZC5yb290O1xuICAgICAgICBzdGFydF9rZXkuc3RyaW5nc1tcImV0LWFsLW1pblwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC1taW5cIik7XG4gICAgICAgIHN0YXJ0X2tleS5zdHJpbmdzW1wiZXQtYWwtdXNlLWZpcnN0XCJdID0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImV0LWFsLXVzZS1maXJzdFwiKTtcbiAgICAgICAgc3RhcnRfa2V5LnN0cmluZ3NbXCJldC1hbC11c2UtbGFzdFwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtbGFzdFwiKTtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgc3RhdGUudG1wLmRvbmVfdmFycyA9IFtdO1xuICAgICAgICB9O1xuICAgICAgICBzdGFydF9rZXkuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgc3RhdGUub3B0LmNpdGF0aW9uX251bWJlcl9zb3J0X2RpcmVjdGlvbiA9IHRoaXMuc3RyaW5ncy5zb3J0X2RpcmVjdGlvbjtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChcImVtcHR5XCIpO1xuICAgICAgICB9O1xuICAgICAgICBzdGFydF9rZXkuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgdmFyIHNvcnRfZGlyZWN0aW9uID0gW107XG4gICAgICAgIGlmICh0aGlzLnN0cmluZ3Muc29ydF9kaXJlY3Rpb24gPT09IENTTC5ERVNDRU5ESU5HKSB7XG4gICAgICAgICAgICBzb3J0X2RpcmVjdGlvbi5wdXNoKDEpO1xuICAgICAgICAgICAgc29ydF9kaXJlY3Rpb24ucHVzaCgtMSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzb3J0X2RpcmVjdGlvbi5wdXNoKC0xKTtcbiAgICAgICAgICAgIHNvcnRfZGlyZWN0aW9uLnB1c2goMSk7XG4gICAgICAgIH1cbiAgICAgICAgc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LnNvcnRfZGlyZWN0aW9ucy5wdXNoKHNvcnRfZGlyZWN0aW9uKTtcbiAgICAgICAgaWYgKENTTC5EQVRFX1ZBUklBQkxFUy5pbmRleE9mKHRoaXMudmFyaWFibGVzWzBdKSA+IC0xKSB7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5kYXRlX2tleSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgc3RhdGUudG1wLnNvcnRfa2V5X2ZsYWcgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC1taW5cIikpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXBbXCJldC1hbC1taW5cIl0gPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtbWluXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtZmlyc3RcIikpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXBbXCJldC1hbC11c2UtZmlyc3RcIl0gPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtdXNlLWZpcnN0XCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKFwiYm9vbGVhblwiID09PSB0eXBlb2Ygc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImV0LWFsLXVzZS1sYXN0XCIpKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtdXNlLWxhc3RcIl0gPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtdXNlLWxhc3RcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHN0YXJ0X2tleS5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB0YXJnZXQucHVzaChzdGFydF9rZXkpO1xuICAgICAgICBpZiAodGhpcy52YXJpYWJsZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgdmFyaWFibGUgPSB0aGlzLnZhcmlhYmxlc1swXTtcbiAgICAgICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJjaXRhdGlvbi1udW1iZXJcIikge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5hcmVhID09PSBcImNpdGF0aW9uXCIgJiYgc3RhdGUuYnVpbGQuZXh0ZW5zaW9uID09PSBcIl9zb3J0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3B0LmNpdGF0aW9uX251bWJlcl9zb3J0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5yb290ID09PSBcImJpYmxpb2dyYXBoeVwiICYmIHN0YXRlLmJ1aWxkLmV4dGVuc2lvbiA9PT0gXCJfc29ydFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5jaXRhdGlvbl9udW1iZXJfc29ydF91c2VkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKENTTC5DUkVBVE9SUy5pbmRleE9mKHZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5hbWVzX3N0YXJ0X3Rva2VuID0gbmV3IENTTC5Ub2tlbihcIm5hbWVzXCIsIENTTC5TVEFSVCk7XG4gICAgICAgICAgICAgICAgbmFtZXNfc3RhcnRfdG9rZW4udG9rZW50eXBlID0gQ1NMLlNUQVJUO1xuICAgICAgICAgICAgICAgIG5hbWVzX3N0YXJ0X3Rva2VuLnZhcmlhYmxlcyA9IHRoaXMudmFyaWFibGVzO1xuICAgICAgICAgICAgICAgIENTTC5Ob2RlLm5hbWVzLmJ1aWxkLmNhbGwobmFtZXNfc3RhcnRfdG9rZW4sIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIHZhciBuYW1lX3Rva2VuID0gbmV3IENTTC5Ub2tlbihcIm5hbWVcIiwgQ1NMLlNJTkdMRVRPTik7XG4gICAgICAgICAgICAgICAgbmFtZV90b2tlbi50b2tlbnR5cGUgPSBDU0wuU0lOR0xFVE9OO1xuICAgICAgICAgICAgICAgIG5hbWVfdG9rZW4uc3RyaW5nc1tcIm5hbWUtYXMtc29ydC1vcmRlclwiXSA9IFwiYWxsXCI7XG4gICAgICAgICAgICAgICAgbmFtZV90b2tlbi5zdHJpbmdzW1wic29ydC1zZXBhcmF0b3JcIl0gPSBcIiBcIjtcbiAgICAgICAgICAgICAgICBuYW1lX3Rva2VuLnN0cmluZ3NbXCJldC1hbC11c2UtbGFzdFwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtbGFzdFwiKTtcbiAgICAgICAgICAgICAgICBuYW1lX3Rva2VuLnN0cmluZ3NbXCJldC1hbC1taW5cIl0gPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtbWluXCIpO1xuICAgICAgICAgICAgICAgIG5hbWVfdG9rZW4uc3RyaW5nc1tcImV0LWFsLXVzZS1maXJzdFwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtZmlyc3RcIik7XG4gICAgICAgICAgICAgICAgQ1NMLk5vZGUubmFtZS5idWlsZC5jYWxsKG5hbWVfdG9rZW4sIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIHZhciBpbnN0aXR1dGlvbl90b2tlbiA9IG5ldyBDU0wuVG9rZW4oXCJpbnN0aXR1dGlvblwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgICAgICBpbnN0aXR1dGlvbl90b2tlbi50b2tlbnR5cGUgPSBDU0wuU0lOR0xFVE9OO1xuICAgICAgICAgICAgICAgIENTTC5Ob2RlLmluc3RpdHV0aW9uLmJ1aWxkLmNhbGwoaW5zdGl0dXRpb25fdG9rZW4sIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIHZhciBuYW1lc19lbmRfdG9rZW4gPSBuZXcgQ1NMLlRva2VuKFwibmFtZXNcIiwgQ1NMLkVORCk7XG4gICAgICAgICAgICAgICAgbmFtZXNfZW5kX3Rva2VuLnRva2VudHlwZSA9IENTTC5FTkQ7XG4gICAgICAgICAgICAgICAgQ1NMLk5vZGUubmFtZXMuYnVpbGQuY2FsbChuYW1lc19lbmRfdG9rZW4sIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgc2luZ2xlX3RleHQgPSBuZXcgQ1NMLlRva2VuKFwidGV4dFwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgICAgICBzaW5nbGVfdGV4dC5kYXRlcGFydHMgPSB0aGlzLmRhdGVwYXJ0cztcbiAgICAgICAgICAgICAgICBpZiAoQ1NMLk5VTUVSSUNfVkFSSUFCTEVTLmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG51bSwgbTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwiY2l0YXRpb24tbnVtYmVyXCIgPT09IHZhcmlhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtID0gc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uc2VxLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bSA9IEl0ZW1bdmFyaWFibGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG51bSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bSA9IENTTC5VdGlsLnBhZGRpbmcobnVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQobnVtLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhcmlhYmxlID09PSBcImNpdGF0aW9uLWxhYmVsXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyaWdyYXBoID0gc3RhdGUuZ2V0Q2l0YXRpb25MYWJlbChJdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodHJpZ3JhcGgsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQ1NMLkRBVEVfVkFSSUFCTEVTLmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IENTTC5kYXRlQXNTb3J0S2V5O1xuICAgICAgICAgICAgICAgICAgICBzaW5nbGVfdGV4dC52YXJpYWJsZXMgPSB0aGlzLnZhcmlhYmxlcztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwidGl0bGVcIiA9PT0gdmFyaWFibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFiYnJldmZhbSA9IFwidGl0bGVcIjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFiYnJmYWxsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHZhciBhbHR2YXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRyYW5zZmFsbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBzdGF0ZS50cmFuc2Zvcm0uZ2V0T3V0cHV0RnVuY3Rpb24odGhpcy52YXJpYWJsZXMsIGFiYnJldmZhbSwgYWJicmZhbGwsIGFsdHZhciwgdHJhbnNmYWxsKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFydmFsID0gSXRlbVt2YXJpYWJsZV07XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHZhcnZhbCwgXCJlbXB0eVwiKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc2luZ2xlX3RleHQuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICB0YXJnZXQucHVzaChzaW5nbGVfdGV4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7IC8vIG1hY3JvXG4gICAgICAgICAgICB2YXIgdG9rZW4gPSBuZXcgQ1NMLlRva2VuKFwidGV4dFwiLCBDU0wuU0lOR0xFVE9OKTtcbiAgICAgICAgICAgIHRva2VuLnBvc3Rwb25lZF9tYWNybyA9IHRoaXMucG9zdHBvbmVkX21hY3JvO1xuICAgICAgICAgICAgQ1NMLmV4cGFuZE1hY3JvLmNhbGwoc3RhdGUsIHRva2VuLCB0YXJnZXQpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBlbmRfa2V5ID0gbmV3IENTTC5Ub2tlbihcImtleVwiLCBDU0wuRU5EKTtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgdmFyIGtleXN0cmluZyA9IHN0YXRlLm91dHB1dC5zdHJpbmcoc3RhdGUsIHN0YXRlLm91dHB1dC5xdWV1ZSk7XG4gICAgICAgICAgICBpZiAoc3RhdGUuc3lzLm5vcm1hbGl6ZVVuaWNvZGUpIHtcbiAgICAgICAgICAgICAgICBrZXlzdHJpbmcgPSBzdGF0ZS5zeXMubm9ybWFsaXplVW5pY29kZShrZXlzdHJpbmcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAga2V5c3RyaW5nID0ga2V5c3RyaW5nID8gKGtleXN0cmluZy5zcGxpdChcIiBcIikuam9pbihzdGF0ZS5vcHQuc29ydF9zZXApICsgc3RhdGUub3B0LnNvcnRfc2VwKSA6IFwiXCI7XG4gICAgICAgICAgICBpZiAoXCJcIiA9PT0ga2V5c3RyaW5nKSB7XG4gICAgICAgICAgICAgICAga2V5c3RyaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgIT09IHR5cGVvZiBrZXlzdHJpbmcgfHwgc3RhdGUudG1wLmVtcHR5X2RhdGUpIHtcbiAgICAgICAgICAgICAgICBrZXlzdHJpbmcgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmVtcHR5X2RhdGUgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlW3N0YXRlW3N0YXRlLnRtcC5hcmVhXS5yb290ICsgXCJfc29ydFwiXS5rZXlzLnB1c2goa2V5c3RyaW5nKTtcbiAgICAgICAgICAgIHN0YXRlLnRtcC52YWx1ZSA9IFtdO1xuICAgICAgICB9O1xuICAgICAgICBlbmRfa2V5LmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIGlmIChzdGF0ZS5idWlsZC5kYXRlX2tleSkge1xuICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmFyZWEgPT09IFwiY2l0YXRpb25cIiAmJiBzdGF0ZS5idWlsZC5leHRlbnNpb24gPT09IFwiX3NvcnRcIikge1xuICAgICAgICAgICAgICAgIHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5zb3J0X2RpcmVjdGlvbnMucHVzaChbLTEsMV0pO1xuICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHllYXJfc3VmZml4ID0gc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcueWVhcl9zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIGlmICgheWVhcl9zdWZmaXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHllYXJfc3VmZml4ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gQ1NMLlV0aWwucGFkZGluZyhcIlwiICsgeWVhcl9zdWZmaXgpO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ua2V5cy5wdXNoKGtleSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVuZF9rZXkuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmRhdGVfa2V5ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtbWluXCJdID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtdXNlLWZpcnN0XCJdID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtdXNlLWxhc3RcIl0gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICBzdGF0ZS50bXAuc29ydF9rZXlfZmxhZyA9IGZhbHNlO1xuICAgICAgICB9O1xuICAgICAgICBlbmRfa2V5LmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIHRhcmdldC5wdXNoKGVuZF9rZXkpO1xuICAgIH1cbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ob2RlLmxhYmVsID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB2YXIgZGVidWcgPSBmYWxzZTtcbiAgICAgICAgaWYgKHRoaXMuc3RyaW5ncy50ZXJtKSB7XG4gICAgICAgICAgICB2YXIgcGx1cmFsID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoIXRoaXMuc3RyaW5ncy5mb3JtKSB7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgIHZhciB0ZXJtdHh0ID0gQ1NMLmV2YWx1YXRlTGFiZWwodGhpcywgc3RhdGUsIEl0ZW0sIGl0ZW0pO1xuICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIHRoaXMuc3RyaW5ncy50ZXJtID09PSBcImxvY2F0b3JcIikge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5TdGFydFZhcmlhYmxlKFwibGFiZWxcIik7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLkFwcGVuZFRvVmFyaWFibGUoaXRlbS5sYWJlbCk7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0uc2VjdGlvbl9mb3JtX292ZXJyaWRlID0gdGhpcy5zdHJpbmdzLmZvcm07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0ZXJtdHh0KSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC50ZXJtX2ludGVuZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgQ1NMLlVQREFURV9HUk9VUF9DT05URVhUX0NPTkRJVElPTihzdGF0ZSwgdGVybXR4dCk7XG4gICAgICAgICAgICAgICAgaWYgKHRlcm10eHQuaW5kZXhPZihcIiVzXCIpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHRlcm10eHQsIHRoaXMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiB0aGlzLnN0cmluZ3MudGVybSA9PT0gXCJsb2NhdG9yXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwuQ2xvc2VWYXJpYWJsZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YXIgbmFtZXZhcnMgPSBzdGF0ZS5idWlsZC5uYW1lc192YXJpYWJsZXMuc2xpY2UoLTEpWzBdO1xuICAgICAgICAgICAgaWYgKCFzdGF0ZS5idWlsZC5uYW1lX2xhYmVsKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZV9sYWJlbCA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBuYW1ldmFycy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLmJ1aWxkLm5hbWVfbGFiZWxbbmFtZXZhcnNbaV1dKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVfbGFiZWxbbmFtZXZhcnNbaV1dID0ge307XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFzdGF0ZS5idWlsZC5uYW1lX2ZsYWcpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG5hbWV2YXJzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZC5uYW1lX2xhYmVsW25hbWV2YXJzW2ldXS5iZWZvcmUgPSB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBuYW1ldmFycy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZV9sYWJlbFtuYW1ldmFyc1tpXV0uYWZ0ZXIgPSB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS5sYXlvdXQgPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7XG4gICAgICAgIHZhciBmdW5jLCBwcmVmaXhfdG9rZW4sIHN1ZmZpeF90b2tlbiwgdG9rO1xuICAgICAgICBmdW5jdGlvbiBzZXRTdWZmaXgoKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUuYnVpbGQuYXJlYSA9PT0gXCJiaWJsaW9ncmFwaHlcIikge1xuICAgICAgICAgICAgICAgIHN1ZmZpeF90b2tlbiA9IG5ldyBDU0wuVG9rZW4oXCJ0ZXh0XCIsIENTTC5TSU5HTEVUT04pO1xuICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbihzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdF9sb2NhbGUgPSBzdGF0ZS50bXAuY2l0ZV9sb2NhbGVzW3N0YXRlLnRtcC5jaXRlX2xvY2FsZXMubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICAgICAgICAgIHZhciBzdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY2l0ZV9hZmZpeGVzW3N0YXRlLnRtcC5hcmVhXVtzdGF0ZS50bXAubGFzdF9jaXRlX2xvY2FsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1ZmZpeCA9IHN0YXRlLnRtcC5jaXRlX2FmZml4ZXNbc3RhdGUudG1wLmFyZWFdW3N0YXRlLnRtcC5sYXN0X2NpdGVfbG9jYWxlXS5zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSBzdGF0ZS5iaWJsaW9ncmFwaHkub3B0LmxheW91dF9zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIHRvcGJsb2IgPSBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LnVzaW5nX2Rpc3BsYXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvcGJsb2IuYmxvYnNbdG9wYmxvYi5ibG9icy5sZW5ndGgtMV0uc3RyaW5ncy5zdWZmaXggPSBzdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b3BibG9iLnN0cmluZ3Muc3VmZml4ID0gc3VmZml4O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5iaWJsaW9ncmFwaHkub3B0W1wic2Vjb25kLWZpZWxkLWFsaWduXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuZW5kVGFnKFwiYmliX290aGVyXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBzdWZmaXhfdG9rZW4uZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICB0YXJnZXQucHVzaChzdWZmaXhfdG9rZW4pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5sb2NhbGVfcmF3KSB7XG4gICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQuY3VycmVudF9kZWZhdWx0X2xvY2FsZSA9IHRoaXMubG9jYWxlX3JhdztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQuY3VycmVudF9kZWZhdWx0X2xvY2FsZSA9IHN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5hcHBseV9jaXRhdGlvbl93cmFwcGVyXG4gICAgICAgICAgICAgICAgICAgICYmIHN0YXRlLnN5cy53cmFwQ2l0YXRpb25FbnRyeVxuICAgICAgICAgICAgICAgICAgICAmJiAhc3RhdGUudG1wLmp1c3RfbG9va2luZ1xuICAgICAgICAgICAgICAgICAgICAmJiBJdGVtLnN5c3RlbV9pZCBcbiAgICAgICAgICAgICAgICAgICAgJiYgc3RhdGUudG1wLmFyZWEgPT09IFwiY2l0YXRpb25cIikgeyBcbiAgICAgICAgICAgICAgICAgICAgY2l0ZV9lbnRyeSA9IG5ldyBDU0wuVG9rZW4oXCJncm91cFwiLCBDU0wuU1RBUlQpO1xuICAgICAgICAgICAgICAgICAgICBjaXRlX2VudHJ5LmRlY29yYXRpb25zID0gW1tcIkBjaXRlXCIsIFwiZW50cnlcIl1dO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuc3RhcnRUYWcoXCJjaXRlX2VudHJ5XCIsIGNpdGVfZW50cnkpO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLml0ZW1faWQgPSBJdGVtLnN5c3RlbV9pZDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkubG9jYXRvcl90eHQgPSBpdGVtLmxvY2F0b3JfdHh0O1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5zdWZmaXhfdHh0ID0gaXRlbS5zdWZmaXhfdHh0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUICYmICFzdGF0ZS50bXAuY2l0ZV9hZmZpeGVzW3N0YXRlLmJ1aWxkLmFyZWFdKSB7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmRvbmVfdmFycyA9IFtdO1xuICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmp1c3RfbG9va2luZyAmJiBzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXSAmJiBzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5wYXJhbGxlbCkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZG9uZV92YXJzLnB1c2goXCJmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXJcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5yZW5kZXJlZF9uYW1lID0gZmFsc2U7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5zb3J0X2tleV9mbGFnID0gZmFsc2U7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5uYW1lc2V0X2NvdW50ZXIgPSAwO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICB2YXIgdG9rID0gbmV3IENTTC5Ub2tlbigpO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ydGxfc3VwcG9ydCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoW1wiYXJcIiwgXCJoZVwiLCBcImZhXCIsIFwidXJcIiwgXCJ5aVwiLCBcInBzXCIsIFwic3lyXCJdLmluZGV4T2YoSXRlbS5sYW5ndWFnZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG9rID0gbmV3IENTTC5Ub2tlbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdG9rLnN0cmluZ3MucHJlZml4ID0gXCJcXHUyMDJiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b2suc3RyaW5ncy5zdWZmaXggPSBcIlxcdTIwMmNcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQub3BlbkxldmVsKHRvayk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICAgICAgICAgIGlmIChzdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5ydGxfc3VwcG9ydCAmJiBmYWxzZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RyaW5ncy5wcmVmaXggPSB0aGlzLnN0cmluZ3MucHJlZml4LnJlcGxhY2UoL1xcKCgufCQpL2csXCIoXFx1MjAwZSQxXCIpO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RyaW5ncy5zdWZmaXggPSB0aGlzLnN0cmluZ3Muc3VmZml4LnJlcGxhY2UoL1xcKSgufCQpL2csXCIpXFx1MjAwZSQxXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmFyZWEgPT09IFwiY2l0YXRpb25cIikge1xuICAgICAgICAgICAgICAgIHByZWZpeF90b2tlbiA9IG5ldyBDU0wuVG9rZW4oXCJ0ZXh0XCIsIENTTC5TSU5HTEVUT04pO1xuICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNwO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtLnByZWZpeCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3AgPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlc3RfcHJlZml4ID0gaXRlbS5wcmVmaXgucmVwbGFjZSgvPFtePl0rPi9nLCBcIlwiKS5yZXBsYWNlKC9bXCInXFx1MjAxZFxcdTIwMTlcXHUwMGJiXFx1MjAyZlxcdTAwYTAgXSskL2csXCJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVzdF9jaGFyID0gdGVzdF9wcmVmaXguc2xpY2UoLTEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RfcHJlZml4Lm1hdGNoKENTTC5FTkRTV0lUSF9ST01BTkVTUVVFX1JFR0VYUCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcCA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChDU0wuVEVSTUlOQUxfUFVOQ1RVQVRJT04uc2xpY2UoMCwtMSkuaW5kZXhPZih0ZXN0X2NoYXIpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcCA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZXN0X2NoYXIubWF0Y2goL1tcXClcXF0sMC05XS8pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3AgPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZ25vcmVQcmVkZWNlc3NvciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKENTTC5URVJNSU5BTF9QVU5DVFVBVElPTi5zbGljZSgwLC0xKS5pbmRleE9mKHRlc3RfY2hhcikgPiAtMSAmJiBpdGVtLnByZWZpeC50cmltKCkuaW5kZXhPZihcIiBcIikgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC50ZXJtX3ByZWRlY2Vzc29yID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWdub3JlUHJlZGVjZXNzb3IgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZWZpeCA9IChpdGVtLnByZWZpeCArIHNwKS5yZXBsYWNlKC9cXHMrL2csIFwiIFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeCA9IHN0YXRlLm91dHB1dC5jaGVja05lc3RlZEJyYWNlLnVwZGF0ZShwcmVmaXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZChwcmVmaXgsIHRoaXMsIGZhbHNlLCBpZ25vcmVQcmVkZWNlc3Nvcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHByZWZpeF90b2tlbi5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgICAgIHRhcmdldC5wdXNoKHByZWZpeF90b2tlbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG15X3RvaztcbiAgICAgICAgaWYgKHRoaXMubG9jYWxlX3Jhdykge1xuICAgICAgICAgICAgbXlfdG9rID0gbmV3IENTTC5Ub2tlbihcImR1bW15XCIsIENTTC5TVEFSVCk7XG4gICAgICAgICAgICBteV90b2subG9jYWxlID0gdGhpcy5sb2NhbGVfcmF3O1xuICAgICAgICAgICAgbXlfdG9rLnN0cmluZ3MuZGVsaW1pdGVyID0gdGhpcy5zdHJpbmdzLmRlbGltaXRlcjtcbiAgICAgICAgICAgIG15X3Rvay5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5jaXRlX2FmZml4ZXNbc3RhdGUuYnVpbGQuYXJlYV0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuY2l0ZV9hZmZpeGVzW3N0YXRlLmJ1aWxkLmFyZWFdID0ge307XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmxheW91dF9mbGFnID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmICghdGhpcy5sb2NhbGVfcmF3KSB7XG4gICAgICAgICAgICAgICAgc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdC50b3BkZWNvciA9IFt0aGlzLmRlY29yYXRpb25zXTtcbiAgICAgICAgICAgICAgICBzdGF0ZVsoc3RhdGUudG1wLmFyZWEgKyBcIl9zb3J0XCIpXS5vcHQudG9wZGVjb3IgPSBbdGhpcy5kZWNvcmF0aW9uc107XG4gICAgICAgICAgICAgICAgc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LmxheW91dF9wcmVmaXggPSB0aGlzLnN0cmluZ3MucHJlZml4O1xuICAgICAgICAgICAgICAgIHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5sYXlvdXRfc3VmZml4ID0gdGhpcy5zdHJpbmdzLnN1ZmZpeDtcbiAgICAgICAgICAgICAgICBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQubGF5b3V0X2RlbGltaXRlciA9IHRoaXMuc3RyaW5ncy5kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LmxheW91dF9kZWNvcmF0aW9ucyA9IHRoaXMuZGVjb3JhdGlvbnM7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5jaXRlX2FmZml4ZXNbc3RhdGUuYnVpbGQuYXJlYV0pIHtcbiAgICAgICAgICAgICAgICAgICAgdG9rID0gbmV3IENTTC5Ub2tlbihcImVsc2VcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgICAgICAgICAgICAgQ1NMLk5vZGVbXCJlbHNlXCJdLmJ1aWxkLmNhbGwodG9rLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IC8vICF0aGlzLmxvY2FsZV9yYXdcbiAgICAgICAgICAgIGlmICh0aGlzLmxvY2FsZV9yYXcpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLmJ1aWxkLmxheW91dF9sb2NhbGVfZmxhZykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2hvb3NlX3RvayA9IG5ldyBDU0wuVG9rZW4oXCJjaG9vc2VcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgICAgICAgICAgICAgQ1NMLk5vZGUuY2hvb3NlLmJ1aWxkLmNhbGwoY2hvb3NlX3Rvaywgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgIG15X3Rvay5uYW1lID0gXCJpZlwiO1xuICAgICAgICAgICAgICAgICAgICBDU0wuQXR0cmlidXRlc1tcIkBsb2NhbGUtaW50ZXJuYWxcIl0uY2FsbChteV90b2ssIHN0YXRlLCB0aGlzLmxvY2FsZV9yYXcpO1xuICAgICAgICAgICAgICAgICAgICBDU0wuTm9kZVtcImlmXCJdLmJ1aWxkLmNhbGwobXlfdG9rLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBteV90b2submFtZSA9IFwiZWxzZS1pZlwiO1xuICAgICAgICAgICAgICAgICAgICBDU0wuQXR0cmlidXRlc1tcIkBsb2NhbGUtaW50ZXJuYWxcIl0uY2FsbChteV90b2ssIHN0YXRlLCB0aGlzLmxvY2FsZV9yYXcpO1xuICAgICAgICAgICAgICAgICAgICBDU0wuTm9kZVtcImVsc2UtaWZcIl0uYnVpbGQuY2FsbChteV90b2ssIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuY2l0ZV9hZmZpeGVzW3N0YXRlLmJ1aWxkLmFyZWFdW215X3Rvay5sb2NhbGVdID0ge307XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmNpdGVfYWZmaXhlc1tzdGF0ZS5idWlsZC5hcmVhXVtteV90b2subG9jYWxlXS5kZWxpbWl0ZXIgPSB0aGlzLnN0cmluZ3MuZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5jaXRlX2FmZml4ZXNbc3RhdGUuYnVpbGQuYXJlYV1bbXlfdG9rLmxvY2FsZV0uc3VmZml4ID0gdGhpcy5zdHJpbmdzLnN1ZmZpeDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmxvY2FsZV9yYXcpIHtcbiAgICAgICAgICAgICAgICBzZXRTdWZmaXgoKTtcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLmJ1aWxkLmxheW91dF9sb2NhbGVfZmxhZykge1xuICAgICAgICAgICAgICAgICAgICBteV90b2submFtZSA9IFwiaWZcIjtcbiAgICAgICAgICAgICAgICAgICAgbXlfdG9rLnRva2VudHlwZSA9IENTTC5FTkQ7XG4gICAgICAgICAgICAgICAgICAgIENTTC5BdHRyaWJ1dGVzW1wiQGxvY2FsZS1pbnRlcm5hbFwiXS5jYWxsKG15X3Rvaywgc3RhdGUsIHRoaXMubG9jYWxlX3Jhdyk7XG4gICAgICAgICAgICAgICAgICAgIENTTC5Ob2RlW1wiaWZcIl0uYnVpbGQuY2FsbChteV90b2ssIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZC5sYXlvdXRfbG9jYWxlX2ZsYWcgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG15X3Rvay5uYW1lID0gXCJlbHNlLWlmXCI7XG4gICAgICAgICAgICAgICAgICAgIG15X3Rvay50b2tlbnR5cGUgPSBDU0wuRU5EO1xuICAgICAgICAgICAgICAgICAgICBDU0wuQXR0cmlidXRlc1tcIkBsb2NhbGUtaW50ZXJuYWxcIl0uY2FsbChteV90b2ssIHN0YXRlLCB0aGlzLmxvY2FsZV9yYXcpO1xuICAgICAgICAgICAgICAgICAgICBDU0wuTm9kZVtcImVsc2UtaWZcIl0uYnVpbGQuY2FsbChteV90b2ssIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghdGhpcy5sb2NhbGVfcmF3KSB7XG4gICAgICAgICAgICAgICAgc2V0U3VmZml4KCk7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5jaXRlX2FmZml4ZXNbc3RhdGUuYnVpbGQuYXJlYV0pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLmxheW91dF9sb2NhbGVfZmxhZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG9rID0gbmV3IENTTC5Ub2tlbihcImVsc2VcIiwgQ1NMLkVORCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBDU0wuTm9kZVtcImVsc2VcIl0uYnVpbGQuY2FsbCh0b2ssIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdG9rID0gbmV3IENTTC5Ub2tlbihcImNob29zZVwiLCBDU0wuRU5EKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIENTTC5Ob2RlLmNob29zZS5idWlsZC5jYWxsKHRvaywgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUuYnVpbGRfbGF5b3V0X2xvY2FsZV9mbGFnID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuYnVpbGQuYXJlYSA9PT0gXCJjaXRhdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHN1ZmZpeF90b2tlbiA9IG5ldyBDU0wuVG9rZW4oXCJ0ZXh0XCIsIENTTC5TSU5HTEVUT04pO1xuICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3A7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtLnN1ZmZpeCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5zdWZmaXgubWF0Y2goQ1NMLlNUQVJUU1dJVEhfUk9NQU5FU1FVRV9SRUdFWFApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHx8IFsnWycsJygnXS5pbmRleE9mKGl0ZW0uc3VmZml4LnNsaWNlKDAsMSkpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3AgPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN1ZmZpeCA9IGl0ZW0uc3VmZml4O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSBzdGF0ZS5vdXRwdXQuY2hlY2tOZXN0ZWRCcmFjZS51cGRhdGUoc3VmZml4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCgoc3AgKyBzdWZmaXgpLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgc3VmZml4X3Rva2VuLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldC5wdXNoKHN1ZmZpeF90b2tlbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5hcHBseV9jaXRhdGlvbl93cmFwcGVyXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiBzdGF0ZS5zeXMud3JhcENpdGF0aW9uRW50cnlcbiAgICAgICAgICAgICAgICAgICAgICAgICYmICFzdGF0ZS50bXAuanVzdF9sb29raW5nXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiBJdGVtLnN5c3RlbV9pZCBcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIHN0YXRlLnRtcC5hcmVhID09PSBcImNpdGF0aW9uXCIpIHsgXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuZW5kVGFnKCk7IC8vIGNsb3NlcyBjaXRhdGlvbiBsaW5rIHdyYXBwZXJcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQubGF5b3V0X2ZsYWcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZC5sYXlvdXRfbG9jYWxlX2ZsYWcgPSBmYWxzZTtcbiAgICAgICAgICAgIH0gLy8gIXRoaXMubGF5b3V0X3Jhd1xuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUubWFjcm8gPSB7XG4gICAgYnVpbGQ6IGZ1bmN0aW9uIChzdGF0ZSwgdGFyZ2V0KSB7fVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQgPSBmdW5jdGlvbihzdGF0ZSwgSXRlbSwgaXRlbSwgdmFyaWFibGVzKSB7XG4gICAgdGhpcy5kZWJ1ZyA9IGZhbHNlO1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICB0aGlzLkl0ZW0gPSBJdGVtO1xuICAgIHRoaXMuaXRlbSA9IGl0ZW07XG4gICAgdGhpcy5uYW1lc2V0X2Jhc2UgPSAwO1xuICAgIHRoaXMuZXRhbF9zcGVjID0ge307XG4gICAgdGhpcy5fZmlyc3RfY3JlYXRvcl92YXJpYWJsZSA9IGZhbHNlO1xuICAgIHRoaXMuX3BsZWFzZV9jaG9wID0gZmFsc2U7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAobmFtZXMpIHtcbiAgICBpZiAodGhpcy5zdGF0ZS50bXAudGVybV9wcmVkZWNlc3Nvcikge1xuICAgICAgICB0aGlzLnN0YXRlLnRtcC5zdWJzZXF1ZW50X2F1dGhvcl9zdWJzdGl0dXRlX29rID0gZmFsc2U7XG4gICAgfVxuICAgIGlmICh0aGlzLm5hbWVzZXRfb2Zmc2V0KSB7XG4gICAgICAgIHRoaXMubmFtZXNldF9iYXNlID0gdGhpcy5uYW1lc2V0X2Jhc2UgKyB0aGlzLm5hbWVzZXRfb2Zmc2V0O1xuICAgIH1cbiAgICB0aGlzLm5hbWVzZXRfb2Zmc2V0ID0gMDtcbiAgICB0aGlzLm5hbWVzID0gbmFtZXM7XG4gICAgdGhpcy52YXJpYWJsZXMgPSBuYW1lcy52YXJpYWJsZXM7XG4gICAgdGhpcy5zdGF0ZS50bXAudmFsdWUgPSBbXTtcbiAgICB0aGlzLnN0YXRlLnRtcC5yZW5kZXJlZF9uYW1lID0gW107XG4gICAgdGhpcy5zdGF0ZS50bXAubGFiZWxfYmxvYiA9IGZhbHNlO1xuICAgIHRoaXMuc3RhdGUudG1wLmV0YWxfbm9kZSA9IGZhbHNlO1xuICAgIHRoaXMuc3RhdGUudG1wLmV0YWxfdGVybSA9IGZhbHNlO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy52YXJpYWJsZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGlmICh0aGlzLkl0ZW1bdGhpcy52YXJpYWJsZXNbaV1dICYmIHRoaXMuSXRlbVt0aGlzLnZhcmlhYmxlc1tpXV0ubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC52YWx1ZSA9IHRoaXMuc3RhdGUudG1wLnZhbHVlLmNvbmNhdCh0aGlzLkl0ZW1bdGhpcy52YXJpYWJsZXNbaV1dKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzW1wiZXQtYWxcIl0gPSB1bmRlZmluZWQ7XG4gICAgdGhpc1tcIndpdGhcIl0gPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5uYW1lID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuaW5zdGl0dXRpb25wYXJ0ID0ge307XG4gICAgdGhpcy5zdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAudmFyaWFibGVfYXR0ZW1wdCA9IHRydWU7XG4gICAgdGhpcy5sYWJlbFZhcmlhYmxlID0gdGhpcy52YXJpYWJsZXNbMF07XG4gICAgaWYgKCF0aGlzLnN0YXRlLnRtcC52YWx1ZS5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUucmVpbml0ID0gZnVuY3Rpb24gKG5hbWVzLCBsYWJlbFZhcmlhYmxlKSB7XG4gICAgdGhpcy5sYWJlbFZhcmlhYmxlID0gbGFiZWxWYXJpYWJsZTtcbiAgICBpZiAodGhpcy5zdGF0ZS50bXAuY2FuX3N1YnN0aXR1dGUudmFsdWUoKSkge1xuICAgICAgICB0aGlzLm5hbWVzZXRfb2Zmc2V0ID0gMDtcbiAgICAgICAgdGhpcy52YXJpYWJsZXMgPSBuYW1lcy52YXJpYWJsZXM7XG4gICAgICAgIHZhciBvbGR2YWwgPSB0aGlzLnN0YXRlLnRtcC52YWx1ZS5zbGljZSgpO1xuICAgICAgICB0aGlzLnN0YXRlLnRtcC52YWx1ZSA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMudmFyaWFibGVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuSXRlbVt0aGlzLnZhcmlhYmxlc1tpXV0gJiYgdGhpcy5JdGVtW3RoaXMudmFyaWFibGVzW2ldXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC52YWx1ZSA9IHRoaXMuc3RhdGUudG1wLnZhbHVlLmNvbmNhdCh0aGlzLkl0ZW1bdGhpcy52YXJpYWJsZXNbaV1dKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5zdGF0ZS50bXAudmFsdWUubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5jYW5fc3Vic3RpdHV0ZS5yZXBsYWNlKGZhbHNlLCBDU0wuTElURVJBTCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zdGF0ZS50bXAudmFsdWUgPSBvbGR2YWw7XG4gICAgfVxufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5vdXRwdXROYW1lcyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgaSwgaWxlbjtcbiAgICB2YXIgdmFyaWFibGVzID0gdGhpcy52YXJpYWJsZXM7XG4gICAgaWYgKHRoaXMuaW5zdGl0dXRpb24uYW5kKSB7XG4gICAgICAgIGlmICghdGhpcy5pbnN0aXR1dGlvbi5hbmQuc2luZ2xlLmJsb2JzIHx8ICF0aGlzLmluc3RpdHV0aW9uLmFuZC5zaW5nbGUuYmxvYnMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmluc3RpdHV0aW9uLmFuZC5zaW5nbGUuYmxvYnMgPSB0aGlzLm5hbWUuYW5kLnNpbmdsZS5ibG9icztcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuaW5zdGl0dXRpb24uYW5kLm11bHRpcGxlLmJsb2JzIHx8ICF0aGlzLmluc3RpdHV0aW9uLmFuZC5tdWx0aXBsZS5ibG9icy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuaW5zdGl0dXRpb24uYW5kLm11bHRpcGxlLmJsb2JzID0gdGhpcy5uYW1lLmFuZC5tdWx0aXBsZS5ibG9icztcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnZhcmlhYmxlX29mZnNldCA9IHt9O1xuICAgIGlmICh0aGlzLmZhbWlseSkge1xuICAgICAgICB0aGlzLmZhbWlseV9kZWNvciA9IENTTC5VdGlsLmNsb25lVG9rZW4odGhpcy5mYW1pbHkpO1xuICAgICAgICB0aGlzLmZhbWlseV9kZWNvci5zdHJpbmdzLnByZWZpeCA9IFwiXCI7XG4gICAgICAgIHRoaXMuZmFtaWx5X2RlY29yLnN0cmluZ3Muc3VmZml4ID0gXCJcIjtcbiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHRoaXMuZmFtaWx5LmV4ZWNzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgdGhpcy5mYW1pbHkuZXhlY3NbaV0uY2FsbCh0aGlzLmZhbWlseV9kZWNvciwgdGhpcy5zdGF0ZSwgdGhpcy5JdGVtKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZmFtaWx5X2RlY29yID0gZmFsc2U7XG4gICAgfVxuICAgIGlmICh0aGlzLmdpdmVuKSB7XG4gICAgICAgIHRoaXMuZ2l2ZW5fZGVjb3IgPSBDU0wuVXRpbC5jbG9uZVRva2VuKHRoaXMuZ2l2ZW4pO1xuICAgICAgICB0aGlzLmdpdmVuX2RlY29yLnN0cmluZ3MucHJlZml4ID0gXCJcIjtcbiAgICAgICAgdGhpcy5naXZlbl9kZWNvci5zdHJpbmdzLnN1ZmZpeCA9IFwiXCI7XG4gICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSB0aGlzLmdpdmVuLmV4ZWNzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgdGhpcy5naXZlbi5leGVjc1tpXS5jYWxsKHRoaXMuZ2l2ZW5fZGVjb3IsIHRoaXMuc3RhdGUsIHRoaXMuSXRlbSk7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmdpdmVuX2RlY29yID0gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMuZ2V0RXRBbENvbmZpZygpO1xuICAgIHRoaXMuZGl2aWRlQW5kVHJhbnNsaXRlcmF0ZU5hbWVzKCk7XG4gICAgdGhpcy50cnVuY2F0ZVBlcnNvbmFsTmFtZUxpc3RzKCk7XG4gICAgdGhpcy5kaXNhbWJpZ05hbWVzKCk7XG4gICAgdGhpcy5jb25zdHJhaW5OYW1lcygpO1xuICAgIGlmICh0aGlzLm5hbWUuc3RyaW5ncy5mb3JtID09PSBcImNvdW50XCIpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLmV4dGVuc2lvbiB8fCB0aGlzLm5hbWVzX2NvdW50ICE9IDApIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZCh0aGlzLm5hbWVzX2NvdW50LCBcImVtcHR5XCIpO1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAudmFyaWFibGVfc3VjY2VzcyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNldEV0QWxQYXJhbWV0ZXJzKCk7XG4gICAgdGhpcy5zZXRDb21tb25UZXJtKCk7XG4gICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlID0ge307XG4gICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLmNoaWxkcmVuID0gW107XG4gICAgdGhpcy5yZW5kZXJBbGxOYW1lcygpO1xuICAgIHZhciBibG9iX2xpc3QgPSBbXTtcbiAgICBmb3IgKGkgPSAwLCBpbGVuID0gdmFyaWFibGVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgdiA9IHZhcmlhYmxlc1tpXTtcbiAgICAgICAgdmFyIGluc3RpdHV0aW9uX3NldHMgPSBbXTtcbiAgICAgICAgdmFyIGluc3RpdHV0aW9ucyA9IGZhbHNlO1xuICAgICAgICB2YXIgdmFyYmxvYiA9IG51bGw7XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5zcG9vZl9pbnN0aXR1dGlvbmFsX2FmZmlsaWF0aW9ucykge1xuICAgICAgICAgICAgdmFyYmxvYiA9IHRoaXMuX2pvaW4oW3RoaXMuZnJlZXRlcnNbdl1dLCBcIlwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gdGhpcy5pbnN0aXR1dGlvbnNbdl0ubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgaW5zdGl0dXRpb25fc2V0cy5wdXNoKHRoaXMuam9pblBlcnNvbnNBbmRJbnN0aXR1dGlvbnMoW3RoaXMucGVyc29uc1t2XVtqXSwgdGhpcy5pbnN0aXR1dGlvbnNbdl1bal1dKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5pbnN0aXR1dGlvbnNbdl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBvcyA9IHRoaXMubmFtZXNldF9iYXNlICsgdGhpcy52YXJpYWJsZV9vZmZzZXRbdl07XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZnJlZXRlcnNbdl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHBvcyArPSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpbnN0aXR1dGlvbnMgPSB0aGlzLmpvaW5JbnN0aXR1dGlvblNldHMoaW5zdGl0dXRpb25fc2V0cywgcG9zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciB2YXJibG9iID0gdGhpcy5qb2luRnJlZXRlcnNBbmRJbnN0aXR1dGlvblNldHMoW3RoaXMuZnJlZXRlcnNbdl0sIGluc3RpdHV0aW9uc10pO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YXJibG9iKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuc3RhdGUudG1wLmV4dGVuc2lvbikge1xuICAgICAgICAgICAgICAgIHZhcmJsb2IgPSB0aGlzLl9hcHBseUxhYmVscyh2YXJibG9iLCB2KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJsb2JfbGlzdC5wdXNoKHZhcmJsb2IpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmNvbW1vbl90ZXJtKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnN0YXRlLm91dHB1dC5vcGVuTGV2ZWwoXCJlbXB0eVwiKTtcbiAgICB0aGlzLnN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkuc3RyaW5ncy5kZWxpbWl0ZXIgPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lcywgXCJkZWxpbWl0ZXJcIiwgXCJuYW1lcy1kZWxpbWl0ZXJcIik7XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IGJsb2JfbGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKGJsb2JfbGlzdFtpXSwgXCJsaXRlcmFsXCIsIHRydWUpO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlLm91dHB1dC5jbG9zZUxldmVsKFwiZW1wdHlcIik7XG4gICAgdmFyIGJsb2IgPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICB2YXIgbmFtZXNUb2tlbiA9IENTTC5VdGlsLmNsb25lVG9rZW4odGhpcy5uYW1lcyk7XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKGJsb2IsIG5hbWVzVG9rZW4pO1xuICAgIGlmICh0aGlzLnN0YXRlLnRtcC50ZXJtX3ByZWRlY2Vzc29yX25hbWUpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS50bXAudGVybV9wcmVkZWNlc3NvciA9IHRydWU7XG4gICAgfVxuICAgIHRoaXMuc3RhdGUudG1wLm5hbWVfbm9kZS50b3AgPSB0aGlzLnN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCk7XG4gICAgaWYgKHZhcmlhYmxlc1swXSAhPT0gXCJhdXRob3JpdHlcIikge1xuICAgICAgICB2YXIgbmFtZV9ub2RlX3N0cmluZyA9IFtdO1xuICAgICAgICB2YXIgbmFtZW9ianMgPSB0aGlzLkl0ZW1bdmFyaWFibGVzWzBdXTtcbiAgICAgICAgaWYgKG5hbWVvYmpzKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG5hbWVvYmpzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIHZhciBzdWJzdHJpbmcgPSBDU0wuVXRpbC5OYW1lcy5nZXRSYXdOYW1lKG5hbWVvYmpzW2ldKTtcbiAgICAgICAgICAgICAgICBpZiAoc3Vic3RyaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVfbm9kZV9zdHJpbmcucHVzaChzdWJzdHJpbmcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBuYW1lX25vZGVfc3RyaW5nID0gbmFtZV9ub2RlX3N0cmluZy5qb2luKFwiLCBcIik7XG4gICAgICAgIGlmIChuYW1lX25vZGVfc3RyaW5nKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5uYW1lX25vZGUuc3RyaW5nID0gbmFtZV9ub2RlX3N0cmluZztcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLnN0cmluZyAmJiAhdGhpcy5zdGF0ZS50bXAuZmlyc3RfbmFtZV9zdHJpbmcpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS50bXAuZmlyc3RfbmFtZV9zdHJpbmcgPSB0aGlzLnN0YXRlLnRtcC5uYW1lX25vZGUuc3RyaW5nO1xuICAgIH1cbiAgICBpZiAoXCJjbGFzc2ljXCIgPT09IHRoaXMuSXRlbS50eXBlKSB7XG4gICAgICAgIHZhciBhdXRob3JfdGl0bGUgPSBbXTtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLmZpcnN0X25hbWVfc3RyaW5nKSB7XG4gICAgICAgICAgICBhdXRob3JfdGl0bGUucHVzaCh0aGlzLnN0YXRlLnRtcC5maXJzdF9uYW1lX3N0cmluZyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuSXRlbS50aXRsZSkge1xuICAgICAgICAgICAgYXV0aG9yX3RpdGxlLnB1c2godGhpcy5JdGVtLnRpdGxlKTtcbiAgICAgICAgfVxuICAgICAgICBhdXRob3JfdGl0bGUgPSBhdXRob3JfdGl0bGUuam9pbihcIiwgXCIpO1xuICAgICAgICBpZiAoYXV0aG9yX3RpdGxlICYmIHRoaXMuc3RhdGUuc3lzLmdldEFiYnJldmlhdGlvbikge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbihcImRlZmF1bHRcIiwgXCJjbGFzc2ljXCIsIGF1dGhvcl90aXRsZSk7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1tcImRlZmF1bHRcIl0uY2xhc3NpY1thdXRob3JfdGl0bGVdKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuZG9uZV92YXJzLnB1c2goXCJ0aXRsZVwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQodGhpcy5zdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1tcImRlZmF1bHRcIl0uY2xhc3NpY1thdXRob3JfdGl0bGVdLCBcImVtcHR5XCIsIHRydWUpO1xuICAgICAgICAgICAgICAgIGJsb2IgPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcblx0XHRcdFx0dGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLnRvcC5ibG9icy5wb3AoKTtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5uYW1lX25vZGUudG9wLmJsb2JzLnB1c2goYmxvYik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fY29sbGFwc2VBdXRob3IoKTtcbiAgICB0aGlzLnZhcmlhYmxlcyA9IFtdO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fYXBwbHlMYWJlbHMgPSBmdW5jdGlvbiAoYmxvYiwgdikge1xuICAgIHZhciB0eHQ7XG4gICAgaWYgKCF0aGlzLmxhYmVsIHx8ICF0aGlzLmxhYmVsW3RoaXMubGFiZWxWYXJpYWJsZV0pIHtcbiAgICAgICAgcmV0dXJuIGJsb2I7XG4gICAgfVxuICAgIHZhciBwbHVyYWwgPSAwO1xuICAgIHZhciBudW0gPSB0aGlzLmZyZWV0ZXJzX2NvdW50W3ZdICsgdGhpcy5pbnN0aXR1dGlvbnNfY291bnRbdl07XG4gICAgaWYgKG51bSA+IDEpIHtcbiAgICAgICAgcGx1cmFsID0gMTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMucGVyc29uc1t2XS5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIG51bSArPSB0aGlzLnBlcnNvbnNfY291bnRbdl1baV07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG51bSA+IDEpIHtcbiAgICAgICAgICAgIHBsdXJhbCA9IDE7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMubGFiZWxbdGhpcy5sYWJlbFZhcmlhYmxlXS5iZWZvcmUpIHtcbiAgICAgICAgaWYgKFwibnVtYmVyXCIgPT09IHR5cGVvZiB0aGlzLmxhYmVsW3RoaXMubGFiZWxWYXJpYWJsZV0uYmVmb3JlLnN0cmluZ3MucGx1cmFsKSB7XG4gICAgICAgICAgICBwbHVyYWwgPSB0aGlzLmxhYmVsW3RoaXMubGFiZWxWYXJpYWJsZV0uYmVmb3JlLnN0cmluZ3MucGx1cmFsO1xuICAgICAgICB9XG4gICAgICAgIHR4dCA9IHRoaXMuX2J1aWxkTGFiZWwodiwgcGx1cmFsLCBcImJlZm9yZVwiLCB0aGlzLmxhYmVsVmFyaWFibGUpO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5vcGVuTGV2ZWwoXCJlbXB0eVwiKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHR4dCwgdGhpcy5sYWJlbFt0aGlzLmxhYmVsVmFyaWFibGVdLmJlZm9yZSwgdHJ1ZSk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChibG9iLCBcImxpdGVyYWxcIiwgdHJ1ZSk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoXCJlbXB0eVwiKTtcbiAgICAgICAgYmxvYiA9IHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5sYWJlbFt0aGlzLmxhYmVsVmFyaWFibGVdLmFmdGVyKSB7XG4gICAgICAgIGlmIChcIm51bWJlclwiID09PSB0eXBlb2YgdGhpcy5sYWJlbFt0aGlzLmxhYmVsVmFyaWFibGVdLmFmdGVyLnN0cmluZ3MucGx1cmFsKSB7XG4gICAgICAgICAgICBwbHVyYWwgPSB0aGlzLmxhYmVsW3RoaXMubGFiZWxWYXJpYWJsZV0uYWZ0ZXIuc3RyaW5ncy5wbHVyYWw7XG4gICAgICAgIH1cbiAgICAgICAgdHh0ID0gdGhpcy5fYnVpbGRMYWJlbCh2LCBwbHVyYWwsIFwiYWZ0ZXJcIiwgdGhpcy5sYWJlbFZhcmlhYmxlKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQub3BlbkxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChibG9iLCBcImxpdGVyYWxcIiwgdHJ1ZSk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZCh0eHQsIHRoaXMubGFiZWxbdGhpcy5sYWJlbFZhcmlhYmxlXS5hZnRlciwgdHJ1ZSk7XG4gICAgICAgIHRoaXMuc3RhdGUudG1wLmxhYmVsX2Jsb2IgPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHRoaXMuc3RhdGUudG1wLmxhYmVsX2Jsb2IsXCJsaXRlcmFsXCIsdHJ1ZSk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoXCJlbXB0eVwiKTtcbiAgICAgICAgYmxvYiA9IHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgIH1cbiAgICByZXR1cm4gYmxvYjtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2J1aWxkTGFiZWwgPSBmdW5jdGlvbiAodGVybSwgcGx1cmFsLCBwb3NpdGlvbiwgdikge1xuICAgIGlmICh0aGlzLmNvbW1vbl90ZXJtKSB7XG4gICAgICAgIHRlcm0gPSB0aGlzLmNvbW1vbl90ZXJtO1xuICAgIH1cbiAgICB2YXIgcmV0ID0gZmFsc2U7XG4gICAgdmFyIG5vZGUgPSB0aGlzLmxhYmVsW3ZdW3Bvc2l0aW9uXTtcbiAgICBpZiAobm9kZSkge1xuICAgICAgICByZXQgPSBDU0wuY2FzdExhYmVsKHRoaXMuc3RhdGUsIG5vZGUsIHRlcm0sIHBsdXJhbCwgQ1NMLlRPTEVSQU5UKTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2NvbGxhcHNlQXV0aG9yID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBteXF1ZXVlLCBteXN0ciwgb2xkY2hhcnM7XG4gICAgaWYgKHRoaXMubmFtZXNldF9iYXNlID09PSAwICYmIHRoaXMuSXRlbVt0aGlzLnZhcmlhYmxlc1swXV0gJiYgIXRoaXMuX2ZpcnN0X2NyZWF0b3JfdmFyaWFibGUpIHtcbiAgICAgICAgdGhpcy5fZmlyc3RfY3JlYXRvcl92YXJpYWJsZSA9IHRoaXMudmFyaWFibGVzWzBdO1xuICAgIH1cbiAgICBpZiAoKHRoaXMuaXRlbSAmJiB0aGlzLml0ZW1bXCJzdXBwcmVzcy1hdXRob3JcIl0gJiYgdGhpcy5fZmlyc3RfY3JlYXRvcl92YXJpYWJsZSA9PSB0aGlzLnZhcmlhYmxlc1swXSlcbiAgICAgICAgfHwgKHRoaXMuc3RhdGVbdGhpcy5zdGF0ZS50bXAuYXJlYV0ub3B0LmNvbGxhcHNlIFxuICAgICAgICAgICAgJiYgdGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5vcHQuY29sbGFwc2UubGVuZ3RoKVxuICAgICAgICB8fCAodGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXIgXG4gICAgICAgICAgICAmJiB0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlci5sZW5ndGgpKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnRtcC5hdXRob3JzdHJpbmdfcmVxdWVzdCkge1xuICAgICAgICAgICAgbXlzdHIgPSBcIlwiO1xuICAgICAgICAgICAgbXlxdWV1ZSA9IHRoaXMuc3RhdGUudG1wLm5hbWVfbm9kZS50b3AuYmxvYnMuc2xpY2UoLTEpWzBdLmJsb2JzO1xuICAgICAgICAgICAgb2xkY2hhcnMgPSB0aGlzLnN0YXRlLnRtcC5vZmZzZXRfY2hhcmFjdGVycztcbiAgICAgICAgICAgIGlmIChteXF1ZXVlKSB7XG4gICAgICAgICAgICAgICAgbXlzdHIgPSB0aGlzLnN0YXRlLm91dHB1dC5zdHJpbmcodGhpcy5zdGF0ZSwgbXlxdWV1ZSwgZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAub2Zmc2V0X2NoYXJhY3RlcnMgPSBvbGRjaGFycztcbiAgICAgICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkuYXV0aG9yc3RyaW5nc1t0aGlzLkl0ZW0uaWRdID0gbXlzdHI7XG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuc3RhdGUudG1wLmp1c3RfbG9va2luZ1xuICAgICAgICAgICAgICAgICAgICYmICF0aGlzLnN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucyAmJiAodGhpcy5pdGVtW1wic3VwcHJlc3MtYXV0aG9yXCJdIHx8ICh0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLm9wdC5jb2xsYXBzZSAmJiB0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLm9wdC5jb2xsYXBzZS5sZW5ndGgpIHx8IHRoaXMuc3RhdGVbdGhpcy5zdGF0ZS50bXAuYXJlYV0ub3B0LmNpdGVfZ3JvdXBfZGVsaW1pdGVyICYmIHRoaXMuc3RhdGVbdGhpcy5zdGF0ZS50bXAuYXJlYV0ub3B0LmNpdGVfZ3JvdXBfZGVsaW1pdGVyKSkge1xuICAgICAgICAgICAgbXlzdHIgPSBcIlwiO1xuICAgICAgICAgICAgbXlxdWV1ZSA9IHRoaXMuc3RhdGUudG1wLm5hbWVfbm9kZS50b3AuYmxvYnMuc2xpY2UoLTEpWzBdLmJsb2JzO1xuICAgICAgICAgICAgb2xkY2hhcnMgPSB0aGlzLnN0YXRlLnRtcC5vZmZzZXRfY2hhcmFjdGVycztcbiAgICAgICAgICAgIGlmIChteXF1ZXVlKSB7XG4gICAgICAgICAgICAgICAgbXlzdHIgPSB0aGlzLnN0YXRlLm91dHB1dC5zdHJpbmcodGhpcy5zdGF0ZSwgbXlxdWV1ZSwgZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG15c3RyID09PSB0aGlzLnN0YXRlLnRtcC5sYXN0X3ByaW1hcnlfbmFtZXNfc3RyaW5nKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaXRlbVtcInN1cHByZXNzLWF1dGhvclwiXSB8fCAodGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5vcHQuY29sbGFwc2UgJiYgdGhpcy5zdGF0ZVt0aGlzLnN0YXRlLnRtcC5hcmVhXS5vcHQuY29sbGFwc2UubGVuZ3RoKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5uYW1lX25vZGUudG9wLmJsb2JzLnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5uYW1lX25vZGUuY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAub2Zmc2V0X2NoYXJhY3RlcnMgPSBvbGRjaGFycztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGVbdGhpcy5zdGF0ZS50bXAuYXJlYV0ub3B0LmNpdGVfZ3JvdXBfZGVsaW1pdGVyICYmIHRoaXMuc3RhdGVbdGhpcy5zdGF0ZS50bXAuYXJlYV0ub3B0LmNpdGVfZ3JvdXBfZGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLnVzZV9jaXRlX2dyb3VwX2RlbGltaXRlciA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5sYXN0X3ByaW1hcnlfbmFtZXNfc3RyaW5nID0gbXlzdHI7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudmFyaWFibGVzLmluZGV4T2YodGhpcy5fZmlyc3RfY3JlYXRvcl92YXJpYWJsZSkgPiAtMSAmJiB0aGlzLml0ZW0gJiYgdGhpcy5pdGVtW1wic3VwcHJlc3MtYXV0aG9yXCJdICYmIHRoaXMuSXRlbS50eXBlICE9PSBcImxlZ2FsX2Nhc2VcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5uYW1lX25vZGUudG9wLmJsb2JzLnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5uYW1lX25vZGUuY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAub2Zmc2V0X2NoYXJhY3RlcnMgPSBvbGRjaGFycztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudGVybV9wcmVkZWNlc3NvciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5oYXZlX2NvbGxhcHNlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlciAmJiB0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlcikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC51c2VfY2l0ZV9ncm91cF9kZWxpbWl0ZXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuaXNQZXJzb24gPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICBpZiAodmFsdWUubGl0ZXJhbFxuICAgICAgICB8fCAoIXZhbHVlLmdpdmVuICYmIHZhbHVlLmZhbWlseSAmJiB2YWx1ZS5pc0luc3RpdHV0aW9uKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLnRydW5jYXRlUGVyc29uYWxOYW1lTGlzdHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHYsIGksIGlsZW4sIGosIGpsZW4sIGNob3B2YXIsIHZhbHVlcztcbiAgICB0aGlzLmZyZWV0ZXJzX2NvdW50ID0ge307XG4gICAgdGhpcy5wZXJzb25zX2NvdW50ID0ge307XG4gICAgdGhpcy5pbnN0aXR1dGlvbnNfY291bnQgPSB7fTtcbiAgICBmb3IgKHYgaW4gdGhpcy5mcmVldGVycykge1xuICAgICAgICBpZiAodGhpcy5mcmVldGVycy5oYXNPd25Qcm9wZXJ0eSh2KSkge1xuICAgICAgICAgICAgdGhpcy5mcmVldGVyc19jb3VudFt2XSA9IHRoaXMuZnJlZXRlcnNbdl0ubGVuZ3RoO1xuICAgICAgICAgICAgdGhpcy5mcmVldGVyc1t2XSA9IHRoaXMuX3RydW5jYXRlTmFtZUxpc3QodGhpcy5mcmVldGVycywgdik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yICh2IGluIHRoaXMucGVyc29ucykge1xuICAgICAgICBpZiAodGhpcy5wZXJzb25zLmhhc093blByb3BlcnR5KHYpKSB7XG4gICAgICAgICAgICB0aGlzLmluc3RpdHV0aW9uc19jb3VudFt2XSA9IHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aDtcbiAgICAgICAgICAgIHRoaXMuX3RydW5jYXRlTmFtZUxpc3QodGhpcy5pbnN0aXR1dGlvbnMsIHYpO1xuICAgICAgICAgICAgdGhpcy5wZXJzb25zW3ZdID0gdGhpcy5wZXJzb25zW3ZdLnNsaWNlKDAsIHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aCk7XG4gICAgICAgICAgICB0aGlzLnBlcnNvbnNfY291bnRbdl0gPSBbXTtcbiAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSB0aGlzLnBlcnNvbnNbdl0ubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wZXJzb25zX2NvdW50W3ZdW2pdID0gdGhpcy5wZXJzb25zW3ZdW2pdLmxlbmd0aDtcbiAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbnNbdl1bal0gPSB0aGlzLl90cnVuY2F0ZU5hbWVMaXN0KHRoaXMucGVyc29ucywgdiwgaik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuZXRhbF9taW4gPT09IDEgJiYgdGhpcy5ldGFsX3VzZV9maXJzdCA9PT0gMSBcbiAgICAgICAgJiYgISh0aGlzLnN0YXRlLnRtcC5leHRlbnNpb25cbiAgICAgICAgICAgICB8fCB0aGlzLnN0YXRlLnRtcC5qdXN0X2xvb2tpbmcpKSB7XG4gICAgICAgIGNob3B2YXIgPSB2O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNob3B2YXIgPSBmYWxzZTtcbiAgICB9XG4gICAgaWYgKGNob3B2YXIgfHwgdGhpcy5fcGxlYXNlX2Nob3ApIHtcbiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHRoaXMudmFyaWFibGVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgdiA9IHRoaXMudmFyaWFibGVzW2ldO1xuICAgICAgICAgICAgaWYgKHRoaXMuZnJlZXRlcnNbdl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BsZWFzZV9jaG9wID09PSB2KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNbdl0gPSB0aGlzLmZyZWV0ZXJzW3ZdLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWV0ZXJzX2NvdW50W3ZdICs9IC0xO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wbGVhc2VfY2hvcCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hvcHZhciAmJiAhdGhpcy5fcGxlYXNlX2Nob3ApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmVldGVyc1t2XSA9IHRoaXMuZnJlZXRlcnNbdl0uc2xpY2UoMCwgMSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNfY291bnRbdl0gPSAxO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmluc3RpdHV0aW9uc1t2XSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbnNbdl0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGxlYXNlX2Nob3AgPSBjaG9wdmFyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuID0gdGhpcy5wZXJzb25zW3ZdLmxlbmd0aDtqPGpsZW47aisrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucGVyc29uc1t2XVtqXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BsZWFzZV9jaG9wID09PSB2KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbnNbdl1bal0gPSB0aGlzLnBlcnNvbnNbdl1bal0uc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbnNfY291bnRbdl1bal0gKz0gLTE7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wbGVhc2VfY2hvcCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hvcHZhciAmJiAhdGhpcy5fcGxlYXNlX2Nob3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNbdl0gPSB0aGlzLnBlcnNvbnNbdl1bal0uc2xpY2UoMCwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWV0ZXJzX2NvdW50W3ZdID0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zdGl0dXRpb25zW3ZdID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbnNbdl0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGxlYXNlX2Nob3AgPSBjaG9wdmFyO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5pbnN0aXR1dGlvbnNbdl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BsZWFzZV9jaG9wID09PSB2KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zdGl0dXRpb25zW3ZdID0gdGhpcy5pbnN0aXR1dGlvbnNbdl0uc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zdGl0dXRpb25zX2NvdW50W3ZdICs9IC0xO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wbGVhc2VfY2hvcCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hvcHZhciAmJiAhdGhpcy5fcGxlYXNlX2Nob3ApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnN0aXR1dGlvbnNbdl0gPSB0aGlzLmluc3RpdHV0aW9uc1t2XS5zbGljZSgwLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnN0aXR1dGlvbnNfY291bnRbdl0gPSAxO1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGxlYXNlX2Nob3AgPSBjaG9wdmFyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGkgPSAwLCBpbGVuID0gdGhpcy52YXJpYWJsZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGlmICh0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMubmFtZXNldF9vZmZzZXQgKz0gMTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBqPTAsamxlbj10aGlzLnBlcnNvbnNbdl0ubGVuZ3RoO2o8amxlbjtqKyspIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnBlcnNvbnNbdl1bal0ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lc2V0X29mZnNldCArPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fdHJ1bmNhdGVOYW1lTGlzdCA9IGZ1bmN0aW9uIChjb250YWluZXIsIHZhcmlhYmxlLCBpbmRleCkge1xuICAgIHZhciBsc3Q7XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBpbmRleCkge1xuICAgICAgICBsc3QgPSBjb250YWluZXJbdmFyaWFibGVdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxzdCA9IGNvbnRhaW5lclt2YXJpYWJsZV1baW5kZXhdO1xuICAgIH1cbiAgICBpZiAodGhpcy5zdGF0ZVt0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLnJvb3RdLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzIFxuICAgICAgICAmJiBsc3QubGVuZ3RoID4gNTAgXG4gICAgICAgICYmIGxzdC5sZW5ndGggPiAodGhpcy5zdGF0ZVt0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLnJvb3RdLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzICsgMikpIHtcbiAgICAgICAgdmFyIGxpbWl0ID0gdGhpcy5zdGF0ZVt0aGlzLnN0YXRlW3RoaXMuc3RhdGUudG1wLmFyZWFdLnJvb3RdLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzO1xuICAgICAgICBsc3QgPSBsc3Quc2xpY2UoMCwgbGltaXQrMSkuY29uY2F0KGxzdC5zbGljZSgtMSkpO1xuICAgIH1cbiAgICByZXR1cm4gbHN0O1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmRpdmlkZUFuZFRyYW5zbGl0ZXJhdGVOYW1lcyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgaSwgaWxlbiwgaiwgamxlbjtcbiAgICB2YXIgSXRlbSA9IHRoaXMuSXRlbTtcbiAgICB2YXIgdmFyaWFibGVzID0gdGhpcy52YXJpYWJsZXM7XG4gICAgdGhpcy52YXJuYW1lcyA9IHZhcmlhYmxlcy5zbGljZSgpO1xuICAgIHRoaXMuZnJlZXRlcnMgPSB7fTtcbiAgICB0aGlzLnBlcnNvbnMgPSB7fTtcbiAgICB0aGlzLmluc3RpdHV0aW9ucyA9IHt9O1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSB2YXJpYWJsZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciB2ID0gdmFyaWFibGVzW2ldO1xuICAgICAgICB0aGlzLnZhcmlhYmxlX29mZnNldFt2XSA9IHRoaXMubmFtZXNldF9vZmZzZXQ7XG4gICAgICAgIHZhciB2YWx1ZXMgPSB0aGlzLl9ub3JtYWxpemVWYXJpYWJsZVZhbHVlKEl0ZW0sIHYpO1xuICAgICAgICBpZiAodGhpcy5uYW1lLnN0cmluZ3NbXCJzdXBwcmVzcy1taW5cIl0gJiYgdmFsdWVzLmxlbmd0aCA+PSB0aGlzLm5hbWUuc3RyaW5nc1tcInN1cHByZXNzLW1pblwiXSkge1xuICAgICAgICAgICAgdmFsdWVzID0gW107XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubmFtZS5zdHJpbmdzW1wic3VwcHJlc3MtbWF4XCJdICYmIHZhbHVlcy5sZW5ndGggPD0gdGhpcy5uYW1lLnN0cmluZ3NbXCJzdXBwcmVzcy1tYXhcIl0pIHtcbiAgICAgICAgICAgIHZhbHVlcyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2dldEZyZWV0ZXJzKHYsIHZhbHVlcyk7XG4gICAgICAgIHRoaXMuX2dldFBlcnNvbnNBbmRJbnN0aXR1dGlvbnModiwgdmFsdWVzKTtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3Bvb2ZfaW5zdGl0dXRpb25hbF9hZmZpbGlhdGlvbnMpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLm5hbWUuc3RyaW5nc1tcInN1cHByZXNzLW1pblwiXSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNbdl0gPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gdGhpcy5wZXJzb25zW3ZdLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbnNbdl1bal0gPSBbXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcInN1cHByZXNzLW1pblwiXSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuaW5zdGl0dXRpb25zW3ZdID0gW107XG4gICAgICAgICAgICAgICAgdGhpcy5mcmVldGVyc1t2XSA9IHRoaXMuZnJlZXRlcnNbdl0uY29uY2F0KHRoaXMucGVyc29uc1t2XSk7XG4gICAgICAgICAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IHRoaXMucGVyc29uc1t2XS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGtsZW4gPSB0aGlzLnBlcnNvbnNbdl1bal0ubGVuZ3RoOyBrIDwga2xlbjsgayArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWV0ZXJzW3ZdLnB1c2godGhpcy5wZXJzb25zW3ZdW2pdW2tdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbnNbdl0gPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX25vcm1hbGl6ZVZhcmlhYmxlVmFsdWUgPSBmdW5jdGlvbiAoSXRlbSwgdmFyaWFibGUpIHtcbiAgICB2YXIgbmFtZXMsIG5hbWUsIGksIGlsZW47XG4gICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBJdGVtW3ZhcmlhYmxlXSB8fCBcIm51bWJlclwiID09PSB0eXBlb2YgSXRlbVt2YXJpYWJsZV0pIHtcbiAgICAgICAgQ1NMLmRlYnVnKFwibmFtZSB2YXJpYWJsZSBcXFwiXCIgKyB2YXJpYWJsZSArIFwiXFxcIiBpcyBzdHJpbmcgb3IgbnVtYmVyLCBub3QgYXJyYXkuIEF0dGVtcHRpbmcgdG8gZml4LlwiKTtcbiAgICAgICAgbmFtZXMgPSBbe2xpdGVyYWw6IEl0ZW1bdmFyaWFibGVdICsgXCJcIn1dO1xuICAgIH0gZWxzZSBpZiAoIUl0ZW1bdmFyaWFibGVdKSB7XG4gICAgICAgIG5hbWVzID0gW107XG4gICAgfSBlbHNlIGlmIChcIm51bWJlclwiICE9PSB0eXBlb2YgSXRlbVt2YXJpYWJsZV0ubGVuZ3RoKSB7XG4gICAgICAgIENTTC5kZWJ1ZyhcIm5hbWUgdmFyaWFibGUgXFxcIlwiICsgdmFyaWFibGUgKyBcIlxcXCIgaXMgb2JqZWN0LCBub3QgYXJyYXkuIEF0dGVtcHRpbmcgdG8gZml4LlwiKTtcbiAgICAgICAgSXRlbVt2YXJpYWJsZV0gPSBbSXRlbVt2YXJpYWJsZV1dO1xuICAgICAgICBuYW1lcyA9IEl0ZW1bdmFyaWFibGVdLnNsaWNlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbmFtZXMgPSBJdGVtW3ZhcmlhYmxlXS5zbGljZSgpO1xuICAgIH1cbiAgICByZXR1cm4gbmFtZXM7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9nZXRGcmVldGVycyA9IGZ1bmN0aW9uICh2LCB2YWx1ZXMpIHtcbiAgICB0aGlzLmZyZWV0ZXJzW3ZdID0gW107XG4gICAgaWYgKHRoaXMuc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3Bvb2ZfaW5zdGl0dXRpb25hbF9hZmZpbGlhdGlvbnMpIHtcbiAgICAgICAgZm9yICh2YXIgaT12YWx1ZXMubGVuZ3RoLTE7aT4tMTtpLS0pIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmlzUGVyc29uKHZhbHVlc1tpXSkpIHtcbiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLl9jaGVja05pY2tuYW1lKHZhbHVlcy5wb3AoKSk7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNbdl0ucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGZvciAodmFyIGk9dmFsdWVzLmxlbmd0aC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICB2YXIgdmFsdWUgPSB2YWx1ZXMucG9wKCk7XG4gICAgICAgICAgICBpZiAodGhpcy5pc1BlcnNvbih2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLl9jaGVja05pY2tuYW1lKHZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZnJlZXRlcnNbdl0ucHVzaCh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5mcmVldGVyc1t2XS5yZXZlcnNlKCk7XG4gICAgaWYgKHRoaXMuZnJlZXRlcnNbdl0ubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMubmFtZXNldF9vZmZzZXQgKz0gMTtcbiAgICB9XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9nZXRQZXJzb25zQW5kSW5zdGl0dXRpb25zID0gZnVuY3Rpb24gKHYsIHZhbHVlcykge1xuICAgIHRoaXMucGVyc29uc1t2XSA9IFtdO1xuICAgIHRoaXMuaW5zdGl0dXRpb25zW3ZdID0gW107XG4gICAgaWYgKCF0aGlzLnN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLnNwb29mX2luc3RpdHV0aW9uYWxfYWZmaWxpYXRpb25zKSByZXR1cm47XG4gICAgdmFyIHBlcnNvbnMgPSBbXTtcbiAgICB2YXIgaGFzX2FmZmlsaWF0ZXMgPSBmYWxzZTtcbiAgICB2YXIgZmlyc3QgPSB0cnVlO1xuICAgIGZvciAodmFyIGkgPSB2YWx1ZXMubGVuZ3RoIC0gMTsgaSA+IC0xOyBpICs9IC0xKSB7XG4gICAgICAgIGlmICh0aGlzLmlzUGVyc29uKHZhbHVlc1tpXSkpIHtcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX2NoZWNrTmlja25hbWUodmFsdWVzW2ldKTtcbiAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgIHBlcnNvbnMucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBoYXNfYWZmaWxpYXRlcyA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmluc3RpdHV0aW9uc1t2XS5wdXNoKHZhbHVlc1tpXSk7XG4gICAgICAgICAgICBpZiAoIWZpcnN0KSB7XG4gICAgICAgICAgICAgICAgcGVyc29ucy5yZXZlcnNlKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5wZXJzb25zW3ZdLnB1c2gocGVyc29ucyk7XG4gICAgICAgICAgICAgICAgcGVyc29ucyA9IFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZmlyc3QgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoaGFzX2FmZmlsaWF0ZXMpIHtcbiAgICAgICAgcGVyc29ucy5yZXZlcnNlKCk7XG4gICAgICAgIHRoaXMucGVyc29uc1t2XS5wdXNoKHBlcnNvbnMpO1xuICAgICAgICB0aGlzLnBlcnNvbnNbdl0ucmV2ZXJzZSgpO1xuICAgICAgICB0aGlzLmluc3RpdHV0aW9uc1t2XS5yZXZlcnNlKCk7XG4gICAgfVxufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fY2xlYXJWYWx1ZXMgPSBmdW5jdGlvbiAodmFsdWVzKSB7XG4gICAgZm9yICh2YXIgaSA9IHZhbHVlcy5sZW5ndGggLSAxOyBpID4gLTE7IGkgKz0gLTEpIHtcbiAgICAgICAgdmFsdWVzLnBvcCgpO1xuICAgIH1cbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2NoZWNrTmlja25hbWUgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIGlmIChbXCJpbnRlcnZpZXdcIiwgXCJwZXJzb25hbF9jb21tdW5pY2F0aW9uXCJdLmluZGV4T2YodGhpcy5JdGVtLnR5cGUpID4gLTEpIHtcbiAgICAgICAgdmFyIGF1dGhvciA9IFwiXCI7XG4gICAgICAgIGF1dGhvciA9IENTTC5VdGlsLk5hbWVzLmdldFJhd05hbWUobmFtZSk7XG4gICAgICAgIGlmIChhdXRob3IgJiYgdGhpcy5zdGF0ZS5zeXMuZ2V0QWJicmV2aWF0aW9uICYmICEodGhpcy5pdGVtICYmIHRoaXMuaXRlbVtcInN1cHByZXNzLWF1dGhvclwiXSkpIHtcbiAgICAgICAgICAgIHZhciBub3JtYWxpemVkS2V5ID0gYXV0aG9yO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUuc3lzLm5vcm1hbGl6ZUFiYnJldnNLZXkpIHtcbiAgICAgICAgICAgICAgICBub3JtYWxpemVkS2V5ID0gdGhpcy5zdGF0ZS5zeXMubm9ybWFsaXplQWJicmV2c0tleShhdXRob3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zdGF0ZS50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbihcImRlZmF1bHRcIiwgXCJuaWNrbmFtZVwiLCBub3JtYWxpemVkS2V5KTtcbiAgICAgICAgICAgIHZhciBteUxvY2FsTmFtZSA9IHRoaXMuc3RhdGUudHJhbnNmb3JtLmFiYnJldnNbXCJkZWZhdWx0XCJdLm5pY2tuYW1lW25vcm1hbGl6ZWRLZXldO1xuICAgICAgICAgICAgaWYgKG15TG9jYWxOYW1lKSB7XG4gICAgICAgICAgICAgICAgaWYgKG15TG9jYWxOYW1lID09PSBcIiFoZXJlPj4+XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWUgPSB7ZmFtaWx5Om15TG9jYWxOYW1lLGdpdmVuOicnfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5hbWU7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuam9pblBlcnNvbnMgPSBmdW5jdGlvbiAoYmxvYnMsIHBvcywgaiwgdG9rZW5uYW1lKSB7XG4gICAgdmFyIHJldDtcbiAgICBpZiAoIXRva2VubmFtZSkge1xuICAgICAgICB0b2tlbm5hbWUgPSBcIm5hbWVcIjtcbiAgICB9XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBqKSB7XG4gICAgICAgIGlmICh0aGlzLmV0YWxfc3BlY1twb3NdLmZyZWV0ZXJzID09PSAxKSB7XG4gICAgICAgICAgIHJldCA9IHRoaXMuX2pvaW5FdEFsKGJsb2JzLCB0b2tlbm5hbWUpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZXRhbF9zcGVjW3Bvc10uZnJlZXRlcnMgPT09IDIpIHtcbiAgICAgICAgICAgIHJldCA9IHRoaXMuX2pvaW5FbGxpcHNpcyhibG9icywgdG9rZW5uYW1lKTtcbiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5zdGF0ZS50bXAuc29ydF9rZXlfZmxhZykge1xuICAgICAgICAgICAgcmV0ID0gdGhpcy5fam9pbkFuZChibG9icywgdG9rZW5uYW1lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldCA9IHRoaXMuX2pvaW4oYmxvYnMsIFwiIFwiKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0aGlzLmV0YWxfc3BlY1twb3NdLnBlcnNvbnNbal0gPT09IDEpIHtcbiAgICAgICAgICAgIHJldCA9IHRoaXMuX2pvaW5FdEFsKGJsb2JzLCB0b2tlbm5hbWUpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZXRhbF9zcGVjW3Bvc10ucGVyc29uc1tqXSA9PT0gMikge1xuICAgICAgICAgICAgcmV0ID0gdGhpcy5fam9pbkVsbGlwc2lzKGJsb2JzLCB0b2tlbm5hbWUpO1xuICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLnN0YXRlLnRtcC5zb3J0X2tleV9mbGFnKSB7XG4gICAgICAgICAgICByZXQgPSB0aGlzLl9qb2luQW5kKGJsb2JzLCB0b2tlbm5hbWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0ID0gdGhpcy5fam9pbihibG9icywgXCIgXCIpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmpvaW5JbnN0aXR1dGlvblNldHMgPSBmdW5jdGlvbiAoYmxvYnMsIHBvcykge1xuICAgIHZhciByZXQ7XG4gICAgaWYgKHRoaXMuZXRhbF9zcGVjW3Bvc10uaW5zdGl0dXRpb25zID09PSAxKSB7XG4gICAgICAgIHJldCA9IHRoaXMuX2pvaW5FdEFsKGJsb2JzLCBcImluc3RpdHV0aW9uXCIpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5ldGFsX3NwZWNbcG9zXS5pbnN0aXR1dGlvbnMgPT09IDIpIHtcbiAgICAgICAgcmV0ID0gdGhpcy5fam9pbkVsbGlwc2lzKGJsb2JzLCBcImluc3RpdHV0aW9uXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldCA9IHRoaXMuX2pvaW5BbmQoYmxvYnMsIFwiaW5zdGl0dXRpb25cIik7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmpvaW5QZXJzb25zQW5kSW5zdGl0dXRpb25zID0gZnVuY3Rpb24gKGJsb2JzKSB7XG4gICAgcmV0dXJuIHRoaXMuX2pvaW4oYmxvYnMsIHRoaXMuc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyKTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuam9pbkZyZWV0ZXJzQW5kSW5zdGl0dXRpb25TZXRzID0gZnVuY3Rpb24gKGJsb2JzKSB7XG4gICAgdmFyIHJldCA9IHRoaXMuX2pvaW4oYmxvYnMsIFwiW25ldmVyIGhlcmVdXCIsIHRoaXNbXCJ3aXRoXCJdLnNpbmdsZSwgdGhpc1tcIndpdGhcIl0ubXVsdGlwbGUpO1xuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9qb2luRXRBbCA9IGZ1bmN0aW9uIChibG9icywgdG9rZW5uYW1lKSB7XG4gICAgdmFyIGJsb2IgPSB0aGlzLl9qb2luKGJsb2JzLCB0aGlzLnN0YXRlLnRtcC5uYW1lX2RlbGltaXRlcik7XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQub3BlbkxldmVsKHRoaXMuX2dldFRva2VuKHRva2VubmFtZSkpO1xuICAgIHRoaXMuc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5zdHJpbmdzLmRlbGltaXRlciA9IFwiXCI7XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKGJsb2IsIFwibGl0ZXJhbFwiLCB0cnVlKTtcbiAgICBpZiAoYmxvYnMubGVuZ3RoID4gMSkge1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQodGhpc1tcImV0LWFsXCJdLm11bHRpcGxlLCBcImxpdGVyYWxcIiwgdHJ1ZSk7XG4gICAgfSBlbHNlIGlmIChibG9icy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHRoaXNbXCJldC1hbFwiXS5zaW5nbGUsIFwibGl0ZXJhbFwiLCB0cnVlKTtcbiAgICB9XG4gICAgdGhpcy5zdGF0ZS5vdXRwdXQuY2xvc2VMZXZlbCgpO1xuICAgIHJldHVybiB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2pvaW5FbGxpcHNpcyA9IGZ1bmN0aW9uIChibG9icywgdG9rZW5uYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuX2pvaW4oYmxvYnMsIHRoaXMuc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyLCB0aGlzLm5hbWUuZWxsaXBzaXMuc2luZ2xlLCB0aGlzLm5hbWUuZWxsaXBzaXMubXVsdGlwbGUsIHRva2VubmFtZSk7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9qb2luQW5kID0gZnVuY3Rpb24gKGJsb2JzLCB0b2tlbm5hbWUpIHtcbiAgICByZXR1cm4gdGhpcy5fam9pbihibG9icywgdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXNbdG9rZW5uYW1lXSwgXCJkZWxpbWl0ZXJcIiwgKHRva2VubmFtZSArIFwiLWRlbGltaXRlclwiKSwgXCIsIFwiKSwgdGhpc1t0b2tlbm5hbWVdLmFuZC5zaW5nbGUsIHRoaXNbdG9rZW5uYW1lXS5hbmQubXVsdGlwbGUsIHRva2VubmFtZSk7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9qb2luID0gZnVuY3Rpb24gKGJsb2JzLCBkZWxpbWl0ZXIsIHNpbmdsZSwgbXVsdGlwbGUsIHRva2VubmFtZSkge1xuICAgIHZhciBpLCBpbGVuO1xuICAgIGlmICghYmxvYnMpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBmb3IgKGkgPSBibG9icy5sZW5ndGggLSAxOyBpID4gLTE7IGkgKz0gLTEpIHtcbiAgICAgICAgaWYgKCFibG9ic1tpXSB8fCBibG9ic1tpXS5sZW5ndGggPT09IDAgfHwgIWJsb2JzW2ldLmJsb2JzLmxlbmd0aCkge1xuICAgICAgICAgICAgYmxvYnMgPSBibG9icy5zbGljZSgwLCBpKS5jb25jYXQoYmxvYnMuc2xpY2UoaSArIDEpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoIWJsb2JzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSBlbHNlIGlmIChzaW5nbGUgJiYgYmxvYnMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgIGlmIChzaW5nbGUpIHtcbiAgICAgICAgICAgIHNpbmdsZSA9IG5ldyBDU0wuQmxvYihzaW5nbGUuYmxvYnMsc2luZ2xlKTtcbiAgICAgICAgfVxuICAgICAgICBibG9icyA9IFtibG9ic1swXSwgc2luZ2xlLCBibG9ic1sxXV07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGRlbGltaXRlcl9vZmZzZXQ7XG4gICAgICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgICAgICAgZGVsaW1pdGVyX29mZnNldCA9IDI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkZWxpbWl0ZXJfb2Zmc2V0ID0gMTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gYmxvYnMubGVuZ3RoIC0gZGVsaW1pdGVyX29mZnNldDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgYmxvYnNbaV0uc3RyaW5ncy5zdWZmaXggKz0gZGVsaW1pdGVyO1xuICAgICAgICB9XG4gICAgICAgIGlmIChibG9icy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICB2YXIgYmxvYiA9IGJsb2JzLnBvcCgpO1xuICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgbXVsdGlwbGUgPSBuZXcgQ1NMLkJsb2IobXVsdGlwbGUuYmxvYnMsbXVsdGlwbGUpO1xuICAgICAgICAgICAgICAgIGJsb2JzLnB1c2gobXVsdGlwbGUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoc2luZ2xlKSB7XG4gICAgICAgICAgICAgICAgICAgIHNpbmdsZSA9IG5ldyBDU0wuQmxvYihzaW5nbGUuYmxvYnMsc2luZ2xlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYmxvYnMucHVzaChzaW5nbGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYmxvYnMucHVzaChibG9iKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnN0YXRlLm91dHB1dC5vcGVuTGV2ZWwoKTtcbiAgICBpZiAoc2luZ2xlICYmIG11bHRpcGxlKSB7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmN1cnJlbnQudmFsdWUoKS5zdHJpbmdzLmRlbGltaXRlciA9IFwiXCI7XG4gICAgfVxuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBibG9icy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKGJsb2JzW2ldLCBmYWxzZSwgdHJ1ZSk7XG4gICAgfVxuICAgIHRoaXMuc3RhdGUub3V0cHV0LmNsb3NlTGV2ZWwoKTtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9nZXRUb2tlbiA9IGZ1bmN0aW9uICh0b2tlbm5hbWUpIHtcbiAgICB2YXIgdG9rZW4gPSB0aGlzW3Rva2VubmFtZV07XG4gICAgaWYgKHRva2VubmFtZSA9PT0gXCJpbnN0aXR1dGlvblwiKSB7XG4gICAgICAgIHZhciBuZXd0b2tlbiA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICAgICAgcmV0dXJuIG5ld3Rva2VuO1xuICAgIH1cbiAgICByZXR1cm4gdG9rZW47XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuc2V0Q29tbW9uVGVybSA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgdmFyaWFibGVzID0gdGhpcy52YXJpYWJsZXM7XG4gICAgdmFyIHZhcm5hbWVzID0gdmFyaWFibGVzLnNsaWNlKCk7XG4gICAgdmFybmFtZXMuc29ydCgpO1xuICAgIHRoaXMuY29tbW9uX3Rlcm0gPSB2YXJuYW1lcy5qb2luKFwiXCIpO1xuICAgIGlmICghdGhpcy5jb21tb25fdGVybSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHZhciBoYXNfdGVybSA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmxhYmVsICYmIHRoaXMubGFiZWxbdGhpcy52YXJpYWJsZXNbMF1dKSB7XG4gICAgICAgIGlmICh0aGlzLmxhYmVsW3RoaXMudmFyaWFibGVzWzBdXS5iZWZvcmUpIHtcbiAgICAgICAgICAgIGhhc190ZXJtID0gdGhpcy5zdGF0ZS5nZXRUZXJtKHRoaXMuY29tbW9uX3Rlcm0sIHRoaXMubGFiZWxbdGhpcy52YXJpYWJsZXNbMF1dLmJlZm9yZS5zdHJpbmdzLmZvcm0sIDApO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMubGFiZWxbdGhpcy52YXJpYWJsZXNbMF1dLmFmdGVyKSB7XG4gICAgICAgICAgICBoYXNfdGVybSA9IHRoaXMuc3RhdGUuZ2V0VGVybSh0aGlzLmNvbW1vbl90ZXJtLCB0aGlzLmxhYmVsW3RoaXMudmFyaWFibGVzWzBdXS5hZnRlci5zdHJpbmdzLmZvcm0sIDApO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghdGhpcy5zdGF0ZS5sb2NhbGVbdGhpcy5zdGF0ZS5vcHQubGFuZ10udGVybXNbdGhpcy5jb21tb25fdGVybV1cbiAgICAgICAgfHwgIWhhc190ZXJtXG4gICAgICAgIHx8IHRoaXMudmFyaWFibGVzLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgdGhpcy5jb21tb25fdGVybSA9IGZhbHNlO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBmcmVldGVyc19vZmZzZXQgPSAwO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy52YXJpYWJsZXMubGVuZ3RoIC0gMTsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgdiA9IHRoaXMudmFyaWFibGVzW2ldO1xuICAgICAgICB2YXIgdnYgPSB0aGlzLnZhcmlhYmxlc1tpICsgMV07XG4gICAgICAgIGlmICh0aGlzLmZyZWV0ZXJzW3ZdLmxlbmd0aCB8fCB0aGlzLmZyZWV0ZXJzW3Z2XS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmV0YWxfc3BlY1t2XS5mcmVldGVycyAhPT0gdGhpcy5ldGFsX3NwZWNbdnZdLmZyZWV0ZXJzXG4gICAgICAgICAgICAgICAgfHwgIXRoaXMuX2NvbXBhcmVOYW1lc2V0cyh0aGlzLmZyZWV0ZXJzW3ZdLCB0aGlzLmZyZWV0ZXJzW3Z2XSkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbW1vbl90ZXJtID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnJlZXRlcnNfb2Zmc2V0ICs9IDE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucGVyc29uc1t2XS5sZW5ndGggIT09IHRoaXMucGVyc29uc1t2dl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmNvbW1vbl90ZXJtID0gZmFsc2U7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSB0aGlzLnBlcnNvbnNbdl0ubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5ldGFsX3NwZWNbdl0ucGVyc29uc1tqXSAhPT0gdGhpcy5ldGFsX3NwZWNbdnZdLnBlcnNvbnNbal1cbiAgICAgICAgICAgICAgICB8fCAhdGhpcy5fY29tcGFyZU5hbWVzZXRzKHRoaXMucGVyc29uc1t2XVtqXSwgdGhpcy5wZXJzb25zW3Z2XVtqXSkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbW1vbl90ZXJtID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fY29tcGFyZU5hbWVzZXRzID0gZnVuY3Rpb24gKGJhc2VfbmFtZXNldCwgbmFtZXNldCkge1xuICAgIGlmIChiYXNlX25hbWVzZXQubGVuZ3RoICE9PSBuYW1lc2V0Lmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gbmFtZXNldC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIG5hbWUgPSBuYW1lc2V0W2ldO1xuICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IENTTC5OQU1FX1BBUlRTLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgdmFyIHBhcnQgPSBDU0wuTkFNRV9QQVJUU1tqXTtcbiAgICAgICAgICAgIGlmICghYmFzZV9uYW1lc2V0W2ldIHx8IGJhc2VfbmFtZXNldFtpXVtwYXJ0XSAhPSBuYW1lc2V0W2ldW3BhcnRdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmNvbnN0cmFpbk5hbWVzID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMubmFtZXNfY291bnQgPSAwO1xuICAgIHZhciBwb3M7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLnZhcmlhYmxlcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIHYgPSB0aGlzLnZhcmlhYmxlc1tpXTtcbiAgICAgICAgcG9zID0gdGhpcy5uYW1lc2V0X2Jhc2UgKyBpO1xuICAgICAgICBpZiAodGhpcy5mcmVldGVyc1t2XS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLm5hbWVzX21heC5wdXNoKHRoaXMuZnJlZXRlcnNbdl0ubGVuZ3RoLCBcImxpdGVyYWxcIik7XG4gICAgICAgICAgICB0aGlzLl9pbXBvc2VOYW1lQ29uc3RyYWludHModGhpcy5mcmVldGVycywgdGhpcy5mcmVldGVyc19jb3VudCwgdiwgcG9zKTtcbiAgICAgICAgICAgIHRoaXMubmFtZXNfY291bnQgKz0gdGhpcy5mcmVldGVyc1t2XS5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAubmFtZXNfbWF4LnB1c2godGhpcy5pbnN0aXR1dGlvbnNbdl0ubGVuZ3RoLCBcImxpdGVyYWxcIik7XG4gICAgICAgICAgICB0aGlzLl9pbXBvc2VOYW1lQ29uc3RyYWludHModGhpcy5pbnN0aXR1dGlvbnMsIHRoaXMuaW5zdGl0dXRpb25zX2NvdW50LCB2LCBwb3MpO1xuICAgICAgICAgICAgdGhpcy5wZXJzb25zW3ZdID0gdGhpcy5wZXJzb25zW3ZdLnNsaWNlKDAsIHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aCk7XG4gICAgICAgICAgICB0aGlzLm5hbWVzX2NvdW50ICs9IHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IHRoaXMucGVyc29uc1t2XS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnBlcnNvbnNbdl1bal0ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAubmFtZXNfbWF4LnB1c2godGhpcy5wZXJzb25zW3ZdW2pdLmxlbmd0aCwgXCJsaXRlcmFsXCIpO1xuICAgICAgICAgICAgICAgIHRoaXMuX2ltcG9zZU5hbWVDb25zdHJhaW50cyh0aGlzLnBlcnNvbnNbdl0sIHRoaXMucGVyc29uc19jb3VudFt2XSwgaiwgcG9zKTtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVzX2NvdW50ICs9IHRoaXMucGVyc29uc1t2XVtqXS5sZW5ndGg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9pbXBvc2VOYW1lQ29uc3RyYWludHMgPSBmdW5jdGlvbiAobHN0LCBjb3VudCwga2V5LCBwb3MpIHtcbiAgICB2YXIgZGlzcGxheV9uYW1lcyA9IGxzdFtrZXldO1xuICAgIHZhciBkaXNjcmV0aW9uYXJ5X25hbWVzX2xlbmd0aCA9IHRoaXMuc3RhdGUudG1wW1wiZXQtYWwtbWluXCJdO1xuICAgIGlmICh0aGlzLnN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfcmVxdWVzdCAmJiB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19yZXF1ZXN0Lm5hbWVzW3Bvc10pIHtcbiAgICAgICAgICAgIGRpc2NyZXRpb25hcnlfbmFtZXNfbGVuZ3RoID0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfcmVxdWVzdC5uYW1lc1twb3NdO1xuICAgICAgICB9IGVsc2UgaWYgKGNvdW50W2tleV0gPj0gdGhpcy5ldGFsX21pbikge1xuICAgICAgICAgICAgZGlzY3JldGlvbmFyeV9uYW1lc19sZW5ndGggPSB0aGlzLmV0YWxfdXNlX2ZpcnN0O1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3JlcXVlc3QgXG4gICAgICAgICAgICAmJiB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19yZXF1ZXN0Lm5hbWVzW3Bvc10gPiB0aGlzLmV0YWxfdXNlX2ZpcnN0KSB7XG4gICAgICAgICAgICBpZiAoY291bnRba2V5XSA8IHRoaXMuZXRhbF9taW4pIHtcbiAgICAgICAgICAgICAgICBkaXNjcmV0aW9uYXJ5X25hbWVzX2xlbmd0aCA9IGNvdW50W2tleV07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRpc2NyZXRpb25hcnlfbmFtZXNfbGVuZ3RoID0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfcmVxdWVzdC5uYW1lc1twb3NdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGNvdW50W2tleV0gPj0gdGhpcy5ldGFsX21pbikge1xuICAgICAgICAgICAgZGlzY3JldGlvbmFyeV9uYW1lc19sZW5ndGggPSB0aGlzLmV0YWxfdXNlX2ZpcnN0O1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmV0YWxfdXNlX2xhc3QgJiYgZGlzY3JldGlvbmFyeV9uYW1lc19sZW5ndGggPiAodGhpcy5ldGFsX21pbiAtIDIpKSB7XG4gICAgICAgICAgICBkaXNjcmV0aW9uYXJ5X25hbWVzX2xlbmd0aCA9IHRoaXMuZXRhbF9taW4gLSAyO1xuICAgICAgICB9XG4gICAgfVxuICAgIHZhciBzYW5lID0gdGhpcy5ldGFsX21pbiA+PSB0aGlzLmV0YWxfdXNlX2ZpcnN0O1xuICAgIHZhciBvdmVybGVuZ3RoID0gY291bnRba2V5XSA+IGRpc2NyZXRpb25hcnlfbmFtZXNfbGVuZ3RoO1xuICAgIGlmIChkaXNjcmV0aW9uYXJ5X25hbWVzX2xlbmd0aCA+IGNvdW50W2tleV0pIHtcbiAgICAgICAgZGlzY3JldGlvbmFyeV9uYW1lc19sZW5ndGggPSBkaXNwbGF5X25hbWVzLmxlbmd0aDtcbiAgICB9XG4gICAgaWYgKHNhbmUgJiYgb3Zlcmxlbmd0aCkge1xuICAgICAgICBpZiAodGhpcy5ldGFsX3VzZV9sYXN0KSB7XG4gICAgICAgICAgICBsc3Rba2V5XSA9IGRpc3BsYXlfbmFtZXMuc2xpY2UoMCwgZGlzY3JldGlvbmFyeV9uYW1lc19sZW5ndGgpLmNvbmNhdChkaXNwbGF5X25hbWVzLnNsaWNlKC0xKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsc3Rba2V5XSA9IGRpc3BsYXlfbmFtZXMuc2xpY2UoMCwgZGlzY3JldGlvbmFyeV9uYW1lc19sZW5ndGgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLm5hbWVzW3Bvc10gPSBsc3Rba2V5XS5sZW5ndGg7XG4gICAgdGhpcy5zdGF0ZS5kaXNhbWJpZ3VhdGUucGFkQmFzZSh0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncyk7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuZGlzYW1iaWdOYW1lcyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcG9zO1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy52YXJpYWJsZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciB2ID0gdGhpcy52YXJpYWJsZXNbaV07XG4gICAgICAgIHBvcyA9IHRoaXMubmFtZXNldF9iYXNlICsgaTtcbiAgICAgICAgaWYgKHRoaXMuZnJlZXRlcnNbdl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLl9ydW5EaXNhbWJpZ05hbWVzKHRoaXMuZnJlZXRlcnNbdl0sIHBvcyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aCkge1xuICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbcG9zXSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVuc1twb3NdID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKHZhciBqPTAsamxlbj10aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGg7ajxqbGVuO2orPTEpIHtcbiAgICAgICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVuc1twb3NdW2pdKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVuc1twb3NdLnB1c2goMik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gdGhpcy5wZXJzb25zW3ZdLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgaWYgKHRoaXMucGVyc29uc1t2XVtqXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9ydW5EaXNhbWJpZ05hbWVzKHRoaXMucGVyc29uc1t2XVtqXSwgcG9zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX3J1bkRpc2FtYmlnTmFtZXMgPSBmdW5jdGlvbiAobHN0LCBwb3MpIHtcbiAgICB2YXIgY2hrLCBteWZvcm0sIG15aW5pdGlhbHMsIHBhcmFtLCBpLCBpbGVuLCBwYXJhbXg7XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IGxzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKCFsc3RbaV0uZ2l2ZW4gJiYgIWxzdFtpXS5mYW1pbHkpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIG15aW5pdGlhbHMgPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImluaXRpYWxpemUtd2l0aFwiKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5uYW1lcmVnLmFkZG5hbWUoXCJcIiArIHRoaXMuSXRlbS5pZCwgbHN0W2ldLCBpKTtcbiAgICAgICAgY2hrID0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zW3Bvc107XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgY2hrKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IHBvcyArIDE7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVuc1tqXSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbal0gPSBbXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2hrID0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zW3Bvc11baV07XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgY2hrKSB7XG4gICAgICAgICAgICBteWZvcm0gPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImZvcm1cIiwgXCJuYW1lLWZvcm1cIik7XG4gICAgICAgICAgICBwYXJhbSA9IHRoaXMuc3RhdGUucmVnaXN0cnkubmFtZXJlZy5ldmFsbmFtZShcIlwiICsgdGhpcy5JdGVtLmlkLCBsc3RbaV0sIGksIDAsIG15Zm9ybSwgbXlpbml0aWFscyk7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbcG9zXS5wdXNoKHBhcmFtKTtcbiAgICAgICAgfVxuICAgICAgICBteWZvcm0gPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImZvcm1cIiwgXCJuYW1lLWZvcm1cIik7XG4gICAgICAgIHBhcmFteCA9IHRoaXMuc3RhdGUucmVnaXN0cnkubmFtZXJlZy5ldmFsbmFtZShcIlwiICsgdGhpcy5JdGVtLmlkLCBsc3RbaV0sIGksIDAsIG15Zm9ybSwgbXlpbml0aWFscyk7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19yZXF1ZXN0KSB7XG4gICAgICAgICAgICB2YXIgdmFsID0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zW3Bvc11baV07XG4gICAgICAgICAgICBpZiAodmFsID09PSAxICYmIFxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUuY2l0YXRpb24ub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl0gPT09IFwiYnktY2l0ZVwiICYmIFxuICAgICAgICAgICAgICAgIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJpbml0aWFsaXplLXdpdGhcIilcbiAgICAgICAgICAgICAgICAgfHwgXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGxzdFtpXS5naXZlbikpIHtcbiAgICAgICAgICAgICAgICB2YWwgPSAyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFyYW0gPSB2YWw7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLWdpdmVubmFtZVwiXSAmJiBsc3RbaV0uZ2l2ZW4pIHtcbiAgICAgICAgICAgICAgICBwYXJhbSA9IHRoaXMuc3RhdGUucmVnaXN0cnkubmFtZXJlZy5ldmFsbmFtZShcIlwiICsgdGhpcy5JdGVtLmlkLCBsc3RbaV0sIGksIHBhcmFtLCB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImZvcm1cIiwgXCJuYW1lLWZvcm1cIiksIHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiaW5pdGlhbGl6ZS13aXRoXCIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHBhcmFtID0gcGFyYW14O1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS50bXAuanVzdF9sb29raW5nICYmIHRoaXMuaXRlbSAmJiB0aGlzLml0ZW0ucG9zaXRpb24gPT09IENTTC5QT1NJVElPTl9GSVJTVCkge1xuICAgICAgICAgICAgaWYgKHBhcmFteCA+IHBhcmFtKSB7XG4gICAgICAgICAgICAgICAgcGFyYW0gPSBwYXJhbXg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnRtcC5zb3J0X2tleV9mbGFnKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbcG9zXVtpXSA9IHBhcmFtO1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBteWluaXRpYWxzXG4gICAgICAgICAgICAgICAgJiYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLm5hbWUuc3RyaW5nc1tcImluaXRpYWxpemVcIl1cbiAgICAgICAgICAgICAgICAgICAgfHwgdHJ1ZSA9PT0gdGhpcy5uYW1lLnN0cmluZ3NbXCJpbml0aWFsaXplXCJdKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLnVzZV9pbml0aWFscyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuZ2V0RXRBbENvbmZpZyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgaXRlbSA9IHRoaXMuaXRlbTtcbiAgICB0aGlzW1wiZXQtYWxcIl0gPSB7fTtcbiAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQodGhpcy5ldGFsX3Rlcm0sIHRoaXMuZXRhbF9zdHlsZSwgdHJ1ZSk7XG4gICAgdGhpc1tcImV0LWFsXCJdLnNpbmdsZSA9IHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgIHRoaXNbXCJldC1hbFwiXS5zaW5nbGUuc3RyaW5ncy5zdWZmaXggPSB0aGlzLmV0YWxfc3VmZml4O1xuICAgIHRoaXNbXCJldC1hbFwiXS5zaW5nbGUuc3RyaW5ncy5wcmVmaXggPSB0aGlzLmV0YWxfcHJlZml4X3NpbmdsZTtcbiAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQodGhpcy5ldGFsX3Rlcm0sIHRoaXMuZXRhbF9zdHlsZSwgdHJ1ZSk7XG4gICAgdGhpc1tcImV0LWFsXCJdLm11bHRpcGxlID0gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgdGhpc1tcImV0LWFsXCJdLm11bHRpcGxlLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5ldGFsX3N1ZmZpeDtcbiAgICB0aGlzW1wiZXQtYWxcIl0ubXVsdGlwbGUuc3RyaW5ncy5wcmVmaXggPSB0aGlzLmV0YWxfcHJlZml4X211bHRpcGxlO1xuICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgaXRlbSkge1xuICAgICAgICBpdGVtID0ge307XG4gICAgfVxuICAgIGlmIChpdGVtLnBvc2l0aW9uKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImV0LWFsLXN1YnNlcXVlbnQtbWluXCIpKSB7XG4gICAgICAgICAgICB0aGlzLmV0YWxfbWluID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJldC1hbC1zdWJzZXF1ZW50LW1pblwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZXRhbF9taW4gPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImV0LWFsLW1pblwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJldC1hbC1zdWJzZXF1ZW50LXVzZS1maXJzdFwiKSkge1xuICAgICAgICAgICAgdGhpcy5ldGFsX3VzZV9maXJzdCA9IHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiZXQtYWwtc3Vic2VxdWVudC11c2UtZmlyc3RcIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmV0YWxfdXNlX2ZpcnN0ID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJldC1hbC11c2UtZmlyc3RcIik7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS50bXBbXCJldC1hbC1taW5cIl0pIHtcbiAgICAgICAgICAgIHRoaXMuZXRhbF9taW4gPSB0aGlzLnN0YXRlLnRtcFtcImV0LWFsLW1pblwiXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZXRhbF9taW4gPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImV0LWFsLW1pblwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5zdGF0ZS50bXBbXCJldC1hbC11c2UtZmlyc3RcIl0pIHtcbiAgICAgICAgICAgIHRoaXMuZXRhbF91c2VfZmlyc3QgPSB0aGlzLnN0YXRlLnRtcFtcImV0LWFsLXVzZS1maXJzdFwiXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZXRhbF91c2VfZmlyc3QgPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcImV0LWFsLXVzZS1maXJzdFwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJib29sZWFuXCIgPT09IHR5cGVvZiB0aGlzLnN0YXRlLnRtcFtcImV0LWFsLXVzZS1sYXN0XCJdKSB7XG4gICAgICAgICAgICB0aGlzLmV0YWxfdXNlX2xhc3QgPSB0aGlzLnN0YXRlLnRtcFtcImV0LWFsLXVzZS1sYXN0XCJdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ldGFsX3VzZV9sYXN0ID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJldC1hbC11c2UtbGFzdFwiKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoIXRoaXMuc3RhdGUudG1wW1wiZXQtYWwtbWluXCJdKSB7XG4gICAgICAgIHRoaXMuc3RhdGUudG1wW1wiZXQtYWwtbWluXCJdID0gdGhpcy5ldGFsX21pbjtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuc2V0RXRBbFBhcmFtZXRlcnMgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGksIGlsZW4sIGosIGpsZW47XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IHRoaXMudmFyaWFibGVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgdiA9IHRoaXMudmFyaWFibGVzW2ldO1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMuZXRhbF9zcGVjW3ZdKSB7XG4gICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1t2XSA9IHtmcmVldGVyczowLGluc3RpdHV0aW9uczowLHBlcnNvbnM6W119O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZXRhbF9zcGVjW3RoaXMubmFtZXNldF9iYXNlICsgaV0gPSB0aGlzLmV0YWxfc3BlY1t2XTtcbiAgICAgICAgaWYgKHRoaXMuZnJlZXRlcnNbdl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLl9zZXRFdEFsUGFyYW1ldGVyKFwiZnJlZXRlcnNcIiwgdik7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IHRoaXMucGVyc29uc1t2XS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5ldGFsX3NwZWNbdl1bal0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1t2XS5wZXJzb25zW2pdID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX3NldEV0QWxQYXJhbWV0ZXIoXCJwZXJzb25zXCIsIHYsIGopO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuX3NldEV0QWxQYXJhbWV0ZXIoXCJpbnN0aXR1dGlvbnNcIiwgdik7XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9zZXRFdEFsUGFyYW1ldGVyID0gZnVuY3Rpb24gKHR5cGUsIHYsIGopIHtcbiAgICB2YXIgbHN0LCBjb3VudDtcbiAgICBpZiAodHlwZSA9PT0gXCJwZXJzb25zXCIpIHtcbiAgICAgICAgbHN0ID0gdGhpcy5wZXJzb25zW3ZdW2pdO1xuICAgICAgICBjb3VudCA9IHRoaXMucGVyc29uc19jb3VudFt2XVtqXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBsc3QgPSB0aGlzW3R5cGVdW3ZdO1xuICAgICAgICBjb3VudCA9IHRoaXNbdHlwZSArIFwiX2NvdW50XCJdW3ZdO1xuICAgIH1cbiAgICBpZiAobHN0Lmxlbmd0aCA8IGNvdW50ICYmICF0aGlzLnN0YXRlLnRtcC5zb3J0X2tleV9mbGFnKSB7XG4gICAgICAgIGlmICh0aGlzLmV0YWxfdXNlX2xhc3QpIHtcbiAgICAgICAgICAgIGlmICh0eXBlID09PSBcInBlcnNvbnNcIikge1xuICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9zcGVjW3ZdLnBlcnNvbnNbal0gPSAyXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9zcGVjW3ZdW3R5cGVdID0gMjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0eXBlID09PSBcInBlcnNvbnNcIikge1xuICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9zcGVjW3ZdLnBlcnNvbnNbal0gPSAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1t2XVt0eXBlXSA9IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodHlwZSA9PT0gXCJwZXJzb25zXCIpIHtcbiAgICAgICAgICAgIHRoaXMuZXRhbF9zcGVjW3ZdLnBlcnNvbnNbal0gPSAwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ldGFsX3NwZWNbdl1bdHlwZV0gPSAwO1xuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLnJlbmRlckFsbE5hbWVzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBwb3M7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLnZhcmlhYmxlcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIHYgPSB0aGlzLnZhcmlhYmxlc1tpXTtcbiAgICAgICAgaWYgKHRoaXMuZnJlZXRlcnNbdl0ubGVuZ3RoIHx8IHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aCkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24pIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5qdXN0X2RpZF9udW1iZXIgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBwb3MgPSB0aGlzLm5hbWVzZXRfYmFzZSArIGk7XG4gICAgICAgIGlmICh0aGlzLmZyZWV0ZXJzW3ZdLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5mcmVldGVyc1t2XSA9IHRoaXMuX3JlbmRlck5hbWVzKHYsIHRoaXMuZnJlZXRlcnNbdl0sIHBvcyk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSB0aGlzLmluc3RpdHV0aW9uc1t2XS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgIHRoaXMucGVyc29uc1t2XVtqXSA9IHRoaXMuX3JlbmRlck5hbWVzKHYsIHRoaXMucGVyc29uc1t2XVtqXSwgcG9zLCBqKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnJlbmRlckluc3RpdHV0aW9uTmFtZXMoKTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUucmVuZGVySW5zdGl0dXRpb25OYW1lcyA9IGZ1bmN0aW9uICgpIHtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMudmFyaWFibGVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICB2YXIgdiA9IHRoaXMudmFyaWFibGVzW2ldO1xuICAgICAgICBmb3IgKHZhciBqID0gMCwgamxlbiA9IHRoaXMuaW5zdGl0dXRpb25zW3ZdLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgdmFyIGluc3RpdHV0aW9uLCBpbnN0aXR1dGlvbl9zaG9ydCwgaW5zdGl0dXRpb25fbG9uZywgc2hvcnRfc3R5bGUsIGxvbmdfc3R5bGU7XG4gICAgICAgICAgICB2YXIgbmFtZSA9IHRoaXMuaW5zdGl0dXRpb25zW3ZdW2pdO1xuICAgICAgICAgICAgdmFyIGosIHJldCwgb3B0TGFuZ1RhZywgamxlbiwga2V5LCBsb2NhbGVzZXRzO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLmV4dGVuc2lvbikge1xuICAgICAgICAgICAgICAgIGxvY2FsZXNldHMgPSBbXCJzb3J0XCJdO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lLmlzSW5zdGl0dXRpb24gfHwgbmFtZS5saXRlcmFsKSB7XG4gICAgICAgICAgICAgICAgbG9jYWxlc2V0cyA9IHRoaXMuc3RhdGUub3B0WydjaXRlLWxhbmctcHJlZnMnXS5pbnN0aXR1dGlvbnM7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxvY2FsZXNldHMgPSB0aGlzLnN0YXRlLm9wdFsnY2l0ZS1sYW5nLXByZWZzJ10ucGVyc29ucztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBzbG90ID0ge3ByaW1hcnk6J2xvY2FsZS1vcmlnJyxzZWNvbmRhcnk6ZmFsc2UsdGVydGlhcnk6ZmFsc2V9O1xuXHQgICAgICAgIGlmIChsb2NhbGVzZXRzKSB7XG5cdFx0ICAgICAgICB2YXIgc2xvdG5hbWVzID0gW1wicHJpbWFyeVwiLCBcInNlY29uZGFyeVwiLCBcInRlcnRpYXJ5XCJdO1xuXHRcdCAgICAgICAgZm9yICh2YXIgayA9IDAsIGtsZW4gPSBzbG90bmFtZXMubGVuZ3RoOyBrIDwga2xlbjsgayArPSAxKSB7XG5cdFx0XHQgICAgICAgIGlmIChsb2NhbGVzZXRzLmxlbmd0aCAtIDEgPCAgaykge1xuXHRcdFx0XHQgICAgICAgIGJyZWFrO1xuXHRcdFx0ICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChsb2NhbGVzZXRzW2tdKSB7XG5cdFx0XHQgICAgICAgICAgICBzbG90W3Nsb3RuYW1lc1trXV0gPSAnbG9jYWxlLScgKyBsb2NhbGVzZXRzW2tdO1xuICAgICAgICAgICAgICAgICAgICB9XG5cdFx0ICAgICAgICB9XG5cdCAgICAgICAgfSBlbHNlIHtcblx0XHQgICAgICAgIHNsb3QucHJpbWFyeSA9ICdsb2NhbGUtdHJhbnNsYXQnO1xuXHQgICAgICAgIH1cblx0ICAgICAgICBpZiAodGhpcy5zdGF0ZS50bXAuYXJlYSAhPT0gXCJiaWJsaW9ncmFwaHlcIlxuXHRcdCAgICAgICAgJiYgISh0aGlzLnN0YXRlLnRtcC5hcmVhID09PSBcImNpdGF0aW9uXCJcblx0XHRcdCAgICAgICAgICYmIHRoaXMuc3RhdGUub3B0LnhjbGFzcyA9PT0gXCJub3RlXCJcblx0XHRcdCAgICAgICAgICYmIHRoaXMuaXRlbSAmJiAhdGhpcy5pdGVtLnBvc2l0aW9uKSkge1xuXHRcdCAgICAgICAgc2xvdC5zZWNvbmRhcnkgPSBmYWxzZTtcblx0XHQgICAgICAgIHNsb3QudGVydGlhcnkgPSBmYWxzZTtcblx0ICAgICAgICB9XG4gICAgICAgICAgICB2YXIgcmVzO1xuICAgICAgICAgICAgdGhpcy5zZXRSZW5kZXJlZE5hbWUobmFtZSk7XG4gICAgICAgICAgICB2YXIgaW5zdGl0dXRpb24gPSB0aGlzLl9yZW5kZXJJbnN0aXR1dGlvbk5hbWUodiwgbmFtZSwgc2xvdCwgaik7XG4gICAgICAgICAgICB0aGlzLmluc3RpdHV0aW9uc1t2XVtqXSA9IGluc3RpdHV0aW9uO1xuICAgICAgICB9XG4gICAgfVxufVxuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9yZW5kZXJJbnN0aXR1dGlvbk5hbWUgPSBmdW5jdGlvbiAodiwgbmFtZSwgc2xvdCwgaikge1xuICAgIHZhciBzZWNvbmRhcnksIHRlcnRpYXJ5LCBsb25nX3N0eWxlLCBzaG9ydF9zdHlsZSwgaW5zdGl0dXRpb24sIGluc3RpdHV0aW9uX3Nob3J0LCBpbnN0aXR1dGlvbl9sb25nO1xuICAgIHZhciByZXMgPSB0aGlzLmdldE5hbWUobmFtZSwgc2xvdC5wcmltYXJ5LCB0cnVlKTtcbiAgICB2YXIgcHJpbWFyeSA9IHJlcy5uYW1lO1xuICAgIHZhciB1c2VkT3JpZyA9IHJlcy51c2VkT3JpZztcbiAgICBpZiAocHJpbWFyeSkge1xuICAgICAgICBwcmltYXJ5ID0gdGhpcy5maXh1cEluc3RpdHV0aW9uKHByaW1hcnksIHYsIGopO1xuICAgIH1cblx0c2Vjb25kYXJ5ID0gZmFsc2U7XG5cdGlmIChzbG90LnNlY29uZGFyeSkge1xuICAgICAgICByZXMgPSB0aGlzLmdldE5hbWUobmFtZSwgc2xvdC5zZWNvbmRhcnksIGZhbHNlLCB1c2VkT3JpZyk7XG4gICAgICAgIHZhciBzZWNvbmRhcnkgPSByZXMubmFtZTtcbiAgICAgICAgdXNlZE9yaWcgPSByZXMudXNlZE9yaWc7XG4gICAgICAgIGlmIChzZWNvbmRhcnkpIHtcblx0XHRcdHNlY29uZGFyeSA9IHRoaXMuZml4dXBJbnN0aXR1dGlvbihzZWNvbmRhcnksIHYsIGopO1xuICAgICAgICB9XG5cdH1cblx0dGVydGlhcnkgPSBmYWxzZTtcblx0aWYgKHNsb3QudGVydGlhcnkpIHtcbiAgICAgICAgcmVzID0gdGhpcy5nZXROYW1lKG5hbWUsIHNsb3QudGVydGlhcnksIGZhbHNlLCB1c2VkT3JpZyk7XG4gICAgICAgIHRlcnRpYXJ5ID0gcmVzLm5hbWU7XG4gICAgICAgIGlmICh0ZXJ0aWFyeSkge1xuXHRcdFx0dGVydGlhcnkgPSB0aGlzLmZpeHVwSW5zdGl0dXRpb24odGVydGlhcnksIHYsIGopO1xuICAgICAgICB9XG5cdH1cbiAgICB2YXIgbiA9IHtcbiAgICAgICAgbDoge1xuICAgICAgICAgICAgcHJpOiBmYWxzZSxcbiAgICAgICAgICAgIHNlYzogZmFsc2UsXG4gICAgICAgICAgICB0ZXI6IGZhbHNlXG4gICAgICAgIH0sXG4gICAgICAgIHM6IHtcbiAgICAgICAgICAgIHByaTogZmFsc2UsXG4gICAgICAgICAgICBzZWM6IGZhbHNlLFxuICAgICAgICAgICAgdGVyOiBmYWxzZVxuICAgICAgICB9XG4gICAgfTtcbiAgICBpZiAocHJpbWFyeSkge1xuICAgICAgICBuLmwucHJpID0gcHJpbWFyeVtcImxvbmdcIl07XG4gICAgICAgIG4ucy5wcmkgPSBwcmltYXJ5W1wic2hvcnRcIl0ubGVuZ3RoID8gcHJpbWFyeVtcInNob3J0XCJdIDogcHJpbWFyeVtcImxvbmdcIl07XG4gICAgfVxuICAgIGlmIChzZWNvbmRhcnkpIHtcbiAgICAgICAgbi5sLnNlYyA9IHNlY29uZGFyeVtcImxvbmdcIl07XG4gICAgICAgIG4ucy5zZWMgPSBzZWNvbmRhcnlbXCJzaG9ydFwiXS5sZW5ndGggPyBzZWNvbmRhcnlbXCJzaG9ydFwiXSA6IHNlY29uZGFyeVtcImxvbmdcIl07XG4gICAgfVxuICAgIGlmICh0ZXJ0aWFyeSkge1xuICAgICAgICBuLmwudGVyID0gdGVydGlhcnlbXCJsb25nXCJdO1xuICAgICAgICBuLnMudGVyID0gdGVydGlhcnlbXCJzaG9ydFwiXS5sZW5ndGggPyB0ZXJ0aWFyeVtcInNob3J0XCJdIDogdGVydGlhcnlbXCJsb25nXCJdO1xuICAgIH1cbiAgICBzd2l0Y2ggKHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcImluc3RpdHV0aW9uLXBhcnRzXCJdKSB7XG4gICAgY2FzZSBcInNob3J0XCI6XG4gICAgICAgIGlmIChwcmltYXJ5W1wic2hvcnRcIl0ubGVuZ3RoKSB7XG4gICAgICAgICAgICBzaG9ydF9zdHlsZSA9IHRoaXMuX2dldFNob3J0U3R5bGUoKTtcbiAgICAgICAgICAgIGluc3RpdHV0aW9uID0gW3RoaXMuX2NvbXBvc2VPbmVJbnN0aXR1dGlvblBhcnQoW24ucy5wcmksIG4ucy5zZWMsIG4ucy50ZXJdLCBzbG90LCBzaG9ydF9zdHlsZSwgdildO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9uZ19zdHlsZSA9IHRoaXMuX2dldExvbmdTdHlsZShwcmltYXJ5LCB2LCBqKTtcbiAgICAgICAgICAgIGluc3RpdHV0aW9uID0gW3RoaXMuX2NvbXBvc2VPbmVJbnN0aXR1dGlvblBhcnQoW24ubC5wcmksIG4ubC5zZWMsIG4ubC50ZXJdLCBzbG90LCBsb25nX3N0eWxlLCB2KV07XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgY2FzZSBcInNob3J0LWxvbmdcIjpcbiAgICAgICAgbG9uZ19zdHlsZSA9IHRoaXMuX2dldExvbmdTdHlsZShwcmltYXJ5LCB2LCBqKTtcbiAgICAgICAgc2hvcnRfc3R5bGUgPSB0aGlzLl9nZXRTaG9ydFN0eWxlKCk7XG4gICAgICAgIGluc3RpdHV0aW9uX3Nob3J0ID0gdGhpcy5fcmVuZGVyT25lSW5zdGl0dXRpb25QYXJ0KHByaW1hcnlbXCJzaG9ydFwiXSwgc2hvcnRfc3R5bGUpO1xuICAgICAgICBpbnN0aXR1dGlvbl9sb25nID0gdGhpcy5fY29tcG9zZU9uZUluc3RpdHV0aW9uUGFydChbbi5sLnByaSwgbi5sLnNlYywgbi5sLnRlcl0sIHNsb3QsIGxvbmdfc3R5bGUsIHYpO1xuICAgICAgICBpbnN0aXR1dGlvbiA9IFtpbnN0aXR1dGlvbl9zaG9ydCwgaW5zdGl0dXRpb25fbG9uZ107XG4gICAgICAgIGJyZWFrO1xuICAgIGNhc2UgXCJsb25nLXNob3J0XCI6XG4gICAgICAgIGxvbmdfc3R5bGUgPSB0aGlzLl9nZXRMb25nU3R5bGUocHJpbWFyeSwgdiwgaik7XG4gICAgICAgIHNob3J0X3N0eWxlID0gdGhpcy5fZ2V0U2hvcnRTdHlsZSgpO1xuICAgICAgICBpbnN0aXR1dGlvbl9zaG9ydCA9IHRoaXMuX3JlbmRlck9uZUluc3RpdHV0aW9uUGFydChwcmltYXJ5W1wic2hvcnRcIl0sIHNob3J0X3N0eWxlKTtcbiAgICAgICAgaW5zdGl0dXRpb25fbG9uZyA9IHRoaXMuX2NvbXBvc2VPbmVJbnN0aXR1dGlvblBhcnQoW24ubC5wcmksIG4ubC5zZWMsIG4ubC50ZXJdLCBzbG90LCBsb25nX3N0eWxlLCB2KTtcbiAgICAgICAgaW5zdGl0dXRpb24gPSBbaW5zdGl0dXRpb25fbG9uZywgaW5zdGl0dXRpb25fc2hvcnRdO1xuICAgICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgICBsb25nX3N0eWxlID0gdGhpcy5fZ2V0TG9uZ1N0eWxlKHByaW1hcnksIHYsIGopO1xuICAgICAgICBpbnN0aXR1dGlvbiA9IFt0aGlzLl9jb21wb3NlT25lSW5zdGl0dXRpb25QYXJ0KFtuLmwucHJpLCBuLmwuc2VjLCBuLmwudGVyXSwgc2xvdCwgbG9uZ19zdHlsZSwgdildO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gICAgdmFyIGJsb2IgPSB0aGlzLl9qb2luKGluc3RpdHV0aW9uLCBcIiBcIik7XG4gICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLmNoaWxkcmVuLnB1c2goYmxvYik7XG4gICAgcmV0dXJuIGJsb2I7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9jb21wb3NlT25lSW5zdGl0dXRpb25QYXJ0ID0gZnVuY3Rpb24gKG5hbWVzLCBzbG90LCBzdHlsZSwgdikge1xuICAgIHZhciBwcmltYXJ5ID0gZmFsc2UsIHNlY29uZGFyeSA9IGZhbHNlLCB0ZXJ0aWFyeSA9IGZhbHNlLCBwcmltYXJ5X3Rvaywgc2Vjb25kYXJ5X3RvaywgdGVydGlhcnlfdG9rO1xuICAgIGlmIChuYW1lc1swXSkge1xuICAgICAgICBwcmltYXJ5X3RvayA9IENTTC5VdGlsLmNsb25lVG9rZW4oc3R5bGUpO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5vcHQuY2l0ZUFmZml4ZXNbc2xvdC5wcmltYXJ5XSl7XG4gICAgICAgICAgICBpZiAoXCI8aT5cIiA9PT0gdGhpcy5zdGF0ZS5vcHQuY2l0ZUFmZml4ZXMuaW5zdGl0dXRpb25zW3Nsb3QucHJpbWFyeV0ucHJlZml4KSB7XG4gICAgICAgICAgICAgICAgdmFyIGhhc0l0YWxpYyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gcHJpbWFyeV90b2suZGVjb3JhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdHlsZS5kZWNvcmF0aW9uc1tpXVswXSA9PT0gXCJAZm9udC1zdHlsZVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiBwcmltYXJ5X3Rvay5kZWNvcmF0aW9uc1tpXVsxXSA9PT0gXCJpdGFsaWNcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaGFzSXRhbGljID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWhhc0l0YWxpYykge1xuICAgICAgICAgICAgICAgICAgICBwcmltYXJ5X3Rvay5kZWNvcmF0aW9ucy5wdXNoKFtcIkBmb250LXN0eWxlXCIsIFwiaXRhbGljXCJdKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBwcmltYXJ5ID0gdGhpcy5fcmVuZGVyT25lSW5zdGl0dXRpb25QYXJ0KG5hbWVzWzBdLCBwcmltYXJ5X3Rvayk7XG4gICAgIH1cbiAgICBpZiAobmFtZXNbMV0pIHtcbiAgICAgICAgc2Vjb25kYXJ5ID0gdGhpcy5fcmVuZGVyT25lSW5zdGl0dXRpb25QYXJ0KG5hbWVzWzFdLCBzdHlsZSk7XG4gICAgfVxuICAgIGlmIChuYW1lc1syXSkge1xuICAgICAgICB0ZXJ0aWFyeSA9IHRoaXMuX3JlbmRlck9uZUluc3RpdHV0aW9uUGFydChuYW1lc1syXSwgc3R5bGUpO1xuICAgIH1cbiAgICB2YXIgaW5zdGl0dXRpb25ibG9iO1xuICAgIGlmIChzZWNvbmRhcnkgfHwgdGVydGlhcnkpIHtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQub3BlbkxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChwcmltYXJ5KTtcbiAgICAgICAgc2Vjb25kYXJ5X3RvayA9IENTTC5VdGlsLmNsb25lVG9rZW4oc3R5bGUpO1xuICAgICAgICBpZiAoc2xvdC5zZWNvbmRhcnkpIHtcbiAgICAgICAgICAgIHNlY29uZGFyeV90b2suc3RyaW5ncy5wcmVmaXggPSB0aGlzLnN0YXRlLm9wdC5jaXRlQWZmaXhlcy5pbnN0aXR1dGlvbnNbc2xvdC5zZWNvbmRhcnldLnByZWZpeDtcbiAgICAgICAgICAgIHNlY29uZGFyeV90b2suc3RyaW5ncy5zdWZmaXggPSB0aGlzLnN0YXRlLm9wdC5jaXRlQWZmaXhlcy5pbnN0aXR1dGlvbnNbc2xvdC5zZWNvbmRhcnldLnN1ZmZpeDtcbiAgICAgICAgICAgIGlmICghc2Vjb25kYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCkge1xuICAgICAgICAgICAgICAgIHNlY29uZGFyeV90b2suc3RyaW5ncy5wcmVmaXggPSBcIiBcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgc2Vjb25kYXJ5X291dGVyID0gbmV3IENTTC5Ub2tlbigpO1xuICAgICAgICBzZWNvbmRhcnlfb3V0ZXIuZGVjb3JhdGlvbnMucHVzaChbXCJAZm9udC1zdHlsZVwiLCBcIm5vcm1hbFwiXSk7XG4gICAgICAgIHNlY29uZGFyeV9vdXRlci5kZWNvcmF0aW9ucy5wdXNoKFtcIkBmb250LXdlaWdodFwiLCBcIm5vcm1hbFwiXSk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChzZWNvbmRhcnlfb3V0ZXIpO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoc2Vjb25kYXJ5LCBzZWNvbmRhcnlfdG9rKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuY2xvc2VMZXZlbCgpO1xuICAgICAgICB0ZXJ0aWFyeV90b2sgPSBDU0wuVXRpbC5jbG9uZVRva2VuKHN0eWxlKTtcbiAgICAgICAgaWYgKHNsb3QudGVydGlhcnkpIHtcbiAgICAgICAgICAgIHRlcnRpYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCA9IHRoaXMuc3RhdGUub3B0LmNpdGVBZmZpeGVzLmluc3RpdHV0aW9uc1tzbG90LnRlcnRpYXJ5XS5wcmVmaXg7XG4gICAgICAgICAgICB0ZXJ0aWFyeV90b2suc3RyaW5ncy5zdWZmaXggPSB0aGlzLnN0YXRlLm9wdC5jaXRlQWZmaXhlcy5pbnN0aXR1dGlvbnNbc2xvdC50ZXJ0aWFyeV0uc3VmZml4O1xuICAgICAgICAgICAgaWYgKCF0ZXJ0aWFyeV90b2suc3RyaW5ncy5wcmVmaXgpIHtcbiAgICAgICAgICAgICAgICB0ZXJ0aWFyeV90b2suc3RyaW5ncy5wcmVmaXggPSBcIiBcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgdGVydGlhcnlfb3V0ZXIgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgICAgIHRlcnRpYXJ5X291dGVyLmRlY29yYXRpb25zLnB1c2goW1wiQGZvbnQtc3R5bGVcIiwgXCJub3JtYWxcIl0pO1xuICAgICAgICB0ZXJ0aWFyeV9vdXRlci5kZWNvcmF0aW9ucy5wdXNoKFtcIkBmb250LXdlaWdodFwiLCBcIm5vcm1hbFwiXSk7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0Lm9wZW5MZXZlbCh0ZXJ0aWFyeV9vdXRlcik7XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZCh0ZXJ0aWFyeSwgdGVydGlhcnlfdG9rKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuY2xvc2VMZXZlbCgpO1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5jbG9zZUxldmVsKCk7XG4gICAgICAgIGluc3RpdHV0aW9uYmxvYiA9IHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGluc3RpdHV0aW9uYmxvYiA9IHByaW1hcnk7XG4gICAgfVxuICAgIHJldHVybiBpbnN0aXR1dGlvbmJsb2I7XG59XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX3JlbmRlck9uZUluc3RpdHV0aW9uUGFydCA9IGZ1bmN0aW9uIChibG9icywgc3R5bGUpIHtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGJsb2JzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpZiAoYmxvYnNbaV0pIHtcbiAgICAgICAgICAgIHZhciBzdHIgPSBibG9ic1tpXTtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLnRtcC5zdHJpcF9wZXJpb2RzKSB7XG4gICAgICAgICAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoL1xcLi9nLCBcIlwiKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSBzdHlsZS5kZWNvcmF0aW9ucy5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFwiQHN0cmlwLXBlcmlvZHNcIiA9PT0gc3R5bGUuZGVjb3JhdGlvbnNbal1bMF0gJiYgXCJ0cnVlXCIgPT09IHN0eWxlLmRlY29yYXRpb25zW2pdWzFdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSgvXFwuL2csIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC52YXJpYWJsZV9zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmNhbl9zdWJzdGl0dXRlLnJlcGxhY2UoZmFsc2UsIENTTC5MSVRFUkFMKTtcbiAgICAgICAgICAgIGlmIChzdHIgPT09IFwiIWhlcmU+Pj5cIikge1xuICAgICAgICAgICAgICAgIGJsb2JzW2ldID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChzdHIsIHN0eWxlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICBibG9ic1tpXSA9IHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5pbnN0aXR1dGlvbi5zdHJpbmdzW1wicGFydC1zZXBhcmF0b3JcIl0pIHtcbiAgICAgICAgdGhpcy5pbnN0aXR1dGlvbi5zdHJpbmdzW1wicGFydC1zZXBhcmF0b3JcIl0gPSB0aGlzLnN0YXRlLnRtcC5uYW1lX2RlbGltaXRlcjtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2pvaW4oYmxvYnMsIHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcInBhcnQtc2VwYXJhdG9yXCJdKTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX3JlbmRlck5hbWVzID0gZnVuY3Rpb24gKHYsIHZhbHVlcywgcG9zLCBqKSB7XG4gICAgdmFyIHJldCA9IGZhbHNlO1xuICAgIGlmICh2YWx1ZXMubGVuZ3RoKSB7XG4gICAgICAgIHZhciBuYW1lcyA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHZhbHVlcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHZhciBuYW1lID0gdmFsdWVzW2ldO1xuICAgICAgICAgICAgdmFyIHJldCwgb3B0TGFuZ1RhZywgamxlbiwga2V5LCBsb2NhbGVzZXRzO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLmV4dGVuc2lvbikge1xuICAgICAgICAgICAgICAgIGxvY2FsZXNldHMgPSBbXCJzb3J0XCJdO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lLmlzSW5zdGl0dXRpb24gfHwgbmFtZS5saXRlcmFsKSB7XG4gICAgICAgICAgICAgICAgbG9jYWxlc2V0cyA9IHRoaXMuc3RhdGUub3B0WydjaXRlLWxhbmctcHJlZnMnXS5pbnN0aXR1dGlvbnM7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxvY2FsZXNldHMgPSB0aGlzLnN0YXRlLm9wdFsnY2l0ZS1sYW5nLXByZWZzJ10ucGVyc29ucztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBzbG90ID0ge3ByaW1hcnk6J2xvY2FsZS1vcmlnJyxzZWNvbmRhcnk6ZmFsc2UsdGVydGlhcnk6ZmFsc2V9O1xuXHQgICAgICAgIGlmIChsb2NhbGVzZXRzKSB7XG5cdFx0ICAgICAgICB2YXIgc2xvdG5hbWVzID0gW1wicHJpbWFyeVwiLCBcInNlY29uZGFyeVwiLCBcInRlcnRpYXJ5XCJdO1xuXHRcdCAgICAgICAgZm9yICh2YXIgayA9IDAsIGtsZW4gPSBzbG90bmFtZXMubGVuZ3RoOyBrIDwga2xlbjsgayArPSAxKSB7XG5cdFx0XHQgICAgICAgIGlmIChsb2NhbGVzZXRzLmxlbmd0aCAtIDEgPCAgaykge1xuXHRcdFx0XHQgICAgICAgIGJyZWFrO1xuXHRcdFx0ICAgICAgICB9XG5cdFx0XHQgICAgICAgIHNsb3Rbc2xvdG5hbWVzW2tdXSA9ICdsb2NhbGUtJyArIGxvY2FsZXNldHNba107XG5cdFx0ICAgICAgICB9XG5cdCAgICAgICAgfSBlbHNlIHtcblx0XHQgICAgICAgIHNsb3QucHJpbWFyeSA9ICdsb2NhbGUtdHJhbnNsYXQnO1xuXHQgICAgICAgIH1cblx0ICAgICAgICBpZiAodGhpcy5zdGF0ZS50bXAuc29ydF9rZXlfZmxhZyB8fCAodGhpcy5zdGF0ZS50bXAuYXJlYSAhPT0gXCJiaWJsaW9ncmFwaHlcIlxuXHRcdCAgICAgICAgJiYgISh0aGlzLnN0YXRlLnRtcC5hcmVhID09PSBcImNpdGF0aW9uXCJcblx0XHRcdCAgICAgICAgICYmIHRoaXMuc3RhdGUub3B0LnhjbGFzcyA9PT0gXCJub3RlXCJcblx0XHRcdCAgICAgICAgICYmIHRoaXMuaXRlbSAmJiAhdGhpcy5pdGVtLnBvc2l0aW9uKSkpIHtcblx0XHQgICAgICAgIHNsb3Quc2Vjb25kYXJ5ID0gZmFsc2U7XG5cdFx0ICAgICAgICBzbG90LnRlcnRpYXJ5ID0gZmFsc2U7XG5cdCAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zZXRSZW5kZXJlZE5hbWUobmFtZSk7XG4gICAgICAgICAgICBpZiAoIW5hbWUubGl0ZXJhbCAmJiAhbmFtZS5pc0luc3RpdHV0aW9uKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5hbWVCbG9iID0gdGhpcy5fcmVuZGVyUGVyc29uYWxOYW1lKHYsIG5hbWUsIHNsb3QsIHBvcywgaSwgaik7XG4gICAgICAgICAgICAgICAgdmFyIG5hbWVUb2tlbiA9IENTTC5VdGlsLmNsb25lVG9rZW4odGhpcy5uYW1lKTtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQobmFtZUJsb2IsIG5hbWVUb2tlbiwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgbmFtZXMucHVzaCh0aGlzLnN0YXRlLm91dHB1dC5wb3AoKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5hbWVzLnB1c2godGhpcy5fcmVuZGVySW5zdGl0dXRpb25OYW1lKHYsIG5hbWUsIHNsb3QsIGopKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXQgPSB0aGlzLmpvaW5QZXJzb25zKG5hbWVzLCBwb3MsIGopO1xuICAgIH1cbiAgICByZXR1cm4gcmV0XG59XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX3JlbmRlclBlcnNvbmFsTmFtZSA9IGZ1bmN0aW9uICh2LCBuYW1lLCBzbG90LCBwb3MsIGksIGopIHtcbiAgICB2YXIgcmVzID0gdGhpcy5nZXROYW1lKG5hbWUsIHNsb3QucHJpbWFyeSwgdHJ1ZSk7XG4gICAgdmFyIHByaW1hcnkgPSB0aGlzLl9yZW5kZXJPbmVQZXJzb25hbE5hbWUocmVzLm5hbWUsIHBvcywgaSwgaik7XG5cdHZhciBzZWNvbmRhcnkgPSBmYWxzZTtcblx0aWYgKHNsb3Quc2Vjb25kYXJ5KSB7XG4gICAgICAgIHJlcyA9IHRoaXMuZ2V0TmFtZShuYW1lLCBzbG90LnNlY29uZGFyeSwgZmFsc2UsIHJlcy51c2VkT3JpZyk7XG4gICAgICAgIGlmIChyZXMubmFtZSkge1xuXHRcdFx0c2Vjb25kYXJ5ID0gdGhpcy5fcmVuZGVyT25lUGVyc29uYWxOYW1lKHJlcy5uYW1lLCBwb3MsIGksIGopO1xuICAgICAgICB9XG5cdH1cblx0dmFyIHRlcnRpYXJ5ID0gZmFsc2U7XG5cdGlmIChzbG90LnRlcnRpYXJ5KSB7XG4gICAgICAgIHJlcyA9IHRoaXMuZ2V0TmFtZShuYW1lLCBzbG90LnRlcnRpYXJ5LCBmYWxzZSwgcmVzLnVzZWRPcmlnKTtcbiAgICAgICAgaWYgKHJlcy5uYW1lKSB7XG5cdFx0XHR0ZXJ0aWFyeSA9IHRoaXMuX3JlbmRlck9uZVBlcnNvbmFsTmFtZShyZXMubmFtZSwgcG9zLCBpLCBqKTtcbiAgICAgICAgfVxuXHR9XG4gICAgdmFyIHBlcnNvbmJsb2I7XG4gICAgaWYgKHNlY29uZGFyeSB8fCB0ZXJ0aWFyeSkge1xuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5vcGVuTGV2ZWwoXCJlbXB0eVwiKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHByaW1hcnkpO1xuICAgICAgICB2YXIgc2Vjb25kYXJ5X3RvayA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICAgICAgaWYgKHNsb3Quc2Vjb25kYXJ5KSB7XG4gICAgICAgICAgICBzZWNvbmRhcnlfdG9rLnN0cmluZ3MucHJlZml4ID0gdGhpcy5zdGF0ZS5vcHQuY2l0ZUFmZml4ZXMucGVyc29uc1tzbG90LnNlY29uZGFyeV0ucHJlZml4O1xuICAgICAgICAgICAgc2Vjb25kYXJ5X3Rvay5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuc3RhdGUub3B0LmNpdGVBZmZpeGVzLnBlcnNvbnNbc2xvdC5zZWNvbmRhcnldLnN1ZmZpeDtcbiAgICAgICAgICAgIGlmICghc2Vjb25kYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCkge1xuICAgICAgICAgICAgICAgIHNlY29uZGFyeV90b2suc3RyaW5ncy5wcmVmaXggPSBcIiBcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoc2Vjb25kYXJ5LCBzZWNvbmRhcnlfdG9rKTtcbiAgICAgICAgdmFyIHRlcnRpYXJ5X3RvayA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICAgICAgaWYgKHNsb3QudGVydGlhcnkpIHtcbiAgICAgICAgICAgIHRlcnRpYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCA9IHRoaXMuc3RhdGUub3B0LmNpdGVBZmZpeGVzLnBlcnNvbnNbc2xvdC50ZXJ0aWFyeV0ucHJlZml4O1xuICAgICAgICAgICAgdGVydGlhcnlfdG9rLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5zdGF0ZS5vcHQuY2l0ZUFmZml4ZXMucGVyc29uc1tzbG90LnRlcnRpYXJ5XS5zdWZmaXg7XG4gICAgICAgICAgICBpZiAoIXRlcnRpYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCkge1xuICAgICAgICAgICAgICAgIHRlcnRpYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCA9IFwiIFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZCh0ZXJ0aWFyeSwgdGVydGlhcnlfdG9rKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5vdXRwdXQuY2xvc2VMZXZlbCgpO1xuICAgICAgICBwZXJzb25ibG9iID0gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcGVyc29uYmxvYiA9IHByaW1hcnk7XG4gICAgfVxuICAgIHJldHVybiBwZXJzb25ibG9iO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5faXNSb21hbmVzcXVlID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICB2YXIgcmV0ID0gMjtcbiAgICBpZiAoIW5hbWUuZmFtaWx5LnJlcGxhY2UoL1xcXCIvZywgJycpLm1hdGNoKENTTC5ST01BTkVTUVVFX1JFR0VYUCkpIHtcbiAgICAgICAgcmV0ID0gMDtcbiAgICB9XG4gICAgaWYgKCFyZXQgJiYgbmFtZS5naXZlbiAmJiBuYW1lLmdpdmVuLm1hdGNoKENTTC5TVEFSVFNXSVRIX1JPTUFORVNRVUVfUkVHRVhQKSkge1xuICAgICAgICByZXQgPSAxO1xuICAgIH1cbiAgICBpZiAocmV0ID09IDIpIHtcbiAgICAgICAgaWYgKG5hbWUubXVsdGkgJiYgbmFtZS5tdWx0aS5tYWluKSB7XG4gICAgICAgICAgICB2YXIgdG9wX2xvY2FsZSA9IG5hbWUubXVsdGkubWFpbi5zbGljZSgwLCAyKTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLkl0ZW0ubGFuZ3VhZ2UpIHtcbiAgICAgICAgICAgIHRvcF9sb2NhbGUgPSB0aGlzLkl0ZW0ubGFuZ3VhZ2Uuc2xpY2UoMCwgMik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFtcImphXCIsIFwiemhcIl0uaW5kZXhPZih0b3BfbG9jYWxlKSA+IC0xKSB7XG4gICAgICAgICAgICByZXQgPSAxO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9yZW5kZXJPbmVQZXJzb25hbE5hbWUgPSBmdW5jdGlvbiAodmFsdWUsIHBvcywgaSwgaikge1xuICAgIHZhciBuYW1lID0gdmFsdWU7XG4gICAgdmFyIGRyb3BwaW5nX3BhcnRpY2xlID0gdGhpcy5fZHJvcHBpbmdQYXJ0aWNsZShuYW1lLCBwb3MsIGopO1xuICAgIHZhciBmYW1pbHkgPSB0aGlzLl9mYW1pbHlOYW1lKG5hbWUpO1xuICAgIHZhciBub25fZHJvcHBpbmdfcGFydGljbGUgPSB0aGlzLl9ub25Ecm9wcGluZ1BhcnRpY2xlKG5hbWUpO1xuICAgIHZhciBnaXZlbiA9IHRoaXMuX2dpdmVuTmFtZShuYW1lLCBwb3MsIGkpO1xuICAgIHZhciBzdWZmaXggPSB0aGlzLl9uYW1lU3VmZml4KG5hbWUpO1xuICAgIGlmICh0aGlzLl9pc1Nob3J0KHBvcywgaSkgJiYgIW5hbWVbXCJmdWxsLWZvcm0tYWx3YXlzXCJdKSB7XG4gICAgICAgIGRyb3BwaW5nX3BhcnRpY2xlID0gZmFsc2U7XG4gICAgICAgIGdpdmVuID0gZmFsc2U7XG4gICAgICAgIHN1ZmZpeCA9IGZhbHNlO1xuICAgIH1cbiAgICB2YXIgc29ydF9zZXAgPSB0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcInNvcnQtc2VwYXJhdG9yXCIpO1xuICAgIGlmICghc29ydF9zZXApIHtcbiAgICAgICAgc29ydF9zZXAgPSBcIlwiO1xuICAgIH1cbiAgICB2YXIgc3VmZml4X3NlcDtcbiAgICBpZiAobmFtZVtcImNvbW1hLXN1ZmZpeFwiXSkge1xuICAgICAgICBzdWZmaXhfc2VwID0gXCIsIFwiO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHN1ZmZpeF9zZXAgPSBcIiBcIjtcbiAgICB9XG4gICAgdmFyIHJvbWFuZXNxdWUgPSB0aGlzLl9pc1JvbWFuZXNxdWUobmFtZSk7XG4gICAgZnVuY3Rpb24gaGFzSm9pbmluZ1B1bmN0dWF0aW9uKGJsb2IpIHtcbiAgICAgICAgaWYgKCFibG9iKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIGJsb2IuYmxvYnMpIHtcbiAgICAgICAgICAgIGlmIChbXCJcXHUyMDE5XCIsIFwiXFwnXCIsIFwiLVwiLCBcIiBcIl0uaW5kZXhPZihibG9iLmJsb2JzLnNsaWNlKC0xKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gaGFzSm9pbmluZ1B1bmN0dWF0aW9uKGJsb2IuYmxvYnNbYmxvYi5ibG9icy5sZW5ndGgtMV0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHZhciBoYXNfaHlwaGVuYXRlZF9ub25fZHJvcHBpbmdfcGFydGljbGUgPSBoYXNKb2luaW5nUHVuY3R1YXRpb24obm9uX2Ryb3BwaW5nX3BhcnRpY2xlKTtcbiAgICB2YXIgYmxvYiwgbWVyZ2VkLCBmaXJzdCwgc2Vjb25kO1xuICAgIGlmIChyb21hbmVzcXVlID09PSAwKSB7XG4gICAgICAgIGJsb2IgPSB0aGlzLl9qb2luKFtub25fZHJvcHBpbmdfcGFydGljbGUsIGZhbWlseSwgZ2l2ZW5dLCBcIlwiKTtcbiAgICB9IGVsc2UgaWYgKHJvbWFuZXNxdWUgPT09IDEgfHwgbmFtZVtcInN0YXRpYy1vcmRlcmluZ1wiXSkgeyAvLyBlbnRyeSBsaWtlcyBzb3J0IG9yZGVyXG4gICAgICAgIGJsb2IgPSB0aGlzLl9qb2luKFtub25fZHJvcHBpbmdfcGFydGljbGUsIGZhbWlseSwgZ2l2ZW5dLCBcIiBcIik7XG4gICAgfSBlbHNlIGlmIChuYW1lW1wicmV2ZXJzZS1vcmRlcmluZ1wiXSkgeyAvLyBlbnRyeSBsaWtlcyByZXZlcnNlIG9yZGVyXG4gICAgICAgIGJsb2IgPSB0aGlzLl9qb2luKFtnaXZlbiwgbm9uX2Ryb3BwaW5nX3BhcnRpY2xlLCBmYW1pbHldLCBcIiBcIik7XG4gICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlLnRtcC5zb3J0X2tleV9mbGFnKSB7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLm9wdFtcImRlbW90ZS1ub24tZHJvcHBpbmctcGFydGljbGVcIl0gPT09IFwibmV2ZXJcIikge1xuICAgICAgICAgICAgZmlyc3QgPSB0aGlzLl9qb2luKFtub25fZHJvcHBpbmdfcGFydGljbGUsIGZhbWlseSwgZHJvcHBpbmdfcGFydGljbGVdLCBcIiBcIik7XG4gICAgICAgICAgICBtZXJnZWQgPSB0aGlzLl9qb2luKFtmaXJzdCwgZ2l2ZW5dLCB0aGlzLnN0YXRlLm9wdC5zb3J0X3NlcCk7XG4gICAgICAgICAgICBibG9iID0gdGhpcy5fam9pbihbbWVyZ2VkLCBzdWZmaXhdLCBcIiBcIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzZWNvbmQgPSB0aGlzLl9qb2luKFtnaXZlbiwgZHJvcHBpbmdfcGFydGljbGUsIG5vbl9kcm9wcGluZ19wYXJ0aWNsZV0sIFwiIFwiKTtcbiAgICAgICAgICAgIG1lcmdlZCA9IHRoaXMuX2pvaW4oW2ZhbWlseSwgc2Vjb25kXSwgdGhpcy5zdGF0ZS5vcHQuc29ydF9zZXApO1xuICAgICAgICAgICAgYmxvYiA9IHRoaXMuX2pvaW4oW21lcmdlZCwgc3VmZml4XSwgXCIgXCIpO1xuICAgICAgICB9XG4gICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlLmluaGVyaXRPcHQodGhpcy5uYW1lLCBcIm5hbWUtYXMtc29ydC1vcmRlclwiKSA9PT0gXCJhbGxcIiB8fCAodGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJuYW1lLWFzLXNvcnQtb3JkZXJcIikgPT09IFwiZmlyc3RcIiAmJiBpID09PSAwICYmIChqID09PSAwIHx8IFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBqKSkpIHtcbiAgICAgICAgaWYgKFtcIkxvcmRcIiwgXCJMYWR5XCJdLmluZGV4T2YobmFtZS5naXZlbikgPiAtMSkge1xuICAgICAgICAgICAgc29ydF9zZXAgPSBcIiwgXCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFtcImFsd2F5c1wiLCBcImRpc3BsYXktYW5kLXNvcnRcIl0uaW5kZXhPZih0aGlzLnN0YXRlLm9wdFtcImRlbW90ZS1ub24tZHJvcHBpbmctcGFydGljbGVcIl0pID4gLTEpIHtcbiAgICAgICAgICAgIHNlY29uZCA9IHRoaXMuX2pvaW4oW2dpdmVuLCBkcm9wcGluZ19wYXJ0aWNsZV0sIChuYW1lW1wiY29tbWEtZHJvcHBpbmctcGFydGljbGVcIl0gKyBcIiBcIikpO1xuICAgICAgICAgICAgc2Vjb25kID0gdGhpcy5fam9pbihbc2Vjb25kLCBub25fZHJvcHBpbmdfcGFydGljbGVdLCBcIiBcIik7XG4gICAgICAgICAgICBpZiAoc2Vjb25kICYmIHRoaXMuZ2l2ZW4pIHtcbiAgICAgICAgICAgICAgICBzZWNvbmQuc3RyaW5ncy5wcmVmaXggPSB0aGlzLmdpdmVuLnN0cmluZ3MucHJlZml4O1xuICAgICAgICAgICAgICAgIHNlY29uZC5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuZ2l2ZW4uc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZmFtaWx5ICYmIHRoaXMuZmFtaWx5KSB7XG4gICAgICAgICAgICAgICAgZmFtaWx5LnN0cmluZ3MucHJlZml4ID0gdGhpcy5mYW1pbHkuc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgICAgICAgICAgZmFtaWx5LnN0cmluZ3Muc3VmZml4ID0gdGhpcy5mYW1pbHkuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtZXJnZWQgPSB0aGlzLl9qb2luKFtmYW1pbHksIHNlY29uZF0sIHNvcnRfc2VwKTtcbiAgICAgICAgICAgIGJsb2IgPSB0aGlzLl9qb2luKFttZXJnZWQsIHN1ZmZpeF0sIHNvcnRfc2VwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChoYXNfaHlwaGVuYXRlZF9ub25fZHJvcHBpbmdfcGFydGljbGUpIHtcbiAgICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMuX2pvaW4oW25vbl9kcm9wcGluZ19wYXJ0aWNsZSwgZmFtaWx5XSwgXCJcIik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy5fam9pbihbbm9uX2Ryb3BwaW5nX3BhcnRpY2xlLCBmYW1pbHldLCBcIiBcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZmlyc3QgJiYgdGhpcy5mYW1pbHkpIHtcbiAgICAgICAgICAgICAgICBmaXJzdC5zdHJpbmdzLnByZWZpeCA9IHRoaXMuZmFtaWx5LnN0cmluZ3MucHJlZml4O1xuICAgICAgICAgICAgICAgIGZpcnN0LnN0cmluZ3Muc3VmZml4ID0gdGhpcy5mYW1pbHkuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZWNvbmQgPSB0aGlzLl9qb2luKFtnaXZlbiwgZHJvcHBpbmdfcGFydGljbGVdLCAobmFtZVtcImNvbW1hLWRyb3BwaW5nLXBhcnRpY2xlXCJdICsgXCIgXCIpKTtcbiAgICAgICAgICAgIGlmIChzZWNvbmQgJiYgdGhpcy5naXZlbikge1xuICAgICAgICAgICAgICAgIHNlY29uZC5zdHJpbmdzLnByZWZpeCA9IHRoaXMuZ2l2ZW4uc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgICAgICAgICAgc2Vjb25kLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5naXZlbi5zdHJpbmdzLnN1ZmZpeDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1lcmdlZCA9IHRoaXMuX2pvaW4oW2ZpcnN0LCBzZWNvbmRdLCBzb3J0X3NlcCk7XG4gICAgICAgICAgICBibG9iID0gdGhpcy5fam9pbihbbWVyZ2VkLCBzdWZmaXhdLCBzb3J0X3NlcCk7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgeyAvLyBwbGFpbiB2YW5pbGxhXG4gICAgICAgIGlmIChuYW1lW1wiZHJvcHBpbmctcGFydGljbGVcIl0gJiYgbmFtZS5mYW1pbHkgJiYgIW5hbWVbXCJub24tZHJvcHBpbmctcGFydGljbGVcIl0pIHtcbiAgICAgICAgICAgIGlmIChbXCInXCIsXCJcXHUwMmJjXCIsXCJcXHUyMDE5XCIsXCItXCJdLmluZGV4T2YobmFtZVtcImRyb3BwaW5nLXBhcnRpY2xlXCJdLnNsaWNlKC0xKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIGZhbWlseSA9IHRoaXMuX2pvaW4oW2Ryb3BwaW5nX3BhcnRpY2xlLCBmYW1pbHldLCBcIlwiKTtcbiAgICAgICAgICAgICAgICBkcm9wcGluZ19wYXJ0aWNsZSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS50bXAudGVybV9wcmVkZWNlc3Nvcikge1xuICAgICAgICB9XG4gICAgICAgIHZhciBzcGFjZSA9IFwiIFwiO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJpbml0aWFsaXplLXdpdGhcIilcbiAgICAgICAgICAgICYmIHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiaW5pdGlhbGl6ZS13aXRoXCIpLm1hdGNoKC9bXFx1MDBhMFxcdWZlZmZdLylcbiAgICAgICAgICAgICYmIFtcImZyXCIsIFwicnVcIiwgXCJjc1wiXS5pbmRleE9mKHRoaXMuc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0uc2xpY2UoMCwgMikpID4gLTEpIHtcbiAgICAgICAgICAgIHNwYWNlID0gXCJcXHUwMGEwXCJcbiAgICAgICAgfVxuICAgICAgICBpZiAoaGFzX2h5cGhlbmF0ZWRfbm9uX2Ryb3BwaW5nX3BhcnRpY2xlKSB7XG4gICAgICAgICAgICBzZWNvbmQgPSB0aGlzLl9qb2luKFtub25fZHJvcHBpbmdfcGFydGljbGUsIGZhbWlseV0sIFwiXCIpO1xuICAgICAgICAgICAgc2Vjb25kID0gdGhpcy5fam9pbihbZHJvcHBpbmdfcGFydGljbGUsIHNlY29uZF0sIHNwYWNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNlY29uZCA9IHRoaXMuX2pvaW4oW2Ryb3BwaW5nX3BhcnRpY2xlLCBub25fZHJvcHBpbmdfcGFydGljbGUsIGZhbWlseV0sIHNwYWNlKTtcbiAgICAgICAgfVxuICAgICAgICBzZWNvbmQgPSB0aGlzLl9qb2luKFtzZWNvbmQsIHN1ZmZpeF0sIHN1ZmZpeF9zZXApO1xuICAgICAgICBpZiAoc2Vjb25kICYmIHRoaXMuZmFtaWx5KSB7XG4gICAgICAgICAgICBzZWNvbmQuc3RyaW5ncy5wcmVmaXggPSB0aGlzLmZhbWlseS5zdHJpbmdzLnByZWZpeDtcbiAgICAgICAgICAgIHNlY29uZC5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuZmFtaWx5LnN0cmluZ3Muc3VmZml4O1xuICAgICAgICB9XG4gICAgICAgIGlmIChnaXZlbiAmJiB0aGlzLmdpdmVuKSB7XG4gICAgICAgICAgICBnaXZlbi5zdHJpbmdzLnByZWZpeCA9IHRoaXMuZ2l2ZW4uc3RyaW5ncy5wcmVmaXg7XG4gICAgICAgICAgICBnaXZlbi5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuZ2l2ZW4uc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNlY29uZC5zdHJpbmdzLnByZWZpeCkge1xuICAgICAgICAgICAgbmFtZVtcImNvbW1hLWRyb3BwaW5nLXBhcnRpY2xlXCJdID0gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICBibG9iID0gdGhpcy5fam9pbihbZ2l2ZW4sIHNlY29uZF0sIChuYW1lW1wiY29tbWEtZHJvcHBpbmctcGFydGljbGVcIl0gKyBzcGFjZSkpO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC52YXJpYWJsZV9zdWNjZXNzID0gdHJ1ZTtcbiAgICB0aGlzLnN0YXRlLnRtcC5jYW5fc3Vic3RpdHV0ZS5yZXBsYWNlKGZhbHNlLCBDU0wuTElURVJBTCk7XG4gICAgdGhpcy5zdGF0ZS50bXAudGVybV9wcmVkZWNlc3NvciA9IHRydWU7XG4gICAgdGhpcy5zdGF0ZS50bXAubmFtZV9ub2RlLmNoaWxkcmVuLnB1c2goYmxvYik7XG4gICAgcmV0dXJuIGJsb2I7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9pc1Nob3J0ID0gZnVuY3Rpb24gKHBvcywgaSkge1xuICAgIGlmICgwID09PSB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbcG9zXVtpXSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fbm9ybWFsaXplTmFtZUlucHV0ID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgdmFyIG5hbWUgPSB7XG4gICAgICAgIGxpdGVyYWw6dmFsdWUubGl0ZXJhbCxcbiAgICAgICAgZmFtaWx5OnZhbHVlLmZhbWlseSxcbiAgICAgICAgaXNJbnN0aXR1dGlvbjp2YWx1ZS5pc0luc3RpdHV0aW9uLFxuICAgICAgICBnaXZlbjp2YWx1ZS5naXZlbixcbiAgICAgICAgc3VmZml4OnZhbHVlLnN1ZmZpeCxcbiAgICAgICAgXCJjb21tYS1zdWZmaXhcIjp2YWx1ZVtcImNvbW1hLXN1ZmZpeFwiXSxcbiAgICAgICAgXCJub24tZHJvcHBpbmctcGFydGljbGVcIjp2YWx1ZVtcIm5vbi1kcm9wcGluZy1wYXJ0aWNsZVwiXSxcbiAgICAgICAgXCJkcm9wcGluZy1wYXJ0aWNsZVwiOnZhbHVlW1wiZHJvcHBpbmctcGFydGljbGVcIl0sXG4gICAgICAgIFwic3RhdGljLW9yZGVyaW5nXCI6dmFsdWVbXCJzdGF0aWMtb3JkZXJpbmdcIl0sXG4gICAgICAgIFwic3RhdGljLXBhcnRpY2xlc1wiOnZhbHVlW1wic3RhdGljLXBhcnRpY2xlc1wiXSxcbiAgICAgICAgXCJyZXZlcnNlLW9yZGVyaW5nXCI6dmFsdWVbXCJyZXZlcnNlLW9yZGVyaW5nXCJdLFxuICAgICAgICBcImZ1bGwtZm9ybS1hbHdheXNcIjogdmFsdWVbXCJmdWxsLWZvcm0tYWx3YXlzXCJdLFxuICAgICAgICBcInBhcnNlLW5hbWVzXCI6dmFsdWVbXCJwYXJzZS1uYW1lc1wiXSxcbiAgICAgICAgXCJjb21tYS1kcm9wcGluZy1wYXJ0aWNsZVwiOiBcIlwiLFxuICAgICAgICBibG9ja19pbml0aWFsaXplOnZhbHVlLmJsb2NrX2luaXRpYWxpemUsXG4gICAgICAgIG11bHRpOnZhbHVlLm11bHRpXG4gICAgfTtcbiAgICB0aGlzLl9wYXJzZU5hbWUobmFtZSk7XG4gICAgcmV0dXJuIG5hbWU7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9zdHJpcFBlcmlvZHMgPSBmdW5jdGlvbiAodG9rbmFtZSwgc3RyKSB7XG4gICAgdmFyIGRlY29yX3RvayA9IHRoaXNbdG9rbmFtZSArIFwiX2RlY29yXCJdO1xuICAgIGlmIChzdHIpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUudG1wLnN0cmlwX3BlcmlvZHMpIHtcbiAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC9cXC4vZywgXCJcIik7XG4gICAgICAgIH0gZWxzZSAgaWYgKGRlY29yX3Rvaykge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBkZWNvcl90b2suZGVjb3JhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgaWYgKFwiQHN0cmlwLXBlcmlvZHNcIiA9PT0gZGVjb3JfdG9rLmRlY29yYXRpb25zW2ldWzBdICYmIFwidHJ1ZVwiID09PSBkZWNvcl90b2suZGVjb3JhdGlvbnNbaV1bMV0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoL1xcLi9nLCBcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzdHI7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9ub25Ecm9wcGluZ1BhcnRpY2xlID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICB2YXIgbmRwID0gbmFtZVtcIm5vbi1kcm9wcGluZy1wYXJ0aWNsZVwiXTtcbiAgICBpZiAobmRwICYmIHRoaXMuc3RhdGUudG1wLnNvcnRfa2V5X2ZsYWcpIHtcbiAgICAgICAgbmRwID0gbmRwLnJlcGxhY2UoL1tcXCdcXHUyMDE5XS8sIFwiXCIpO1xuICAgIH1cbiAgICB2YXIgc3RyID0gdGhpcy5fc3RyaXBQZXJpb2RzKFwiZmFtaWx5XCIsIG5kcCk7XG4gICAgaWYgKHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChzdHIsIHRoaXMuZmFtaWx5X2RlY29yLCB0cnVlKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2Ryb3BwaW5nUGFydGljbGUgPSBmdW5jdGlvbiAobmFtZSwgcG9zLCBqKSB7XG4gICAgdmFyIGRwID0gbmFtZVtcImRyb3BwaW5nLXBhcnRpY2xlXCJdO1xuICAgIGlmIChkcCAmJiB0aGlzLnN0YXRlLnRtcC5zb3J0X2tleV9mbGFnKSB7XG4gICAgICAgIGRwID0gZHAucmVwbGFjZSgvW1xcJ1xcdTIwMTldLywgXCJcIik7XG4gICAgfVxuICAgIHZhciBzdHIgPSB0aGlzLl9zdHJpcFBlcmlvZHMoXCJnaXZlblwiLCBkcCk7XG4gICAgaWYgKG5hbWVbXCJkcm9wcGluZy1wYXJ0aWNsZVwiXSAmJiBuYW1lW1wiZHJvcHBpbmctcGFydGljbGVcIl0ubWF0Y2goL15ldC4/YWxbXmEtel0kLykpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiZXQtYWwtdXNlLWxhc3RcIikpIHtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgaikgeyBcbiAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1twb3NdLmZyZWV0ZXJzID0gMjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ldGFsX3NwZWNbcG9zXS5wZXJzb25zID0gMjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgaikgeyBcbiAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3BlY1twb3NdLmZyZWV0ZXJzID0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ldGFsX3NwZWNbcG9zXS5wZXJzb25zID0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBuYW1lW1wiY29tbWEtZHJvcHBpbmctcGFydGljbGVcIl0gPSBcIlwiO1xuICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHN0ciwgdGhpcy5naXZlbl9kZWNvciwgdHJ1ZSkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9mYW1pbHlOYW1lID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICB2YXIgc3RyID0gdGhpcy5fc3RyaXBQZXJpb2RzKFwiZmFtaWx5XCIsIG5hbWUuZmFtaWx5KTtcbiAgICBpZiAodGhpcy5zdGF0ZS5vdXRwdXQuYXBwZW5kKHN0ciwgdGhpcy5mYW1pbHlfZGVjb3IsIHRydWUpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fZ2l2ZW5OYW1lID0gZnVuY3Rpb24gKG5hbWUsIHBvcywgaSkge1xuICAgIHZhciByZXQ7XG4gICAgaWYgKHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiaW5pdGlhbGl6ZVwiKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgaWYgKG5hbWUuZmFtaWx5ICYmIG5hbWUuZ2l2ZW4gJiYgdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJpbml0aWFsaXplXCIpID09PSBmYWxzZSkge1xuICAgICAgICAgICAgbmFtZS5naXZlbiA9IENTTC5VdGlsLk5hbWVzLmluaXRpYWxpemVXaXRoKHRoaXMuc3RhdGUsIG5hbWUuZ2l2ZW4sIHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiaW5pdGlhbGl6ZS13aXRoXCIpLCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICBuYW1lLmdpdmVuID0gQ1NMLlV0aWwuTmFtZXMudW5Jbml0aWFsaXplKHRoaXMuc3RhdGUsIG5hbWUuZ2l2ZW4pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChuYW1lLmZhbWlseSAmJiAxID09PSB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5naXZlbnNbcG9zXVtpXSAmJiAhbmFtZS5ibG9ja19pbml0aWFsaXplKSB7XG4gICAgICAgICAgICB2YXIgaW5pdGlhbGl6ZV93aXRoID0gdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJpbml0aWFsaXplLXdpdGhcIik7XG4gICAgICAgICAgICBuYW1lLmdpdmVuID0gQ1NMLlV0aWwuTmFtZXMuaW5pdGlhbGl6ZVdpdGgodGhpcy5zdGF0ZSwgbmFtZS5naXZlbiwgaW5pdGlhbGl6ZV93aXRoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5hbWUuZ2l2ZW4gPSBDU0wuVXRpbC5OYW1lcy51bkluaXRpYWxpemUodGhpcy5zdGF0ZSwgbmFtZS5naXZlbik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHN0ciA9IHRoaXMuX3N0cmlwUGVyaW9kcyhcImdpdmVuXCIsIG5hbWUuZ2l2ZW4pO1xuICAgIHZhciByZW5kZXJlZCA9IHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChzdHIsIHRoaXMuZ2l2ZW5fZGVjb3IsIHRydWUpO1xuICAgIGlmIChyZW5kZXJlZCkge1xuICAgICAgICByZXQgPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcblx0ICAgIHJldHVybiByZXQ7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX25hbWVTdWZmaXggPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIHZhciBzdHIgPSBuYW1lLnN1ZmZpeCwgcmV0O1xuICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgdGhpcy5zdGF0ZS5pbmhlcml0T3B0KHRoaXMubmFtZSwgXCJpbml0aWFsaXplLXdpdGhcIikpIHtcbiAgICAgICAgc3RyID0gQ1NMLlV0aWwuTmFtZXMuaW5pdGlhbGl6ZVdpdGgodGhpcy5zdGF0ZSwgbmFtZS5zdWZmaXgsIHRoaXMuc3RhdGUuaW5oZXJpdE9wdCh0aGlzLm5hbWUsIFwiaW5pdGlhbGl6ZS13aXRoXCIpLCB0cnVlKTtcbiAgICB9XG4gICAgc3RyID0gdGhpcy5fc3RyaXBQZXJpb2RzKFwiZmFtaWx5XCIsIHN0cik7XG4gICAgdmFyIHRvU3VmZml4ID0gJyc7XG4gICAgaWYgKHN0ciAmJiBzdHIuc2xpY2UoLTEpID09PSAnLicpIHtcblx0c3RyID0gc3RyLnNsaWNlKDAsIC0xKTtcblx0dG9TdWZmaXggPSAnLic7XG4gICAgfVxuICAgIHZhciByZW5kZXJlZCA9IHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChzdHIsIFwiZW1wdHlcIiwgdHJ1ZSk7XG4gICAgaWYgKHJlbmRlcmVkKSB7XG4gICAgICAgIHJldCA9IHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuXHRyZXQuc3RyaW5ncy5zdWZmaXggPSB0b1N1ZmZpeCArIHJldC5zdHJpbmdzLnN1ZmZpeDtcblx0cmV0dXJuIHJldDtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fZ2V0TG9uZ1N0eWxlID0gZnVuY3Rpb24gKG5hbWUsIHYsIGkpIHtcbiAgICB2YXIgbG9uZ19zdHlsZSwgc2hvcnRfc3R5bGU7XG4gICAgaWYgKG5hbWVbXCJzaG9ydFwiXS5sZW5ndGgpIHtcbiAgICAgICAgaWYgKHRoaXMuaW5zdGl0dXRpb25wYXJ0W1wibG9uZy13aXRoLXNob3J0XCJdKSB7XG4gICAgICAgICAgICBsb25nX3N0eWxlID0gdGhpcy5pbnN0aXR1dGlvbnBhcnRbXCJsb25nLXdpdGgtc2hvcnRcIl07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb25nX3N0eWxlID0gdGhpcy5pbnN0aXR1dGlvbnBhcnRbXCJsb25nXCJdO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbG9uZ19zdHlsZSA9IHRoaXMuaW5zdGl0dXRpb25wYXJ0W1wibG9uZ1wiXTtcbiAgICB9XG4gICAgaWYgKCFsb25nX3N0eWxlKSB7XG4gICAgICAgIGxvbmdfc3R5bGUgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgfVxuICAgIHJldHVybiBsb25nX3N0eWxlO1xufTtcbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fZ2V0U2hvcnRTdHlsZSA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgc2hvcnRfc3R5bGU7XG4gICAgaWYgKHRoaXMuaW5zdGl0dXRpb25wYXJ0W1wic2hvcnRcIl0pIHtcbiAgICAgICAgc2hvcnRfc3R5bGUgPSB0aGlzLmluc3RpdHV0aW9ucGFydFtcInNob3J0XCJdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHNob3J0X3N0eWxlID0gbmV3IENTTC5Ub2tlbigpO1xuICAgIH1cbiAgICByZXR1cm4gc2hvcnRfc3R5bGU7XG59O1xuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLl9wYXJzZU5hbWUgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIHZhciBtLCBpZHg7XG4gICAgaWYgKCFuYW1lW1wicGFyc2UtbmFtZXNcIl0gJiYgXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIG5hbWVbXCJwYXJzZS1uYW1lc1wiXSkge1xuICAgICAgICByZXR1cm4gbmFtZTtcbiAgICB9XG4gICAgaWYgKG5hbWUuZmFtaWx5ICYmICFuYW1lLmdpdmVuICYmIG5hbWUuaXNJbnN0aXR1dGlvbikge1xuICAgICAgICBuYW1lLmxpdGVyYWwgPSBuYW1lLmZhbWlseTtcbiAgICAgICAgbmFtZS5mYW1pbHkgPSB1bmRlZmluZWQ7XG4gICAgICAgIG5hbWUuaXNJbnN0aXR1dGlvbiA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgdmFyIG5vcGFyc2U7XG4gICAgaWYgKG5hbWUuZmFtaWx5IFxuICAgICAgICAmJiAobmFtZS5mYW1pbHkuc2xpY2UoMCwgMSkgPT09ICdcIicgJiYgbmFtZS5mYW1pbHkuc2xpY2UoLTEpID09PSAnXCInKVxuICAgICAgICB8fCAoIW5hbWVbXCJwYXJzZS1uYW1lc1wiXSAmJiBcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgbmFtZVtcInBhcnNlLW5hbWVzXCJdKSkge1xuICAgICAgICBuYW1lLmZhbWlseSA9IG5hbWUuZmFtaWx5LnNsaWNlKDEsIC0xKTtcbiAgICAgICAgbm9wYXJzZSA9IHRydWU7XG4gICAgICAgIG5hbWVbXCJwYXJzZS1uYW1lc1wiXSA9IDA7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbm9wYXJzZSA9IGZhbHNlO1xuICAgIH1cbiAgICBpZiAodGhpcy5zdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5wYXJzZV9uYW1lcykge1xuICAgICAgICBpZiAoIW5hbWVbXCJub24tZHJvcHBpbmctcGFydGljbGVcIl0gJiYgbmFtZS5mYW1pbHkgJiYgIW5vcGFyc2UgJiYgbmFtZS5naXZlbikge1xuICAgICAgICAgICAgaWYgKCFuYW1lW1wic3RhdGljLXBhcnRpY2xlc1wiXSkge1xuICAgICAgICAgICAgICAgIENTTC5wYXJzZVBhcnRpY2xlcyhuYW1lLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuZ2V0TmFtZSA9IGZ1bmN0aW9uIChuYW1lLCBzbG90TG9jYWxlc2V0LCBmYWxsYmFjaywgc3RvcE9yaWcpIHtcbiAgICBpZiAoc3RvcE9yaWcgJiYgc2xvdExvY2FsZXNldCA9PT0gJ2xvY2FsZS1vcmlnJykge1xuICAgICAgICByZXR1cm4ge25hbWU6ZmFsc2UsdXNlZE9yaWc6c3RvcE9yaWd9O1xuICAgIH1cbiAgICBpZiAoIW5hbWUuZmFtaWx5KSB7XG4gICAgICAgIG5hbWUuZmFtaWx5ID0gXCJcIjtcbiAgICB9XG4gICAgaWYgKCFuYW1lLmdpdmVuKSB7XG4gICAgICAgIG5hbWUuZ2l2ZW4gPSBcIlwiO1xuICAgIH1cbiAgICB2YXIgbmFtZV9wYXJhbXMgPSB7fTtcbiAgICBuYW1lX3BhcmFtc1tcInN0YXRpYy1vcmRlcmluZ1wiXSA9IHRoaXMuZ2V0U3RhdGljT3JkZXIobmFtZSk7XG4gICAgdmFyIGZvdW5kVGFnID0gdHJ1ZTtcbiAgICBpZiAoc2xvdExvY2FsZXNldCAhPT0gJ2xvY2FsZS1vcmlnJykge1xuICAgICAgICBmb3VuZFRhZyA9IGZhbHNlO1xuICAgICAgICBpZiAobmFtZS5tdWx0aSkge1xuICAgICAgICAgICAgdmFyIGxhbmdUYWdzID0gdGhpcy5zdGF0ZS5vcHRbc2xvdExvY2FsZXNldF1cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gbGFuZ1RhZ3MubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgbGFuZ1RhZyA9IGxhbmdUYWdzW2ldO1xuICAgICAgICAgICAgICAgIGlmIChuYW1lLm11bHRpLl9rZXlbbGFuZ1RhZ10pIHtcbiAgICAgICAgICAgICAgICAgICAgZm91bmRUYWcgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaXNJbnN0aXR1dGlvbiA9IG5hbWUuaXNJbnN0aXR1dGlvbjtcbiAgICAgICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUubXVsdGkuX2tleVtsYW5nVGFnXTtcbiAgICAgICAgICAgICAgICAgICAgbmFtZS5pc0luc3RpdHV0aW9uID0gaXNJbnN0aXR1dGlvbjtcbiAgICAgICAgICAgICAgICAgICAgbmFtZV9wYXJhbXMgPSB0aGlzLmdldE5hbWVQYXJhbXMobGFuZ1RhZyk7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVfcGFyYW1zLnRyYW5zbGl0ZXJhdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghZm91bmRUYWcpIHtcbiAgICAgICAgdmFyIGxhbmdUYWcgPSBmYWxzZTtcbiAgICAgICAgaWYgKG5hbWUubXVsdGkgJiYgbmFtZS5tdWx0aS5tYWluKSB7XG4gICAgICAgICAgICBsYW5nVGFnID0gbmFtZS5tdWx0aS5tYWluO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuSXRlbS5sYW5ndWFnZSkge1xuICAgICAgICAgICAgbGFuZ1RhZyA9IHRoaXMuSXRlbS5sYW5ndWFnZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobGFuZ1RhZykge1xuICAgICAgICAgICAgbmFtZV9wYXJhbXMgPSB0aGlzLmdldE5hbWVQYXJhbXMobGFuZ1RhZyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFmYWxsYmFjayAmJiAhZm91bmRUYWcpIHtcbiAgICAgICAgcmV0dXJuIHtuYW1lOmZhbHNlLHVzZWRPcmlnOnN0b3BPcmlnfTtcbiAgICB9XG4gICAgaWYgKCFuYW1lLmZhbWlseSkge1xuICAgICAgICBuYW1lLmZhbWlseSA9IFwiXCI7XG4gICAgfVxuICAgIGlmICghbmFtZS5naXZlbikge1xuICAgICAgICBuYW1lLmdpdmVuID0gXCJcIjtcbiAgICB9XG4gICAgbmFtZSA9IHtcbiAgICAgICAgZmFtaWx5Om5hbWUuZmFtaWx5LFxuICAgICAgICBnaXZlbjpuYW1lLmdpdmVuLFxuICAgICAgICBcIm5vbi1kcm9wcGluZy1wYXJ0aWNsZVwiOm5hbWVbXCJub24tZHJvcHBpbmctcGFydGljbGVcIl0sXG4gICAgICAgIFwiZHJvcHBpbmctcGFydGljbGVcIjpuYW1lW1wiZHJvcHBpbmctcGFydGljbGVcIl0sXG4gICAgICAgIHN1ZmZpeDpuYW1lLnN1ZmZpeCxcbiAgICAgICAgXCJzdGF0aWMtb3JkZXJpbmdcIjpuYW1lX3BhcmFtc1tcInN0YXRpYy1vcmRlcmluZ1wiXSxcbiAgICAgICAgXCJzdGF0aWMtcGFydGljbGVzXCI6bmFtZVtcInN0YXRpYy1wYXJ0aWNsZXNcIl0sXG4gICAgICAgIFwicmV2ZXJzZS1vcmRlcmluZ1wiOm5hbWVfcGFyYW1zW1wicmV2ZXJzZS1vcmRlcmluZ1wiXSxcbiAgICAgICAgXCJmdWxsLWZvcm0tYWx3YXlzXCI6IG5hbWVfcGFyYW1zW1wiZnVsbC1mb3JtLWFsd2F5c1wiXSxcbiAgICAgICAgXCJwYXJzZS1uYW1lc1wiOm5hbWVbXCJwYXJzZS1uYW1lc1wiXSxcbiAgICAgICAgXCJjb21tYS1zdWZmaXhcIjpuYW1lW1wiY29tbWEtc3VmZml4XCJdLFxuICAgICAgICBcImNvbW1hLWRyb3BwaW5nLXBhcnRpY2xlXCI6bmFtZVtcImNvbW1hLWRyb3BwaW5nLXBhcnRpY2xlXCJdLFxuICAgICAgICB0cmFuc2xpdGVyYXRlZDogbmFtZV9wYXJhbXMudHJhbnNsaXRlcmF0ZWQsXG4gICAgICAgIGJsb2NrX2luaXRpYWxpemU6IG5hbWVfcGFyYW1zW1wiYmxvY2staW5pdGlhbGl6ZVwiXSxcbiAgICAgICAgbGl0ZXJhbDpuYW1lLmxpdGVyYWwsXG4gICAgICAgIGlzSW5zdGl0dXRpb246bmFtZS5pc0luc3RpdHV0aW9uLFxuICAgICAgICBtdWx0aTpuYW1lLm11bHRpXG4gICAgfTtcbiAgICBpZiAoIW5hbWUubGl0ZXJhbCAmJiAoIW5hbWUuZ2l2ZW4gJiYgbmFtZS5mYW1pbHkgJiYgbmFtZS5pc0luc3RpdHV0aW9uKSkge1xuICAgICAgICBuYW1lLmxpdGVyYWwgPSBuYW1lLmZhbWlseTtcbiAgICB9XG4gICAgaWYgKG5hbWUubGl0ZXJhbCkge1xuICAgICAgICBkZWxldGUgbmFtZS5mYW1pbHk7XG4gICAgICAgIGRlbGV0ZSBuYW1lLmdpdmVuO1xuICAgIH1cbiAgICBuYW1lID0gdGhpcy5fbm9ybWFsaXplTmFtZUlucHV0KG5hbWUpO1xuICAgIHZhciB1c2VkT3JpZztcbiAgICBpZiAoc3RvcE9yaWcpIHtcbiAgICAgICAgdXNlZE9yaWcgPSBzdG9wT3JpZztcbiAgICB9IGVsc2Uge1xuICAgICAgICB1c2VkT3JpZyA9ICFmb3VuZFRhZztcbiAgICB9XG4gICAgcmV0dXJuIHtuYW1lOm5hbWUsdXNlZE9yaWc6dXNlZE9yaWd9O1xufVxuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmdldE5hbWVQYXJhbXMgPSBmdW5jdGlvbiAobGFuZ1RhZykge1xuICAgIHZhciByZXQgPSB7fTtcbiAgICB2YXIgbGFuZ3NwZWMgPSBDU0wubG9jYWxlUmVzb2x2ZSh0aGlzLkl0ZW0ubGFuZ3VhZ2UsIHRoaXMuc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0pO1xuICAgIHZhciB0cnlfbG9jYWxlID0gdGhpcy5zdGF0ZS5sb2NhbGVbbGFuZ3NwZWMuYmVzdF0gPyBsYW5nc3BlYy5iZXN0IDogdGhpcy5zdGF0ZS5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXTtcbiAgICB2YXIgbmFtZV9hc19zb3J0X29yZGVyID0gdGhpcy5zdGF0ZS5sb2NhbGVbdHJ5X2xvY2FsZV0ub3B0c1tcIm5hbWUtYXMtc29ydC1vcmRlclwiXVxuICAgIHZhciBuYW1lX2FzX3JldmVyc2Vfb3JkZXIgPSB0aGlzLnN0YXRlLmxvY2FsZVt0cnlfbG9jYWxlXS5vcHRzW1wibmFtZS1hcy1yZXZlcnNlLW9yZGVyXCJdXG4gICAgdmFyIG5hbWVfbmV2ZXJfc2hvcnQgPSB0aGlzLnN0YXRlLmxvY2FsZVt0cnlfbG9jYWxlXS5vcHRzW1wibmFtZS1uZXZlci1zaG9ydFwiXVxuICAgIHZhciBmaWVsZF9sYW5nX2JhcmUgPSBsYW5nVGFnLnNwbGl0KFwiLVwiKVswXTtcbiAgICBpZiAobmFtZV9hc19zb3J0X29yZGVyICYmIG5hbWVfYXNfc29ydF9vcmRlcltmaWVsZF9sYW5nX2JhcmVdKSB7XG4gICAgICAgIHJldFtcInN0YXRpYy1vcmRlcmluZ1wiXSA9IHRydWU7XG4gICAgICAgIHJldFtcInJldmVyc2Utb3JkZXJpbmdcIl0gPSBmYWxzZTtcbiAgICB9XG4gICAgaWYgKG5hbWVfYXNfcmV2ZXJzZV9vcmRlciAmJiBuYW1lX2FzX3JldmVyc2Vfb3JkZXJbZmllbGRfbGFuZ19iYXJlXSkge1xuICAgICAgICByZXRbXCJyZXZlcnNlLW9yZGVyaW5nXCJdID0gdHJ1ZTtcbiAgICAgICAgcmV0W1wic3RhdGljLW9yZGVyaW5nXCJdID0gZmFsc2U7XG4gICAgfVxuICAgIGlmIChuYW1lX25ldmVyX3Nob3J0ICYmIG5hbWVfbmV2ZXJfc2hvcnRbZmllbGRfbGFuZ19iYXJlXSkge1xuICAgICAgICByZXRbXCJmdWxsLWZvcm0tYWx3YXlzXCJdID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKHJldFtcInN0YXRpYy1vcmRlcmluZ1wiXSkge1xuICAgICAgICByZXRbXCJibG9jay1pbml0aWFsaXplXCJdID0gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn1cbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5zZXRSZW5kZXJlZE5hbWUgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIGlmICh0aGlzLnN0YXRlLnRtcC5hcmVhID09PSBcImJpYmxpb2dyYXBoeVwiKSB7XG4gICAgICAgIHZhciBzdHJuYW1lID0gXCJcIjtcbiAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49Q1NMLk5BTUVfUEFSVFMubGVuZ3RoO2o8amxlbjtqKz0xKSB7XG4gICAgICAgICAgICBpZiAobmFtZVtDU0wuTkFNRV9QQVJUU1tqXV0pIHtcbiAgICAgICAgICAgICAgICBzdHJuYW1lICs9IG5hbWVbQ1NMLk5BTUVfUEFSVFNbal1dO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RhdGUudG1wLnJlbmRlcmVkX25hbWUucHVzaChzdHJuYW1lKTtcbiAgICB9XG59XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuZml4dXBJbnN0aXR1dGlvbiA9IGZ1bmN0aW9uIChuYW1lLCB2YXJuYW1lLCBsaXN0cG9zKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUuc3lzLmdldEh1bWFuRm9ybSAmJiBcImxlZ2FsX2Nhc2VcIiA9PT0gdGhpcy5JdGVtLnR5cGUgJiYgXCJhdXRob3JpdHlcIiA9PT0gdmFybmFtZSkge1xuICAgICAgICBuYW1lLmxpdGVyYWwgPSB0aGlzLnN0YXRlLnN5cy5nZXRIdW1hbkZvcm0odGhpcy5JdGVtLmp1cmlzZGljdGlvbiwgbmFtZS5saXRlcmFsLCB0cnVlKTtcbiAgICB9XG4gICAgbmFtZSA9IHRoaXMuX3NwbGl0SW5zdGl0dXRpb24obmFtZSwgdmFybmFtZSwgbGlzdHBvcyk7XG4gICAgaWYgKHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcInJldmVyc2Utb3JkZXJcIl0pIHtcbiAgICAgICAgbmFtZVtcImxvbmdcIl0ucmV2ZXJzZSgpO1xuICAgIH1cbiAgICB2YXIgbG9uZ19mb3JtID0gbmFtZVtcImxvbmdcIl07XG4gICAgdmFyIHNob3J0X2Zvcm0gPSBuYW1lW1wibG9uZ1wiXS5zbGljZSgpO1xuICAgIHZhciB1c2Vfc2hvcnRfZm9ybSA9IGZhbHNlO1xuICAgIGlmICh0aGlzLnN0YXRlLnN5cy5nZXRBYmJyZXZpYXRpb24pIHtcbiAgICAgICAgdmFyIGp1cmlzZGljdGlvbiA9IHRoaXMuSXRlbS5qdXJpc2RpY3Rpb247XG4gICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gbG9uZ19mb3JtLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRLZXkgPSBsb25nX2Zvcm1bal07XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5zeXMubm9ybWFsaXplQWJicmV2c0tleSkge1xuICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRLZXkgPSB0aGlzLnN0YXRlLnN5cy5ub3JtYWxpemVBYmJyZXZzS2V5KGxvbmdfZm9ybVtqXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBqdXJpc2RpY3Rpb24gPSB0aGlzLnN0YXRlLnRyYW5zZm9ybS5sb2FkQWJicmV2aWF0aW9uKGp1cmlzZGljdGlvbiwgXCJpbnN0aXR1dGlvbi1wYXJ0XCIsIG5vcm1hbGl6ZWRLZXkpO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXVtcImluc3RpdHV0aW9uLXBhcnRcIl1bbm9ybWFsaXplZEtleV0pIHtcbiAgICAgICAgICAgICAgICBzaG9ydF9mb3JtW2pdID0gdGhpcy5zdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dW1wiaW5zdGl0dXRpb24tcGFydFwiXVtub3JtYWxpemVkS2V5XTtcbiAgICAgICAgICAgICAgICB1c2Vfc2hvcnRfZm9ybSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHVzZV9zaG9ydF9mb3JtKSB7XG4gICAgICAgIG5hbWVbXCJzaG9ydFwiXSA9IHNob3J0X2Zvcm07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbmFtZVtcInNob3J0XCJdID0gW107XG4gICAgfVxuICAgIHJldHVybiBuYW1lO1xufVxuQ1NMLk5hbWVPdXRwdXQucHJvdG90eXBlLmdldFN0YXRpY09yZGVyID0gZnVuY3Rpb24gKG5hbWUsIHJlZnJlc2gpIHtcbiAgICB2YXIgc3RhdGljX29yZGVyaW5nX3ZhbCA9IGZhbHNlO1xuICAgIGlmICghcmVmcmVzaCAmJiBuYW1lW1wic3RhdGljLW9yZGVyaW5nXCJdKSB7XG4gICAgICAgIHN0YXRpY19vcmRlcmluZ192YWwgPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAodGhpcy5faXNSb21hbmVzcXVlKG5hbWUpID09PSAwKSB7XG4gICAgICAgIHN0YXRpY19vcmRlcmluZ192YWwgPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAoKCFuYW1lLm11bHRpIHx8ICFuYW1lLm11bHRpLm1haW4pICYmIHRoaXMuSXRlbS5sYW5ndWFnZSAmJiBbJ3ZpJywgJ2h1J10uaW5kZXhPZih0aGlzLkl0ZW0ubGFuZ3VhZ2UpID4gLTEpIHtcbiAgICAgICAgc3RhdGljX29yZGVyaW5nX3ZhbCA9IHRydWU7XG4gICAgfSBlbHNlIGlmIChuYW1lLm11bHRpICYmIG5hbWUubXVsdGkubWFpbiAmJiBbJ3ZpJywgJ2h1J10uaW5kZXhPZihuYW1lLm11bHRpLm1haW4uc2xpY2UoMCwyKSkgPiAtMSkge1xuICAgICAgICBzdGF0aWNfb3JkZXJpbmdfdmFsID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5vcHRbJ2F1dG8tdmlldG5hbWVzZS1uYW1lcyddXG4gICAgICAgICAgICAmJiAoQ1NMLlZJRVROQU1FU0VfTkFNRVMuZXhlYyhuYW1lLmZhbWlseSArIFwiIFwiICsgbmFtZS5naXZlbilcbiAgICAgICAgICAgICAgICAmJiBDU0wuVklFVE5BTUVTRV9TUEVDSUFMUy5leGVjKG5hbWUuZmFtaWx5ICsgbmFtZS5naXZlbikpKSB7XG4gICAgICAgICAgICBzdGF0aWNfb3JkZXJpbmdfdmFsID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc3RhdGljX29yZGVyaW5nX3ZhbDtcbn1cbkNTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fc3BsaXRJbnN0aXR1dGlvbiA9IGZ1bmN0aW9uICh2YWx1ZSwgdiwgaSkge1xuICAgIHZhciByZXQgPSB7fTtcbiAgICBpZiAoIXZhbHVlLmxpdGVyYWwgJiYgdmFsdWUuZmFtaWx5KSB7XG4gICAgICAgIHZhbHVlLmxpdGVyYWwgPSB2YWx1ZS5mYW1pbHk7XG4gICAgICAgIGRlbGV0ZSB2YWx1ZS5mYW1pbHk7XG4gICAgfVxuICAgIHZhciBzcGxpdEluc3RpdHV0aW9uID0gdmFsdWUubGl0ZXJhbC5yZXBsYWNlKC9cXHMqXFx8XFxzKi9nLCBcInxcIik7XG4gICAgc3BsaXRJbnN0aXR1dGlvbiA9IHNwbGl0SW5zdGl0dXRpb24uc3BsaXQoXCJ8XCIpO1xuICAgIGlmICh0aGlzLmluc3RpdHV0aW9uLnN0cmluZ3MuZm9ybSA9PT0gXCJzaG9ydFwiICYmIHRoaXMuc3RhdGUuc3lzLmdldEFiYnJldmlhdGlvbikge1xuICAgICAgICB2YXIganVyaXNkaWN0aW9uID0gdGhpcy5JdGVtLmp1cmlzZGljdGlvbjtcbiAgICAgICAgZm9yICh2YXIgaiA9IHNwbGl0SW5zdGl0dXRpb24ubGVuZ3RoOyBqID4gMDsgaiArPSAtMSkge1xuICAgICAgICAgICAgdmFyIHN0ciA9IHNwbGl0SW5zdGl0dXRpb24uc2xpY2UoMCwgaikuam9pbihcInxcIik7XG4gICAgICAgICAgICB2YXIgbm9ybWFsaXplZEtleSA9IHN0cjtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLnN5cy5ub3JtYWxpemVBYmJyZXZzS2V5KSB7XG4gICAgICAgICAgICAgICAgbm9ybWFsaXplZEtleSA9IHRoaXMuc3RhdGUuc3lzLm5vcm1hbGl6ZUFiYnJldnNLZXkoc3RyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGp1cmlzZGljdGlvbiA9IHRoaXMuc3RhdGUudHJhbnNmb3JtLmxvYWRBYmJyZXZpYXRpb24oanVyaXNkaWN0aW9uLCBcImluc3RpdHV0aW9uLWVudGlyZVwiLCBub3JtYWxpemVkS2V5KTtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bXCJpbnN0aXR1dGlvbi1lbnRpcmVcIl1bbm9ybWFsaXplZEtleV0pIHtcbiAgICAgICAgICAgICAgICB2YXIgc3BsaXRMc3QgPSB0aGlzLnN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bXCJpbnN0aXR1dGlvbi1lbnRpcmVcIl1bbm9ybWFsaXplZEtleV07XG4gICAgICAgICAgICAgICAgc3BsaXRMc3QgPSB0aGlzLnN0YXRlLnRyYW5zZm9ybS5xdWFzaENoZWNrKHNwbGl0THN0KTtcbiAgICAgICAgICAgICAgICB2YXIgc3BsaXRTcGxpdExzdCA9IHNwbGl0THN0LnNwbGl0KC8+PlswLTldezR9Pj4vKTtcbiAgICAgICAgICAgICAgICB2YXIgbSA9IHNwbGl0THN0Lm1hdGNoKC8+PihbMC05XXs0fSk+Pi8pO1xuICAgICAgICAgICAgICAgIHNwbGl0THN0ID0gc3BsaXRTcGxpdExzdC5wb3AoKTtcbiAgICAgICAgICAgICAgICBpZiAoc3BsaXRTcGxpdExzdC5sZW5ndGggPiAwICYmIHRoaXMuSXRlbVtcIm9yaWdpbmFsLWRhdGVcIl0gJiYgdGhpcy5JdGVtW1wib3JpZ2luYWwtZGF0ZVwiXS55ZWFyKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGs9bS5sZW5ndGggLSAxOyBrID4gMDsgayArPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlSW50KHRoaXMuSXRlbVtcIm9yaWdpbmFsLWRhdGVcIl0ueWVhciwgMTApID49IHBhcnNlSW50KG1ba10sIDEwKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc3BsaXRMc3QgPSBzcGxpdFNwbGl0THN0LnBvcCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNwbGl0THN0ID0gc3BsaXRMc3QucmVwbGFjZSgvXFxzKlxcfFxccyovZywgXCJ8XCIpO1xuICAgICAgICAgICAgICAgIHNwbGl0SW5zdGl0dXRpb24gPSBbc3BsaXRMc3RdO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHNwbGl0SW5zdGl0dXRpb24ucmV2ZXJzZSgpO1xuICAgIHJldFtcImxvbmdcIl0gPSB0aGlzLl90cmltSW5zdGl0dXRpb24oc3BsaXRJbnN0aXR1dGlvbiwgdiwgaSk7XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX3RyaW1JbnN0aXR1dGlvbiA9IGZ1bmN0aW9uIChzdWJ1bml0cywgdiwgaSkge1xuICAgIHZhciB1c2VfZmlyc3QgPSBmYWxzZTtcbiAgICB2YXIgYXBwZW5kX2xhc3QgPSBmYWxzZTtcbiAgICB2YXIgcyA9IHN1YnVuaXRzLnNsaWNlKCk7XG4gICAgdmFyIHN0b3BfbGFzdCA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmluc3RpdHV0aW9uKSB7XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiICE9PSB0eXBlb2YgdGhpcy5pbnN0aXR1dGlvbi5zdHJpbmdzW1widXNlLWZpcnN0XCJdKSB7XG4gICAgICAgICAgICB1c2VfZmlyc3QgPSB0aGlzLmluc3RpdHV0aW9uLnN0cmluZ3NbXCJ1c2UtZmlyc3RcIl07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB0aGlzLmluc3RpdHV0aW9uLnN0cmluZ3NbXCJzdG9wLWxhc3RcIl0pIHtcbiAgICAgICAgICAgIHN0b3BfbGFzdCA9IHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcInN0b3AtbGFzdFwiXTtcbiAgICAgICAgfSBlbHNlIGlmIChcImF1dGhvcml0eVwiID09PSB2ICYmIHRoaXMuc3RhdGUudG1wLmF1dGhvcml0eV9zdG9wX2xhc3QpIHtcbiAgICAgICAgICAgIHN0b3BfbGFzdCA9IHRoaXMuc3RhdGUudG1wLmF1dGhvcml0eV9zdG9wX2xhc3Q7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0b3BfbGFzdCkge1xuICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgc3RvcF9sYXN0KTtcbiAgICAgICAgICAgIHN1YnVuaXRzID0gc3VidW5pdHMuc2xpY2UoMCwgc3RvcF9sYXN0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPT0gdHlwZW9mIHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcInVzZS1sYXN0XCJdKSB7XG4gICAgICAgICAgICBhcHBlbmRfbGFzdCA9IHRoaXMuaW5zdGl0dXRpb24uc3RyaW5nc1tcInVzZS1sYXN0XCJdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcImF1dGhvcml0eVwiID09PSB2KSB7XG4gICAgICAgICAgICBpZiAoc3RvcF9sYXN0KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAuYXV0aG9yaXR5X3N0b3BfbGFzdCA9IHN0b3BfbGFzdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhcHBlbmRfbGFzdCkgIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC5hdXRob3JpdHlfc3RvcF9sYXN0ICs9IChhcHBlbmRfbGFzdCAqIC0xKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoZmFsc2UgPT09IHVzZV9maXJzdCkge1xuICAgICAgICBpZiAodGhpcy5wZXJzb25zW3ZdLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdXNlX2ZpcnN0ID0gdGhpcy5pbnN0aXR1dGlvbi5zdHJpbmdzW1wic3Vic3RpdHV0ZS11c2UtZmlyc3RcIl07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF1c2VfZmlyc3QpIHtcbiAgICAgICAgICAgIHVzZV9maXJzdCA9IDA7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGZhbHNlID09PSBhcHBlbmRfbGFzdCkge1xuICAgICAgICBpZiAoIXVzZV9maXJzdCkge1xuICAgICAgICAgICAgYXBwZW5kX2xhc3QgPSBzdWJ1bml0cy5sZW5ndGg7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhcHBlbmRfbGFzdCA9IDA7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHVzZV9maXJzdCA+IHN1YnVuaXRzLmxlbmd0aCAtIGFwcGVuZF9sYXN0KSB7XG4gICAgICAgIHVzZV9maXJzdCA9IHN1YnVuaXRzLmxlbmd0aCAtIGFwcGVuZF9sYXN0O1xuICAgIH1cbiAgICBzdWJ1bml0cyA9IHN1YnVuaXRzLnNsaWNlKDAsIHVzZV9maXJzdCk7XG4gICAgcyA9IHMuc2xpY2UodXNlX2ZpcnN0KTtcbiAgICBpZiAoYXBwZW5kX2xhc3QpIHtcbiAgICAgICAgaWYgKGFwcGVuZF9sYXN0ID4gcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGFwcGVuZF9sYXN0ID0gcy5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFwcGVuZF9sYXN0KSB7XG4gICAgICAgICAgICBzdWJ1bml0cyA9IHN1YnVuaXRzLmNvbmNhdChzLnNsaWNlKChzLmxlbmd0aCAtIGFwcGVuZF9sYXN0KSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzdWJ1bml0cztcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5QdWJsaXNoZXJPdXRwdXQgPSBmdW5jdGlvbiAoc3RhdGUsIGdyb3VwX3Rvaykge1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICB0aGlzLmdyb3VwX3RvayA9IGdyb3VwX3RvaztcbiAgICB0aGlzLnZhcmxpc3QgPSBbXTtcbn07XG5DU0wuUHVibGlzaGVyT3V0cHV0LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5jbGVhclZhcnMoKTtcbiAgICB0aGlzLmNvbXBvc2VBbmRCbG9iKCk7XG4gICAgdGhpcy5jb21wb3NlRWxlbWVudHMoKTtcbiAgICB0aGlzLmNvbXBvc2VQdWJsaXNoZXJzKCk7XG4gICAgdGhpcy5qb2luUHVibGlzaGVycygpO1xufTtcbkNTTC5QdWJsaXNoZXJPdXRwdXQucHJvdG90eXBlLmNvbXBvc2VBbmRCbG9iID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuYW5kX2Jsb2IgPSB7fTtcbiAgICB2YXIgYW5kX3Rlcm0gPSBmYWxzZTtcbiAgICBpZiAodGhpcy5ncm91cF90b2suc3RyaW5ncy5hbmQgPT09IFwidGV4dFwiKSB7XG4gICAgICAgIGFuZF90ZXJtID0gdGhpcy5zdGF0ZS5nZXRUZXJtKFwiYW5kXCIpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5ncm91cF90b2suc3RyaW5ncy5hbmQgPT09IFwic3ltYm9sXCIpIHtcbiAgICAgICAgYW5kX3Rlcm0gPSBcIiZcIjtcbiAgICB9XG4gICAgdmFyIHRvayA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICB0b2suc3RyaW5ncy5zdWZmaXggPSBcIiBcIjtcbiAgICB0b2suc3RyaW5ncy5wcmVmaXggPSBcIiBcIjtcbiAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoYW5kX3Rlcm0sIHRvaywgdHJ1ZSk7XG4gICAgdmFyIG5vX2RlbGltID0gdGhpcy5zdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgdG9rLnN0cmluZ3MucHJlZml4ID0gdGhpcy5ncm91cF90b2suc3RyaW5nc1tcInN1Ymdyb3VwLWRlbGltaXRlclwiXTtcbiAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoYW5kX3Rlcm0sIHRvaywgdHJ1ZSk7XG4gICAgdmFyIHdpdGhfZGVsaW0gPSB0aGlzLnN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICB0aGlzLmFuZF9ibG9iLnNpbmdsZSA9IGZhbHNlO1xuICAgIHRoaXMuYW5kX2Jsb2IubXVsdGlwbGUgPSBmYWxzZTtcbiAgICBpZiAoYW5kX3Rlcm0pIHtcbiAgICAgICAgaWYgKHRoaXMuZ3JvdXBfdG9rLnN0cmluZ3NbXCJzdWJncm91cC1kZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiXSA9PT0gXCJhbHdheXNcIikge1xuICAgICAgICAgICAgdGhpcy5hbmRfYmxvYi5zaW5nbGUgPSB3aXRoX2RlbGltO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZ3JvdXBfdG9rLnN0cmluZ3NbXCJzdWJncm91cC1kZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiXSA9PT0gXCJuZXZlclwiKSB7XG4gICAgICAgICAgICB0aGlzLmFuZF9ibG9iLnNpbmdsZSA9IG5vX2RlbGltO1xuICAgICAgICAgICAgdGhpcy5hbmRfYmxvYi5tdWx0aXBsZSA9IG5vX2RlbGltO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5hbmRfYmxvYi5zaW5nbGUgPSBub19kZWxpbTtcbiAgICAgICAgICAgIHRoaXMuYW5kX2Jsb2IubXVsdGlwbGUgPSB3aXRoX2RlbGltO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5QdWJsaXNoZXJPdXRwdXQucHJvdG90eXBlLmNvbXBvc2VFbGVtZW50cyA9IGZ1bmN0aW9uICgpIHtcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IDI7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIHZhcm5hbWUgPSBbXCJwdWJsaXNoZXJcIiwgXCJwdWJsaXNoZXItcGxhY2VcIl1baV07XG4gICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gdGhpc1tcInB1Ymxpc2hlci1saXN0XCJdLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgdmFyIHN0ciA9IHRoaXNbdmFybmFtZSArIFwiLWxpc3RcIl1bal07XG4gICAgICAgICAgICB2YXIgdG9rID0gdGhpc1t2YXJuYW1lICsgXCItdG9rZW5cIl07XG4gICAgICAgICAgICB0aGlzLnN0YXRlLm91dHB1dC5hcHBlbmQoc3RyLCB0b2ssIHRydWUpO1xuICAgICAgICAgICAgdGhpc1t2YXJuYW1lICsgXCItbGlzdFwiXVtqXSA9IHRoaXMuc3RhdGUub3V0cHV0LnBvcCgpO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5QdWJsaXNoZXJPdXRwdXQucHJvdG90eXBlLmNvbXBvc2VQdWJsaXNoZXJzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBibG9icztcbiAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXNbXCJwdWJsaXNoZXItbGlzdFwiXS5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgdmFyIG9yZGVyZWRfbGlzdCA9IFtdO1xuICAgICAgICBibG9icyA9IFt0aGlzW3RoaXMudmFybGlzdFswXSArIFwiLWxpc3RcIl1baV0sIHRoaXNbdGhpcy52YXJsaXN0WzFdICsgXCItbGlzdFwiXVtpXV07XG4gICAgICAgIHRoaXNbXCJwdWJsaXNoZXItbGlzdFwiXVtpXSA9IHRoaXMuX2pvaW4oYmxvYnMsIHRoaXMuZ3JvdXBfdG9rLnN0cmluZ3MuZGVsaW1pdGVyKTtcbiAgICB9XG59O1xuQ1NMLlB1Ymxpc2hlck91dHB1dC5wcm90b3R5cGUuam9pblB1Ymxpc2hlcnMgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGJsb2JzID0gdGhpc1tcInB1Ymxpc2hlci1saXN0XCJdO1xuICAgIHZhciBkZWxpbSA9IHRoaXMubmFtZV9kZWxpbWl0ZXI7XG4gICAgdmFyIHB1Ymxpc2hlcnMgPSB0aGlzLl9qb2luKGJsb2JzLCB0aGlzLmdyb3VwX3Rvay5zdHJpbmdzW1wic3ViZ3JvdXAtZGVsaW1pdGVyXCJdLCB0aGlzLmFuZF9ibG9iLnNpbmdsZSwgdGhpcy5hbmRfYmxvYi5tdWx0aXBsZSwgdGhpcy5ncm91cF90b2spO1xuICAgIHRoaXMuc3RhdGUub3V0cHV0LmFwcGVuZChwdWJsaXNoZXJzLCBcImxpdGVyYWxcIik7XG59O1xuQ1NMLlB1Ymxpc2hlck91dHB1dC5wcm90b3R5cGUuX2pvaW4gPSBDU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2pvaW47XG5DU0wuUHVibGlzaGVyT3V0cHV0LnByb3RvdHlwZS5fZ2V0VG9rZW4gPSBDU0wuTmFtZU91dHB1dC5wcm90b3R5cGUuX2dldFRva2VuO1xuQ1NMLlB1Ymxpc2hlck91dHB1dC5wcm90b3R5cGUuY2xlYXJWYXJzID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuc3RhdGUudG1wW1wicHVibGlzaGVyLWxpc3RcIl0gPSBmYWxzZTtcbiAgICB0aGlzLnN0YXRlLnRtcFtcInB1Ymxpc2hlci1wbGFjZS1saXN0XCJdID0gZmFsc2U7XG4gICAgdGhpcy5zdGF0ZS50bXBbXCJwdWJsaXNoZXItZ3JvdXAtdG9rZW5cIl0gPSBmYWxzZTtcbiAgICB0aGlzLnN0YXRlLnRtcFtcInB1Ymxpc2hlci10b2tlblwiXSA9IGZhbHNlO1xuICAgIHRoaXMuc3RhdGUudG1wW1wicHVibGlzaGVyLXBsYWNlLXRva2VuXCJdID0gZmFsc2U7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuZXZhbHVhdGVMYWJlbCA9IGZ1bmN0aW9uIChub2RlLCBzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgIHZhciBteXRlcm07XG4gICAgaWYgKFwibG9jYXRvclwiID09PSBub2RlLnN0cmluZ3MudGVybSkge1xuICAgICAgICBpZiAoaXRlbSAmJiBpdGVtLmxhYmVsKSB7XG4gICAgICAgICAgICBpZiAoaXRlbS5sYWJlbCA9PT0gXCJzdWIgdmVyYm9cIikge1xuICAgICAgICAgICAgICAgIG15dGVybSA9IFwic3ViLXZlcmJvXCI7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG15dGVybSA9IGl0ZW0ubGFiZWw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFteXRlcm0pIHtcbiAgICAgICAgICAgIG15dGVybSA9IFwicGFnZVwiO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbXl0ZXJtID0gbm9kZS5zdHJpbmdzLnRlcm07XG4gICAgfVxuICAgIHZhciBwbHVyYWwgPSBub2RlLnN0cmluZ3MucGx1cmFsO1xuICAgIGlmIChcIm51bWJlclwiICE9PSB0eXBlb2YgcGx1cmFsKSB7XG4gICAgICAgIHZhciB0aGVJdGVtID0gbm9kZS5zdHJpbmdzLnRlcm0gPT09IFwibG9jYXRvclwiID8gaXRlbSA6IEl0ZW07XG4gICAgICAgIHN0YXRlLnByb2Nlc3NOdW1iZXIoZmFsc2UsIHRoZUl0ZW0sIG5vZGUuc3RyaW5ncy50ZXJtLCBJdGVtLnR5cGUpO1xuICAgICAgICBwbHVyYWwgPSBzdGF0ZS50bXAuc2hhZG93X251bWJlcnNbbm9kZS5zdHJpbmdzLnRlcm1dLnBsdXJhbDtcbiAgICAgICAgaWYgKCFzdGF0ZS50bXAuc2hhZG93X251bWJlcnNbbm9kZS5zdHJpbmdzLnRlcm1dLmxhYmVsRm9ybVxuICAgICAgICAgICAmJiAhc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW25vZGUuc3RyaW5ncy50ZXJtXS5sYWJlbERlY29yYXRpb25zKSB7XG4gICAgICAgICAgICBzdGF0ZS50bXAuc2hhZG93X251bWJlcnNbbm9kZS5zdHJpbmdzLnRlcm1dLmxhYmVsRm9ybSA9IG5vZGUuc3RyaW5ncy5mb3JtO1xuICAgICAgICAgICAgc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW25vZGUuc3RyaW5ncy50ZXJtXS5sYWJlbERlY29yYXRpb25zID0gbm9kZS5kZWNvcmF0aW9ucy5zbGljZSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChbXCJsb2NhdG9yXCIsIFwibnVtYmVyXCIsIFwicGFnZVwiXS5pbmRleE9mKG5vZGUuc3RyaW5ncy50ZXJtKSA+IC0xICYmIHN0YXRlLnRtcC5zaGFkb3dfbnVtYmVyc1tub2RlLnN0cmluZ3MudGVybV0ubGFiZWwpIHtcbiAgICAgICAgICAgIG15dGVybSA9IHN0YXRlLnRtcC5zaGFkb3dfbnVtYmVyc1tub2RlLnN0cmluZ3MudGVybV0ubGFiZWw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGUuZGVjb3JhdGlvbnMgJiYgKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmNzbF9yZXZlcnNlX2xvb2t1cF9zdXBwb3J0IHx8IHN0YXRlLnN5cy5jc2xfcmV2ZXJzZV9sb29rdXBfc3VwcG9ydCkpIHtcbiAgICAgICAgICAgIG5vZGUuZGVjb3JhdGlvbnMucmV2ZXJzZSgpO1xuICAgICAgICAgICAgbm9kZS5kZWNvcmF0aW9ucy5wdXNoKFtcIkBzaG93aWRcIixcInRydWVcIiwgbm9kZS5jc2xpZF0pO1xuICAgICAgICAgICAgbm9kZS5kZWNvcmF0aW9ucy5yZXZlcnNlKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIENTTC5jYXN0TGFiZWwoc3RhdGUsIG5vZGUsIG15dGVybSwgcGx1cmFsLCBDU0wuVE9MRVJBTlQpO1xufTtcbkNTTC5jYXN0TGFiZWwgPSBmdW5jdGlvbiAoc3RhdGUsIG5vZGUsIHRlcm0sIHBsdXJhbCwgbW9kZSkge1xuICAgIHZhciBsYWJlbF9mb3JtID0gbm9kZS5zdHJpbmdzLmZvcm07XG4gICAgaWYgKHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5sYWJlbF9mb3JtICYmIGxhYmVsX2Zvcm0gIT09IFwic3RhdGljXCIpIHtcbiAgICAgICAgbGFiZWxfZm9ybSA9IHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5sYWJlbF9mb3JtO1xuICAgIH1cbiAgICB2YXIgcmV0ID0gc3RhdGUuZ2V0VGVybSh0ZXJtLCBsYWJlbF9mb3JtLCBwbHVyYWwsIGZhbHNlLCBtb2RlLCBub2RlLmRlZmF1bHRfbG9jYWxlKTtcbiAgICBpZiAoc3RhdGUudG1wLnN0cmlwX3BlcmlvZHMpIHtcbiAgICAgICAgcmV0ID0gcmV0LnJlcGxhY2UoL1xcLi9nLCBcIlwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG5vZGUuZGVjb3JhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBpZiAoXCJAc3RyaXAtcGVyaW9kc1wiID09PSBub2RlLmRlY29yYXRpb25zW2ldWzBdICYmIFwidHJ1ZVwiID09PSBub2RlLmRlY29yYXRpb25zW2ldWzFdKSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gcmV0LnJlcGxhY2UoL1xcLi9nLCBcIlwiKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUubmFtZSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgdmFyIGZ1bmMsIHBvcywgbGVuLCBhdHRybmFtZTtcbiAgICAgICAgaWYgKFtDU0wuU0lOR0xFVE9OLCBDU0wuU1RBUlRdLmluZGV4T2YodGhpcy50b2tlbnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygc3RhdGUudG1wLnJvb3QpIHtcbiAgICAgICAgICAgICAgICB2YXIgb2xkVG1wUm9vdCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAucm9vdCA9IFwiY2l0YXRpb25cIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIG9sZFRtcFJvb3QgPSBzdGF0ZS50bXAucm9vdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtc3Vic2VxdWVudC1taW5cIilcbiAgICAgICAgICAgICAgICAmJiAoc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImV0LWFsLXN1YnNlcXVlbnQtbWluXCIpICE9PSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtbWluXCIpKSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLm9wdC51cGRhdGVfbW9kZSA9IENTTC5QT1NJVElPTjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtc3Vic2VxdWVudC11c2UtZmlyc3RcIilcbiAgICAgICAgICAgICAgICAmJiAoc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImV0LWFsLXN1YnNlcXVlbnQtdXNlLWZpcnN0XCIpICE9PSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtdXNlLWZpcnN0XCIpKSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLm9wdC51cGRhdGVfbW9kZSA9IENTTC5QT1NJVElPTjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLnRtcC5yb290ID0gb2xkVG1wUm9vdDtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZXRhbF90ZXJtID0gXCJldC1hbFwiO1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5uYW1lX2RlbGltaXRlciA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXJcIiwgXCJuYW1lLWRlbGltaXRlclwiLCBcIiwgXCIpO1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcFtcImRlbGltaXRlci1wcmVjZWRlcy1ldC1hbFwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXItcHJlY2VkZXMtZXQtYWxcIik7XG4gICAgICAgICAgICAgICAgaWYgKFwidGV4dFwiID09PSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiYW5kXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3Rlcm0gPSBzdGF0ZS5nZXRUZXJtKFwiYW5kXCIsIFwibG9uZ1wiLCAwKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwic3ltYm9sXCIgPT09IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJhbmRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLmV4cGVjdF9hbmRfc3ltYm9sX2Zvcm0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3Rlcm0gPSBzdGF0ZS5nZXRUZXJtKFwiYW5kXCIsIFwic3ltYm9sXCIsIDApO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfdGVybSA9IFwiJlwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5hbmRfdGVybSA9IHRoaXMuYW5kX3Rlcm07XG4gICAgICAgICAgICAgICAgaWYgKENTTC5TVEFSVFNXSVRIX1JPTUFORVNRVUVfUkVHRVhQLnRlc3QodGhpcy5hbmRfdGVybSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X3NpbmdsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfbXVsdGlwbGUgPSBcIiwgXCI7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2Ygc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfbXVsdGlwbGUgPSBzdGF0ZS50bXAubmFtZV9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfc3VmZml4ID0gXCIgXCI7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X3NpbmdsZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3ByZWZpeF9tdWx0aXBsZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3N1ZmZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIikgPT09IFwiYWx3YXlzXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmRfcHJlZml4X3NpbmdsZSA9IHN0YXRlLnRtcC5uYW1lX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJkZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiKSA9PT0gXCJuZXZlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZF9wcmVmaXhfbXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3ByZWZpeF9tdWx0aXBsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIikgPT09IFwiYWZ0ZXItaW52ZXJ0ZWQtbmFtZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZF9wcmVmaXhfc2luZ2xlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZF9wcmVmaXhfc2luZ2xlID0gc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuZF9wcmVmaXhfbXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kX3ByZWZpeF9tdWx0aXBsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuYW5kID0ge307XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJhbmRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh0aGlzLmFuZF90ZXJtLCBcImVtcHR5XCIsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUgPSBzdGF0ZS5vdXRwdXQucG9wKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLnNpbmdsZS5zdHJpbmdzLnByZWZpeCA9IHRoaXMuYW5kX3ByZWZpeF9zaW5nbGU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLnNpbmdsZS5zdHJpbmdzLnN1ZmZpeCA9IHRoaXMuYW5kX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh0aGlzLmFuZF90ZXJtLCBcImVtcHR5XCIsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5tdWx0aXBsZSA9IHN0YXRlLm91dHB1dC5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmQubXVsdGlwbGUuc3RyaW5ncy5wcmVmaXggPSB0aGlzLmFuZF9wcmVmaXhfbXVsdGlwbGU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLm11bHRpcGxlLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5hbmRfc3VmZml4O1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUudG1wLm5hbWVfZGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLnNpbmdsZSA9IG5ldyBDU0wuQmxvYihzdGF0ZS50bXAubmFtZV9kZWxpbWl0ZXIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUuc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5zaW5nbGUuc3RyaW5ncy5zdWZmaXggPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5tdWx0aXBsZSA9IG5ldyBDU0wuQmxvYihzdGF0ZS50bXAubmFtZV9kZWxpbWl0ZXIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFuZC5tdWx0aXBsZS5zdHJpbmdzLnByZWZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYW5kLm11bHRpcGxlLnN0cmluZ3Muc3VmZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5lbGxpcHNpcyA9IHt9O1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtdXNlLWxhc3RcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbGxpcHNpc190ZXJtID0gXCJcXHUyMDI2XCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWxsaXBzaXNfcHJlZml4X3NpbmdsZSA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVsbGlwc2lzX3ByZWZpeF9tdWx0aXBsZSA9ICBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZGVsaW1pdGVyXCIsIFwibmFtZS1kZWxpbWl0ZXJcIiwgXCIsIFwiKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbGxpcHNpc19zdWZmaXggPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbGxpcHNpcy5zaW5nbGUgPSBuZXcgQ1NMLkJsb2IodGhpcy5lbGxpcHNpc190ZXJtKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbGxpcHNpcy5zaW5nbGUuc3RyaW5ncy5wcmVmaXggPSB0aGlzLmVsbGlwc2lzX3ByZWZpeF9zaW5nbGU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWxsaXBzaXMuc2luZ2xlLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5lbGxpcHNpc19zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWxsaXBzaXMubXVsdGlwbGUgPSBuZXcgQ1NMLkJsb2IodGhpcy5lbGxpcHNpc190ZXJtKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbGxpcHNpcy5tdWx0aXBsZS5zdHJpbmdzLnByZWZpeCA9IHRoaXMuZWxsaXBzaXNfcHJlZml4X211bHRpcGxlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVsbGlwc2lzLm11bHRpcGxlLnN0cmluZ3Muc3VmZml4ID0gdGhpcy5lbGxpcHNpc19zdWZmaXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygc3RhdGUudG1wW1wiZXQtYWwtbWluXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcFtcImV0LWFsLW1pblwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC1taW5cIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygc3RhdGUudG1wW1wiZXQtYWwtdXNlLWZpcnN0XCJdKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcFtcImV0LWFsLXVzZS1maXJzdFwiXSA9IHN0YXRlLmluaGVyaXRPcHQodGhpcywgXCJldC1hbC11c2UtZmlyc3RcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygc3RhdGUudG1wW1wiZXQtYWwtdXNlLWxhc3RcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtdXNlLWxhc3RcIl0gPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZXQtYWwtdXNlLWxhc3RcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQubmFtZSA9IHRoaXM7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZV9mbGFnID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZVtcIm5hbWUtcGFydFwiXSA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgc3RhdGUuYnVpbGRbdGhpcy5zdHJpbmdzLm5hbWVdID0gdGhpcztcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS5uYW1lcyA9IHtcbiAgICBidWlsZDogZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICAgICAgdmFyIGZ1bmMsIGxlbiwgcG9zLCBhdHRybmFtZTtcbiAgICAgICAgdmFyIGRlYnVnID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUIHx8IHRoaXMudG9rZW50eXBlID09PSBDU0wuU0lOR0xFVE9OKSB7XG4gICAgICAgICAgICBDU0wuVXRpbC5zdWJzdGl0dXRlU3RhcnQuY2FsbCh0aGlzLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLnN1YnN0aXR1dGVfbGV2ZWwucHVzaCgxKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5TSU5HTEVUT04pIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVzX3ZhcmlhYmxlcy5wdXNoKHRoaXMudmFyaWFibGVzKTtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICB2YXIgbGFiZWxWYXJpYWJsZSA9IHN0YXRlLm5hbWVPdXRwdXQubGFiZWxWYXJpYWJsZTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5uYW1lT3V0cHV0LnJlaW5pdCh0aGlzLCBsYWJlbFZhcmlhYmxlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVzX2ZsYWcgPSB0cnVlO1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQubmFtZXNfbGV2ZWwgKz0gMTtcbiAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5uYW1lc19sZXZlbCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVzX3ZhcmlhYmxlcyA9IFtdO1xuICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVfbGFiZWwgPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVzX3ZhcmlhYmxlcy5wdXNoKHRoaXMudmFyaWFibGVzKTtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuY2FuX3N1YnN0aXR1dGUucHVzaCh0cnVlKTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5TdGFydFZhcmlhYmxlKFwibmFtZXNcIix0aGlzLnZhcmlhYmxlc1swXSk7XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dC5pbml0KHRoaXMpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50b2tlbnR5cGUgPT09IENTTC5FTkQpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gMzsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIHZhciBrZXkgPSBbXCJmYW1pbHlcIiwgXCJnaXZlblwiLCBcImV0LWFsXCJdW2ldO1xuICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHN0YXRlLmJ1aWxkW2tleV07XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLm5hbWVzX2xldmVsID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkW2tleV0gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5sYWJlbCA9IHN0YXRlLmJ1aWxkLm5hbWVfbGFiZWw7XG4gICAgICAgICAgICBpZiAoc3RhdGUuYnVpbGQubmFtZXNfbGV2ZWwgPT09IDEpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZC5uYW1lX2xhYmVsID0ge307XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5uYW1lc19sZXZlbCArPSAtMTtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLm5hbWVzX3ZhcmlhYmxlcy5wb3AoKTtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmV0YWxfbm9kZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3R5bGUgPSBzdGF0ZS50bXAuZXRhbF9ub2RlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9zdHlsZSA9IFwiZW1wdHlcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5ldGFsX3Rlcm0gPSBzdGF0ZS5nZXRUZXJtKHN0YXRlLnRtcC5ldGFsX3Rlcm0sIFwibG9uZ1wiLCAwKTtcbiAgICAgICAgICAgICAgICBpZiAoQ1NMLlNUQVJUU1dJVEhfUk9NQU5FU1FVRV9SRUdFWFAudGVzdCh0aGlzLmV0YWxfdGVybSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ldGFsX3ByZWZpeF9zaW5nbGUgPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ldGFsX3ByZWZpeF9tdWx0aXBsZSA9IHN0YXRlLnRtcC5uYW1lX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcFtcImRlbGltaXRlci1wcmVjZWRlcy1ldC1hbFwiXSA9PT0gXCJhbHdheXNcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldGFsX3ByZWZpeF9zaW5nbGUgPSBzdGF0ZS50bXAubmFtZV9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUudG1wW1wiZGVsaW1pdGVyLXByZWNlZGVzLWV0LWFsXCJdID09PSBcIm5ldmVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9wcmVmaXhfbXVsdGlwbGUgPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS50bXBbXCJkZWxpbWl0ZXItcHJlY2VkZXMtZXQtYWxcIl0gPT09IFwiYWZ0ZXItaW52ZXJ0ZWQtbmFtZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV0YWxfcHJlZml4X3NpbmdsZSA9IHN0YXRlLnRtcC5uYW1lX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9wcmVmaXhfbXVsdGlwbGUgPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3VmZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV0YWxfcHJlZml4X3NpbmdsZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXRhbF9wcmVmaXhfbXVsdGlwbGUgPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV0YWxfc3VmZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSAzOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBbXCJmYW1pbHlcIiwgXCJnaXZlblwiXVtpXTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dFtrZXldID0gdGhpc1trZXldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGF0ZS5uYW1lT3V0cHV0W1wid2l0aFwiXSA9IHRoaXNbXCJ3aXRoXCJdO1xuICAgICAgICAgICAgICAgIHZhciBteXdpdGggPSBcIndpdGhcIjtcbiAgICAgICAgICAgICAgICB2YXIgd2l0aF9kZWZhdWx0X3ByZWZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgdmFyIHdpdGhfc3VmZml4ID0gXCJcIjtcbiAgICAgICAgICAgICAgICBpZiAoQ1NMLlNUQVJUU1dJVEhfUk9NQU5FU1FVRV9SRUdFWFAudGVzdChteXdpdGgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHdpdGhfZGVmYXVsdF9wcmVmaXggPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgd2l0aF9zdWZmaXggPSBcIiBcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHRoZXdpdGggPSB7fTtcbiAgICAgICAgICAgICAgICB0aGV3aXRoLnNpbmdsZSA9IG5ldyBDU0wuQmxvYihteXdpdGgpO1xuICAgICAgICAgICAgICAgIHRoZXdpdGguc2luZ2xlLnN0cmluZ3Muc3VmZml4ID0gd2l0aF9zdWZmaXg7XG4gICAgICAgICAgICAgICAgdGhld2l0aC5tdWx0aXBsZSA9IG5ldyBDU0wuQmxvYihteXdpdGgpO1xuICAgICAgICAgICAgICAgIHRoZXdpdGgubXVsdGlwbGUuc3RyaW5ncy5zdWZmaXggPSB3aXRoX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaW5oZXJpdE9wdChzdGF0ZS5uYW1lT3V0cHV0Lm5hbWUsIFwiZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIikgPT09IFwiYWx3YXlzXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhld2l0aC5zaW5nbGUuc3RyaW5ncy5wcmVmaXggPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZGVsaW1pdGVyXCIsIFwibmFtZXMtZGVsaW1pdGVyXCIpO1xuICAgICAgICAgICAgICAgICAgICB0aGV3aXRoLm11bHRpcGxlLnN0cmluZ3MucHJlZml4ID0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImRlbGltaXRlclwiLCBcIm5hbWVzLWRlbGltaXRlclwiKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmluaGVyaXRPcHQoc3RhdGUubmFtZU91dHB1dC5uYW1lLCBcImRlbGltaXRlci1wcmVjZWRlcy1sYXN0XCIpID09PSBcImNvbnRleHR1YWxcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGV3aXRoLnNpbmdsZS5zdHJpbmdzLnByZWZpeCA9IHdpdGhfZGVmYXVsdF9wcmVmaXg7XG4gICAgICAgICAgICAgICAgICAgIHRoZXdpdGgubXVsdGlwbGUuc3RyaW5ncy5wcmVmaXggPSBzdGF0ZS5pbmhlcml0T3B0KHRoaXMsIFwiZGVsaW1pdGVyXCIsIFwibmFtZXMtZGVsaW1pdGVyXCIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUuaW5oZXJpdE9wdChzdGF0ZS5uYW1lT3V0cHV0Lm5hbWUsIFwiZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIikgPT09IFwiYWZ0ZXItaW52ZXJ0ZWQtbmFtZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoZXdpdGguc2luZ2xlLnN0cmluZ3MucHJlZml4ID0gc3RhdGUuaW5oZXJpdE9wdCh0aGlzLCBcImRlbGltaXRlclwiLCBcIm5hbWVzLWRlbGltaXRlclwiKTtcbiAgICAgICAgICAgICAgICAgICAgdGhld2l0aC5tdWx0aXBsZS5zdHJpbmdzLnByZWZpeCA9IHdpdGhfZGVmYXVsdF9wcmVmaXg7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhld2l0aC5zaW5nbGUuc3RyaW5ncy5wcmVmaXggPSB3aXRoX2RlZmF1bHRfcHJlZml4O1xuICAgICAgICAgICAgICAgICAgICB0aGV3aXRoLm11bHRpcGxlLnN0cmluZ3MucHJlZml4ID0gd2l0aF9kZWZhdWx0X3ByZWZpeDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dFtcIndpdGhcIl0gPSB0aGV3aXRoO1xuICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQubGFiZWwgPSB0aGlzLmxhYmVsO1xuICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQuZXRhbF9zdHlsZSA9IHRoaXMuZXRhbF9zdHlsZTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5uYW1lT3V0cHV0LmV0YWxfdGVybSA9IHRoaXMuZXRhbF90ZXJtO1xuICAgICAgICAgICAgICAgIHN0YXRlLm5hbWVPdXRwdXQuZXRhbF9wcmVmaXhfc2luZ2xlID0gdGhpcy5ldGFsX3ByZWZpeF9zaW5nbGU7XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dC5ldGFsX3ByZWZpeF9tdWx0aXBsZSA9IHRoaXMuZXRhbF9wcmVmaXhfbXVsdGlwbGU7XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dC5ldGFsX3N1ZmZpeCA9IHRoaXMuZXRhbF9zdWZmaXg7XG4gICAgICAgICAgICAgICAgc3RhdGUubmFtZU91dHB1dC5vdXRwdXROYW1lcygpO1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcFtcImV0LWFsLXVzZS1maXJzdFwiXSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXBbXCJldC1hbC1taW5cIl0gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wW1wiZXQtYWwtdXNlLWxhc3RcIl0gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmNhbl9zdWJzdGl0dXRlLnBvcCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5jYW5fc3Vic3RpdHV0ZS5yZXBsYWNlKGZhbHNlLCBDU0wuTElURVJBTCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLkNsb3NlVmFyaWFibGUoXCJuYW1lc1wiKTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmNhbl9zdWJzdGl0dXRlLm15c3RhY2subGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5jYW5fYmxvY2tfc3Vic3RpdHV0ZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5uYW1lX2ZsYWcgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuRU5EIHx8IHRoaXMudG9rZW50eXBlID09PSBDU0wuU0lOR0xFVE9OKSB7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5zdWJzdGl0dXRlX2xldmVsLnBvcCgpO1xuICAgICAgICAgICAgQ1NMLlV0aWwuc3Vic3RpdHV0ZUVuZC5jYWxsKHRoaXMsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICB9XG4gICAgfVxufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk5vZGUubnVtYmVyID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB2YXIgZnVuYztcbiAgICAgICAgQ1NMLlV0aWwuc3Vic3RpdHV0ZVN0YXJ0LmNhbGwodGhpcywgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgIGlmICh0aGlzLnN0cmluZ3MuZm9ybSA9PT0gXCJyb21hblwiKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1hdHRlciA9IHN0YXRlLmZ1bi5yb21hbml6ZXI7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdHJpbmdzLmZvcm0gPT09IFwib3JkaW5hbFwiKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1hdHRlciA9IHN0YXRlLmZ1bi5vcmRpbmFsaXplcjtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0cmluZ3MuZm9ybSA9PT0gXCJsb25nLW9yZGluYWxcIikge1xuICAgICAgICAgICAgdGhpcy5mb3JtYXR0ZXIgPSBzdGF0ZS5mdW4ubG9uZ19vcmRpbmFsaXplcjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMuc3VjY2Vzc29yX3ByZWZpeCkge1xuICAgICAgICAgICAgdGhpcy5zdWNjZXNzb3JfcHJlZml4ID0gc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LmxheW91dF9kZWxpbWl0ZXI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLnNwbGljZV9wcmVmaXgpIHtcbiAgICAgICAgICAgIHRoaXMuc3BsaWNlX3ByZWZpeCA9IHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5sYXlvdXRfZGVsaW1pdGVyO1xuICAgICAgICB9XG4gICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIHZhciBpLCBpbGVuLCBuZXdsc3QsIGxzdDtcbiAgICAgICAgICAgIGlmICh0aGlzLnZhcmlhYmxlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICB2YXIgaXRlbSA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHZhcm5hbWUsIG51bSwgbnVtYmVyLCBtLCBqLCBqbGVuO1xuICAgICAgICAgICAgdmFybmFtZSA9IHRoaXMudmFyaWFibGVzWzBdO1xuICAgICAgICAgICAgaWYgKHZhcm5hbWUgPT09IFwibG9jYXRvclwiICYmIHN0YXRlLnRtcC5qdXN0X2xvb2tpbmcpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5TdGFydFZhcmlhYmxlKHRoaXMudmFyaWFibGVzWzBdKTtcbiAgICAgICAgICAgIGlmICh0aGlzLnZhcmlhYmxlc1swXSA9PT0gXCJsb2NhdG9yXCIpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5BcHBlbmRUb1ZhcmlhYmxlKEl0ZW0uc2VjdGlvbik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLkFwcGVuZFRvVmFyaWFibGUoSXRlbVt0aGlzLnZhcmlhYmxlc1swXV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHJleCA9IG5ldyBSZWdFeHAoXCIoPzomfCwgfCBhbmQgfFwiICsgc3RhdGUuZ2V0VGVybShcInBhZ2UtcmFuZ2UtZGVsaW1pdGVyXCIpICsgXCIpXCIpO1xuICAgICAgICAgICAgaWYgKHZhcm5hbWUgPT09ICdjb2xsZWN0aW9uLW51bWJlcicgJiYgSXRlbS50eXBlID09PSAnbGVnYWxfY2FzZScpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAucmVuZGVyc19jb2xsZWN0aW9uX251bWJlciA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgdmFsdWUgPSBJdGVtW3RoaXMudmFyaWFibGVzWzBdXTtcbiAgICAgICAgICAgIHZhciBmb3JtID0gXCJsb25nXCI7XG4gICAgICAgICAgICBpZiAodGhpcy5zdHJpbmdzLmxhYmVsX2Zvcm1fb3ZlcnJpZGUpIHtcbiAgICAgICAgICAgICAgICBmb3JtID0gdGhpcy5zdHJpbmdzLmxhYmVsX2Zvcm1fb3ZlcnJpZGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXM7XG4gICAgICAgICAgICBpZiAoc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmZvcmNlX3N1cHByZXNzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHZhcm5hbWUgPT09IFwibG9jYXRvclwiKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUucHJvY2Vzc051bWJlcihub2RlLCBpdGVtLCB2YXJuYW1lLCBJdGVtLnR5cGUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC5jb25kaXRpb24gJiYgSXRlbVt2YXJuYW1lXSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuanVzdF9kaWRfbnVtYmVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUucHJvY2Vzc051bWJlcihub2RlLCBJdGVtLCB2YXJuYW1lLCBJdGVtLnR5cGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgQ1NMLlV0aWwub3V0cHV0TnVtZXJpY0ZpZWxkKHN0YXRlLCB2YXJuYW1lLCBJdGVtLmlkKTtcbiAgICAgICAgICAgIHN0YXRlLnBhcmFsbGVsLkNsb3NlVmFyaWFibGUoXCJudW1iZXJcIik7XG4gICAgICAgICAgICBpZiAoW1wibG9jYXRvclwiLCBcImxvY2F0b3ItZXh0cmFcIl0uaW5kZXhPZih0aGlzLnZhcmlhYmxlc19yZWFsWzBdKSA+IC0xXG4gICAgICAgICAgICAgICAmJiAhc3RhdGUudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5kb25lX3ZhcnMucHVzaCh0aGlzLnZhcmlhYmxlc19yZWFsWzBdKTtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAuZG9uZV92YXJzLnB1c2godGhpcy52YXJpYWJsZXNfcmVhbFswXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgICAgIENTTC5VdGlsLnN1YnN0aXR1dGVFbmQuY2FsbCh0aGlzLCBzdGF0ZSwgdGFyZ2V0KTtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS5zb3J0ID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB0YXJnZXQgPSBzdGF0ZVtzdGF0ZS5idWlsZC5yb290ICsgXCJfc29ydFwiXS50b2tlbnM7XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLlNUQVJUKSB7XG4gICAgICAgICAgICBpZiAoc3RhdGUuYnVpbGQuYXJlYSA9PT0gXCJjaXRhdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwudXNlX3BhcmFsbGVscyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5zb3J0X2NpdGF0aW9ucyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5hcmVhID0gc3RhdGUuYnVpbGQucm9vdCArIFwiX3NvcnRcIjtcbiAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmV4dGVuc2lvbiA9IFwiX3NvcnRcIjtcbiAgICAgICAgICAgIHZhciBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC5oYXNfbGF5b3V0X2xvY2FsZSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbGFuZ3NwZWMgPSBDU0wubG9jYWxlUmVzb2x2ZShJdGVtLmxhbmd1YWdlLCBzdGF0ZS5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXSk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzb3J0X2xvY2FsZXMgPSBzdGF0ZVtzdGF0ZS50bXAuYXJlYS5zbGljZSgwLC01KV0ub3B0LnNvcnRfbG9jYWxlcztcbiAgICAgICAgICAgICAgICAgICAgdmFyIGxhbmdGb3JJdGVtO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1zb3J0X2xvY2FsZXMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYW5nRm9ySXRlbSA9IHNvcnRfbG9jYWxlc1tpXVtsYW5nc3BlYy5iYXJlXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGFuZ0Zvckl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYW5nRm9ySXRlbSA9IHNvcnRfbG9jYWxlc1tpXVtsYW5nc3BlYy5iZXN0XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYW5nRm9ySXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghbGFuZ0Zvckl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhbmdGb3JJdGVtID0gc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmxhbmdfc29ydF9ob2xkID0gc3RhdGUub3B0Lmxhbmc7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5sYW5nID0gbGFuZ0Zvckl0ZW07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRva2VudHlwZSA9PT0gQ1NMLkVORCkge1xuICAgICAgICAgICAgc3RhdGUuYnVpbGQuYXJlYSA9IHN0YXRlLmJ1aWxkLnJvb3Q7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5leHRlbnNpb24gPSBcIlwiO1xuICAgICAgICAgICAgdmFyIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0Lmhhc19sYXlvdXRfbG9jYWxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5sYW5nID0gc3RhdGUudG1wLmxhbmdfc29ydF9ob2xkO1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgc3RhdGUudG1wLmxhbmdfc29ydF9ob2xkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS5zdWJzdGl0dXRlID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB2YXIgZnVuYztcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuY2FuX2Jsb2NrX3N1YnN0aXR1dGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAudmFsdWUubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5jYW5fc3Vic3RpdHV0ZS5yZXBsYWNlKGZhbHNlLCBDU0wuTElURVJBTCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgfVxuICAgICAgICB0YXJnZXQucHVzaCh0aGlzKTtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTm9kZS50ZXh0ID0ge1xuICAgIGJ1aWxkOiBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgICAgICB2YXIgdmFyaWFibGUsIGZ1bmMsIGZvcm0sIHBsdXJhbCwgaWQsIG51bSwgbnVtYmVyLCBmb3JtYXR0ZXIsIGZpcnN0b3V0cHV0LCBzcGVjaWFsZGVsaW1pdGVyLCBsYWJlbCwgbXluYW1lLCBuYW1lcywgbmFtZSwgeWVhciwgc3VmZml4LCB0ZXJtLCBkcCwgbGVuLCBwb3MsIG4sIG0sIHZhbHVlLCBmbGFnO1xuICAgICAgICBpZiAodGhpcy5wb3N0cG9uZWRfbWFjcm8pIHtcbiAgICAgICAgICAgIHZhciBncm91cF9zdGFydCA9IENTTC5VdGlsLmNsb25lVG9rZW4odGhpcyk7XG4gICAgICAgICAgICBncm91cF9zdGFydC5uYW1lID0gXCJncm91cFwiO1xuICAgICAgICAgICAgZ3JvdXBfc3RhcnQudG9rZW50eXBlID0gQ1NMLlNUQVJUO1xuICAgICAgICAgICAgQ1NMLk5vZGUuZ3JvdXAuYnVpbGQuY2FsbChncm91cF9zdGFydCwgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICBDU0wuZXhwYW5kTWFjcm8uY2FsbChzdGF0ZSwgdGhpcywgdGFyZ2V0KTtcbiAgICAgICAgICAgIHZhciBncm91cF9lbmQgPSBDU0wuVXRpbC5jbG9uZVRva2VuKHRoaXMpO1xuICAgICAgICAgICAgZ3JvdXBfZW5kLm5hbWUgPSBcImdyb3VwXCI7XG4gICAgICAgICAgICBncm91cF9lbmQudG9rZW50eXBlID0gQ1NMLkVORDtcbiAgICAgICAgICAgIGlmICh0aGlzLnBvc3Rwb25lZF9tYWNybyA9PT0gJ2p1cmlzLWxvY2F0b3ItbGFiZWwnKSB7XG4gICAgICAgICAgICAgICAgZ3JvdXBfZW5kLmlzSnVyaXNMb2NhdG9yTGFiZWwgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgQ1NMLk5vZGUuZ3JvdXAuYnVpbGQuY2FsbChncm91cF9lbmQsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgQ1NMLlV0aWwuc3Vic3RpdHV0ZVN0YXJ0LmNhbGwodGhpcywgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgICAgICBpZiAoIXRoaXMudmFyaWFibGVzX3JlYWwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnZhcmlhYmxlc19yZWFsID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXRoaXMudmFyaWFibGVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy52YXJpYWJsZXMgPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvcm0gPSBcImxvbmdcIjtcbiAgICAgICAgICAgIHBsdXJhbCA9IDA7XG4gICAgICAgICAgICBpZiAodGhpcy5zdHJpbmdzLmZvcm0pIHtcbiAgICAgICAgICAgICAgICBmb3JtID0gdGhpcy5zdHJpbmdzLmZvcm07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5zdHJpbmdzLnBsdXJhbCkge1xuICAgICAgICAgICAgICAgIHBsdXJhbCA9IHRoaXMuc3RyaW5ncy5wbHVyYWw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoXCJjaXRhdGlvbi1udW1iZXJcIiA9PT0gdGhpcy52YXJpYWJsZXNfcmVhbFswXSB8fCBcInllYXItc3VmZml4XCIgPT09IHRoaXMudmFyaWFibGVzX3JlYWxbMF0gfHwgXCJjaXRhdGlvbi1sYWJlbFwiID09PSB0aGlzLnZhcmlhYmxlc19yZWFsWzBdKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudmFyaWFibGVzX3JlYWxbMF0gPT09IFwiY2l0YXRpb24tbnVtYmVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLnJvb3QgPT09IFwiY2l0YXRpb25cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3B0LnVwZGF0ZV9tb2RlID0gQ1NMLk5VTUVSSUM7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmJ1aWxkLnJvb3QgPT09IFwiYmlibGlvZ3JhcGh5XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5iaWJfbW9kZSA9IENTTC5OVU1FUklDO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5idWlsZC5hcmVhID09PSBcImJpYmxpb2dyYXBoeV9zb3J0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5jaXRhdGlvbl9udW1iZXJfc29ydF91c2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoXCJjaXRhdGlvbi1udW1iZXJcIiA9PT0gc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdC5jb2xsYXBzZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yYW5nZV9wcmVmaXggPSBzdGF0ZS5nZXRUZXJtKFwiY2l0YXRpb24tcmFuZ2UtZGVsaW1pdGVyXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3VjY2Vzc29yX3ByZWZpeCA9IHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5sYXlvdXRfZGVsaW1pdGVyO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNwbGljZV9wcmVmaXggPSBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQubGF5b3V0X2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWQgPSBcIlwiICsgSXRlbS5pZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW1bXCJhdXRob3Itb25seVwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZWxlbWVudF90cmFjZS5yZXBsYWNlKFwiZG8tbm90LXN1cHByZXNzLW1lXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmZXJlbmNlX3Rlcm0gPSBzdGF0ZS5nZXRUZXJtKFwicmVmZXJlbmNlXCIsIFwibG9uZ1wiLCBcInNpbmd1bGFyXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHJlZmVyZW5jZV90ZXJtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VfdGVybSA9IFwicmVmZXJlbmNlXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVybSA9IENTTC5PdXRwdXQuRm9ybWF0dGVyc1tcImNhcGl0YWxpemUtZmlyc3RcIl0oc3RhdGUsIHJlZmVyZW5jZV90ZXJtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh0ZXJtICsgXCIgXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAubGFzdF9lbGVtZW50X3RyYWNlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbVtcInN1cHByZXNzLWF1dGhvclwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmxhc3RfZWxlbWVudF90cmFjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmVsZW1lbnRfdHJhY2UucmVwbGFjZShcInN1cHByZXNzLW1lXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5sYXN0X2VsZW1lbnRfdHJhY2UgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtID0gc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbaWRdLnNlcTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LmNpdGF0aW9uX251bWJlcl9zbHVnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQoc3RhdGUub3B0LmNpdGF0aW9uX251bWJlcl9zbHVnLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIgPSBuZXcgQ1NMLk51bWVyaWNCbG9iKGZhbHNlLCBudW0sIHRoaXMsIEl0ZW0uaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmluX2NpdGVfcHJlZGVjZXNzb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyLnN1cHByZXNzX3NwbGljZV9wcmVmaXggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQobnVtYmVyLCBcImxpdGVyYWxcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnZhcmlhYmxlc19yZWFsWzBdID09PSBcInllYXItc3VmZml4XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3B0Lmhhc195ZWFyX3N1ZmZpeCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0LmNvbGxhcHNlID09PSBcInllYXItc3VmZml4LXJhbmdlZFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJhbmdlX3ByZWZpeCA9IHN0YXRlLmdldFRlcm0oXCJjaXRhdGlvbi1yYW5nZS1kZWxpbWl0ZXJcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWNjZXNzb3JfcHJlZml4ID0gc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0LmxheW91dF9kZWxpbWl0ZXI7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0W1wieWVhci1zdWZmaXgtZGVsaW1pdGVyXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN1Y2Nlc3Nvcl9wcmVmaXggPSBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHRbXCJ5ZWFyLXN1ZmZpeC1kZWxpbWl0ZXJcIl07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdICYmIHN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLnllYXJfc3VmZml4ICE9PSBmYWxzZSAmJiAhc3RhdGUudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bSA9IHBhcnNlSW50KHN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLnllYXJfc3VmZml4LCAxMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQuY2l0ZV9ncm91cF9kZWxpbWl0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWNjZXNzb3JfcHJlZml4ID0gc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdC5jaXRlX2dyb3VwX2RlbGltaXRlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyID0gbmV3IENTTC5OdW1lcmljQmxvYihmYWxzZSwgbnVtLCB0aGlzLCBJdGVtLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXIgPSBuZXcgQ1NMLlV0aWwuU3VmZml4YXRvcihDU0wuU1VGRklYX0NIQVJTKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1iZXIuc2V0Rm9ybWF0dGVyKGZvcm1hdHRlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZChudW1iZXIsIFwibGl0ZXJhbFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdG91dHB1dCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXN0YXRlLnRtcC5ncm91cF9jb250ZXh0Lm15c3RhY2subGVuZ3RoOyBpPGlsZW47IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmxhZ3MgPSBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC5teXN0YWNrW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWZsYWdzLnZhcmlhYmxlX3N1Y2Nlc3MgJiYgKGZsYWdzLnZhcmlhYmxlX2F0dGVtcHQgfHwgKCFmbGFncy52YXJpYWJsZV9hdHRlbXB0ICYmICFmbGFncy50ZXJtX2ludGVuZGVkKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0b3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpYWxkZWxpbWl0ZXIgPSBzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0W1wieWVhci1zdWZmaXgtZGVsaW1pdGVyXCJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdG91dHB1dCAmJiBzcGVjaWFsZGVsaW1pdGVyICYmICFzdGF0ZS50bXAuc29ydF9rZXlfZmxhZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuc3BsaWNlX2RlbGltaXRlciA9IHN0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHRbXCJ5ZWFyLXN1ZmZpeC1kZWxpbWl0ZXJcIl07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnZhcmlhYmxlc19yZWFsWzBdID09PSBcImNpdGF0aW9uLWxhYmVsXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3B0Lmhhc195ZWFyX3N1ZmZpeCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsID0gSXRlbVtcImNpdGF0aW9uLWxhYmVsXCJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsYWJlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsID0gc3RhdGUuZ2V0Q2l0YXRpb25MYWJlbChJdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1ZmZpeCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdICYmIHN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLnllYXJfc3VmZml4ICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW0gPSBwYXJzZUludChzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy55ZWFyX3N1ZmZpeCwgMTApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSBzdGF0ZS5mdW4uc3VmZml4YXRvci5mb3JtYXQobnVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgKz0gc3VmZml4O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZChsYWJlbCwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cmluZ3MudGVybSkge1xuICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2VuZGVyID0gc3RhdGUub3B0LmdlbmRlcltJdGVtLnR5cGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlcm0gPSB0aGlzLnN0cmluZ3MudGVybTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlcm0gPSBzdGF0ZS5nZXRUZXJtKHRlcm0sIGZvcm0sIHBsdXJhbCwgZ2VuZGVyLCBDU0wuVE9MRVJBTlQsIHRoaXMuZGVmYXVsdF9sb2NhbGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG15dGVybTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0ZXJtICE9PSBcIlwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLnRlcm1faW50ZW5kZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgQ1NMLlVQREFURV9HUk9VUF9DT05URVhUX0NPTkRJVElPTihzdGF0ZSwgdGVybSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC50ZXJtX3ByZWRlY2Vzc29yICYmICEoc3RhdGUub3B0W1wiY2xhc3NcIl0gPT09IFwiaW4tdGV4dFwiICYmIHN0YXRlLnRtcC5hcmVhID09PSBcImNpdGF0aW9uXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXl0ZXJtID0gQ1NMLk91dHB1dC5Gb3JtYXR0ZXJzW1wiY2FwaXRhbGl6ZS1maXJzdFwiXShzdGF0ZSwgdGVybSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15dGVybSA9IHRlcm07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLnN0cmlwX3BlcmlvZHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBteXRlcm0gPSBteXRlcm0ucmVwbGFjZSgvXFwuL2csIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMuZGVjb3JhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChcIkBzdHJpcC1wZXJpb2RzXCIgPT09IHRoaXMuZGVjb3JhdGlvbnNbaV1bMF0gJiYgXCJ0cnVlXCIgPT09IHRoaXMuZGVjb3JhdGlvbnNbaV1bMV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15dGVybSA9IG15dGVybS5yZXBsYWNlKC9cXC4vZywgXCJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQobXl0ZXJtLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5idWlsZC50ZXJtID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmJ1aWxkLmZvcm0gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYnVpbGQucGx1cmFsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnZhcmlhYmxlc19yZWFsLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52YXJpYWJsZXNfcmVhbFswXSAhPT0gXCJsb2NhdG9yXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuaGF2ZV9jb2xsYXBzZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJhbGxlbF92YXJpYWJsZSA9IHRoaXMudmFyaWFibGVzWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFsbGVsX3ZhcmlhYmxlID09PSBcInRpdGxlXCIgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgKGZvcm0gPT09IFwic2hvcnRcIiB8fCBJdGVtW1widGl0bGUtc2hvcnRcIl0pKSB7IFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFsbGVsX3ZhcmlhYmxlID0gXCJ0aXRsZS1zaG9ydFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwuU3RhcnRWYXJpYWJsZShwYXJhbGxlbF92YXJpYWJsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5BcHBlbmRUb1ZhcmlhYmxlKEl0ZW1bcGFyYWxsZWxfdmFyaWFibGVdLHBhcmFsbGVsX3ZhcmlhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLmNvbmRpdGlvbiAmJiBJdGVtW3RoaXMudmFyaWFibGVzWzBdXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5qdXN0X2RpZF9udW1iZXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoQ1NMLk1VTFRJX0ZJRUxEUy5pbmRleE9mKHRoaXMudmFyaWFibGVzX3JlYWxbMF0pID4gLTFcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IFtcImxhbmd1YWdlLW5hbWVcIiwgXCJsYW5ndWFnZS1uYW1lLW9yaWdpbmFsXCJdLmluZGV4T2YodGhpcy52YXJpYWJsZXNfcmVhbFswXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFiYnJldmZhbSA9IHRoaXMudmFyaWFibGVzWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFiYnJmYWxsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWx0dmFyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNmYWxsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybSA9PT0gXCJzaG9ydFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudmFyaWFibGVzX3JlYWxbMF0gPT09IFwiY29udGFpbmVyLXRpdGxlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWx0dmFyID0gXCJqb3VybmFsQWJicmV2aWF0aW9uXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnZhcmlhYmxlc19yZWFsWzBdID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWx0dmFyID0gXCJ0aXRsZS1zaG9ydFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWJicmV2ZmFtID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuYnVpbGQuZXh0ZW5zaW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNmYWxsID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNmYWxsID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhYmJyZmFsbCA9IHRydWU7XG5cdFx0XHRcdFx0XHR9XG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jID0gc3RhdGUudHJhbnNmb3JtLmdldE91dHB1dEZ1bmN0aW9uKHRoaXMudmFyaWFibGVzLCBhYmJyZXZmYW0sIGFiYnJmYWxsLCBhbHR2YXIsIHRyYW5zZmFsbCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoQ1NMLkNJVEVfRklFTERTLmluZGV4T2YodGhpcy52YXJpYWJsZXNfcmVhbFswXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbVt0aGlzLnZhcmlhYmxlc1swXV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnByb2Nlc3NOdW1iZXIodGhpcywgaXRlbSwgdGhpcy52YXJpYWJsZXNbMF0sIEl0ZW0udHlwZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDU0wuVXRpbC5vdXRwdXROdW1lcmljRmllbGQoc3RhdGUsIHRoaXMudmFyaWFibGVzWzBdLCBJdGVtLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodmFsdWUsIHRoaXMsIGZhbHNlLCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoW1wibG9jYXRvclwiLCBcImxvY2F0b3ItZXh0cmFcIl0uaW5kZXhPZih0aGlzLnZhcmlhYmxlc19yZWFsWzBdKSA+IC0xXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAhc3RhdGUudG1wLmp1c3RfbG9va2luZykgeyBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZG9uZV92YXJzLnB1c2godGhpcy52YXJpYWJsZXNfcmVhbFswXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlICBpZiAoW1wicGFnZVwiLCBcInBhZ2UtZmlyc3RcIiwgXCJjaGFwdGVyLW51bWJlclwiLCBcImNvbGxlY3Rpb24tbnVtYmVyXCIsIFwiZWRpdGlvblwiLCBcImlzc3VlXCIsIFwibnVtYmVyXCIsIFwibnVtYmVyLW9mLXBhZ2VzXCIsIFwibnVtYmVyLW9mLXZvbHVtZXNcIiwgXCJ2b2x1bWVcIl0uaW5kZXhPZih0aGlzLnZhcmlhYmxlc19yZWFsWzBdKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnByb2Nlc3NOdW1iZXIodGhpcywgSXRlbSwgdGhpcy52YXJpYWJsZXNbMF0sIEl0ZW0udHlwZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENTTC5VdGlsLm91dHB1dE51bWVyaWNGaWVsZChzdGF0ZSwgdGhpcy52YXJpYWJsZXNbMF0sIEl0ZW0uaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoW1wiVVJMXCIsIFwiRE9JXCJdLmluZGV4T2YodGhpcy52YXJpYWJsZXNfcmVhbFswXSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy52YXJpYWJsZXNbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gc3RhdGUuZ2V0VmFyaWFibGUoSXRlbSwgdGhpcy52YXJpYWJsZXNbMF0sIGZvcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLndyYXBfdXJsX2FuZF9kb2kpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmRlY29yYXRpb25zLmxlbmd0aCB8fCB0aGlzLmRlY29yYXRpb25zWzBdWzBdICE9PSBcIkBcIiArIHRoaXMudmFyaWFibGVzWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY29yYXRpb25zID0gW1tcIkBcIiArIHRoaXMudmFyaWFibGVzWzBdLCBcInRydWVcIl1dLmNvbmNhdCh0aGlzLmRlY29yYXRpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlY29yYXRpb25zLmxlbmd0aCAmJiB0aGlzLmRlY29yYXRpb25zWzBdWzBdID09PSBcIkBcIiArIHRoaXMudmFyaWFibGVzWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY29yYXRpb25zID0gdGhpcy5kZWNvcmF0aW9ucy5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHZhbHVlLCB0aGlzLCBmYWxzZSwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy52YXJpYWJsZXNfcmVhbFswXSA9PT0gXCJzZWN0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBzdGF0ZS5nZXRWYXJpYWJsZShJdGVtLCB0aGlzLnZhcmlhYmxlc1swXSwgZm9ybSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh2YWx1ZSwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnZhcmlhYmxlc19yZWFsWzBdID09PSBcImhlcmVpbmFmdGVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW1wiZGVmYXVsdFwiXVtcImhlcmVpbmFmdGVyXCJdW0l0ZW0uaWRdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodmFsdWUsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmdyb3VwX2NvbnRleHQudGlwLnZhcmlhYmxlX3N1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudmFyaWFibGVzWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlLmdldFZhcmlhYmxlKEl0ZW0sIHRoaXMudmFyaWFibGVzWzBdLCBmb3JtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gXCJcIiArIHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc3BsaXQoXCJcXFxcXCIpLmpvaW4oXCJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh2YWx1ZSwgdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwuQ2xvc2VWYXJpYWJsZShcInRleHRcIik7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RyaW5ncy52YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZ3JvdXBfY29udGV4dC50aXAudGVybV9pbnRlbmRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBDU0wuVVBEQVRFX0dST1VQX0NPTlRFWFRfQ09ORElUSU9OKHN0YXRlLCB0aGlzLnN0cmluZ3MudmFsdWUsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh0aGlzLnN0cmluZ3MudmFsdWUsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGFyZ2V0LnB1c2godGhpcyk7XG4gICAgICAgICAgICBDU0wuVXRpbC5zdWJzdGl0dXRlRW5kLmNhbGwodGhpcywgc3RhdGUsIHRhcmdldCk7XG4gICAgICAgIH1cbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuQXR0cmlidXRlcyA9IHt9O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZ2VucmVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGFyZyA9IGFyZy5yZXBsYWNlKFwiLVwiLCBcIiBcIik7XG4gICAgdmFyIGZ1bmMgPSBmdW5jdGlvbiAoSXRlbSwgaXRlbSkge1xuICAgICAgICB2YXIgcmV0O1xuICAgICAgICBpZiAoYXJnID09PSBJdGVtLmdlbnJlKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMudGVzdHMucHVzaChmdW5jKTtcbn1cbkNTTC5BdHRyaWJ1dGVzW1wiQGRpc2FtYmlndWF0ZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgc3RhdGUub3B0Lmhhc19kaXNhbWJpZ3VhdGUgPSB0cnVlO1xuICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICBzdGF0ZS50bXAuZGlzYW1iaWd1YXRlX21heE1heCArPSAxO1xuICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5kaXNhbWJpZ19zZXR0aW5ncy5kaXNhbWJpZ3VhdGVcbiAgICAgICAgICAgICAgICAmJiBzdGF0ZS50bXAuZGlzYW1iaWd1YXRlX2NvdW50IDwgc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLmRpc2FtYmlndWF0ZSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5kaXNhbWJpZ3VhdGVfY291bnQgKz0gMTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKGZ1bmMpO1xuICAgIH0gZWxzZSBpZiAoYXJnID09PSBcImNoZWNrLWFtYmlndWl0eS1hbmQtYmFja3JlZmVyZW5jZVwiKSB7XG4gICAgICAgIHZhciBmdW5jID0gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIGlmIChzdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5kaXNhbWJpZy5kaXNhbWJpZ3VhdGUgJiYgc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF1bXCJjaXRhdGlvbi1jb3VudFwiXSA+IDEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKGZ1bmMpO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBpcy1udW1lcmljXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcsIGpvaW5lcikge1xuICAgIHZhciB2YXJpYWJsZXMgPSBhcmcuc3BsaXQoL1xccysvKTtcbiAgICB2YXIgbWFrZXRlc3QgPSBmdW5jdGlvbih2YXJpYWJsZSkge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIHZhciBteWl0ZW0gPSBJdGVtO1xuICAgICAgICAgICAgaWYgKFtcImxvY2F0b3JcIixcImxvY2F0b3ItZXh0cmFcIl0uaW5kZXhPZih2YXJpYWJsZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIG15aXRlbSA9IGl0ZW07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIG15aXRlbSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChDU0wuTlVNRVJJQ19WQVJJQUJMRVMuaW5kZXhPZih2YXJpYWJsZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIGlmICghc3RhdGUudG1wLnNoYWRvd19udW1iZXJzW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wcm9jZXNzTnVtYmVyKGZhbHNlLCBteWl0ZW0sIHZhcmlhYmxlLCBJdGVtLnR5cGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobXlpdGVtW3ZhcmlhYmxlXSAmJiBzdGF0ZS50bXAuc2hhZG93X251bWJlcnNbdmFyaWFibGVdLm51bWVyaWMpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChbXCJ0aXRsZVwiLCBcImxvY2F0b3ItZXh0cmFcIixcInZlcnNpb25cIl0uaW5kZXhPZih2YXJpYWJsZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIGlmIChteWl0ZW1bdmFyaWFibGVdKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChteWl0ZW1bdmFyaWFibGVdLnNsaWNlKC0xKSA9PT0gXCJcIiArIHBhcnNlSW50KG15aXRlbVt2YXJpYWJsZV0uc2xpY2UoLTEpLCAxMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MDsgaTx2YXJpYWJsZXMubGVuZ3RoOyBpKz0xKSB7XG4gICAgICAgIHRoaXMudGVzdHMucHVzaChtYWtldGVzdCh2YXJpYWJsZXNbaV0pKTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAaXMtdW5jZXJ0YWluLWRhdGVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciB2YXJpYWJsZXMgPSBhcmcuc3BsaXQoL1xccysvKTtcbiAgICB2YXIgbWFrZXRlc3QgPSBmdW5jdGlvbiAobXl2YXJpYWJsZSkge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgaWYgKEl0ZW1bbXl2YXJpYWJsZV0gJiYgSXRlbVtteXZhcmlhYmxlXS5jaXJjYSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yICh2YXIgaT0wLGlsZW49dmFyaWFibGVzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QodmFyaWFibGVzW2ldKSk7XG4gICAgfTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBsb2NhdG9yXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgdHJ5bGFiZWxzID0gYXJnLnJlcGxhY2UoXCJzdWIgdmVyYm9cIiwgXCJzdWItdmVyYm9cIik7XG4gICAgdHJ5bGFiZWxzID0gdHJ5bGFiZWxzLnNwbGl0KC9cXHMrLyk7XG4gICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24gKHRyeWxhYmVsKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICB2YXIgbGFiZWw7XG4gICAgICAgICAgICBzdGF0ZS5wcm9jZXNzTnVtYmVyKGZhbHNlLCBpdGVtLCBcImxvY2F0b3JcIik7XG4gICAgICAgICAgICBsYWJlbCA9IHN0YXRlLnRtcC5zaGFkb3dfbnVtYmVycy5sb2NhdG9yLmxhYmVsO1xuICAgICAgICAgICAgaWYgKHRyeWxhYmVsID09PSBsYWJlbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yICh2YXIgaT0wLGlsZW49dHJ5bGFiZWxzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QodHJ5bGFiZWxzW2ldKSk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHBvc2l0aW9uXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgdHJ5cG9zaXRpb247XG4gICAgc3RhdGUub3B0LnVwZGF0ZV9tb2RlID0gQ1NMLlBPU0lUSU9OO1xuICAgIHN0YXRlLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMgPSBudWxsO1xuICAgIHZhciB0cnlwb3NpdGlvbnMgPSBhcmcuc3BsaXQoL1xccysvKTtcbiAgICB2YXIgbWFrZXRlc3QgPSBmdW5jdGlvbih0cnlwb3NpdGlvbikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuYXJlYSA9PT0gXCJiaWJsaW9ncmFwaHlcIikge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpdGVtICYmIFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBpdGVtLnBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgaXRlbS5wb3NpdGlvbiA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXRlbSAmJiB0eXBlb2YgaXRlbS5wb3NpdGlvbiA9PT0gXCJudW1iZXJcIikge1xuICAgICAgICAgICAgICAgIGlmIChpdGVtLnBvc2l0aW9uID09PSAwICYmIHRyeXBvc2l0aW9uID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHJ5cG9zaXRpb24gPiAwICYmIGl0ZW0ucG9zaXRpb24gPj0gdHJ5cG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0cnlwb3NpdGlvbiA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPXRyeXBvc2l0aW9ucy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgdmFyIHRyeXBvc2l0aW9uID0gdHJ5cG9zaXRpb25zW2ldO1xuICAgICAgICBpZiAodHJ5cG9zaXRpb24gPT09IFwiZmlyc3RcIikge1xuICAgICAgICAgICAgdHJ5cG9zaXRpb24gPSBDU0wuUE9TSVRJT05fRklSU1Q7XG4gICAgICAgIH0gZWxzZSBpZiAodHJ5cG9zaXRpb24gPT09IFwic3Vic2VxdWVudFwiKSB7XG4gICAgICAgICAgICB0cnlwb3NpdGlvbiA9IENTTC5QT1NJVElPTl9TVUJTRVFVRU5UO1xuICAgICAgICB9IGVsc2UgaWYgKHRyeXBvc2l0aW9uID09PSBcImliaWRcIikge1xuICAgICAgICAgICAgdHJ5cG9zaXRpb24gPSBDU0wuUE9TSVRJT05fSUJJRDtcbiAgICAgICAgfSBlbHNlIGlmICh0cnlwb3NpdGlvbiA9PT0gXCJpYmlkLXdpdGgtbG9jYXRvclwiKSB7XG4gICAgICAgICAgICB0cnlwb3NpdGlvbiA9IENTTC5QT1NJVElPTl9JQklEX1dJVEhfTE9DQVRPUjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXCJuZWFyLW5vdGVcIiA9PT0gdHJ5cG9zaXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMudGVzdHMucHVzaChmdW5jdGlvbiAoSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW0ucG9zaXRpb24gPj0gQ1NMLlBPU0lUSU9OX1NVQlNFUVVFTlQgJiYgaXRlbVtcIm5lYXItbm90ZVwiXSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAoXCJmYXItbm90ZVwiID09PSB0cnlwb3NpdGlvbikge1xuICAgICAgICAgICAgdGhpcy50ZXN0cy5wdXNoKGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbS5wb3NpdGlvbiA9PSBDU0wuUE9TSVRJT05fU1VCU0VRVUVOVCAmJiAhaXRlbVtcIm5lYXItbm90ZVwiXSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QodHJ5cG9zaXRpb24pKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkB0eXBlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgdHlwZXMgPSBhcmcuc3BsaXQoL1xccysvKTtcbiAgICB2YXIgbWFrZXRlc3QgPSBmdW5jdGlvbiAobXl0eXBlKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihJdGVtLGl0ZW0pIHtcbiAgICAgICAgICAgIHZhciByZXQgPSAoSXRlbS50eXBlID09PSBteXR5cGUpO1xuICAgICAgICAgICAgaWYgKHJldCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHRlc3RzID0gW107XG4gICAgZm9yICh2YXIgaT0wLGlsZW49dHlwZXMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgIHRlc3RzLnB1c2gobWFrZXRlc3QodHlwZXNbaV0pKTtcbiAgICB9XG4gICAgdGhpcy50ZXN0cy5wdXNoKHN0YXRlLmZ1bi5tYXRjaC5hbnkodGhpcywgc3RhdGUsIHRlc3RzKSk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAdmFyaWFibGVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciBmdW5jO1xuICAgIHRoaXMudmFyaWFibGVzID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgdGhpcy52YXJpYWJsZXNfcmVhbCA9IHRoaXMudmFyaWFibGVzLnNsaWNlKCk7XG4gICAgaWYgKFwibGFiZWxcIiA9PT0gdGhpcy5uYW1lICYmIHRoaXMudmFyaWFibGVzWzBdKSB7XG4gICAgICAgIHRoaXMuc3RyaW5ncy50ZXJtID0gdGhpcy52YXJpYWJsZXNbMF07XG4gICAgfSBlbHNlIGlmIChbXCJuYW1lc1wiLCBcImRhdGVcIiwgXCJ0ZXh0XCIsIFwibnVtYmVyXCJdLmluZGV4T2YodGhpcy5uYW1lKSA+IC0xKSB7XG4gICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLnZhcmlhYmxlcy5sZW5ndGggLSAxOyBpID4gLTE7IGkgKz0gLTEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnZhcmlhYmxlcy5wb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMudmFyaWFibGVzX3JlYWwubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmRvbmVfdmFycy5pbmRleE9mKHRoaXMudmFyaWFibGVzX3JlYWxbaV0pID09PSAtMSBcbiAgICAgICAgICAgICAgICAgICAgJiYgIShpdGVtICYmIEl0ZW0udHlwZSA9PT0gXCJsZWdhbF9jYXNlXCIgJiYgaXRlbVtcInN1cHByZXNzLWF1dGhvclwiXSAmJiB0aGlzLnZhcmlhYmxlc19yZWFsW2ldID09PSBcInRpdGxlXCIpXG4gICAgICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmFyaWFibGVzLnB1c2godGhpcy52YXJpYWJsZXNfcmVhbFtpXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuY2FuX2Jsb2NrX3N1YnN0aXR1dGUpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmRvbmVfdmFycy5wdXNoKHRoaXMudmFyaWFibGVzX3JlYWxbaV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICB2YXIgbXlkYXRlO1xuICAgICAgICAgICAgdmFyIG91dHB1dCA9IGZhbHNlO1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGhpcy52YXJpYWJsZXMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgdmFyaWFibGUgPSB0aGlzLnZhcmlhYmxlc1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoW1wiYXV0aG9yaXR5XCIsIFwiY29tbWl0dGVlXCJdLmluZGV4T2YodmFyaWFibGUpID4gLTFcbiAgICAgICAgICAgICAgICAgICAgJiYgXCJzdHJpbmdcIiA9PT0gdHlwZW9mIEl0ZW1bdmFyaWFibGVdXG4gICAgICAgICAgICAgICAgICAgICYmIFwibmFtZXNcIiA9PT0gdGhpcy5uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjcmVhdG9yUGFyZW50cyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHZhciByYXdOYW1lcyA9IEl0ZW1bdmFyaWFibGVdLnNwbGl0KC9cXHMqO1xccyovKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJhd011bHRpTmFtZXMgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKEl0ZW0ubXVsdGkgJiYgSXRlbS5tdWx0aS5fa2V5c1t2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGxhbmdUYWcgaW4gSXRlbS5tdWx0aS5fa2V5c1t2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXdNdWx0aU5hbWVzW2xhbmdUYWddID0gSXRlbS5tdWx0aS5fa2V5c1t2YXJpYWJsZV1bbGFuZ1RhZ10uc3BsaXQoL1xccyo7XFxzKi8pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyYXdNdWx0aU5hbWVzW2xhbmdUYWddLmxlbmd0aCAhPT0gcmF3TmFtZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNWYWxpZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmF3TmFtZXMgPSBbSXRlbVt2YXJpYWJsZV1dO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmF3TXVsdGlOYW1lcyA9IEl0ZW0ubXVsdGkuX2tleXNbdmFyaWFibGVdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gcmF3TmFtZXMubGVuZ3RoOyBqIDwgamxlbjsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgY3JlYXRvclBhcmVudCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXRlcmFsOnJhd05hbWVzW2pdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11bHRpOntcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2tleTp7fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBsYW5nVGFnIGluIHJhd011bHRpTmFtZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY3JlYXRvckNoaWxkID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXRlcmFsOnJhd011bHRpTmFtZXNbbGFuZ1RhZ11bal1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRvclBhcmVudC5tdWx0aS5fa2V5W2xhbmdUYWddID0gY3JlYXRvckNoaWxkO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmF3TmFtZXNbal0gPSBjcmVhdG9yUGFyZW50O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIEl0ZW1bdmFyaWFibGVdID0gcmF3TmFtZXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnN0cmluZ3MuZm9ybSA9PT0gXCJzaG9ydFwiICYmICFJdGVtW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodmFyaWFibGUgPT09IFwidGl0bGVcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUgPSBcInRpdGxlLXNob3J0XCI7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFyaWFibGUgPT09IFwiY29udGFpbmVyLXRpdGxlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlID0gXCJqb3VybmFsQWJicmV2aWF0aW9uXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHZhcmlhYmxlID09PSBcInllYXItc3VmZml4XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChDU0wuREFURV9WQVJJQUJMRVMuaW5kZXhPZih2YXJpYWJsZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMubG9jYXRvcl9kYXRlX2FuZF9yZXZpc2lvbiAmJiBcImxvY2F0b3ItZGF0ZVwiID09PSB2YXJpYWJsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChJdGVtW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIEl0ZW1bdmFyaWFibGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0ZXBhcnRzLmluZGV4T2Yoa2V5KSA9PT0gLTEgJiYgXCJsaXRlcmFsXCIgIT09IGtleSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEl0ZW1bdmFyaWFibGVdW2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG91dHB1dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChcImxvY2F0b3JcIiA9PT0gdmFyaWFibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbS5sb2NhdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJsb2NhdG9yLWV4dHJhXCIgPT09IHZhcmlhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW1bXCJsb2NhdG9yLWV4dHJhXCJdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoW1wiY2l0YXRpb24tbnVtYmVyXCIsXCJjaXRhdGlvbi1sYWJlbFwiXS5pbmRleE9mKHZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXJcIiA9PT0gdmFyaWFibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbVtcImZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlclwiXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwiaGVyZWluYWZ0ZXJcIiA9PT0gdmFyaWFibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW1wiZGVmYXVsdFwiXS5oZXJlaW5hZnRlcltJdGVtLmlkXVxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgc3RhdGUuc3lzLmdldEFiYnJldmlhdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgSXRlbS5pZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwib2JqZWN0XCIgPT09IHR5cGVvZiBJdGVtW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoSXRlbVt2YXJpYWJsZV0ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgSXRlbVt2YXJpYWJsZV0gJiYgSXRlbVt2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChcIm51bWJlclwiID09PSB0eXBlb2YgSXRlbVt2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChvdXRwdXQpIHtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG91dHB1dCkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXRoaXMudmFyaWFibGVzX3JlYWwubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhcmlhYmxlID0gdGhpcy52YXJpYWJsZXNfcmVhbFtpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhcmlhYmxlICE9PSBcImNpdGF0aW9uLW51bWJlclwiIHx8IHN0YXRlLnRtcC5hcmVhICE9PSBcImJpYmxpb2dyYXBoeVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuY2l0ZV9yZW5kZXJzX2NvbnRlbnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC52YXJpYWJsZV9zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5jYW5fc3Vic3RpdHV0ZS52YWx1ZSgpIFxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgc3RhdGUudG1wLmFyZWEgPT09IFwiYmlibGlvZ3JhcGh5XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIFwic3RyaW5nXCIgPT09IHR5cGVvZiBJdGVtW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLm5hbWVfbm9kZS50b3AgPSBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLnJlbmRlcmVkX25hbWUucHVzaChJdGVtW3ZhcmlhYmxlXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLmNhbl9zdWJzdGl0dXRlLnJlcGxhY2UoZmFsc2UsICBDU0wuTElURVJBTCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5ncm91cF9jb250ZXh0LnRpcC52YXJpYWJsZV9hdHRlbXB0ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgIH0gZWxzZSBpZiAoW1wiaWZcIiwgIFwiZWxzZS1pZlwiLCBcImNvbmRpdGlvblwiXS5pbmRleE9mKHRoaXMubmFtZSkgPiAtMSkge1xuICAgICAgICB2YXIgbWFrZXRlc3QgPSBmdW5jdGlvbiAodmFyaWFibGUpIHtcbiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihJdGVtLGl0ZW0pe1xuICAgICAgICAgICAgICAgIHZhciBteWl0ZW0gPSBJdGVtO1xuICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIFtcImxvY2F0b3JcIiwgXCJsb2NhdG9yLWV4dHJhXCIsIFwiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCIsIFwibG9jYXRvci1kYXRlXCJdLmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgbXlpdGVtID0gaXRlbTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHZhcmlhYmxlID09PSBcImhlcmVpbmFmdGVyXCIgJiYgc3RhdGUuc3lzLmdldEFiYnJldmlhdGlvbiAmJiBteWl0ZW0uaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW1wiZGVmYXVsdFwiXS5oZXJlaW5hZnRlcltteWl0ZW0uaWRdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobXlpdGVtW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoXCJudW1iZXJcIiA9PT0gdHlwZW9mIG15aXRlbVt2YXJpYWJsZV0gfHwgXCJzdHJpbmdcIiA9PT0gdHlwZW9mIG15aXRlbVt2YXJpYWJsZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwib2JqZWN0XCIgPT09IHR5cGVvZiBteWl0ZW1bdmFyaWFibGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbXlpdGVtW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChteWl0ZW1bdmFyaWFibGVdW2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj10aGlzLnZhcmlhYmxlcy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgIHRoaXMudGVzdHMucHVzaChtYWtldGVzdCh0aGlzLnZhcmlhYmxlc1tpXSkpO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHBhZ2VcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciB0cnlsYWJlbHMgPSBhcmcucmVwbGFjZShcInN1YiB2ZXJib1wiLCBcInN1Yi12ZXJib1wiKTtcbiAgICB0cnlsYWJlbHMgPSB0cnlsYWJlbHMuc3BsaXQoL1xccysvKTtcbiAgICB2YXIgbWFrZXRlc3QgPSBmdW5jdGlvbiAodHJ5bGFiZWwpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIHZhciBsYWJlbDtcbiAgICAgICAgICAgIHN0YXRlLnByb2Nlc3NOdW1iZXIoZmFsc2UsIEl0ZW0sIFwicGFnZVwiLCBJdGVtLnR5cGUpO1xuICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAuc2hhZG93X251bWJlcnMucGFnZS5sYWJlbCkge1xuICAgICAgICAgICAgICAgIGxhYmVsID0gXCJwYWdlXCI7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnRtcC5zaGFkb3dfbnVtYmVycy5wYWdlLmxhYmVsID09PSBcInN1YiB2ZXJib1wiKSB7XG4gICAgICAgICAgICAgICAgbGFiZWwgPSBcInN1Yi12ZXJib1wiO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsYWJlbCA9IHN0YXRlLnRtcC5zaGFkb3dfbnVtYmVycy5wYWdlLmxhYmVsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRyeWxhYmVsID09PSBsYWJlbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yICh2YXIgaT0wLGlsZW49dHJ5bGFiZWxzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QodHJ5bGFiZWxzW2ldKSk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQG51bWJlclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHRyeWxhYmVscyA9IGFyZy5yZXBsYWNlKFwic3ViIHZlcmJvXCIsIFwic3ViLXZlcmJvXCIpO1xuICAgIHRyeWxhYmVscyA9IHRyeWxhYmVscy5zcGxpdCgvXFxzKy8pO1xuICAgIHZhciBtYWtldGVzdCA9IGZ1bmN0aW9uKHRyeWxhYmVsKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgdmFyIGxhYmVsO1xuICAgICAgICAgICAgc3RhdGUucHJvY2Vzc051bWJlcihmYWxzZSwgSXRlbSwgXCJudW1iZXJcIiwgSXRlbS50eXBlKTtcbiAgICAgICAgICAgIGlmICghc3RhdGUudG1wLnNoYWRvd19udW1iZXJzLm51bWJlci5sYWJlbCkge1xuICAgICAgICAgICAgICAgIGxhYmVsID0gXCJudW1iZXJcIjtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUudG1wLnNoYWRvd19udW1iZXJzLm51bWJlci5sYWJlbCA9PT0gXCJzdWIgdmVyYm9cIikge1xuICAgICAgICAgICAgICAgIGxhYmVsID0gXCJzdWItdmVyYm9cIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGFiZWwgPSBzdGF0ZS50bXAuc2hhZG93X251bWJlcnMubnVtYmVyLmxhYmVsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRyeWxhYmVsID09PSBsYWJlbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yICh2YXIgaT0wLGlsZW49dHJ5bGFiZWxzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QodHJ5bGFiZWxzW2ldKSk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGp1cmlzZGljdGlvblwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHRyeWp1cmlzZGljdGlvbnMgPSBhcmcuc3BsaXQoL1xccysvKTtcbiAgICBmb3IgKHZhciBpPTAsaWxlbj10cnlqdXJpc2RpY3Rpb25zLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICB0cnlqdXJpc2RpY3Rpb25zW2ldID0gdHJ5anVyaXNkaWN0aW9uc1tpXS5zcGxpdChcIjpcIik7XG4gICAgfVxuICAgIHZhciBtYWtldGVzdHMgPSBmdW5jdGlvbiAodHJ5anVyaXNkaWN0aW9uKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihJdGVtLGl0ZW0pe1xuICAgICAgICAgICAgaWYgKCFJdGVtLmp1cmlzZGljdGlvbikge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBqdXJpc2RpY3Rpb25zID0gSXRlbS5qdXJpc2RpY3Rpb24uc3BsaXQoXCI6XCIpO1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49anVyaXNkaWN0aW9ucy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgICAgICBqdXJpc2RpY3Rpb25zW2ldID0ganVyaXNkaWN0aW9uc1tpXS5zcGxpdChcIjpcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKGk9dHJ5anVyaXNkaWN0aW9uLmxlbmd0aDtpPjA7aSs9LTEpIHtcbiAgICAgICAgICAgICAgICB2YXIgdHJ5anVyaXNkaWN0aW9uU3RyID0gdHJ5anVyaXNkaWN0aW9uLnNsaWNlKDAsaSkuam9pbihcIjpcIik7XG4gICAgICAgICAgICAgICAgdmFyIGp1cmlzZGljdGlvbiA9IGp1cmlzZGljdGlvbnMuc2xpY2UoMCxpKS5qb2luKFwiOlwiKTtcbiAgICAgICAgICAgICAgICBpZiAodHJ5anVyaXNkaWN0aW9uU3RyICE9PSBqdXJpc2RpY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPXRyeWp1cmlzZGljdGlvbnMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgIHZhciB0cnlqdXJpc2RpY3Rpb25TbGljZSA9IHRyeWp1cmlzZGljdGlvbnNbaV0uc2xpY2UoKTtcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0cyh0cnlqdXJpc2RpY3Rpb25TbGljZSkpO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBjb250ZXh0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG5cdFx0dmFyIGFyZWEgPSBzdGF0ZS50bXAuYXJlYS5zbGljZSgwLCBhcmcubGVuZ3RoKTtcblx0XHRpZiAoYXJlYSA9PT0gYXJnKSB7XG5cdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHR9XG5cdFx0cmV0dXJuIGZhbHNlO1xuICAgIH07XG4gICAgdGhpcy50ZXN0cy5wdXNoKGZ1bmMpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGhhcy15ZWFyLW9ubHlcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciB0cnlkYXRlcyA9IGFyZy5zcGxpdCgvXFxzKy8pO1xuICAgIHZhciBtYWtldGVzdCA9IGZ1bmN0aW9uICh0cnlkYXRlKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihJdGVtLGl0ZW0pe1xuICAgICAgICAgICAgdmFyIGRhdGUgPSBJdGVtW3RyeWRhdGVdO1xuICAgICAgICAgICAgaWYgKCFkYXRlIHx8IGRhdGUubW9udGggfHwgZGF0ZS5zZWFzb24pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPXRyeWRhdGVzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QodHJ5ZGF0ZXNbaV0pKTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAaGFzLXRvLW1vbnRoLW9yLXNlYXNvblwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHRyeWRhdGVzID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24gKHRyeWRhdGUpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKEl0ZW0saXRlbSl7XG4gICAgICAgICAgICB2YXIgZGF0ZSA9IEl0ZW1bdHJ5ZGF0ZV07XG4gICAgICAgICAgICBpZiAoIWRhdGUgfHwgKCFkYXRlLm1vbnRoICYmICFkYXRlLnNlYXNvbikgfHwgZGF0ZS5kYXkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAodmFyIGk9MCxpbGVuPXRyeWRhdGVzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QodHJ5ZGF0ZXNbaV0pKTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAaGFzLWRheVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHRyeWRhdGVzID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24gKHRyeWRhdGUpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKEl0ZW0saXRlbSl7XG4gICAgICAgICAgICB2YXIgZGF0ZSA9IEl0ZW1bdHJ5ZGF0ZV07XG4gICAgICAgICAgICBpZiAoIWRhdGUgfHwgIWRhdGUuZGF5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHZhciBpPTAsaWxlbj10cnlkYXRlcy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0KHRyeWRhdGVzW2ldKSk7XG4gICAgfTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBzdWJqdXJpc2RpY3Rpb25zXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgdHJ5c3VianVyaXNkaWN0aW9ucyA9IHBhcnNlSW50KGFyZywgMTApO1xuICAgIHZhciBmdW5jID0gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgdmFyIHN1Ymp1cmlzZGljdGlvbnMgPSAwO1xuICAgICAgICBpZiAoSXRlbS5qdXJpc2RpY3Rpb24pIHtcbiAgICAgICAgICAgIHN1Ymp1cmlzZGljdGlvbnMgPSBJdGVtLmp1cmlzZGljdGlvbi5zcGxpdChcIjpcIikubGVuZ3RoO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdWJqdXJpc2RpY3Rpb25zKSB7XG4gICAgICAgICAgICBzdWJqdXJpc2RpY3Rpb25zICs9IC0xO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdWJqdXJpc2RpY3Rpb25zID49IHRyeXN1Ymp1cmlzZGljdGlvbnMpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9O1xuICAgIHRoaXMudGVzdHMucHVzaChmdW5jKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBpcy1wbHVyYWxcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciBmdW5jID0gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgdmFyIG5hbWVMaXN0ID0gSXRlbVthcmddO1xuICAgICAgICBpZiAobmFtZUxpc3QgJiYgbmFtZUxpc3QubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgcGVyc29ucyA9IDA7XG4gICAgICAgICAgICB2YXIgaW5zdGl0dXRpb25zID0gMDtcbiAgICAgICAgICAgIHZhciBsYXN0X2lzX3BlcnNvbiA9IGZhbHNlO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBuYW1lTGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3Bvb2ZfaW5zdGl0dXRpb25hbF9hZmZpbGlhdGlvbnNcbiAgICAgICAgICAgICAgICAgICAgJiYgKG5hbWVMaXN0W2ldLmxpdGVyYWwgfHwgKG5hbWVMaXN0W2ldLmlzSW5zdGl0dXRpb24gJiYgbmFtZUxpc3RbaV0uZmFtaWx5ICYmICFuYW1lTGlzdFtpXS5naXZlbikpKSB7XG4gICAgICAgICAgICAgICAgICAgIGluc3RpdHV0aW9ucyArPSAxO1xuICAgICAgICAgICAgICAgICAgICBsYXN0X2lzX3BlcnNvbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBlcnNvbnMgKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgbGFzdF9pc19wZXJzb24gPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwZXJzb25zID4gMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0aXR1dGlvbnMgPiAxKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RpdHV0aW9ucyAmJiBsYXN0X2lzX3BlcnNvbikge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9O1xuICAgIHRoaXMudGVzdHMucHVzaChmdW5jKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBsb2NhbGVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciBmdW5jLCByZXQsIGxlbiwgcG9zLCB2YXJpYWJsZSwgbXlpdGVtLCBsYW5nc3BlYywgbGFuZywgbHN0LCBpLCBpbGVuLCBmYWxsYmFjaztcbiAgICB2YXIgbG9jYWxlX2RlZmF1bHQgPSBzdGF0ZS5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXTtcbiAgICBpZiAodGhpcy5uYW1lID09PSBcImxheW91dFwiKSB7XG4gICAgICAgIHRoaXMubG9jYWxlX3JhdyA9IGFyZztcbiAgICAgICAgaWYgKHRoaXMudG9rZW50eXBlID09PSBDU0wuU1RBUlQpIHtcbiAgICAgICAgICAgIHZhciBsb2NhbGVzID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgICAgICAgICB2YXIgc29ydF9sb2NhbGUgPSB7fTtcbiAgICAgICAgICAgIHZhciBsb2NhbGVNYXN0ZXIgPSBDU0wubG9jYWxlUmVzb2x2ZShsb2NhbGVzWzBdLCBsb2NhbGVfZGVmYXVsdCk7XG4gICAgICAgICAgICBpZiAobG9jYWxlTWFzdGVyLmdlbmVyaWMpIHtcbiAgICAgICAgICAgICAgICBzb3J0X2xvY2FsZVtsb2NhbGVNYXN0ZXIuZ2VuZXJpY10gPSBsb2NhbGVNYXN0ZXIuYmVzdDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc29ydF9sb2NhbGVbbG9jYWxlTWFzdGVyLmJlc3RdID0gbG9jYWxlTWFzdGVyLmJlc3Q7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKHZhciBpPTEsaWxlbj1sb2NhbGVzLmxlbmd0aDtpPGlsZW47aSs9MSkge1xuICAgICAgICAgICAgICAgIHZhciBsb2NhbGVTZXJ2YW50ID0gQ1NMLmxvY2FsZVJlc29sdmUobG9jYWxlc1tpXSwgbG9jYWxlX2RlZmF1bHQpO1xuICAgICAgICAgICAgICAgIGlmIChsb2NhbGVTZXJ2YW50LmdlbmVyaWMpIHtcbiAgICAgICAgICAgICAgICAgICAgc29ydF9sb2NhbGVbbG9jYWxlU2VydmFudC5nZW5lcmljXSA9IGxvY2FsZU1hc3Rlci5iZXN0O1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNvcnRfbG9jYWxlW2xvY2FsZVNlcnZhbnQuYmVzdF0gPSBsb2NhbGVNYXN0ZXIuYmVzdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQuc29ydF9sb2NhbGVzLnB1c2goc29ydF9sb2NhbGUpO1xuICAgICAgICB9XG4gICAgICAgIHN0YXRlLm9wdC5oYXNfbGF5b3V0X2xvY2FsZSA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbHN0ID0gYXJnLnNwbGl0KC9cXHMrLyk7XG4gICAgICAgIHZhciBsb2NhbGVfYmFyZXMgPSBbXTtcbiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGxzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGxhbmcgPSBsc3RbaV07XG4gICAgICAgICAgICBsYW5nc3BlYyA9IENTTC5sb2NhbGVSZXNvbHZlKGxhbmcsIGxvY2FsZV9kZWZhdWx0KTtcbiAgICAgICAgICAgIGlmIChsc3RbaV0ubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgbG9jYWxlX2JhcmVzLnB1c2gobGFuZ3NwZWMuYmFyZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZS5sb2NhbGVDb25maWd1cmUobGFuZ3NwZWMsIHRydWUpO1xuICAgICAgICAgICAgbHN0W2ldID0gbGFuZ3NwZWM7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGxvY2FsZV9saXN0ID0gbHN0LnNsaWNlKCk7XG4gICAgICAgIHZhciBtYWtldGVzdCA9IGZ1bmN0aW9uIChsb2NhbGVfbGlzdCwgbG9jYWxlX2RlZmF1bHQsbG9jYWxlX2JhcmVzKSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICB2YXIga2V5LCByZXM7XG4gICAgICAgICAgICAgICAgcmV0ID0gW107XG4gICAgICAgICAgICAgICAgcmVzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIGxhbmdzcGVjID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIGxhbmc7XG4gICAgICAgICAgICAgICAgaWYgKCFJdGVtLmxhbmd1YWdlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhbmcgPSBsb2NhbGVfZGVmYXVsdDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsYW5nID0gSXRlbS5sYW5ndWFnZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGFuZ3NwZWMgPSBDU0wubG9jYWxlUmVzb2x2ZShsYW5nLCBsb2NhbGVfZGVmYXVsdCk7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGxvY2FsZV9saXN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAobGFuZ3NwZWMuYmVzdCA9PT0gbG9jYWxlX2xpc3RbaV0uYmVzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghcmVzICYmIGxvY2FsZV9iYXJlcy5pbmRleE9mKGxhbmdzcGVjLmJhcmUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRlc3RzLnB1c2gobWFrZXRlc3QobG9jYWxlX2xpc3QsbG9jYWxlX2RlZmF1bHQsbG9jYWxlX2JhcmVzKSk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGF1dGhvcml0eS1yZXNpZHVlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgbWFrZXRlc3QgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBzdWNjZWVkID0gKGFyZyA9PT0gXCJ0cnVlXCIpID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgaWYgKCFJdGVtLmF1dGhvcml0eSB8fCAhSXRlbS5hdXRob3JpdHlbMF0gfHwgIUl0ZW0uYXV0aG9yaXR5WzBdLmZhbWlseSkgcmV0dXJuICFzdWNjZWVkO1xuICAgICAgICAgICAgdmFyIHZhckxlbiA9IEl0ZW0uYXV0aG9yaXR5WzBdLmZhbWlseS5zcGxpdChcInxcIikubGVuZ3RoO1xuICAgICAgICAgICAgdmFyIHN0b3BMYXN0ID0gc3RhdGUudG1wLmF1dGhvcml0eV9zdG9wX2xhc3Q7XG4gICAgICAgICAgICBpZiAoKHZhckxlbiArIHN0b3BMYXN0KSA+IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3VjY2VlZDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICFzdWNjZWVkO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMudGVzdHMucHVzaChtYWtldGVzdCgpKTtcbn1cbkNTTC5BdHRyaWJ1dGVzW1wiQGxvY2FsZS1pbnRlcm5hbFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIGZ1bmMsIHJldCwgbGVuLCBwb3MsIHZhcmlhYmxlLCBteWl0ZW0sIGxhbmdzcGVjLCBsYW5nLCBsc3QsIGksIGlsZW4sIGZhbGxiYWNrO1xuICAgICAgICBsc3QgPSBhcmcuc3BsaXQoL1xccysvKTtcbiAgICAgICAgdGhpcy5sb2NhbGVfYmFyZXMgPSBbXTtcbiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGxzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGxhbmcgPSBsc3RbaV07XG4gICAgICAgICAgICBsYW5nc3BlYyA9IENTTC5sb2NhbGVSZXNvbHZlKGxhbmcsIHN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdKTtcbiAgICAgICAgICAgIGlmIChsc3RbaV0ubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVfYmFyZXMucHVzaChsYW5nc3BlYy5iYXJlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXRlLmxvY2FsZUNvbmZpZ3VyZShsYW5nc3BlYyk7XG4gICAgICAgICAgICBsc3RbaV0gPSBsYW5nc3BlYztcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxvY2FsZV9kZWZhdWx0ID0gc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF07XG4gICAgICAgIHRoaXMubG9jYWxlID0gbHN0WzBdLmJlc3Q7XG4gICAgICAgIHRoaXMubG9jYWxlX2xpc3QgPSBsc3Quc2xpY2UoKTtcbiAgICAgICAgdmFyIG1ha2V0ZXN0ID0gZnVuY3Rpb24gKG1lKSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICB2YXIga2V5LCByZXM7XG4gICAgICAgICAgICAgICAgcmV0ID0gW107XG4gICAgICAgICAgICAgICAgcmVzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIGxhbmdzcGVjID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKEl0ZW0ubGFuZ3VhZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgbGFuZyA9IEl0ZW0ubGFuZ3VhZ2U7XG4gICAgICAgICAgICAgICAgICAgIGxhbmdzcGVjID0gQ1NMLmxvY2FsZVJlc29sdmUobGFuZywgc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAobGFuZ3NwZWMuYmVzdCA9PT0gc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl1bMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhbmdzcGVjID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGxhbmdzcGVjKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBtZS5sb2NhbGVfbGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYW5nc3BlYy5iZXN0ID09PSBtZS5sb2NhbGVfbGlzdFtpXS5iZXN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3B0LmxhbmcgPSBtZS5sb2NhbGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmxhc3RfY2l0ZV9sb2NhbGUgPSBtZS5sb2NhbGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChcImVtcHR5XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCkubmV3X2xvY2FsZSA9IG1lLmxvY2FsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghcmVzICYmIG1lLmxvY2FsZV9iYXJlcy5pbmRleE9mKGxhbmdzcGVjLmJhcmUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm9wdC5sYW5nID0gbWUubG9jYWxlO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmxhc3RfY2l0ZV9sb2NhbGUgPSBtZS5sb2NhbGU7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQub3BlbkxldmVsKFwiZW1wdHlcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLm5ld19sb2NhbGUgPSBtZS5sb2NhbGU7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiByZXM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1lID0gdGhpcztcbiAgICAgICAgdGhpcy50ZXN0cy5wdXNoKG1ha2V0ZXN0KG1lKSk7XG59XG5DU0wuQXR0cmlidXRlc1tcIkBpcy1wYXJhbGxlbFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHZhbHVlcyA9IGFyZy5zcGxpdChcIiBcIik7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB2YWx1ZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGlmICh2YWx1ZXNbaV0gPT09IFwidHJ1ZVwiKSB7XG4gICAgICAgICAgICB2YWx1ZXNbaV0gPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlc1tpXSA9PT0gXCJmYWxzZVwiKSB7XG4gICAgICAgICAgICB2YWx1ZXNbaV0gPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnN0cmluZ3Muc2V0X3BhcmFsbGVsX2NvbmRpdGlvbiA9IHZhbHVlcztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBqdXJpc2RpY3Rpb24tZGVwdGhcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5ncy5qdXJpc2RpY3Rpb25fZGVwdGggPSBwYXJzZUludChhcmcsIDEwKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkByZXF1aXJlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3MucmVxdWlyZSA9IGFyZztcbn1cbkNTTC5BdHRyaWJ1dGVzW1wiQHJlamVjdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzLnJlamVjdCA9IGFyZztcbn1cbkNTTC5BdHRyaWJ1dGVzW1wiQGdlbmRlclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5nZW5kZXIgPSBhcmc7XG59XG5DU0wuQXR0cmlidXRlc1tcIkBjc2xpZFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5jc2xpZCA9IHBhcnNlSW50KGFyZywgMTApO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGxhYmVsLWZvcm1cIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5ncy5sYWJlbF9mb3JtX292ZXJyaWRlID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHBhcnQtc2VwYXJhdG9yXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJwYXJ0LXNlcGFyYXRvclwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBsZWFkaW5nLW5vaXNlLXdvcmRzXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzW1wibGVhZGluZy1ub2lzZS13b3Jkc1wiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuYW1lLW5ldmVyLXNob3J0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzW1wibmFtZS1uZXZlci1zaG9ydFwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBjbGFzc1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGUub3B0W1wiY2xhc3NcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAdmVyc2lvblwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGUub3B0LnZlcnNpb24gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAdmFsdWVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5ncy52YWx1ZSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuYW1lXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3MubmFtZSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBmb3JtXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3MuZm9ybSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBkYXRlLXBhcnRzXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJkYXRlLXBhcnRzXCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHJhbmdlLWRlbGltaXRlclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1wicmFuZ2UtZGVsaW1pdGVyXCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQG1hY3JvXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnBvc3Rwb25lZF9tYWNybyA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkB0ZXJtXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoYXJnID09PSBcInN1YiB2ZXJib1wiKSB7XG4gICAgICAgIHRoaXMuc3RyaW5ncy50ZXJtID0gXCJzdWItdmVyYm9cIjtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnN0cmluZ3MudGVybSA9IGFyZztcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAeG1sbnNcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge307XG5DU0wuQXR0cmlidXRlc1tcIkBsYW5nXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoYXJnKSB7XG4gICAgICAgIHN0YXRlLmJ1aWxkLmxhbmcgPSBhcmc7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGxpbmdvXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBtYWNyby1oYXMtZGF0ZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpc1tcIm1hY3JvLWhhcy1kYXRlXCJdID0gdHJ1ZTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBzdWZmaXhcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5ncy5zdWZmaXggPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAcHJlZml4XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3MucHJlZml4ID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGRlbGltaXRlclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzLmRlbGltaXRlciA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBtYXRjaFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5tYXRjaCA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuYW1lcy1taW5cIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciB2YWwgPSBwYXJzZUludChhcmcsIDEwKTtcbiAgICBpZiAoc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0Lm1heF9udW1iZXJfb2ZfbmFtZXMgPCB2YWwpIHtcbiAgICAgICAgc3RhdGVbc3RhdGUuYnVpbGQuYXJlYV0ub3B0Lm1heF9udW1iZXJfb2ZfbmFtZXMgPSB2YWw7XG4gICAgfVxuICAgIHRoaXMuc3RyaW5nc1tcImV0LWFsLW1pblwiXSA9IHZhbDtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuYW1lcy11c2UtZmlyc3RcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5nc1tcImV0LWFsLXVzZS1maXJzdFwiXSA9IHBhcnNlSW50KGFyZywgMTApO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQG5hbWVzLXVzZS1sYXN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoYXJnID09PSBcInRydWVcIikge1xuICAgICAgICB0aGlzLnN0cmluZ3NbXCJldC1hbC11c2UtbGFzdFwiXSA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzW1wiZXQtYWwtdXNlLWxhc3RcIl0gPSBmYWxzZTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc29ydFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJkZXNjZW5kaW5nXCIpIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzLnNvcnRfZGlyZWN0aW9uID0gQ1NMLkRFU0NFTkRJTkc7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHBsdXJhbFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKFwiYWx3YXlzXCIgPT09IGFyZyB8fCBcInRydWVcIiA9PT0gYXJnKSB7XG4gICAgICAgIHRoaXMuc3RyaW5ncy5wbHVyYWwgPSAxO1xuICAgIH0gZWxzZSBpZiAoXCJuZXZlclwiID09PSBhcmcgfHwgXCJmYWxzZVwiID09PSBhcmcpIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzLnBsdXJhbCA9IDA7XG4gICAgfSBlbHNlIGlmIChcImNvbnRleHR1YWxcIiA9PT0gYXJnKSB7XG4gICAgICAgIHRoaXMuc3RyaW5ncy5wbHVyYWwgPSBmYWxzZTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAaGFzLXB1Ymxpc2hlci1hbmQtcHVibGlzaGVyLXBsYWNlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJoYXMtcHVibGlzaGVyLWFuZC1wdWJsaXNoZXItcGxhY2VcIl0gPSB0cnVlO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHB1Ymxpc2hlci1kZWxpbWl0ZXItcHJlY2VkZXMtbGFzdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1wicHVibGlzaGVyLWRlbGltaXRlci1wcmVjZWRlcy1sYXN0XCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHB1Ymxpc2hlci1kZWxpbWl0ZXJcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5nc1tcInB1Ymxpc2hlci1kZWxpbWl0ZXJcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAcHVibGlzaGVyLWFuZFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1wicHVibGlzaGVyLWFuZFwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuZXdkYXRlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBnaXZlbm5hbWUtZGlzYW1iaWd1YXRpb24tcnVsZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKENTTC5HSVZFTk5BTUVfRElTQU1CSUdVQVRJT05fUlVMRVMuaW5kZXhPZihhcmcpID4gLTEpIHtcbiAgICAgICAgc3RhdGUuY2l0YXRpb24ub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl0gPSBhcmc7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGNvbGxhcHNlXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoYXJnKSB7XG4gICAgICAgIHN0YXRlW3RoaXMubmFtZV0ub3B0LmNvbGxhcHNlID0gYXJnO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBjaXRlLWdyb3VwLWRlbGltaXRlclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZykge1xuICAgICAgICBzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0LmNpdGVfZ3JvdXBfZGVsaW1pdGVyID0gYXJnO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBuYW1lcy1kZWxpbWl0ZXJcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlLnNldE9wdCh0aGlzLCBcIm5hbWVzLWRlbGltaXRlclwiLCBhcmcpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQG5hbWUtZm9ybVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwibmFtZS1mb3JtXCIsIGFyZyk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc3ViZ3JvdXAtZGVsaW1pdGVyXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJzdWJncm91cC1kZWxpbWl0ZXJcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc3ViZ3JvdXAtZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5nc1tcInN1Ymdyb3VwLWRlbGltaXRlci1wcmVjZWRlcy1sYXN0XCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQG5hbWUtZGVsaW1pdGVyXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJuYW1lLWRlbGltaXRlclwiLCBhcmcpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGV0LWFsLW1pblwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIHZhbCA9IHBhcnNlSW50KGFyZywgMTApO1xuICAgIGlmIChzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQubWF4X251bWJlcl9vZl9uYW1lcyA8IHZhbCkge1xuICAgICAgICBzdGF0ZVtzdGF0ZS5idWlsZC5hcmVhXS5vcHQubWF4X251bWJlcl9vZl9uYW1lcyA9IHZhbDtcbiAgICB9XG4gICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwiZXQtYWwtbWluXCIsIHZhbCk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZXQtYWwtdXNlLWZpcnN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJldC1hbC11c2UtZmlyc3RcIiwgcGFyc2VJbnQoYXJnLCAxMCkpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGV0LWFsLXVzZS1sYXN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoYXJnID09PSBcInRydWVcIikge1xuICAgICAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJldC1hbC11c2UtbGFzdFwiLCB0cnVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJldC1hbC11c2UtbGFzdFwiLCBmYWxzZSk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGV0LWFsLXN1YnNlcXVlbnQtbWluXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB2YXIgdmFsID0gcGFyc2VJbnQoYXJnLCAxMCk7XG4gICAgaWYgKHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzIDwgdmFsKSB7XG4gICAgICAgIHN0YXRlW3N0YXRlLmJ1aWxkLmFyZWFdLm9wdC5tYXhfbnVtYmVyX29mX25hbWVzID0gdmFsO1xuICAgIH1cbiAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJldC1hbC1zdWJzZXF1ZW50LW1pblwiLCB2YWwpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGV0LWFsLXN1YnNlcXVlbnQtdXNlLWZpcnN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJldC1hbC1zdWJzZXF1ZW50LXVzZS1maXJzdFwiLCBwYXJzZUludChhcmcsIDEwKSk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc3VwcHJlc3MtbWluXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJzdXBwcmVzcy1taW5cIl0gPSBwYXJzZUludChhcmcsIDEwKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBzdXBwcmVzcy1tYXhcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5nc1tcInN1cHByZXNzLW1heFwiXSA9IHBhcnNlSW50KGFyZywgMTApO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGFuZFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGUuc2V0T3B0KHRoaXMsIFwiYW5kXCIsIGFyZyk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZGVsaW1pdGVyLXByZWNlZGVzLWxhc3RcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlLnNldE9wdCh0aGlzLCBcImRlbGltaXRlci1wcmVjZWRlcy1sYXN0XCIsIGFyZyk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZGVsaW1pdGVyLXByZWNlZGVzLWV0LWFsXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJkZWxpbWl0ZXItcHJlY2VkZXMtZXQtYWxcIiwgYXJnKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBpbml0aWFsaXplLXdpdGhcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlLnNldE9wdCh0aGlzLCBcImluaXRpYWxpemUtd2l0aFwiLCBhcmcpO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGluaXRpYWxpemVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChhcmcgPT09IFwiZmFsc2VcIikge1xuICAgICAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJpbml0aWFsaXplXCIsIGZhbHNlKTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAbmFtZS1hcy1yZXZlcnNlLW9yZGVyXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzW1wibmFtZS1hcy1yZXZlcnNlLW9yZGVyXCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQG5hbWUtYXMtc29ydC1vcmRlclwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKHRoaXMubmFtZSA9PT0gXCJzdHlsZS1vcHRpb25zXCIpIHtcbiAgICAgICAgdGhpc1tcIm5hbWUtYXMtc29ydC1vcmRlclwiXSA9IGFyZztcbiAgICB9IGVsc2Uge1xuICAgICAgICBzdGF0ZS5zZXRPcHQodGhpcywgXCJuYW1lLWFzLXNvcnQtb3JkZXJcIiwgYXJnKTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc29ydC1zZXBhcmF0b3JcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlLnNldE9wdCh0aGlzLCBcInNvcnQtc2VwYXJhdG9yXCIsIGFyZyk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAeWVhci1zdWZmaXgtZGVsaW1pdGVyXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZVt0aGlzLm5hbWVdLm9wdFtcInllYXItc3VmZml4LWRlbGltaXRlclwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBhZnRlci1jb2xsYXBzZS1kZWxpbWl0ZXJcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlW3RoaXMubmFtZV0ub3B0W1wiYWZ0ZXItY29sbGFwc2UtZGVsaW1pdGVyXCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHN1YnNlcXVlbnQtYXV0aG9yLXN1YnN0aXR1dGVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlW3RoaXMubmFtZV0ub3B0W1wic3Vic2VxdWVudC1hdXRob3Itc3Vic3RpdHV0ZVwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBzdWJzZXF1ZW50LWF1dGhvci1zdWJzdGl0dXRlLXJ1bGVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlW3RoaXMubmFtZV0ub3B0W1wic3Vic2VxdWVudC1hdXRob3Itc3Vic3RpdHV0ZS1ydWxlXCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGRpc2FtYmlndWF0ZS1hZGQtbmFtZXNcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChhcmcgPT09IFwidHJ1ZVwiKSB7XG4gICAgICAgIHN0YXRlLm9wdFtcImRpc2FtYmlndWF0ZS1hZGQtbmFtZXNcIl0gPSB0cnVlO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBkaXNhbWJpZ3VhdGUtYWRkLWdpdmVubmFtZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgc3RhdGUub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC1naXZlbm5hbWVcIl0gPSB0cnVlO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBkaXNhbWJpZ3VhdGUtYWRkLXllYXItc3VmZml4XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoYXJnID09PSBcInRydWVcIiAmJiBzdGF0ZS5vcHQueGNsYXNzICE9PSBcIm51bWVyaWNcIikge1xuICAgICAgICBzdGF0ZS5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLXllYXItc3VmZml4XCJdID0gdHJ1ZTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc2Vjb25kLWZpZWxkLWFsaWduXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoYXJnID09PSBcImZsdXNoXCIgfHwgYXJnID09PSBcIm1hcmdpblwiKSB7XG4gICAgICAgIHN0YXRlW3RoaXMubmFtZV0ub3B0W1wic2Vjb25kLWZpZWxkLWFsaWduXCJdID0gYXJnO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBoYW5naW5nLWluZGVudFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgc3RhdGVbdGhpcy5uYW1lXS5vcHQuaGFuZ2luZ2luZGVudCA9IDI7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGxpbmUtc3BhY2luZ1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyAmJiBhcmcubWF0Y2goL15bLjAtOV0rJC8pKSB7XG4gICAgICAgIHN0YXRlW3RoaXMubmFtZV0ub3B0W1wibGluZS1zcGFjaW5nXCJdID0gcGFyc2VGbG9hdChhcmcsIDEwKTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZW50cnktc3BhY2luZ1wiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyAmJiBhcmcubWF0Y2goL15bLjAtOV0rJC8pKSB7XG4gICAgICAgIHN0YXRlW3RoaXMubmFtZV0ub3B0W1wiZW50cnktc3BhY2luZ1wiXSA9IHBhcnNlRmxvYXQoYXJnLCAxMCk7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQG5lYXItbm90ZS1kaXN0YW5jZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgc3RhdGVbdGhpcy5uYW1lXS5vcHRbXCJuZWFyLW5vdGUtZGlzdGFuY2VcIl0gPSBwYXJzZUludChhcmcsIDEwKTtcbn07XG5DU0wuQXR0cmlidXRlc1tcIkB0ZXh0LWNhc2VcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHZhciBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgIGlmIChhcmcgPT09IFwibm9ybWFsXCIpIHtcbiAgICAgICAgICAgIHRoaXMudGV4dF9jYXNlX25vcm1hbCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0gPSBhcmc7XG4gICAgICAgICAgICBpZiAoYXJnID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgICAgICB2YXIgbSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciBkZWZhdWx0X2xvY2FsZSA9IHN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdLnNsaWNlKDAsIDIpO1xuICAgICAgICAgICAgICAgIGlmIChJdGVtLmp1cmlzZGljdGlvbikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0gPSBcInBhc3N0aHJvdWdoXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAcGFnZS1yYW5nZS1mb3JtYXRcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlLm9wdFtcInBhZ2UtcmFuZ2UtZm9ybWF0XCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHllYXItcmFuZ2UtZm9ybWF0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBzdGF0ZS5vcHRbXCJ5ZWFyLXJhbmdlLWZvcm1hdFwiXSA9IGFyZztcbn07XG5DU0wuQXR0cmlidXRlc1tcIkBkZWZhdWx0LWxvY2FsZVwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKHRoaXMubmFtZSA9PT0gJ3N0eWxlJykge1xuICAgICAgICB2YXIgbHN0LCBsZW4sIHBvcywgbSwgcmV0O1xuICAgICAgICB2YXIgbSA9IGFyZy5tYXRjaCgvLXgtKHNvcnR8dHJhbnNsaXR8dHJhbnNsYXQpLS9nKTtcbiAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgIGZvciAocG9zID0gMCwgbGVuID0gbS5sZW5ndGg7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgICAgICBtW3Bvc10gPSBtW3Bvc10ucmVwbGFjZSgvXi14LS8sIFwiXCIpLnJlcGxhY2UoLy0kLywgXCJcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbHN0ID0gYXJnLnNwbGl0KC8teC0oPzpzb3J0fHRyYW5zbGl0fHRyYW5zbGF0KS0vKTtcbiAgICAgICAgcmV0ID0gW2xzdFswXV07XG4gICAgICAgIGZvciAocG9zID0gMSwgbGVuID0gbHN0Lmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgcmV0LnB1c2gobVtwb3MgLSAxXSk7XG4gICAgICAgICAgICByZXQucHVzaChsc3RbcG9zXSk7XG4gICAgICAgIH1cbiAgICAgICAgbHN0ID0gcmV0LnNsaWNlKCk7XG4gICAgICAgIGxlbiA9IGxzdC5sZW5ndGg7XG4gICAgICAgIGZvciAocG9zID0gMTsgcG9zIDwgbGVuOyBwb3MgKz0gMikge1xuICAgICAgICAgICAgc3RhdGUub3B0WyhcImxvY2FsZS1cIiArIGxzdFtwb3NdKV0ucHVzaChsc3RbKHBvcyArIDEpXS5yZXBsYWNlKC9eXFxzKi9nLCBcIlwiKS5yZXBsYWNlKC9cXHMqJC9nLCBcIlwiKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxzdC5sZW5ndGgpIHtcbiAgICAgICAgICAgIHN0YXRlLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdID0gbHN0LnNsaWNlKDAsIDEpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RhdGUub3B0W1wiZGVmYXVsdC1sb2NhbGVcIl0gPSBbXCJlblwiXTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSBpZiAoYXJnID09PSBcInRydWVcIikge1xuICAgICAgICB0aGlzLmRlZmF1bHRfbG9jYWxlID0gdHJ1ZTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAZGVmYXVsdC1sb2NhbGUtc29ydFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdmFyIGxzdCwgbGVuLCBwb3MsIG0sIHJldDtcbiAgICBzdGF0ZS5vcHRbXCJkZWZhdWx0LWxvY2FsZS1zb3J0XCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGRlbW90ZS1ub24tZHJvcHBpbmctcGFydGljbGVcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHN0YXRlLm9wdFtcImRlbW90ZS1ub24tZHJvcHBpbmctcGFydGljbGVcIl0gPSBhcmc7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAaW5pdGlhbGl6ZS13aXRoLWh5cGhlblwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgaWYgKGFyZyA9PT0gXCJmYWxzZVwiKSB7XG4gICAgICAgIHN0YXRlLm9wdFtcImluaXRpYWxpemUtd2l0aC1oeXBoZW5cIl0gPSBmYWxzZTtcbiAgICB9XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAaW5zdGl0dXRpb24tcGFydHNcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIHRoaXMuc3RyaW5nc1tcImluc3RpdHV0aW9uLXBhcnRzXCJdID0gYXJnO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQGlmLXNob3J0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoYXJnID09PSBcInRydWVcIikge1xuICAgICAgICB0aGlzLnN0cmluZ3NbXCJpZi1zaG9ydFwiXSA9IHRydWU7XG4gICAgfVxufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHN1YnN0aXR1dGUtdXNlLWZpcnN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJzdWJzdGl0dXRlLXVzZS1maXJzdFwiXSA9IHBhcnNlSW50KGFyZywgMTApO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHVzZS1maXJzdFwiXSA9IGZ1bmN0aW9uIChzdGF0ZSwgYXJnKSB7XG4gICAgdGhpcy5zdHJpbmdzW1widXNlLWZpcnN0XCJdID0gcGFyc2VJbnQoYXJnLCAxMCk7XG59O1xuQ1NMLkF0dHJpYnV0ZXNbXCJAc3RvcC1sYXN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJzdG9wLWxhc3RcIl0gPSBwYXJzZUludChhcmcsIDEwKSAqIC0xO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHVzZS1sYXN0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICB0aGlzLnN0cmluZ3NbXCJ1c2UtbGFzdFwiXSA9IHBhcnNlSW50KGFyZywgMTApO1xufTtcbkNTTC5BdHRyaWJ1dGVzW1wiQHJldmVyc2Utb3JkZXJcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIGFyZykge1xuICAgIGlmIChcInRydWVcIiA9PT0gYXJnKSB7XG4gICAgICAgIHRoaXMuc3RyaW5nc1tcInJldmVyc2Utb3JkZXJcIl0gPSB0cnVlO1xuICAgIH1cbn07XG5DU0wuQXR0cmlidXRlc1tcIkBkaXNwbGF5XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBhcmcpIHtcbiAgICBpZiAoc3RhdGUuYmlibGlvZ3JhcGh5LnRva2Vucy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgc3RhdGUub3B0LnVzaW5nX2Rpc3BsYXkgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLnN0cmluZ3MuY2xzID0gYXJnO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlN0YWNrID0gZnVuY3Rpb24gKHZhbCwgbGl0ZXJhbCkge1xuICAgIHRoaXMubXlzdGFjayA9IFtdO1xuICAgIGlmIChsaXRlcmFsIHx8IHZhbCkge1xuICAgICAgICB0aGlzLm15c3RhY2sucHVzaCh2YWwpO1xuICAgIH1cbiAgICB0aGlzLnRpcCA9IHRoaXMubXlzdGFja1swXTtcbn07XG5DU0wuU3RhY2sucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiAodmFsLCBsaXRlcmFsKSB7XG4gICAgaWYgKGxpdGVyYWwgfHwgdmFsKSB7XG4gICAgICAgIHRoaXMubXlzdGFjay5wdXNoKHZhbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5teXN0YWNrLnB1c2goXCJcIik7XG4gICAgfVxuICAgIHRoaXMudGlwID0gdGhpcy5teXN0YWNrW3RoaXMubXlzdGFjay5sZW5ndGggLSAxXTtcbn07XG5DU0wuU3RhY2sucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMubXlzdGFjayA9IFtdO1xuICAgIHRoaXMudGlwID0ge307XG59O1xuQ1NMLlN0YWNrLnByb3RvdHlwZS5yZXBsYWNlID0gZnVuY3Rpb24gKHZhbCwgbGl0ZXJhbCkge1xuICAgIGlmICh0aGlzLm15c3RhY2subGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IFwiSW50ZXJuYWwgQ1NMIHByb2Nlc3NvciBlcnJvcjogYXR0ZW1wdCB0byByZXBsYWNlIG5vbmV4aXN0ZW50IHN0YWNrIGl0ZW0gd2l0aCBcIiArIHZhbDtcbiAgICB9XG4gICAgaWYgKGxpdGVyYWwgfHwgdmFsKSB7XG4gICAgICAgIHRoaXMubXlzdGFja1sodGhpcy5teXN0YWNrLmxlbmd0aCAtIDEpXSA9IHZhbDtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLm15c3RhY2tbKHRoaXMubXlzdGFjay5sZW5ndGggLSAxKV0gPSBcIlwiO1xuICAgIH1cbiAgICB0aGlzLnRpcCA9IHRoaXMubXlzdGFja1t0aGlzLm15c3RhY2subGVuZ3RoIC0gMV07XG59O1xuQ1NMLlN0YWNrLnByb3RvdHlwZS5wb3AgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHJldCA9IHRoaXMubXlzdGFjay5wb3AoKTtcbiAgICBpZiAodGhpcy5teXN0YWNrLmxlbmd0aCkge1xuICAgICAgICB0aGlzLnRpcCA9IHRoaXMubXlzdGFja1t0aGlzLm15c3RhY2subGVuZ3RoIC0gMV07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy50aXAgPSB7fTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuU3RhY2sucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLm15c3RhY2suc2xpY2UoLTEpWzBdO1xufTtcbkNTTC5TdGFjay5wcm90b3R5cGUubGVuZ3RoID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLm15c3RhY2subGVuZ3RoO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlBhcmFsbGVsID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xuICAgIHRoaXMuc2V0cyA9IG5ldyBDU0wuU3RhY2soW10pO1xuICAgIHRoaXMudHJ5X2NpdGUgPSB0cnVlO1xuICAgIHRoaXMudXNlX3BhcmFsbGVscyA9IGZhbHNlO1xuICAgIHRoaXMubWlkVmFycyA9IFtcInNlY3Rpb25cIiwgXCJ2b2x1bWVcIiwgXCJjb250YWluZXItdGl0bGVcIiwgXCJjb2xsZWN0aW9uLW51bWJlclwiLCBcImlzc3VlXCIsIFwicGFnZS1maXJzdFwiLCBcInBhZ2VcIiwgXCJudW1iZXJcIl07XG4gICAgdGhpcy5pZ25vcmVWYXJzTGF3R2VuZXJhbCA9IFtcImZpcnN0LXJlZmVyZW5jZS1ub3RlLW51bWJlclwiLCBcImxvY2F0b3JcIiwgXCJsYWJlbFwiLFwicGFnZS1maXJzdFwiLFwicGFnZVwiLFwiZ2VucmVcIl07XG4gICAgdGhpcy5pZ25vcmVWYXJzTGF3UHJvY2VkdXJhbEhpc3RvcnkgPSBbXCJpc3N1ZWRcIiwgXCJmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXJcIiwgXCJsb2NhdG9yXCIsIFwibGFiZWxcIixcInBhZ2UtZmlyc3RcIixcInBhZ2VcIixcImdlbnJlXCIsXCJqdXJpc2RpY3Rpb25cIl07XG4gICAgdGhpcy5pZ25vcmVWYXJzT3JkZXJzID0gW1wiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCJdO1xuICAgIHRoaXMuaWdub3JlVmFyc090aGVyID0gW1wiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCIsIFwibG9jYXRvclwiLCBcImxhYmVsXCIsXCJzZWN0aW9uXCIsXCJwYWdlLWZpcnN0XCIsXCJwYWdlXCJdO1xufTtcbkNTTC5QYXJhbGxlbC5wcm90b3R5cGUuaXNNaWQgPSBmdW5jdGlvbiAodmFyaWFibGUpIHtcbiAgICByZXR1cm4gKHRoaXMubWlkVmFycy5pbmRleE9mKHZhcmlhYmxlKSA+IC0xKTtcbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLlN0YXJ0Q2l0YXRpb24gPSBmdW5jdGlvbiAoc29ydGVkSXRlbXMsIG91dCkge1xuICAgIHRoaXMucGFyYWxsZWxfY29uZGl0aW9uYWxfYmxvYnNfbGlzdCA9IFtdO1xuICAgIGlmICh0aGlzLnVzZV9wYXJhbGxlbHMpIHtcbiAgICAgICAgdGhpcy5zb3J0ZWRJdGVtcyA9IHNvcnRlZEl0ZW1zO1xuICAgICAgICB0aGlzLnNvcnRlZEl0ZW1zUG9zID0gLTE7XG4gICAgICAgIHRoaXMuc2V0cy5jbGVhcigpO1xuICAgICAgICB0aGlzLnNldHMucHVzaChbXSk7XG4gICAgICAgIHRoaXMuaW5fc2VyaWVzID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5kZWxpbV9jb3VudGVyID0gMDtcbiAgICAgICAgdGhpcy5kZWxpbV9wb2ludGVycyA9IFtdO1xuICAgICAgICBpZiAob3V0KSB7XG4gICAgICAgICAgICB0aGlzLm91dCA9IG91dDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMub3V0ID0gdGhpcy5zdGF0ZS5vdXRwdXQucXVldWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tYXN0ZXJfd2FzX25ldXRyYWxfY2l0ZSA9IHRydWU7XG4gICAgfVxufTtcbkNTTC5QYXJhbGxlbC5wcm90b3R5cGUuU3RhcnRDaXRlID0gZnVuY3Rpb24gKEl0ZW0sIGl0ZW0sIHByZXZJdGVtSUQpIHtcbiAgICB2YXIgcG9zaXRpb24sIGxlbiwgcG9zLCB4LCBjdXJyLCBtYXN0ZXIsIGxhc3RfaWQsIHByZXZfbG9jYXRvciwgY3Vycl9sb2NhdG9yLCBpc19tYXN0ZXIsIHBhcmFsbGVsO1xuICAgIGlmICh0aGlzLnVzZV9wYXJhbGxlbHMpIHtcbiAgICAgICAgaWYgKHRoaXMuc2V0cy52YWx1ZSgpLmxlbmd0aCAmJiB0aGlzLnNldHMudmFsdWUoKVswXS5pdGVtSWQgPT0gSXRlbS5pZCkge1xuICAgICAgICAgICAgdGhpcy5Db21wb3NlU2V0KCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zb3J0ZWRJdGVtc1BvcyArPSAxO1xuICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgcG9zaXRpb24gPSBpdGVtLnBvc2l0aW9uO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudHJ5X2NpdGUgPSB0cnVlO1xuICAgICAgICB2YXIgaGFzX3JlcXVpcmVkX3ZhciA9IGZhbHNlO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IENTTC5QQVJBTExFTF9NQVRDSF9WQVJTLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgaWYgKEl0ZW1bQ1NMLlBBUkFMTEVMX01BVENIX1ZBUlNbaV1dKSB7XG4gICAgICAgICAgICAgICAgaGFzX3JlcXVpcmVkX3ZhciA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGJhc2ljc19vayA9IHRydWU7XG4gICAgICAgIHZhciBsYXN0X2NpdGUgPSB0aGlzLnNldHMudmFsdWUoKS5zbGljZSgtMSlbMF07XG4gICAgICAgIGlmIChsYXN0X2NpdGUgJiYgbGFzdF9jaXRlLkl0ZW0pIHtcbiAgICAgICAgICAgIHZhciBsYXN0SnVyaXMgPSBsYXN0X2NpdGUuSXRlbS5qdXJpc2RpY3Rpb24gPyBsYXN0X2NpdGUuSXRlbS5qdXJpc2RpY3Rpb24uc3BsaXQoXCI6XCIpWzBdIDogXCJcIjtcbiAgICAgICAgICAgIHZhciB0aGlzSnVyaXMgPSBJdGVtLmp1cmlzZGljdGlvbiA/IEl0ZW0uanVyaXNkaWN0aW9uLnNwbGl0KFwiOlwiKVswXSA6IFwiXCI7XG4gICAgICAgICAgICBpZiAobGFzdF9jaXRlLkl0ZW0udGl0bGUgIT09IEl0ZW0udGl0bGUpIHtcbiAgICAgICAgICAgICAgICBiYXNpY3Nfb2sgPSBmYWxzZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobGFzdEp1cmlzICE9PSB0aGlzSnVyaXMpIHtcbiAgICAgICAgICAgICAgICBiYXNpY3Nfb2sgPSBmYWxzZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobGFzdF9jaXRlLkl0ZW0udHlwZSAhPT0gSXRlbS50eXBlKSB7XG4gICAgICAgICAgICAgICAgYmFzaWNzX29rID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKFtcImFydGljbGUtam91cm5hbFwiLFwiYXJ0aWNsZS1tYWdhemluZVwiXS5pbmRleE9mKEl0ZW0udHlwZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5zdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5oYW5kbGVfcGFyYWxsZWxfYXJ0aWNsZXNcbiAgICAgICAgICAgICAgICAgICB8fCBsYXN0X2NpdGUuSXRlbVtcImNvbnRhaW5lci10aXRsZVwiXSAhPT0gSXRlbVtcImNvbnRhaW5lci10aXRsZVwiXSkge1xuICAgICAgICAgICAgICAgICAgICBiYXNpY3Nfb2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFiYXNpY3Nfb2sgfHwgIWhhc19yZXF1aXJlZF92YXIgfHwgQ1NMLlBBUkFMTEVMX1RZUEVTLmluZGV4T2YoSXRlbS50eXBlKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIHRoaXMudHJ5X2NpdGUgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHRoaXMuaW5fc2VyaWVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbl9zZXJpZXMgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNpdGUgPSB7fTtcbiAgICAgICAgdGhpcy5jaXRlLmZyb250ID0gW107XG4gICAgICAgIHRoaXMuY2l0ZS5taWQgPSBbXTtcbiAgICAgICAgdGhpcy5jaXRlLmJhY2sgPSBbXTtcbiAgICAgICAgdGhpcy5jaXRlLmZyb250X2NvbGxhcHNlID0ge307XG4gICAgICAgIHRoaXMuY2l0ZS5iYWNrX2ZvcmNlbWUgPSBbXTtcbiAgICAgICAgdGhpcy5jaXRlLnBvc2l0aW9uID0gcG9zaXRpb247XG4gICAgICAgIHRoaXMuY2l0ZS5JdGVtID0gSXRlbTtcbiAgICAgICAgdGhpcy5jaXRlLml0ZW1JZCA9IFwiXCIgKyBJdGVtLmlkO1xuICAgICAgICB0aGlzLmNpdGUucHJldkl0ZW1JRCA9IFwiXCIgKyBwcmV2SXRlbUlEO1xuICAgICAgICB0aGlzLnRhcmdldCA9IFwiZnJvbnRcIjtcbiAgICAgICAgaWYgKFtcInRyZWF0eVwiXS5pbmRleE9mKEl0ZW0udHlwZSkgPiAtMSkge1xuICAgICAgICAgICAgdGhpcy5pZ25vcmVWYXJzID0gdGhpcy5pZ25vcmVWYXJzT3JkZXJzO1xuICAgICAgICB9IGVsc2UgaWYgKFtcImFydGljbGUtam91cm5hbFwiLFwiYXJ0aWNsZS1tYWdhemluZVwiXS5pbmRleE9mKEl0ZW0udHlwZSkgPiAtMSkge1xuICAgICAgICAgICAgdGhpcy5pZ25vcmVWYXJzID0gdGhpcy5pZ25vcmVWYXJzT3RoZXI7XG4gICAgICAgIH0gZWxzZSBpZiAoaXRlbSAmJiBpdGVtLnByZWZpeCkge1xuICAgICAgICAgICAgdGhpcy5pZ25vcmVWYXJzID0gdGhpcy5pZ25vcmVWYXJzTGF3UHJvY2VkdXJhbEhpc3Rvcnk7XG4gICAgICAgICAgICB0aGlzLmNpdGUudXNlUHJvY2VkdXJhbEhpc3RvcnkgPSB0cnVlO1xuICAgICAgICAgICAgdmFyIHByZXYgPSB0aGlzLnNldHMudmFsdWUoKVsodGhpcy5zZXRzLnZhbHVlKCkubGVuZ3RoIC0gMSldO1xuICAgICAgICAgICAgaWYgKHByZXYgJiYgcHJldi5iYWNrKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaT1wcmV2LmJhY2subGVuZ3RoLTE7aT4tMTtpKz0tMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJldi5iYWNrW2ldICYmIHByZXZbcHJldi5iYWNrW2ldXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHByZXZbcHJldi5iYWNrW2ldXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuaWdub3JlVmFycyA9IHRoaXMuaWdub3JlVmFyc0xhd0dlbmVyYWw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuc29ydGVkSXRlbXMgJiYgdGhpcy5zb3J0ZWRJdGVtc1BvcyA+IDAgJiYgdGhpcy5zb3J0ZWRJdGVtc1BvcyA8IHRoaXMuc29ydGVkSXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgICBjdXJyID0gdGhpcy5zb3J0ZWRJdGVtc1t0aGlzLnNvcnRlZEl0ZW1zUG9zXVsxXTtcbiAgICAgICAgICAgIGxhc3RfaWQgPSBcIlwiICsgdGhpcy5zb3J0ZWRJdGVtc1sodGhpcy5zb3J0ZWRJdGVtc1BvcyAtIDEpXVsxXS5pZDtcbiAgICAgICAgICAgIG1hc3RlciA9IHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbbGFzdF9pZF0ucGFyYWxsZWw7XG4gICAgICAgICAgICBwcmV2X2xvY2F0b3IgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChtYXN0ZXIgPT0gY3Vyci5pZCkge1xuICAgICAgICAgICAgICAgIGxlbiA9IHRoaXMuc29ydGVkSXRlbXNQb3MgLSAxO1xuICAgICAgICAgICAgICAgIGZvciAocG9zID0gbGVuOyBwb3MgPiAtMTsgcG9zICs9IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnNvcnRlZEl0ZW1zW3Bvc11bMV0uaWQgPT0gSXRlbS5pZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldl9sb2NhdG9yID0gdGhpcy5zb3J0ZWRJdGVtc1twb3NdWzFdLmxvY2F0b3I7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjdXJyX2xvY2F0b3IgPSB0aGlzLnNvcnRlZEl0ZW1zW3RoaXMuc29ydGVkSXRlbXNQb3NdWzFdLmxvY2F0b3I7XG4gICAgICAgICAgICAgICAgaWYgKCFwcmV2X2xvY2F0b3IgJiYgY3Vycl9sb2NhdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnIucG9zaXRpb24gPSBDU0wuUE9TSVRJT05fSUJJRF9XSVRIX0xPQ0FUT1I7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyX2xvY2F0b3IgPT09IHByZXZfbG9jYXRvcikge1xuICAgICAgICAgICAgICAgICAgICBjdXJyLnBvc2l0aW9uID0gQ1NMLlBPU0lUSU9OX0lCSUQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY3Vyci5wb3NpdGlvbiA9IENTTC5QT1NJVElPTl9JQklEX1dJVEhfTE9DQVRPUjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXSkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtJdGVtLmlkXS5wYXJhbGxlbCA9IGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50cnlfY2l0ZSA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5mb3JjZV9jb2xsYXBzZSA9IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZm9yY2VfY29sbGFwc2UgPSBmYWxzZTtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0ucGFyYWxsZWwpIHtcbiAgICAgICAgICAgIHRoaXMuZm9yY2VfY29sbGFwc2UgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5QYXJhbGxlbC5wcm90b3R5cGUuU3RhcnRWYXJpYWJsZSA9IGZ1bmN0aW9uICh2YXJpYWJsZSwgcmVhbF92YXJpYWJsZSkge1xuICAgIGlmICh0aGlzLnVzZV9wYXJhbGxlbHMgJiYgKHRoaXMudHJ5X2NpdGUgfHwgdGhpcy5mb3JjZV9jb2xsYXBzZSkpIHtcbiAgICAgICAgaWYgKHZhcmlhYmxlID09PSBcIm5hbWVzXCIpIHtcbiAgICAgICAgICAgIHRoaXMudmFyaWFibGUgPSB2YXJpYWJsZSArIFwiOlwiICsgdGhpcy50YXJnZXQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnZhcmlhYmxlID0gdmFyaWFibGU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuaWdub3JlVmFycy5pbmRleE9mKHZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHZhcmlhYmxlID09PSBcImNvbnRhaW5lci10aXRsZVwiICYmIHRoaXMuc2V0cy52YWx1ZSgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5tYXN0ZXJfd2FzX25ldXRyYWxfY2l0ZSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGF0YSA9IHt9O1xuICAgICAgICB0aGlzLmRhdGEudmFsdWUgPSBcIlwiO1xuICAgICAgICB0aGlzLmRhdGEuYmxvYnMgPSBbXTtcbiAgICAgICAgdmFyIGlzX21pZCA9IHRoaXMuaXNNaWQodmFyaWFibGUpO1xuICAgICAgICBpZiAocmVhbF92YXJpYWJsZSA9PT0gXCJhdXRob3JpdHlcIiAmJiB0aGlzLnZhcmlhYmxlID09PSBcIm5hbWVzOmZyb250XCIgJiYgdGhpcy5zZXRzLnZhbHVlKCkubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgcHJldiA9IHRoaXMuc2V0cy52YWx1ZSgpWyh0aGlzLnNldHMudmFsdWUoKS5sZW5ndGggLSAxKV0uSXRlbTtcbiAgICAgICAgICAgIHZhciB0aGlzQXV0aG9yaXR5ID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAodGhpcy5jaXRlLkl0ZW0uYXV0aG9yaXR5ICYmIHRoaXMuY2l0ZS5JdGVtLmF1dGhvcml0eS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0aGlzQXV0aG9yaXR5ID0gdGhpcy5jaXRlLkl0ZW0uYXV0aG9yaXR5WzBdLmxpdGVyYWw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgdGhhdEF1dGhvcml0eSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHByZXYuYXV0aG9yaXR5ICYmIHByZXYuYXV0aG9yaXR5Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRoYXRBdXRob3JpdHkgPSBwcmV2LmF1dGhvcml0eVswXS5saXRlcmFsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXNBdXRob3JpdHkgIT09IHRoYXRBdXRob3JpdHkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnRyeV9jaXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLmluX3NlcmllcyA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRhcmdldCA9PT0gXCJmcm9udFwiICYmIGlzX21pZCkge1xuICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBcIm1pZFwiO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFyZ2V0ID09PSBcIm1pZFwiICYmICFpc19taWQgJiYgdGhpcy5jaXRlLkl0ZW0udGl0bGUgJiYgdmFyaWFibGUgIT09IFwibmFtZXNcIikge1xuICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBcImJhY2tcIjtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRhcmdldCA9PT0gXCJiYWNrXCIgJiYgaXNfbWlkKSB7XG4gICAgICAgICAgICB0aGlzLnRyeV9jaXRlID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuaW5fc2VyaWVzID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHZhcmlhYmxlID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICB0aGlzLmNpdGUuZnJvbnQucHVzaCh0aGlzLnZhcmlhYmxlKTtcbiAgICAgICAgfSBlbHNlIGlmIChDU0wuUEFSQUxMRUxfQ09MTEFQU0lOR19NSURfVkFSU0VULmluZGV4T2YodmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgIGlmIChbXCJhcnRpY2xlLWpvdXJuYWxcIixcImFydGljbGUtbWFnYXppbmVcIl0uaW5kZXhPZih0aGlzLmNpdGUuSXRlbS50eXBlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaXRlLm1pZC5wdXNoKHRoaXMudmFyaWFibGUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNpdGUuZnJvbnQucHVzaCh0aGlzLnZhcmlhYmxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2l0ZVt0aGlzLnRhcmdldF0ucHVzaCh0aGlzLnZhcmlhYmxlKTtcbiAgICAgICAgfVxuICAgfVxufTtcbkNTTC5QYXJhbGxlbC5wcm90b3R5cGUuQXBwZW5kQmxvYlBvaW50ZXIgPSBmdW5jdGlvbiAoYmxvYikge1xuICAgIGlmICh0aGlzLnVzZV9wYXJhbGxlbHMpIHtcbiAgICAgICAgaWYgKHRoaXMuaWdub3JlVmFycy5pbmRleE9mKHRoaXMudmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy51c2VfcGFyYWxsZWxzICYmICh0aGlzLmZvcmNlX2NvbGxhcHNlIHx8IHRoaXMudHJ5X2NpdGUpKSB7XG4gICAgICAgICAgICBpZiAoW1wiYXJ0aWNsZS1qb3VybmFsXCIsIFwiYXJ0aWNsZS1tYWdhemluZVwiXS5pbmRleE9mKHRoaXMuY2l0ZS5JdGVtLnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBpZiAoW1widm9sdW1lXCIsXCJwYWdlXCIsXCJwYWdlLWZpcnN0XCIsXCJpc3N1ZVwiXS5pbmRleE9mKHRoaXMudmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoXCJjb250YWluZXItdGl0bGVcIiA9PT0gdGhpcy52YXJpYWJsZSAmJiB0aGlzLmNpdGUubWlkLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLnZhcmlhYmxlICYmICh0aGlzLnRyeV9jaXRlIHx8IHRoaXMuZm9yY2VfY29sbGFwc2UpICYmIGJsb2IgJiYgYmxvYi5ibG9icykge1xuICAgICAgICAgICAgICAgIGlmICghKHRoaXMuY2l0ZS51c2VQcm9jZWR1cmFsSGlzdG9yeSAmJiB0aGlzLnRhcmdldCA9PT0gXCJiYWNrXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YS5ibG9icy5wdXNoKFtibG9iLCBibG9iLmJsb2JzLmxlbmd0aF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLkFwcGVuZFRvVmFyaWFibGUgPSBmdW5jdGlvbiAoc3RyLCB2YXJuYW1lKSB7XG4gICAgaWYgKHRoaXMudXNlX3BhcmFsbGVscykge1xuICAgICAgICBpZiAodGhpcy5pZ25vcmVWYXJzLmluZGV4T2YodGhpcy52YXJpYWJsZSkgPiAtMSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnRyeV9jaXRlIHx8IHRoaXMuZm9yY2VfY29sbGFwc2UpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldCAhPT0gXCJiYWNrXCIgfHwgdHJ1ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YS52YWx1ZSArPSBcIjo6XCIgKyBzdHI7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBwcmV2ID0gdGhpcy5zZXRzLnZhbHVlKClbKHRoaXMuc2V0cy52YWx1ZSgpLmxlbmd0aCAtIDEpXTtcbiAgICAgICAgICAgICAgICBpZiAocHJldikge1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJldlt0aGlzLnZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZbdGhpcy52YXJpYWJsZV0udmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGEudmFsdWUgKz0gXCI6OlwiICsgc3RyO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5QYXJhbGxlbC5wcm90b3R5cGUuQ2xvc2VWYXJpYWJsZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAodGhpcy51c2VfcGFyYWxsZWxzKSB7XG4gICAgICAgIGlmICh0aGlzLmlnbm9yZVZhcnMuaW5kZXhPZih0aGlzLnZhcmlhYmxlKSA+IC0xKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudHJ5X2NpdGUgfHwgdGhpcy5mb3JjZV9jb2xsYXBzZSkge1xuICAgICAgICAgICAgdGhpcy5jaXRlW3RoaXMudmFyaWFibGVdID0gdGhpcy5kYXRhO1xuICAgICAgICAgICAgaWYgKHRoaXMuc2V0cy52YWx1ZSgpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICB2YXIgcHJldiA9IHRoaXMuc2V0cy52YWx1ZSgpWyh0aGlzLnNldHMudmFsdWUoKS5sZW5ndGggLSAxKV07XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0ID09PSBcImZyb250XCIgJiYgdGhpcy52YXJpYWJsZSA9PT0gXCJpc3N1ZWRcIikge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXRhLnZhbHVlICYmIHRoaXMubWFzdGVyX3dhc19uZXV0cmFsX2NpdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gXCJtaWRcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGhpcy50YXJnZXQgPT09IFwiZnJvbnRcIikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoKHByZXZbdGhpcy52YXJpYWJsZV0gfHwgdGhpcy5kYXRhLnZhbHVlKSAmJiAoIXByZXZbdGhpcy52YXJpYWJsZV0gfHwgdGhpcy5kYXRhLnZhbHVlICE9PSBwcmV2W3RoaXMudmFyaWFibGVdLnZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwiaXNzdWVkXCIgIT09IHRoaXMudmFyaWFibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluX3NlcmllcyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRhcmdldCA9PT0gXCJtaWRcIikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoQ1NMLlBBUkFMTEVMX0NPTExBUFNJTkdfTUlEX1ZBUlNFVC5pbmRleE9mKHRoaXMudmFyaWFibGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2W3RoaXMudmFyaWFibGVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZbdGhpcy52YXJpYWJsZV0udmFsdWUgPT09IHRoaXMuZGF0YS52YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNpdGUuZnJvbnRfY29sbGFwc2VbdGhpcy52YXJpYWJsZV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2l0ZS5mcm9udF9jb2xsYXBzZVt0aGlzLnZhcmlhYmxlXSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaXRlLmZyb250X2NvbGxhcHNlW3RoaXMudmFyaWFibGVdID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFyZ2V0ID09PSBcImJhY2tcIikge1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJldlt0aGlzLnZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0YS52YWx1ZSAhPT0gcHJldlt0aGlzLnZhcmlhYmxlXS52YWx1ZSBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiB0aGlzLnNldHMudmFsdWUoKS5zbGljZSgtMSlbMF0uYmFja19mb3JjZW1lLmluZGV4T2YodGhpcy52YXJpYWJsZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbl9zZXJpZXMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnZhcmlhYmxlID0gZmFsc2U7XG4gICAgfVxufTtcbkNTTC5QYXJhbGxlbC5wcm90b3R5cGUuQ2xvc2VDaXRlID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciB4LCBwb3MsIGxlbiwgaGFzX2lzc3VlZCwgdXNlX2pvdXJuYWxfaW5mbywgdm9sdW1lX3BvcywgY29udGFpbmVyX3RpdGxlX3Bvcywgc2VjdGlvbl9wb3M7XG4gICAgaWYgKHRoaXMudXNlX3BhcmFsbGVscyAmJiAodGhpcy5mb3JjZV9jb2xsYXBzZSB8fCB0aGlzLnRyeV9jaXRlKSkge1xuICAgICAgICB1c2Vfam91cm5hbF9pbmZvID0gZmFsc2U7XG4gICAgICAgIGlmICghdGhpcy5jaXRlLmZyb250X2NvbGxhcHNlW1wiY29udGFpbmVyLXRpdGxlXCJdKSB7XG4gICAgICAgICAgICB1c2Vfam91cm5hbF9pbmZvID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5jaXRlLmZyb250X2NvbGxhcHNlLnZvbHVtZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHVzZV9qb3VybmFsX2luZm8gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmNpdGUuZnJvbnRfY29sbGFwc2VbXCJjb2xsZWN0aW9uLW51bWJlclwiXSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHVzZV9qb3VybmFsX2luZm8gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmNpdGUuZnJvbnRfY29sbGFwc2Uuc2VjdGlvbiA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHVzZV9qb3VybmFsX2luZm8gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh1c2Vfam91cm5hbF9pbmZvKSB7XG4gICAgICAgICAgICB0aGlzLmNpdGUudXNlX2pvdXJuYWxfaW5mbyA9IHRydWU7XG4gICAgICAgICAgICBzZWN0aW9uX3BvcyA9IHRoaXMuY2l0ZS5mcm9udC5pbmRleE9mKFwic2VjdGlvblwiKTtcbiAgICAgICAgICAgIGlmIChzZWN0aW9uX3BvcyA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaXRlLmZyb250ID0gdGhpcy5jaXRlLmZyb250LnNsaWNlKDAsc2VjdGlvbl9wb3MpLmNvbmNhdCh0aGlzLmNpdGUuZnJvbnQuc2xpY2Uoc2VjdGlvbl9wb3MgKyAxKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2b2x1bWVfcG9zID0gdGhpcy5jaXRlLmZyb250LmluZGV4T2YoXCJ2b2x1bWVcIik7XG4gICAgICAgICAgICBpZiAodm9sdW1lX3BvcyA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaXRlLmZyb250ID0gdGhpcy5jaXRlLmZyb250LnNsaWNlKDAsdm9sdW1lX3BvcykuY29uY2F0KHRoaXMuY2l0ZS5mcm9udC5zbGljZSh2b2x1bWVfcG9zICsgMSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29udGFpbmVyX3RpdGxlX3BvcyA9IHRoaXMuY2l0ZS5mcm9udC5pbmRleE9mKFwiY29udGFpbmVyLXRpdGxlXCIpO1xuICAgICAgICAgICAgaWYgKGNvbnRhaW5lcl90aXRsZV9wb3MgPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2l0ZS5mcm9udCA9IHRoaXMuY2l0ZS5mcm9udC5zbGljZSgwLGNvbnRhaW5lcl90aXRsZV9wb3MpLmNvbmNhdCh0aGlzLmNpdGUuZnJvbnQuc2xpY2UoY29udGFpbmVyX3RpdGxlX3BvcyArIDEpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBjb2xsZWN0aW9uX251bWJlcl9wb3MgPSB0aGlzLmNpdGUuZnJvbnQuaW5kZXhPZihcImNvbGxlY3Rpb24tbnVtYmVyXCIpO1xuICAgICAgICAgICAgaWYgKGNvbGxlY3Rpb25fbnVtYmVyX3BvcyA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaXRlLmZyb250ID0gdGhpcy5jaXRlLmZyb250LnNsaWNlKDAsY29sbGVjdGlvbl9udW1iZXJfcG9zKS5jb25jYXQodGhpcy5jaXRlLmZyb250LnNsaWNlKGNvbGxlY3Rpb25fbnVtYmVyX3BvcyArIDEpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuaW5fc2VyaWVzICYmICF0aGlzLmZvcmNlX2NvbGxhcHNlKSB7XG4gICAgICAgICAgICB0aGlzLkNvbXBvc2VTZXQodHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuc2V0cy52YWx1ZSgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdmFyIGhhc19kYXRlID0gZmFsc2U7XG4gICAgICAgICAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IHRoaXMuY2l0ZS5iYWNrLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgIHggPSB0aGlzLmNpdGUuYmFja1twb3NdO1xuICAgICAgICAgICAgICAgIGlmICh4ID09PSBcImlzc3VlZFwiICYmIHRoaXMuY2l0ZVtcImlzc3VlZFwiXSAmJiB0aGlzLmNpdGVbXCJpc3N1ZWRcIl0udmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaGFzX2RhdGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWhhc19kYXRlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaXRlLmJhY2tfZm9yY2VtZS5wdXNoKFwiaXNzdWVkXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIGlkeCA9IHRoaXMuY2l0ZS5mcm9udC5pbmRleE9mKFwiaXNzdWVkXCIpO1xuICAgICAgICAgICAgaWYgKGlkeCA9PT0gLTEgfHwgdGhpcy5tYXN0ZXJfd2FzX25ldXRyYWxfY2l0ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2l0ZS5iYWNrX2ZvcmNlbWUgPSB0aGlzLnNldHMudmFsdWUoKS5zbGljZSgtMSlbMF0uYmFja19mb3JjZW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGlkeCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgdmFyIHByZXYgPSB0aGlzLnNldHMudmFsdWUoKVt0aGlzLnNldHMudmFsdWUoKS5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgICAgICBpZiAoIXByZXZbXCJpc3N1ZWRcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaXRlLmZyb250ID0gdGhpcy5jaXRlLmZyb250LnNsaWNlKDAsIGlkeCkuY29uY2F0KHRoaXMuY2l0ZS5mcm9udC5zbGljZShpZHggKyAxKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMubWFzdGVyX3dhc19uZXV0cmFsX2NpdGUgJiYgdGhpcy5jaXRlLm1pZC5pbmRleE9mKFwibmFtZXM6bWlkXCIpID4gLTEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNpdGUuZnJvbnQucHVzaChcIm5hbWVzOm1pZFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldHMudmFsdWUoKS5wdXNoKHRoaXMuY2l0ZSk7XG4gICAgfVxufTtcbkNTTC5QYXJhbGxlbC5wcm90b3R5cGUuQ29tcG9zZVNldCA9IGZ1bmN0aW9uIChuZXh0X291dHB1dF9pbl9wcm9ncmVzcykge1xuICAgIHZhciBjaXRlLCBwb3MsIG1hc3RlciwgbGVuO1xuICAgIGlmICh0aGlzLnVzZV9wYXJhbGxlbHMgJiYgKHRoaXMuZm9yY2VfY29sbGFwc2UgfHwgdGhpcy50cnlfY2l0ZSkpIHtcbiAgICAgICAgdmFyIGxlbmd0aENoZWNrID0gdGhpcy5zZXRzLnZhbHVlKCkubGVuZ3RoO1xuICAgICAgICBpZiAodGhpcy5zZXRzLnZhbHVlKCkubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaW5fc2VyaWVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRzLnZhbHVlKCkucG9wKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWxpbV9jb3VudGVyICs9IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZW4gPSB0aGlzLnNldHMudmFsdWUoKS5sZW5ndGg7XG4gICAgICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgICAgICBjaXRlID0gdGhpcy5zZXRzLnZhbHVlKClbcG9zXTtcbiAgICAgICAgICAgICAgICBpZiAocG9zID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVsaW1fY291bnRlciArPSAxO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghY2l0ZS5JdGVtLnRpdGxlICYmIGNpdGUudXNlX2pvdXJuYWxfaW5mbykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWxpbV9wb2ludGVycy5wdXNoKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVsaW1fcG9pbnRlcnMucHVzaCh0aGlzLmRlbGltX2NvdW50ZXIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVsaW1fY291bnRlciArPSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoQ1NMLlBPU0lUSU9OX0ZJUlNUID09PSBjaXRlLnBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwb3MgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbY2l0ZS5pdGVtSWRdLm1hc3RlciA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2NpdGUuaXRlbUlkXS5zaWJsaW5ncyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtjaXRlLml0ZW1JZF0ucGFyYWxsZWwgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaXRlLnByZXZJdGVtSUQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbY2l0ZS5wcmV2SXRlbUlEXS5wYXJhbGxlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2NpdGUuaXRlbUlkXS5wYXJhbGxlbCA9IGNpdGUucHJldkl0ZW1JRDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2NpdGUuaXRlbUlkXS5wYXJhbGxlbCA9IHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbY2l0ZS5wcmV2SXRlbUlEXS5wYXJhbGxlbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVtjaXRlLml0ZW1JZF0uc2libGluZ3MgPSB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2NpdGUucHJldkl0ZW1JRF0uc2libGluZ3M7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2NpdGUuaXRlbUlkXS5zaWJsaW5ncykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W2NpdGUuaXRlbUlkXS5zaWJsaW5ncyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDU0wuZGVidWcoXCJXQVJOSU5HOiBhZGRpbmcgbWlzc2luZyBzaWJsaW5ncyBhcnJheSB0byByZWdpc3RyeSBvYmplY3RcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbY2l0ZS5pdGVtSWRdLnNpYmxpbmdzLnB1c2goY2l0ZS5pdGVtSWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zZXRzLnB1c2goW10pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsZW5ndGhDaGVjayA8IDIpIHtcbiAgICAgICAgICAgIHRoaXMucHVyZ2VHcm91cHNJZlBhcmFsbGVsKGZhbHNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucHVyZ2VHcm91cHNJZlBhcmFsbGVsKHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaW5fc2VyaWVzID0gdHJ1ZTtcbiAgICB9XG59O1xuQ1NMLlBhcmFsbGVsLnByb3RvdHlwZS5QcnVuZU91dHB1dFF1ZXVlID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBsZW4sIHBvcywgc2VyaWVzLCBwcG9zLCBsbGVuLCBjaXRlO1xuICAgIGlmICh0aGlzLnVzZV9wYXJhbGxlbHMpIHtcbiAgICAgICAgbGVuID0gdGhpcy5zZXRzLm15c3RhY2subGVuZ3RoO1xuICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgICAgIHNlcmllcyA9IHRoaXMuc2V0cy5teXN0YWNrW3Bvc107XG4gICAgICAgICAgICBpZiAoc2VyaWVzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICBsbGVuID0gc2VyaWVzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICBmb3IgKHBwb3MgPSAwOyBwcG9zIDwgbGxlbjsgcHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGNpdGUgPSBzZXJpZXNbcHBvc107XG4gICAgICAgICAgICAgICAgICAgIGlmIChwcG9zID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmdlVmFyaWFibGVCbG9icyhjaXRlLCBjaXRlLmJhY2spO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHBwb3MgPT09IChzZXJpZXMubGVuZ3RoIC0gMSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVyZ2VWYXJpYWJsZUJsb2JzKGNpdGUsIGNpdGUuZnJvbnQuY29uY2F0KGNpdGUuYmFja19mb3JjZW1lKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmdlVmFyaWFibGVCbG9icyhjaXRlLCBjaXRlLmZyb250LmNvbmNhdChjaXRlLmJhY2spKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLnB1cmdlVmFyaWFibGVCbG9icyA9IGZ1bmN0aW9uIChjaXRlLCB2YXJuYW1lcykge1xuICAgIHZhciBsZW4sIHBvcywgdmFybmFtZSwgYiwgbGxlbiwgcHBvcywgb3V0O1xuICAgIGlmICh0aGlzLnVzZV9wYXJhbGxlbHMpIHtcbiAgICAgICAgb3V0ID0gdGhpcy5zdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpO1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIG91dC5sZW5ndGgpIHtcbiAgICAgICAgICAgIG91dCA9IG91dC5ibG9icztcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IHRoaXMuZGVsaW1fcG9pbnRlcnMubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICBwcG9zID0gdGhpcy5kZWxpbV9wb2ludGVyc1twb3NdO1xuICAgICAgICAgICAgaWYgKHBwb3MgIT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgb3V0W3Bwb3NdLnBhcmFsbGVsX2RlbGltaXRlciA9IFwiLCBcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsZW4gPSB2YXJuYW1lcy5sZW5ndGggLSAxO1xuICAgICAgICBmb3IgKHBvcyA9IGxlbjsgcG9zID4gLTE7IHBvcyArPSAtMSkge1xuICAgICAgICAgICAgdmFybmFtZSA9IHZhcm5hbWVzW3Bvc107XG4gICAgICAgICAgICBpZiAoY2l0ZVt2YXJuYW1lXSkge1xuICAgICAgICAgICAgICAgIGxsZW4gPSBjaXRlW3Zhcm5hbWVdLmJsb2JzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgZm9yIChwcG9zID0gbGxlbjsgcHBvcyA+IC0xOyBwcG9zICs9IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGIgPSBjaXRlW3Zhcm5hbWVdLmJsb2JzW3Bwb3NdO1xuICAgICAgICAgICAgICAgICAgICBiWzBdLmJsb2JzID0gYlswXS5ibG9icy5zbGljZSgwLCBiWzFdKS5jb25jYXQoYlswXS5ibG9icy5zbGljZSgoYlsxXSArIDEpKSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmhhc19wdXJnZWRfcGFyYWxsZWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYlswXSAmJiBiWzBdLnN0cmluZ3MgJiYgXCJzdHJpbmdcIiA9PSB0eXBlb2YgYlswXS5zdHJpbmdzLm9vcHNcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIGJbMF0ucGFyZW50ICYmIGJbMF0ucGFyZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBiWzBdLnBhcmVudC5wYXJlbnQuc3RyaW5ncy5kZWxpbWl0ZXIgPSBiWzBdLnN0cmluZ3Mub29wcztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuUGFyYWxsZWwucHJvdG90eXBlLnB1cmdlR3JvdXBzSWZQYXJhbGxlbCA9IGZ1bmN0aW9uIChvcmlnaW5hbF9jb25kaXRpb24pIHtcbiAgICBmb3IgKHZhciBpID0gdGhpcy5wYXJhbGxlbF9jb25kaXRpb25hbF9ibG9ic19saXN0Lmxlbmd0aCAtIDE7IGkgPiAtMTsgaSArPSAtMSkge1xuICAgICAgICB2YXIgb2JqID0gdGhpcy5wYXJhbGxlbF9jb25kaXRpb25hbF9ibG9ic19saXN0W2ldO1xuICAgICAgICB2YXIgcHVyZ2VtZSA9IHRydWU7XG4gICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gb2JqLmNvbmRpdGlvbnMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICBpZiAoISghb2JqLmNvbmRpdGlvbnNbal0gPT09ICEhb3JpZ2luYWxfY29uZGl0aW9uXG4gICAgICAgICAgICAgICAgfHwgKFwibWFzdGVyXCIgPT09IG9iai5jb25kaXRpb25zW2pdXG4gICAgICAgICAgICAgICAgICAgICYmICF0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W29iai5pZF0ubWFzdGVyKVxuICAgICAgICAgICAgICAgIHx8IChcInNlcnZhbnRcIiA9PT0gb2JqLmNvbmRpdGlvbnNbal1cbiAgICAgICAgICAgICAgICAgICAgJiYgIXRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbb2JqLmlkXS5wYXJhbGxlbCkpKSB7XG4gICAgICAgICAgICAgICAgdmFyIHB1cmdlbWUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocHVyZ2VtZSkge1xuICAgICAgICAgICAgdmFyIGJ1ZmZlciA9IFtdO1xuICAgICAgICAgICAgd2hpbGUgKG9iai5ibG9icy5sZW5ndGggPiBvYmoucG9zKSB7XG4gICAgICAgICAgICAgICAgYnVmZmVyLnB1c2gob2JqLmJsb2JzLnBvcCgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChidWZmZXIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgYnVmZmVyLnBvcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgd2hpbGUgKGJ1ZmZlci5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBvYmouYmxvYnMucHVzaChidWZmZXIucG9wKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMucGFyYWxsZWxfY29uZGl0aW9uYWxfYmxvYnNfbGlzdC5wb3AoKTtcbiAgICB9XG59XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5VdGlsID0ge307XG5DU0wuVXRpbC5NYXRjaCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmFueSA9IGZ1bmN0aW9uICh0b2tlbiwgc3RhdGUsIHRlc3RzKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLCBpbGVuPXRlc3RzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB0ZXN0c1tpXShJdGVtLCBpdGVtKTtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfTtcbiAgICB9O1xuICAgIHRoaXMubm9uZSA9IGZ1bmN0aW9uICh0b2tlbiwgc3RhdGUsIHRlc3RzKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGVzdHMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHRlc3RzW2ldKEl0ZW0saXRlbSk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgfTtcbiAgICB0aGlzLmFsbCA9IGZ1bmN0aW9uICh0b2tlbiwgc3RhdGUsIHRlc3RzKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoSXRlbSwgaXRlbSkge1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dGVzdHMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHRlc3RzW2ldKEl0ZW0saXRlbSk7XG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgIH07XG4gICAgdGhpc1t1bmRlZmluZWRdID0gdGhpcy5hbGw7XG4gICAgdGhpcy5uYW5kID0gZnVuY3Rpb24gKHRva2VuLCBzdGF0ZSwgdGVzdHMpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj10ZXN0cy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gdGVzdHNbaV0oSXRlbSxpdGVtKTtcbiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH07XG4gICAgfTtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5UcmFuc2Zvcm0gPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICB2YXIgZGVidWcgPSBmYWxzZSwgYWJicmV2aWF0aW9ucywgdG9rZW4sIGZpZWxkbmFtZSwgYWJicmV2X2ZhbWlseSwgb3B0O1xuICAgIHRoaXMuYWJicmV2cyA9IHt9O1xuICAgIHRoaXMuYWJicmV2c1tcImRlZmF1bHRcIl0gPSBuZXcgc3RhdGUuc3lzLkFiYnJldmlhdGlvblNlZ21lbnRzKCk7XG4gICAgdGhpcy5nZXRUZXh0U3ViRmllbGQgPSBnZXRUZXh0U3ViRmllbGQ7XG4gICAgZnVuY3Rpb24gYWJicmV2aWF0ZShzdGF0ZSwgSXRlbSwgYWx0dmFyLCBiYXNldmFsdWUsIG15YWJicmV2X2ZhbWlseSwgdXNlX2ZpZWxkKSB7XG4gICAgICAgIHZhciB2YWx1ZTtcbiAgICAgICAgbXlhYmJyZXZfZmFtaWx5ID0gQ1NMLkZJRUxEX0NBVEVHT1JZX1JFTUFQW215YWJicmV2X2ZhbWlseV07XG4gICAgICAgIGlmICghbXlhYmJyZXZfZmFtaWx5KSB7XG4gICAgICAgICAgICByZXR1cm4gYmFzZXZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHZhciB2YXJpYWJsZSA9IG15YWJicmV2X2ZhbWlseTtcbiAgICAgICAgdmFsdWUgPSBcIlwiO1xuICAgICAgICBpZiAoc3RhdGUuc3lzLmdldEFiYnJldmlhdGlvbikge1xuICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRLZXkgPSBiYXNldmFsdWU7XG4gICAgICAgICAgICBpZiAoc3RhdGUuc3lzLm5vcm1hbGl6ZUFiYnJldnNLZXkpIHtcbiAgICAgICAgICAgICAgICBub3JtYWxpemVkS2V5ID0gc3RhdGUuc3lzLm5vcm1hbGl6ZUFiYnJldnNLZXkoYmFzZXZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBqdXJpc2RpY3Rpb24gPSBzdGF0ZS50cmFuc2Zvcm0ubG9hZEFiYnJldmlhdGlvbihJdGVtLmp1cmlzZGljdGlvbiwgbXlhYmJyZXZfZmFtaWx5LCBub3JtYWxpemVkS2V5LCBJdGVtLnR5cGUsIHRydWUpO1xuICAgICAgICAgICAgaWYgKHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bbXlhYmJyZXZfZmFtaWx5XSAmJiBub3JtYWxpemVkS2V5ICYmIHN0YXRlLnN5cy5nZXRBYmJyZXZpYXRpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXVtteWFiYnJldl9mYW1pbHldW25vcm1hbGl6ZWRLZXldKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gc3RhdGUudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXVtteWFiYnJldl9mYW1pbHldW25vcm1hbGl6ZWRLZXldLnJlcGxhY2UoXCJ7c3RldH1cIixiYXNldmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIXZhbHVlIFxuICAgICAgICAgICAgJiYgKCFzdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5yZXF1aXJlX2V4cGxpY2l0X2xlZ2FsX2Nhc2VfdGl0bGVfc2hvcnQgfHwgSXRlbS50eXBlICE9PSAnbGVnYWxfY2FzZScpIFxuICAgICAgICAgICAgJiYgYWx0dmFyICYmIEl0ZW1bYWx0dmFyXSAmJiB1c2VfZmllbGQpIHtcbiAgICAgICAgICAgIHZhbHVlID0gSXRlbVthbHR2YXJdO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdmFsdWUpIHtcbiAgICAgICAgICAgIHZhbHVlID0gYmFzZXZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5tYXRjaCgvXlxcISg/OltePl0rLCkqaGVyZSg/OixbXj5dKykqPj4+LykpIHtcbiAgICAgICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJqdXJpc2RpY3Rpb25cIiAmJiBbXCJ0cmVhdHlcIiwgXCJwYXRlbnRcIl0uaW5kZXhPZihJdGVtLnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL15cXCFbXj5dKj4+PlxccyovLCBcIlwiKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICBmdW5jdGlvbiBnZXRGaWVsZExvY2FsZShJdGVtLGZpZWxkKSB7XG4gICAgICAgIHZhciByZXQgPSBzdGF0ZS5vcHRbXCJkZWZhdWx0LWxvY2FsZVwiXVswXS5zbGljZSgwLCAyKVxuICAgICAgICB2YXIgbG9jYWxlUmV4O1xuICAgICAgICBpZiAoc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3RyaWN0X3RleHRfY2FzZV9sb2NhbGVzKSB7XG4gICAgICAgICAgICBsb2NhbGVSZXggPSBuZXcgUmVnRXhwKFwiXihbYS16QS1aXXsyfSkoPzokfC0uKnwgLiopXCIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9jYWxlUmV4ID0gbmV3IFJlZ0V4cChcIl4oW2EtekEtWl17Mn0pKD86JHwtLip8LiopXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChJdGVtLmxhbmd1YWdlKSB7XG4gICAgICAgICAgICB2YXIgbSA9IChcIlwiICsgSXRlbS5sYW5ndWFnZSkubWF0Y2gobG9jYWxlUmV4KTtcbiAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gbVsxXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gXCJ0bGhcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoSXRlbS5tdWx0aSAmJiBJdGVtLm11bHRpICYmIEl0ZW0ubXVsdGkubWFpbiAmJiBJdGVtLm11bHRpLm1haW5bZmllbGRdKSB7XG4gICAgICAgICAgICByZXQgPSBJdGVtLm11bHRpLm1haW5bZmllbGRdO1xuICAgICAgICB9XG4gICAgICAgIGlmICghc3RhdGUub3B0LmRldmVsb3BtZW50X2V4dGVuc2lvbnMuc3RyaWN0X3RleHRfY2FzZV9sb2NhbGVzXG4gICAgICAgICAgIHx8IHN0YXRlLm9wdC5kZXZlbG9wbWVudF9leHRlbnNpb25zLm5vcm1hbGl6ZV9sYW5nX2tleXNfdG9fbG93ZXJjYXNlKSB7XG4gICAgICAgICAgICByZXQgPSByZXQudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH07XG4gICAgZnVuY3Rpb24gZ2V0VGV4dFN1YkZpZWxkIChJdGVtLCBmaWVsZCwgbG9jYWxlX3R5cGUsIHVzZV9kZWZhdWx0LCBzdG9wT3JpZykge1xuICAgICAgICB2YXIgbSwgbHN0LCBvcHQsIG8sIG9vLCBwb3MsIGtleSwgcmV0LCBsZW4sIG15cmV0LCBvcHRzO1xuICAgICAgICB2YXIgdXNlZE9yaWcgPSBzdG9wT3JpZztcbiAgICAgICAgdmFyIHVzaW5nT3JpZyA9IGZhbHNlO1xuICAgICAgICBpZiAoIUl0ZW1bZmllbGRdKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIG5hbWU6XCJcIixcbiAgICAgICAgICAgICAgICB1c2VkT3JpZzpzdG9wT3JpZyxcbiAgICAgICAgICAgICAgICB0b2tlbjogQ1NMLlV0aWwuY2xvbmVUb2tlbih0aGlzKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICByZXQgPSB7bmFtZTpcIlwiLCB1c2VkT3JpZzpzdG9wT3JpZyxsb2NhbGU6Z2V0RmllbGRMb2NhbGUoSXRlbSxmaWVsZCl9O1xuICAgICAgICBvcHRzID0gc3RhdGUub3B0W2xvY2FsZV90eXBlXTtcbiAgICAgICAgdmFyIGhhc1ZhbCA9IGZhbHNlO1xuICAgICAgICB2YXIganVyaXNkaWN0aW9uTmFtZSA9IGZhbHNlO1xuICAgICAgICBpZiAobG9jYWxlX3R5cGUgPT09ICdsb2NhbGUtb3JpZycpIHtcbiAgICAgICAgICAgIGlmIChzdG9wT3JpZykge1xuICAgICAgICAgICAgICAgIHJldCA9IHtuYW1lOlwiXCIsIHVzZWRPcmlnOnN0b3BPcmlnfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0ID0ge25hbWU6SXRlbVtmaWVsZF0sIHVzZWRPcmlnOmZhbHNlLCBsb2NhbGU6Z2V0RmllbGRMb2NhbGUoSXRlbSxmaWVsZCl9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaGFzVmFsID0gdHJ1ZTtcbiAgICAgICAgICAgIHVzaW5nT3JpZyA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAodXNlX2RlZmF1bHQgJiYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBvcHRzIHx8IG9wdHMubGVuZ3RoID09PSAwKSkge1xuICAgICAgICAgICAgdmFyIHJldCA9IHtuYW1lOkl0ZW1bZmllbGRdLCB1c2VkT3JpZzp0cnVlLCBsb2NhbGU6Z2V0RmllbGRMb2NhbGUoSXRlbSxmaWVsZCl9O1xuICAgICAgICAgICAgaGFzVmFsID0gdHJ1ZTtcbiAgICAgICAgICAgIHVzaW5nT3JpZyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFoYXNWYWwpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gb3B0cy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBvcHQgPSBvcHRzW2ldO1xuICAgICAgICAgICAgICAgIG8gPSBvcHQuc3BsaXQoL1tcXC1fXS8pWzBdO1xuICAgICAgICAgICAgICAgIGlmIChvcHQgJiYgSXRlbS5tdWx0aSAmJiBJdGVtLm11bHRpLl9rZXlzW2ZpZWxkXSAmJiBJdGVtLm11bHRpLl9rZXlzW2ZpZWxkXVtvcHRdKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldC5uYW1lID0gSXRlbS5tdWx0aS5fa2V5c1tmaWVsZF1bb3B0XTtcbiAgICAgICAgICAgICAgICAgICAgcmV0LmxvY2FsZSA9IG9wdDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkID09PSAnanVyaXNkaWN0aW9uJykganVyaXNkaWN0aW9uTmFtZSA9IHJldC5uYW1lO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG8gJiYgSXRlbS5tdWx0aSAmJiBJdGVtLm11bHRpLl9rZXlzW2ZpZWxkXSAmJiBJdGVtLm11bHRpLl9rZXlzW2ZpZWxkXVtvXSkge1xuICAgICAgICAgICAgICAgICAgICByZXQubmFtZSA9IEl0ZW0ubXVsdGkuX2tleXNbZmllbGRdW29dO1xuICAgICAgICAgICAgICAgICAgICByZXQubG9jYWxlID0gbztcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkID09PSAnanVyaXNkaWN0aW9uJykganVyaXNkaWN0aW9uTmFtZSA9IHJldC5uYW1lO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXJldC5uYW1lICYmIHVzZV9kZWZhdWx0KSB7XG4gICAgICAgICAgICAgICAgcmV0ID0ge25hbWU6SXRlbVtmaWVsZF0sIHVzZWRPcmlnOnRydWUsIGxvY2FsZTpnZXRGaWVsZExvY2FsZShJdGVtLGZpZWxkKX07XG4gICAgICAgICAgICAgICAgdXNpbmdPcmlnID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXQudG9rZW4gPSBDU0wuVXRpbC5jbG9uZVRva2VuKHRoaXMpO1xuICAgICAgICBpZiAoc3RhdGUuc3lzLmdldEh1bWFuRm9ybSAmJiByZXQubmFtZSAmJiBmaWVsZCA9PT0gJ2p1cmlzZGljdGlvbicpIHtcbiAgICAgICAgICAgIHJldC5uYW1lID0gQ1NMLmdldEp1cmlzZGljdGlvbk5hbWVBbmRTdXBwcmVzcyhzdGF0ZSwgSXRlbVtmaWVsZF0sIGp1cmlzZGljdGlvbk5hbWUsIHRoaXMuc3RyaW5ncy5qdXJpc2RpY3Rpb25fZGVwdGgpO1xuICAgICAgICB9IGVsc2UgaWYgKFtcInRpdGxlXCIsIFwiY29udGFpbmVyLXRpdGxlXCJdLmluZGV4T2YoZmllbGQpID4gLTEpIHtcbiAgICAgICAgICAgIGlmICghdXNlZE9yaWdcbiAgICAgICAgICAgICAgICAmJiAoIXJldC50b2tlbi5zdHJpbmdzW1widGV4dC1jYXNlXCJdXG4gICAgICAgICAgICAgICAgICAgIHx8IHJldC50b2tlbi5zdHJpbmdzW1widGV4dC1jYXNlXCJdID09PSBcInNlbnRlbmNlXCJcbiAgICAgICAgICAgICAgICAgICAgfHwgcmV0LnRva2VuLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0gPT09IFwibm9ybWFsXCIpKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxvY2FsZSA9IHVzaW5nT3JpZyA/IGZhbHNlIDogcmV0LmxvY2FsZTtcbiAgICAgICAgICAgICAgICB2YXIgc2VnID0gZmllbGQuc2xpY2UoMCwtNSk7XG4gICAgICAgICAgICAgICAgdmFyIHNlbnRlbmNlQ2FzZSA9IHJldC50b2tlbi5zdHJpbmdzW1widGV4dC1jYXNlXCJdID09PSBcInNlbnRlbmNlXCIgPyB0cnVlIDogZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0Lm5hbWUgPSBDU0wudGl0bGVjYXNlU2VudGVuY2VPck5vcm1hbChzdGF0ZSwgSXRlbSwgc2VnLCBsb2NhbGUsIHNlbnRlbmNlQ2FzZSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHJldC50b2tlbi5zdHJpbmdzW1widGV4dC1jYXNlXCJdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGxvYWRBYmJyZXZpYXRpb24oanVyaXNkaWN0aW9uLCBjYXRlZ29yeSwgb3JpZywgaXRlbVR5cGUpIHtcbiAgICAgICAgdmFyIHBvcywgbGVuO1xuICAgICAgICBpZiAoIWp1cmlzZGljdGlvbikge1xuICAgICAgICAgICAganVyaXNkaWN0aW9uID0gXCJkZWZhdWx0XCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFvcmlnKSB7XG4gICAgICAgICAgICBpZiAoIXN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dID0gbmV3IHN0YXRlLnN5cy5BYmJyZXZpYXRpb25TZWdtZW50cygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFzdGF0ZS50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dW2NhdGVnb3J5XSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl1bY2F0ZWdvcnldID0ge307XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4ganVyaXNkaWN0aW9uO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGF0ZS5zeXMuZ2V0QWJicmV2aWF0aW9uKSB7XG4gICAgICAgICAgICBqdXJpc2RpY3Rpb24gPSBzdGF0ZS5zeXMuZ2V0QWJicmV2aWF0aW9uKHN0YXRlLm9wdC5zdHlsZUlELCBzdGF0ZS50cmFuc2Zvcm0uYWJicmV2cywganVyaXNkaWN0aW9uLCBjYXRlZ29yeSwgb3JpZywgaXRlbVR5cGUsIHRydWUpO1xuICAgICAgICAgICAgaWYgKCFqdXJpc2RpY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBqdXJpc2RpY3Rpb24gPSBcImRlZmF1bHRcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ganVyaXNkaWN0aW9uO1xuICAgIH1cbiAgICB0aGlzLmxvYWRBYmJyZXZpYXRpb24gPSBsb2FkQWJicmV2aWF0aW9uO1xuICAgIGZ1bmN0aW9uIHB1Ymxpc2hlckNoZWNrICh0b2ssIEl0ZW0sIHByaW1hcnksIG15YWJicmV2X2ZhbWlseSkge1xuICAgICAgICB2YXIgdmFybmFtZSA9IHRvay52YXJpYWJsZXNbMF07XG4gICAgICAgIGlmIChzdGF0ZS5wdWJsaXNoZXJPdXRwdXQgJiYgcHJpbWFyeSkge1xuICAgICAgICAgICAgaWYgKFtcInB1Ymxpc2hlclwiLFwicHVibGlzaGVyLXBsYWNlXCJdLmluZGV4T2YodmFybmFtZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5wdWJsaXNoZXJPdXRwdXRbdmFybmFtZSArIFwiLXRva2VuXCJdID0gdG9rO1xuICAgICAgICAgICAgICAgIHN0YXRlLnB1Ymxpc2hlck91dHB1dC52YXJsaXN0LnB1c2godmFybmFtZSk7XG4gICAgICAgICAgICAgICAgdmFyIGxzdCA9IHByaW1hcnkuc3BsaXQoLztcXHMqLyk7XG4gICAgICAgICAgICAgICAgaWYgKGxzdC5sZW5ndGggPT09IHN0YXRlLnB1Ymxpc2hlck91dHB1dFt2YXJuYW1lICsgXCItbGlzdFwiXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUucHVibGlzaGVyT3V0cHV0W3Zhcm5hbWUgKyBcIi1saXN0XCJdID0gbHN0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGxzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgbHN0W2ldID0gYWJicmV2aWF0ZShzdGF0ZSwgSXRlbSwgZmFsc2UsIGxzdFtpXSwgbXlhYmJyZXZfZmFtaWx5LCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wW3Zhcm5hbWUgKyBcIi10b2tlblwiXSA9IHRvaztcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGdldE91dHB1dEZ1bmN0aW9uKHZhcmlhYmxlcywgbXlhYmJyZXZfZmFtaWx5LCBhYmJyZXZpYXRpb25fZmFsbGJhY2ssIGFsdGVybmF0aXZlX3Zhcm5hbWUsIHRyYW5zZm9ybV9mYWxsYmFjaykge1xuICAgICAgICB2YXIgbG9jYWxlc2V0cztcbiAgICAgICAgdmFyIGxhbmdQcmVmcyA9IENTTC5MYW5nUHJlZnNNYXBbdmFyaWFibGVzWzBdXTtcbiAgICAgICAgaWYgKCFsYW5nUHJlZnMpIHtcbiAgICAgICAgICAgIGxvY2FsZXNldHMgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvY2FsZXNldHMgPSBzdGF0ZS5vcHRbJ2NpdGUtbGFuZy1wcmVmcyddW2xhbmdQcmVmc107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSwgaXRlbSwgdXNlZE9yaWcpIHtcbiAgICAgICAgICAgIHZhciBwcmltYXJ5LCBwcmltYXJ5X2xvY2FsZSwgc2Vjb25kYXJ5LCBzZWNvbmRhcnlfbG9jYWxlLCB0ZXJ0aWFyeSwgdGVydGlhcnlfbG9jYWxlLCBwcmltYXJ5X3RvaywgZ3JvdXBfdG9rLCBrZXk7XG4gICAgICAgICAgICBpZiAoIXZhcmlhYmxlc1swXSB8fCAoIUl0ZW1bdmFyaWFibGVzWzBdXSAmJiAhSXRlbVthbHRlcm5hdGl2ZV92YXJuYW1lXSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBzbG90ID0ge3ByaW1hcnk6ZmFsc2UsIHNlY29uZGFyeTpmYWxzZSwgdGVydGlhcnk6ZmFsc2V9O1xuICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5hcmVhLnNsaWNlKC01KSA9PT0gXCJfc29ydFwiKSB7XG4gICAgICAgICAgICAgICAgc2xvdC5wcmltYXJ5ID0gJ2xvY2FsZS1zb3J0JztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGxvY2FsZXNldHMpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNsb3RuYW1lcyA9IFtcInByaW1hcnlcIiwgXCJzZWNvbmRhcnlcIiwgXCJ0ZXJ0aWFyeVwiXTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBzbG90bmFtZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobG9jYWxlc2V0cy5sZW5ndGggLSAxIDwgIGkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsb2NhbGVzZXRzW2ldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xvdFtzbG90bmFtZXNbaV1dID0gJ2xvY2FsZS0nICsgbG9jYWxlc2V0c1tpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNsb3QucHJpbWFyeSA9ICdsb2NhbGUtb3JpZyc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHZhcmlhYmxlc1swXSA9PT0gXCJ0aXRsZS1zaG9ydFwiIFxuICAgICAgICAgICAgICAgIHx8IChzdGF0ZS50bXAuYXJlYSAhPT0gXCJiaWJsaW9ncmFwaHlcIlxuICAgICAgICAgICAgICAgICAgICAmJiAhKHN0YXRlLnRtcC5hcmVhID09PSBcImNpdGF0aW9uXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAmJiBzdGF0ZS5vcHQueGNsYXNzID09PSBcIm5vdGVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICYmIGl0ZW0gJiYgIWl0ZW0ucG9zaXRpb24pKSkge1xuICAgICAgICAgICAgICAgIHNsb3Quc2Vjb25kYXJ5ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgc2xvdC50ZXJ0aWFyeSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN0YXRlLnRtcFtcInB1Ymxpc2hlci1saXN0XCJdKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZhcmlhYmxlc1swXSA9PT0gXCJwdWJsaXNoZXJcIikge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXBbXCJwdWJsaXNoZXItdG9rZW5cIl0gPSB0aGlzO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFyaWFibGVzWzBdID09PSBcInB1Ymxpc2hlci1wbGFjZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcFtcInB1Ymxpc2hlci1wbGFjZS10b2tlblwiXSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHJlcyA9IGdldFRleHRTdWJGaWVsZC5jYWxsKHRoaXMsIEl0ZW0sIHZhcmlhYmxlc1swXSwgc2xvdC5wcmltYXJ5LCB0cnVlKTtcbiAgICAgICAgICAgIHByaW1hcnkgPSByZXMubmFtZTtcbiAgICAgICAgICAgIHByaW1hcnlfbG9jYWxlID0gcmVzLmxvY2FsZTtcbiAgICAgICAgICAgIHZhciBwcmltYXJ5X3RvayA9IHJlcy50b2tlbjtcbiAgICAgICAgICAgIHZhciBwcmltYXJ5VXNlZE9yaWcgPSByZXMudXNlZE9yaWc7XG4gICAgICAgICAgICBpZiAocHVibGlzaGVyQ2hlY2sodGhpcywgSXRlbSwgcHJpbWFyeSwgbXlhYmJyZXZfZmFtaWx5KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2Vjb25kYXJ5ID0gZmFsc2U7XG4gICAgICAgICAgICB0ZXJ0aWFyeSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHNsb3Quc2Vjb25kYXJ5KSB7XG4gICAgICAgICAgICAgICAgcmVzID0gZ2V0VGV4dFN1YkZpZWxkLmNhbGwodGhpcywgSXRlbSwgdmFyaWFibGVzWzBdLCBzbG90LnNlY29uZGFyeSwgZmFsc2UsIHJlcy51c2VkT3JpZyk7XG4gICAgICAgICAgICAgICAgc2Vjb25kYXJ5ID0gcmVzLm5hbWU7XG4gICAgICAgICAgICAgICAgc2Vjb25kYXJ5X2xvY2FsZSA9IHJlcy5sb2NhbGU7XG4gICAgICAgICAgICAgICAgdmFyIHNlY29uZGFyeV90b2sgPSByZXMudG9rZW47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc2xvdC50ZXJ0aWFyeSkge1xuICAgICAgICAgICAgICAgIHJlcyA9IGdldFRleHRTdWJGaWVsZC5jYWxsKHRoaXMsIEl0ZW0sIHZhcmlhYmxlc1swXSwgc2xvdC50ZXJ0aWFyeSwgZmFsc2UsIHJlcy51c2VkT3JpZyk7XG4gICAgICAgICAgICAgICAgdGVydGlhcnkgPSByZXMubmFtZTtcbiAgICAgICAgICAgICAgICB0ZXJ0aWFyeV9sb2NhbGUgPSByZXMubG9jYWxlO1xuICAgICAgICAgICAgICAgIHZhciB0ZXJ0aWFyeV90b2sgPSByZXMudG9rZW47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobXlhYmJyZXZfZmFtaWx5KSB7XG4gICAgICAgICAgICAgICAgcHJpbWFyeSA9IGFiYnJldmlhdGUoc3RhdGUsIEl0ZW0sIGFsdGVybmF0aXZlX3Zhcm5hbWUsIHByaW1hcnksIG15YWJicmV2X2ZhbWlseSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgaWYgKHByaW1hcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJpbWFyeSA9IHF1YXNoQ2hlY2socHJpbWFyeSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNlY29uZGFyeSA9IGFiYnJldmlhdGUoc3RhdGUsIEl0ZW0sIGZhbHNlLCBzZWNvbmRhcnksIG15YWJicmV2X2ZhbWlseSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgdGVydGlhcnkgPSBhYmJyZXZpYXRlKHN0YXRlLCBJdGVtLCBmYWxzZSwgdGVydGlhcnksIG15YWJicmV2X2ZhbWlseSwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgcHJpbWFyeVByZWZpeDtcbiAgICAgICAgICAgIGlmIChzbG90LnByaW1hcnkgPT09IFwibG9jYWxlLXRyYW5zbGl0XCIpIHtcbiAgICAgICAgICAgICAgICBwcmltYXJ5UHJlZml4ID0gc3RhdGUub3B0LmNpdGVBZmZpeGVzW2xhbmdQcmVmc11bc2xvdC5wcmltYXJ5XS5wcmVmaXg7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHByaW1hcnlQcmVmaXggPT09IFwiPGk+XCIgJiYgdmFyaWFibGVzWzBdID09PSAndGl0bGUnICYmICFwcmltYXJ5VXNlZE9yaWcpIHtcbiAgICAgICAgICAgICAgICB2YXIgaGFzSXRhbGljID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBwcmltYXJ5X3Rvay5kZWNvcmF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlfdG9rLmRlY29yYXRpb25zW2ldWzBdID09PSBcIkBmb250LXN0eWxlXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIHByaW1hcnlfdG9rLmRlY29yYXRpb25zW2ldWzFdID09PSBcIml0YWxpY1wiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBoYXNJdGFsaWMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghaGFzSXRhbGljKSB7XG4gICAgICAgICAgICAgICAgICAgIHByaW1hcnlfdG9rLmRlY29yYXRpb25zLnB1c2goW1wiQGZvbnQtc3R5bGVcIiwgXCJpdGFsaWNcIl0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHByaW1hcnlfbG9jYWxlICE9PSBcImVuXCIgJiYgcHJpbWFyeV90b2suc3RyaW5nc1tcInRleHQtY2FzZVwiXSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgcHJpbWFyeV90b2suc3RyaW5nc1tcInRleHQtY2FzZVwiXSA9IFwicGFzc3Rocm91Z2hcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChcInRpdGxlXCIgPT09IHZhcmlhYmxlc1swXSkge1xuICAgICAgICAgICAgICAgIHByaW1hcnkgPSBDU0wuZGVtb3RlTm9pc2VXb3JkcyhzdGF0ZSwgcHJpbWFyeSwgdGhpc1tcImxlYWRpbmctbm9pc2Utd29yZHNcIl0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHNlY29uZGFyeSB8fCB0ZXJ0aWFyeSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5vcGVuTGV2ZWwoXCJlbXB0eVwiKTtcbiAgICAgICAgICAgICAgICBwcmltYXJ5X3Rvay5zdHJpbmdzLnN1ZmZpeCA9IHByaW1hcnlfdG9rLnN0cmluZ3Muc3VmZml4LnJlcGxhY2UoL1sgLixdKyQvLFwiXCIpO1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQocHJpbWFyeSwgcHJpbWFyeV90b2spO1xuICAgICAgICAgICAgICAgIGlmIChzZWNvbmRhcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCA9IHN0YXRlLm9wdC5jaXRlQWZmaXhlc1tsYW5nUHJlZnNdW3Nsb3Quc2Vjb25kYXJ5XS5wcmVmaXg7XG4gICAgICAgICAgICAgICAgICAgIHNlY29uZGFyeV90b2suc3RyaW5ncy5zdWZmaXggPSBzdGF0ZS5vcHQuY2l0ZUFmZml4ZXNbbGFuZ1ByZWZzXVtzbG90LnNlY29uZGFyeV0uc3VmZml4O1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXNlY29uZGFyeV90b2suc3RyaW5ncy5wcmVmaXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlY29uZGFyeV90b2suc3RyaW5ncy5wcmVmaXggPSBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gc2Vjb25kYXJ5X3Rvay5kZWNvcmF0aW9ucy5sZW5ndGggLSAxOyBpID4gLTE7IGkgKz0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChbJ0BxdW90ZXMvdHJ1ZScsICdAZm9udC1zdHlsZS9pdGFsaWMnLCAnQGZvbnQtc3R5bGUvb2JsaXF1ZScsICdAZm9udC13ZWlnaHQvYm9sZCddLmluZGV4T2Yoc2Vjb25kYXJ5X3Rvay5kZWNvcmF0aW9uc1tpXS5qb2luKCcvJykpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWNvbmRhcnlfdG9rLmRlY29yYXRpb25zID0gc2Vjb25kYXJ5X3Rvay5kZWNvcmF0aW9ucy5zbGljZSgwLCBpKS5jb25jYXQoc2Vjb25kYXJ5X3Rvay5kZWNvcmF0aW9ucy5zbGljZShpICsgMSkpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlY29uZGFyeV9sb2NhbGUgIT09IFwiZW5cIiAmJiBzZWNvbmRhcnlfdG9rLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl0gPT09IFwidGl0bGVcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5X3Rvay5zdHJpbmdzW1widGV4dC1jYXNlXCJdID0gXCJwYXNzdGhyb3VnaFwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciBzZWNvbmRhcnlfb3V0ZXIgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgICAgICAgICAgICAgICAgIHNlY29uZGFyeV9vdXRlci5kZWNvcmF0aW9ucy5wdXNoKFtcIkBmb250LXN0eWxlXCIsIFwibm9ybWFsXCJdKTtcbiAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5X291dGVyLmRlY29yYXRpb25zLnB1c2goW1wiQGZvbnQtd2VpZ2h0XCIsIFwibm9ybWFsXCJdKTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChzZWNvbmRhcnlfb3V0ZXIpO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHNlY29uZGFyeSwgc2Vjb25kYXJ5X3Rvayk7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5jbG9zZUxldmVsKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBibG9iX29iaiA9IHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBibG9ic19wb3MgPSBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLmJsb2JzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5wYXJhbGxlbC51c2VfcGFyYWxsZWxzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5jaXRlLmZyb250LnB1c2godmFyaWFibGVzWzBdICsgXCI6c2Vjb25kYXJ5XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucGFyYWxsZWwuY2l0ZVt2YXJpYWJsZXNbMF0gKyBcIjpzZWNvbmRhcnlcIl0gPSB7YmxvYnM6W1tibG9iX29iaiwgYmxvYnNfcG9zXV19O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0ZXJ0aWFyeSkge1xuICAgICAgICAgICAgICAgICAgICB0ZXJ0aWFyeV90b2suc3RyaW5ncy5wcmVmaXggPSBzdGF0ZS5vcHQuY2l0ZUFmZml4ZXNbbGFuZ1ByZWZzXVtzbG90LnRlcnRpYXJ5XS5wcmVmaXg7XG4gICAgICAgICAgICAgICAgICAgIHRlcnRpYXJ5X3Rvay5zdHJpbmdzLnN1ZmZpeCA9IHN0YXRlLm9wdC5jaXRlQWZmaXhlc1tsYW5nUHJlZnNdW3Nsb3QudGVydGlhcnldLnN1ZmZpeDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZXJ0aWFyeV90b2suc3RyaW5ncy5wcmVmaXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlcnRpYXJ5X3Rvay5zdHJpbmdzLnByZWZpeCA9IFwiIFwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSB0ZXJ0aWFyeV90b2suZGVjb3JhdGlvbnMubGVuZ3RoIC0gMTsgaSA+IC0xOyBpICs9IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoWydAcXVvdGVzL3RydWUnLCAnQGZvbnQtc3R5bGUvaXRhbGljJywgJ0Bmb250LXN0eWxlL29ibGlxdWUnLCAnQGZvbnQtd2VpZ2h0L2JvbGQnXS5pbmRleE9mKHRlcnRpYXJ5X3Rvay5kZWNvcmF0aW9uc1tpXS5qb2luKCcvJykpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXJ0aWFyeV90b2suZGVjb3JhdGlvbnMgPSB0ZXJ0aWFyeV90b2suZGVjb3JhdGlvbnMuc2xpY2UoMCwgaSkuY29uY2F0KHRlcnRpYXJ5X3Rvay5kZWNvcmF0aW9ucy5zbGljZShpICsgMSkpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRlcnRpYXJ5X2xvY2FsZSAhPT0gXCJlblwiICYmIHRlcnRpYXJ5X3Rvay5zdHJpbmdzW1widGV4dC1jYXNlXCJdID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlcnRpYXJ5X3Rvay5zdHJpbmdzW1widGV4dC1jYXNlXCJdID0gXCJwYXNzdGhyb3VnaFwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciB0ZXJ0aWFyeV9vdXRlciA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgdGVydGlhcnlfb3V0ZXIuZGVjb3JhdGlvbnMucHVzaChbXCJAZm9udC1zdHlsZVwiLCBcIm5vcm1hbFwiXSk7XG4gICAgICAgICAgICAgICAgICAgIHRlcnRpYXJ5X291dGVyLmRlY29yYXRpb25zLnB1c2goW1wiQGZvbnQtd2VpZ2h0XCIsIFwibm9ybWFsXCJdKTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0Lm9wZW5MZXZlbCh0ZXJ0aWFyeV9vdXRlcik7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQodGVydGlhcnksIHRlcnRpYXJ5X3Rvayk7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5jbG9zZUxldmVsKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBibG9iX29iaiA9IHN0YXRlLm91dHB1dC5jdXJyZW50LnZhbHVlKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBibG9ic19wb3MgPSBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLmJsb2JzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5wYXJhbGxlbC51c2VfcGFyYWxsZWxzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5jaXRlLmZyb250LnB1c2godmFyaWFibGVzWzBdICsgXCI6dGVydGlhcnlcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wYXJhbGxlbC5jaXRlW3ZhcmlhYmxlc1swXSArIFwiOnRlcnRpYXJ5XCJdID0ge2Jsb2JzOltbYmxvYl9vYmosIGJsb2JzX3Bvc11dfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuY2xvc2VMZXZlbCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKHByaW1hcnksIHByaW1hcnlfdG9rKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9O1xuICAgIH1cbiAgICB0aGlzLmdldE91dHB1dEZ1bmN0aW9uID0gZ2V0T3V0cHV0RnVuY3Rpb247XG4gICAgZnVuY3Rpb24gcXVhc2hDaGVjayh2YWx1ZSkge1xuICAgICAgICB2YXIgbSA9IHZhbHVlLm1hdGNoKC9eIShbLSxfYS16XSspPj4+Lyk7XG4gICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICB2YXIgZmllbGRzID0gbVsxXS5zcGxpdChcIixcIik7XG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnNsaWNlKG1bMF0ubGVuZ3RoKTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gZmllbGRzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZG9uZV92YXJzLmluZGV4T2YoZmllbGRzW2ldKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmRvbmVfdmFycy5wdXNoKGZpZWxkc1tpXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gICAgdGhpcy5xdWFzaENoZWNrID0gcXVhc2hDaGVjaztcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5Ub2tlbiA9IGZ1bmN0aW9uIChuYW1lLCB0b2tlbnR5cGUpIHtcbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgIHRoaXMuc3RyaW5ncyA9IHt9O1xuICAgIHRoaXMuc3RyaW5ncy5kZWxpbWl0ZXIgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5zdHJpbmdzLnByZWZpeCA9IFwiXCI7XG4gICAgdGhpcy5zdHJpbmdzLnN1ZmZpeCA9IFwiXCI7XG4gICAgdGhpcy5kZWNvcmF0aW9ucyA9IFtdO1xuICAgIHRoaXMudmFyaWFibGVzID0gW107XG4gICAgdGhpcy5leGVjcyA9IFtdO1xuICAgIHRoaXMudG9rZW50eXBlID0gdG9rZW50eXBlO1xuICAgIHRoaXMuZXZhbHVhdG9yID0gZmFsc2U7XG4gICAgdGhpcy50ZXN0cyA9IFtdO1xuICAgIHRoaXMucmF3dGVzdHMgPSBbXTtcbiAgICB0aGlzLnN1Y2NlZWQgPSBmYWxzZTtcbiAgICB0aGlzLmZhaWwgPSBmYWxzZTtcbiAgICB0aGlzLm5leHQgPSBmYWxzZTtcbn07XG5DU0wuVXRpbC5jbG9uZVRva2VuID0gZnVuY3Rpb24gKHRva2VuKSB7XG4gICAgdmFyIG5ld3Rvaywga2V5LCBwb3MsIGxlbjtcbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHRva2VuKSB7XG4gICAgICAgIHJldHVybiB0b2tlbjtcbiAgICB9XG4gICAgbmV3dG9rID0gbmV3IENTTC5Ub2tlbih0b2tlbi5uYW1lLCB0b2tlbi50b2tlbnR5cGUpO1xuICAgIGZvciAodmFyIGtleSBpbiB0b2tlbi5zdHJpbmdzKSB7XG4gICAgICAgIGlmICh0b2tlbi5zdHJpbmdzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgIG5ld3Rvay5zdHJpbmdzW2tleV0gPSB0b2tlbi5zdHJpbmdzW2tleV07XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRva2VuLmRlY29yYXRpb25zKSB7XG4gICAgICAgIG5ld3Rvay5kZWNvcmF0aW9ucyA9IFtdO1xuICAgICAgICBmb3IgKHBvcyA9IDAsIGxlbiA9IHRva2VuLmRlY29yYXRpb25zLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgbmV3dG9rLmRlY29yYXRpb25zLnB1c2godG9rZW4uZGVjb3JhdGlvbnNbcG9zXS5zbGljZSgpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodG9rZW4udmFyaWFibGVzKSB7XG4gICAgICAgIG5ld3Rvay52YXJpYWJsZXMgPSB0b2tlbi52YXJpYWJsZXMuc2xpY2UoKTtcbiAgICB9XG4gICAgaWYgKHRva2VuLmV4ZWNzKSB7XG4gICAgICAgIG5ld3Rvay5leGVjcyA9IHRva2VuLmV4ZWNzLnNsaWNlKCk7XG4gICAgICAgIG5ld3Rvay50ZXN0cyA9IHRva2VuLnRlc3RzLnNsaWNlKCk7XG4gICAgICAgIG5ld3Rvay5yYXd0ZXN0cyA9IHRva2VuLnRlc3RzLnNsaWNlKCk7XG4gICAgfVxuICAgIHJldHVybiBuZXd0b2s7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuQW1iaWdDb25maWcgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5tYXh2YWxzID0gW107XG4gICAgdGhpcy5taW52YWwgPSAxO1xuICAgIHRoaXMubmFtZXMgPSBbXTtcbiAgICB0aGlzLmdpdmVucyA9IFtdO1xuICAgIHRoaXMueWVhcl9zdWZmaXggPSBmYWxzZTtcbiAgICB0aGlzLmRpc2FtYmlndWF0ZSA9IDA7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuQmxvYiA9IGZ1bmN0aW9uIChzdHIsIHRva2VuLCBsZXZlbG5hbWUpIHtcbiAgICB2YXIgbGVuLCBwb3MsIGtleTtcbiAgICB0aGlzLmxldmVsbmFtZSA9IGxldmVsbmFtZTtcbiAgICBpZiAodG9rZW4pIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzID0ge1wicHJlZml4XCI6XCJcIixcInN1ZmZpeFwiOlwiXCJ9O1xuICAgICAgICBmb3IgKHZhciBrZXkgaW4gdG9rZW4uc3RyaW5ncykge1xuICAgICAgICAgICAgaWYgKHRva2VuLnN0cmluZ3MuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RyaW5nc1trZXldID0gdG9rZW4uc3RyaW5nc1trZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGVjb3JhdGlvbnMgPSBbXTtcbiAgICAgICAgaWYgKHRva2VuLmRlY29yYXRpb25zID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGxlbiA9IDA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZW4gPSB0b2tlbi5kZWNvcmF0aW9ucy5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICB0aGlzLmRlY29yYXRpb25zLnB1c2godG9rZW4uZGVjb3JhdGlvbnNbcG9zXS5zbGljZSgpKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHt9O1xuICAgICAgICB0aGlzLnN0cmluZ3MucHJlZml4ID0gXCJcIjtcbiAgICAgICAgdGhpcy5zdHJpbmdzLnN1ZmZpeCA9IFwiXCI7XG4gICAgICAgIHRoaXMuc3RyaW5ncy5kZWxpbWl0ZXIgPSBcIlwiO1xuICAgICAgICB0aGlzLmRlY29yYXRpb25zID0gW107XG4gICAgfVxuICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2Ygc3RyKSB7XG4gICAgICAgIHRoaXMuYmxvYnMgPSBzdHI7XG4gICAgfSBlbHNlIGlmIChzdHIpIHtcbiAgICAgICAgdGhpcy5ibG9icyA9IFtzdHJdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuYmxvYnMgPSBbXTtcbiAgICB9XG4gICAgdGhpcy5hbGxkZWNvciA9IFt0aGlzLmRlY29yYXRpb25zXTtcbn07XG5DU0wuQmxvYi5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uIChibG9iKSB7XG4gICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiB0aGlzLmJsb2JzKSB7XG4gICAgICAgIHRocm93IFwiQXR0ZW1wdCB0byBwdXNoIGJsb2Igb250byBzdHJpbmcgb2JqZWN0XCI7XG4gICAgfSBlbHNlIGlmIChmYWxzZSAhPT0gYmxvYikge1xuICAgICAgICBibG9iLmFsbGRlY29yID0gYmxvYi5hbGxkZWNvci5jb25jYXQodGhpcy5hbGxkZWNvcik7XG4gICAgICAgIHRoaXMuYmxvYnMucHVzaChibG9iKTtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuTnVtZXJpY0Jsb2IgPSBmdW5jdGlvbiAocGFydGljbGUsIG51bSwgbW90aGVyX3Rva2VuLCBpZCkge1xuICAgIHRoaXMuaWQgPSBpZDtcbiAgICB0aGlzLmFsbGRlY29yID0gW107XG4gICAgdGhpcy5udW0gPSBudW07XG4gICAgdGhpcy5wYXJ0aWNsZSA9IHBhcnRpY2xlO1xuICAgIHRoaXMuYmxvYnMgPSBudW0udG9TdHJpbmcoKTtcbiAgICB0aGlzLnN0YXR1cyA9IENTTC5TVEFSVDtcbiAgICB0aGlzLnN0cmluZ3MgPSB7fTtcbiAgICBpZiAobW90aGVyX3Rva2VuKSB7XG4gICAgICAgIHRoaXMuZ2VuZGVyID0gbW90aGVyX3Rva2VuLmdlbmRlcjtcbiAgICAgICAgdGhpcy5kZWNvcmF0aW9ucyA9IG1vdGhlcl90b2tlbi5kZWNvcmF0aW9ucztcbiAgICAgICAgdGhpcy5zdHJpbmdzLnByZWZpeCA9IG1vdGhlcl90b2tlbi5zdHJpbmdzLnByZWZpeDtcbiAgICAgICAgdGhpcy5zdHJpbmdzLnN1ZmZpeCA9IG1vdGhlcl90b2tlbi5zdHJpbmdzLnN1ZmZpeDtcbiAgICAgICAgdGhpcy5zdHJpbmdzW1widGV4dC1jYXNlXCJdID0gbW90aGVyX3Rva2VuLnN0cmluZ3NbXCJ0ZXh0LWNhc2VcIl07XG4gICAgICAgIHRoaXMuc3VjY2Vzc29yX3ByZWZpeCA9IG1vdGhlcl90b2tlbi5zdWNjZXNzb3JfcHJlZml4O1xuICAgICAgICB0aGlzLnJhbmdlX3ByZWZpeCA9IG1vdGhlcl90b2tlbi5yYW5nZV9wcmVmaXg7XG4gICAgICAgIHRoaXMuc3BsaWNlX3ByZWZpeCA9IG1vdGhlcl90b2tlbi5zcGxpY2VfcHJlZml4O1xuICAgICAgICB0aGlzLmZvcm1hdHRlciA9IG1vdGhlcl90b2tlbi5mb3JtYXR0ZXI7XG4gICAgICAgIGlmICghdGhpcy5mb3JtYXR0ZXIpIHtcbiAgICAgICAgICAgIHRoaXMuZm9ybWF0dGVyID0gIG5ldyBDU0wuT3V0cHV0LkRlZmF1bHRGb3JtYXR0ZXIoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5mb3JtYXR0ZXIpIHtcbiAgICAgICAgICAgIHRoaXMudHlwZSA9IHRoaXMuZm9ybWF0dGVyLmZvcm1hdCgxKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZGVjb3JhdGlvbnMgPSBbXTtcbiAgICAgICAgdGhpcy5zdHJpbmdzLnByZWZpeCA9IFwiXCI7XG4gICAgICAgIHRoaXMuc3RyaW5ncy5zdWZmaXggPSBcIlwiO1xuICAgICAgICB0aGlzLnN1Y2Nlc3Nvcl9wcmVmaXggPSBcIlwiO1xuICAgICAgICB0aGlzLnJhbmdlX3ByZWZpeCA9IFwiXCI7XG4gICAgICAgIHRoaXMuc3BsaWNlX3ByZWZpeCA9IFwiXCI7XG4gICAgICAgIHRoaXMuZm9ybWF0dGVyID0gbmV3IENTTC5PdXRwdXQuRGVmYXVsdEZvcm1hdHRlcigpO1xuICAgIH1cbn07XG5DU0wuTnVtZXJpY0Jsb2IucHJvdG90eXBlLnNldEZvcm1hdHRlciA9IGZ1bmN0aW9uIChmb3JtYXR0ZXIpIHtcbiAgICB0aGlzLmZvcm1hdHRlciA9IGZvcm1hdHRlcjtcbiAgICB0aGlzLnR5cGUgPSB0aGlzLmZvcm1hdHRlci5mb3JtYXQoMSk7XG59O1xuQ1NMLk91dHB1dC5EZWZhdWx0Rm9ybWF0dGVyID0gZnVuY3Rpb24gKCkge307XG5DU0wuT3V0cHV0LkRlZmF1bHRGb3JtYXR0ZXIucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uIChudW0pIHtcbiAgICByZXR1cm4gbnVtLnRvU3RyaW5nKCk7XG59O1xuQ1NMLk51bWVyaWNCbG9iLnByb3RvdHlwZS5jaGVja05leHQgPSBmdW5jdGlvbiAobmV4dCxzdGFydCkge1xuICAgIGlmIChzdGFydCkge1xuICAgICAgICB0aGlzLnN0YXR1cyA9IENTTC5TVEFSVDtcbiAgICAgICAgaWYgKFwib2JqZWN0XCIgPT09IHR5cGVvZiBuZXh0KSB7XG4gICAgICAgICAgICBpZiAobmV4dC5udW0gPT09ICh0aGlzLm51bSArIDEpKSB7XG4gICAgICAgICAgICAgICAgbmV4dC5zdGF0dXMgPSBDU0wuU1VDQ0VTU09SO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXh0LnN0YXR1cyA9IENTTC5TRUVOO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSBlbHNlIGlmICghIG5leHQgfHwgIW5leHQubnVtIHx8IHRoaXMudHlwZSAhPT0gbmV4dC50eXBlIHx8IG5leHQubnVtICE9PSAodGhpcy5udW0gKyAxKSkge1xuICAgICAgICBpZiAodGhpcy5zdGF0dXMgPT09IENTTC5TVUNDRVNTT1JfT0ZfU1VDQ0VTU09SKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXR1cyA9IENTTC5FTkQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwib2JqZWN0XCIgPT09IHR5cGVvZiBuZXh0KSB7IFxuICAgICAgICAgICBuZXh0LnN0YXR1cyA9IENTTC5TRUVOO1xuICAgICAgICB9XG4gICAgfSBlbHNlIHsgLy8gbmV4dCBudW1iZXIgaXMgaW4gdGhlIHNlcXVlbmNlXG4gICAgICAgIGlmICh0aGlzLnN0YXR1cyA9PT0gQ1NMLlNUQVJUIHx8IHRoaXMuc3RhdHVzID09PSBDU0wuU0VFTikge1xuICAgICAgICAgICAgbmV4dC5zdGF0dXMgPSBDU0wuU1VDQ0VTU09SO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdHVzID09PSBDU0wuU1VDQ0VTU09SIHx8IHRoaXMuc3RhdHVzID09PSBDU0wuU1VDQ0VTU09SX09GX1NVQ0NFU1NPUikge1xuICAgICAgICAgICAgaWYgKHRoaXMucmFuZ2VfcHJlZml4KSB7XG4gICAgICAgICAgICAgICAgbmV4dC5zdGF0dXMgPSBDU0wuU1VDQ0VTU09SX09GX1NVQ0NFU1NPUjtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cyA9IENTTC5TVVBQUkVTUztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbmV4dC5zdGF0dXMgPSBDU0wuU1VDQ0VTU09SO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5OdW1lcmljQmxvYi5wcm90b3R5cGUuY2hlY2tMYXN0ID0gZnVuY3Rpb24gKGxhc3QpIHtcbiAgICBpZiAodGhpcy5zdGF0dXMgPT09IENTTC5TRUVOIFxuICAgIHx8IChsYXN0Lm51bSAhPT0gKHRoaXMubnVtIC0gMSkgJiYgdGhpcy5zdGF0dXMgPT09IENTTC5TVUNDRVNTT1IpKSB7XG4gICAgICAgIHRoaXMuc3RhdHVzID0gQ1NMLlNVQ0NFU1NPUjtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5VdGlsLmZpeERhdGVOb2RlID0gZnVuY3Rpb24gKHBhcmVudCwgcG9zLCBub2RlKSB7XG4gICAgdmFyIGZvcm0sIHZhcmlhYmxlLCBkYXRleG1sLCBzdWJub2RlLCBwYXJ0bmFtZSwgYXR0ciwgdmFsLCBwcmVmaXgsIHN1ZmZpeCwgY2hpbGRyZW4sIGtleSwgc3ViY2hpbGRyZW4sIGtrZXksIGRpc3BsYXksIGNzbGlkO1xuICAgIHZhciBsaW5nbyA9IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGUsIFwibGluZ29cIik7XG4gICAgdmFyIGRlZmF1bHRfbG9jYWxlID0gdGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUobm9kZSwgXCJkZWZhdWx0LWxvY2FsZVwiKTtcbiAgICB0aGlzLmJ1aWxkLmRhdGVfa2V5ID0gdHJ1ZTtcbiAgICBmb3JtID0gdGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUobm9kZSwgXCJmb3JtXCIpO1xuICAgIHZhciBsaW5nbztcbiAgICBpZiAoZGVmYXVsdF9sb2NhbGUpIHtcbiAgICAgICAgbGluZ28gPSB0aGlzLm9wdFtcImRlZmF1bHQtbG9jYWxlXCJdWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxpbmdvID0gdGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUobm9kZSwgXCJsaW5nb1wiKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmdldERhdGUoZm9ybSwgZGVmYXVsdF9sb2NhbGUpKSB7XG4gICAgICAgIHJldHVybiBwYXJlbnQ7XG4gICAgfVxuICAgIHZhciBkYXRlcGFydHMgPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShub2RlLCBcImRhdGUtcGFydHNcIik7XG4gICAgdmFyaWFibGUgPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShub2RlLCBcInZhcmlhYmxlXCIpO1xuICAgIHByZWZpeCA9IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGUsIFwicHJlZml4XCIpO1xuICAgIHN1ZmZpeCA9IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGUsIFwic3VmZml4XCIpO1xuICAgIGRpc3BsYXkgPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShub2RlLCBcImRpc3BsYXlcIik7XG4gICAgY3NsaWQgPSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShub2RlLCBcImNzbGlkXCIpO1xuICAgIGRhdGV4bWwgPSB0aGlzLmNzbFhtbC5ub2RlQ29weSh0aGlzLmdldERhdGUoZm9ybSwgZGVmYXVsdF9sb2NhbGUpKTtcbiAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGUoZGF0ZXhtbCwgJ2xpbmdvJywgdGhpcy5vcHQubGFuZyk7XG4gICAgdGhpcy5jc2xYbWwuc2V0QXR0cmlidXRlKGRhdGV4bWwsICdmb3JtJywgZm9ybSk7XG4gICAgdGhpcy5jc2xYbWwuc2V0QXR0cmlidXRlKGRhdGV4bWwsICdkYXRlLXBhcnRzJywgZGF0ZXBhcnRzKTtcbiAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGUoZGF0ZXhtbCwgXCJjc2xpZFwiLCBjc2xpZCk7XG4gICAgdGhpcy5jc2xYbWwuc2V0QXR0cmlidXRlKGRhdGV4bWwsICd2YXJpYWJsZScsIHZhcmlhYmxlKTtcbiAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGUoZGF0ZXhtbCwgJ2RlZmF1bHQtbG9jYWxlJywgZGVmYXVsdF9sb2NhbGUpO1xuICAgIGlmIChwcmVmaXgpIHtcbiAgICAgICAgdGhpcy5jc2xYbWwuc2V0QXR0cmlidXRlKGRhdGV4bWwsIFwicHJlZml4XCIsIHByZWZpeCk7XG4gICAgfVxuICAgIGlmIChzdWZmaXgpIHtcbiAgICAgICAgdGhpcy5jc2xYbWwuc2V0QXR0cmlidXRlKGRhdGV4bWwsIFwic3VmZml4XCIsIHN1ZmZpeCk7XG4gICAgfVxuICAgIGlmIChkaXNwbGF5KSB7XG4gICAgICAgIHRoaXMuY3NsWG1sLnNldEF0dHJpYnV0ZShkYXRleG1sLCBcImRpc3BsYXlcIiwgZGlzcGxheSk7XG4gICAgfVxuICAgIGNoaWxkcmVuID0gdGhpcy5jc2xYbWwuY2hpbGRyZW4oZGF0ZXhtbCk7XG4gICAgZm9yICh2YXIga2V5IGluIGNoaWxkcmVuKSB7XG4gICAgICAgIHN1Ym5vZGUgPSBjaGlsZHJlbltrZXldO1xuICAgICAgICBpZiAoXCJkYXRlLXBhcnRcIiA9PT0gdGhpcy5jc2xYbWwubm9kZW5hbWUoc3Vibm9kZSkpIHtcbiAgICAgICAgICAgIHBhcnRuYW1lID0gdGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUoc3Vibm9kZSwgXCJuYW1lXCIpO1xuICAgICAgICAgICAgaWYgKGRlZmF1bHRfbG9jYWxlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jc2xYbWwuc2V0QXR0cmlidXRlT25Ob2RlSWRlbnRpZmllZEJ5TmFtZUF0dHJpYnV0ZShkYXRleG1sLCBcImRhdGUtcGFydFwiLCBwYXJ0bmFtZSwgXCJAZGVmYXVsdC1sb2NhbGVcIiwgXCJ0cnVlXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGNoaWxkcmVuID0gdGhpcy5jc2xYbWwuY2hpbGRyZW4obm9kZSk7XG4gICAgZm9yICh2YXIga2V5IGluIGNoaWxkcmVuKSB7XG4gICAgICAgIHN1Ym5vZGUgPSBjaGlsZHJlbltrZXldO1xuICAgICAgICBpZiAoXCJkYXRlLXBhcnRcIiA9PT0gdGhpcy5jc2xYbWwubm9kZW5hbWUoc3Vibm9kZSkpIHtcbiAgICAgICAgICAgIHBhcnRuYW1lID0gdGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUoc3Vibm9kZSwgXCJuYW1lXCIpO1xuICAgICAgICAgICAgc3ViY2hpbGRyZW4gPSB0aGlzLmNzbFhtbC5hdHRyaWJ1dGVzKHN1Ym5vZGUpO1xuICAgICAgICAgICAgZm9yIChhdHRyIGluIHN1YmNoaWxkcmVuKSB7XG4gICAgICAgICAgICAgICAgaWYgKFwiQG5hbWVcIiA9PT0gYXR0cikge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGxpbmdvICYmIGxpbmdvICE9PSB0aGlzLm9wdC5sYW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChbXCJAc3VmZml4XCIsIFwiQHByZWZpeFwiLCBcIkBmb3JtXCJdLmluZGV4T2YoYXR0cikgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFsID0gc3ViY2hpbGRyZW5bYXR0cl07XG4gICAgICAgICAgICAgICAgdGhpcy5jc2xYbWwuc2V0QXR0cmlidXRlT25Ob2RlSWRlbnRpZmllZEJ5TmFtZUF0dHJpYnV0ZShkYXRleG1sLCBcImRhdGUtcGFydFwiLCBwYXJ0bmFtZSwgYXR0ciwgdmFsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoXCJ5ZWFyXCIgPT09IHRoaXMuY3NsWG1sLmdldEF0dHJpYnV0ZVZhbHVlKG5vZGUsIFwiZGF0ZS1wYXJ0c1wiKSkge1xuICAgICAgICB0aGlzLmNzbFhtbC5kZWxldGVOb2RlQnlOYW1lQXR0cmlidXRlKGRhdGV4bWwsICdtb250aCcpO1xuICAgICAgICB0aGlzLmNzbFhtbC5kZWxldGVOb2RlQnlOYW1lQXR0cmlidXRlKGRhdGV4bWwsICdkYXknKTtcbiAgICB9IGVsc2UgaWYgKFwieWVhci1tb250aFwiID09PSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShub2RlLCBcImRhdGUtcGFydHNcIikpIHtcbiAgICAgICAgdGhpcy5jc2xYbWwuZGVsZXRlTm9kZUJ5TmFtZUF0dHJpYnV0ZShkYXRleG1sLCAnZGF5Jyk7XG4gICAgfSBlbHNlIGlmIChcIm1vbnRoLWRheVwiID09PSB0aGlzLmNzbFhtbC5nZXRBdHRyaWJ1dGVWYWx1ZShub2RlLCBcImRhdGUtcGFydHNcIikpIHtcbiAgICAgICAgdmFyIGNoaWxkTm9kZXMgPSB0aGlzLmNzbFhtbC5jaGlsZHJlbihkYXRleG1sKTtcbiAgICAgICAgZm9yICh2YXIgaT0xLGlsZW49dGhpcy5jc2xYbWwubnVtYmVyb2Zub2RlcyhjaGlsZE5vZGVzKTtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jc2xYbWwuZ2V0QXR0cmlidXRlVmFsdWUoY2hpbGROb2Rlc1tpXSwgJ25hbWUnKSA9PT0gXCJ5ZWFyXCIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNzbFhtbC5zZXRBdHRyaWJ1dGUoY2hpbGROb2Rlc1tpLTFdLCBcInN1ZmZpeFwiLCBcIlwiKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNzbFhtbC5kZWxldGVOb2RlQnlOYW1lQXR0cmlidXRlKGRhdGV4bWwsICd5ZWFyJyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmNzbFhtbC5pbnNlcnRDaGlsZE5vZGVBZnRlcihwYXJlbnQsIG5vZGUsIHBvcywgZGF0ZXhtbCk7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuZGF0ZU1hY3JvQXNTb3J0S2V5ID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgQ1NMLmRhdGVBc1NvcnRLZXkuY2FsbCh0aGlzLCBzdGF0ZSwgSXRlbSwgdHJ1ZSk7XG59O1xuQ1NMLmRhdGVBc1NvcnRLZXkgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGlzTWFjcm8pIHtcbiAgICB2YXIgZHAsIGVsZW0sIHZhbHVlLCBlLCB5ciwgcHJlZml4LCBpLCBpbGVuLCBudW07XG4gICAgdmFyIHZhcmlhYmxlID0gdGhpcy52YXJpYWJsZXNbMF07XG4gICAgdmFyIG1hY3JvRmxhZyA9IFwiZW1wdHlcIjtcbiAgICBpZiAoaXNNYWNybyAmJiBzdGF0ZS50bXAuZXh0ZW5zaW9uKSB7XG4gICAgICAgIG1hY3JvRmxhZyA9IFwibWFjcm8td2l0aC1kYXRlXCI7XG4gICAgfVxuICAgIGRwID0gSXRlbVt2YXJpYWJsZV07XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBkcCkge1xuICAgICAgICBkcCA9IHtcImRhdGUtcGFydHNcIjogW1swXV0gfTtcbiAgICAgICAgaWYgKCFkcC55ZWFyKSB7XG4gICAgICAgICAgICBzdGF0ZS50bXAuZW1wdHlfZGF0ZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLmRhdGVwYXJ0cykge1xuICAgICAgICB0aGlzLmRhdGVwYXJ0cyA9IFtcInllYXJcIiwgXCJtb250aFwiLCBcImRheVwiXTtcbiAgICB9XG4gICAgaWYgKGRwLnJhdykge1xuICAgICAgICBkcCA9IHN0YXRlLmZ1bi5kYXRlcGFyc2VyLnBhcnNlRGF0ZVRvQXJyYXkoZHAucmF3KTtcbiAgICB9IGVsc2UgaWYgKGRwW1wiZGF0ZS1wYXJ0c1wiXSkge1xuICAgICAgICBkcCA9IHN0YXRlLmRhdGVQYXJzZUFycmF5KGRwKTtcbiAgICB9XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBkcCkge1xuICAgICAgICBkcCA9IHt9O1xuICAgIH1cbiAgICBmb3IgKGkgPSAwLCBpbGVuID0gQ1NMLkRBVEVfUEFSVFNfSU5URVJOQUwubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGVsZW0gPSBDU0wuREFURV9QQVJUU19JTlRFUk5BTFtpXTtcbiAgICAgICAgdmFsdWUgPSAwO1xuICAgICAgICBlID0gZWxlbTtcbiAgICAgICAgaWYgKGUuc2xpY2UoLTQpID09PSBcIl9lbmRcIikge1xuICAgICAgICAgICAgZSA9IGUuc2xpY2UoMCwgLTQpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkcFtlbGVtXSAmJiB0aGlzLmRhdGVwYXJ0cy5pbmRleE9mKGUpID4gLTEpIHtcbiAgICAgICAgICAgIHZhbHVlID0gZHBbZWxlbV07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVsZW0uc2xpY2UoMCwgNCkgPT09IFwieWVhclwiKSB7XG4gICAgICAgICAgICB5ciA9IENTTC5VdGlsLkRhdGVzW2VdLm51bWVyaWMoc3RhdGUsIHZhbHVlKTtcbiAgICAgICAgICAgIHZhciBwcmVmaXggPSBcIllcIjtcbiAgICAgICAgICAgIGlmICh5clswXSA9PT0gXCItXCIpIHtcbiAgICAgICAgICAgICAgICBwcmVmaXggPSBcIlhcIjtcbiAgICAgICAgICAgICAgICB5ciA9IHlyLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgIHlyID0gOTk5OSAtIHBhcnNlSW50KHlyLCAxMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKENTTC5VdGlsLkRhdGVzW2VsZW0uc2xpY2UoMCwgNCldLm51bWVyaWMoc3RhdGUsIChwcmVmaXggKyB5cikpLCBtYWNyb0ZsYWcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFsdWUgPSBDU0wuVXRpbC5EYXRlc1tlXVtcIm51bWVyaWMtbGVhZGluZy16ZXJvc1wiXShzdGF0ZSwgdmFsdWUpO1xuICAgICAgICAgICAgaWYgKCF2YWx1ZSkge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gXCIwMFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGUub3V0cHV0LmFwcGVuZCh2YWx1ZSwgbWFjcm9GbGFnKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuRW5naW5lLnByb3RvdHlwZS5kYXRlUGFyc2VBcnJheSA9IGZ1bmN0aW9uIChkYXRlX29iaikge1xuICAgIHZhciByZXQsIGZpZWxkLCBkcG9zLCBwcG9zLCBkcCwgZXh0cywgbGxlbiwgcG9zLCBsZW4sIHBwcG9zLCBsbGxlbjtcbiAgICByZXQgPSB7fTtcbiAgICBmb3IgKGZpZWxkIGluIGRhdGVfb2JqKSB7XG4gICAgICAgIGlmIChmaWVsZCA9PT0gXCJkYXRlLXBhcnRzXCIpIHtcbiAgICAgICAgICAgIGRwID0gZGF0ZV9vYmpbXCJkYXRlLXBhcnRzXCJdO1xuICAgICAgICAgICAgaWYgKGRwLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoZHBbMF0ubGVuZ3RoICE9PSBkcFsxXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgQ1NMLmVycm9yKFwiQ1NMIGRhdGEgZXJyb3I6IGVsZW1lbnQgbWlzbWF0Y2ggaW4gZGF0ZSByYW5nZSBpbnB1dC5cIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZXh0cyA9IFtcIlwiLCBcIl9lbmRcIl07XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IGRwLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBqbGVuID0gQ1NMLkRBVEVfUEFSVFMubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgZHBbaV1bal0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldFsoQ1NMLkRBVEVfUEFSVFNbal0gKyBleHRzW2ldKV0gPSBkcFtpXVtqXTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldFsoQ1NMLkRBVEVfUEFSVFNbal0gKyBleHRzW2ldKV0gPSBwYXJzZUludChkcFtpXVtqXSwgMTApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGRhdGVfb2JqLmhhc093blByb3BlcnR5KGZpZWxkKSkge1xuICAgICAgICAgICAgaWYgKGZpZWxkID09PSBcImxpdGVyYWxcIiAmJiBcIm9iamVjdFwiID09PSB0eXBlb2YgZGF0ZV9vYmoubGl0ZXJhbCAmJiBcInN0cmluZ1wiID09PSB0eXBlb2YgZGF0ZV9vYmoubGl0ZXJhbC5wYXJ0KSB7XG4gICAgICAgICAgICAgICAgQ1NMLmRlYnVnKFwiV2FybmluZzogZml4aW5nIHVwIHdlaXJkIGxpdGVyYWwgZGF0ZSB2YWx1ZVwiKTtcbiAgICAgICAgICAgICAgICByZXQubGl0ZXJhbCA9IGRhdGVfb2JqLmxpdGVyYWwucGFydDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0W2ZpZWxkXSA9IGRhdGVfb2JqW2ZpZWxkXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlV0aWwuTmFtZXMgPSB7fTtcbkNTTC5VdGlsLk5hbWVzLmNvbXBhcmVOYW1lc2V0cyA9IENTTC5OYW1lT3V0cHV0LnByb3RvdHlwZS5fY29tcGFyZU5hbWVzZXRzO1xuQ1NMLlV0aWwuTmFtZXMudW5Jbml0aWFsaXplID0gZnVuY3Rpb24gKHN0YXRlLCBuYW1lKSB7XG4gICAgdmFyIGksIGlsZW4sIG5hbWVsaXN0LCBwdW5jdGxpc3QsIHJldDtcbiAgICBpZiAoIW5hbWUpIHtcbiAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuICAgIG5hbWVsaXN0ID0gbmFtZS5zcGxpdCgvKD86XFwtfFxccyspLyk7XG4gICAgcHVuY3RsaXN0ID0gbmFtZS5tYXRjaCgvKFxcLXxcXHMrKS9nKTtcbiAgICByZXQgPSBcIlwiO1xuICAgIGZvciAoaSA9IDAsIGlsZW4gPSBuYW1lbGlzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgcmV0ICs9IG5hbWVsaXN0W2ldO1xuICAgICAgICBpZiAoaSA8IGlsZW4gLSAxKSB7XG4gICAgICAgICAgICByZXQgKz0gcHVuY3RsaXN0W2ldO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLlV0aWwuTmFtZXMuaW5pdGlhbGl6ZVdpdGggPSBmdW5jdGlvbiAoc3RhdGUsIG5hbWUsIHRlcm1pbmF0b3IsIG5vcm1hbGl6ZU9ubHkpIHtcbiAgICB2YXIgaSwgaWxlbiwgaiwgamxlbiwgbiwgbSwgbW0sIHN0ciwgbHN0LCByZXQ7XG4gICAgaWYgKCFuYW1lKSB7XG4gICAgICAgIHJldHVybiBcIlwiO1xuICAgIH1cbiAgICBpZiAoIXRlcm1pbmF0b3IpIHtcbiAgICAgICAgdGVybWluYXRvciA9IFwiXCI7XG4gICAgfVxuICAgIGlmIChbXCJMb3JkXCIsIFwiTGFkeVwiXS5pbmRleE9mKG5hbWUpID4gLTFcbiAgICAgICAgfHwgKCFuYW1lLm1hdGNoKENTTC5TVEFSVFNXSVRIX1JPTUFORVNRVUVfUkVHRVhQKVxuICAgICAgICAgICAgJiYgIXRlcm1pbmF0b3IubWF0Y2goXCIlc1wiKSkpIHtcbiAgICAgICAgcmV0dXJuIG5hbWU7XG4gICAgfVxuICAgIHZhciBuYW1lbGlzdCA9IG5hbWU7XG4gICAgaWYgKHN0YXRlLm9wdFtcImluaXRpYWxpemUtd2l0aC1oeXBoZW5cIl0gPT09IGZhbHNlKSB7XG4gICAgICAgIG5hbWVsaXN0ID0gbmFtZWxpc3QucmVwbGFjZSgvXFwtL2csIFwiIFwiKTtcbiAgICB9XG4gICAgbmFtZWxpc3QgPSBuYW1lbGlzdC5yZXBsYWNlKC9cXHMqXFwtXFxzKi9nLCBcIi1cIikucmVwbGFjZSgvXFxzKy9nLCBcIiBcIik7XG4gICAgbmFtZWxpc3QgPSBuYW1lbGlzdC5yZXBsYWNlKC8tKFthLXpdKS9nLCBcIlxcdTIwMTMkMVwiKTtcbiAgICBtbSA9IG5hbWVsaXN0Lm1hdGNoKC9bXFwtXFxzXSsvZyk7XG4gICAgbHN0ID0gbmFtZWxpc3Quc3BsaXQoL1tcXC1cXHNdKy8pO1xuICAgIGlmIChsc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIG5hbWVsaXN0ID0gbW07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbmFtZWxpc3QgPSBbbHN0WzBdXTtcbiAgICAgICAgZm9yIChpID0gMSwgaWxlbiA9IGxzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIG5hbWVsaXN0LnB1c2gobW1baSAtIDFdKTtcbiAgICAgICAgICAgIG5hbWVsaXN0LnB1c2gobHN0W2ldKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBsc3QgPSBuYW1lbGlzdDtcbiAgICBmb3IgKGkgPSBsc3QubGVuZ3RoIC0xOyBpID4gLTE7IGkgKz0gLTEpIHtcbiAgICAgICAgaWYgKGxzdFtpXSAmJiBsc3RbaV0uc2xpY2UoMCwgLTEpLmluZGV4T2YoXCIuXCIpID4gLTEpIHtcbiAgICAgICAgICAgIHZhciBsc3RlbmQgPSBsc3Quc2xpY2UoaSArIDEpO1xuICAgICAgICAgICAgdmFyIGxzdG1pZCA9IGxzdFtpXS5zbGljZSgwLCAtMSkuc3BsaXQoXCIuXCIpO1xuICAgICAgICAgICAgbHN0ID0gbHN0LnNsaWNlKDAsIGkpO1xuICAgICAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IGxzdG1pZC5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICBsc3QucHVzaChsc3RtaWRbal0gKyBcIi5cIik7XG4gICAgICAgICAgICAgICAgaWYgKGogPCBsc3RtaWQubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgICAgICBsc3QucHVzaChcIiBcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbHN0ID0gbHN0LmNvbmNhdChsc3RlbmQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChub3JtYWxpemVPbmx5KSB7XG4gICAgICAgIHJldCA9IENTTC5VdGlsLk5hbWVzLmRvTm9ybWFsaXplKHN0YXRlLCBsc3QsIHRlcm1pbmF0b3IpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldCA9IENTTC5VdGlsLk5hbWVzLmRvSW5pdGlhbGl6ZShzdGF0ZSwgbHN0LCB0ZXJtaW5hdG9yKTtcbiAgICB9XG4gICAgcmV0ID0gcmV0LnJlcGxhY2UoL1xcdTIwMTMoW2Etel0pL2csIFwiLSQxXCIpO1xuICAgIHJldHVybiByZXQ7XG59O1xuQ1NMLlV0aWwuTmFtZXMuZG9Ob3JtYWxpemUgPSBmdW5jdGlvbiAoc3RhdGUsIG5hbWVsaXN0LCB0ZXJtaW5hdG9yLCBtb2RlKSB7XG4gICAgdmFyIGksIGlsZW47XG4gICAgdGVybWluYXRvciA9IHRlcm1pbmF0b3IgPyB0ZXJtaW5hdG9yIDogXCJcIjtcbiAgICB2YXIgaXNBYmJyZXYgPSBbXTtcbiAgICBmb3IgKGkgPSAwLCBpbGVuID0gbmFtZWxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIGlmIChuYW1lbGlzdFtpXS5sZW5ndGggPiAxICYmIG5hbWVsaXN0W2ldLnNsaWNlKC0xKSA9PT0gXCIuXCIpIHtcbiAgICAgICAgICAgIG5hbWVsaXN0W2ldID0gbmFtZWxpc3RbaV0uc2xpY2UoMCwgLTEpO1xuICAgICAgICAgICAgaXNBYmJyZXYucHVzaCh0cnVlKTtcbiAgICAgICAgfSBlbHNlIGlmIChuYW1lbGlzdFtpXS5sZW5ndGggPT09IDEgJiYgbmFtZWxpc3RbaV0udG9VcHBlckNhc2UoKSA9PT0gbmFtZWxpc3RbaV0pIHtcbiAgICAgICAgICAgIGlzQWJicmV2LnB1c2godHJ1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpc0FiYnJldi5wdXNoKGZhbHNlKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgcmV0ID0gW107XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IG5hbWVsaXN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMikge1xuICAgICAgICBpZiAoaXNBYmJyZXZbaV0pIHtcbiAgICAgICAgICAgIGlmIChpIDwgbmFtZWxpc3QubGVuZ3RoIC0gMikge1xuICAgICAgICAgICAgICAgIG5hbWVsaXN0W2kgKyAxXSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgaWYgKCghdGVybWluYXRvciB8fCB0ZXJtaW5hdG9yLnNsaWNlKC0xKSAmJiB0ZXJtaW5hdG9yLnNsaWNlKC0xKSAhPT0gXCIgXCIpXG4gICAgICAgICAgICAgICAgICAgICYmIG5hbWVsaXN0W2ldLmxlbmd0aCAmJiBuYW1lbGlzdFtpXS5tYXRjaChDU0wuQUxMX1JPTUFORVNRVUVfUkVHRVhQKVxuICAgICAgICAgICAgICAgICAgICAmJiAobmFtZWxpc3RbaV0ubGVuZ3RoID4gMSB8fCBuYW1lbGlzdFtpICsgMl0ubGVuZ3RoID4gMSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZWxpc3RbaSArIDFdID0gXCIgXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChuYW1lbGlzdFtpICsgMl0ubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICBuYW1lbGlzdFtpXSA9IG5hbWVsaXN0W2ldICsgdGVybWluYXRvci5yZXBsYWNlKC9bXFx1MDAwOVxcdTAwMGFcXHUwMDBiXFx1MDAwY1xcdTAwMGRcXHUwMDIwXFx1ZmVmZlxcdTAwYTBdKyQvLCBcIlwiKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuYW1lbGlzdFtpXSA9IG5hbWVsaXN0W2ldICsgdGVybWluYXRvcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaSA9PT0gbmFtZWxpc3QubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgIG5hbWVsaXN0W2ldID0gbmFtZWxpc3RbaV0gKyB0ZXJtaW5hdG9yO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBuYW1lbGlzdC5qb2luKFwiXCIpLnJlcGxhY2UoL1tcXHUwMDA5XFx1MDAwYVxcdTAwMGJcXHUwMDBjXFx1MDAwZFxcdTAwMjBcXHVmZWZmXFx1MDBhMF0rJC8sXCJcIikucmVwbGFjZSgvXFxzKlxcLVxccyovZywgXCItXCIpLnJlcGxhY2UoL1tcXHUwMDA5XFx1MDAwYVxcdTAwMGJcXHUwMDBjXFx1MDAwZFxcdTAwMjBdKy9nLCBcIiBcIik7XG59O1xuQ1NMLlV0aWwuTmFtZXMuZG9Jbml0aWFsaXplID0gZnVuY3Rpb24gKHN0YXRlLCBuYW1lbGlzdCwgdGVybWluYXRvciwgbW9kZSkge1xuICAgIHZhciBpLCBpbGVuLCBtLCBqLCBqbGVuLCBsc3QsIG47XG4gICAgZm9yIChpID0gMCwgaWxlbiA9IG5hbWVsaXN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMikge1xuICAgICAgICBuID0gbmFtZWxpc3RbaV07XG4gICAgICAgIGlmICghbikge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgbSA9IG4ubWF0Y2goQ1NMLk5BTUVfSU5JVElBTF9SRUdFWFApO1xuICAgICAgICBpZiAoIW0gJiYgKCFuLm1hdGNoKENTTC5TVEFSVFNXSVRIX1JPTUFORVNRVUVfUkVHRVhQKSAmJiBuLmxlbmd0aCA+IDEgJiYgdGVybWluYXRvci5tYXRjaChcIiVzXCIpKSkge1xuICAgICAgICAgICAgbSA9IG4ubWF0Y2goLyguKSguKikvKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobSAmJiBtWzFdID09PSBtWzFdLnRvVXBwZXJDYXNlKCkpIHtcbiAgICAgICAgICAgIHZhciBleHRyYSA9IFwiXCI7XG4gICAgICAgICAgICBpZiAobVsyXSkge1xuICAgICAgICAgICAgICAgIHZhciBzID0gXCJcIjtcbiAgICAgICAgICAgICAgICBsc3QgPSBtWzJdLnNwbGl0KFwiXCIpO1xuICAgICAgICAgICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBsc3QubGVuZ3RoOyBqIDwgamxlbjsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjID0gbHN0W2pdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYyA9PT0gYy50b1VwcGVyQ2FzZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzICs9IGM7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5sZW5ndGggPCBtWzJdLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBleHRyYSA9IHMudG9Mb2NhbGVMb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuYW1lbGlzdFtpXSA9IG1bMV0udG9Mb2NhbGVVcHBlckNhc2UoKSArIGV4dHJhO1xuICAgICAgICAgICAgaWYgKGkgPCAoaWxlbiAtIDEpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRlcm1pbmF0b3IubWF0Y2goXCIlc1wiKSkge1xuICAgICAgICAgICAgICAgICAgICBuYW1lbGlzdFtpXSA9IHRlcm1pbmF0b3IucmVwbGFjZShcIiVzXCIsIG5hbWVsaXN0W2ldKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAobmFtZWxpc3RbaSArIDFdLmluZGV4T2YoXCItXCIpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVsaXN0W2kgKyAxXSA9IHRlcm1pbmF0b3IgKyBuYW1lbGlzdFtpICsgMV07XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lbGlzdFtpICsgMV0gPSB0ZXJtaW5hdG9yO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAodGVybWluYXRvci5tYXRjaChcIiVzXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVsaXN0W2ldID0gdGVybWluYXRvci5yZXBsYWNlKFwiJXNcIiwgbmFtZWxpc3RbaV0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVsaXN0LnB1c2godGVybWluYXRvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKG4ubWF0Y2goQ1NMLlJPTUFORVNRVUVfUkVHRVhQKSkge1xuICAgICAgICAgICAgbmFtZWxpc3RbaV0gPSBcIiBcIiArIG47XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHJldCA9IG5hbWVsaXN0LmpvaW4oXCJcIik7XG4gICAgcmV0ID0gcmV0LnJlcGxhY2UoL1tcXHUwMDA5XFx1MDAwYVxcdTAwMGJcXHUwMDBjXFx1MDAwZFxcdTAwMjBcXHVmZWZmXFx1MDBhMF0rJC8sXCJcIikucmVwbGFjZSgvXFxzKlxcLVxccyovZywgXCItXCIpLnJlcGxhY2UoL1tcXHUwMDA5XFx1MDAwYVxcdTAwMGJcXHUwMDBjXFx1MDAwZFxcdTAwMjBdKy9nLCBcIiBcIik7XG4gICAgcmV0dXJuIHJldDtcbn07XG5DU0wuVXRpbC5OYW1lcy5nZXRSYXdOYW1lID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgICB2YXIgcmV0ID0gW107XG4gICAgaWYgKG5hbWUuZ2l2ZW4pIHtcbiAgICAgICAgcmV0LnB1c2gobmFtZS5naXZlbik7XG4gICAgfVxuICAgIGlmIChuYW1lLmZhbWlseSkge1xuICAgICAgICByZXQucHVzaChuYW1lLmZhbWlseSk7XG4gICAgfVxuICAgIHJldHVybiByZXQuam9pbihcIiBcIik7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuVXRpbC5EYXRlcyA9IHt9O1xuQ1NMLlV0aWwuRGF0ZXMueWVhciA9IHt9O1xuQ1NMLlV0aWwuRGF0ZXMueWVhcltcImxvbmdcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIG51bSkge1xuICAgIGlmICghbnVtKSB7XG4gICAgICAgIGlmIChcImJvb2xlYW5cIiA9PT0gdHlwZW9mIG51bSkge1xuICAgICAgICAgICAgbnVtID0gXCJcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG51bSA9IDA7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bS50b1N0cmluZygpO1xufTtcbkNTTC5VdGlsLkRhdGVzLnllYXIuaW1wZXJpYWwgPSBmdW5jdGlvbiAoc3RhdGUsIG51bSwgZW5kLCBtYWtlU2hvcnQpIHtcbiAgICB2YXIgeWVhciA9IFwiXCI7XG4gICAgaWYgKCFudW0pIHtcbiAgICAgICAgaWYgKFwiYm9vbGVhblwiID09PSB0eXBlb2YgbnVtKSB7XG4gICAgICAgICAgICBudW0gPSBcIlwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbnVtID0gMDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbmQgPSBlbmQgPyBcIl9lbmRcIiA6IFwiXCI7XG4gICAgdmFyIG1vbnRoID0gc3RhdGUudG1wLmRhdGVfb2JqZWN0W1wibW9udGhcIiArIGVuZF07XG4gICAgbW9udGggPSBtb250aCA/IFwiXCIrbW9udGggOiBcIjFcIjtcbiAgICB3aGlsZSAobW9udGgubGVuZ3RoIDwgMikge1xuICAgICAgICBtb250aCA9IFwiMFwiICsgbW9udGg7XG4gICAgfVxuICAgIHZhciBkYXkgPSBzdGF0ZS50bXAuZGF0ZV9vYmplY3RbXCJkYXlcIiArIGVuZF07XG4gICAgZGF5ID0gZGF5ID8gXCJcIitkYXkgOiBcIjFcIjtcbiAgICB3aGlsZSAoZGF5Lmxlbmd0aCA8IDIpIHtcbiAgICAgICAgZGF5ID0gXCIwXCIgKyBkYXk7XG4gICAgfVxuICAgIHZhciBkYXRlID0gcGFyc2VJbnQobnVtICsgbW9udGggKyBkYXksIDEwKTtcbiAgICB2YXIgbGFiZWw7XG4gICAgdmFyIG9mZnNldDtcbiAgICBpZiAoZGF0ZSA+PSAxODY4MDkwOCAmJiBkYXRlIDwgMTkxMjA3MzApIHtcbiAgICAgICAgbGFiZWwgPSAnXFx1NjYwZVxcdTZjYmInO1xuICAgICAgICBvZmZzZXQgPSAxODY3O1xuICAgIH0gZWxzZSBpZiAoZGF0ZSA+PSAxOTEyMDczMCAmJiBkYXRlIDwgMTkyNjEyMjUpIHtcbiAgICAgICAgbGFiZWwgPSAnXFx1NTkyN1xcdTZiNjMnO1xuICAgICAgICBvZmZzZXQgPSAxOTExO1xuICAgIH0gZWxzZSBpZiAoZGF0ZSA+PSAxOTI2MTIyNSAmJiBkYXRlIDwgMTk4OTAxMDgpIHtcbiAgICAgICAgbGFiZWwgPSAnXFx1NjYyZFxcdTU0OGMnO1xuICAgICAgICBvZmZzZXQgPSAxOTI1O1xuICAgIH0gZWxzZSBpZiAoZGF0ZSA+PSAxOTg5MDEwOCkge1xuICAgICAgICBsYWJlbCA9ICdcXHU1ZTczXFx1NjIxMCc7XG4gICAgICAgIG9mZnNldCA9IDE5ODg7XG4gICAgfVxuICAgIGlmIChsYWJlbCAmJiBvZmZzZXQpIHtcbiAgICAgICAgdmFyIG5vcm1hbGl6ZWRLZXkgPSBsYWJlbDtcbiAgICAgICAgaWYgKHN0YXRlLnN5cy5ub3JtYWxpemVBYmJyZXZzS2V5KSB7XG4gICAgICAgICAgICBub3JtYWxpemVkS2V5ID0gc3RhdGUuc3lzLm5vcm1hbGl6ZUFiYnJldnNLZXkobGFiZWwpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghc3RhdGUudHJhbnNmb3JtLmFiYnJldnNbJ2RlZmF1bHQnXVsnbnVtYmVyJ11bbm9ybWFsaXplZEtleV0pIHtcbiAgICAgICAgICAgIHN0YXRlLnRyYW5zZm9ybS5sb2FkQWJicmV2aWF0aW9uKCdkZWZhdWx0JywgXCJudW1iZXJcIiwgbm9ybWFsaXplZEtleSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzWydkZWZhdWx0J11bJ251bWJlciddW25vcm1hbGl6ZWRLZXldKSB7XG4gICAgICAgICAgICBsYWJlbCA9IHN0YXRlLnRyYW5zZm9ybS5hYmJyZXZzWydkZWZhdWx0J11bJ251bWJlciddW25vcm1hbGl6ZWRLZXldO1xuICAgICAgICB9O1xuICAgICAgICB5ZWFyID0gbGFiZWwgKyAobnVtIC0gb2Zmc2V0KTtcbiAgICB9XG4gICAgcmV0dXJuIHllYXI7XG59O1xuQ1NMLlV0aWwuRGF0ZXMueWVhcltcInNob3J0XCJdID0gZnVuY3Rpb24gKHN0YXRlLCBudW0pIHtcbiAgICBudW0gPSBudW0udG9TdHJpbmcoKTtcbiAgICBpZiAobnVtICYmIG51bS5sZW5ndGggPT09IDQpIHtcbiAgICAgICAgcmV0dXJuIG51bS5zdWJzdHIoMik7XG4gICAgfVxufTtcbkNTTC5VdGlsLkRhdGVzLnllYXIubnVtZXJpYyA9IGZ1bmN0aW9uIChzdGF0ZSwgbnVtKSB7XG4gICAgdmFyIG0sIHByZTtcbiAgICBudW0gPSBcIlwiICsgbnVtO1xuICAgIHZhciBtID0gbnVtLm1hdGNoKC8oWzAtOV0qKSQvKTtcbiAgICBpZiAobSkge1xuICAgICAgICBwcmUgPSBudW0uc2xpY2UoMCwgbVsxXS5sZW5ndGggKiAtMSk7XG4gICAgICAgIG51bSA9IG1bMV07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcHJlID0gbnVtO1xuICAgICAgICBudW0gPSBcIlwiO1xuICAgIH1cbiAgICB3aGlsZSAobnVtLmxlbmd0aCA8IDQpIHtcbiAgICAgICAgbnVtID0gXCIwXCIgKyBudW07XG4gICAgfVxuICAgIHJldHVybiAocHJlICsgbnVtKTtcbn07XG5DU0wuVXRpbC5EYXRlcy5ub3JtYWxpemVNb250aCA9IGZ1bmN0aW9uIChudW0sIHVzZVNlYXNvbikge1xuICAgIHZhciByZXQ7XG4gICAgaWYgKCFudW0pIHtcbiAgICAgICAgbnVtID0gMDtcbiAgICB9XG4gICAgbnVtID0gXCJcIiArIG51bTtcbiAgICBpZiAoIW51bS5tYXRjaCgvXlswLTldKyQvKSkge1xuICAgICAgICBudW0gPSAwO1xuICAgIH1cbiAgICBudW0gPSBwYXJzZUludChudW0sIDEwKTtcbiAgICBpZiAodXNlU2Vhc29uKSB7XG4gICAgICAgIHZhciByZXMgPSB7c3R1YjogXCJtb250aC1cIiwgbnVtOiBudW19O1xuICAgICAgICBpZiAocmVzLm51bSA8IDEgfHwgcmVzLm51bSA+IDIwKSB7XG4gICAgICAgICAgICByZXMubnVtID0gMDtcbiAgICAgICAgfSBlbHNlIGlmIChyZXMubnVtID4gMTYpIHtcbiAgICAgICAgICAgIHJlcy5zdHViID0gXCJzZWFzb24tXCI7XG4gICAgICAgICAgICByZXMubnVtID0gcmVzLm51bSAtIDE2O1xuICAgICAgICB9IGVsc2UgaWYgKHJlcy5udW0gPiAxMikge1xuICAgICAgICAgICAgcmVzLnN0dWIgPSBcInNlYXNvbi1cIjtcbiAgICAgICAgICAgIHJlcy5udW0gPSByZXMubnVtIC0gMTI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0ID0gcmVzO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChudW0gPCAxIHx8IG51bSA+IDEyKSB7XG4gICAgICAgICAgICBudW0gPSAwO1xuICAgICAgICB9XG4gICAgICAgIHJldCA9IG51bTtcbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn1cbkNTTC5VdGlsLkRhdGVzLm1vbnRoID0ge307XG5DU0wuVXRpbC5EYXRlcy5tb250aC5udW1lcmljID0gZnVuY3Rpb24gKHN0YXRlLCBudW0pIHtcbiAgICB2YXIgbnVtID0gQ1NMLlV0aWwuRGF0ZXMubm9ybWFsaXplTW9udGgobnVtKTtcbiAgICBpZiAoIW51bSkge1xuICAgICAgICBudW0gPSBcIlwiO1xuICAgIH1cbiAgICByZXR1cm4gbnVtO1xufTtcbkNTTC5VdGlsLkRhdGVzLm1vbnRoW1wibnVtZXJpYy1sZWFkaW5nLXplcm9zXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBudW0pIHtcbiAgICB2YXIgbnVtID0gQ1NMLlV0aWwuRGF0ZXMubm9ybWFsaXplTW9udGgobnVtKTtcbiAgICBpZiAoIW51bSkge1xuICAgICAgICBudW0gPSBcIlwiO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG51bSA9IFwiXCIgKyBudW07XG4gICAgICAgIHdoaWxlIChudW0ubGVuZ3RoIDwgMikge1xuICAgICAgICAgICAgbnVtID0gXCIwXCIgKyBudW07XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bTtcbn07XG5DU0wuVXRpbC5EYXRlcy5tb250aFtcImxvbmdcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIG51bSwgZ2VuZGVyLCBmb3JjZURlZmF1bHRMb2NhbGUpIHtcbiAgICB2YXIgcmVzID0gQ1NMLlV0aWwuRGF0ZXMubm9ybWFsaXplTW9udGgobnVtLCB0cnVlKTtcbiAgICB2YXIgbnVtID0gcmVzLm51bTtcbiAgICBpZiAoIW51bSkge1xuICAgICAgICBudW0gPSBcIlwiO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG51bSA9IFwiXCIgKyBudW07XG4gICAgICAgIHdoaWxlIChudW0ubGVuZ3RoIDwgMikge1xuICAgICAgICAgICAgbnVtID0gXCIwXCIgKyBudW07XG4gICAgICAgIH1cbiAgICAgICAgbnVtID0gc3RhdGUuZ2V0VGVybShyZXMuc3R1YiArIG51bSwgXCJsb25nXCIsIDAsIDAsIGZhbHNlLCBmb3JjZURlZmF1bHRMb2NhbGUpO1xuICAgIH1cbiAgICByZXR1cm4gbnVtO1xufTtcbkNTTC5VdGlsLkRhdGVzLm1vbnRoW1wic2hvcnRcIl0gPSBmdW5jdGlvbiAoc3RhdGUsIG51bSwgZ2VuZGVyLCBmb3JjZURlZmF1bHRMb2NhbGUpIHtcbiAgICB2YXIgcmVzID0gQ1NMLlV0aWwuRGF0ZXMubm9ybWFsaXplTW9udGgobnVtLCB0cnVlKTtcbiAgICB2YXIgbnVtID0gcmVzLm51bTtcbiAgICBpZiAoIW51bSkge1xuICAgICAgICBudW0gPSBcIlwiO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG51bSA9IFwiXCIgKyBudW07XG4gICAgICAgIHdoaWxlIChudW0ubGVuZ3RoIDwgMikge1xuICAgICAgICAgICAgbnVtID0gXCIwXCIgKyBudW07XG4gICAgICAgIH1cbiAgICAgICAgbnVtID0gc3RhdGUuZ2V0VGVybShyZXMuc3R1YiArIG51bSwgXCJzaG9ydFwiLCAwLCAwLCBmYWxzZSwgZm9yY2VEZWZhdWx0TG9jYWxlKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bTtcbn07XG5DU0wuVXRpbC5EYXRlcy5kYXkgPSB7fTtcbkNTTC5VdGlsLkRhdGVzLmRheS5udW1lcmljID0gZnVuY3Rpb24gKHN0YXRlLCBudW0pIHtcbiAgICByZXR1cm4gbnVtLnRvU3RyaW5nKCk7XG59O1xuQ1NMLlV0aWwuRGF0ZXMuZGF5W1wibG9uZ1wiXSA9IENTTC5VdGlsLkRhdGVzLmRheS5udW1lcmljO1xuQ1NMLlV0aWwuRGF0ZXMuZGF5W1wibnVtZXJpYy1sZWFkaW5nLXplcm9zXCJdID0gZnVuY3Rpb24gKHN0YXRlLCBudW0pIHtcbiAgICBpZiAoIW51bSkge1xuICAgICAgICBudW0gPSAwO1xuICAgIH1cbiAgICBudW0gPSBudW0udG9TdHJpbmcoKTtcbiAgICB3aGlsZSAobnVtLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgbnVtID0gXCIwXCIgKyBudW07XG4gICAgfVxuICAgIHJldHVybiBudW0udG9TdHJpbmcoKTtcbn07XG5DU0wuVXRpbC5EYXRlcy5kYXkub3JkaW5hbCA9IGZ1bmN0aW9uIChzdGF0ZSwgbnVtLCBnZW5kZXIpIHtcbiAgICByZXR1cm4gc3RhdGUuZnVuLm9yZGluYWxpemVyLmZvcm1hdChudW0sIGdlbmRlcik7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuVXRpbC5Tb3J0ID0ge307XG5DU0wuVXRpbC5Tb3J0LnN0cmlwX3ByZXBvc2l0aW9ucyA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICB2YXIgbTtcbiAgICBpZiAoXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHN0cikge1xuICAgICAgICBtID0gc3RyLnRvTG9jYWxlTG93ZXJDYXNlKCk7XG4gICAgICAgIG0gPSBzdHIubWF0Y2goL14oKGF8YW58dGhlKVxccyspLyk7XG4gICAgfVxuICAgIGlmIChtKSB7XG4gICAgICAgIHN0ciA9IHN0ci5zdWJzdHIobVsxXS5sZW5ndGgpO1xuICAgIH1cbiAgICByZXR1cm4gc3RyO1xufTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlV0aWwuc3Vic3RpdHV0ZVN0YXJ0ID0gZnVuY3Rpb24gKHN0YXRlLCB0YXJnZXQpIHtcbiAgICB2YXIgZWxlbWVudF90cmFjZSwgZGlzcGxheSwgYmliX2ZpcnN0LCBmdW5jLCBjaG9vc2Vfc3RhcnQsIGlmX3N0YXJ0LCBub2RldHlwZXM7XG4gICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMuZGVjb3JhdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICBpZiAoXCJAc3RyaXAtcGVyaW9kc1wiID09PSB0aGlzLmRlY29yYXRpb25zW2ldWzBdICYmIFwidHJ1ZVwiID09PSB0aGlzLmRlY29yYXRpb25zW2ldWzFdKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUudG1wLnN0cmlwX3BlcmlvZHMgKz0gMTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgIGlmICh0aGlzLmRlY29yYXRpb25zICYmIChzdGF0ZS5vcHQuZGV2ZWxvcG1lbnRfZXh0ZW5zaW9ucy5jc2xfcmV2ZXJzZV9sb29rdXBfc3VwcG9ydCB8fCBzdGF0ZS5zeXMuY3NsX3JldmVyc2VfbG9va3VwX3N1cHBvcnQpKSB7XG4gICAgICAgIHRoaXMuZGVjb3JhdGlvbnMucmV2ZXJzZSgpO1xuICAgICAgICB0aGlzLmRlY29yYXRpb25zLnB1c2goW1wiQHNob3dpZFwiLFwidHJ1ZVwiLCB0aGlzLmNzbGlkXSk7XG4gICAgICAgIHRoaXMuZGVjb3JhdGlvbnMucmV2ZXJzZSgpO1xuICAgIH1cbiAgICBub2RldHlwZXMgPSBbXCJudW1iZXJcIiwgXCJkYXRlXCIsIFwibmFtZXNcIl07XG4gICAgaWYgKChcInRleHRcIiA9PT0gdGhpcy5uYW1lICYmICF0aGlzLnBvc3Rwb25lZF9tYWNybykgfHwgbm9kZXR5cGVzLmluZGV4T2YodGhpcy5uYW1lKSA+IC0xKSB7XG4gICAgICAgIGVsZW1lbnRfdHJhY2UgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0sIGl0ZW0pIHtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuZWxlbWVudF90cmFjZS52YWx1ZSgpID09PSBcImF1dGhvclwiIHx8IFwibmFtZXNcIiA9PT0gdGhpcy5uYW1lKSB7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbVtcImF1dGhvci1vbmx5XCJdKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5lbGVtZW50X3RyYWNlLnB1c2goXCJkby1ub3Qtc3VwcHJlc3MtbWVcIik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpdGVtICYmIGl0ZW1bXCJzdXBwcmVzcy1hdXRob3JcIl0pIHtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW1bXCJhdXRob3Itb25seVwiXSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuZWxlbWVudF90cmFjZS5wdXNoKFwic3VwcHJlc3MtbWVcIik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpdGVtICYmIGl0ZW1bXCJzdXBwcmVzcy1hdXRob3JcIl0pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmVsZW1lbnRfdHJhY2UucHVzaChcImRvLW5vdC1zdXBwcmVzcy1tZVwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChlbGVtZW50X3RyYWNlKTtcbiAgICB9XG4gICAgZGlzcGxheSA9IHRoaXMuc3RyaW5ncy5jbHM7XG4gICAgdGhpcy5zdHJpbmdzLmNscyA9IGZhbHNlO1xuICAgIGlmIChzdGF0ZS5idWlsZC5yZW5kZXJfbmVzdGluZ19sZXZlbCA9PT0gMCkge1xuICAgICAgICBpZiAoc3RhdGUuYnVpbGQuYXJlYSA9PT0gXCJiaWJsaW9ncmFwaHlcIiAmJiBzdGF0ZS5iaWJsaW9ncmFwaHkub3B0W1wic2Vjb25kLWZpZWxkLWFsaWduXCJdKSB7XG4gICAgICAgICAgICBiaWJfZmlyc3QgPSBuZXcgQ1NMLlRva2VuKFwiZ3JvdXBcIiwgQ1NMLlNUQVJUKTtcbiAgICAgICAgICAgIGJpYl9maXJzdC5kZWNvcmF0aW9ucyA9IFtbXCJAZGlzcGxheVwiLCBcImxlZnQtbWFyZ2luXCJdXTtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5yZW5kZXJfc2Vlbikge1xuICAgICAgICAgICAgICAgICAgICBiaWJfZmlyc3Quc3RyaW5ncy5maXJzdF9ibG9iID0gSXRlbS5pZDtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LnN0YXJ0VGFnKFwiYmliX2ZpcnN0XCIsIGJpYl9maXJzdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJpYl9maXJzdC5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgdGFyZ2V0LnB1c2goYmliX2ZpcnN0KTtcbiAgICAgICAgfSBlbHNlIGlmIChDU0wuRElTUExBWV9DTEFTU0VTLmluZGV4T2YoZGlzcGxheSkgPiAtMSkge1xuICAgICAgICAgICAgYmliX2ZpcnN0ID0gbmV3IENTTC5Ub2tlbihcImdyb3VwXCIsIENTTC5TVEFSVCk7XG4gICAgICAgICAgICBiaWJfZmlyc3QuZGVjb3JhdGlvbnMgPSBbW1wiQGRpc3BsYXlcIiwgZGlzcGxheV1dO1xuICAgICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgICAgIGJpYl9maXJzdC5zdHJpbmdzLmZpcnN0X2Jsb2IgPSBJdGVtLmlkO1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5zdGFydFRhZyhcImJpYl9maXJzdFwiLCBiaWJfZmlyc3QpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJpYl9maXJzdC5leGVjcy5wdXNoKGZ1bmMpO1xuICAgICAgICAgICAgdGFyZ2V0LnB1c2goYmliX2ZpcnN0KTtcbiAgICAgICAgfVxuICAgICAgICBzdGF0ZS5idWlsZC5jbHMgPSBkaXNwbGF5O1xuICAgIH1cbiAgICBzdGF0ZS5idWlsZC5yZW5kZXJfbmVzdGluZ19sZXZlbCArPSAxO1xuICAgIGlmIChzdGF0ZS5idWlsZC5zdWJzdGl0dXRlX2xldmVsLnZhbHVlKCkgPT09IDEpIHtcbiAgICAgICAgY2hvb3NlX3N0YXJ0ID0gbmV3IENTTC5Ub2tlbihcImNob29zZVwiLCBDU0wuU1RBUlQpO1xuICAgICAgICBDU0wuTm9kZS5jaG9vc2UuYnVpbGQuY2FsbChjaG9vc2Vfc3RhcnQsIHN0YXRlLCB0YXJnZXQpO1xuICAgICAgICBpZl9zdGFydCA9IG5ldyBDU0wuVG9rZW4oXCJpZlwiLCBDU0wuU1RBUlQpO1xuICAgICAgICBmdW5jID0gZnVuY3Rpb24gKEl0ZW0saXRlbSkge1xuICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5jYW5fc3Vic3RpdHV0ZS52YWx1ZSgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH07XG4gICAgICAgIGlmX3N0YXJ0LnRlc3RzLnB1c2goZnVuYyk7XG4gICAgICAgIGlmX3N0YXJ0LnRlc3QgPSBzdGF0ZS5mdW4ubWF0Y2guYW55KHRoaXMsIHN0YXRlLCBpZl9zdGFydC50ZXN0cyk7XG4gICAgICAgIHRhcmdldC5wdXNoKGlmX3N0YXJ0KTtcbiAgICB9XG4gICAgaWYgKHN0YXRlLnN5cy52YXJpYWJsZVdyYXBwZXJcbiAgICAgICAgJiYgdGhpcy52YXJpYWJsZXNfcmVhbFxuICAgICAgICAmJiB0aGlzLnZhcmlhYmxlc19yZWFsLmxlbmd0aCkge1xuICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtLCBpdGVtKSB7XG4gICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5qdXN0X2xvb2tpbmcgJiYgIXN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgICAgIHZhciB2YXJpYWJsZV9lbnRyeSA9IG5ldyBDU0wuVG9rZW4oXCJ0ZXh0XCIsIENTTC5TVEFSVCk7XG4gICAgICAgICAgICAgICAgdmFyaWFibGVfZW50cnkuZGVjb3JhdGlvbnMgPSBbW1wiQHNob3dpZFwiLCBcInRydWVcIl1dO1xuICAgICAgICAgICAgICAgIHN0YXRlLm91dHB1dC5zdGFydFRhZyhcInZhcmlhYmxlX2VudHJ5XCIsIHZhcmlhYmxlX2VudHJ5KTtcbiAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb24gPSBudWxsO1xuICAgICAgICAgICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gaXRlbS5wb3NpdGlvbjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFwb3NpdGlvbikgcG9zaXRpb24gPSAwO1xuICAgICAgICAgICAgICAgIHZhciBwb3NpdGlvbk1hcCA9IFtcbiAgICAgICAgICAgICAgICAgICAgXCJmaXJzdFwiLFxuICAgICAgICAgICAgICAgICAgICBcInN1YnNlcXVlbnRcIixcbiAgICAgICAgICAgICAgICAgICAgXCJpYmlkXCIsXG4gICAgICAgICAgICAgICAgICAgIFwiaWJpZC13aXRoLWxvY2F0b3JcIlxuICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICB2YXIgbm90ZU51bWJlciA9IDA7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbS5ub3RlSW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgbm90ZU51bWJlciA9IGl0ZW0ubm90ZUluZGV4O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgZmlyc3RSZWZlcmVuY2VOb3RlTnVtYmVyID0gMDtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtWydmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXInXSkge1xuICAgICAgICAgICAgICAgICAgICBmaXJzdFJlZmVyZW5jZU5vdGVOdW1iZXIgPSBpdGVtWydmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXInXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGNpdGF0aW9uTnVtYmVyID0gMDtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtWydjaXRhdGlvbi1udW1iZXInXSkge1xuICAgICAgICAgICAgICAgICAgICBjaXRhdGlvbk51bWJlciA9IGl0ZW1bJ2NpdGF0aW9uLW51bWJlciddO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSAwO1xuICAgICAgICAgICAgICAgIGlmIChpdGVtICYmIGl0ZW0uaW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBpdGVtLmluZGV4O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgcGFyYW1zID0ge1xuICAgICAgICAgICAgICAgICAgICBpdGVtRGF0YTogSXRlbSxcbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGVOYW1lczogdGhpcy52YXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IHN0YXRlLnRtcC5hcmVhLFxuICAgICAgICAgICAgICAgICAgICB4Y2xhc3M6IHN0YXRlLm9wdC54Y2xhc3MsXG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBwb3NpdGlvbk1hcFtwb3NpdGlvbl0sXG4gICAgICAgICAgICAgICAgICAgIFwibm90ZS1udW1iZXJcIjogbm90ZU51bWJlcixcbiAgICAgICAgICAgICAgICAgICAgXCJmaXJzdC1yZWZlcmVuY2Utbm90ZS1udW1iZXJcIjogZmlyc3RSZWZlcmVuY2VOb3RlTnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICBcImNpdGF0aW9uLW51bWJlclwiOiBjaXRhdGlvbk51bWJlcixcbiAgICAgICAgICAgICAgICAgICAgXCJpbmRleFwiOiBpbmRleCxcbiAgICAgICAgICAgICAgICAgICAgXCJtb2RlXCI6IHN0YXRlLm9wdC5tb2RlXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuY3VycmVudC52YWx1ZSgpLnBhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgfVxufTtcbkNTTC5VdGlsLnN1YnN0aXR1dGVFbmQgPSBmdW5jdGlvbiAoc3RhdGUsIHRhcmdldCkge1xuICAgIHZhciBmdW5jLCBiaWJfZmlyc3RfZW5kLCBiaWJfb3RoZXIsIGlmX2VuZCwgY2hvb3NlX2VuZCwgdG9wbGV2ZWwsIGhhc3ZhbCwgYXV0aG9yX3N1YnN0aXR1dGUsIHN0cjtcbiAgICBpZiAoc3RhdGUuc3lzLnZhcmlhYmxlV3JhcHBlclxuICAgICAgICAmJiAodGhpcy5oYXNWYXJpYWJsZSB8fCAodGhpcy52YXJpYWJsZXNfcmVhbCAmJiB0aGlzLnZhcmlhYmxlc19yZWFsLmxlbmd0aCkpKSB7XG4gICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsSXRlbSkge1xuICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAuanVzdF9sb29raW5nICYmICFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuZW5kVGFnKFwidmFyaWFibGVfZW50cnlcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgIH1cbiAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5kZWNvcmF0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGlmIChcIkBzdHJpcC1wZXJpb2RzXCIgPT09IHRoaXMuZGVjb3JhdGlvbnNbaV1bMF0gJiYgXCJ0cnVlXCIgPT09IHRoaXMuZGVjb3JhdGlvbnNbaV1bMV0pIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS50bXAuc3RyaXBfcGVyaW9kcyArPSAtMTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgIHN0YXRlLmJ1aWxkLnJlbmRlcl9uZXN0aW5nX2xldmVsICs9IC0xO1xuICAgIGlmIChzdGF0ZS5idWlsZC5yZW5kZXJfbmVzdGluZ19sZXZlbCA9PT0gMCkge1xuICAgICAgICBpZiAoc3RhdGUuYnVpbGQuY2xzKSB7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmVuZFRhZyhcImJpYl9maXJzdFwiKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICBzdGF0ZS5idWlsZC5jbHMgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS5idWlsZC5hcmVhID09PSBcImJpYmxpb2dyYXBoeVwiICYmIHN0YXRlLmJpYmxpb2dyYXBoeS5vcHRbXCJzZWNvbmQtZmllbGQtYWxpZ25cIl0pIHtcbiAgICAgICAgICAgIGJpYl9maXJzdF9lbmQgPSBuZXcgQ1NMLlRva2VuKFwiZ3JvdXBcIiwgQ1NMLkVORCk7XG4gICAgICAgICAgICBmdW5jID0gZnVuY3Rpb24gKHN0YXRlLCBJdGVtKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS50bXAucmVuZGVyX3NlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUub3V0cHV0LmVuZFRhZyhcImJpYl9maXJzdFwiKTsgLy8gY2xvc2VzIGJpYl9maXJzdFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBiaWJfZmlyc3RfZW5kLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICB0YXJnZXQucHVzaChiaWJfZmlyc3RfZW5kKTtcbiAgICAgICAgICAgIGJpYl9vdGhlciA9IG5ldyBDU0wuVG9rZW4oXCJncm91cFwiLCBDU0wuU1RBUlQpO1xuICAgICAgICAgICAgYmliX290aGVyLmRlY29yYXRpb25zID0gW1tcIkBkaXNwbGF5XCIsIFwicmlnaHQtaW5saW5lXCJdXTtcbiAgICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlLnRtcC5yZW5kZXJfc2Vlbikge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAucmVuZGVyX3NlZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuc3RhcnRUYWcoXCJiaWJfb3RoZXJcIiwgYmliX290aGVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYmliX290aGVyLmV4ZWNzLnB1c2goZnVuYyk7XG4gICAgICAgICAgICB0YXJnZXQucHVzaChiaWJfb3RoZXIpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChzdGF0ZS5idWlsZC5zdWJzdGl0dXRlX2xldmVsLnZhbHVlKCkgPT09IDEpIHtcbiAgICAgICAgaWZfZW5kID0gbmV3IENTTC5Ub2tlbihcImlmXCIsIENTTC5FTkQpO1xuICAgICAgICB0YXJnZXQucHVzaChpZl9lbmQpO1xuICAgICAgICBjaG9vc2VfZW5kID0gbmV3IENTTC5Ub2tlbihcImNob29zZVwiLCBDU0wuRU5EKTtcbiAgICAgICAgQ1NMLk5vZGUuY2hvb3NlLmJ1aWxkLmNhbGwoY2hvb3NlX2VuZCwgc3RhdGUsIHRhcmdldCk7XG4gICAgfVxuICAgIGlmIChcIm5hbWVzXCIgPT09IHRoaXMubmFtZSB8fCAoXCJ0ZXh0XCIgPT09IHRoaXMubmFtZSAmJiB0aGlzLnZhcmlhYmxlc19yZWFsICE9PSBcInRpdGxlXCIpKSB7XG4gICAgICAgIGF1dGhvcl9zdWJzdGl0dXRlID0gbmV3IENTTC5Ub2tlbihcInRleHRcIiwgQ1NMLlNJTkdMRVRPTik7XG4gICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoc3RhdGUsIEl0ZW0pIHtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuYXJlYSAhPT0gXCJiaWJsaW9ncmFwaHlcIikgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgIT09IHR5cGVvZiBzdGF0ZS5iaWJsaW9ncmFwaHkub3B0W1wic3Vic2VxdWVudC1hdXRob3Itc3Vic3RpdHV0ZVwiXSkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKHRoaXMudmFyaWFibGVzX3JlYWwgJiYgIUl0ZW1bdGhpcy52YXJpYWJsZXNfcmVhbF0pIHJldHVybjtcbiAgICAgICAgICAgIGlmIChzdGF0ZS50bXAuc3Vic3RpdHV0ZWRfdmFyaWFibGUgIT09IHRoaXMudmFyaWFibGVzX3JlYWwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgc3VicnVsZSA9IHN0YXRlLmJpYmxpb2dyYXBoeS5vcHRbXCJzdWJzZXF1ZW50LWF1dGhvci1zdWJzdGl0dXRlLXJ1bGVcIl07XG4gICAgICAgICAgICB2YXIgaSwgaWxlbjtcbiAgICAgICAgICAgIHZhciBwcmludGluZyA9ICFzdGF0ZS50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnM7XG4gICAgICAgICAgICBpZiAocHJpbnRpbmcgJiYgc3RhdGUudG1wLnN1YnNlcXVlbnRfYXV0aG9yX3N1YnN0aXR1dGVfb2spIHtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLnJlbmRlcmVkX25hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFwicGFydGlhbC1lYWNoXCIgPT09IHN1YnJ1bGUgfHwgXCJwYXJ0aWFsLWZpcnN0XCIgPT09IHN1YnJ1bGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkb3N1YiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRfbmFtZSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHN0YXRlLnRtcC5uYW1lX25vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBzdGF0ZS50bXAucmVuZGVyZWRfbmFtZVtpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9zdWJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgc3RhdGUudG1wLmxhc3RfcmVuZGVyZWRfbmFtZSAmJiBzdGF0ZS50bXAubGFzdF9yZW5kZXJlZF9uYW1lLmxlbmd0aCA+IChpIC0gMSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgbmFtZSAmJiAhbmFtZS5sb2NhbGVDb21wYXJlKHN0YXRlLnRtcC5sYXN0X3JlbmRlcmVkX25hbWVbaV0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IG5ldyBDU0wuQmxvYihzdGF0ZVtzdGF0ZS50bXAuYXJlYV0ub3B0W1wic3Vic2VxdWVudC1hdXRob3Itc3Vic3RpdHV0ZVwiXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5uYW1lX25vZGUuY2hpbGRyZW5baV0uYmxvYnMgPSBbc3RyXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFwicGFydGlhbC1maXJzdFwiID09PSBzdWJydWxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3N1YiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9zdWIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZWRfbmFtZS5wdXNoKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLmxhc3RfcmVuZGVyZWRfbmFtZSA9IHJlbmRlcmVkX25hbWU7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXCJjb21wbGV0ZS1lYWNoXCIgPT09IHN1YnJ1bGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZF9uYW1lID0gc3RhdGUudG1wLnJlbmRlcmVkX25hbWUuam9pbihcIixcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVyZWRfbmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS50bXAubGFzdF9yZW5kZXJlZF9uYW1lICYmICFyZW5kZXJlZF9uYW1lLmxvY2FsZUNvbXBhcmUoc3RhdGUudG1wLmxhc3RfcmVuZGVyZWRfbmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHN0YXRlLnRtcC5uYW1lX25vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBuZXcgQ1NMLkJsb2Ioc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdFtcInN1YnNlcXVlbnQtYXV0aG9yLXN1YnN0aXR1dGVcIl0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLm5hbWVfbm9kZS5jaGlsZHJlbltpXS5ibG9icyA9IFtzdHJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5sYXN0X3JlbmRlcmVkX25hbWUgPSByZW5kZXJlZF9uYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVkX25hbWUgPSBzdGF0ZS50bXAucmVuZGVyZWRfbmFtZS5qb2luKFwiLFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlZF9uYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnRtcC5sYXN0X3JlbmRlcmVkX25hbWUgJiYgIXJlbmRlcmVkX25hbWUubG9jYWxlQ29tcGFyZShzdGF0ZS50bXAubGFzdF9yZW5kZXJlZF9uYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBuZXcgQ1NMLkJsb2Ioc3RhdGVbc3RhdGUudG1wLmFyZWFdLm9wdFtcInN1YnNlcXVlbnQtYXV0aG9yLXN1YnN0aXR1dGVcIl0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUudG1wLmxhYmVsX2Jsb2IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC5uYW1lX25vZGUudG9wLmJsb2JzID0gW3N0cixzdGF0ZS50bXAubGFiZWxfYmxvYl07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUudG1wLm5hbWVfbm9kZS50b3AuYmxvYnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAubmFtZV9ub2RlLnRvcC5ibG9ic1swXS5ibG9icyA9IFtzdHJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLm5hbWVfbm9kZS50b3AuYmxvYnMgPSBbc3RyXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuc3Vic3RpdHV0ZWRfdmFyaWFibGUgPSB0aGlzLnZhcmlhYmxlc19yZWFsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAubGFzdF9yZW5kZXJlZF9uYW1lID0gcmVuZGVyZWRfbmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzdGF0ZS50bXAuc3Vic2VxdWVudF9hdXRob3Jfc3Vic3RpdHV0ZV9vayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5leGVjcy5wdXNoKGZ1bmMpO1xuICAgIH1cbiAgICBpZiAoKFwidGV4dFwiID09PSB0aGlzLm5hbWUgJiYgIXRoaXMucG9zdHBvbmVkX21hY3JvKSB8fCBbXCJudW1iZXJcIiwgXCJkYXRlXCIsIFwibmFtZXNcIl0uaW5kZXhPZih0aGlzLm5hbWUpID4gLTEpIHtcbiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uIChzdGF0ZSwgSXRlbSkge1xuICAgICAgICAgICAgc3RhdGUudG1wLmVsZW1lbnRfdHJhY2UucG9wKCk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZXhlY3MucHVzaChmdW5jKTtcbiAgICB9XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuVXRpbC5wYWRkaW5nID0gZnVuY3Rpb24gKG51bSkge1xuICAgIHZhciBtID0gbnVtLm1hdGNoKC9cXHMqKC17MCwxfVswLTldKykvKTtcbiAgICBpZiAobSkge1xuICAgICAgICBudW0gPSBwYXJzZUludChtWzFdLCAxMCk7XG4gICAgICAgIGlmIChudW0gPCAwKSB7XG4gICAgICAgICAgICBudW0gPSA5OTk5OTk5OTk5OTk5OTk5OTk5OSArIG51bTtcbiAgICAgICAgfVxuICAgICAgICBudW0gPSBcIlwiICsgbnVtO1xuICAgICAgICB3aGlsZSAobnVtLmxlbmd0aCA8IDIwKSB7XG4gICAgICAgICAgICBudW0gPSBcIjBcIiArIG51bTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVtO1xufTtcbkNTTC5VdGlsLkxvbmdPcmRpbmFsaXplciA9IGZ1bmN0aW9uICgpIHt9O1xuQ1NMLlV0aWwuTG9uZ09yZGluYWxpemVyLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xufTtcbkNTTC5VdGlsLkxvbmdPcmRpbmFsaXplci5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24gKG51bSwgZ2VuZGVyKSB7XG4gICAgaWYgKG51bSA8IDEwKSB7XG4gICAgICAgIG51bSA9IFwiMFwiICsgbnVtO1xuICAgIH1cbiAgICB2YXIgcmV0ID0gQ1NMLkVuZ2luZS5nZXRGaWVsZChcbiAgICAgICAgQ1NMLkxPT1NFLCBcbiAgICAgICAgdGhpcy5zdGF0ZS5sb2NhbGVbdGhpcy5zdGF0ZS5vcHQubGFuZ10udGVybXMsXG4gICAgICAgIFwibG9uZy1vcmRpbmFsLVwiICsgbnVtLFxuICAgICAgICBcImxvbmdcIiwgXG4gICAgICAgIDAsIFxuICAgICAgICBnZW5kZXJcbiAgICApO1xuICAgIGlmICghcmV0KSB7XG4gICAgICAgIHJldCA9IHRoaXMuc3RhdGUuZnVuLm9yZGluYWxpemVyLmZvcm1hdChudW0sIGdlbmRlcik7XG4gICAgfVxuICAgIHRoaXMuc3RhdGUudG1wLmNpdGVfcmVuZGVyc19jb250ZW50ID0gdHJ1ZTtcbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5VdGlsLk9yZGluYWxpemVyID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xuICAgIHRoaXMuc3VmZml4ZXMgPSB7fTtcbn07XG5DU0wuVXRpbC5PcmRpbmFsaXplci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAoIXRoaXMuc3VmZml4ZXNbdGhpcy5zdGF0ZS5vcHQubGFuZ10pIHtcbiAgICAgICAgdGhpcy5zdWZmaXhlc1t0aGlzLnN0YXRlLm9wdC5sYW5nXSA9IHt9O1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IDM7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIHZhciBnZW5kZXIgPSBbdW5kZWZpbmVkLCBcIm1hc2N1bGluZVwiLCBcImZlbWluaW5lXCJdW2ldO1xuICAgICAgICAgICAgdGhpcy5zdWZmaXhlc1t0aGlzLnN0YXRlLm9wdC5sYW5nXVtnZW5kZXJdID0gW107XG4gICAgICAgICAgICBmb3IgKHZhciBqID0gMTsgaiA8IDU7IGogKz0gMSkge1xuICAgICAgICAgICAgICAgIHZhciBvcmRpbmFsID0gdGhpcy5zdGF0ZS5nZXRUZXJtKFwib3JkaW5hbC0wXCIgKyBqLCBcImxvbmdcIiwgZmFsc2UsIGdlbmRlcik7XG4gICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBvcmRpbmFsKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnN1ZmZpeGVzW3RoaXMuc3RhdGUub3B0LmxhbmddW2dlbmRlcl07XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnN1ZmZpeGVzW3RoaXMuc3RhdGUub3B0LmxhbmddW2dlbmRlcl0ucHVzaChvcmRpbmFsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuVXRpbC5PcmRpbmFsaXplci5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24gKG51bSwgZ2VuZGVyKSB7XG4gICAgdmFyIHN0cjtcbiAgICBudW0gPSBwYXJzZUludChudW0sIDEwKTtcbiAgICBzdHIgPSBcIlwiICsgbnVtO1xuICAgIHZhciBzdWZmaXggPSBcIlwiO1xuICAgIHZhciB0cnlnZW5kZXJzID0gW107XG4gICAgaWYgKGdlbmRlcikge1xuICAgICAgICB0cnlnZW5kZXJzLnB1c2goZ2VuZGVyKTtcbiAgICB9XG4gICAgdHJ5Z2VuZGVycy5wdXNoKFwibmV1dGVyXCIpO1xuICAgIGlmICh0aGlzLnN0YXRlLmxvY2FsZVt0aGlzLnN0YXRlLm9wdC5sYW5nXS5vcmRbXCIxLjAuMVwiXSkge1xuICAgICAgICBzdWZmaXggPSB0aGlzLnN0YXRlLmdldFRlcm0oXCJvcmRpbmFsXCIsZmFsc2UsMCxnZW5kZXIpO1xuICAgICAgICB2YXIgdHJ5Z2VuZGVyO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRyeWdlbmRlcnMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICB0cnlnZW5kZXIgPSB0cnlnZW5kZXJzW2ldO1xuICAgICAgICAgICAgdmFyIG9yZGluZm8gPSB0aGlzLnN0YXRlLmxvY2FsZVt0aGlzLnN0YXRlLm9wdC5sYW5nXS5vcmRbXCIxLjAuMVwiXTtcbiAgICAgICAgICAgIGlmIChvcmRpbmZvW1wid2hvbGUtbnVtYmVyXCJdW3N0cl0gJiYgb3JkaW5mb1tcIndob2xlLW51bWJlclwiXVtzdHJdW3RyeWdlbmRlcl0pIHtcbiAgICAgICAgICAgICAgICBzdWZmaXggPSB0aGlzLnN0YXRlLmdldFRlcm0odGhpcy5zdGF0ZS5sb2NhbGVbdGhpcy5zdGF0ZS5vcHQubGFuZ10ub3JkW1wiMS4wLjFcIl1bXCJ3aG9sZS1udW1iZXJcIl1bc3RyXVt0cnlnZW5kZXJdLGZhbHNlLDAsZ2VuZGVyKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAob3JkaW5mb1tcImxhc3QtdHdvLWRpZ2l0c1wiXVtzdHIuc2xpY2Uoc3RyLmxlbmd0aCAtIDIpXSAmJiBvcmRpbmZvW1wibGFzdC10d28tZGlnaXRzXCJdW3N0ci5zbGljZShzdHIubGVuZ3RoIC0gMildW3RyeWdlbmRlcl0pIHtcbiAgICAgICAgICAgICAgICBzdWZmaXggPSB0aGlzLnN0YXRlLmdldFRlcm0odGhpcy5zdGF0ZS5sb2NhbGVbdGhpcy5zdGF0ZS5vcHQubGFuZ10ub3JkW1wiMS4wLjFcIl1bXCJsYXN0LXR3by1kaWdpdHNcIl1bc3RyLnNsaWNlKHN0ci5sZW5ndGggLSAyKV1bdHJ5Z2VuZGVyXSxmYWxzZSwwLGdlbmRlcik7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG9yZGluZm9bXCJsYXN0LWRpZ2l0XCJdW3N0ci5zbGljZShzdHIubGVuZ3RoIC0gMSldICYmIG9yZGluZm9bXCJsYXN0LWRpZ2l0XCJdW3N0ci5zbGljZShzdHIubGVuZ3RoIC0gMSldW3RyeWdlbmRlcl0pIHtcbiAgICAgICAgICAgICAgICBzdWZmaXggPSB0aGlzLnN0YXRlLmdldFRlcm0odGhpcy5zdGF0ZS5sb2NhbGVbdGhpcy5zdGF0ZS5vcHQubGFuZ10ub3JkW1wiMS4wLjFcIl1bXCJsYXN0LWRpZ2l0XCJdW3N0ci5zbGljZShzdHIubGVuZ3RoIC0gMSldW3RyeWdlbmRlcl0sZmFsc2UsMCxnZW5kZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN1ZmZpeCkge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKCFnZW5kZXIpIHtcbiAgICAgICAgICAgIGdlbmRlciA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN0YXRlLmZ1bi5vcmRpbmFsaXplci5pbml0KCk7XG4gICAgICAgIGlmICgobnVtIC8gMTApICUgMTAgPT09IDEgfHwgKG51bSA+IDEwICYmIG51bSA8IDIwKSkge1xuICAgICAgICAgICAgc3VmZml4ID0gdGhpcy5zdWZmaXhlc1t0aGlzLnN0YXRlLm9wdC5sYW5nXVtnZW5kZXJdWzNdO1xuICAgICAgICB9IGVsc2UgaWYgKG51bSAlIDEwID09PSAxICYmIG51bSAlIDEwMCAhPT0gMTEpIHtcbiAgICAgICAgICAgIHN1ZmZpeCA9IHRoaXMuc3VmZml4ZXNbdGhpcy5zdGF0ZS5vcHQubGFuZ11bZ2VuZGVyXVswXTtcbiAgICAgICAgfSBlbHNlIGlmIChudW0gJSAxMCA9PT0gMiAmJiBudW0gJSAxMDAgIT09IDEyKSB7XG4gICAgICAgICAgICBzdWZmaXggPSB0aGlzLnN1ZmZpeGVzW3RoaXMuc3RhdGUub3B0LmxhbmddW2dlbmRlcl1bMV07XG4gICAgICAgIH0gZWxzZSBpZiAobnVtICUgMTAgPT09IDMgJiYgbnVtICUgMTAwICE9PSAxMykge1xuICAgICAgICAgICAgc3VmZml4ID0gdGhpcy5zdWZmaXhlc1t0aGlzLnN0YXRlLm9wdC5sYW5nXVtnZW5kZXJdWzJdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VmZml4ID0gdGhpcy5zdWZmaXhlc1t0aGlzLnN0YXRlLm9wdC5sYW5nXVtnZW5kZXJdWzNdO1xuICAgICAgICB9XG4gICAgfVxuICAgIHN0ciA9IHN0ciArPSBzdWZmaXg7XG4gICAgcmV0dXJuIHN0cjtcbn07XG5DU0wuVXRpbC5Sb21hbml6ZXIgPSBmdW5jdGlvbiAoKSB7fTtcbkNTTC5VdGlsLlJvbWFuaXplci5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24gKG51bSkge1xuICAgIHZhciByZXQsIHBvcywgbiwgbnVtc3RyLCBsZW47XG4gICAgcmV0ID0gXCJcIjtcbiAgICBpZiAobnVtIDwgNjAwMCkge1xuICAgICAgICBudW1zdHIgPSBudW0udG9TdHJpbmcoKS5zcGxpdChcIlwiKTtcbiAgICAgICAgbnVtc3RyLnJldmVyc2UoKTtcbiAgICAgICAgcG9zID0gMDtcbiAgICAgICAgbiA9IDA7XG4gICAgICAgIGxlbiA9IG51bXN0ci5sZW5ndGg7XG4gICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgbiA9IHBhcnNlSW50KG51bXN0cltwb3NdLCAxMCk7XG4gICAgICAgICAgICByZXQgPSBDU0wuUk9NQU5fTlVNRVJBTFNbcG9zXVtuXSArIHJldDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufTtcbkNTTC5VdGlsLlN1ZmZpeGF0b3IgPSBmdW5jdGlvbiAoc2xpc3QpIHtcbiAgICBpZiAoIXNsaXN0KSB7XG4gICAgICAgIHNsaXN0ID0gQ1NMLlNVRkZJWF9DSEFSUztcbiAgICB9XG4gICAgdGhpcy5zbGlzdCA9IHNsaXN0LnNwbGl0KFwiLFwiKTtcbn07XG5DU0wuVXRpbC5TdWZmaXhhdG9yLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbiAoTikge1xuICAgIHZhciBYO1xuICAgIE4gKz0gMTtcbiAgICB2YXIga2V5ID0gXCJcIjtcbiAgICBkbyB7XG4gICAgICAgIFggPSAoKE4gJSAyNikgPT09IDApID8gMjYgOiAoTiAlIDI2KTtcbiAgICAgICAgdmFyIGtleSA9IHRoaXMuc2xpc3RbWC0xXSArIGtleTtcbiAgICAgICAgTiA9IChOIC0gWCkgLyAyNjtcbiAgICB9IHdoaWxlICggTiAhPT0gMCApO1xuICAgIHJldHVybiBrZXk7XG59O1xuQ1NMLkVuZ2luZS5wcm90b3R5cGUucHJvY2Vzc051bWJlciA9IGZ1bmN0aW9uIChub2RlLCBJdGVtT2JqZWN0LCB2YXJpYWJsZSwgdHlwZSkge1xuICAgIHZhciB2YWwsIG0sIGksIGlsZW4sIGosIGpsZW47XG4gICAgdmFyIGRlYnVnID0gZmFsc2U7XG4gICAgdmFyIG1lID0gdGhpcztcbiAgICBmdW5jdGlvbiBub3JtYWxpemVGaWVsZFZhbHVlKHN0ciwgZGVmYXVsdExhYmVsKSB7XG4gICAgICAgIHN0ciA9IHN0ci50cmltKCk7XG4gICAgICAgIHZhciBtID0gc3RyLm1hdGNoKC9eKFteIF0rKS8pO1xuICAgICAgICBpZiAobSAmJiAhQ1NMLlNUQVRVVEVfU1VCRElWX1NUUklOR1NbbVsxXV0pIHtcbiAgICAgICAgICAgIHZhciBlbWJlZGRlZExhYmVsID0gbnVsbDtcbiAgICAgICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJsb2NhdG9yXCIgKSB7XG4gICAgICAgICAgICAgICAgaWYgKEl0ZW1PYmplY3QubGFiZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgZW1iZWRkZWRMYWJlbCA9IENTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTX1JFVkVSU0VbSXRlbU9iamVjdC5sYWJlbF07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZW1iZWRkZWRMYWJlbCA9IFwicC5cIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGVtYmVkZGVkTGFiZWwgPSBDU0wuU1RBVFVURV9TVUJESVZfU1RSSU5HU19SRVZFUlNFW3ZhcmlhYmxlXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChlbWJlZGRlZExhYmVsKSB7XG4gICAgICAgICAgICAgICAgc3RyID0gZW1iZWRkZWRMYWJlbCArIFwiIFwiICsgc3RyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdHI7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNvbXBvc2VOdW1iZXJJbmZvKG9yaWdMYWJlbCwgbGFiZWwsIHZhbCwgam9pbmluZ1N1ZmZpeCkge1xuICAgICAgICBqb2luaW5nU3VmZml4ID0gam9pbmluZ1N1ZmZpeCA/IGpvaW5pbmdTdWZmaXggOiBcIlwiO1xuICAgICAgICB2YXIgaW5mbyA9IHt9O1xuICAgICAgICBpZiAoIWxhYmVsICYmICFDU0wuU1RBVFVURV9TVUJESVZfU1RSSU5HU19SRVZFUlNFW3ZhcmlhYmxlXSkge1xuICAgICAgICAgICAgICAgIGxhYmVsID0gXCJ2YXI6XCIrdmFyaWFibGU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxhYmVsKSB7XG4gICAgICAgICAgICB2YXIgbSA9IGxhYmVsLm1hdGNoKC8oXFxzKikoW15cXHNdKikoXFxzKikvKTtcbiAgICAgICAgICAgIGluZm8ubGFiZWwgPSBtWzJdO1xuICAgICAgICAgICAgaW5mby5vcmlnTGFiZWwgPSBvcmlnTGFiZWw7XG4gICAgICAgICAgICBpbmZvLmxhYmVsU3VmZml4ID0gbVszXSA/IG1bM10gOiBcIlwiO1xuICAgICAgICAgICAgaW5mby5wbHVyYWwgPSAwO1xuICAgICAgICAgICAgaW5mby5sYWJlbFZpc2liaWxpdHkgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbSA9IHZhbC5tYXRjaCgvXihbYS16QS1aMF0qKShbMC05XSsoPzpbYS16QS1aXSp8Wy0sYS16QS1aXSspKSQvKTtcbiAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgIGluZm8ucGFydGljbGUgPSBtWzFdO1xuICAgICAgICAgICAgaW5mby52YWx1ZSA9IG1bMl07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpbmZvLnBhcnRpY2xlID0gXCJcIjtcbiAgICAgICAgICAgIGluZm8udmFsdWUgPSB2YWw7XG4gICAgICAgIH1cbiAgICAgICAgaW5mby5qb2luaW5nU3VmZml4ID0gam9pbmluZ1N1ZmZpeC5yZXBsYWNlKC9cXHMqLVxccyovLCBcIi1cIik7XG4gICAgICAgIHJldHVybiBpbmZvO1xuICAgIH07XG4gICAgZnVuY3Rpb24gZml4dXBTdWJzZWN0aW9ucyhlbGVtcykge1xuICAgICAgICBmb3IgKHZhciBpPWVsZW1zLmxlbmd0aC0yO2k+LTE7aS09Mikge1xuICAgICAgICAgICAgaWYgKGVsZW1zW2ldID09PSBcIi1cIlxuICAgICAgICAgICAgICAgJiYgZWxlbXNbaS0xXS5tYXRjaCgvXig/Oig/OlthLXpdfFthLXpdW2Etel18W2Etel1bYS16XVthLXpdfFthLXpdW2Etel1bYS16XVthLXpdKVxcLiAgKikqWzAtOV0rWyxhLXpBLVpdKyQvKVxuICAgICAgICAgICAgICAgJiYgZWxlbXNbaSsxXS5tYXRjaCgvXlssYS16QS1aXSskLykpIHtcbiAgICAgICAgICAgICAgICBlbGVtc1tpLTFdID0gZWxlbXMuc2xpY2UoaS0xLGkrMikuam9pbihcIlwiKTtcbiAgICAgICAgICAgICAgICBlbGVtcyA9IGVsZW1zLnNsaWNlKDAsaSkuY29uY2F0KGVsZW1zLnNsaWNlKGkrMikpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBlbGVtcztcbiAgICB9XG4gICAgZnVuY3Rpb24gcGFyc2VTdHJpbmcoc3RyLCBkZWZhdWx0TGFiZWwpIHtcbiAgICAgICAgZGVmYXVsdExhYmVsID0gZGVmYXVsdExhYmVsID8gZGVmYXVsdExhYmVsIDogXCJcIjtcbiAgICAgICAgc3RyID0gbm9ybWFsaXplRmllbGRWYWx1ZShzdHIsIGRlZmF1bHRMYWJlbCk7XG4gICAgICAgIHZhciBlbGVtcyA9IFtdO1xuICAgICAgICB2YXIgbSA9IHN0ci5tYXRjaCgvKCxcXHMrfFxccypcXFxcKltcXC1cXHUyMDEzXStcXHMqfFxccyomXFxzKikvZyk7XG4gICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICB2YXIgbHN0ID0gc3RyLnNwbGl0KC8oPzosXFxzK3xcXHMqXFxcXCpbXFwtXFx1MjAxM10rXFxzKnxcXHMqJlxccyopLyk7XG4gICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj1sc3QubGVuZ3RoLTE7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICAgICAgZWxlbXMucHVzaChsc3RbaV0pO1xuICAgICAgICAgICAgICAgIGVsZW1zLnB1c2gobVtpXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbGVtcy5wdXNoKGxzdFtsc3QubGVuZ3RoLTFdKTtcbiAgICAgICAgICAgIGVsZW1zID0gZml4dXBTdWJzZWN0aW9ucyhlbGVtcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YXIgZWxlbXMgPSBbc3RyXTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgdmFsdWVzID0gW107XG4gICAgICAgIHZhciBsYWJlbCA9IGRlZmF1bHRMYWJlbDtcbiAgICAgICAgdmFyIG9yaWdMYWJlbCA9IFwiXCI7XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWVsZW1zLmxlbmd0aDtpPGlsZW47aSArPSAyKSB7XG4gICAgICAgICAgICB2YXIgbSA9IGVsZW1zW2ldLm1hdGNoKC8oKD86XnwgKSg/OlthLXpdfFthLXpdW2Etel18W2Etel1bYS16XVthLXpdfFthLXpdW2Etel1bYS16XVthLXpdKVxcLiAqKS9nKTtcbiAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxzdCA9IGVsZW1zW2ldLnNwbGl0KC8oPzooPzpefCApKD86W2Etel18W2Etel1bYS16XXxbYS16XVthLXpdW2Etel18W2Etel1bYS16XVthLXpdW2Etel0pXFwuICopLyk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaj1sc3QubGVuZ3RoLTE7aj4wO2otLSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAobHN0W2otMV0gJiYgKCFsc3Rbal0ubWF0Y2goL15bMC05XSsoWy0sOmEtekEtWl0qKSQvKSB8fCAhbHN0W2otMV0ubWF0Y2goL15bMC05XSsoWy0sOmEtekEtWl0qKSQvKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxzdFtqLTFdID0gbHN0W2otMV0gKyBtW2otMV0gKyBsc3Rbal07XG4gICAgICAgICAgICAgICAgICAgICAgICBsc3QgPSBsc3Quc2xpY2UoMCxqKS5jb25jYXQobHN0LnNsaWNlKGorMSkpXG4gICAgICAgICAgICAgICAgICAgICAgICBtID0gbS5zbGljZSgwLGotMSkuY29uY2F0KG0uc2xpY2UoaikpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG0ubGVuZ3RoID4gMCAmJiBpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzbHVnID0gbVswXS50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghQ1NMLlNUQVRVVEVfU1VCRElWX1NUUklOR1Nbc2x1Z11cbiAgICAgICAgICAgICAgICAgICAgICAgIHx8ICFtZS5nZXRUZXJtKENTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTW3NsdWddKVxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgKFtcImxvY2F0b3JcIiwgXCJudW1iZXJcIl0uaW5kZXhPZih2YXJpYWJsZSkgPT09IC0xICYmIENTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTW3NsdWddICE9PSB2YXJpYWJsZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG0gPSBtLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbHN0WzBdID0gbHN0WzBdICsgXCIgXCIgKyBzbHVnICsgXCIgXCIgKyBsc3RbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICBsc3QgPSBsc3Quc2xpY2UoMCwxKS5jb25jYXQobHN0LnNsaWNlKDIpKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPWxzdC5sZW5ndGg7IGo8amxlbjsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsc3Rbal0gfHwgaiA9PT0gKGxzdC5sZW5ndGgtMSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsID0gbVtqLTFdID8gbVtqLTFdIDogbGFiZWw7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3JpZ0xhYmVsID0gaiA+IDEgPyBtW2otMV0gOiBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0ciA9IGxzdFtqXSA/IGxzdFtqXS50cmltKCkgOiBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGogPT09IChsc3QubGVuZ3RoLTEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2goY29tcG9zZU51bWJlckluZm8ob3JpZ0xhYmVsLCBsYWJlbCwgc3RyLCBlbGVtc1tpKzFdKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKGNvbXBvc2VOdW1iZXJJbmZvKG9yaWdMYWJlbCwgbGFiZWwsIHN0cikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaChjb21wb3NlTnVtYmVySW5mbyhvcmlnTGFiZWwsIGxhYmVsLCBlbGVtc1tpXSwgZWxlbXNbaSsxXSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWx1ZXM7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHNldFNwYWNlcyh2YWx1ZXMpIHtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49dmFsdWVzLmxlbmd0aC0xO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIGlmICghdmFsdWVzW2ldLmpvaW5pbmdTdWZmaXggJiYgdmFsdWVzW2krMV0ubGFiZWwpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZXNbaV0uam9pbmluZ1N1ZmZpeCA9IFwiIFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGZ1bmN0aW9uIGZpeE51bWVyaWNBbmRDb3VudCh2YWx1ZXMsIGksIGN1cnJlbnRMYWJlbEluZm8pIHtcbiAgICAgICAgdmFyIG1hc3RlciA9IHZhbHVlc1tjdXJyZW50TGFiZWxJbmZvLnBvc107XG4gICAgICAgIHZhciB2YWwgPSB2YWx1ZXNbaV0udmFsdWU7XG4gICAgICAgIHZhciBpc0VzY2FwZWRIeXBoZW4gPSBtYXN0ZXIuam9pbmluZ1N1ZmZpeCA9PT0gXCJcXFxcLVwiO1xuICAgICAgICBpZiAodmFsLnBhcnRpY2xlICYmIHZhbC5wYXJ0aWNsZSAhPT0gbWFzdGVyLnBhcnRpY2xlKSB7XG4gICAgICAgICAgICBjdXJyZW50TGFiZWxJbmZvLmNvbGxhcHNpYmxlID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG1WYWwgPSB2YWwubWF0Y2goL15bMC05XSsoWy0sOmEtekEtWl0qKSQvKTtcbiAgICAgICAgdmFyIG1DdXJyZW50TGFiZWwgPSBtYXN0ZXIudmFsdWUubWF0Y2goL15bMC05XSsoWy0sOmEtekEtWl0qKSQvKTtcbiAgICAgICAgaWYgKCF2YWwgfHwgIW1WYWwgfHwgIW1DdXJyZW50TGFiZWwgfHwgaXNFc2NhcGVkSHlwaGVuKSB7XG4gICAgICAgICAgICBjdXJyZW50TGFiZWxJbmZvLmNvbGxhcHNpYmxlID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoIXZhbCB8fCAhbUN1cnJlbnRMYWJlbCkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRMYWJlbEluZm8ubnVtZXJpYyA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGlzRXNjYXBlZEh5cGhlbikge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRMYWJlbEluZm8uY291bnQtLTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoKG1WYWwgJiYgbVZhbFsxXSkgfHwgKG1DdXJyZW50TGFiZWwgJiYgbUN1cnJlbnRMYWJlbFsxXSkpIHtcbiAgICAgICAgICAgIGN1cnJlbnRMYWJlbEluZm8uY29sbGFwc2libGUgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgaXNDb2xsYXBzaWJsZSA9IGN1cnJlbnRMYWJlbEluZm8uY29sbGFwc2libGU7XG4gICAgICAgIGlmICghaXNDb2xsYXBzaWJsZSAmJiBpPjAgJiYgdmFsLm1hdGNoKC9eW2l2eGxjbUlWWExDTV0rJC8pICYmIHZhbHVlc1tpLTFdLnZhbHVlLm1hdGNoKC9eW2l2eGxjbUlWWExDTV0rJC8pKSB7XG4gICAgICAgICAgICBpc0NvbGxhcHNpYmxlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBqPWN1cnJlbnRMYWJlbEluZm8ucG9zLGpsZW49dmFsdWVzLmxlbmd0aDsgajxqbGVuOyBqKyspIHtcbiAgICAgICAgICAgIGlmIChjdXJyZW50TGFiZWxJbmZvLmxhYmVsID09PSB2YWx1ZXNbal0ubGFiZWwgJiYgY3VycmVudExhYmVsSW5mby5jb3VudCA+IDEgJiYgaXNDb2xsYXBzaWJsZSkge1xuICAgICAgICAgICAgICAgIHZhbHVlc1tqXS5wbHVyYWwgPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFsdWVzW2pdLm51bWVyaWMgPSBjdXJyZW50TGFiZWxJbmZvLm51bWVyaWM7XG4gICAgICAgICAgICB2YWx1ZXNbal0uY29sbGFwc2libGUgPSBjdXJyZW50TGFiZWxJbmZvLmNvbGxhcHNpYmxlO1xuICAgICAgICB9XG4gICAgICAgIGN1cnJlbnRMYWJlbEluZm8ubGFiZWwgPSB2YWx1ZXNbaV0ubGFiZWw7XG4gICAgICAgIGN1cnJlbnRMYWJlbEluZm8uY291bnQgPSAxO1xuICAgICAgICBjdXJyZW50TGFiZWxJbmZvLnBvcyA9IGk7XG4gICAgICAgIGN1cnJlbnRMYWJlbEluZm8ubnVtZXJpYyA9IHRydWU7XG4gICAgICAgIGN1cnJlbnRMYWJlbEluZm8uY29sbGFwc2libGUgPSB0cnVlO1xuICAgIH1cbiAgICBmdW5jdGlvbiBzZXRQbHVyYWxzQW5kTnVtZXJpY3ModmFsdWVzKSB7XG4gICAgICAgIHZhciBjdXJyZW50TGFiZWxJbmZvID0ge1xuICAgICAgICAgICAgbGFiZWw6IG51bGwsXG4gICAgICAgICAgICBjb3VudDogMSxcbiAgICAgICAgICAgIG51bWVyaWM6IHRydWUsXG4gICAgICAgICAgICBjb2xsYXBzaWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIHBvczogMFxuICAgICAgICB9XG4gICAgICAgIHZhciBtYXN0ZXJMYWJlbCA9IHZhbHVlcy5sZW5ndGggPyB2YWx1ZXNbMF0ubGFiZWwgOiBudWxsO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj12YWx1ZXMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZXNbaV0ubGFiZWwpIHtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWVzW2ldLmxhYmVsID09PSBjdXJyZW50TGFiZWxJbmZvLmxhYmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRMYWJlbEluZm8uY291bnQrKztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmaXhOdW1lcmljQW5kQ291bnQodmFsdWVzLCBpLCBjdXJyZW50TGFiZWxJbmZvKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRMYWJlbEluZm8ucG9zID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFyaWFibGUgPT09IFwibG9jYXRvclwiIHx8IHZhcmlhYmxlID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtZS5nZXRUZXJtKENTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTW2N1cnJlbnRMYWJlbEluZm8ubGFiZWxdKSAmJiBjdXJyZW50TGFiZWxJbmZvLmxhYmVsLnNsaWNlKDAsIDQpICE9PSBcInZhcjpcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbY3VycmVudExhYmVsSW5mby5wb3NdLmxhYmVsVmlzaWJpbGl0eSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFtcImxvY2F0b3JcIiwgXCJudW1iZXJcIl0uaW5kZXhPZih2YXJpYWJsZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKENTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTW2N1cnJlbnRMYWJlbEluZm8ubGFiZWxdICE9PSB2YXJpYWJsZSAmJiBjdXJyZW50TGFiZWxJbmZvLmxhYmVsLnNsaWNlKDAsIDQpICE9PSBcInZhcjpcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbMF0ubGFiZWxWaXNpYmlsaXR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWVzW2ktMV0ubGFiZWwgIT09IHZhbHVlc1tpXS5sYWJlbCAmJiBjdXJyZW50TGFiZWxJbmZvLmxhYmVsLnNsaWNlKDAsIDQpICE9PSBcInZhcjpcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc1tjdXJyZW50TGFiZWxJbmZvLnBvc10ubGFiZWxWaXNpYmlsaXR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmaXhOdW1lcmljQW5kQ291bnQodmFsdWVzLCB2YWx1ZXMubGVuZ3RoLTEsIGN1cnJlbnRMYWJlbEluZm8pO1xuICAgICAgICBpZiAodmFsdWVzLmxlbmd0aCAmJiB2YWx1ZXNbMF0ubnVtZXJpYyAmJiB2YXJpYWJsZS5zbGljZSgwLCAxMCkgPT09IFwibnVtYmVyLW9mLVwiKSB7XG4gICAgICAgICAgICBpZiAocGFyc2VJbnQoSXRlbU9iamVjdFt2YXJpYWJsZV0sIDEwKSA+IDEpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZXNbMF0ucGx1cmFsID0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj12YWx1ZXMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIGlmICghdmFsdWVzW2ldLm51bWVyaWMpIHtcbiAgICAgICAgICAgICAgICB2YXIgb3JpZ0xhYmVsID0gdmFsdWVzW2ldLm9yaWdMYWJlbCA/IHZhbHVlc1tpXS5vcmlnTGFiZWwgOiBcIlwiO1xuICAgICAgICAgICAgICAgIHZhbHVlc1tpXS52YWx1ZSA9IChvcmlnTGFiZWwgKyB2YWx1ZXNbaV0udmFsdWUpLnRyaW0oKTtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWVzW2ldLmxhYmVsICE9PSB2YWx1ZXNbMF0ubGFiZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzW2ldLmxhYmVsID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9ICAgICAgICBcbiAgICBmdW5jdGlvbiBzZXRTdHlsaW5nKHZhbHVlcykge1xuICAgICAgICB2YXIgbWFzdGVyTm9kZSA9IENTTC5VdGlsLmNsb25lVG9rZW4obm9kZSk7XG4gICAgICAgIHZhciBtYXN0ZXJTdHlsaW5nID0gbmV3IENTTC5Ub2tlbigpO1xuICAgICAgICBpZiAoIW1lLnRtcC5qdXN0X2xvb2tpbmcpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGo9bWFzdGVyTm9kZS5kZWNvcmF0aW9ucy5sZW5ndGgtMTtqPi0xO2otLSkge1xuICAgICAgICAgICAgICAgIGlmIChtYXN0ZXJOb2RlLmRlY29yYXRpb25zW2pdWzBdID09PSBcIkBxdW90ZXNcIikge1xuICAgICAgICAgICAgICAgICAgICBtYXN0ZXJTdHlsaW5nLmRlY29yYXRpb25zID0gbWFzdGVyU3R5bGluZy5kZWNvcmF0aW9ucy5jb25jYXQobWFzdGVyTm9kZS5kZWNvcmF0aW9ucy5zbGljZShqLCBqKzEpKTtcbiAgICAgICAgICAgICAgICAgICAgbWFzdGVyTm9kZS5kZWNvcmF0aW9ucyA9IG1hc3Rlck5vZGUuZGVjb3JhdGlvbnMuc2xpY2UoMCwgaikuY29uY2F0KG1hc3Rlck5vZGUuZGVjb3JhdGlvbnMuc2xpY2UoaisxKSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtYXN0ZXJTdHlsaW5nLnN0cmluZ3MucHJlZml4ID0gbWFzdGVyTm9kZS5zdHJpbmdzLnByZWZpeDtcbiAgICAgICAgICAgIG1hc3Rlck5vZGUuc3RyaW5ncy5wcmVmaXggPSBcIlwiO1xuICAgICAgICAgICAgbWFzdGVyU3R5bGluZy5zdHJpbmdzLnN1ZmZpeCA9IG1hc3Rlck5vZGUuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgICAgICBtYXN0ZXJOb2RlLnN0cmluZ3Muc3VmZml4ID0gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbWFzdGVyTGFiZWwgPSB2YWx1ZXMubGVuZ3RoID8gdmFsdWVzWzBdLmxhYmVsIDogbnVsbDtcbiAgICAgICAgaWYgKHZhbHVlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXZhbHVlcy5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZhbCA9IHZhbHVlc1tpXTtcbiAgICAgICAgICAgICAgICB2YXIgbmV3bm9kZSA9IENTTC5VdGlsLmNsb25lVG9rZW4obWFzdGVyTm9kZSk7XG4gICAgICAgICAgICAgICAgbmV3bm9kZS5nZW5kZXIgPSBub2RlLmdlbmRlcjtcbiAgICAgICAgICAgICAgICBpZiAobWFzdGVyTGFiZWwgPT09IHZhbC5sYWJlbCkge1xuICAgICAgICAgICAgICAgICAgICBuZXdub2RlLmZvcm1hdHRlciA9IG5vZGUuZm9ybWF0dGVyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodmFsLm51bWVyaWMpIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3bm9kZS5zdWNjZXNzb3JfcHJlZml4ID0gdmFsLnN1Y2Nlc3Nvcl9wcmVmaXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG5ld25vZGUuc3RyaW5ncy5zdWZmaXggPSBuZXdub2RlLnN0cmluZ3Muc3VmZml4ICsgc3RyaXBIeXBoZW5CYWNrc2xhc2godmFsLmpvaW5pbmdTdWZmaXgpO1xuICAgICAgICAgICAgICAgIHZhbC5zdHlsaW5nID0gbmV3bm9kZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghbWUudG1wLmp1c3RfbG9va2luZykge1xuICAgICAgICAgICAgICAgIGlmICh2YWx1ZXNbMF0udmFsdWUuc2xpY2UoMCwxKSA9PT0gXCJcXFwiXCIgJiYgdmFsdWVzW3ZhbHVlcy5sZW5ndGgtMV0udmFsdWUuc2xpY2UoLTEpID09PSBcIlxcXCJcIikge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZXNbMF0udmFsdWUgPSB2YWx1ZXNbMF0udmFsdWUuc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlc1t2YWx1ZXMubGVuZ3RoLTFdLnZhbHVlID0gdmFsdWVzW3ZhbHVlcy5sZW5ndGgtMV0udmFsdWUuc2xpY2UoMCwtMSk7XG4gICAgICAgICAgICAgICAgICAgIG1hc3RlclN0eWxpbmcuZGVjb3JhdGlvbnMucHVzaChbXCJAcXVvdGVzXCIsIHRydWVdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1hc3RlclN0eWxpbmc7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHN0cmlwSHlwaGVuQmFja3NsYXNoKGpvaW5pbmdTdWZmaXgpIHtcbiAgICAgICAgcmV0dXJuIGpvaW5pbmdTdWZmaXgucmVwbGFjZShcIlxcXFwtXCIsIFwiLVwiKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gZml4dXBSYW5nZURlbGltaXRlcih2YXJpYWJsZSwgdmFsLCByYW5nZURlbGltaXRlciwgaXNOdW1lcmljKSB7XG4gICAgICAgIHZhciBpc1BhZ2UgPSBjaGVja1BhZ2UodmFyaWFibGUsIHZhbCk7XG4gICAgICAgIHZhciBoYXNUZXJtID0gY2hlY2tUZXJtKHZhcmlhYmxlLCB2YWwpO1xuICAgICAgICBpZiAoaGFzVGVybSAmJiByYW5nZURlbGltaXRlciA9PT0gXCItXCIpIHtcbiAgICAgICAgICAgIGlmIChpc051bWVyaWMpIHtcbiAgICAgICAgICAgICAgICBpZiAoaXNQYWdlIHx8IFtcImxvY2F0b3JcIiwgXCJpc3N1ZVwiLCBcInZvbHVtZVwiLCBcImVkaXRpb25cIiwgXCJudW1iZXJcIl0uaW5kZXhPZih2YXJpYWJsZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICByYW5nZURlbGltaXRlciA9IG1lLmdldFRlcm0oXCJwYWdlLXJhbmdlLWRlbGltaXRlclwiKVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXJhbmdlRGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZURlbGltaXRlciA9IFwiXFx1MjAxM1wiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJjb2xsZWN0aW9uLW51bWJlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHJhbmdlRGVsaW1pdGVyID0gbWUuZ2V0VGVybShcInllYXItcmFuZ2UtZGVsaW1pdGVyXCIpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXJhbmdlRGVsaW1pdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZURlbGltaXRlciA9IFwiXFx1MjAxM1wiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByYW5nZURlbGltaXRlcjtcbiAgICB9XG4gICAgZnVuY3Rpb24gY2hlY2tQYWdlKHZhcmlhYmxlLCB2YWwpIHtcbiAgICAgICAgcmV0dXJuIHZhcmlhYmxlID09PSBcInBhZ2VcIiBcbiAgICAgICAgICAgIHx8ICh2YXJpYWJsZSA9PT0gXCJsb2NhdG9yXCIgJiYgKFtcInAuXCJdLmluZGV4T2YodmFsLmxhYmVsKSA+IC0xKSk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNoZWNrVGVybSh2YXJpYWJsZSwgdmFsKSB7XG4gICAgICAgIHZhciByZXQgPSB0cnVlO1xuICAgICAgICBpZiAodmFyaWFibGUgPT09IFwibG9jYXRvclwiKSB7XG4gICAgICAgICAgICByZXQgPSAhIW1lLmdldFRlcm0oQ1NMLlNUQVRVVEVfU1VCRElWX1NUUklOR1NbdmFsLmxhYmVsXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG4gICAgZnVuY3Rpb24gbWFuZ2xlUGFnZU51bWJlcnModmFsdWVzLCBpLCBjdXJyZW50SW5mbykge1xuICAgICAgICBpZiAoaTwxKSByZXR1cm47XG4gICAgICAgIGlmIChjdXJyZW50SW5mby5jb3VudCAhPT0gMikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2YWx1ZXNbaS0xXS5wYXJ0aWNsZSAhPT0gdmFsdWVzW2ldLnBhcnRpY2xlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHZhbHVlc1tpLTFdLmpvaW5pbmdTdWZmaXggIT09IFwiLVwiKSB7XG4gICAgICAgICAgICBjdXJyZW50SW5mby5jb3VudCA9IDE7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFtZS5vcHRbXCJwYWdlLXJhbmdlLWZvcm1hdFwiXSAmJiBwYXJzZUludCh2YWx1ZXNbaS0xXS52YWx1ZSwgMTApID4gcGFyc2VJbnQodmFsdWVzW2ldLnZhbHVlLCAxMCkpIHtcbiAgICAgICAgICAgIHZhbHVlc1tpLTFdLmpvaW5pbmdTdWZmaXggPSBmaXh1cFJhbmdlRGVsaW1pdGVyKHZhcmlhYmxlLCB2YWx1ZXNbaV0sIHZhbHVlc1tpLTFdLmpvaW5pbmdTdWZmaXgsIHRydWUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHZhciB2YWwgPSB2YWx1ZXNbaV07XG4gICAgICAgIHZhciBpc1BhZ2UgPSBjaGVja1BhZ2UodmFyaWFibGUsIHZhbCk7XG4gICAgICAgIGlmIChpc1BhZ2UpIHtcbiAgICAgICAgICAgIHZhciBzdHIgPSB2YWx1ZXNbaS0xXS5wYXJ0aWNsZSArIHZhbHVlc1tpLTFdLnZhbHVlICsgXCIgLSBcIiArIHZhbHVlc1tpXS5wYXJ0aWNsZSArIHZhbHVlc1tpXS52YWx1ZTtcbiAgICAgICAgICAgIHN0ciA9IG1lLmZ1bi5wYWdlX21hbmdsZXIoc3RyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0ciA9IHZhbHVlc1tpLTFdLnZhbHVlICsgc3RyaXBIeXBoZW5CYWNrc2xhc2godmFsdWVzW2ktMV0uam9pbmluZ1N1ZmZpeCkgKyB2YWx1ZXNbaV0udmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG0gPSBzdHIubWF0Y2goL14oW2EtekEtWl0/MCopKFswLTldKykoXFxzKlteMC05XStcXHMqKShbLSxhLXpBLVpdPzAqKShbMC05XSspJC8pO1xuICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgdmFyIHJhbmdlRGVsaW1pdGVyID0gbVszXTtcbiAgICAgICAgICAgIHJhbmdlRGVsaW1pdGVyID0gZml4dXBSYW5nZURlbGltaXRlcih2YXJpYWJsZSwgdmFsLCByYW5nZURlbGltaXRlciwgdmFsdWVzW2ldLm51bWVyaWMpO1xuICAgICAgICAgICAgdmFsdWVzW2ktMV0ucGFydGljbGUgPSBtWzFdO1xuICAgICAgICAgICAgdmFsdWVzW2ktMV0udmFsdWUgPSBtWzJdO1xuICAgICAgICAgICAgdmFsdWVzW2ktMV0uam9pbmluZ1N1ZmZpeCA9IHJhbmdlRGVsaW1pdGVyO1xuICAgICAgICAgICAgdmFsdWVzW2ldLnBhcnRpY2xlID0gbVs0XTtcbiAgICAgICAgICAgIHZhbHVlc1tpXS52YWx1ZSA9IG1bNV07XG4gICAgICAgIH1cbiAgICAgICAgY3VycmVudEluZm8uY291bnQgPSAwO1xuICAgIH1cbiAgICBmdW5jdGlvbiBmaXhSYW5nZXModmFsdWVzKSB7XG4gICAgICAgIGlmICghbm9kZSkgcmV0dXJuO1xuICAgICAgICBpZiAoW1wicGFnZVwiLCBcInBhZ2UtZmlyc3RcIiwgXCJjaGFwdGVyLW51bWJlclwiLCBcImNvbGxlY3Rpb24tbnVtYmVyXCIsIFwiZWRpdGlvblwiLCBcImlzc3VlXCIsIFwibnVtYmVyXCIsIFwibnVtYmVyLW9mLXBhZ2VzXCIsIFwibnVtYmVyLW9mLXZvbHVtZXNcIiwgXCJ2b2x1bWVcIiwgXCJsb2NhdG9yXCJdLmluZGV4T2YodmFyaWFibGUpID09PSAtMSkgcmV0dXJuO1xuICAgICAgICB2YXIgY3VycmVudEluZm8gPSB7XG4gICAgICAgICAgICBjb3VudDogMCxcbiAgICAgICAgICAgIGxhYmVsOiBudWxsLFxuICAgICAgICAgICAgbGFzdEhhZFJhbmdlRGVsaW1pdGVyOiBmYWxzZVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXZhbHVlcy5sZW5ndGg7IGk8aWxlbjsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgdmFsID0gdmFsdWVzW2ldO1xuICAgICAgICAgICAgaWYgKCF2YWwuY29sbGFwc2libGUpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50SW5mby5jb3VudCA9IDA7XG4gICAgICAgICAgICAgICAgY3VycmVudEluZm8ubGFiZWwgPSBudWxsO1xuICAgICAgICAgICAgICAgIHZhciBpc051bWVyaWMgPSB2YWwubnVtZXJpYztcbiAgICAgICAgICAgICAgICBpZiAoaTwodmFsdWVzLmxlbmd0aC0xKSAmJiAhaXNOdW1lcmljICYmIHZhbC52YWx1ZS5tYXRjaCgvXltpdnhsY21JVlhMQ01dKyQvKSAmJiB2YWx1ZXNbaSsxXS52YWx1ZS5tYXRjaCgvXltpdnhsY21JVlhMQ01dKyQvKSkge1xuICAgICAgICAgICAgICAgICAgICBpc051bWVyaWMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YWwuam9pbmluZ1N1ZmZpeCA9IGZpeHVwUmFuZ2VEZWxpbWl0ZXIodmFyaWFibGUsIHZhbCwgdmFsLmpvaW5pbmdTdWZmaXgsIGlzTnVtZXJpYyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRJbmZvLmxhYmVsID09PSB2YWwubGFiZWwgJiYgdmFsLmpvaW5pbmdTdWZmaXggPT09IFwiLVwiKSB7XG4gICAgICAgICAgICAgICAgY3VycmVudEluZm8uY291bnQgPSAxO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50SW5mby5sYWJlbCA9PT0gdmFsLmxhYmVsICYmIHZhbC5qb2luaW5nU3VmZml4ICE9PSBcIi1cIikge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRJbmZvLmNvdW50Kys7XG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRJbmZvLmNvdW50ID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgIG1hbmdsZVBhZ2VOdW1iZXJzKHZhbHVlcywgaSwgY3VycmVudEluZm8pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudEluZm8ubGFiZWwgIT09IHZhbC5sYWJlbCkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRJbmZvLmxhYmVsID0gdmFsLmxhYmVsO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRJbmZvLmNvdW50ID0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY3VycmVudEluZm8uY291bnQgPSAxO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRJbmZvLmxhYmVsID0gdmFsLmxhYmVsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChjdXJyZW50SW5mby5jb3VudCA9PT0gMikge1xuICAgICAgICAgICAgbWFuZ2xlUGFnZU51bWJlcnModmFsdWVzLCB2YWx1ZXMubGVuZ3RoLTEsIGN1cnJlbnRJbmZvKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBzZXRWYXJpYWJsZVBhcmFtcyhzaGFkb3dfbnVtYmVycywgdmFyaWFibGUsIHZhbHVlcykge1xuICAgICAgICB2YXIgb2JqID0gc2hhZG93X251bWJlcnNbdmFyaWFibGVdO1xuICAgICAgICBpZiAodmFsdWVzLmxlbmd0aCkge1xuICAgICAgICAgICAgb2JqLm51bWVyaWMgPSB2YWx1ZXNbMF0ubnVtZXJpYztcbiAgICAgICAgICAgIG9iai5jb2xsYXBzaWJsZSA9IHZhbHVlc1swXS5jb2xsYXBzaWJsZTtcbiAgICAgICAgICAgIG9iai5wbHVyYWwgPSB2YWx1ZXNbMF0ucGx1cmFsO1xuICAgICAgICAgICAgb2JqLmxhYmVsID0gQ1NMLlNUQVRVVEVfU1VCRElWX1NUUklOR1NbdmFsdWVzWzBdLmxhYmVsXTtcbiAgICAgICAgICAgIGlmICh2YXJpYWJsZSA9PT0gXCJudW1iZXJcIiAmJiBvYmoubGFiZWwgPT09IFwiaXNzdWVcIiAmJiBtZS5nZXRUZXJtKFwibnVtYmVyXCIpKSB7XG4gICAgICAgICAgICAgICAgb2JqLmxhYmVsID0gXCJudW1iZXJcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAobm9kZSAmJiB0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1t2YXJpYWJsZV0gJiYgdGhpcy50bXAuc2hhZG93X251bWJlcnNbdmFyaWFibGVdLnZhbHVlcy5sZW5ndGgpIHtcbiAgICAgICAgdmFyIHZhbHVlcyA9IHRoaXMudG1wLnNoYWRvd19udW1iZXJzW3ZhcmlhYmxlXS52YWx1ZXM7XG4gICAgICAgIGZpeFJhbmdlcyh2YWx1ZXMpO1xuICAgICAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbdmFyaWFibGVdLm1hc3RlclN0eWxpbmcgPSBzZXRTdHlsaW5nKHZhbHVlcyk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1t2YXJpYWJsZV0pIHtcbiAgICAgICAgdGhpcy50bXAuc2hhZG93X251bWJlcnNbdmFyaWFibGVdID0ge1xuICAgICAgICAgICAgdmFsdWVzOltdXG4gICAgICAgIH07XG4gICAgfVxuICAgIGlmICghSXRlbU9iamVjdCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBsYW5ndWFnZVJvbGUgPSBDU0wuTGFuZ1ByZWZzTWFwW3ZhcmlhYmxlXTtcbiAgICBpZiAobGFuZ3VhZ2VSb2xlKSB7XG4gICAgICAgIHZhciBsb2NhbGVUeXBlID0gdGhpcy5vcHRbXCJjaXRlLWxhbmctcHJlZnNcIl1bbGFuZ3VhZ2VSb2xlXVswXTtcbiAgICAgICAgdmFsID0gdGhpcy50cmFuc2Zvcm0uZ2V0VGV4dFN1YkZpZWxkKEl0ZW1PYmplY3QsIHZhcmlhYmxlLCBcImxvY2FsZS1cIitsb2NhbGVUeXBlLCB0cnVlKTtcbiAgICAgICAgdmFsID0gdmFsLm5hbWU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdmFsID0gSXRlbU9iamVjdFt2YXJpYWJsZV07XG4gICAgfVxuICAgIGlmICh2YWwgJiYgdGhpcy5zeXMuZ2V0QWJicmV2aWF0aW9uKSB7XG4gICAgICAgIHZhciBqdXJpc2RpY3Rpb24gPSB0aGlzLnRyYW5zZm9ybS5sb2FkQWJicmV2aWF0aW9uKEl0ZW1PYmplY3QuanVyaXNkaWN0aW9uLCBcIm51bWJlclwiLCB2YWwpO1xuICAgICAgICBpZiAodGhpcy50cmFuc2Zvcm0uYWJicmV2c1tqdXJpc2RpY3Rpb25dLm51bWJlcikge1xuICAgICAgICAgICAgaWYgKHRoaXMudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXS5udW1iZXJbdmFsXSkge1xuICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXS5udW1iZXJbdmFsXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB0aGlzLnRyYW5zZm9ybS5hYmJyZXZzW2p1cmlzZGljdGlvbl0ubnVtYmVyW3ZhbF0pIHtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMudHJhbnNmb3JtLmFiYnJldnNbanVyaXNkaWN0aW9uXS5udW1iZXJbdmFsXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB2YWwgJiYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiB2YWwgfHwgXCJudW1iZXJcIiA9PT0gdHlwZW9mIHZhbCkpIHtcbiAgICAgICAgaWYgKFwibnVtYmVyXCIgPT09IHR5cGVvZiB2YWwpIHtcbiAgICAgICAgICAgIHZhbCA9IFwiXCIgKyB2YWw7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGRlZmF1bHRMYWJlbCA9IENTTC5TVEFUVVRFX1NVQkRJVl9TVFJJTkdTX1JFVkVSU0VbdmFyaWFibGVdO1xuICAgICAgICBpZiAoIXRoaXMudG1wLnNoYWRvd19udW1iZXJzLnZhbHVlcykge1xuICAgICAgICAgICAgdmFyIHZhbHVlcyA9IHBhcnNlU3RyaW5nKHZhbCwgZGVmYXVsdExhYmVsKTtcbiAgICAgICAgICAgIHNldFNwYWNlcyh2YWx1ZXMpO1xuICAgICAgICAgICAgc2V0UGx1cmFsc0FuZE51bWVyaWNzKHZhbHVlcyk7XG4gICAgICAgICAgICB0aGlzLnRtcC5zaGFkb3dfbnVtYmVyc1t2YXJpYWJsZV0udmFsdWVzID0gdmFsdWVzO1xuICAgICAgICB9XG4gICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICBmaXhSYW5nZXModmFsdWVzKTtcbiAgICAgICAgICAgIHRoaXMudG1wLnNoYWRvd19udW1iZXJzW3ZhcmlhYmxlXS5tYXN0ZXJTdHlsaW5nID0gc2V0U3R5bGluZyh2YWx1ZXMpXG4gICAgICAgIH1cbiAgICAgICAgc2V0VmFyaWFibGVQYXJhbXModGhpcy50bXAuc2hhZG93X251bWJlcnMsIHZhcmlhYmxlLCB2YWx1ZXMpO1xuICAgIH1cbn07XG5DU0wuVXRpbC5vdXRwdXROdW1lcmljRmllbGQgPSBmdW5jdGlvbihzdGF0ZSwgdmFybmFtZSwgaXRlbUlEKSB7XG4gICAgc3RhdGUub3V0cHV0Lm9wZW5MZXZlbChzdGF0ZS50bXAuc2hhZG93X251bWJlcnNbdmFybmFtZV0ubWFzdGVyU3R5bGluZyk7XG4gICAgdmFyIG51bXMgPSBzdGF0ZS50bXAuc2hhZG93X251bWJlcnNbdmFybmFtZV0udmFsdWVzO1xuICAgIHZhciBtYXN0ZXJMYWJlbCA9IG51bXMubGVuZ3RoID8gbnVtc1swXS5sYWJlbCA6IG51bGw7XG4gICAgdmFyIGxhYmVsRm9ybSA9IHN0YXRlLnRtcC5zaGFkb3dfbnVtYmVyc1t2YXJuYW1lXS5sYWJlbEZvcm07XG4gICAgdmFyIGVtYmVkZGVkTGFiZWxGb3JtO1xuICAgIGlmIChsYWJlbEZvcm0pIHtcbiAgICAgICAgZW1iZWRkZWRMYWJlbEZvcm0gPSBsYWJlbEZvcm1cbiAgICB9IGVsc2Uge1xuICAgICAgICBlbWJlZGRlZExhYmVsRm9ybSA9IFwic2hvcnRcIjtcbiAgICB9XG4gICAgdmFyIGxhYmVsRGVjb3JhdGlvbnMgPSBzdGF0ZS50bXAuc2hhZG93X251bWJlcnNbdmFybmFtZV0ubGFiZWxEZWNvcmF0aW9ucztcbiAgICB2YXIgbGFzdExhYmVsTmFtZSA9IG51bGw7XG4gICAgZm9yICh2YXIgaT0wLGlsZW49bnVtcy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICB2YXIgbnVtID0gbnVtc1tpXTtcbiAgICAgICAgdmFyIGxhYmVsID0gXCJcIjtcbiAgICAgICAgaWYgKG51bS5sYWJlbCkge1xuICAgICAgICAgICAgdmFyIGxhYmVsTmFtZTtcbiAgICAgICAgICAgIGlmICgndmFyOicgPT09IG51bS5sYWJlbC5zbGljZSgwLDQpKSB7XG4gICAgICAgICAgICAgICAgbGFiZWxOYW1lID0gbnVtLmxhYmVsLnNsaWNlKDQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsYWJlbE5hbWUgPSBDU0wuU1RBVFVURV9TVUJESVZfU1RSSU5HU1tudW0ubGFiZWxdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGxhYmVsTmFtZSkge1xuICAgICAgICAgICAgICAgIGlmIChudW0ubGFiZWwgPT09IG1hc3RlckxhYmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhYmVsID0gc3RhdGUuZ2V0VGVybShsYWJlbE5hbWUsIGxhYmVsRm9ybSwgbnVtLnBsdXJhbCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBzdGF0ZS5nZXRUZXJtKGxhYmVsTmFtZSwgZW1iZWRkZWRMYWJlbEZvcm0sIG51bS5wbHVyYWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgbGFiZWxQbGFjZWhvbGRlclBvcyA9IC0xO1xuICAgICAgICBpZiAobGFiZWwpIHtcbiAgICAgICAgICAgIGxhYmVsUGxhY2Vob2xkZXJQb3MgPSBsYWJlbC5pbmRleE9mKFwiJXNcIik7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG51bVN0eWxpbmcgPSBDU0wuVXRpbC5jbG9uZVRva2VuKG51bS5zdHlsaW5nKTtcbiAgICAgICAgbnVtU3R5bGluZy5mb3JtYXR0ZXIgPSBudW0uc3R5bGluZy5mb3JtYXR0ZXI7XG4gICAgICAgIG51bVN0eWxpbmcudHlwZSA9IG51bS5zdHlsaW5nLnR5cGU7XG4gICAgICAgIG51bVN0eWxpbmcubnVtID0gbnVtLnN0eWxpbmcubnVtO1xuICAgICAgICBudW1TdHlsaW5nLmdlbmRlciA9IG51bS5zdHlsaW5nLmdlbmRlcjtcbiAgICAgICAgaWYgKGxhYmVsUGxhY2Vob2xkZXJQb3MgPiAwICYmIGxhYmVsUGxhY2Vob2xkZXJQb3MgPCAobGFiZWwubGVuZ3RoLTIpKSB7XG4gICAgICAgICAgICBudW1TdHlsaW5nLnN0cmluZ3MucHJlZml4ICs9IGxhYmVsLnNsaWNlKDAsbGFiZWxQbGFjZWhvbGRlclBvcyk7XG4gICAgICAgICAgICBudW1TdHlsaW5nLnN0cmluZ3Muc3VmZml4ID0gbGFiZWwuc2xpY2UobGFiZWxQbGFjZWhvbGRlclBvcysyKSArIG51bVN0eWxpbmcuc3RyaW5ncy5zdWZmaXg7XG4gICAgICAgIH0gZWxzZSBpZiAobnVtLmxhYmVsVmlzaWJpbGl0eSkge1xuICAgICAgICAgICAgaWYgKCFsYWJlbCkge1xuICAgICAgICAgICAgICAgIGxhYmVsID0gbnVtLmxhYmVsO1xuICAgICAgICAgICAgICAgIGxhYmVsTmFtZSA9IG51bS5sYWJlbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChsYWJlbFBsYWNlaG9sZGVyUG9zID4gMCkge1xuICAgICAgICAgICAgICAgIHZhciBwcmVmaXhMYWJlbFN0eWxpbmcgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgICAgICAgICAgICAgcHJlZml4TGFiZWxTdHlsaW5nLmRlY29yYXRpb25zID0gbGFiZWxEZWNvcmF0aW9ucztcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKGxhYmVsLnNsaWNlKDAsbGFiZWxQbGFjZWhvbGRlclBvcyksIHByZWZpeExhYmVsU3R5bGluZyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGxhYmVsUGxhY2Vob2xkZXJQb3MgPT09IChsYWJlbC5sZW5ndGgtMikgfHwgbGFiZWxQbGFjZWhvbGRlclBvcyA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKGxhYmVsK251bS5sYWJlbFN1ZmZpeCwgXCJlbXB0eVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAobnVtLmNvbGxhcHNpYmxlKSB7XG4gICAgICAgICAgICBpZiAobnVtLnZhbHVlLm1hdGNoKC9eWzAtOV0rJC8pKSB7XG4gICAgICAgICAgICAgICAgdmFyIGJsb2IgPSBuZXcgQ1NMLk51bWVyaWNCbG9iKG51bS5wYXJ0aWNsZSwgcGFyc2VJbnQobnVtLnZhbHVlLCAxMCksIG51bVN0eWxpbmcsIGl0ZW1JRCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBibG9iID0gbmV3IENTTC5OdW1lcmljQmxvYihudW0ucGFydGljbGUsIG51bS52YWx1ZSwgbnVtU3R5bGluZywgaXRlbUlEKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgYmxvYi5nZW5kZXIpIHtcbiAgICAgICAgICAgICAgICBibG9iLmdlbmRlciA9IHN0YXRlLmxvY2FsZVtzdGF0ZS5vcHQubGFuZ11bXCJub3VuLWdlbmRlcnNcIl1bdmFybmFtZV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKGJsb2IsIFwibGl0ZXJhbFwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0YXRlLm91dHB1dC5hcHBlbmQobnVtLnBhcnRpY2xlICsgbnVtLnZhbHVlLCBudW1TdHlsaW5nKVxuICAgICAgICB9XG4gICAgICAgIGlmIChsYWJlbFBsYWNlaG9sZGVyUG9zID09PSAwICYmIGxhYmVsUGxhY2Vob2xkZXJQb3MgPCAobGFiZWwubGVuZ3RoLTIpKSB7XG4gICAgICAgICAgICBpZiAobGFzdExhYmVsTmFtZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGxhc3RMYWJlbE5hbWUgPSBsYWJlbE5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobGFiZWxOYW1lICE9PSBsYXN0TGFiZWxOYW1lIHx8IGkgPT09IChudW1zLmxlbmd0aC0xKSkge1xuICAgICAgICAgICAgICAgIHZhciBzdWZmaXhMYWJlbFN0eWxpbmcgPSBuZXcgQ1NMLlRva2VuKCk7XG4gICAgICAgICAgICAgICAgc3VmZml4TGFiZWxTdHlsaW5nLmRlY29yYXRpb25zID0gbGFiZWxEZWNvcmF0aW9ucztcbiAgICAgICAgICAgICAgICBzdGF0ZS5vdXRwdXQuYXBwZW5kKGxhYmVsLnNsaWNlKGxhYmVsUGxhY2Vob2xkZXJQb3MrMiksIHN1ZmZpeExhYmVsU3R5bGluZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgbGFzdExhYmVsTmFtZSA9PT0gbGFiZWxOYW1lO1xuICAgIH1cbiAgICBzdGF0ZS5vdXRwdXQuY2xvc2VMZXZlbCgpO1xufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuVXRpbC5QYWdlUmFuZ2VNYW5nbGVyID0ge307XG5DU0wuVXRpbC5QYWdlUmFuZ2VNYW5nbGVyLmdldEZ1bmN0aW9uID0gZnVuY3Rpb24gKHN0YXRlLCByYW5nZVR5cGUpIHtcbiAgICB2YXIgcmFuZ2VyZXgsIHBvcywgbGVuLCBzdHJpbmdpZnksIGxpc3RpZnksIGV4cGFuZCwgbWluaW1pemUsIG1pbmltaXplX2ludGVybmFsLCBjaGljYWdvLCBsc3QsIG0sIGIsIGUsIHJldCwgYmVnaW4sIGVuZCwgcmV0X2Z1bmMsIHBwb3MsIGxsZW47XG4gICAgdmFyIHJhbmdlX2RlbGltaXRlciA9IHN0YXRlLmdldFRlcm0ocmFuZ2VUeXBlICsgXCItcmFuZ2UtZGVsaW1pdGVyXCIpO1xuICAgIHJhbmdlcmV4ID0gLyhbYS16QS1aXSopKFswLTldKylcXHMqKD86XFx1MjAxM3wtKVxccyooW2EtekEtWl0qKShbMC05XSspLztcbiAgICBzdHJpbmdpZnkgPSBmdW5jdGlvbiAobHN0KSB7XG4gICAgICAgIGxlbiA9IGxzdC5sZW5ndGg7XG4gICAgICAgIGZvciAocG9zID0gMTsgcG9zIDwgbGVuOyBwb3MgKz0gMikge1xuICAgICAgICAgICAgaWYgKFwib2JqZWN0XCIgPT09IHR5cGVvZiBsc3RbcG9zXSkge1xuICAgICAgICAgICAgICAgIGxzdFtwb3NdID0gbHN0W3Bvc10uam9pbihcIlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgcmV0ID0gbHN0LmpvaW4oXCJcIik7XG4gICAgICAgIHJldCA9IHJldC5yZXBsYWNlKC8oW15cXFxcXSlcXC0vZywgXCIkMVwiK3N0YXRlLmdldFRlcm0ocmFuZ2VUeXBlICsgXCItcmFuZ2UtZGVsaW1pdGVyXCIpKTtcbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuICAgIGxpc3RpZnkgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgIHZhciBtLCBsc3QsIHJldDtcbiAgICAgICAgdmFyIGh5cGhlbnMgPSBcIlxcXFxzK1xcXFwtXFxcXHMrXCI7XG4gICAgICAgIHZhciB0aGlzX3JhbmdlX2RlbGltaXRlciA9IHJhbmdlX2RlbGltaXRlciA9PT0gXCItXCIgPyBcIlwiIDogcmFuZ2VfZGVsaW1pdGVyO1xuICAgICAgICB2YXIgZGVsaW1SZXggPSBuZXcgUmVnRXhwKFwiKFteXFxcXFxcXFxdKVstXCIgKyB0aGlzX3JhbmdlX2RlbGltaXRlciArIFwiXFxcXHUyMDEzXVwiLCBcImdcIik7XG4gICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKGRlbGltUmV4LCBcIiQxIC0gXCIpLnJlcGxhY2UoL1xccystXFxzKy9nLCBcIiAtIFwiKTtcbiAgICAgICAgdmFyIHJleG0gPSBuZXcgUmVnRXhwKFwiKFthLXpBLVpdKlswLTldK1wiICsgaHlwaGVucyArIFwiW2EtekEtWl0qWzAtOV0rKVwiLCBcImdcIik7XG4gICAgICAgIHZhciByZXhsc3QgPSBuZXcgUmVnRXhwKFwiW2EtekEtWl0qWzAtOV0rXCIgKyBoeXBoZW5zICsgXCJbYS16QS1aXSpbMC05XStcIik7XG4gICAgICAgIG0gPSBzdHIubWF0Y2gocmV4bSk7XG4gICAgICAgIGxzdCA9IHN0ci5zcGxpdChyZXhsc3QpO1xuICAgICAgICBpZiAobHN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0ID0gbTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldCA9IFtsc3RbMF1dO1xuICAgICAgICAgICAgZm9yIChwb3MgPSAxLCBsZW4gPSBsc3QubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICAgICAgcmV0LnB1c2gobVtwb3MgLSAxXS5yZXBsYWNlKC9cXHMqXFwtXFxzKi9nLCBcIi1cIikpO1xuICAgICAgICAgICAgICAgIHJldC5wdXNoKGxzdFtwb3NdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH07XG4gICAgZXhwYW5kID0gZnVuY3Rpb24gKHN0cikge1xuICAgICAgICBzdHIgPSBcIlwiICsgc3RyO1xuICAgICAgICBsc3QgPSBsaXN0aWZ5KHN0cik7XG4gICAgICAgIGxlbiA9IGxzdC5sZW5ndGg7XG4gICAgICAgIGZvciAocG9zID0gMTsgcG9zIDwgbGVuOyBwb3MgKz0gMikge1xuICAgICAgICAgICAgbSA9IGxzdFtwb3NdLm1hdGNoKHJhbmdlcmV4KTtcbiAgICAgICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFtWzNdIHx8IG1bMV0gPT09IG1bM10pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1bNF0ubGVuZ3RoIDwgbVsyXS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1bNF0gPSBtWzJdLnNsaWNlKDAsIChtWzJdLmxlbmd0aCAtIG1bNF0ubGVuZ3RoKSkgKyBtWzRdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJzZUludChtWzJdLCAxMCkgPCBwYXJzZUludChtWzRdLCAxMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1bM10gPSByYW5nZV9kZWxpbWl0ZXIgKyBtWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgbHN0W3Bvc10gPSBtLnNsaWNlKDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBsc3RbcG9zXSkge1xuICAgICAgICAgICAgICAgIGxzdFtwb3NdID0gbHN0W3Bvc10ucmVwbGFjZSgvXFwtL2csIHJhbmdlX2RlbGltaXRlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxzdDtcbiAgICB9O1xuICAgIG1pbmltaXplID0gZnVuY3Rpb24gKGxzdCwgbWluY2hhcnMsIGlzeWVhcikge1xuICAgICAgICBsZW4gPSBsc3QubGVuZ3RoO1xuICAgICAgICBmb3IgKHZhciBpID0gMSwgaWxlbiA9IGxzdC5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDIpIHtcbiAgICAgICAgICAgIGxzdFtpXVszXSA9IG1pbmltaXplX2ludGVybmFsKGxzdFtpXVsxXSwgbHN0W2ldWzNdLCBtaW5jaGFycywgaXN5ZWFyKTtcbiAgICAgICAgICAgIGlmIChsc3RbaV1bMl0uc2xpY2UoMSkgPT09IGxzdFtpXVswXSkge1xuICAgICAgICAgICAgICAgIGxzdFtpXVsyXSA9IHJhbmdlX2RlbGltaXRlcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3RyaW5naWZ5KGxzdCk7XG4gICAgfTtcbiAgICBtaW5pbWl6ZV9pbnRlcm5hbCA9IGZ1bmN0aW9uIChiZWdpbiwgZW5kLCBtaW5jaGFycywgaXN5ZWFyKSB7XG4gICAgICAgIGlmICghbWluY2hhcnMpIHtcbiAgICAgICAgICAgIG1pbmNoYXJzID0gMDtcbiAgICAgICAgfVxuICAgICAgICBiID0gKFwiXCIgKyBiZWdpbikuc3BsaXQoXCJcIik7XG4gICAgICAgIGUgPSAoXCJcIiArIGVuZCkuc3BsaXQoXCJcIik7XG4gICAgICAgIHJldCA9IGUuc2xpY2UoKTtcbiAgICAgICAgcmV0LnJldmVyc2UoKTtcbiAgICAgICAgaWYgKGIubGVuZ3RoID09PSBlLmxlbmd0aCkge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBiLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIGlmIChiW2ldID09PSBlW2ldICYmIHJldC5sZW5ndGggPiBtaW5jaGFycykge1xuICAgICAgICAgICAgICAgICAgICByZXQucG9wKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1pbmNoYXJzICYmIGlzeWVhciAmJiByZXQubGVuZ3RoID09PSAzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZnJvbnQgPSBiLnNsaWNlKDAsIGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZnJvbnQucmV2ZXJzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gcmV0LmNvbmNhdChmcm9udCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldC5yZXZlcnNlKCk7XG4gICAgICAgIHJldHVybiByZXQuam9pbihcIlwiKTtcbiAgICB9O1xuICAgIGNoaWNhZ28gPSBmdW5jdGlvbiAobHN0KSB7XG4gICAgICAgIGxlbiA9IGxzdC5sZW5ndGg7XG4gICAgICAgIGZvciAocG9zID0gMTsgcG9zIDwgbGVuOyBwb3MgKz0gMikge1xuICAgICAgICAgICAgaWYgKFwib2JqZWN0XCIgPT09IHR5cGVvZiBsc3RbcG9zXSkge1xuICAgICAgICAgICAgICAgIG0gPSBsc3RbcG9zXTtcbiAgICAgICAgICAgICAgICBiZWdpbiA9IHBhcnNlSW50KG1bMV0sIDEwKTtcbiAgICAgICAgICAgICAgICBlbmQgPSBwYXJzZUludChtWzNdLCAxMCk7XG4gICAgICAgICAgICAgICAgaWYgKGJlZ2luID4gMTAwICYmIGJlZ2luICUgMTAwICYmIHBhcnNlSW50KChiZWdpbiAvIDEwMCksIDEwKSA9PT0gcGFyc2VJbnQoKGVuZCAvIDEwMCksIDEwKSkge1xuICAgICAgICAgICAgICAgICAgICBtWzNdID0gXCJcIiArIChlbmQgJSAxMDApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmVnaW4gPj0gMTAwMDApIHtcbiAgICAgICAgICAgICAgICAgICAgbVszXSA9IFwiXCIgKyAoZW5kICUgMTAwMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG1bMl0uc2xpY2UoMSkgPT09IG1bMF0pIHtcbiAgICAgICAgICAgICAgICBtWzJdID0gcmFuZ2VfZGVsaW1pdGVyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdHJpbmdpZnkobHN0KTtcbiAgICB9O1xuICAgIHZhciBzbmlmZiA9IGZ1bmN0aW9uIChzdHIsIGZ1bmMsIG1pbmNoYXJzLCBpc3llYXIpIHtcbiAgICAgICAgdmFyIHJldDtcblx0XHRzdHIgPSBcIlwiICsgc3RyO1xuXHRcdHZhciBsc3QgPSBleHBhbmQoc3RyKTtcbiAgICAgICAgdmFyIHJldCA9IGZ1bmMobHN0LCBtaW5jaGFycywgaXN5ZWFyKTtcbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG4gICAgaWYgKCFzdGF0ZS5vcHRbcmFuZ2VUeXBlICsgXCItcmFuZ2UtZm9ybWF0XCJdKSB7XG4gICAgICAgIHJldF9mdW5jID0gZnVuY3Rpb24gKHN0cikge1xuICAgICAgICAgICAgcmV0dXJuIHNuaWZmKHN0ciwgc3RyaW5naWZ5KTtcbiAgICAgICAgfTtcbiAgICB9IGVsc2UgaWYgKHN0YXRlLm9wdFtyYW5nZVR5cGUgKyBcIi1yYW5nZS1mb3JtYXRcIl0gPT09IFwiZXhwYW5kZWRcIikge1xuICAgICAgICByZXRfZnVuYyA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgICAgIHJldHVybiBzbmlmZihzdHIsIHN0cmluZ2lmeSk7XG4gICAgICAgIH07XG4gICAgfSBlbHNlIGlmIChzdGF0ZS5vcHRbcmFuZ2VUeXBlICsgXCItcmFuZ2UtZm9ybWF0XCJdID09PSBcIm1pbmltYWxcIikge1xuICAgICAgICByZXRfZnVuYyA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgICAgIHJldHVybiBzbmlmZihzdHIsIG1pbmltaXplKTtcbiAgICAgICAgfTtcbiAgICB9IGVsc2UgaWYgKHN0YXRlLm9wdFtyYW5nZVR5cGUgKyBcIi1yYW5nZS1mb3JtYXRcIl0gPT09IFwibWluaW1hbC10d29cIikge1xuICAgICAgICByZXRfZnVuYyA9IGZ1bmN0aW9uIChzdHIsIGlzeWVhcikge1xuICAgICAgICAgICAgcmV0dXJuIHNuaWZmKHN0ciwgbWluaW1pemUsIDIsIGlzeWVhcik7XG4gICAgICAgIH07XG4gICAgfSBlbHNlIGlmIChzdGF0ZS5vcHRbcmFuZ2VUeXBlICsgXCItcmFuZ2UtZm9ybWF0XCJdID09PSBcImNoaWNhZ29cIikge1xuICAgICAgICByZXRfZnVuYyA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgICAgIHJldHVybiBzbmlmZihzdHIsIGNoaWNhZ28pO1xuICAgICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gcmV0X2Z1bmM7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuVXRpbC5GbGlwRmxvcHBlciA9IGZ1bmN0aW9uKHN0YXRlKSB7XG4gICAgdGhpcy5wcm9jZXNzVGFncyA9IHByb2Nlc3NUYWdzO1xuICAgIHZhciBfbmVzdGluZ1N0YXRlID0gW107XG4gICAgdmFyIF9uZXN0aW5nRGF0YSA9IHtcbiAgICAgICAgXCI8c3BhbiBjbGFzcz1cXFwibm9jYXNlXFxcIj5cIjoge1xuICAgICAgICAgICAgdHlwZTogXCJub2Nhc2VcIixcbiAgICAgICAgICAgIG9wZW5lcjogXCI8c3BhbiBjbGFzcz1cXFwibm9jYXNlXFxcIj5cIixcbiAgICAgICAgICAgIGNsb3NlcjogXCI8L3NwYW4+XCIsXG4gICAgICAgICAgICBhdHRyOiBudWxsLFxuICAgICAgICAgICAgb3V0ZXI6IG51bGwsXG4gICAgICAgICAgICBmbGlwZmxvcDogbnVsbFxuICAgICAgICB9LFxuICAgICAgICBcIjxzcGFuIGNsYXNzPVxcXCJub2RlY29yXFxcIj5cIjoge1xuICAgICAgICAgICAgdHlwZTogXCJub2RlY29yXCIsXG4gICAgICAgICAgICBvcGVuZXI6IFwiPHNwYW4gY2xhc3M9XFxcIm5vZGVjb3JcXFwiPlwiLFxuICAgICAgICAgICAgY2xvc2VyOiBcIjwvc3Bhbj5cIixcbiAgICAgICAgICAgIGF0dHI6IFwiQGNsYXNzXCIsXG4gICAgICAgICAgICBvdXRlcjogXCJub2RlY29yXCIsXG4gICAgICAgICAgICBmbGlwZmxvcDoge1xuICAgICAgICAgICAgICAgIFwibm9kZWNvclwiOiBcIm5vZGVjb3JcIlxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBcIjxzcGFuIHN0eWxlPVxcXCJmb250LXZhcmlhbnQ6c21hbGwtY2FwcztcXFwiPlwiOiB7XG4gICAgICAgICAgICB0eXBlOiBcInRhZ1wiLFxuICAgICAgICAgICAgb3BlbmVyOiBcIjxzcGFuIHN0eWxlPVxcXCJmb250LXZhcmlhbnQ6c21hbGwtY2FwcztcXFwiPlwiLFxuICAgICAgICAgICAgY2xvc2VyOiBcIjwvc3Bhbj5cIixcbiAgICAgICAgICAgIGF0dHI6IFwiQGZvbnQtdmFyaWFudFwiLFxuICAgICAgICAgICAgb3V0ZXI6IFwic21hbGwtY2Fwc1wiLFxuICAgICAgICAgICAgZmxpcGZsb3A6IHtcbiAgICAgICAgICAgICAgICBcInNtYWxsLWNhcHNcIjogXCJub3JtYWxcIixcbiAgICAgICAgICAgICAgICBcIm5vcm1hbFwiOiBcInNtYWxsLWNhcHNcIlxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBcIjxzYz5cIjoge1xuICAgICAgICAgICAgdHlwZTogXCJ0YWdcIixcbiAgICAgICAgICAgIG9wZW5lcjogXCI8c2M+XCIsXG4gICAgICAgICAgICBjbG9zZXI6IFwiPC9zYz5cIixcbiAgICAgICAgICAgIGF0dHI6IFwiQGZvbnQtdmFyaWFudFwiLFxuICAgICAgICAgICAgb3V0ZXI6IFwic21hbGwtY2Fwc1wiLFxuICAgICAgICAgICAgZmxpcGZsb3A6IHtcbiAgICAgICAgICAgICAgICBcInNtYWxsLWNhcHNcIjogXCJub3JtYWxcIixcbiAgICAgICAgICAgICAgICBcIm5vcm1hbFwiOiBcInNtYWxsLWNhcHNcIlxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBcIjxpPlwiOiB7XG4gICAgICAgICAgICB0eXBlOiBcInRhZ1wiLFxuICAgICAgICAgICAgb3BlbmVyOiBcIjxpPlwiLFxuICAgICAgICAgICAgY2xvc2VyOiBcIjwvaT5cIixcbiAgICAgICAgICAgIGF0dHI6IFwiQGZvbnQtc3R5bGVcIixcbiAgICAgICAgICAgIG91dGVyOiBcIml0YWxpY1wiLFxuICAgICAgICAgICAgZmxpcGZsb3A6IHtcbiAgICAgICAgICAgICAgICBcIml0YWxpY1wiOiBcIm5vcm1hbFwiLFxuICAgICAgICAgICAgICAgIFwibm9ybWFsXCI6IFwiaXRhbGljXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgXCI8Yj5cIjoge1xuICAgICAgICAgICAgdHlwZTogXCJ0YWdcIixcbiAgICAgICAgICAgIG9wZW5lcjogXCI8Yj5cIixcbiAgICAgICAgICAgIGNsb3NlcjogXCI8L2I+XCIsXG4gICAgICAgICAgICBhdHRyOiBcIkBmb250LXdlaWdodFwiLFxuICAgICAgICAgICAgb3V0ZXI6IFwiYm9sZFwiLFxuICAgICAgICAgICAgZmxpcGZsb3A6IHtcbiAgICAgICAgICAgICAgICBcImJvbGRcIjogXCJub3JtYWxcIixcbiAgICAgICAgICAgICAgICBcIm5vcm1hbFwiOiBcImJvbGRcIlxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBcIjxzdXA+XCI6IHtcbiAgICAgICAgICAgIHR5cGU6IFwidGFnXCIsXG4gICAgICAgICAgICBvcGVuZXI6IFwiPHN1cD5cIixcbiAgICAgICAgICAgIGNsb3NlcjogXCI8L3N1cD5cIixcbiAgICAgICAgICAgIGF0dHI6IFwiQHZlcnRpY2FsLWFsaWduXCIsXG4gICAgICAgICAgICBvdXRlcjogXCJzdXBcIixcbiAgICAgICAgICAgIGZsaXBmbG9wOiB7XG4gICAgICAgICAgICAgICAgXCJzdWJcIjogXCJzdXBcIixcbiAgICAgICAgICAgICAgICBcInN1cFwiOiBcInN1cFwiXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIFwiPHN1Yj5cIjoge1xuICAgICAgICAgICAgdHlwZTogXCJ0YWdcIixcbiAgICAgICAgICAgIG9wZW5lcjogXCI8c3ViPlwiLFxuICAgICAgICAgICAgY2xvc2VyOiBcIjwvc3ViPlwiLFxuICAgICAgICAgICAgYXR0cjogXCJAdmVydGljYWwtYWxpZ25cIixcbiAgICAgICAgICAgIG91dGVyOiBcInN1YlwiLFxuICAgICAgICAgICAgZmxpcGZsb3A6IHtcbiAgICAgICAgICAgICAgICBcInN1cFwiOiBcInN1YlwiLFxuICAgICAgICAgICAgICAgIFwic3ViXCI6IFwic3ViXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgXCIgXFxcIlwiOiB7XG4gICAgICAgICAgICB0eXBlOiBcInF1b3RlXCIsXG4gICAgICAgICAgICBvcGVuZXI6IFwiIFxcXCJcIixcbiAgICAgICAgICAgIGNsb3NlcjogXCJcXFwiXCIsXG4gICAgICAgICAgICBhdHRyOiBcIkBxdW90ZXNcIixcbiAgICAgICAgICAgIG91dGVyOiBcInRydWVcIixcbiAgICAgICAgICAgIGZsaXBmbG9wOiB7XG4gICAgICAgICAgICAgICAgXCJ0cnVlXCI6IFwiaW5uZXJcIixcbiAgICAgICAgICAgICAgICBcImlubmVyXCI6IFwidHJ1ZVwiLFxuICAgICAgICAgICAgICAgIFwiZmFsc2VcIjogXCJ0cnVlXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgXCIgXFwnXCI6IHtcbiAgICAgICAgICAgIHR5cGU6IFwicXVvdGVcIixcbiAgICAgICAgICAgIG9wZW5lcjogXCIgXFwnXCIsXG4gICAgICAgICAgICBjbG9zZXI6IFwiXFwnXCIsXG4gICAgICAgICAgICBhdHRyOiBcIkBxdW90ZXNcIixcbiAgICAgICAgICAgIG91dGVyOiBcImlubmVyXCIsXG4gICAgICAgICAgICBmbGlwZmxvcDoge1xuICAgICAgICAgICAgICAgIFwidHJ1ZVwiOiBcImlubmVyXCIsXG4gICAgICAgICAgICAgICAgXCJpbm5lclwiOiBcInRydWVcIixcbiAgICAgICAgICAgICAgICBcImZhbHNlXCI6IFwidHJ1ZVwiXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgX25lc3RpbmdEYXRhW1wiKFxcXCJcIl0gPSBfbmVzdGluZ0RhdGFbXCIgXFxcIlwiXVxuICAgIF9uZXN0aW5nRGF0YVtcIihcXCdcIl0gPSBfbmVzdGluZ0RhdGFbXCIgXFwnXCJdXG4gICAgdmFyIGxvY2FsZU9wZW5RdW90ZSA9IHN0YXRlLmdldFRlcm0oXCJvcGVuLXF1b3RlXCIpO1xuICAgIHZhciBsb2NhbGVDbG9zZVF1b3RlID0gc3RhdGUuZ2V0VGVybShcImNsb3NlLXF1b3RlXCIpO1xuICAgIHZhciBsb2NhbGVPcGVuSW5uZXJRdW90ZSA9IHN0YXRlLmdldFRlcm0oXCJvcGVuLWlubmVyLXF1b3RlXCIpO1xuICAgIHZhciBsb2NhbGVDbG9zZUlubmVyUXVvdGUgPSBzdGF0ZS5nZXRUZXJtKFwiY2xvc2UtaW5uZXItcXVvdGVcIik7XG4gICAgaWYgKGxvY2FsZU9wZW5RdW90ZSAmJiBsb2NhbGVDbG9zZVF1b3RlICYmIFtcIiBcXFwiXCIsXCIgXFwnXCIsXCJcXFwiXCIsXCJcXCdcIl0uaW5kZXhPZihsb2NhbGVPcGVuUXVvdGUpID09PSAtMSkge1xuICAgICAgICBfbmVzdGluZ0RhdGFbbG9jYWxlT3BlblF1b3RlXSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoX25lc3RpbmdEYXRhW1wiIFxcXCJcIl0pKTtcbiAgICAgICAgX25lc3RpbmdEYXRhW2xvY2FsZU9wZW5RdW90ZV0ub3BlbmVyID0gbG9jYWxlT3BlblF1b3RlO1xuICAgICAgICBfbmVzdGluZ0RhdGFbbG9jYWxlT3BlblF1b3RlXS5jbG9zZXIgPSBsb2NhbGVDbG9zZVF1b3RlO1xuICAgIH1cbiAgICBpZiAobG9jYWxlT3BlbklubmVyUXVvdGUgJiYgbG9jYWxlQ2xvc2VJbm5lclF1b3RlICYmIFtcIiBcXFwiXCIsXCIgXFwnXCIsXCJcXFwiXCIsXCJcXCdcIl0uaW5kZXhPZihsb2NhbGVPcGVuSW5uZXJRdW90ZSkgPT09IC0xKSB7XG4gICAgICAgIF9uZXN0aW5nRGF0YVtsb2NhbGVPcGVuSW5uZXJRdW90ZV0gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KF9uZXN0aW5nRGF0YVtcIiBcXCdcIl0pKTtcbiAgICAgICAgX25lc3RpbmdEYXRhW2xvY2FsZU9wZW5Jbm5lclF1b3RlXS5vcGVuZXIgPSBsb2NhbGVPcGVuSW5uZXJRdW90ZTtcbiAgICAgICAgX25lc3RpbmdEYXRhW2xvY2FsZU9wZW5Jbm5lclF1b3RlXS5jbG9zZXIgPSBsb2NhbGVDbG9zZUlubmVyUXVvdGU7XG4gICAgfVxuICAgIHZhciBfbmVzdGluZ1F1b3RlUmV2ZXJzZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgcmV0ID0ge307XG4gICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoX25lc3RpbmdEYXRhKTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07XG4gICAgICAgICAgICBpZiAoX25lc3RpbmdEYXRhW2tleV0udHlwZSA9PT0gXCJxdW90ZVwiKSB7XG4gICAgICAgICAgICAgICAgcmV0W19uZXN0aW5nRGF0YVtrZXldLmNsb3Nlcl0gPSBfbmVzdGluZ0RhdGFba2V5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH0oKTtcbiAgICB2YXIgX25lc3RpbmdEYXRhQXR0ciA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgcmV0ID0ge307XG4gICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoX25lc3RpbmdEYXRhKTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07XG4gICAgICAgICAgICBpZiAoX25lc3RpbmdEYXRhW2tleV0udHlwZSA9PT0gXCJub2Nhc2VcIikgY29udGludWU7XG4gICAgICAgICAgICB2YXIgYXR0ciA9IF9uZXN0aW5nRGF0YVtrZXldLmF0dHI7XG4gICAgICAgICAgICB2YXIgb3V0ZXIgPSBfbmVzdGluZ0RhdGFba2V5XS5vdXRlcjtcbiAgICAgICAgICAgIHZhciBpbm5lciA9IF9uZXN0aW5nRGF0YVtrZXldLmZsaXBmbG9wW19uZXN0aW5nRGF0YVtrZXldLm91dGVyXTtcbiAgICAgICAgICAgIHJldFthdHRyICsgXCIvXCIgKyBvdXRlcl0gPSBfbmVzdGluZ0RhdGFba2V5XTtcbiAgICAgICAgICAgIHJldFthdHRyICsgXCIvXCIgKyBpbm5lcl0gPSBfbmVzdGluZ0RhdGFba2V5XTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH0oKTtcbiAgICBmdW5jdGlvbiBfc2V0T3V0ZXJRdW90ZUZvcm0ocXVvdCkge1xuICAgICAgICB2YXIgZmxpcCA9IHtcbiAgICAgICAgICAgIFwiIFxcJ1wiOiBcIiBcXFwiXCIsXG4gICAgICAgICAgICBcIiBcXFwiXCI6IFwiIFxcJ1wiLFxuICAgICAgICAgICAgXCIoXFxcIlwiOiBcIihcXCdcIixcbiAgICAgICAgICAgIFwiKFxcJ1wiOiBcIihcXFwiXCJcbiAgICAgICAgfVxuICAgICAgICBfbmVzdGluZ0RhdGFbcXVvdF0ub3V0ZXIgPSBcInRydWVcIjtcbiAgICAgICAgX25lc3RpbmdEYXRhW2ZsaXBbcXVvdF1dLm91dGVyID0gXCJpbm5lclwiO1xuICAgIH1cbiAgICBmdW5jdGlvbiBfZ2V0TmVzdGluZ09wZW5lclBhcmFtcyhvcGVuZXIpIHtcbiAgICAgICAgdmFyIG9wZW5lcnMgPSBbXTtcbiAgICAgICAgdmFyIGNsb3NlcjtcbiAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhfbmVzdGluZ0RhdGEpO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTtcbiAgICAgICAgICAgIGlmIChfbmVzdGluZ0RhdGFbb3BlbmVyXS50eXBlICE9PSBcInF1b3RlXCIgfHwgIV9uZXN0aW5nRGF0YVtvcGVuZXJdKSB7XG4gICAgICAgICAgICAgICAgb3BlbmVycy5wdXNoKGtleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHJldCA9IF9uZXN0aW5nRGF0YVtvcGVuZXJdO1xuICAgICAgICByZXQub3BlbmVyID0gbmV3IFJlZ0V4cChcIl4oPzpcIiArIG9wZW5lcnMubWFwKGZ1bmN0aW9uKHN0cil7cmV0dXJuIHN0ci5yZXBsYWNlKFwiKFwiLCBcIlxcXFwoXCIpfSkuam9pbihcInxcIikgKyBcIilcIik7IFxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgICB2YXIgX25lc3RpbmdQYXJhbXMgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHJldCA9IHt9O1xuICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKF9uZXN0aW5nRGF0YSk7XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldO1xuICAgICAgICAgICAgcmV0W2tleV0gPSBfZ2V0TmVzdGluZ09wZW5lclBhcmFtcyhrZXkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfSgpXG4gICAgdmFyIF90YWdSZXggPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIG9wZW5lcnMgPSBbXTtcbiAgICAgICAgdmFyIGNsb3NlcnMgPSBbXTtcbiAgICAgICAgdmFyIHZhbHMgPSB7fTtcbiAgICAgICAgZm9yICh2YXIgb3BlbmVyIGluIF9uZXN0aW5nUGFyYW1zKSB7XG4gICAgICAgICAgICBvcGVuZXJzLnB1c2gob3BlbmVyKTtcbiAgICAgICAgICAgIHZhbHNbX25lc3RpbmdQYXJhbXNbb3BlbmVyXS5jbG9zZXJdID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHZhbHMpO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgY2xvc2VyID0ga2V5c1tpXTtcbiAgICAgICAgICAgIGNsb3NlcnMucHVzaChjbG9zZXIpO1xuICAgICAgICB9XG4gICAgICAgIHZhciBhbGwgPSBvcGVuZXJzLmNvbmNhdChjbG9zZXJzKS5tYXAoZnVuY3Rpb24oc3RyKXtyZXR1cm4gc3RyLnJlcGxhY2UoXCIoXCIsIFwiXFxcXChcIil9KS5qb2luKFwifFwiKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG1hdGNoQWxsOiBuZXcgUmVnRXhwKFwiKCg/OlwiICsgYWxsICsgXCIpKVwiLCBcImdcIiksXG4gICAgICAgICAgICBzcGxpdEFsbDogbmV3IFJlZ0V4cChcIig/OlwiICsgYWxsICsgXCIpXCIsIFwiZ1wiKSxcbiAgICAgICAgICAgIG9wZW46IG5ldyBSZWdFeHAoXCIoXig/OlwiICsgb3BlbmVycy5tYXAoZnVuY3Rpb24oc3RyKXtyZXR1cm4gc3RyLnJlcGxhY2UoXCIoXCIsIFwiXFxcXChcIil9KS5qb2luKFwifFwiKSArIFwiKSQpXCIpLFxuICAgICAgICAgICAgY2xvc2U6IG5ldyBSZWdFeHAoXCIoXig/OlwiICsgY2xvc2Vycy5qb2luKFwifFwiKSArIFwiKSQpXCIpLFxuICAgICAgICB9XG4gICAgfSgpO1xuICAgIGZ1bmN0aW9uIF9uZXN0aW5nRml4ICh0YWcsIHBvcykge1xuICAgICAgICByZXR1cm4gX3B1c2hOZXN0aW5nU3RhdGUodGFnLCBwb3MpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBfcHVzaE5lc3RpbmdTdGF0ZSh0YWcsIHBvcykge1xuICAgICAgICBpZiAodGFnLm1hdGNoKF90YWdSZXgub3BlbikpIHtcbiAgICAgICAgICAgIHJldHVybiBfdHJ5T3Blbih0YWcsIHBvcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gX3RyeUNsb3NlKHRhZywgcG9zKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBfdHJ5T3Blbih0YWcsIHBvcykge1xuICAgICAgICB2YXIgcGFyYW1zID0gX25lc3RpbmdTdGF0ZVtfbmVzdGluZ1N0YXRlLmxlbmd0aCAtIDFdO1xuICAgICAgICBpZiAoIXBhcmFtcyB8fCB0YWcubWF0Y2gocGFyYW1zLm9wZW5lcikpIHtcbiAgICAgICAgICAgIF9uZXN0aW5nU3RhdGUucHVzaCh7XG4gICAgICAgICAgICAgICAgdHlwZTogX25lc3RpbmdQYXJhbXNbdGFnXS50eXBlLFxuICAgICAgICAgICAgICAgIG9wZW5lcjogX25lc3RpbmdQYXJhbXNbdGFnXS5vcGVuZXIsXG4gICAgICAgICAgICAgICAgY2xvc2VyOiBfbmVzdGluZ1BhcmFtc1t0YWddLmNsb3NlcixcbiAgICAgICAgICAgICAgICBwb3M6IHBvc1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBfbmVzdGluZ1N0YXRlLnBvcCgpXG4gICAgICAgICAgICBfbmVzdGluZ1N0YXRlLnB1c2goe1xuICAgICAgICAgICAgICAgIHR5cGU6IF9uZXN0aW5nUGFyYW1zW3RhZ10udHlwZSxcbiAgICAgICAgICAgICAgICBvcGVuZXI6IF9uZXN0aW5nUGFyYW1zW3RhZ10ub3BlbmVyLFxuICAgICAgICAgICAgICAgIGNsb3NlcjogX25lc3RpbmdQYXJhbXNbdGFnXS5jbG9zZXIsXG4gICAgICAgICAgICAgICAgcG9zOiBwb3NcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBmaXh0YWc6IHBhcmFtcy5wb3NcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gX3RyeUNsb3NlKHRhZywgcG9zKSB7XG4gICAgICAgIHZhciBwYXJhbXMgPSBfbmVzdGluZ1N0YXRlW19uZXN0aW5nU3RhdGUubGVuZ3RoIC0gMV07XG4gICAgICAgIGlmIChwYXJhbXMgJiYgdGFnID09PSBwYXJhbXMuY2xvc2VyKSB7XG4gICAgICAgICAgICBfbmVzdGluZ1N0YXRlLnBvcCgpXG4gICAgICAgICAgICBpZiAocGFyYW1zLnR5cGUgPT09IFwibm9jYXNlXCIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBub2Nhc2U6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wZW46IHBhcmFtcy5wb3MsXG4gICAgICAgICAgICAgICAgICAgICAgICBjbG9zZTogcG9zXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChwYXJhbXMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBmaXh0YWc6IHBhcmFtcy5wb3NcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBmaXh0YWc6IHBvc1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gX2RvcHBlbFN0cmluZyhzdHIpIHtcbiAgICAgICAgdmFyIGZvcmNlZFNwYWNlcyA9IFtdO1xuICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSgvKDxzcGFuKVxccysoc3R5bGU9XFxcImZvbnQtdmFyaWFudDopXFxzKihzbWFsbC1jYXBzKTs/XFxcIltePl0qKD4pL2csIFwiJDEgJDIkMztcXFwiJDRcIik7XG4gICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC8oPHNwYW4pXFxzKyhjbGFzcz1cXFwibm8oPzpjYXNlfGRlY29yKVxcXCIpW14+XSooPikvZywgXCIkMSAkMiQzXCIpO1xuICAgICAgICB2YXIgbWF0Y2ggPSBzdHIubWF0Y2goX3RhZ1JleC5tYXRjaEFsbCk7XG4gICAgICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgdGFnczogW10sXG4gICAgICAgICAgICAgICAgc3RyaW5nczogW3N0cl0sXG4gICAgICAgICAgICAgICAgZm9yY2VkU3BhY2VzOiBbXVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgc3BsaXQgPSBzdHIuc3BsaXQoX3RhZ1JleC5zcGxpdEFsbCk7XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPW1hdGNoLmxlbmd0aC0xO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIGlmIChfbmVzdGluZ0RhdGFbbWF0Y2hbaV1dKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNwbGl0W2krMV0gPT09IFwiXCIgJiYgW1wiXFxcIlwiLCBcIidcIl0uaW5kZXhPZihtYXRjaFtpKzFdKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIG1hdGNoW2krMV0gPSBcIiBcIiArIG1hdGNoW2krMV1cbiAgICAgICAgICAgICAgICAgICAgZm9yY2VkU3BhY2VzLnB1c2godHJ1ZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yY2VkU3BhY2VzLnB1c2goZmFsc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGFnczogbWF0Y2gsXG4gICAgICAgICAgICBzdHJpbmdzOiBzcGxpdCxcbiAgICAgICAgICAgIGZvcmNlZFNwYWNlczogZm9yY2VkU3BhY2VzXG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gX3VuZG9wcGVsU3RyaW5nKG9iaikge1xuICAgICAgICB2YXIgbHN0ID0gb2JqLnN0cmluZ3Muc2xpY2UoLTEpO1xuICAgICAgICBmb3IgKHZhciBpPW9iai50YWdzLmxlbmd0aC0xOyBpPi0xOyBpKz0tMSkge1xuICAgICAgICAgICAgbHN0LnB1c2gob2JqLnRhZ3NbaV0pO1xuICAgICAgICAgICAgbHN0LnB1c2gob2JqLnN0cmluZ3NbaV0pO1xuICAgICAgICB9XG4gICAgICAgIGxzdC5yZXZlcnNlKCk7XG4gICAgICAgIHJldHVybiBsc3Quam9pbihcInxcIik7XG4gICAgfVxuICAgIHZhciBfVGFnUmVnID0gZnVuY3Rpb24oYmxvYikge1xuICAgICAgICB0aGlzLnNldCA9IHNldDtcbiAgICAgICAgdGhpcy5wYWlyID0gcGFpcjtcbiAgICAgICAgdGhpcy5wb3AgPSBwb3A7XG4gICAgICAgIHZhciBfc3RhY2sgPSBbXTtcbiAgICAgICAgZnVuY3Rpb24gc2V0KHRhZykge1xuICAgICAgICAgICAgdmFyIGF0dHIgPSBfbmVzdGluZ0RhdGFbdGFnXS5hdHRyO1xuICAgICAgICAgICAgdmFyIGRlY29yID0gbnVsbDtcbiAgICAgICAgICAgIGZvciAodmFyIGk9X3N0YWNrLmxlbmd0aC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICAgICAgdmFyIF9kZWNvciA9IF9zdGFja1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoX2RlY29yWzBdID09PSBhdHRyKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlY29yID0gX2RlY29yO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWRlY29yKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFsbFRoZURlY29yID0gW3N0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQubGF5b3V0X2RlY29yYXRpb25zXS5jb25jYXQoYmxvYi5hbGxkZWNvcilcbiAgICAgICAgICAgICAgICBvdXRlcjpcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPWFsbFRoZURlY29yLmxlbmd0aC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBkZWNvcnNldCA9IGFsbFRoZURlY29yW2ldO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWRlY29yc2V0KSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaj1kZWNvcnNldC5sZW5ndGgtMTtqPi0xO2otLSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9kZWNvciA9IGRlY29yc2V0W2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9kZWNvclswXSA9PT0gYXR0cikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlY29yID0gX2RlY29yO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFkZWNvcikge1xuICAgICAgICAgICAgICAgIGRlY29yID0gW2F0dHIsIF9uZXN0aW5nRGF0YVt0YWddLm91dGVyXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZGVjb3IgPSBbYXR0ciwgX25lc3RpbmdEYXRhW3RhZ10uZmxpcGZsb3BbZGVjb3JbMV1dXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF9zdGFjay5wdXNoKGRlY29yKTtcbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiBwYWlyKCkge1xuICAgICAgICAgICAgcmV0dXJuIF9zdGFja1tfc3RhY2subGVuZ3RoLTFdO1xuICAgICAgICB9XG4gICAgICAgIGZ1bmN0aW9uIHBvcCgpIHtcbiAgICAgICAgICAgIF9zdGFjay5wb3AoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBfYXBvc3Ryb3BoZUZvcmNlKHRhZywgc3RyKSB7XG4gICAgICAgIGlmICh0YWcgPT09IFwiXFwnXCIpIHtcbiAgICAgICAgICAgIGlmIChzdHIgJiYgc3RyLm1hdGNoKC9eW15cXCxcXC5cXD9cXDpcXDtcXCBdLykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IFwiIFxcJ1wiICYmIHN0ciAmJiBzdHIubWF0Y2goL15bXFwgXS8pKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGZ1bmN0aW9uIF91bmRvcHBlbFRvUXVldWUoYmxvYiwgZG9wcGVsLCBsZWFkaW5nU3BhY2UpIHtcbiAgICAgICAgdmFyIFRPUCA9IGJsb2I7XG4gICAgICAgIHZhciBmaXJzdFN0cmluZyA9IHRydWU7XG4gICAgICAgIHZhciB0YWdSZWcgPSBuZXcgX1RhZ1JlZyhibG9iKTtcbiAgICAgICAgYmxvYi5ibG9icyA9IFtdO1xuICAgICAgICBmdW5jdGlvbiBTdGFjayAoYmxvYikge1xuICAgICAgICAgICAgdGhpcy5zdGFjayA9IFtibG9iXTtcbiAgICAgICAgICAgIHRoaXMubGF0ZXN0ID0gYmxvYjtcbiAgICAgICAgICAgIHRoaXMuYWRkU3R5bGluZyA9IGZ1bmN0aW9uKHN0ciwgZGVjb3IsIGZvcmNlZFNwYWNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGZpcnN0U3RyaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdHIuc2xpY2UoMCwgMSkgPT09IFwiIFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0ci5zbGljZSgwLCAxKSA9PT0gXCIgXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmaXJzdFN0cmluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmxhdGVzdCA9IHRoaXMuc3RhY2tbdGhpcy5zdGFjay5sZW5ndGgtMV07XG4gICAgICAgICAgICAgICAgaWYgKGRlY29yKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgdGhpcy5sYXRlc3QuYmxvYnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5ldyBDU0wuQmxvYigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuYmxvYnMgPSB0aGlzLmxhdGVzdC5ibG9icztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLmFsbGRlY29yID0gdGhpcy5sYXRlc3QuYWxsZGVjb3Iuc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGF0ZXN0LmJsb2JzID0gW2NoaWxkXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIgdG9rID0gbmV3IENTTC5Ub2tlbigpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3YmxvYiA9IG5ldyBDU0wuQmxvYihudWxsLCB0b2spO1xuICAgICAgICAgICAgICAgICAgICBuZXdibG9iLmFsbGRlY29yID0gdGhpcy5sYXRlc3QuYWxsZGVjb3Iuc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRlY29yWzBdID09PSBcIkBjbGFzc1wiICYmIGRlY29yWzFdID09PSBcIm5vZGVjb3JcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld2RlY29yc2V0ID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2VlbiA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFsbFRoZURlY29yID0gW3N0YXRlW3N0YXRlLnRtcC5hcmVhXS5vcHQubGF5b3V0X2RlY29yYXRpb25zXS5jb25jYXQobmV3YmxvYi5hbGxkZWNvcilcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9YWxsVGhlRGVjb3IubGVuZ3RoLTE7aT4tMTtpLS0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2RlY29yc2V0ID0gYWxsVGhlRGVjb3JbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFfZGVjb3JzZXQpIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGo9X2RlY29yc2V0Lmxlbmd0aC0xO2o+LTE7ai0tKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfb2xkZGVjb3IgPSBfZGVjb3JzZXRbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChbXCJAZm9udC13ZWlnaHRcIiwgXCJAZm9udC1zdHlsZVwiLCBcIkBmb250LXZhcmlhbnRcIl0uaW5kZXhPZihfb2xkZGVjb3JbMF0pID4gLTFcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmICFzZWVuW19vbGRkZWNvclswXV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNvclsxXSAhPT0gXCJub3JtYWxcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld2Jsb2IuZGVjb3JhdGlvbnMucHVzaChbX29sZGRlY29yWzBdLCBcIm5vcm1hbFwiXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3ZGVjb3JzZXQucHVzaChbX29sZGRlY29yWzBdLCBcIm5vcm1hbFwiXSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZW5bX29sZGRlY29yWzBdXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdibG9iLmFsbGRlY29yLnB1c2gobmV3ZGVjb3JzZXQpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3YmxvYi5kZWNvcmF0aW9ucy5wdXNoKGRlY29yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld2Jsb2IuYWxsZGVjb3IucHVzaChbZGVjb3JdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxhdGVzdC5ibG9icy5wdXNoKG5ld2Jsb2IpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YWNrLnB1c2gobmV3YmxvYik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGF0ZXN0ID0gbmV3YmxvYjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0cikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRvayA9IG5ldyBDU0wuVG9rZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdibG9iID0gbmV3IENTTC5CbG9iKG51bGwsIHRvayk7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdibG9iLmJsb2JzID0gc3RyO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3YmxvYi5hbGxkZWNvciA9IHRoaXMubGF0ZXN0LmFsbGRlY29yLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhdGVzdC5ibG9icy5wdXNoKG5ld2Jsb2IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0cikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbmV3IENTTC5CbG9iKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC5ibG9icyA9IHN0cjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLmFsbGRlY29yID0gdGhpcy5sYXRlc3QuYWxsZGVjb3Iuc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGF0ZXN0LmJsb2JzLnB1c2goY2hpbGQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5wb3BTdHlsaW5nID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGFjay5wb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdmFyIHN0YWNrID0gbmV3IFN0YWNrKGJsb2IpO1xuICAgICAgICBpZiAoZG9wcGVsLnN0cmluZ3MubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgc3RyID0gZG9wcGVsLnN0cmluZ3NbMF07XG4gICAgICAgICAgICBpZiAobGVhZGluZ1NwYWNlKSB7XG4gICAgICAgICAgICAgICAgc3RyID0gXCIgXCIgKyBzdHI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdGFjay5hZGRTdHlsaW5nKHN0cik7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49ZG9wcGVsLnRhZ3MubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIHZhciB0YWcgPSBkb3BwZWwudGFnc1tpXTtcbiAgICAgICAgICAgIHZhciBzdHIgPSBkb3BwZWwuc3RyaW5nc1tpKzFdO1xuICAgICAgICAgICAgaWYgKHRhZy5tYXRjaChfdGFnUmV4Lm9wZW4pKSB7XG4gICAgICAgICAgICAgICAgdGFnUmVnLnNldCh0YWcpO1xuICAgICAgICAgICAgICAgIHN0YWNrLmFkZFN0eWxpbmcoc3RyLCB0YWdSZWcucGFpcigpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGFnUmVnLnBvcCgpO1xuICAgICAgICAgICAgICAgIHN0YWNrLnBvcFN0eWxpbmcoKTtcbiAgICAgICAgICAgICAgICBzdGFjay5hZGRTdHlsaW5nKHN0cik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gcHJvY2Vzc1RhZ3MoYmxvYikge1xuICAgICAgICB2YXIgc3RyID0gYmxvYi5ibG9icztcbiAgICAgICAgdmFyIGxlYWRpbmdTcGFjZSA9IGZhbHNlO1xuICAgICAgICBpZiAoc3RyLnNsaWNlKDAsIDEpID09PSBcIiBcIiAmJiAhc3RyLm1hdGNoKC9eXFxzK1tcXCdcXFwiXS8pKSB7XG4gICAgICAgICAgICBsZWFkaW5nU3BhY2UgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHZhciBzdHIgPSBcIiBcIiArIHN0cjtcbiAgICAgICAgdmFyIGRvcHBlbCA9IF9kb3BwZWxTdHJpbmcoc3RyKTtcbiAgICAgICAgaWYgKGRvcHBlbC50YWdzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICB2YXIgcXVvdGVGb3JtU2VlbiA9IGZhbHNlO1xuICAgIFx0Zm9yICh2YXIgaT0wLGlsZW49ZG9wcGVsLnRhZ3MubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIHZhciB0YWcgPSBkb3BwZWwudGFnc1tpXTtcbiAgICAgICAgICAgIHZhciBzdHIgPSBkb3BwZWwuc3RyaW5nc1tpKzFdO1xuICAgICAgICAgICAgaWYgKF9hcG9zdHJvcGhlRm9yY2UodGFnLCBzdHIpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gXCIgXFwnXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgZG9wcGVsLnN0cmluZ3NbaSsxXSA9IFwiIFxcdTIwMTlcIiArIGRvcHBlbC5zdHJpbmdzW2krMV07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZG9wcGVsLnN0cmluZ3NbaSsxXSA9IFwiXFx1MjAxOVwiICsgZG9wcGVsLnN0cmluZ3NbaSsxXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZG9wcGVsLnRhZ3NbaV0gPSBcIlwiO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgdGFnSW5mbztcbiAgICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICB0YWdJbmZvID0gX25lc3RpbmdGaXgodGFnLCBpKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ0luZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyh0YWdJbmZvKS5pbmRleE9mKFwiZml4dGFnXCIpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFnLm1hdGNoKF90YWdSZXguY2xvc2UpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIHRhZyA9PT0gXCJcXCdcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3BwZWwuc3RyaW5nc1tpKzFdID0gXCJcXHUyMDE5XCIgKyBkb3BwZWwuc3RyaW5nc1tpKzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3BwZWwudGFnc1tpXSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZhaWxlZFRhZyA9IGRvcHBlbC50YWdzW3RhZ0luZm8uZml4dGFnXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRvcHBlbC5mb3JjZWRTcGFjZXNbdGFnSW5mby5maXh0YWctMV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZFRhZyA9IGZhaWxlZFRhZy5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3BwZWwuc3RyaW5nc1t0YWdJbmZvLmZpeHRhZysxXSA9IGZhaWxlZFRhZyArIGRvcHBlbC5zdHJpbmdzW3RhZ0luZm8uZml4dGFnKzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3BwZWwudGFnc1t0YWdJbmZvLmZpeHRhZ10gPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX25lc3RpbmdTdGF0ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9uZXN0aW5nU3RhdGUucG9wKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YWdJbmZvLm5vY2FzZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvcHBlbC50YWdzW3RhZ0luZm8ubm9jYXNlLm9wZW5dID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3BwZWwudGFnc1t0YWdJbmZvLm5vY2FzZS5jbG9zZV0gPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0YWdJbmZvICYmICh0YWdJbmZvLmZpeHRhZ3x8IHRhZ0luZm8uZml4dGFnID09PSAwKSkge1xuICAgICAgICAgICAgICAgICAgICBkb3BwZWwuc3RyaW5nc1tpKzFdID0gZG9wcGVsLnRhZ3NbaV0gKyBkb3BwZWwuc3RyaW5nc1tpKzFdO1xuICAgICAgICAgICAgICAgICAgICBkb3BwZWwudGFnc1tpXSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGk9X25lc3RpbmdTdGF0ZS5sZW5ndGgtMTtpPi0xO2ktLSkge1xuICAgICAgICAgICAgdmFyIHRhZ1BvcyA9IF9uZXN0aW5nU3RhdGVbaV0ucG9zXG4gICAgICAgICAgICB2YXIgdGFnID0gZG9wcGVsLnRhZ3NbdGFnUG9zXTtcbiAgICAgICAgICAgIGlmICh0YWcgPT09IFwiIFxcJ1wiIHx8IHRhZyA9PT0gXCJcXCdcIikge1xuICAgICAgICAgICAgICAgIGRvcHBlbC5zdHJpbmdzW3RhZ1BvcysxXSA9IFwiIFxcdTIwMTlcIiArIGRvcHBlbC5zdHJpbmdzW3RhZ1BvcysxXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZG9wcGVsLnN0cmluZ3NbdGFnUG9zKzFdID0gZG9wcGVsLnRhZ3NbdGFnUG9zXSArIGRvcHBlbC5zdHJpbmdzW3RhZ1BvcysxXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRvcHBlbC50YWdzW3RhZ1Bvc10gPSBcIlwiO1xuICAgICAgICAgICAgX25lc3RpbmdTdGF0ZS5wb3AoKTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBpPWRvcHBlbC50YWdzLmxlbmd0aC0xO2k+LTE7aS0tKSB7XG4gICAgICAgICAgICBpZiAoIWRvcHBlbC50YWdzW2ldKSB7XG4gICAgICAgICAgICAgICAgZG9wcGVsLnRhZ3MgPSBkb3BwZWwudGFncy5zbGljZSgwLGkpLmNvbmNhdChkb3BwZWwudGFncy5zbGljZShpKzEpKTtcbiAgICAgICAgICAgICAgICBkb3BwZWwuc3RyaW5nc1tpXSA9IGRvcHBlbC5zdHJpbmdzW2ldICsgZG9wcGVsLnN0cmluZ3NbaSsxXTtcbiAgICAgICAgICAgICAgICBkb3BwZWwuc3RyaW5ncyA9IGRvcHBlbC5zdHJpbmdzLnNsaWNlKDAsaSsxKS5jb25jYXQoZG9wcGVsLnN0cmluZ3Muc2xpY2UoaSsyKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49ZG9wcGVsLnRhZ3MubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIHZhciB0YWcgPSBkb3BwZWwudGFnc1tpXTtcbiAgICAgICAgICAgIHZhciBmb3JjZWRTcGFjZSA9IGRvcHBlbC5mb3JjZWRTcGFjZXNbaS0xXTtcbiAgICAgICAgICAgIGlmIChbXCIgXFxcIlwiLCBcIiBcXCdcIiwgXCIoXFxcIlwiLCBcIihcXCdcIl0uaW5kZXhPZih0YWcpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXF1b3RlRm9ybVNlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgX3NldE91dGVyUXVvdGVGb3JtKHRhZyk7XG4gICAgICAgICAgICAgICAgICAgIHF1b3RlRm9ybVNlZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWZvcmNlZFNwYWNlKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvcHBlbC5zdHJpbmdzW2ldICs9IHRhZy5zbGljZSgwLCAxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgX3VuZG9wcGVsVG9RdWV1ZShibG9iLCBkb3BwZWwsIGxlYWRpbmdTcGFjZSk7XG4gICAgfVxufVxubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuT3V0cHV0LkZvcm1hdHRlcnMgPSBuZXcgZnVuY3Rpb24gKCkge1xuICAgIHRoaXMucGFzc3Rocm91Z2ggPSBwYXNzdGhyb3VnaDtcbiAgICB0aGlzLmxvd2VyY2FzZSA9IGxvd2VyY2FzZTtcbiAgICB0aGlzLnVwcGVyY2FzZSA9IHVwcGVyY2FzZTtcbiAgICB0aGlzLnNlbnRlbmNlID0gc2VudGVuY2U7XG4gICAgdGhpcy50aXRsZSA9IHRpdGxlO1xuICAgIHRoaXNbXCJjYXBpdGFsaXplLWZpcnN0XCJdID0gY2FwaXRhbGl6ZUZpcnN0O1xuICAgIHRoaXNbXCJjYXBpdGFsaXplLWFsbFwiXSA9IGNhcGl0YWxpemVBbGw7XG4gICAgdmFyIHJleFN0ciA9IFwiKD86XFx1MjAxOHxcXHUyMDE5fFxcdTIwMUN8XFx1MjAxRHwgXFxcInwgXFwnfFxcXCJ8XFwnfFstXFzigJNcXOKAlFxcLy4sOz8hOl18XFxcXFt8XFxcXF18XFxcXCh8XFxcXCl8PHNwYW4gc3R5bGU9XFxcImZvbnQtdmFyaWFudDogc21hbGwtY2FwcztcXFwiPnw8c3BhbiBjbGFzcz1cXFwibm8oPzpjYXNlfGRlY29yKVxcXCI+fDxcXC9zcGFuPnw8XFwvPyg/Oml8c2N8YnxzdWJ8c3VwKT4pXCI7XG4gICAgdmFyIHRhZ0RvcHBlbCA9IG5ldyBDU0wuRG9wcGVsZXIocmV4U3RyLCBmdW5jdGlvbihzdHIpIHtcbiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8oPHNwYW4pXFxzKyhjbGFzcz1cXFwibm8oPzpjYXNlfGRlY29yKVxcXCIpW14+XSooPikvZywgXCIkMSAkMiQzXCIpLnJlcGxhY2UoLyg8c3BhbilcXHMrKHN0eWxlPVxcXCJmb250LXZhcmlhbnQ6KVxccyooc21hbGwtY2Fwcyk7PyhcXFwiKVtePl0qKD4pL2csIFwiJDEgJDIgJDM7JDQkNVwiKTtcbiAgICB9KTtcbiAgICB2YXIgd29yZERvcHBlbCA9IG5ldyBDU0wuRG9wcGVsZXIoXCIoPzpbXFx1MDAyMFxcdTAwQTBcXHUyMDAwLVxcdTIwMEJcXHUyMDVGXFx1MzAwMF0rKVwiKTtcbiAgICB2YXIgX3RhZ1BhcmFtcyA9IHtcbiAgICAgICAgXCI8c3BhbiBzdHlsZT1cXFwiZm9udC12YXJpYW50OiBzbWFsbC1jYXBzO1xcXCI+XCI6IFwiPC9zcGFuPlwiLFxuICAgICAgICBcIjxzcGFuIGNsYXNzPVxcXCJub2Nhc2VcXFwiPlwiOiBcIjwvc3Bhbj5cIixcbiAgICAgICAgXCI8c3BhbiBjbGFzcz1cXFwibm9kZWNvclxcXCI+XCI6IFwiPC9zcGFuPlwiXG4gICAgfVxuICAgIGZ1bmN0aW9uIF9jYXBpdGFsaXNlICh3b3JkLCBmb3JjZSkge1xuICAgICAgICB2YXIgbSA9IHdvcmQubWF0Y2goLyheXFxzKikoKD86W1xcMC1cXHRcXHgwQlxcZlxceDBFLVxcdTIwMjdcXHUyMDJBLVxcdUQ3RkZcXHVFMDAwLVxcdUZGRkZdfFtcXHVEODAwLVxcdURCRkZdW1xcdURDMDAtXFx1REZGRl18W1xcdUQ4MDAtXFx1REJGRl0oPyFbXFx1REMwMC1cXHVERkZGXSl8KD86W15cXHVEODAwLVxcdURCRkZdfF4pW1xcdURDMDAtXFx1REZGRl0pKSguKikvKTtcbiAgICAgICAgaWYgKG0gJiYgIShtWzJdLm1hdGNoKC9eW1xcdTAzNzAtXFx1MDNGRl0kLykgJiYgIW1bM10pKSB7XG4gICAgICAgICAgICByZXR1cm4gbVsxXSArIG1bMl0udG9VcHBlckNhc2UoKSArIG1bM107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHdvcmQ7XG4gICAgfVxuICAgIGZ1bmN0aW9uIF90ZXh0Y2FzZUVuZ2luZShjb25maWcsIHN0cmluZykge1xuICAgICAgICBpZiAoIXN0cmluZykge1xuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgICAgIH1cbiAgICAgICAgY29uZmlnLmRvcHBlbCA9IHRhZ0RvcHBlbC5zcGxpdChzdHJpbmcpO1xuICAgICAgICB2YXIgcXVvdGVQYXJhbXMgPSB7XG4gICAgICAgICAgICBcIiBcXFwiXCI6IHtcbiAgICAgICAgICAgICAgICBvcGVuZXI6IFwiIFxcJ1wiLFxuICAgICAgICAgICAgICAgIGNsb3NlcjogXCJcXFwiXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBcIiBcXCdcIjoge1xuICAgICAgICAgICAgICAgIG9wZW5lcjogXCIgXFxcIlwiLFxuICAgICAgICAgICAgICAgIGNsb3NlcjogXCJcXCdcIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFwiXFx1MjAxOFwiOiB7XG4gICAgICAgICAgICAgICAgb3BlbmVyOiBcIlxcdTIwMThcIixcbiAgICAgICAgICAgICAgICBjbG9zZXI6IFwiXFx1MjAxOVwiXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgXCJcXHUyMDFDXCI6IHtcbiAgICAgICAgICAgICAgICBvcGVuZXI6IFwiXFx1MjAxQ1wiLFxuICAgICAgICAgICAgICAgIGNsb3NlcjogXCJcXHUyMDFEXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gcXVvdGVGaXggKHRhZywgcG9zaXRpb25zKSB7XG4gICAgICAgICAgICB2YXIgbSA9IHRhZy5tYXRjaCgvKF4oPzpcXHUyMDE4fFxcdTIwMTl8XFx1MjAxQ3xcXHUyMDFEfFxcXCJ8XFwnKXwoPzogXFxcInwgXFwnKSQpLyk7XG4gICAgICAgICAgICBpZiAobSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBwdXNoUXVvdGVTdGF0ZShtWzFdLCBwb3NpdGlvbnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZ1bmN0aW9uIHB1c2hRdW90ZVN0YXRlKHRhZywgcG9zKSB7XG4gICAgICAgICAgICB2YXIgaXNPcGVuZXIgPSBbXCJcXHUyMDFDXCIsIFwiXFx1MjAxOFwiLCBcIiBcXFwiXCIsIFwiIFxcJ1wiXS5pbmRleE9mKHRhZykgPiAtMSA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgICAgIGlmIChpc09wZW5lcikge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnlPcGVuKHRhZywgcG9zKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRyeUNsb3NlKHRhZywgcG9zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiB0cnlPcGVuKHRhZywgcG9zKSB7XG4gICAgICAgICAgICBpZiAoY29uZmlnLnF1b3RlU3RhdGUubGVuZ3RoID09PSAwIHx8IHRhZyA9PT0gY29uZmlnLnF1b3RlU3RhdGVbY29uZmlnLnF1b3RlU3RhdGUubGVuZ3RoIC0gMV0ub3BlbmVyKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnLnF1b3RlU3RhdGUucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG9wZW5lcjogcXVvdGVQYXJhbXNbdGFnXS5vcGVuZXIsXG4gICAgICAgICAgICAgICAgICAgIGNsb3NlcjogcXVvdGVQYXJhbXNbdGFnXS5jbG9zZXIsXG4gICAgICAgICAgICAgICAgICAgIHBvczogcG9zXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgcHJldlBvcyA9IGNvbmZpZy5xdW90ZVN0YXRlW2NvbmZpZy5xdW90ZVN0YXRlLmxlbmd0aC0xXS5wb3M7XG4gICAgICAgICAgICAgICAgY29uZmlnLnF1b3RlU3RhdGUucG9wKClcbiAgICAgICAgICAgICAgICBjb25maWcucXVvdGVTdGF0ZS5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgb3BlbmVyOiBxdW90ZVBhcmFtc1t0YWddLm9wZW5lcixcbiAgICAgICAgICAgICAgICAgICAgY2xvc2VyOiBxdW90ZVBhcmFtc1t0YWddLmNsb3NlcixcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zOiBwb3NcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldlBvcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiB0cnlDbG9zZSh0YWcsIHBvcykge1xuICAgICAgICAgICAgaWYgKGNvbmZpZy5xdW90ZVN0YXRlLmxlbmd0aCA+IDAgJiYgdGFnID09PSBjb25maWcucXVvdGVTdGF0ZVtjb25maWcucXVvdGVTdGF0ZS5sZW5ndGggLSAxXS5jbG9zZXIpIHtcbiAgICAgICAgICAgICAgICBjb25maWcucXVvdGVTdGF0ZS5wb3AoKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcG9zO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChjb25maWcuZG9wcGVsLnN0cmluZ3MubGVuZ3RoICYmIGNvbmZpZy5kb3BwZWwuc3RyaW5nc1swXS50cmltKCkpIHtcbiAgICAgICAgICAgIGNvbmZpZy5kb3BwZWwuc3RyaW5nc1swXSA9IGNvbmZpZy5jYXBpdGFsaXNlV29yZHMoY29uZmlnLmRvcHBlbC5zdHJpbmdzWzBdLCAwLCBjb25maWcuZG9wcGVsLnRhZ3NbMF0pO1xuICAgICAgICB9XG4gICAgXHRmb3IgKHZhciBpPTAsaWxlbj1jb25maWcuZG9wcGVsLnRhZ3MubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgIHZhciB0YWcgPSBjb25maWcuZG9wcGVsLnRhZ3NbaV07XG4gICAgICAgICAgICB2YXIgc3RyID0gY29uZmlnLmRvcHBlbC5zdHJpbmdzW2krMV07XG4gICAgICAgICAgICBpZiAoY29uZmlnLnRhZ1N0YXRlICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgaWYgKF90YWdQYXJhbXNbdGFnXSkge1xuICAgICAgICAgICAgICAgICAgICBjb25maWcudGFnU3RhdGUucHVzaChfdGFnUGFyYW1zW3RhZ10pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnRhZ1N0YXRlLmxlbmd0aCAmJiB0YWcgPT09IGNvbmZpZy50YWdTdGF0ZVtjb25maWcudGFnU3RhdGUubGVuZ3RoIC0gMV0pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLnRhZ1N0YXRlLnBvcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb25maWcuYWZ0ZXJQdW5jdCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGlmICh0YWcubWF0Y2goL1tcXCFcXD9cXDpdJC8pKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZy5hZnRlclB1bmN0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY29uZmlnLnRhZ1N0YXRlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGNvbmZpZy5kb3BwZWwuc3RyaW5nc1tpKzFdID0gY29uZmlnLmNhcGl0YWxpc2VXb3JkcyhzdHIsIGkrMSwgY29uZmlnLmRvcHBlbCxjb25maWcuZG9wcGVsLnRhZ3NbaSsxXSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNvbmZpZy5kb3BwZWwuc3RyaW5nc1tpKzFdLnRyaW0oKSkge1xuICAgICAgICAgICAgICAgIGNvbmZpZy5sYXN0V29yZFBvcyA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY29uZmlnLnF1b3RlU3RhdGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICB2YXIgcXVvdGVQb3MgPSBxdW90ZUZpeCh0YWcsIGkpO1xuICAgICAgICAgICAgICAgIGlmIChxdW90ZVBvcyB8fCBxdW90ZVBvcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgb3JpZ0NoYXIgPSBjb25maWcuZG9wcGVsLm9yaWdTdHJpbmdzW3F1b3RlUG9zKzFdLnNsaWNlKDAsIDEpO1xuICAgICAgICAgICAgICAgICAgICBjb25maWcuZG9wcGVsLnN0cmluZ3NbcXVvdGVQb3MrMV0gPSBvcmlnQ2hhciArIGNvbmZpZy5kb3BwZWwuc3RyaW5nc1txdW90ZVBvcysxXS5zbGljZSgxKTtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmxhc3RXb3JkUG9zID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY29uZmlnLmlzRmlyc3QpIHtcbiAgICAgICAgICAgICAgICBpZiAoc3RyLnRyaW0oKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25maWcuaXNGaXJzdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb25maWcuYWZ0ZXJQdW5jdCkge1xuICAgICAgICAgICAgICAgIGlmIChzdHIudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZy5hZnRlclB1bmN0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChjb25maWcucXVvdGVTdGF0ZSkge1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49Y29uZmlnLnF1b3RlU3RhdGUubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgcXVvdGVQb3MgPSBjb25maWcucXVvdGVTdGF0ZVtpXS5wb3M7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBxdW90ZVBvcyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9yaWdDaGFyID0gY29uZmlnLmRvcHBlbC5vcmlnU3RyaW5nc1txdW90ZVBvcysxXS5zbGljZSgwLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLmRvcHBlbC5zdHJpbmdzW3F1b3RlUG9zKzFdID0gb3JpZ0NoYXIgKyBjb25maWcuZG9wcGVsLnN0cmluZ3NbcXVvdGVQb3MrMV0uc2xpY2UoMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChjb25maWcubGFzdFdvcmRQb3MpIHtcbiAgICAgICAgICAgIHZhciBsYXN0V29yZHMgPSB3b3JkRG9wcGVsLnNwbGl0KGNvbmZpZy5kb3BwZWwuc3RyaW5nc1tjb25maWcubGFzdFdvcmRQb3Muc3RyaW5nc10pO1xuICAgICAgICAgICAgdmFyIGxhc3RXb3JkID0gX2NhcGl0YWxpc2UobGFzdFdvcmRzLnN0cmluZ3NbY29uZmlnLmxhc3RXb3JkUG9zLndvcmRzXSk7XG4gICAgICAgICAgICBsYXN0V29yZHMuc3RyaW5nc1tjb25maWcubGFzdFdvcmRQb3Mud29yZHNdID0gbGFzdFdvcmQ7XG4gICAgICAgICAgICBjb25maWcuZG9wcGVsLnN0cmluZ3NbY29uZmlnLmxhc3RXb3JkUG9zLnN0cmluZ3NdID0gd29yZERvcHBlbC5qb2luKGxhc3RXb3Jkcyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRhZ0RvcHBlbC5qb2luKGNvbmZpZy5kb3BwZWwpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBwYXNzdGhyb3VnaCAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gc3RyO1xuICAgIH1cbiAgICBmdW5jdGlvbiBsb3dlcmNhc2Uoc3RhdGUsIHN0cmluZykge1xuICAgICAgICB2YXIgY29uZmlnID0ge1xuICAgICAgICAgICAgcXVvdGVTdGF0ZTogbnVsbCxcbiAgICAgICAgICAgIGNhcGl0YWxpc2VXb3JkczogZnVuY3Rpb24oc3RyKSB7XG4gICAgICAgICAgICAgICAgdmFyIHdvcmRzID0gc3RyLnNwbGl0KFwiIFwiKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj13b3Jkcy5sZW5ndGg7aTxpbGVuO2krKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgd29yZCA9IHdvcmRzW2ldO1xuICAgICAgICAgICAgICAgICAgICBpZiAod29yZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgd29yZHNbaV0gPSB3b3JkLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHdvcmRzLmpvaW4oXCIgXCIpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNraXBXb3Jkc1JleDogbnVsbCxcbiAgICAgICAgICAgIHRhZ1N0YXRlOiBbXSxcbiAgICAgICAgICAgIGFmdGVyUHVuY3Q6IG51bGwsXG4gICAgICAgICAgICBpc0ZpcnN0OiBudWxsXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIF90ZXh0Y2FzZUVuZ2luZShjb25maWcsIHN0cmluZyk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHVwcGVyY2FzZShzdGF0ZSwgc3RyaW5nKSB7XG4gICAgICAgIHZhciBjb25maWcgPSB7XG4gICAgICAgICAgICBxdW90ZVN0YXRlOiBudWxsLFxuICAgICAgICAgICAgY2FwaXRhbGlzZVdvcmRzOiBmdW5jdGlvbihzdHIpIHtcbiAgICAgICAgICAgICAgICB2YXIgd29yZHMgPSBzdHIuc3BsaXQoXCIgXCIpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXdvcmRzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB3b3JkID0gd29yZHNbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmICh3b3JkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3b3Jkc1tpXSA9IHdvcmQudG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gd29yZHMuam9pbihcIiBcIik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2tpcFdvcmRzUmV4OiBudWxsLFxuICAgICAgICAgICAgdGFnU3RhdGU6IFtdLFxuICAgICAgICAgICAgYWZ0ZXJQdW5jdDogbnVsbCxcbiAgICAgICAgICAgIGlzRmlyc3Q6IG51bGxcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gX3RleHRjYXNlRW5naW5lKGNvbmZpZywgc3RyaW5nKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gc2VudGVuY2Uoc3RhdGUsIHN0cmluZykge1xuICAgICAgICB2YXIgY29uZmlnID0ge1xuICAgICAgICAgICAgcXVvdGVTdGF0ZTogW10sXG4gICAgICAgICAgICBjYXBpdGFsaXNlV29yZHM6IGZ1bmN0aW9uKHN0cikge1xuICAgICAgICAgICAgICAgIHZhciB3b3JkcyA9IHN0ci5zcGxpdChcIiBcIik7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49d29yZHMubGVuZ3RoO2k8aWxlbjtpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHdvcmQgPSB3b3Jkc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb25maWcuaXNGaXJzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2ldID0gX2NhcGl0YWxpc2Uod29yZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmlzRmlyc3QgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd29yZHNbaV0gPSB3b3JkLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHdvcmRzLmpvaW4oXCIgXCIpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNraXBXb3Jkc1JleDogbnVsbCxcbiAgICAgICAgICAgIHRhZ1N0YXRlOiBbXSxcbiAgICAgICAgICAgIGFmdGVyUHVuY3Q6IG51bGwsXG4gICAgICAgICAgICBpc0ZpcnN0OiB0cnVlXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIF90ZXh0Y2FzZUVuZ2luZShjb25maWcsIHN0cmluZyk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHRpdGxlKHN0YXRlLCBzdHJpbmcpIHtcbiAgICAgICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgICAgICAgIHF1b3RlU3RhdGU6IFtdLFxuICAgICAgICAgICAgY2FwaXRhbGlzZVdvcmRzOiBmdW5jdGlvbihzdHIsIGksIGZvbGxvd2luZ1RhZykge1xuICAgICAgICAgICAgICAgIGlmIChzdHIudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB3b3JkcyA9IHN0ci5zcGxpdCgvWyBcXHUwMEEwXSsvKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHdvcmRsZSA9IHdvcmREb3BwZWwuc3BsaXQoc3RyKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHdvcmRzID0gd29yZGxlLnN0cmluZ3M7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGo9MCxqbGVuPXdvcmRzLmxlbmd0aDtqPGpsZW47aisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgd29yZCA9IHdvcmRzW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3b3JkKSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3b3JkLmxlbmd0aCA+IDEgJiYgIXdvcmQudG9Mb3dlckNhc2UoKS5tYXRjaChjb25maWcuc2tpcFdvcmRzUmV4KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2pdID0gX2NhcGl0YWxpc2Uod29yZHNbal0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChqID09PSAod29yZHMubGVuZ3RoIC0gMSkgJiYgZm9sbG93aW5nVGFnID09PSBcIi1cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2pdID0gX2NhcGl0YWxpc2Uod29yZHNbal0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb25maWcuaXNGaXJzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2pdID0gX2NhcGl0YWxpc2Uod29yZHNbal0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb25maWcuYWZ0ZXJQdW5jdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2pdID0gX2NhcGl0YWxpc2Uod29yZHNbal0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLmFmdGVyUHVuY3QgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5pc0ZpcnN0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWcubGFzdFdvcmRQb3MgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nczogaSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JkczogalxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHN0ciA9IHdvcmREb3BwZWwuam9pbih3b3JkbGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gc3RyO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNraXBXb3Jkc1JleDogc3RhdGUubG9jYWxlW3N0YXRlLm9wdC5sYW5nXS5vcHRzW1wic2tpcC13b3Jkcy1yZWdleHBcIl0sXG4gICAgICAgICAgICB0YWdTdGF0ZTogW10sXG4gICAgICAgICAgICBhZnRlclB1bmN0OiBmYWxzZSxcbiAgICAgICAgICAgIGlzRmlyc3Q6IHRydWVcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gX3RleHRjYXNlRW5naW5lKGNvbmZpZywgc3RyaW5nKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gY2FwaXRhbGl6ZUZpcnN0KHN0YXRlLCBzdHJpbmcpIHtcbiAgICAgICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgICAgICAgIHF1b3RlU3RhdGU6IFtdLFxuICAgICAgICAgICAgY2FwaXRhbGlzZVdvcmRzOiBmdW5jdGlvbihzdHIpIHtcbiAgICAgICAgICAgICAgICB2YXIgd29yZHMgPSBzdHIuc3BsaXQoXCIgXCIpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXdvcmRzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB3b3JkID0gd29yZHNbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmICh3b3JkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLmlzRmlyc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3Jkc1tpXSA9IF9jYXBpdGFsaXNlKHdvcmQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5pc0ZpcnN0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHdvcmRzLmpvaW4oXCIgXCIpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNraXBXb3Jkc1JleDogbnVsbCxcbiAgICAgICAgICAgIHRhZ1N0YXRlOiBbXSxcbiAgICAgICAgICAgIGFmdGVyUHVuY3Q6IG51bGwsXG4gICAgICAgICAgICBpc0ZpcnN0OiB0cnVlXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIF90ZXh0Y2FzZUVuZ2luZShjb25maWcsIHN0cmluZyk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNhcGl0YWxpemVBbGwgKHN0YXRlLCBzdHJpbmcpIHtcbiAgICAgICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgICAgICAgIHF1b3RlU3RhdGU6IFtdLFxuICAgICAgICAgICAgY2FwaXRhbGlzZVdvcmRzOiBmdW5jdGlvbihzdHIpIHtcbiAgICAgICAgICAgICAgICB2YXIgd29yZHMgPSBzdHIuc3BsaXQoXCIgXCIpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MCxpbGVuPXdvcmRzLmxlbmd0aDtpPGlsZW47aSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB3b3JkID0gd29yZHNbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmICh3b3JkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3b3Jkc1tpXSA9IF9jYXBpdGFsaXNlKHdvcmQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB3b3Jkcy5qb2luKFwiIFwiKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBza2lwV29yZHNSZXg6IG51bGwsXG4gICAgICAgICAgICB0YWdTdGF0ZTogW10sXG4gICAgICAgICAgICBhZnRlclB1bmN0OiBudWxsLFxuICAgICAgICAgICAgaXNGaXJzdDogbnVsbFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBfdGV4dGNhc2VFbmdpbmUoY29uZmlnLCBzdHJpbmcpO1xuICAgIH1cbn1cbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLk91dHB1dC5Gb3JtYXRzID0gZnVuY3Rpb24gKCkge307XG5DU0wuT3V0cHV0LkZvcm1hdHMucHJvdG90eXBlLmh0bWwgPSB7XG4gICAgXCJ0ZXh0X2VzY2FwZVwiOiBmdW5jdGlvbiAodGV4dCkge1xuICAgICAgICBpZiAoIXRleHQpIHtcbiAgICAgICAgICAgIHRleHQgPSBcIlwiO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UoLyYvZywgXCImIzM4O1wiKVxuICAgICAgICAgICAgLnJlcGxhY2UoLzwvZywgXCImIzYwO1wiKVxuICAgICAgICAgICAgLnJlcGxhY2UoLz4vZywgXCImIzYyO1wiKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcc1xccy9nLCBcIlxcdTAwQTAgXCIpXG4gICAgICAgICAgICAucmVwbGFjZShDU0wuU1VQRVJTQ1JJUFRTX1JFR0VYUCxcbiAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGFDaGFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiPHN1cD5cIiArIENTTC5TVVBFUlNDUklQVFNbYUNoYXJdICsgXCI8L3N1cD5cIjtcbiAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgIH0sXG4gICAgXCJiaWJzdGFydFwiOiBcIjxkaXYgY2xhc3M9XFxcImNzbC1iaWItYm9keVxcXCI+XFxuXCIsXG4gICAgXCJiaWJlbmRcIjogXCI8L2Rpdj5cIixcbiAgICBcIkBmb250LXN0eWxlL2l0YWxpY1wiOiBcIjxpPiUlU1RSSU5HJSU8L2k+XCIsXG4gICAgXCJAZm9udC1zdHlsZS9vYmxpcXVlXCI6IFwiPGVtPiUlU1RSSU5HJSU8L2VtPlwiLFxuICAgIFwiQGZvbnQtc3R5bGUvbm9ybWFsXCI6IFwiPHNwYW4gc3R5bGU9XFxcImZvbnQtc3R5bGU6bm9ybWFsO1xcXCI+JSVTVFJJTkclJTwvc3Bhbj5cIixcbiAgICBcIkBmb250LXZhcmlhbnQvc21hbGwtY2Fwc1wiOiBcIjxzcGFuIHN0eWxlPVxcXCJmb250LXZhcmlhbnQ6c21hbGwtY2FwcztcXFwiPiUlU1RSSU5HJSU8L3NwYW4+XCIsXG4gICAgXCJAcGFzc3Rocm91Z2gvdHJ1ZVwiOiBDU0wuT3V0cHV0LkZvcm1hdHRlcnMucGFzc3Rocm91Z2gsXG4gICAgXCJAZm9udC12YXJpYW50L25vcm1hbFwiOiBcIjxzcGFuIHN0eWxlPVxcXCJmb250LXZhcmlhbnQ6bm9ybWFsO1xcXCI+JSVTVFJJTkclJTwvc3Bhbj5cIixcbiAgICBcIkBmb250LXdlaWdodC9ib2xkXCI6IFwiPGI+JSVTVFJJTkclJTwvYj5cIixcbiAgICBcIkBmb250LXdlaWdodC9ub3JtYWxcIjogXCI8c3BhbiBzdHlsZT1cXFwiZm9udC13ZWlnaHQ6bm9ybWFsO1xcXCI+JSVTVFJJTkclJTwvc3Bhbj5cIixcbiAgICBcIkBmb250LXdlaWdodC9saWdodFwiOiBmYWxzZSxcbiAgICBcIkB0ZXh0LWRlY29yYXRpb24vbm9uZVwiOiBcIjxzcGFuIHN0eWxlPVxcXCJ0ZXh0LWRlY29yYXRpb246bm9uZTtcXFwiPiUlU1RSSU5HJSU8L3NwYW4+XCIsXG4gICAgXCJAdGV4dC1kZWNvcmF0aW9uL3VuZGVybGluZVwiOiBcIjxzcGFuIHN0eWxlPVxcXCJ0ZXh0LWRlY29yYXRpb246dW5kZXJsaW5lO1xcXCI+JSVTVFJJTkclJTwvc3Bhbj5cIixcbiAgICBcIkB2ZXJ0aWNhbC1hbGlnbi9zdXBcIjogXCI8c3VwPiUlU1RSSU5HJSU8L3N1cD5cIixcbiAgICBcIkB2ZXJ0aWNhbC1hbGlnbi9zdWJcIjogXCI8c3ViPiUlU1RSSU5HJSU8L3N1Yj5cIixcbiAgICBcIkB2ZXJ0aWNhbC1hbGlnbi9iYXNlbGluZVwiOiBcIjxzcGFuIHN0eWxlPVxcXCJiYXNlbGluZVxcXCI+JSVTVFJJTkclJTwvc3Bhbj5cIixcbiAgICBcIkBzdHJpcC1wZXJpb2RzL3RydWVcIjogQ1NMLk91dHB1dC5Gb3JtYXR0ZXJzLnBhc3N0aHJvdWdoLFxuICAgIFwiQHN0cmlwLXBlcmlvZHMvZmFsc2VcIjogQ1NMLk91dHB1dC5Gb3JtYXR0ZXJzLnBhc3N0aHJvdWdoLFxuICAgIFwiQHF1b3Rlcy90cnVlXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygc3RyKSB7XG4gICAgICAgICAgICByZXR1cm4gc3RhdGUuZ2V0VGVybShcIm9wZW4tcXVvdGVcIik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN0YXRlLmdldFRlcm0oXCJvcGVuLXF1b3RlXCIpICsgc3RyICsgc3RhdGUuZ2V0VGVybShcImNsb3NlLXF1b3RlXCIpO1xuICAgIH0sXG4gICAgXCJAcXVvdGVzL2lubmVyXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2Ygc3RyKSB7XG4gICAgICAgICAgICByZXR1cm4gXCJcXHUyMDE5XCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN0YXRlLmdldFRlcm0oXCJvcGVuLWlubmVyLXF1b3RlXCIpICsgc3RyICsgc3RhdGUuZ2V0VGVybShcImNsb3NlLWlubmVyLXF1b3RlXCIpO1xuICAgIH0sXG4gICAgXCJAcXVvdGVzL2ZhbHNlXCI6IGZhbHNlLFxuICAgIFwiQGNpdGUvZW50cnlcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIHN0YXRlLnN5cy53cmFwQ2l0YXRpb25FbnRyeShzdHIsIHRoaXMuaXRlbV9pZCwgdGhpcy5sb2NhdG9yX3R4dCwgdGhpcy5zdWZmaXhfdHh0KTtcblx0fSxcbiAgICBcIkBiaWJsaW9ncmFwaHkvZW50cnlcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgdmFyIGluc2VydCA9IFwiXCI7XG4gICAgICAgIGlmIChzdGF0ZS5zeXMuZW1iZWRCaWJsaW9ncmFwaHlFbnRyeSkge1xuICAgICAgICAgICAgaW5zZXJ0ID0gc3RhdGUuc3lzLmVtYmVkQmlibGlvZ3JhcGh5RW50cnkodGhpcy5pdGVtX2lkKSArIFwiXFxuXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFwiICA8ZGl2IGNsYXNzPVxcXCJjc2wtZW50cnlcXFwiPlwiICsgc3RyICsgXCI8L2Rpdj5cXG5cIiArIGluc2VydDtcbiAgICB9LFxuICAgIFwiQGRpc3BsYXkvYmxvY2tcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIFwiXFxuXFxuICAgIDxkaXYgY2xhc3M9XFxcImNzbC1ibG9ja1xcXCI+XCIgKyBzdHIgKyBcIjwvZGl2PlxcblwiO1xuICAgIH0sXG4gICAgXCJAZGlzcGxheS9sZWZ0LW1hcmdpblwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gXCJcXG4gICAgPGRpdiBjbGFzcz1cXFwiY3NsLWxlZnQtbWFyZ2luXFxcIj5cIiArIHN0ciArIFwiPC9kaXY+XCI7XG4gICAgfSxcbiAgICBcIkBkaXNwbGF5L3JpZ2h0LWlubGluZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gXCI8ZGl2IGNsYXNzPVxcXCJjc2wtcmlnaHQtaW5saW5lXFxcIj5cIiArIHN0ciArIFwiPC9kaXY+XFxuICBcIjtcbiAgICB9LFxuICAgIFwiQGRpc3BsYXkvaW5kZW50XCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBcIjxkaXYgY2xhc3M9XFxcImNzbC1pbmRlbnRcXFwiPlwiICsgc3RyICsgXCI8L2Rpdj5cXG4gIFwiO1xuICAgIH0sXG4gICAgXCJAc2hvd2lkL3RydWVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIsIGNzbGlkKSB7XG4gICAgICAgIGlmICghc3RhdGUudG1wLmp1c3RfbG9va2luZyAmJiAhIHN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgaWYgKGNzbGlkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFwiPHNwYW4gY2xhc3M9XFxcIlwiICsgc3RhdGUub3B0Lm5vZGVuYW1lc1tjc2xpZF0gKyBcIlxcXCIgY3NsaWQ9XFxcIlwiICsgY3NsaWQgKyBcIlxcXCI+XCIgKyBzdHIgKyBcIjwvc3Bhbj5cIjtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5wYXJhbXMgJiYgXCJzdHJpbmdcIiA9PT0gdHlwZW9mIHN0cikge1xuICAgICAgICAgICAgICAgIHZhciBwcmVQdW5jdCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgaWYgKHN0cikge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbSA9IHN0ci5tYXRjaChDU0wuVkFSSUFCTEVfV1JBUFBFUl9QUkVQVU5DVF9SRVgpO1xuICAgICAgICAgICAgICAgICAgICBwcmVQdW5jdCA9IG1bMV07XG4gICAgICAgICAgICAgICAgICAgIHN0ciA9IG1bMl07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBwb3N0UHVuY3QgPSBcIlwiO1xuICAgICAgICAgICAgICAgIGlmIChzdHIgJiYgQ1NMLlNXQVBQSU5HX1BVTkNUVUFUSU9OLmluZGV4T2Yoc3RyLnNsaWNlKC0xKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICBwb3N0UHVuY3QgPSBzdHIuc2xpY2UoLTEpO1xuICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc2xpY2UoMCwtMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZS5zeXMudmFyaWFibGVXcmFwcGVyKHRoaXMucGFyYW1zLCBwcmVQdW5jdCwgc3RyLCBwb3N0UHVuY3QpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgXCJAVVJML3RydWVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIFwiPGEgaHJlZj1cXFwiXCIgKyBzdHIgKyBcIlxcXCI+XCIgKyBzdHIgKyBcIjwvYT5cIjtcbiAgICB9LFxuICAgIFwiQERPSS90cnVlXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBcIjxhIGhyZWY9XFxcImh0dHBzOi8vZG9pLm9yZy9cIiArIHN0ciArIFwiXFxcIj5cIiArIHN0ciArIFwiPC9hPlwiO1xuICAgIH1cbn07XG5DU0wuT3V0cHV0LkZvcm1hdHMucHJvdG90eXBlLnRleHQgPSB7XG4gICAgXCJ0ZXh0X2VzY2FwZVwiOiBmdW5jdGlvbiAodGV4dCkge1xuICAgICAgICBpZiAoIXRleHQpIHtcbiAgICAgICAgICAgIHRleHQgPSBcIlwiO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0ZXh0O1xuICAgIH0sXG4gICAgXCJiaWJzdGFydFwiOiBcIlwiLFxuICAgIFwiYmliZW5kXCI6IFwiXCIsXG4gICAgXCJAZm9udC1zdHlsZS9pdGFsaWNcIjogZmFsc2UsXG4gICAgXCJAZm9udC1zdHlsZS9vYmxpcXVlXCI6IGZhbHNlLFxuICAgIFwiQGZvbnQtc3R5bGUvbm9ybWFsXCI6IGZhbHNlLFxuICAgIFwiQGZvbnQtdmFyaWFudC9zbWFsbC1jYXBzXCI6IGZhbHNlLFxuICAgIFwiQHBhc3N0aHJvdWdoL3RydWVcIjogQ1NMLk91dHB1dC5Gb3JtYXR0ZXJzLnBhc3N0aHJvdWdoLFxuICAgIFwiQGZvbnQtdmFyaWFudC9ub3JtYWxcIjogZmFsc2UsXG4gICAgXCJAZm9udC13ZWlnaHQvYm9sZFwiOiBmYWxzZSxcbiAgICBcIkBmb250LXdlaWdodC9ub3JtYWxcIjogZmFsc2UsXG4gICAgXCJAZm9udC13ZWlnaHQvbGlnaHRcIjogZmFsc2UsXG4gICAgXCJAdGV4dC1kZWNvcmF0aW9uL25vbmVcIjogZmFsc2UsXG4gICAgXCJAdGV4dC1kZWNvcmF0aW9uL3VuZGVybGluZVwiOiBmYWxzZSxcbiAgICBcIkB2ZXJ0aWNhbC1hbGlnbi9iYXNlbGluZVwiOiBmYWxzZSxcbiAgICBcIkB2ZXJ0aWNhbC1hbGlnbi9zdXBcIjogZmFsc2UsXG4gICAgXCJAdmVydGljYWwtYWxpZ24vc3ViXCI6IGZhbHNlLFxuICAgIFwiQHN0cmlwLXBlcmlvZHMvdHJ1ZVwiOiBDU0wuT3V0cHV0LkZvcm1hdHRlcnMucGFzc3Rocm91Z2gsXG4gICAgXCJAc3RyaXAtcGVyaW9kcy9mYWxzZVwiOiBDU0wuT3V0cHV0LkZvcm1hdHRlcnMucGFzc3Rocm91Z2gsXG4gICAgXCJAcXVvdGVzL3RydWVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBzdHIpIHtcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS5nZXRUZXJtKFwib3Blbi1xdW90ZVwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3RhdGUuZ2V0VGVybShcIm9wZW4tcXVvdGVcIikgKyBzdHIgKyBzdGF0ZS5nZXRUZXJtKFwiY2xvc2UtcXVvdGVcIik7XG4gICAgfSxcbiAgICBcIkBxdW90ZXMvaW5uZXJcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBzdHIpIHtcbiAgICAgICAgICAgIHJldHVybiBcIlxcdTIwMTlcIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3RhdGUuZ2V0VGVybShcIm9wZW4taW5uZXItcXVvdGVcIikgKyBzdHIgKyBzdGF0ZS5nZXRUZXJtKFwiY2xvc2UtaW5uZXItcXVvdGVcIik7XG4gICAgfSxcbiAgICBcIkBxdW90ZXMvZmFsc2VcIjogZmFsc2UsXG4gICAgXCJAY2l0ZS9lbnRyeVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuXHRcdHJldHVybiBzdGF0ZS5zeXMud3JhcENpdGF0aW9uRW50cnkoc3RyLCB0aGlzLml0ZW1faWQsIHRoaXMubG9jYXRvcl90eHQsIHRoaXMuc3VmZml4X3R4dCk7XG5cdH0sXG4gICAgXCJAYmlibGlvZ3JhcGh5L2VudHJ5XCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBzdHIrXCJcXG5cIjtcbiAgICB9LFxuICAgIFwiQGRpc3BsYXkvYmxvY2tcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIFwiXFxuXCIrc3RyO1xuICAgIH0sXG4gICAgXCJAZGlzcGxheS9sZWZ0LW1hcmdpblwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gc3RyO1xuICAgIH0sXG4gICAgXCJAZGlzcGxheS9yaWdodC1pbmxpbmVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIHN0cjtcbiAgICB9LFxuICAgIFwiQGRpc3BsYXkvaW5kZW50XCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBcIlxcbiAgICBcIitzdHI7XG4gICAgfSxcbiAgICBcIkBzaG93aWQvdHJ1ZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0ciwgY3NsaWQpIHtcbiAgICAgICAgcmV0dXJuIHN0cjtcbiAgICB9LFxuICAgIFwiQFVSTC90cnVlXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBzdHI7XG4gICAgfSxcbiAgICBcIkBET0kvdHJ1ZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICByZXR1cm4gc3RyO1xuICAgIH1cbn07XG5DU0wuT3V0cHV0LkZvcm1hdHMucHJvdG90eXBlLnJ0ZiA9IHtcbiAgICBcInRleHRfZXNjYXBlXCI6IGZ1bmN0aW9uICh0ZXh0KSB7XG4gICAgICAgIGlmICghdGV4dCkge1xuICAgICAgICAgICAgdGV4dCA9IFwiXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRleHRcbiAgICAgICAgLnJlcGxhY2UoLyhbXFxcXHt9XSkvZywgXCJcXFxcJDFcIilcbiAgICAgICAgLnJlcGxhY2UoQ1NMLlNVUEVSU0NSSVBUU19SRUdFWFAsXG4gICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGFDaGFyKSB7XG4gICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJcXFxcc3VwZXIgXCIgKyBDU0wuU1VQRVJTQ1JJUFRTW2FDaGFyXSArIFwiXFxcXG5vc3VwZXJzdWJ7fVwiO1xuICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAucmVwbGFjZSgvW1xcdTAwN0YtXFx1RkZGRl0vZyxcbiAgICAgICAgICAgICAgICAgZnVuY3Rpb24oYUNoYXIpIHsgcmV0dXJuIFwiXFxcXHVjMFxcXFx1XCIrYUNoYXIuY2hhckNvZGVBdCgwKS50b1N0cmluZygpK1wie31cIjsgfSlcbiAgICAgICAgLnNwbGl0KFwiXFx0XCIpLmpvaW4oXCJcXFxcdGFie31cIik7XG4gICAgfSxcbiAgICBcIkBwYXNzdGhyb3VnaC90cnVlXCI6IENTTC5PdXRwdXQuRm9ybWF0dGVycy5wYXNzdGhyb3VnaCxcbiAgICBcIkBmb250LXN0eWxlL2l0YWxpY1wiOlwie1xcXFxpe30lJVNUUklORyUlfVwiLFxuICAgIFwiQGZvbnQtc3R5bGUvbm9ybWFsXCI6XCJ7XFxcXGkwe30lJVNUUklORyUlfVwiLFxuICAgIFwiQGZvbnQtc3R5bGUvb2JsaXF1ZVwiOlwie1xcXFxpe30lJVNUUklORyUlfVwiLFxuICAgIFwiQGZvbnQtdmFyaWFudC9zbWFsbC1jYXBzXCI6XCJ7XFxcXHNjYXBzICUlU1RSSU5HJSV9XCIsXG4gICAgXCJAZm9udC12YXJpYW50L25vcm1hbFwiOlwie1xcXFxzY2FwczB7fSUlU1RSSU5HJSV9XCIsXG4gICAgXCJAZm9udC13ZWlnaHQvYm9sZFwiOlwie1xcXFxie30lJVNUUklORyUlfVwiLFxuICAgIFwiQGZvbnQtd2VpZ2h0L25vcm1hbFwiOlwie1xcXFxiMHt9JSVTVFJJTkclJX1cIixcbiAgICBcIkBmb250LXdlaWdodC9saWdodFwiOmZhbHNlLFxuICAgIFwiQHRleHQtZGVjb3JhdGlvbi9ub25lXCI6ZmFsc2UsXG4gICAgXCJAdGV4dC1kZWNvcmF0aW9uL3VuZGVybGluZVwiOlwie1xcXFx1bHt9JSVTVFJJTkclJX1cIixcbiAgICBcIkB2ZXJ0aWNhbC1hbGlnbi9iYXNlbGluZVwiOmZhbHNlLFxuICAgIFwiQHZlcnRpY2FsLWFsaWduL3N1cFwiOlwiXFxcXHN1cGVyICUlU1RSSU5HJSVcXFxcbm9zdXBlcnN1Ynt9XCIsXG4gICAgXCJAdmVydGljYWwtYWxpZ24vc3ViXCI6XCJcXFxcc3ViICUlU1RSSU5HJSVcXFxcbm9zdXBlcnN1Ynt9XCIsXG4gICAgXCJAc3RyaXAtcGVyaW9kcy90cnVlXCI6IENTTC5PdXRwdXQuRm9ybWF0dGVycy5wYXNzdGhyb3VnaCxcbiAgICBcIkBzdHJpcC1wZXJpb2RzL2ZhbHNlXCI6IENTTC5PdXRwdXQuRm9ybWF0dGVycy5wYXNzdGhyb3VnaCxcbiAgICBcIkBxdW90ZXMvdHJ1ZVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHN0cikge1xuICAgICAgICAgICAgcmV0dXJuIENTTC5PdXRwdXQuRm9ybWF0cy5ydGYudGV4dF9lc2NhcGUoc3RhdGUuZ2V0VGVybShcIm9wZW4tcXVvdGVcIikpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBDU0wuT3V0cHV0LkZvcm1hdHMucnRmLnRleHRfZXNjYXBlKHN0YXRlLmdldFRlcm0oXCJvcGVuLXF1b3RlXCIpKSArIHN0ciArIENTTC5PdXRwdXQuRm9ybWF0cy5ydGYudGV4dF9lc2NhcGUoc3RhdGUuZ2V0VGVybShcImNsb3NlLXF1b3RlXCIpKTtcbiAgICB9LFxuICAgIFwiQHF1b3Rlcy9pbm5lclwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHN0cikge1xuICAgICAgICAgICAgcmV0dXJuIENTTC5PdXRwdXQuRm9ybWF0cy5ydGYudGV4dF9lc2NhcGUoXCJcXHUyMDE5XCIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBDU0wuT3V0cHV0LkZvcm1hdHMucnRmLnRleHRfZXNjYXBlKHN0YXRlLmdldFRlcm0oXCJvcGVuLWlubmVyLXF1b3RlXCIpKSArIHN0ciArIENTTC5PdXRwdXQuRm9ybWF0cy5ydGYudGV4dF9lc2NhcGUoc3RhdGUuZ2V0VGVybShcImNsb3NlLWlubmVyLXF1b3RlXCIpKTtcbiAgICB9LFxuICAgIFwiQHF1b3Rlcy9mYWxzZVwiOiBmYWxzZSxcbiAgICBcImJpYnN0YXJ0XCI6XCJ7XFxcXHJ0ZiBcIixcbiAgICBcImJpYmVuZFwiOlwifVwiLFxuICAgIFwiQGRpc3BsYXkvYmxvY2tcIjogXCJcXFxcbGluZXt9JSVTVFJJTkclJVxcXFxsaW5lXFxyXFxuXCIsXG4gICAgXCJAY2l0ZS9lbnRyeVwiOiBmdW5jdGlvbiAoc3RhdGUsIHN0cikge1xuXHRcdHJldHVybiBzdGF0ZS5zeXMud3JhcENpdGF0aW9uRW50cnkoc3RyLCB0aGlzLml0ZW1faWQsIHRoaXMubG9jYXRvcl90eHQsIHRoaXMuc3VmZml4X3R4dCk7XG5cdH0sXG4gICAgXCJAYmlibGlvZ3JhcGh5L2VudHJ5XCI6IGZ1bmN0aW9uKHN0YXRlLHN0cil7XG4gICAgICAgIHJldHVybiBzdHI7XG4gICAgfSxcbiAgICBcIkBkaXNwbGF5L2xlZnQtbWFyZ2luXCI6IGZ1bmN0aW9uKHN0YXRlLHN0cil7XG4gICAgICAgIHJldHVybiBzdHIrXCJcXFxcdGFiIFwiO1xuICAgIH0sXG4gICAgXCJAZGlzcGxheS9yaWdodC1pbmxpbmVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIHN0citcIlxcclxcblwiO1xuICAgIH0sXG4gICAgXCJAZGlzcGxheS9pbmRlbnRcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIFwiXFxuXFxcXHRhYiBcIitzdHIrXCJcXFxcbGluZVxcclxcblwiO1xuICAgIH0sXG4gICAgXCJAc2hvd2lkL3RydWVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIsIGNzbGlkKSB7XG4gICAgICAgIGlmICghc3RhdGUudG1wLmp1c3RfbG9va2luZyAmJiAhIHN0YXRlLnRtcC5zdXBwcmVzc19kZWNvcmF0aW9ucykge1xuICAgICAgICAgICAgdmFyIHByZVB1bmN0ID0gXCJcIjtcbiAgICAgICAgICAgIGlmIChzdHIpIHtcbiAgICAgICAgICAgICAgICB2YXIgbSA9IHN0ci5tYXRjaChDU0wuVkFSSUFCTEVfV1JBUFBFUl9QUkVQVU5DVF9SRVgpO1xuICAgICAgICAgICAgICAgIHByZVB1bmN0ID0gbVsxXTtcbiAgICAgICAgICAgICAgICBzdHIgPSBtWzJdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHBvc3RQdW5jdCA9IFwiXCI7XG4gICAgICAgICAgICBpZiAoc3RyICYmIENTTC5TV0FQUElOR19QVU5DVFVBVElPTi5pbmRleE9mKHN0ci5zbGljZSgtMSkpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBwb3N0UHVuY3QgPSBzdHIuc2xpY2UoLTEpO1xuICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5zbGljZSgwLC0xKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS5zeXMudmFyaWFibGVXcmFwcGVyKHRoaXMucGFyYW1zLCBwcmVQdW5jdCwgc3RyLCBwb3N0UHVuY3QpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHN0cjtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgXCJAVVJML3RydWVcIjogZnVuY3Rpb24gKHN0YXRlLCBzdHIpIHtcbiAgICAgICAgcmV0dXJuIHN0cjtcbiAgICB9LFxuICAgIFwiQERPSS90cnVlXCI6IGZ1bmN0aW9uIChzdGF0ZSwgc3RyKSB7XG4gICAgICAgIHJldHVybiBzdHI7XG4gICAgfVxufTtcbkNTTC5PdXRwdXQuRm9ybWF0cyA9IG5ldyBDU0wuT3V0cHV0LkZvcm1hdHMoKTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlJlZ2lzdHJ5ID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdmFyIHBvcywgbGVuLCByZXQsIGksIGlsZW47XG4gICAgdGhpcy5kZWJ1ZyA9IGZhbHNlO1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICB0aGlzLnJlZ2lzdHJ5ID0ge307XG4gICAgdGhpcy5yZWZsaXN0ID0gW107XG4gICAgdGhpcy5yZWZoYXNoID0ge307XG4gICAgdGhpcy5uYW1lcmVnID0gbmV3IENTTC5SZWdpc3RyeS5OYW1lUmVnKHN0YXRlKTtcbiAgICB0aGlzLmNpdGF0aW9ucmVnID0gbmV3IENTTC5SZWdpc3RyeS5DaXRhdGlvblJlZyhzdGF0ZSk7XG4gICAgdGhpcy5hdXRob3JzdHJpbmdzID0ge307XG4gICAgdGhpcy5teWxpc3QgPSBbXTtcbiAgICB0aGlzLm15aGFzaCA9IHt9O1xuICAgIHRoaXMuZGVsZXRlcyA9IFtdO1xuICAgIHRoaXMuaW5zZXJ0cyA9IFtdO1xuICAgIHRoaXMudW5jaXRlZCA9IHt9O1xuICAgIHRoaXMucmVmcmVzaGVzID0ge307XG4gICAgdGhpcy5ha2V5cyA9IHt9O1xuICAgIHRoaXMub2xkc2VxID0ge307XG4gICAgdGhpcy5yZXR1cm5fZGF0YSA9IHt9O1xuICAgIHRoaXMuYW1iaWdjaXRlcyA9IHt9O1xuICAgIHRoaXMuYW1iaWdyZXNldHMgPSB7fTtcbiAgICB0aGlzLnNvcnRlciA9IG5ldyBDU0wuUmVnaXN0cnkuQ29tcGFyaWZpZXIoc3RhdGUsIFwiYmlibGlvZ3JhcGh5X3NvcnRcIik7XG4gICAgdGhpcy5nZXRTb3J0ZWRJZHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciByZXQgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLnJlZmxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICByZXQucHVzaChcIlwiICsgdGhpcy5yZWZsaXN0W2ldLmlkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH07XG4gICAgdGhpcy5nZXRTb3J0ZWRSZWdpc3RyeUl0ZW1zID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgcmV0ID0gW107XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5yZWZsaXN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgcmV0LnB1c2godGhpcy5yZWZsaXN0W2ldKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH07XG59O1xuQ1NMLlJlZ2lzdHJ5LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKGl0ZW1JRHMsIHVuY2l0ZWRfZmxhZykge1xuICAgIHZhciBpLCBpbGVuO1xuICAgIHRoaXMub2xkc2VxID0ge307XG4gICAgaWYgKHVuY2l0ZWRfZmxhZykge1xuICAgICAgICB0aGlzLnVuY2l0ZWQgPSB7fTtcbiAgICAgICAgZm9yICh2YXIgaT0wLGlsZW49aXRlbUlEcy5sZW5ndGg7aTxpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5teWhhc2hbaXRlbUlEc1tpXV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLm15bGlzdC5wdXNoKFwiXCIgKyBpdGVtSURzW2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMudW5jaXRlZFtpdGVtSURzW2ldXSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLm15aGFzaFtpdGVtSURzW2ldXSA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy51bmNpdGVkKSB7XG4gICAgICAgICAgICBpdGVtSURzLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbXloYXNoID0ge307XG4gICAgICAgIGZvciAoaT1pdGVtSURzLmxlbmd0aC0xO2k+LTE7IGkgKz0gLTEpIHtcbiAgICAgICAgICAgIGlmIChteWhhc2hbaXRlbUlEc1tpXV0pIHtcbiAgICAgICAgICAgICAgICBpdGVtSURzID0gaXRlbUlEcy5zbGljZSgwLCBpKS5jb25jYXQoaXRlbUlEcy5zbGljZShpICsgMSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBteWhhc2hbaXRlbUlEc1tpXV0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMubXlsaXN0ID0gW107XG4gICAgICAgIGZvciAodmFyIGk9MCxpbGVuPWl0ZW1JRHMubGVuZ3RoO2k8aWxlbjtpKz0xKSB7XG4gICAgICAgICAgICB0aGlzLm15bGlzdC5wdXNoKFwiXCIgKyBpdGVtSURzW2ldKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm15aGFzaCA9IG15aGFzaDtcbiAgICB9XG4gICAgdGhpcy5yZWZyZXNoZXMgPSB7fTtcbiAgICB0aGlzLnRvdWNoZWQgPSB7fTtcbiAgICB0aGlzLmFtYmlnc1RvdWNoZWQgPSB7fTtcbiAgICB0aGlzLmFtYmlncmVzZXRzID0ge307XG59O1xuQ1NMLlJlZ2lzdHJ5LnByb3RvdHlwZS5kb3B1cmdlID0gZnVuY3Rpb24gKG15aGFzaCkge1xuICAgIGZvciAodmFyIGk9dGhpcy5teWxpc3QubGVuZ3RoLTE7aT4tMTtpKz0tMSkge1xuICAgICAgICBpZiAodGhpcy5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZCkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkW3RoaXMubXlsaXN0W2ldXSAmJiAhbXloYXNoW3RoaXMubXlsaXN0W2ldXSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm15aGFzaFt0aGlzLm15bGlzdFtpXV07XG4gICAgICAgICAgICAgICAgdGhpcy5teWxpc3QgPSB0aGlzLm15bGlzdC5zbGljZSgwLGkpLmNvbmNhdCh0aGlzLm15bGlzdC5zbGljZShpKzEpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmRvZGVsZXRlcyh0aGlzLm15aGFzaCk7XG59O1xuQ1NMLlJlZ2lzdHJ5LnByb3RvdHlwZS5kb2RlbGV0ZXMgPSBmdW5jdGlvbiAobXloYXNoKSB7XG4gICAgdmFyIG90aGVyaXRlbXMsIGtleSwgYW1iaWcsIHBvcywgbGVuLCBpdGVtcywga2tleSwgbXlwb3MsIGlkO1xuICAgIGlmIChcInN0cmluZ1wiID09PSB0eXBlb2YgbXloYXNoKSB7XG4gICAgICAgIG15aGFzaCA9IHt9O1xuICAgICAgICBteWhhc2hbbXloYXNoXSA9IHRydWU7XG4gICAgfVxuICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnJlZ2lzdHJ5KSB7XG4gICAgICAgIGlmICghbXloYXNoW2tleV0pIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnVuY2l0ZWRba2V5XSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgb3RoZXJpdGVtcyA9IHRoaXMubmFtZXJlZy5kZWxpdGVtcyhrZXkpO1xuICAgICAgICAgICAgZm9yIChra2V5IGluIG90aGVyaXRlbXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hlc1tra2V5XSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhbWJpZyA9IHRoaXMucmVnaXN0cnlba2V5XS5hbWJpZztcbiAgICAgICAgICAgIG15cG9zID0gdGhpcy5hbWJpZ2NpdGVzW2FtYmlnXS5pbmRleE9mKGtleSk7XG4gICAgICAgICAgICBpZiAobXlwb3MgPiAtMSkge1xuICAgICAgICAgICAgICAgIGl0ZW1zID0gdGhpcy5hbWJpZ2NpdGVzW2FtYmlnXS5zbGljZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuYW1iaWdjaXRlc1thbWJpZ10gPSBpdGVtcy5zbGljZSgwLCBteXBvcykuY29uY2F0KGl0ZW1zLnNsaWNlKG15cG9zKzEsIGl0ZW1zLmxlbmd0aCkpO1xuICAgICAgICAgICAgICAgIHRoaXMuYW1iaWdyZXNldHNbYW1iaWddID0gdGhpcy5hbWJpZ2NpdGVzW2FtYmlnXS5sZW5ndGg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZW4gPSB0aGlzLmFtYmlnY2l0ZXNbYW1iaWddLmxlbmd0aDtcbiAgICAgICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgICAgIGlkID0gXCJcIiArIHRoaXMuYW1iaWdjaXRlc1thbWJpZ11bcG9zXTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hlc1tpZF0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMucmVnaXN0cnlba2V5XS5zaWJsaW5ncykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlZ2lzdHJ5W2tleV0uc2libGluZ3MubGVuZ3RoID09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGxvbmVTaWJsaW5nSUQgPSB0aGlzLnJlZ2lzdHJ5W2tleV0uc2libGluZ3NbMF07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cnlbbG9uZVNpYmxpbmdJRF0ubWFzdGVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyeVtsb25lU2libGluZ0lEXS5zaWJsaW5ncy5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RyeVtsb25lU2libGluZ0lEXS5wYXJhbGxlbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5yZWdpc3RyeVtrZXldLnNpYmxpbmdzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlbW92ZUlEcyA9IFtrZXldO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZWdpc3RyeVtrZXldLm1hc3Rlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld21hc3RlcklEID0gdGhpcy5yZWdpc3RyeVtrZXldLnNpYmxpbmdzWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld21hc3RlciA9IHRoaXMucmVnaXN0cnlbbmV3bWFzdGVySURdO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3bWFzdGVyLm1hc3RlciA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdtYXN0ZXIucGFyYWxsZWwgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUlEcy5wdXNoKG5ld21hc3RlcklEKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBrbGVuID0gdGhpcy5yZWdpc3RyeVtrZXldLnNpYmxpbmdzLmxlbmd0aDsgayA8IGtsZW47IGsgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cnlbdGhpcy5yZWdpc3RyeVtrZXldLnNpYmxpbmdzW2tdXS5wYXJhbGxlbCA9IG5ld21hc3RlcklEO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciBidWZmZXIgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IHRoaXMucmVnaXN0cnlba2V5XS5zaWJsaW5ncy5sZW5ndGggLSAxOyBrID4gLTE7IGsgKz0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzaWJsaW5nSUQgPSB0aGlzLnJlZ2lzdHJ5W2tleV0uc2libGluZ3MucG9wKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlSURzLmluZGV4T2Yoc2libGluZ0lEKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaChzaWJsaW5nSUQpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IGJ1ZmZlci5sZW5ndGggLSAxOyBrID4gLTE7IGsgKz0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cnlba2V5XS5zaWJsaW5ncy5wdXNoKGJ1ZmZlcltrXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5yZWdpc3RyeVtrZXldO1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMucmVmaGFzaFtrZXldO1xuICAgICAgICAgICAgdGhpcy5yZXR1cm5fZGF0YS5iaWJjaGFuZ2UgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5SZWdpc3RyeS5wcm90b3R5cGUuZG9pbnNlcnRzID0gZnVuY3Rpb24gKG15bGlzdCkge1xuICAgIHZhciBsZW4sIHBvcywgaXRlbSwgSXRlbSwgYWtleSwgbmV3aXRlbSwgYWJhc2UsIGosIGpsZW4sIGssIGtsZW4sIGksIGlsZW47XG4gICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBteWxpc3QpIHtcbiAgICAgICAgbXlsaXN0ID0gW215bGlzdF07XG4gICAgfVxuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gbXlsaXN0Lmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICBpdGVtID0gbXlsaXN0W2ldO1xuICAgICAgICBpZiAoIXRoaXMucmVnaXN0cnlbaXRlbV0pIHtcbiAgICAgICAgICAgIEl0ZW0gPSB0aGlzLnN0YXRlLnJldHJpZXZlSXRlbShpdGVtKTtcbiAgICAgICAgICAgIGFrZXkgPSBDU0wuZ2V0QW1iaWd1b3VzQ2l0ZS5jYWxsKHRoaXMuc3RhdGUsIEl0ZW0pO1xuICAgICAgICAgICAgdGhpcy5hbWJpZ3NUb3VjaGVkW2FrZXldID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmICghSXRlbS5sZWdpc2xhdGlvbl9pZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuYWtleXNbYWtleV0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmV3aXRlbSA9IHtcbiAgICAgICAgICAgICAgICBcImlkXCI6IFwiXCIgKyBpdGVtLFxuICAgICAgICAgICAgICAgIFwic2VxXCI6IDAsXG4gICAgICAgICAgICAgICAgXCJvZmZzZXRcIjogMCxcbiAgICAgICAgICAgICAgICBcInNvcnRrZXlzXCI6IGZhbHNlLFxuICAgICAgICAgICAgICAgIFwiYW1iaWdcIjogZmFsc2UsXG4gICAgICAgICAgICAgICAgXCJyZW5kZXJlZFwiOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBcImRpc2FtYmlnXCI6IGZhbHNlLFxuICAgICAgICAgICAgICAgIFwicmVmXCI6IEl0ZW1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5W2l0ZW1dID0gbmV3aXRlbTtcbiAgICAgICAgICAgIGlmICh0aGlzLmNpdGF0aW9ucmVnLmNpdGF0aW9uc0J5SXRlbUlkICYmIHRoaXMuY2l0YXRpb25yZWcuY2l0YXRpb25zQnlJdGVtSWRbaXRlbV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5W2l0ZW1dW1wiZmlyc3QtcmVmZXJlbmNlLW5vdGUtbnVtYmVyXCJdID0gdGhpcy5jaXRhdGlvbnJlZy5jaXRhdGlvbnNCeUl0ZW1JZFtpdGVtXVswXS5wcm9wZXJ0aWVzLm5vdGVJbmRleDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFiYXNlID0gQ1NMLmdldEFtYmlnQ29uZmlnLmNhbGwodGhpcy5zdGF0ZSk7XG4gICAgICAgICAgICB0aGlzLnJlZ2lzdGVyQW1iaWdUb2tlbihha2V5LCBpdGVtLCBhYmFzZSk7XG4gICAgICAgICAgICB0aGlzLnRvdWNoZWRbaXRlbV0gPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5yZXR1cm5fZGF0YS5iaWJjaGFuZ2UgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxufTtcbkNTTC5SZWdpc3RyeS5wcm90b3R5cGUucmVidWlsZGxpc3QgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGNvdW50LCBsZW4sIHBvcywgaXRlbTtcbiAgICB0aGlzLnJlZmxpc3QgPSBbXTtcbiAgICBpZiAodGhpcy5zdGF0ZS5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnRfZGlyZWN0aW9uID09PSBDU0wuREVTQ0VORElOR1xuICAgICAgICYmIHRoaXMuc3RhdGUub3B0LmNpdGF0aW9uX251bWJlcl9zb3J0X3VzZWQpIHtcbiAgICB9XG4gICAgbGVuID0gdGhpcy5teWxpc3QubGVuZ3RoO1xuICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBpdGVtID0gdGhpcy5teWxpc3RbcG9zXTtcbiAgICAgICAgdGhpcy5yZWZsaXN0LnB1c2godGhpcy5yZWdpc3RyeVtpdGVtXSk7XG4gICAgICAgIHRoaXMub2xkc2VxW2l0ZW1dID0gdGhpcy5yZWdpc3RyeVtpdGVtXS5zZXE7XG4gICAgICAgIHRoaXMucmVnaXN0cnlbaXRlbV0uc2VxID0gKHBvcyArIDEpO1xuICAgIH1cbiAgICBpZiAodGhpcy5zdGF0ZS5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnRfZGlyZWN0aW9uID09PSBDU0wuREVTQ0VORElOR1xuICAgICAgICYmIHRoaXMuc3RhdGUub3B0LmNpdGF0aW9uX251bWJlcl9zb3J0X3VzZWQpIHtcbiAgICB9XG59O1xuQ1NMLlJlZ2lzdHJ5LnByb3RvdHlwZS5kb3JlZnJlc2hlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIga2V5LCByZWd0b2tlbiwgSXRlbSwgb2xkX2FrZXksIGFrZXksIGFiYXNlO1xuICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnJlZnJlc2hlcykge1xuICAgICAgICByZWd0b2tlbiA9IHRoaXMucmVnaXN0cnlba2V5XTtcbiAgICAgICAgaWYgKCFyZWd0b2tlbikge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgcmVndG9rZW4uc29ydGtleXMgPSB1bmRlZmluZWQ7XG4gICAgICAgIEl0ZW0gPSB0aGlzLnN0YXRlLnJldHJpZXZlSXRlbShrZXkpO1xuICAgICAgICB2YXIgYWtleSA9IHJlZ3Rva2VuLmFtYmlnO1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIGFrZXkpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzID0gZmFsc2U7XG4gICAgICAgICAgICBha2V5ID0gQ1NMLmdldEFtYmlndW91c0NpdGUuY2FsbCh0aGlzLnN0YXRlLCBJdGVtKTtcbiAgICAgICAgICAgIGFiYXNlID0gQ1NMLmdldEFtYmlnQ29uZmlnLmNhbGwodGhpcy5zdGF0ZSk7XG4gICAgICAgICAgICB0aGlzLnJlZ2lzdGVyQW1iaWdUb2tlbihha2V5LCBrZXksIGFiYXNlKTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBha2tleSBpbiB0aGlzLmFtYmlncmVzZXRzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5hbWJpZ3Jlc2V0c1tha2tleV0gPT09IDEpIHtcbiAgICAgICAgICAgICAgICB2YXIgbG9uZUtleSA9IHRoaXMuYW1iaWdjaXRlc1tha2V5XVswXTtcbiAgICAgICAgICAgICAgICB2YXIgSXRlbSA9IHRoaXMuc3RhdGUucmV0cmlldmVJdGVtKGxvbmVLZXkpO1xuICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0cnlbbG9uZUtleV0uZGlzYW1iaWcgPSBuZXcgQ1NMLkFtYmlnQ29uZmlnO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIGFrZXkgPSBDU0wuZ2V0QW1iaWd1b3VzQ2l0ZS5jYWxsKHRoaXMuc3RhdGUsIEl0ZW0pO1xuICAgICAgICAgICAgICAgIHZhciBhYmFzZSA9IENTTC5nZXRBbWJpZ0NvbmZpZy5jYWxsKHRoaXMuc3RhdGUpO1xuICAgICAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJBbWJpZ1Rva2VuKGFrZXksIGxvbmVLZXksIGFiYXNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN0YXRlLnRtcC50YWludGVkSXRlbUlEc1trZXldID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5hbWJpZ3NUb3VjaGVkW2FrZXldID0gdHJ1ZTtcbiAgICAgICAgaWYgKCFJdGVtLmxlZ2lzbGF0aW9uX2lkKSB7XG4gICAgICAgICAgICB0aGlzLmFrZXlzW2FrZXldID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRvdWNoZWRba2V5XSA9IHRydWU7XG4gICAgfVxufTtcbkNTTC5SZWdpc3RyeS5wcm90b3R5cGUuc2V0ZGlzYW1iaWdzID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBha2V5LCBsZWZ0b3ZlcnMsIGtleSwgcG9zLCBsZW4sIGlkO1xuICAgIHRoaXMubGVmdG92ZXJzID0gW107XG4gICAgZm9yIChha2V5IGluIHRoaXMuYW1iaWdzVG91Y2hlZCkge1xuICAgICAgICB0aGlzLnN0YXRlLmRpc2FtYmlndWF0ZS5ydW4oYWtleSk7XG4gICAgfVxuICAgIHRoaXMuYW1iaWdzVG91Y2hlZCA9IHt9O1xuICAgIHRoaXMuYWtleXMgPSB7fTtcbn07XG5DU0wuUmVnaXN0cnkucHJvdG90eXBlLnJlbnVtYmVyID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBsZW4sIHBvcywgaXRlbTtcbiAgICBpZiAodGhpcy5zdGF0ZS5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnRfZGlyZWN0aW9uID09PSBDU0wuREVTQ0VORElOR1xuICAgICAgICYmIHRoaXMuc3RhdGUub3B0LmNpdGF0aW9uX251bWJlcl9zb3J0X3VzZWQpIHtcbiAgICB9XG4gICAgbGVuID0gdGhpcy5yZWZsaXN0Lmxlbmd0aDtcbiAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgaXRlbSA9IHRoaXMucmVmbGlzdFtwb3NdO1xuICAgICAgICBpdGVtLnNlcSA9IChwb3MgKyAxKTtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUub3B0LnVwZGF0ZV9tb2RlID09PSBDU0wuTlVNRVJJQyAmJiBpdGVtLnNlcSAhPSB0aGlzLm9sZHNlcVtpdGVtLmlkXSkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudGFpbnRlZEl0ZW1JRHNbaXRlbS5pZF0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLm9wdC5iaWJfbW9kZSA9PT0gQ1NMLk5VTUVSSUMgJiYgaXRlbS5zZXEgIT0gdGhpcy5vbGRzZXFbaXRlbS5pZF0pIHtcbiAgICAgICAgICAgIHRoaXMucmV0dXJuX2RhdGEuYmliY2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5zdGF0ZS5vcHQuY2l0YXRpb25fbnVtYmVyX3NvcnRfZGlyZWN0aW9uID09PSBDU0wuREVTQ0VORElOR1xuICAgICAgICYmIHRoaXMuc3RhdGUub3B0LmNpdGF0aW9uX251bWJlcl9zb3J0X3VzZWQpIHtcbiAgICAgICAgdGhpcy5yZWZsaXN0LnJldmVyc2UoKTtcbiAgICB9XG59O1xuQ1NMLlJlZ2lzdHJ5LnByb3RvdHlwZS5zZXRzb3J0a2V5cyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIga2V5O1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5teWxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgIHZhciBrZXkgPSB0aGlzLm15bGlzdFtpXTtcbiAgICAgICAgaWYgKHRoaXMudG91Y2hlZFtrZXldIHx8IHRoaXMuc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW2tleV0gfHwgIXRoaXMucmVnaXN0cnlba2V5XS5zb3J0a2V5cykge1xuICAgICAgICAgICAgdGhpcy5yZWdpc3RyeVtrZXldLnNvcnRrZXlzID0gQ1NMLmdldFNvcnRLZXlzLmNhbGwodGhpcy5zdGF0ZSwgdGhpcy5zdGF0ZS5yZXRyaWV2ZUl0ZW0oa2V5KSwgXCJiaWJsaW9ncmFwaHlfc29ydFwiKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuUmVnaXN0cnkucHJvdG90eXBlLnNvcnR0b2tlbnMgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5yZWZsaXN0LnNvcnQodGhpcy5zb3J0ZXIuY29tcGFyZUtleXMpO1xufTtcbkNTTC5SZWdpc3RyeS5Db21wYXJpZmllciA9IGZ1bmN0aW9uIChzdGF0ZSwga2V5c2V0KSB7XG4gICAgdmFyIHNvcnRfZGlyZWN0aW9ucywgbGVuLCBwb3MsIGNvbXBhcmVLZXlzO1xuICAgIHZhciBzb3J0Q29tcGFyZSA9IENTTC5nZXRTb3J0Q29tcGFyZShzdGF0ZS5vcHRbXCJkZWZhdWx0LWxvY2FsZS1zb3J0XCJdKTtcbiAgICBzb3J0X2RpcmVjdGlvbnMgPSBzdGF0ZVtrZXlzZXRdLm9wdC5zb3J0X2RpcmVjdGlvbnM7XG4gICAgdGhpcy5jb21wYXJlS2V5cyA9IGZ1bmN0aW9uIChhLCBiKSB7XG4gICAgICAgIGxlbiA9IGEuc29ydGtleXMgPyBhLnNvcnRrZXlzLmxlbmd0aCA6IDA7XG4gICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICAgICAgdmFyIGNtcCA9IDA7XG4gICAgICAgICAgICBpZiAoYS5zb3J0a2V5c1twb3NdID09PSBiLnNvcnRrZXlzW3Bvc10pIHtcbiAgICAgICAgICAgICAgICBjbXAgPSAwO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgYS5zb3J0a2V5c1twb3NdKSB7XG4gICAgICAgICAgICAgICAgY21wID0gc29ydF9kaXJlY3Rpb25zW3Bvc11bMV07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiBiLnNvcnRrZXlzW3Bvc10pIHtcbiAgICAgICAgICAgICAgICBjbXAgPSBzb3J0X2RpcmVjdGlvbnNbcG9zXVswXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY21wID0gc29ydENvbXBhcmUoYS5zb3J0a2V5c1twb3NdLCBiLnNvcnRrZXlzW3Bvc10pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKDAgPCBjbXApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc29ydF9kaXJlY3Rpb25zW3Bvc11bMV07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKDAgPiBjbXApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc29ydF9kaXJlY3Rpb25zW3Bvc11bMF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGEuc2VxID4gYi5zZXEpIHtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9IGVsc2UgaWYgKGEuc2VxIDwgYi5zZXEpIHtcbiAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gMDtcbiAgICB9O1xuICAgIGNvbXBhcmVLZXlzID0gdGhpcy5jb21wYXJlS2V5cztcbiAgICB0aGlzLmNvbXBhcmVDb21wb3NpdGVLZXlzID0gZnVuY3Rpb24gKGEsIGIpIHtcbiAgICAgICAgcmV0dXJuIGNvbXBhcmVLZXlzKGFbMV0sIGJbMV0pO1xuICAgIH07XG59O1xuQ1NMLlJlZ2lzdHJ5LnByb3RvdHlwZS5jb21wYXJlUmVnaXN0cnlUb2tlbnMgPSBmdW5jdGlvbiAoYSwgYikge1xuICAgIGlmIChhLnNlcSA+IGIuc2VxKSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgIH0gZWxzZSBpZiAoYS5zZXEgPCBiLnNlcSkge1xuICAgICAgICByZXR1cm4gLTE7XG4gICAgfVxuICAgIHJldHVybiAwO1xufTtcbkNTTC5SZWdpc3RyeS5wcm90b3R5cGUucmVnaXN0ZXJBbWJpZ1Rva2VuID0gZnVuY3Rpb24gKGFrZXksIGlkLCBhbWJpZ19jb25maWcpIHtcbiAgICBpZiAodGhpcy5yZWdpc3RyeVtpZF0gJiYgdGhpcy5yZWdpc3RyeVtpZF0uZGlzYW1iaWcgJiYgdGhpcy5yZWdpc3RyeVtpZF0uZGlzYW1iaWcubmFtZXMpIHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBhbWJpZ19jb25maWcubmFtZXMubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG4gICAgICAgICAgICB2YXIgbmV3X25hbWVzX3BhcmFtcyA9IGFtYmlnX2NvbmZpZy5uYW1lc1tpXTtcbiAgICAgICAgICAgIHZhciBvbGRfbmFtZXNfcGFyYW1zID0gdGhpcy5yZWdpc3RyeVtpZF0uZGlzYW1iaWcubmFtZXNbaV07XG4gICAgICAgICAgICBpZiAobmV3X25hbWVzX3BhcmFtcyAhPT0gb2xkX25hbWVzX3BhcmFtcykge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW2lkXSA9IHRydWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGFtYmlnX2NvbmZpZy5naXZlbnNbaV0pIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBqPTAsamxlbj1hbWJpZ19jb25maWcuZ2l2ZW5zW2ldLmxlbmd0aDtqPGpsZW47ais9MSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3X2duYW1lc19wYXJhbXMgPSBhbWJpZ19jb25maWcuZ2l2ZW5zW2ldW2pdO1xuICAgICAgICAgICAgICAgICAgICB2YXIgb2xkX2duYW1lc19wYXJhbXMgPSB0aGlzLnJlZ2lzdHJ5W2lkXS5kaXNhbWJpZy5naXZlbnNbaV1bal07XG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXdfZ25hbWVzX3BhcmFtcyAhPT0gb2xkX2duYW1lc19wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW2lkXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCF0aGlzLmFtYmlnY2l0ZXNbYWtleV0pIHtcbiAgICAgICAgdGhpcy5hbWJpZ2NpdGVzW2FrZXldID0gW107XG4gICAgfVxuICAgIGlmICh0aGlzLmFtYmlnY2l0ZXNbYWtleV0uaW5kZXhPZihcIlwiICsgaWQpID09PSAtMSkge1xuICAgICAgICB0aGlzLmFtYmlnY2l0ZXNbYWtleV0ucHVzaChcIlwiICsgaWQpO1xuICAgIH1cbiAgICB0aGlzLnJlZ2lzdHJ5W2lkXS5hbWJpZyA9IGFrZXk7XG4gICAgdmFyIGRvbWUgPSBmYWxzZTtcbiAgICB0aGlzLnJlZ2lzdHJ5W2lkXS5kaXNhbWJpZyA9IENTTC5jbG9uZUFtYmlnQ29uZmlnKGFtYmlnX2NvbmZpZyk7XG59O1xuQ1NMLmdldFNvcnRLZXlzID0gZnVuY3Rpb24gKEl0ZW0sIGtleV90eXBlKSB7XG4gICAgdmFyIGFyZWEsIHJvb3QsIGV4dGVuc2lvbiwgc3RyaXBfcHJlcG9zaXRpb25zLCB1c2VfcGFyYWxsZWxzLCBsZW4sIHBvcztcbiAgICBhcmVhID0gdGhpcy50bXAuYXJlYTtcbiAgICByb290ID0gdGhpcy50bXAucm9vdDtcbiAgICBleHRlbnNpb24gPSB0aGlzLnRtcC5leHRlbnNpb247XG4gICAgc3RyaXBfcHJlcG9zaXRpb25zID0gQ1NMLlV0aWwuU29ydC5zdHJpcF9wcmVwb3NpdGlvbnM7XG4gICAgdGhpcy50bXAuYXJlYSA9IGtleV90eXBlO1xuICAgIHRoaXMudG1wLnJvb3QgPSBrZXlfdHlwZS5pbmRleE9mKFwiX1wiKSA+IC0xID8ga2V5X3R5cGUuc2xpY2UoMCwtNSkgOiBrZXlfdHlwZTtcbiAgICB0aGlzLnRtcC5leHRlbnNpb24gPSBcIl9zb3J0XCI7XG4gICAgdGhpcy50bXAuZGlzYW1iaWdfb3ZlcnJpZGUgPSB0cnVlO1xuICAgIHRoaXMudG1wLmRpc2FtYmlnX3JlcXVlc3QgPSBmYWxzZTtcbiAgICB0aGlzLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMgPSAodGhpcy5wYXJhbGxlbC51c2VfcGFyYWxsZWxzID09PSB0cnVlIHx8IHRoaXMucGFyYWxsZWwudXNlX3BhcmFsbGVscyA9PT0gbnVsbCkgPyBudWxsIDogZmFsc2U7XG4gICAgdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSB0cnVlO1xuICAgIENTTC5nZXRDaXRlLmNhbGwodGhpcywgSXRlbSk7XG4gICAgdGhpcy50bXAuc3VwcHJlc3NfZGVjb3JhdGlvbnMgPSBmYWxzZTtcbiAgICB0aGlzLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMgPSB0aGlzLnBhcmFsbGVsLnVzZV9wYXJhbGxlbHMgPT09IG51bGwgPyB0cnVlIDogZmFsc2U7XG4gICAgdGhpcy50bXAuZGlzYW1iaWdfb3ZlcnJpZGUgPSBmYWxzZTtcbiAgICBsZW4gPSB0aGlzW2tleV90eXBlXS5rZXlzLmxlbmd0aDtcbiAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbjsgcG9zICs9IDEpIHtcbiAgICAgICAgdGhpc1trZXlfdHlwZV0ua2V5c1twb3NdID0gc3RyaXBfcHJlcG9zaXRpb25zKHRoaXNba2V5X3R5cGVdLmtleXNbcG9zXSk7XG4gICAgfVxuICAgIHRoaXMudG1wLmFyZWEgPSBhcmVhO1xuICAgIHRoaXMudG1wLnJvb3QgPSByb290O1xuICAgIHRoaXMudG1wLmV4dGVuc2lvbiA9IGV4dGVuc2lvbjtcbiAgICByZXR1cm4gdGhpc1trZXlfdHlwZV0ua2V5cztcbn07XG5tb2R1bGUuZXhwb3J0cyA9IENTTDtcbkNTTC5SZWdpc3RyeS5OYW1lUmVnID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgdmFyIHBrZXksIGlrZXksIHNrZXksIGZsb29yLCBjZWlsaW5nLCBkYWdvcHQsIGdkcm9wdCwgcmV0LCBwb3MsIGl0ZW1zLCBzdHJpcF9wZXJpb2RzLCBzZXRfa2V5cywgZXZhbG5hbWUsIGRlbGl0ZW1zLCBhZGRuYW1lLCBrZXksIG15aXRlbXMsIGksIGlsZW47XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xuICAgIHRoaXMubmFtZXJlZyA9IHt9O1xuICAgIHRoaXMubmFtZWluZCA9IHt9O1xuICAgIHRoaXMubmFtZWluZHBrZXlzID0ge307XG4gICAgdGhpcy5pdGVta2V5cmVnID0ge307XG4gICAgc3RyaXBfcGVyaW9kcyA9IGZ1bmN0aW9uIChzdHIpIHtcbiAgICAgICAgaWYgKCFzdHIpIHtcbiAgICAgICAgICAgIHN0ciA9IFwiXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9cXC4vZywgXCIgXCIpLnJlcGxhY2UoL1xccysvZywgXCIgXCIpLnJlcGxhY2UoL1xccyskLyxcIlwiKTtcbiAgICB9O1xuICAgIHNldF9rZXlzID0gZnVuY3Rpb24gKHN0YXRlLCBpdGVtaWQsIG5hbWVvYmopIHtcbiAgICAgICAgcGtleSA9IHN0cmlwX3BlcmlvZHMobmFtZW9iai5mYW1pbHkpO1xuICAgICAgICBza2V5ID0gc3RyaXBfcGVyaW9kcyhuYW1lb2JqLmdpdmVuKTtcbiAgICAgICAgdmFyIG0gPSBza2V5Lm1hdGNoKC9bLFxcIV0qIChbXixdKykkLyk7XG4gICAgICAgIGlmIChtICYmIG1bMV0gPT09IG1bMV0udG9Mb3dlckNhc2UoKSkge1xuICAgICAgICAgICAgc2tleSA9IHNrZXkucmVwbGFjZSgvWyxcXCFdKiBbXixdKyQvLCBcIlwiKTtcbiAgICAgICAgfVxuICAgICAgICBpa2V5ID0gQ1NMLlV0aWwuTmFtZXMuaW5pdGlhbGl6ZVdpdGgoc3RhdGUsIHNrZXksIFwiJXNcIik7XG4gICAgICAgIGlmIChzdGF0ZS5jaXRhdGlvbi5vcHRbXCJnaXZlbm5hbWUtZGlzYW1iaWd1YXRpb24tcnVsZVwiXSA9PT0gXCJieS1jaXRlXCIpIHtcbiAgICAgICAgICAgIHBrZXkgPSBcIlwiICsgaXRlbWlkICsgcGtleTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgZXZhbG5hbWUgPSBmdW5jdGlvbiAoaXRlbV9pZCwgbmFtZW9iaiwgbmFtZW51bSwgcmVxdWVzdF9iYXNlLCBmb3JtLCBpbml0aWFscykge1xuICAgICAgICB2YXIgcG9zLCBsZW4sIGl0ZW1zLCBwYXJhbTtcbiAgICAgICAgaWYgKHN0YXRlLnRtcC5hcmVhLnNsaWNlKDAsIDEyKSA9PT0gXCJiaWJsaW9ncmFwaHlcIiAmJiAhZm9ybSkge1xuICAgICAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBpbml0aWFscykge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgcmVzID0gc3RhdGUubmFtZU91dHB1dC5nZXROYW1lKG5hbWVvYmosIFwibG9jYWxlLXRyYW5zbGl0XCIsIHRydWUpO1xuICAgICAgICBuYW1lb2JqID0gcmVzLm5hbWU7XG4gICAgICAgIHNldF9rZXlzKHRoaXMuc3RhdGUsIFwiXCIgKyBpdGVtX2lkLCBuYW1lb2JqKTtcbiAgICAgICAgcGFyYW0gPSAyO1xuICAgICAgICBkYWdvcHQgPSBzdGF0ZS5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLWdpdmVubmFtZVwiXTtcbiAgICAgICAgZ2Ryb3B0ID0gc3RhdGUuY2l0YXRpb24ub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl07XG4gICAgICAgIHZhciBnZHJvcHRfb3JpZyA9IGdkcm9wdDtcbiAgICAgICAgaWYgKGdkcm9wdCA9PT0gXCJieS1jaXRlXCIpIHtcbiAgICAgICAgICAgIGdkcm9wdCA9IFwiYWxsLW5hbWVzXCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwic2hvcnRcIiA9PT0gZm9ybSkge1xuICAgICAgICAgICAgcGFyYW0gPSAwO1xuICAgICAgICB9IGVsc2UgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBpbml0aWFscykge1xuICAgICAgICAgICAgcGFyYW0gPSAxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5uYW1lcmVnW3BrZXldIHx8IFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XSkge1xuICAgICAgICAgICAgcmV0dXJuIHBhcmFtO1xuICAgICAgICB9XG4gICAgICAgIGlmIChnZHJvcHRfb3JpZyA9PT0gXCJieS1jaXRlXCIgJiYgcGFyYW0gPD0gcmVxdWVzdF9iYXNlKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVxdWVzdF9iYXNlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghZGFnb3B0KSB7XG4gICAgICAgICAgICByZXR1cm4gcGFyYW07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBnZHJvcHQgJiYgZ2Ryb3B0LnNsaWNlKDAsIDEyKSA9PT0gXCJwcmltYXJ5LW5hbWVcIiAmJiBuYW1lbnVtID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHBhcmFtO1xuICAgICAgICB9XG4gICAgICAgIGlmICghZ2Ryb3B0IHx8IGdkcm9wdCA9PT0gXCJhbGwtbmFtZXNcIiB8fCBnZHJvcHQgPT09IFwicHJpbWFyeS1uYW1lXCIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLm5hbWVyZWdbcGtleV0uY291bnQgPiAxKSB7XG4gICAgICAgICAgICAgICAgcGFyYW0gPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCh0aGlzLm5hbWVyZWdbcGtleV0uaWtleSBcbiAgICAgICAgICAgICAgICAgJiYgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uY291bnQgPiAxKVxuICAgICAgICAgICAgICAgIHx8ICh0aGlzLm5hbWVyZWdbcGtleV0uY291bnQgPiAxIFxuICAgICAgICAgICAgICAgICAgICAmJiBcInN0cmluZ1wiICE9PSB0eXBlb2YgaW5pdGlhbHMpKSB7XG4gICAgICAgICAgICAgICAgcGFyYW0gPSAyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGdkcm9wdCA9PT0gXCJhbGwtbmFtZXMtd2l0aC1pbml0aWFsc1wiIHx8IGdkcm9wdCA9PT0gXCJwcmltYXJ5LW5hbWUtd2l0aC1pbml0aWFsc1wiKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5uYW1lcmVnW3BrZXldLmNvdW50ID4gMSkge1xuICAgICAgICAgICAgICAgIHBhcmFtID0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGFyYW0gPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbaXRlbV9pZF0pIHtcbiAgICAgICAgICAgIGlmIChmb3JtID09IFwic2hvcnRcIikge1xuICAgICAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChcInN0cmluZ1wiID09IHR5cGVvZiBpbml0aWFscykge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHBhcmFtO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBkZWxpdGVtcyA9IGZ1bmN0aW9uIChpZHMpIHtcbiAgICAgICAgdmFyIGl0ZW0sIHBvcywgbGVuLCBwb3NBLCBwb3NCLCBpZCwgZnVsbGtleSwgbGxlbiwgcHBvcywgb3RoZXJpZDtcbiAgICAgICAgaWYgKFwic3RyaW5nXCIgPT09IHR5cGVvZiBpZHMgfHwgXCJudW1iZXJcIiA9PT0gdHlwZW9mIGlkcykge1xuICAgICAgICAgICAgaWRzID0gW1wiXCIgKyBpZHNdO1xuICAgICAgICB9XG4gICAgICAgIHZhciByZXQgPSB7fTtcbiAgICAgICAgbGVuID0gaWRzLmxlbmd0aDtcbiAgICAgICAgZm9yIChwb3MgPSAwOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgICAgICBpZCA9IFwiXCIgKyBpZHNbcG9zXTtcbiAgICAgICAgICAgIGlmICghdGhpcy5uYW1laW5kW2lkXSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yIChmdWxsa2V5IGluIHRoaXMubmFtZWluZFtpZF0pIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5uYW1laW5kW2lkXS5oYXNPd25Qcm9wZXJ0eShmdWxsa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gZnVsbGtleS5zcGxpdChcIjo6XCIpO1xuICAgICAgICAgICAgICAgICAgICBwa2V5ID0ga2V5WzBdO1xuICAgICAgICAgICAgICAgICAgICBpa2V5ID0ga2V5WzFdO1xuICAgICAgICAgICAgICAgICAgICBza2V5ID0ga2V5WzJdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMubmFtZXJlZ1twa2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaXRlbXMgPSB0aGlzLm5hbWVyZWdbcGtleV0uaXRlbXM7XG4gICAgICAgICAgICAgICAgICAgIGlmIChza2V5ICYmIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldICYmIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLnNrZXlbc2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG15aXRlbXMgPSB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5za2V5W3NrZXldLml0ZW1zO1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9zQiA9IG15aXRlbXMuaW5kZXhPZihcIlwiICsgaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc0IgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLnNrZXlbc2tleV0uaXRlbXMgPSBteWl0ZW1zLnNsaWNlKDAsIHBvc0IpLmNvbmNhdChteWl0ZW1zLnNsaWNlKFsocG9zQiArIDEpXSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLnNrZXlbc2tleV0uaXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLnNrZXlbc2tleV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uY291bnQgKz0gLTE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLmNvdW50IDwgMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLml0ZW1zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW3RoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLml0ZW1zW2ldXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGlrZXkgJiYgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvc0IgPSB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5pdGVtcy5pbmRleE9mKFwiXCIgKyBpZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zQiA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXMgPSB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5pdGVtcy5zbGljZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLml0ZW1zID0gaXRlbXMuc2xpY2UoMCwgcG9zQikuY29uY2F0KGl0ZW1zLnNsaWNlKFtwb3NCICsgMV0pKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5pdGVtcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmNvdW50ICs9IC0xO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm5hbWVyZWdbcGtleV0uY291bnQgPCAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5uYW1lcmVnW3BrZXldLml0ZW1zLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW3RoaXMubmFtZXJlZ1twa2V5XS5pdGVtc1tpXV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChwa2V5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwb3NCID0gdGhpcy5uYW1lcmVnW3BrZXldLml0ZW1zLmluZGV4T2YoXCJcIiArIGlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3NCID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IHRoaXMubmFtZXJlZ1twa2V5XS5pdGVtcy5zbGljZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5pdGVtcyA9IGl0ZW1zLnNsaWNlKDAsIHBvc0IpLmNvbmNhdChpdGVtcy5zbGljZShbcG9zQiArIDFdLCBpdGVtcy5sZW5ndGgpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm5hbWVyZWdbcGtleV0uaXRlbXMubGVuZ3RoIDwgMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5hbWVyZWdbcGtleV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubmFtZWluZFtpZF1bZnVsbGtleV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGVsZXRlIHRoaXMubmFtZWluZFtpZF07XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5uYW1laW5kcGtleXNbaWRdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcbiAgICBhZGRuYW1lID0gZnVuY3Rpb24gKGl0ZW1faWQsIG5hbWVvYmosIHBvcykge1xuICAgICAgICB2YXIgaSwgaWxlbjtcbiAgICAgICAgdmFyIHJlcyA9IHN0YXRlLm5hbWVPdXRwdXQuZ2V0TmFtZShuYW1lb2JqLCBcImxvY2FsZS10cmFuc2xpdFwiLCB0cnVlKTtcbiAgICAgICAgbmFtZW9iaiA9IHJlcy5uYW1lO1xuICAgICAgICBpZiAoc3RhdGUuY2l0YXRpb24ub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl1cbiAgICAgICAgICAgICYmIHN0YXRlLmNpdGF0aW9uLm9wdFtcImdpdmVubmFtZS1kaXNhbWJpZ3VhdGlvbi1ydWxlXCJdLnNsaWNlKDAsIDgpID09PSBcInByaW1hcnktXCJcbiAgICAgICAgICAgICYmIHBvcyAhPT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBzZXRfa2V5cyh0aGlzLnN0YXRlLCBcIlwiICsgaXRlbV9pZCwgbmFtZW9iaik7XG4gICAgICAgIGlmIChwa2V5KSB7XG4gICAgICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiA9PT0gdHlwZW9mIHRoaXMubmFtZXJlZ1twa2V5XSkge1xuICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XSA9IHt9O1xuICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5jb3VudCA9IDA7XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXkgPSB7fTtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uaXRlbXMgPSBbaXRlbV9pZF07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMubmFtZXJlZ1twa2V5XS5pdGVtcy5pbmRleE9mKGl0ZW1faWQpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5pdGVtcy5wdXNoKGl0ZW1faWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChwa2V5ICYmIGlrZXkpIHtcbiAgICAgICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XSA9IHt9O1xuICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLmNvdW50ID0gMDtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5za2V5ID0ge307XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uaXRlbXMgPSBbaXRlbV9pZF07XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmNvdW50ICs9IDE7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubmFtZXJlZ1twa2V5XS5jb3VudCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMubmFtZXJlZ1twa2V5XS5pdGVtcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC50YWludGVkSXRlbUlEc1t0aGlzLm5hbWVyZWdbcGtleV0uaXRlbXNbaV1dID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uaXRlbXMuaW5kZXhPZihpdGVtX2lkKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5pdGVtcy5wdXNoKGl0ZW1faWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChwa2V5ICYmIGlrZXkgJiYgc2tleSkge1xuICAgICAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgPT09IHR5cGVvZiB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5za2V5W3NrZXldKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uc2tleVtza2V5XSA9IHt9O1xuICAgICAgICAgICAgICAgIHRoaXMubmFtZXJlZ1twa2V5XS5pa2V5W2lrZXldLnNrZXlbc2tleV0uaXRlbXMgPSBbaXRlbV9pZF07XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uY291bnQgKz0gMTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uY291bnQgPT09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5pdGVtcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnRtcC50YWludGVkSXRlbUlEc1t0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5pdGVtc1tpXV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLm5hbWVyZWdbcGtleV0uaWtleVtpa2V5XS5za2V5W3NrZXldLml0ZW1zLmluZGV4T2YoaXRlbV9pZCkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uYW1lcmVnW3BrZXldLmlrZXlbaWtleV0uc2tleVtza2V5XS5pdGVtcy5wdXNoKGl0ZW1faWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5uYW1laW5kW2l0ZW1faWRdKSB7XG4gICAgICAgICAgICB0aGlzLm5hbWVpbmRbaXRlbV9pZF0gPSB7fTtcbiAgICAgICAgICAgIHRoaXMubmFtZWluZHBrZXlzW2l0ZW1faWRdID0ge307XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBrZXkpIHtcbiAgICAgICAgICAgIHRoaXMubmFtZWluZFtpdGVtX2lkXVtwa2V5ICsgXCI6OlwiICsgaWtleSArIFwiOjpcIiArIHNrZXldID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMubmFtZWluZHBrZXlzW2l0ZW1faWRdW3BrZXldID0gdGhpcy5uYW1lcmVnW3BrZXldO1xuICAgICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmFkZG5hbWUgPSBhZGRuYW1lO1xuICAgIHRoaXMuZGVsaXRlbXMgPSBkZWxpdGVtcztcbiAgICB0aGlzLmV2YWxuYW1lID0gZXZhbG5hbWU7XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuUmVnaXN0cnkuQ2l0YXRpb25SZWcgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICB0aGlzLmNpdGF0aW9uQnlJZCA9IHt9O1xuICAgIHRoaXMuY2l0YXRpb25CeUluZGV4ID0gW107XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuRGlzYW1iaWd1YXRpb24gPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICB0aGlzLnN0YXRlID0gc3RhdGU7XG4gICAgdGhpcy5zeXMgPSB0aGlzLnN0YXRlLnN5cztcbiAgICB0aGlzLnJlZ2lzdHJ5ID0gc3RhdGUucmVnaXN0cnkucmVnaXN0cnk7XG4gICAgdGhpcy5hbWJpZ2NpdGVzID0gc3RhdGUucmVnaXN0cnkuYW1iaWdjaXRlcztcbiAgICB0aGlzLmNvbmZpZ01vZGVzKCk7XG4gICAgdGhpcy5kZWJ1ZyA9IGZhbHNlO1xufTtcbkNTTC5EaXNhbWJpZ3VhdGlvbi5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24oYWtleSkge1xuICAgIGlmICghdGhpcy5tb2Rlcy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmFrZXkgPSBha2V5O1xuICAgIGlmICh0aGlzLmluaXRWYXJzKGFrZXkpKSB7XG4gICAgICAgIHRoaXMucnVuRGlzYW1iaWcoKTtcbiAgICB9XG59O1xuQ1NMLkRpc2FtYmlndWF0aW9uLnByb3RvdHlwZS5ydW5EaXNhbWJpZyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcG9zLCBsZW4sIHBwb3MsIGxsZW4sIHBwcG9zLCBsbGxlbiwgaXNtYXg7XG4gICAgdGhpcy5pbml0R2l2ZW5zID0gdHJ1ZTtcbiAgICB3aGlsZSAodGhpcy5saXN0cy5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5nbmFtZXNldCA9IDA7XG4gICAgICAgIHRoaXMuZ25hbWUgPSAwO1xuICAgICAgICB0aGlzLmNsYXNoZXMgPSBbMSwgMF07XG4gICAgICAgIHdoaWxlKHRoaXMubGlzdHNbMF1bMV0ubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmxpc3Rwb3MgPSAwO1xuICAgICAgICAgICAgaWYgKCF0aGlzLmJhc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2UgPSB0aGlzLmxpc3RzWzBdWzBdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG5hbWVzX3VzZWQgPSBbXTtcbiAgICAgICAgICAgIGlzbWF4ID0gdGhpcy5pbmNyZW1lbnREaXNhbWJpZygpO1xuICAgICAgICAgICAgdGhpcy5zY2FuSXRlbXModGhpcy5saXN0c1swXSk7XG4gICAgICAgICAgICB0aGlzLmV2YWxTY2FuKGlzbWF4KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxpc3RzID0gdGhpcy5saXN0cy5zbGljZSgxKTtcbiAgICB9XG59O1xuQ1NMLkRpc2FtYmlndWF0aW9uLnByb3RvdHlwZS5zY2FuSXRlbXMgPSBmdW5jdGlvbiAobGlzdCkge1xuICAgIHZhciBwb3MsIGxlbiwgSXRlbSwgb3RoZXJJdGVtLCBJdGVtQ2l0ZSwgaWdub3JlLCBiYXNlO1xuICAgIHRoaXMuSXRlbSA9IGxpc3RbMV1bMF07XG4gICAgdGhpcy5JdGVtQ2l0ZSA9IENTTC5nZXRBbWJpZ3VvdXNDaXRlLmNhbGwodGhpcy5zdGF0ZSwgdGhpcy5JdGVtLCB0aGlzLmJhc2UsIHRydWUpO1xuICAgIHRoaXMuc2Nhbmxpc3QgPSBsaXN0WzFdO1xuICAgIHRoaXMucGFydG5lcnMgPSBbXTtcbiAgICB0aGlzLnBhcnRuZXJzLnB1c2godGhpcy5JdGVtKTtcbiAgICB0aGlzLm5vbnBhcnRuZXJzID0gW107XG4gICAgdmFyIGNsYXNoZXMgPSAwO1xuICAgIGZvciAodmFyIHBvcyA9IDEsIGxlbiA9IGxpc3RbMV0ubGVuZ3RoOyBwb3MgPCBsZW47IHBvcyArPSAxKSB7XG4gICAgICAgIG90aGVySXRlbSA9IGxpc3RbMV1bcG9zXTtcbiAgICAgICAgdmFyIG90aGVySXRlbUNpdGUgPSBDU0wuZ2V0QW1iaWd1b3VzQ2l0ZS5jYWxsKHRoaXMuc3RhdGUsIG90aGVySXRlbSwgdGhpcy5iYXNlLCB0cnVlKTtcbiAgICAgICAgaWYgKHRoaXMuSXRlbUNpdGUgPT09IG90aGVySXRlbUNpdGUpIHtcbiAgICAgICAgICAgIGNsYXNoZXMgKz0gMTtcbiAgICAgICAgICAgIHRoaXMucGFydG5lcnMucHVzaChvdGhlckl0ZW0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ub25wYXJ0bmVycy5wdXNoKG90aGVySXRlbSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5jbGFzaGVzWzBdID0gdGhpcy5jbGFzaGVzWzFdO1xuICAgIHRoaXMuY2xhc2hlc1sxXSA9IGNsYXNoZXM7XG59O1xuQ1NMLkRpc2FtYmlndWF0aW9uLnByb3RvdHlwZS5ldmFsU2NhbiA9IGZ1bmN0aW9uIChtYXhlZCkge1xuICAgIHRoaXNbdGhpcy5tb2Rlc1t0aGlzLm1vZGVpbmRleF1dKG1heGVkKTtcbiAgICBpZiAobWF4ZWQpIHtcbiAgICAgICAgaWYgKHRoaXMubW9kZWluZGV4IDwgdGhpcy5tb2Rlcy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICB0aGlzLm1vZGVpbmRleCArPSAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3MgKyAxXSA9IFt0aGlzLmJhc2UsIFtdXTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLmRpc05hbWVzID0gZnVuY3Rpb24gKGlzbWF4KSB7XG4gICAgdmFyIHBvcywgbGVuLCBteWJhc2UsIGksIGlsZW47XG4gICAgaWYgKHRoaXMuY2xhc2hlc1sxXSA9PT0gMCAmJiB0aGlzLm5vbnBhcnRuZXJzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICB0aGlzLmNhcHR1cmVTdGVwVG9CYXNlKCk7XG4gICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0ZXJBbWJpZ1Rva2VuKHRoaXMuYWtleSwgXCJcIiArIHRoaXMubm9ucGFydG5lcnNbMF0uaWQsIHRoaXMuYmV0dGVyYmFzZSk7XG4gICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0ZXJBbWJpZ1Rva2VuKHRoaXMuYWtleSwgXCJcIiArIHRoaXMucGFydG5lcnNbMF0uaWQsIHRoaXMuYmV0dGVyYmFzZSk7XG4gICAgICAgIHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXSA9IFt0aGlzLmJldHRlcmJhc2UsIFtdXTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuY2xhc2hlc1sxXSA9PT0gMCkge1xuICAgICAgICB0aGlzLmNhcHR1cmVTdGVwVG9CYXNlKCk7XG4gICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0ZXJBbWJpZ1Rva2VuKHRoaXMuYWtleSwgXCJcIiArIHRoaXMucGFydG5lcnNbMF0uaWQsIHRoaXMuYmV0dGVyYmFzZSk7XG4gICAgICAgIHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXSA9IFt0aGlzLmJldHRlcmJhc2UsIHRoaXMubm9ucGFydG5lcnNdO1xuICAgICAgICBpZiAodGhpcy5ub25wYXJ0bmVycy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdEdpdmVucyA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHRoaXMubm9ucGFydG5lcnMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHRoaXMuY2FwdHVyZVN0ZXBUb0Jhc2UoKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RlckFtYmlnVG9rZW4odGhpcy5ha2V5LCBcIlwiICsgdGhpcy5ub25wYXJ0bmVyc1swXS5pZCwgdGhpcy5iZXR0ZXJiYXNlKTtcbiAgICAgICAgdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdID0gW3RoaXMuYmV0dGVyYmFzZSwgdGhpcy5wYXJ0bmVyc107XG4gICAgfSBlbHNlIGlmICh0aGlzLmNsYXNoZXNbMV0gPCB0aGlzLmNsYXNoZXNbMF0pIHtcbiAgICAgICAgdGhpcy5jYXB0dXJlU3RlcFRvQmFzZSgpO1xuICAgICAgICB0aGlzLmxpc3RzW3RoaXMubGlzdHBvc10gPSBbdGhpcy5iZXR0ZXJiYXNlLCB0aGlzLnBhcnRuZXJzXTtcbiAgICAgICAgdGhpcy5saXN0cy5wdXNoKFt0aGlzLmJldHRlcmJhc2UsIHRoaXMubm9ucGFydG5lcnNdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoaXNtYXgpIHtcbiAgICAgICAgICAgIHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXSA9IFt0aGlzLmJldHRlcmJhc2UsIHRoaXMubm9ucGFydG5lcnNdO1xuICAgICAgICAgICAgdGhpcy5saXN0cy5wdXNoKFt0aGlzLmJldHRlcmJhc2UsIHRoaXMucGFydG5lcnNdKTtcbiAgICAgICAgICAgIGlmICh0aGlzLm1vZGVpbmRleCA9PT0gdGhpcy5tb2Rlcy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLnBhcnRuZXJzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdGVyQW1iaWdUb2tlbih0aGlzLmFrZXksIFwiXCIgKyB0aGlzLnBhcnRuZXJzW2ldLmlkLCB0aGlzLmJldHRlcmJhc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmxpc3RzW3RoaXMubGlzdHBvc10gPSBbdGhpcy5iZXR0ZXJiYXNlLCBbXV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLkRpc2FtYmlndWF0aW9uLnByb3RvdHlwZS5kaXNFeHRyYVRleHQgPSBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHBvcywgbGVuLCBteWJhc2U7XG4gICAgdmFyIGRvbmUgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5jbGFzaGVzWzFdID09PSAwICYmIHRoaXMubm9ucGFydG5lcnMubGVuZ3RoIDwgMikge1xuICAgICAgICBkb25lID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKCFkb25lICYmICghdGhpcy5iYXNlLmRpc2FtYmlndWF0ZSB8fCB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ3VhdGVfY291bnQgIT09IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlndWF0ZV9tYXhNYXgpKSB7XG4gICAgICAgIHRoaXMubW9kZWluZGV4ID0gMDtcbiAgICAgICAgdGhpcy5iYXNlLmRpc2FtYmlndWF0ZSA9IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlndWF0ZV9jb3VudDtcbiAgICAgICAgdGhpcy5iZXR0ZXJiYXNlLmRpc2FtYmlndWF0ZSA9IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlndWF0ZV9jb3VudDtcbiAgICAgICAgaWYgKCF0aGlzLmJhc2UuZGlzYW1iaWd1YXRlKSB7XG4gICAgICAgICAgICB0aGlzLmluaXRHaXZlbnMgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5iYXNlLmRpc2FtYmlndWF0ZSA9IDE7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXVsxXS5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC50YWludGVkSXRlbUlEc1t0aGlzLmxpc3RzW3RoaXMubGlzdHBvc11bMV1baV0uaWRdID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZGlzTmFtZXMoKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZG9uZSB8fCB0aGlzLnN0YXRlLnRtcC5kaXNhbWJpZ3VhdGVfY291bnQgPT09IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlndWF0ZV9tYXhNYXgpIHtcbiAgICAgICAgaWYgKGRvbmUgfHwgdGhpcy5tb2RlaW5kZXggPT09IHRoaXMubW9kZXMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgdmFyIGJhc2UgPSB0aGlzLmxpc3RzW3RoaXMubGlzdHBvc11bMF07XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXVsxXS5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnRtcC50YWludGVkSXRlbUlEc1t0aGlzLmxpc3RzW3RoaXMubGlzdHBvc11bMV1baV0uaWRdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdGVyQW1iaWdUb2tlbih0aGlzLmFrZXksIFwiXCIgKyB0aGlzLmxpc3RzW3RoaXMubGlzdHBvc11bMV1baV0uaWQsIGJhc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdID0gW3RoaXMuYmV0dGVyYmFzZSwgW11dO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5tb2RlaW5kZXggPSB0aGlzLm1vZGVzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICB2YXIgYmFzZSA9IHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXVswXTtcbiAgICAgICAgICAgIGJhc2UuZGlzYW1iaWd1YXRlID0gdHJ1ZTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdWzFdLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUudG1wLnRhaW50ZWRJdGVtSURzW3RoaXMubGlzdHNbdGhpcy5saXN0cG9zXVsxXVtpXS5pZF0gPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0ZXJBbWJpZ1Rva2VuKHRoaXMuYWtleSwgXCJcIiArIHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXVsxXVtpXS5pZCwgYmFzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuQ1NMLkRpc2FtYmlndWF0aW9uLnByb3RvdHlwZS5kaXNZZWFycyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcG9zLCBsZW4sIHRva2VucywgdG9rZW4sIGl0ZW07XG4gICAgdG9rZW5zID0gW107XG4gICAgdmFyIGJhc2UgPSB0aGlzLmxpc3RzW3RoaXMubGlzdHBvc11bMF07XG4gICAgaWYgKHRoaXMuY2xhc2hlc1sxXSkge1xuXHRcdGZvciAodmFyIGkgPSAwLCBpbGVuID0gdGhpcy5zdGF0ZS5yZWdpc3RyeS5teWxpc3QubGVuZ3RoOyBpIDwgaWxlbjsgaSArPSAxKSB7XG5cdFx0XHR2YXIgb3JpZ2lkID0gdGhpcy5zdGF0ZS5yZWdpc3RyeS5teWxpc3RbaV07XG5cdFx0XHRmb3IgKHZhciBqID0gMCwgamxlbiA9IHRoaXMubGlzdHNbdGhpcy5saXN0cG9zXVsxXS5sZW5ndGg7IGogPCBqbGVuOyBqICs9IDEpIHtcblx0XHRcdFx0dmFyIHRva2VuID0gdGhpcy5saXN0c1t0aGlzLmxpc3Rwb3NdWzFdW2pdO1xuXHRcdFx0XHRpZiAodG9rZW4uaWQgPT0gb3JpZ2lkKSB7XG5cdFx0XHRcdFx0dG9rZW5zLnB1c2godGhpcy5yZWdpc3RyeVt0b2tlbi5pZF0pO1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuICAgIH1cbiAgICB0b2tlbnMuc29ydCh0aGlzLnN0YXRlLnJlZ2lzdHJ5LnNvcnRlci5jb21wYXJlS2V5cyk7XG4gICAgZm9yICh2YXIgcG9zID0gMCwgbGVuID0gdG9rZW5zLmxlbmd0aDsgcG9zIDwgbGVuOyBwb3MgKz0gMSkge1xuICAgICAgICBiYXNlLnllYXJfc3VmZml4ID0gXCJcIitwb3M7XG4gICAgICAgIHZhciBvbGRCYXNlID0gdGhpcy5zdGF0ZS5yZWdpc3RyeS5yZWdpc3RyeVt0b2tlbnNbcG9zXS5pZF0uZGlzYW1iaWc7XG4gICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0ZXJBbWJpZ1Rva2VuKHRoaXMuYWtleSwgXCJcIiArIHRva2Vuc1twb3NdLmlkLCBiYXNlKTtcbiAgICAgICAgaWYgKENTTC5hbWJpZ0NvbmZpZ0RpZmYob2xkQmFzZSxiYXNlKSkge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS50bXAudGFpbnRlZEl0ZW1JRHNbdG9rZW5zW3Bvc10uaWRdID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmxpc3RzW3RoaXMubGlzdHBvc10gPSBbdGhpcy5iZXR0ZXJiYXNlLCBbXV07XG59O1xuQ1NMLkRpc2FtYmlndWF0aW9uLnByb3RvdHlwZS5pbmNyZW1lbnREaXNhbWJpZyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgdmFsO1xuICAgIGlmICh0aGlzLmluaXRHaXZlbnMpIHtcbiAgICAgICAgdGhpcy5pbml0R2l2ZW5zID0gZmFsc2U7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdmFyIG1heGVkID0gZmFsc2U7XG4gICAgdmFyIGluY3JlbWVudF9uYW1lcyA9IHRydWU7XG4gICAgdmFyIGluY3JlbWVudF9naXZlbnMgPSB0cnVlO1xuICAgIGlmIChcImRpc05hbWVzXCIgPT09IHRoaXMubW9kZXNbdGhpcy5tb2RlaW5kZXhdKSB7XG4gICAgICAgIGluY3JlbWVudF9uYW1lcyA9IGZhbHNlO1xuICAgICAgICBpZiAoXCJudW1iZXJcIiAhPT0gdHlwZW9mIHRoaXMuZ2l2ZW5zTWF4KSB7XG4gICAgICAgICAgICBpbmNyZW1lbnRfbmFtZXMgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHZhciBpbmNyZW1lbnRfbmFtZXNldHMgPSBmYWxzZTtcbiAgICAgICAgaWYgKFwibnVtYmVyXCIgIT09IHR5cGVvZiB0aGlzLm5hbWVzTWF4KSB7XG4gICAgICAgICAgICBpbmNyZW1lbnRfbmFtZXNldHMgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChcIm51bWJlclwiID09PSB0eXBlb2YgdGhpcy5naXZlbnNNYXgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmJhc2UuZ2l2ZW5zLmxlbmd0aCAmJiB0aGlzLmJhc2UuZ2l2ZW5zW3RoaXMuZ25hbWVzZXRdW3RoaXMuZ25hbWVdIDwgdGhpcy5naXZlbnNNYXgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2UuZ2l2ZW5zW3RoaXMuZ25hbWVzZXRdW3RoaXMuZ25hbWVdICs9IDE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGluY3JlbWVudF9uYW1lcyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwibnVtYmVyXCIgPT09IHR5cGVvZiB0aGlzLm5hbWVzTWF4IFxuICAgICAgICAgICAgJiYgaW5jcmVtZW50X25hbWVzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5vcHRbXCJkaXNhbWJpZ3VhdGUtYWRkLW5hbWVzXCJdKSB7XG4gICAgICAgICAgICAgICAgaW5jcmVtZW50X25hbWVzZXRzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZ25hbWUgPCB0aGlzLm5hbWVzTWF4KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZS5uYW1lc1t0aGlzLmduYW1lc2V0XSArPSAxO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmduYW1lICs9IDE7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaW5jcmVtZW50X25hbWVzZXRzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGluY3JlbWVudF9uYW1lc2V0cyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFwibnVtYmVyXCIgPT09IHR5cGVvZiB0aGlzLm5hbWVzZXRzTWF4ICYmIGluY3JlbWVudF9uYW1lc2V0cykge1xuICAgICAgICAgICAgaWYgKHRoaXMuZ25hbWVzZXQgPCB0aGlzLm5hbWVzZXRzTWF4KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5nbmFtZXNldCArPSAxO1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzZS5uYW1lc1t0aGlzLmduYW1lc2V0XSA9IDE7XG4gICAgICAgICAgICAgICAgdGhpcy5nbmFtZSA9IDA7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBpbmNyZW1lbnRfbW9kZSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKChcIm51bWJlclwiICE9PSB0eXBlb2YgdGhpcy5uYW1lc2V0c01heCB8fCB0aGlzLm5hbWVzZXRzTWF4ID09PSAtMSB8fCB0aGlzLmduYW1lc2V0ID09PSB0aGlzLm5hbWVzZXRzTWF4KVxuICAgICAgICAgICAgJiYgKCF0aGlzLnN0YXRlLm9wdFtcImRpc2FtYmlndWF0ZS1hZGQtbmFtZXNcIl0gfHwgXCJudW1iZXJcIiAhPT0gdHlwZW9mIHRoaXMubmFtZXNNYXggfHwgdGhpcy5nbmFtZSA9PT0gdGhpcy5uYW1lc01heClcbiAgICAgICAgICAgICYmIChcIm51bWJlclwiICE9IHR5cGVvZiB0aGlzLmdpdmVuc01heCB8fCBcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5iYXNlLmdpdmVuc1t0aGlzLmduYW1lc2V0XSB8fCBcInVuZGVmaW5lZFwiID09PSB0eXBlb2YgdGhpcy5iYXNlLmdpdmVuc1t0aGlzLmduYW1lc2V0XVt0aGlzLmduYW1lXSB8fCB0aGlzLmJhc2UuZ2l2ZW5zW3RoaXMuZ25hbWVzZXRdW3RoaXMuZ25hbWVdID09PSB0aGlzLmdpdmVuc01heCkpIHtcbiAgICAgICAgICAgIG1heGVkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSBpZiAoXCJkaXNFeHRyYVRleHRcIiA9PT0gdGhpcy5tb2Rlc1t0aGlzLm1vZGVpbmRleF0pIHtcbiAgICAgICAgdGhpcy5iYXNlLmRpc2FtYmlndWF0ZSArPSAxO1xuICAgICAgICB0aGlzLmJldHRlcmJhc2UuZGlzYW1iaWd1YXRlICs9IDE7XG4gICAgfVxuICAgIHJldHVybiBtYXhlZDtcbn07XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLmluaXRWYXJzID0gZnVuY3Rpb24gKGFrZXkpIHtcbiAgICB2YXIgaSwgaWxlbiwgbXlJZHMsIG15SXRlbUJ1bmRsZXMsIG15SXRlbXM7XG4gICAgdGhpcy5saXN0cyA9IFtdO1xuICAgIHRoaXMuYmFzZSA9IGZhbHNlO1xuICAgIHRoaXMuYmV0dGVyYmFzZSA9IGZhbHNlO1xuICAgIHRoaXMuYWtleSA9IGFrZXk7XG4gICAgdGhpcy5tYXhOYW1lc0J5SXRlbUlkID0ge307XG4gICAgbXlJdGVtQnVuZGxlcyA9IFtdO1xuICAgIG15SWRzID0gdGhpcy5hbWJpZ2NpdGVzW2FrZXldO1xuICAgIGlmICghbXlJZHMgfHwgIW15SWRzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHZhciBJdGVtID0gZmFsc2U7XG4gICAgdmFyIG15SXRlbSA9IHRoaXMuc3RhdGUucmV0cmlldmVJdGVtKFwiXCIgKyBteUlkc1swXSk7XG4gICAgdGhpcy5nZXRDaXRlRGF0YShteUl0ZW0pO1xuICAgIHRoaXMuYmFzZSA9IENTTC5nZXRBbWJpZ0NvbmZpZy5jYWxsKHRoaXMuc3RhdGUpO1xuICAgIGlmIChteUlkcyAmJiBteUlkcy5sZW5ndGggPiAxKSB7XG4gICAgICAgIG15SXRlbUJ1bmRsZXMucHVzaChbdGhpcy5tYXhOYW1lc0J5SXRlbUlkW215SXRlbS5pZF0sIG15SXRlbV0pO1xuICAgICAgICBmb3IgKHZhciBpID0gMSwgaWxlbiA9IG15SWRzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgbXlJdGVtID0gdGhpcy5zdGF0ZS5yZXRyaWV2ZUl0ZW0oXCJcIiArIG15SWRzW2ldKTtcbiAgICAgICAgICAgIHRoaXMuZ2V0Q2l0ZURhdGEobXlJdGVtLCB0aGlzLmJhc2UpO1xuICAgICAgICAgICAgbXlJdGVtQnVuZGxlcy5wdXNoKFt0aGlzLm1heE5hbWVzQnlJdGVtSWRbbXlJdGVtLmlkXSwgbXlJdGVtXSk7XG4gICAgICAgIH1cbiAgICAgICAgbXlJdGVtQnVuZGxlcy5zb3J0KFxuICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHtcbiAgICAgICAgICAgICAgICBpZiAoYVswXSA+IGJbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhWzBdIDwgYlswXSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFbMV0uaWQgPiBiWzFdLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhWzFdLmlkIDwgYlsxXS5pZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICAgIG15SXRlbXMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBteUl0ZW1CdW5kbGVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgbXlJdGVtcy5wdXNoKG15SXRlbUJ1bmRsZXNbaV1bMV0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubGlzdHMucHVzaChbdGhpcy5iYXNlLCBteUl0ZW1zXSk7XG4gICAgICAgIHRoaXMuSXRlbSA9IHRoaXMubGlzdHNbMF1bMV1bMF07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5JdGVtID0gdGhpcy5zdGF0ZS5yZXRyaWV2ZUl0ZW0oXCJcIiArIG15SWRzWzBdKTtcbiAgICB9XG4gICAgdGhpcy5tb2RlaW5kZXggPSAwO1xuICAgIGlmICh0aGlzLnN0YXRlLmNpdGF0aW9uLm9wdFtcImRpc2FtYmlndWF0ZS1hZGQtbmFtZXNcIl0gfHwgdHJ1ZSkge1xuICAgICAgICB0aGlzLm5hbWVzTWF4ID0gdGhpcy5tYXhOYW1lc0J5SXRlbUlkW3RoaXMuSXRlbS5pZF1bMF07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIG5hbWVzTWF4ID0gdGhpcy5iYXNlLm5hbWVzWzBdO1xuICAgICAgICBmb3IgKHZhciBpPTEsaWxlbj10aGlzLmJhc2UubmFtZXMubGVuZ3RoO2k8aWxlbjtpKz0xKXtcbiAgICAgICAgICAgIG5hbWVzTWF4ID0gTWF0aC5tYXgobmFtZXNNYXgsdGhpcy5iYXNlLm5hbWVzLm5hbWVzW2ldKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnBhZEJhc2UodGhpcy5iYXNlKTtcbiAgICB0aGlzLnBhZEJhc2UodGhpcy5iZXR0ZXJiYXNlKTtcbiAgICB0aGlzLmJhc2UueWVhcl9zdWZmaXggPSBmYWxzZTtcbiAgICB0aGlzLmJhc2UuZGlzYW1iaWd1YXRlID0gZmFsc2U7XG4gICAgdGhpcy5iZXR0ZXJiYXNlLnllYXJfc3VmZml4ID0gZmFsc2U7XG4gICAgdGhpcy5iZXR0ZXJiYXNlLmRpc2FtYmlndWF0ZSA9IGZhbHNlO1xuICAgIGlmICh0aGlzLnN0YXRlLmNpdGF0aW9uLm9wdFtcImdpdmVubmFtZS1kaXNhbWJpZ3VhdGlvbi1ydWxlXCJdID09PSBcImJ5LWNpdGVcIlxuICAgICAgICYmIHRoaXMuc3RhdGUub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC1naXZlbm5hbWVcIl0pIHtcbiAgICAgICAgdGhpcy5naXZlbnNNYXggPSAyO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn07XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLnBhZEJhc2UgPSBmdW5jdGlvbiAoYmFzZSkge1xuICAgIGZvciAodmFyIGkgPSAwLCBpbGVuID0gYmFzZS5uYW1lcy5sZW5ndGg7IGkgPCBpbGVuOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKCFiYXNlLmdpdmVuc1tpXSkge1xuICAgICAgICAgICAgYmFzZS5naXZlbnNbaV0gPSBbXTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBqPTAsamxlbj1iYXNlLm5hbWVzW2ldO2o8amxlbjtqKz0xKSB7XG4gICAgICAgICAgICBpZiAoIWJhc2UuZ2l2ZW5zW2ldW2pdKSB7XG4gICAgICAgICAgICAgICAgYmFzZS5naXZlbnNbaV1bal0gPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuQ1NMLkRpc2FtYmlndWF0aW9uLnByb3RvdHlwZS5jb25maWdNb2RlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgZGFnb3B0LCBnZHJvcHQ7XG4gICAgdGhpcy5tb2RlcyA9IFtdO1xuICAgIGRhZ29wdCA9IHRoaXMuc3RhdGUub3B0W1wiZGlzYW1iaWd1YXRlLWFkZC1naXZlbm5hbWVcIl07XG4gICAgZ2Ryb3B0ID0gdGhpcy5zdGF0ZS5jaXRhdGlvbi5vcHRbXCJnaXZlbm5hbWUtZGlzYW1iaWd1YXRpb24tcnVsZVwiXTtcbiAgICBpZiAodGhpcy5zdGF0ZS5vcHRbJ2Rpc2FtYmlndWF0ZS1hZGQtbmFtZXMnXSB8fCAoZGFnb3B0ICYmIGdkcm9wdCA9PT0gXCJieS1jaXRlXCIpKSB7XG4gICAgICAgIHRoaXMubW9kZXMucHVzaChcImRpc05hbWVzXCIpO1xuICAgIH1cbiAgICBpZiAodGhpcy5zdGF0ZS5vcHQuaGFzX2Rpc2FtYmlndWF0ZSkge1xuICAgICAgICB0aGlzLm1vZGVzLnB1c2goXCJkaXNFeHRyYVRleHRcIik7XG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXRlLm9wdFtcImRpc2FtYmlndWF0ZS1hZGQteWVhci1zdWZmaXhcIl0pIHtcbiAgICAgICAgdGhpcy5tb2Rlcy5wdXNoKFwiZGlzWWVhcnNcIik7XG4gICAgfVxufTtcbkNTTC5EaXNhbWJpZ3VhdGlvbi5wcm90b3R5cGUuZ2V0Q2l0ZURhdGEgPSBmdW5jdGlvbihJdGVtLCBiYXNlKSB7XG4gICAgaWYgKCF0aGlzLm1heE5hbWVzQnlJdGVtSWRbSXRlbS5pZF0pIHtcbiAgICAgICAgQ1NMLmdldEFtYmlndW91c0NpdGUuY2FsbCh0aGlzLnN0YXRlLCBJdGVtLCBiYXNlKTtcbiAgICAgICAgYmFzZSA9IENTTC5nZXRBbWJpZ0NvbmZpZy5jYWxsKHRoaXMuc3RhdGUpO1xuICAgICAgICB0aGlzLm1heE5hbWVzQnlJdGVtSWRbSXRlbS5pZF0gPSBDU0wuZ2V0TWF4VmFscy5jYWxsKHRoaXMuc3RhdGUpO1xuICAgICAgICB0aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLmdpdmVucyA9IHRoaXMuc3RhdGUudG1wLmRpc2FtYmlnX3NldHRpbmdzLmdpdmVucy5zbGljZSgpO1xuICAgICAgICBmb3IgKHZhciBpPTAsaWxlbj10aGlzLnN0YXRlLnJlZ2lzdHJ5LnJlZ2lzdHJ5W0l0ZW0uaWRdLmRpc2FtYmlnLmdpdmVucy5sZW5ndGg7aTxpbGVuO2krPTEpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcuZ2l2ZW5zW2ldID0gdGhpcy5zdGF0ZS50bXAuZGlzYW1iaWdfc2V0dGluZ3MuZ2l2ZW5zW2ldLnNsaWNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5uYW1lc2V0c01heCA9IHRoaXMuc3RhdGUucmVnaXN0cnkucmVnaXN0cnlbSXRlbS5pZF0uZGlzYW1iaWcubmFtZXMubGVuZ3RoIC0gMTtcbiAgICAgICAgaWYgKCF0aGlzLmJhc2UpIHtcbiAgICAgICAgICAgIHRoaXMuYmFzZSA9IGJhc2U7XG4gICAgICAgICAgICB0aGlzLmJldHRlcmJhc2UgPSBDU0wuY2xvbmVBbWJpZ0NvbmZpZyhiYXNlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYmFzZS5uYW1lcy5sZW5ndGggPCB0aGlzLmJhc2UubmFtZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmJhc2UgPSBiYXNlO1xuICAgICAgICB9XG4gICAgICAgIHZhciB1cGRhdGUgPSBmYWxzZTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBiYXNlLm5hbWVzLmxlbmd0aDsgaSA8IGlsZW47IGkgKz0gMSkge1xuICAgICAgICAgICAgaWYgKGJhc2UubmFtZXNbaV0gPiB0aGlzLmJhc2UubmFtZXNbaV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2UuZ2l2ZW5zW2ldID0gYmFzZS5naXZlbnNbaV0uc2xpY2UoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2UubmFtZXNbaV0gPSBiYXNlLm5hbWVzW2ldO1xuICAgICAgICAgICAgICAgIHRoaXMuYmV0dGVyYmFzZS5uYW1lcyA9IHRoaXMuYmFzZS5uYW1lcy5zbGljZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuYmV0dGVyYmFzZS5naXZlbnMgPSB0aGlzLmJhc2UuZ2l2ZW5zLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5wYWRCYXNlKHRoaXMuYmFzZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5wYWRCYXNlKHRoaXMuYmV0dGVyYmFzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5iZXR0ZXJiYXNlLmdpdmVucyA9IHRoaXMuYmFzZS5naXZlbnMuc2xpY2UoKTtcbiAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsZW4gPSB0aGlzLmJhc2UuZ2l2ZW5zLmxlbmd0aDsgaiA8IGpsZW47IGogKz0gMSkge1xuICAgICAgICAgICAgdGhpcy5iZXR0ZXJiYXNlLmdpdmVuc1tqXSA9IHRoaXMuYmFzZS5naXZlbnNbal0uc2xpY2UoKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5DU0wuRGlzYW1iaWd1YXRpb24ucHJvdG90eXBlLmNhcHR1cmVTdGVwVG9CYXNlID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUuY2l0YXRpb24ub3B0W1wiZ2l2ZW5uYW1lLWRpc2FtYmlndWF0aW9uLXJ1bGVcIl0gPT09IFwiYnktY2l0ZVwiXG4gICAgICAgICYmIHRoaXMuYmFzZS5naXZlbnMgJiYgdGhpcy5iYXNlLmdpdmVucy5sZW5ndGgpIHtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT09IHR5cGVvZiB0aGlzLmJhc2UuZ2l2ZW5zW3RoaXMuZ25hbWVzZXRdW3RoaXMuZ25hbWVdKSB7XG4gICAgICAgICAgICB0aGlzLmJldHRlcmJhc2UuZ2l2ZW5zW3RoaXMuZ25hbWVzZXRdW3RoaXMuZ25hbWVdID0gdGhpcy5iYXNlLmdpdmVuc1t0aGlzLmduYW1lc2V0XVt0aGlzLmduYW1lXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmJldHRlcmJhc2UubmFtZXNbdGhpcy5nbmFtZXNldF0gPSB0aGlzLmJhc2UubmFtZXNbdGhpcy5nbmFtZXNldF07XG59O1xubW9kdWxlLmV4cG9ydHMgPSBDU0w7XG5DU0wuRW5naW5lLnByb3RvdHlwZS5nZXRKdXJpc2RpY3Rpb25MaXN0ID0gZnVuY3Rpb24gKGp1cmlzZGljdGlvbikge1xuICAgIHZhciBqdXJpc2RpY3Rpb25MaXN0ID0gW107XG4gICAgdmFyIGp1cmlzZGljdGlvbkVsZW1zID0ganVyaXNkaWN0aW9uLnNwbGl0KFwiOlwiKTtcbiAgICBmb3IgKHZhciBqPWp1cmlzZGljdGlvbkVsZW1zLmxlbmd0aDtqPjA7ai0tKSB7XG4gICAgICAgIGp1cmlzZGljdGlvbkxpc3QucHVzaChqdXJpc2RpY3Rpb25FbGVtcy5zbGljZSgwLGopLmpvaW4oXCI6XCIpKTtcbiAgICB9XG4gICAgaWYgKGp1cmlzZGljdGlvbkxpc3QuaW5kZXhPZihcInVzXCIpID09PSAtMSkge1xuICAgICAgICBqdXJpc2RpY3Rpb25MaXN0LnB1c2goXCJ1c1wiKTtcbiAgICB9XG4gICAgcmV0dXJuIGp1cmlzZGljdGlvbkxpc3Q7XG59XG5DU0wuRW5naW5lLnByb3RvdHlwZS5yZXRyaWV2ZUFsbFN0eWxlTW9kdWxlcyA9IGZ1bmN0aW9uIChqdXJpc2RpY3Rpb25MaXN0KSB7XG4gICAgdmFyIHJldCA9IHt9O1xuICAgIHZhciBwcmVmZXJlbmNlcyA9IHRoaXMubG9jYWxlW3RoaXMub3B0LmxhbmddLm9wdHNbXCJqdXJpc2RpY3Rpb24tcHJlZmVyZW5jZVwiXTtcbiAgICBwcmVmZXJlbmNlcyA9IHByZWZlcmVuY2VzID8gcHJlZmVyZW5jZXMgOiBbXTtcbiAgICBwcmVmZXJlbmNlcyA9IFtcIlwiXS5jb25jYXQocHJlZmVyZW5jZXMpO1xuICAgIGZvciAodmFyIGk9cHJlZmVyZW5jZXMubGVuZ3RoLTE7aT4tMTtpLS0pIHtcbiAgICAgICAgdmFyIHByZWZlcmVuY2UgPSBwcmVmZXJlbmNlc1tpXTtcbiAgICAgICAgZm9yICh2YXIgaj0wLGpsZW49anVyaXNkaWN0aW9uTGlzdC5sZW5ndGg7ajxqbGVuO2orKykge1xuICAgICAgICAgICAgdmFyIGp1cmlzZGljdGlvbiA9IGp1cmlzZGljdGlvbkxpc3Rbal07XG4gICAgICAgICAgICBpZiAodGhpcy5vcHQuanVyaXNkaWN0aW9uc19zZWVuW2p1cmlzZGljdGlvbl0pIGNvbnRpbnVlO1xuICAgICAgICAgICAgdmFyIHJlcyA9IHRoaXMuc3lzLnJldHJpZXZlU3R5bGVNb2R1bGUoanVyaXNkaWN0aW9uLCBwcmVmZXJlbmNlKTtcbiAgICAgICAgICAgIGlmICgoIXJlcyAmJiAhcHJlZmVyZW5jZSkgfHwgcmVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHQuanVyaXNkaWN0aW9uc19zZWVuW2p1cmlzZGljdGlvbl0gPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFyZXMpIGNvbnRpbnVlO1xuICAgICAgICAgICAgcmV0W2p1cmlzZGljdGlvbl0gPSByZXM7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJldDtcbn1cbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuQ1NMLlBhcnRpY2xlTGlzdCA9IGZ1bmN0aW9uKCkge1xuXHR2YXIgYWx3YXlzX2Ryb3BwaW5nXzEgPSBbW1swLDFdLCBudWxsXV07XG5cdHZhciBhbHdheXNfZHJvcHBpbmdfMiA9IFtbWzAsMl0sIG51bGxdXTtcblx0dmFyIGFsd2F5c19kcm9wcGluZ18zID0gW1tbMCwzXSwgbnVsbF1dXG5cdHZhciBhbHdheXNfbm9uX2Ryb3BwaW5nXzEgPSBbW251bGwsIFswLDFdXV07XG5cdHZhciBhbHdheXNfbm9uX2Ryb3BwaW5nXzIgPSBbW251bGwsIFswLDJdXV07XG5cdHZhciBhbHdheXNfbm9uX2Ryb3BwaW5nXzMgPSBbW251bGwsIFswLDNdXV07XG5cdHZhciBlaXRoZXJfMSA9IFtbbnVsbCwgWzAsMV1dLFtbMCwxXSxudWxsXV07XG5cdHZhciBlaXRoZXJfMiA9IFtbbnVsbCwgWzAsMl1dLFtbMCwyXSxudWxsXV07XG5cdHZhciBlaXRoZXJfMV9kcm9wcGluZ19iZXN0ID0gW1tbMCwxXSxudWxsXSxbbnVsbCwgWzAsMV1dXTtcblx0dmFyIGVpdGhlcl8yX2Ryb3BwaW5nX2Jlc3QgPSBbW1swLDJdLG51bGxdLFtudWxsLCBbMCwyXV1dO1xuXHR2YXIgZWl0aGVyXzNfZHJvcHBpbmdfYmVzdCA9IFtbWzAsM10sbnVsbF0sW251bGwsIFswLDNdXV07XG5cdHZhciBub25fZHJvcHBpbmdfMl9hbHRfZHJvcHBpbmdfMV9ub25fZHJvcHBpbmdfMSA9IFtbbnVsbCwgWzAsMl1dLCBbWzAsMV0sIFsxLDJdXV07XG5cdHZhciBQQVJUSUNMRVMgPSBbXG5cdFx0W1wiJ3NcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCIncy1cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCIndFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImFcIiwgXHRhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImFhbiAndFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImFhbiBkZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImFhbiBkZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJhYW4gZGVyXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiYWFuIGhldFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImFhbiB0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiYWFuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiYWQtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJhZGgtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJhZlwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYWxcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImFsLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYW0gZGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJhbVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImFuLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYXItXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJhcy1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImFzaC1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImF0LVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYXRoLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYXVmIGRlbVwiLCBlaXRoZXJfMl9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJhdWYgZGVuXCIsIGVpdGhlcl8yX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcImF1ZiBkZXJcIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1wiYXVmIHRlclwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImF1ZlwiLCBlaXRoZXJfMV9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJhdXMgJ21cIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1wiYXVzIGRlbVwiLCBlaXRoZXJfMl9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJhdXMgZGVuXCIsIGVpdGhlcl8yX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcImF1cyBkZXJcIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1wiYXVzIG1cIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1wiYXVzXCIsIGVpdGhlcl8xX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcImF1cydtXCIsIGVpdGhlcl8yX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcImF6LVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYcWhLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYeG4jS1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImHhuI8tXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJh4bmjLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYeG5rS1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImHhua8tXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJh4bqTLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiYmVuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiYmlqICd0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiYmlqIGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiYmlqIGRlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImJpaiBoZXRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJiaWogdFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImJpalwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImJpblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImJvdmVuIGRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJib3ZlbiBkJ1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJkJ1wiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGFcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRhbFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImRhbCdcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJkYWxsJ1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImRhbGxhXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiZGFzXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkZSBkaWUgbGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18zXSxcblx0XHRbXCJkZSBkaWVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJkZSBsXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiZGUgbCdcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJkZSBsYVwiLCBub25fZHJvcHBpbmdfMl9hbHRfZHJvcHBpbmdfMV9ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wiZGUgbGFzXCIsIG5vbl9kcm9wcGluZ18yX2FsdF9kcm9wcGluZ18xX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJkZSBsZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImRlIGxpXCIsIGVpdGhlcl8yXSxcblx0XHRbXCJkZSB2YW4gZGVyXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfM10sXG5cdFx0W1wiZGVcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRlJ1wiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGVjYVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImRlZ2xpXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkZWlcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRlbFwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGVsYVwiLCBhbHdheXNfZHJvcHBpbmdfMV0sXG5cdFx0W1wiZGVsbCdcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRlbGxhXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkZWxsZVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGVsbG9cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRlblwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZGVyXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkZXNcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImRpXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJkaWUgbGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJkb1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImRvblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImRvc1wiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZHVcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImVkLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZWRoLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZWxcIiwgZWl0aGVyXzFdLFxuXHRcdFtcImVsLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZW4tXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJlci1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImVzLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZXNoLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZXQtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJldGgtXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJlei1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImXFoS1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImXhuI0tXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJl4biPLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZeG5oy1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImXhua0tXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJl4bmvLVwiLCBlaXRoZXJfMV0sXG5cdFx0W1wiZeG6ky1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcImhldFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImlcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJpbFwiLCBhbHdheXNfZHJvcHBpbmdfMV0sXG5cdFx0W1wiaW1cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJpbiAndFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcImluIGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiaW4gZGVuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiaW4gZGVyXCIsIGVpdGhlcl8yXSxcblx0XHRbXCJpbiBoZXRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJpbiB0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wiaW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJsXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wibCdcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJsYVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImxhc1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcImxlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wibGVzXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJsb1wiLCBlaXRoZXJfMV0sXG5cdFx0W1wibG9zXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wibG91XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wib2ZcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJvbmRlciAndFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcIm9uZGVyIGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib25kZXIgZGVuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib25kZXIgaGV0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib25kZXIgdFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcIm9uZGVyXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wib3AgJ3RcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvcCBkZVwiLCBlaXRoZXJfMl0sXG5cdFx0W1wib3AgZGVuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib3AgZGVyXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib3AgZ2VuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib3AgaGV0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib3AgdFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcIm9wIHRlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcIm9wXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1wib3ZlciAndFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcIm92ZXIgZGVcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJvdmVyIGRlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcIm92ZXIgaGV0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib3ZlciB0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1wib3ZlclwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInNcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJzJ1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInNlblwiLCBhbHdheXNfZHJvcHBpbmdfMV0sXG5cdFx0W1widFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widGVuXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widGVyXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widGhvXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widGhvZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInRob3JcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJ0b1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInRvZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInRvdFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInVpanQgJ3RcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ1aWp0IGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widWlqdCBkZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ1aWp0IHRlIGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfM10sXG5cdFx0W1widWlqdCB0ZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ1aWp0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMV0sXG5cdFx0W1widWl0ICd0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widWl0IGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widWl0IGRlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInVpdCBoZXRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ1aXQgdFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInVpdCB0ZSBkZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzNdLFxuXHRcdFtcInVpdCB0ZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ1aXRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJ1bnRlclwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInZcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJ2LlwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInYuZC5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJ2YW4gJ3RcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ2YW4gZGUgbFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzNdLFxuXHRcdFtcInZhbiBkZSBsJ1wiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzNdLFxuXHRcdFtcInZhbiBkZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZhbiBkZVwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZhbiBkZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ2YW4gZGVyXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widmFuIGdlblwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZhbiBoZXRcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ2YW4gbGFcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ2YW4gdFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZhbiB0ZXJcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ2YW4gdmFuIGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfM10sXG5cdFx0W1widmFuXCIsIGVpdGhlcl8xXSxcblx0XHRbXCJ2YW5kZXJcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18xXSxcblx0XHRbXCJ2ZFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInZlclwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInZvbSB1bmQgenVtXCIsIGFsd2F5c19kcm9wcGluZ18zXSxcblx0XHRbXCJ2b21cIiwgZWl0aGVyXzFdLFxuXHRcdFtcInZvbiAndFwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzJdLFxuXHRcdFtcInZvbiBkZW1cIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1widm9uIGRlblwiLCBlaXRoZXJfMl9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJ2b24gZGVyXCIsIGVpdGhlcl8yX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcInZvbiB0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widm9uIHVuZCB6dVwiLCBlaXRoZXJfM19kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJ2b24genVcIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1widm9uXCIsIGVpdGhlcl8xX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcInZvb3IgJ3RcIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ2b29yIGRlXCIsIGFsd2F5c19ub25fZHJvcHBpbmdfMl0sXG5cdFx0W1widm9vciBkZW5cIiwgYWx3YXlzX25vbl9kcm9wcGluZ18yXSxcblx0XHRbXCJ2b29yIGluICd0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfM10sXG5cdFx0W1widm9vciBpbiB0XCIsIGFsd2F5c19ub25fZHJvcHBpbmdfM10sXG5cdFx0W1widm9vclwiLCBhbHdheXNfbm9uX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInZvciBkZXJcIiwgZWl0aGVyXzJfZHJvcHBpbmdfYmVzdF0sXG5cdFx0W1widm9yXCIsIGVpdGhlcl8xX2Ryb3BwaW5nX2Jlc3RdLFxuXHRcdFtcInpcIiwgYWx3YXlzX2Ryb3BwaW5nXzFdLFxuXHRcdFtcInplXCIsIGFsd2F5c19kcm9wcGluZ18xXSxcblx0XHRbXCJ6dVwiLCBlaXRoZXJfMV9kcm9wcGluZ19iZXN0XSxcblx0XHRbXCJ6dW1cIiwgZWl0aGVyXzFdLFxuXHRcdFtcInp1clwiLCBlaXRoZXJfMV1cblx0XTtcbiAgICByZXR1cm4gUEFSVElDTEVTO1xufSgpO1xuQ1NMLnBhcnNlUGFydGljbGVzID0gZnVuY3Rpb24oKXtcbiAgICBmdW5jdGlvbiBzcGxpdFBhcnRpY2xlcyhuYW1lVmFsdWUsIGZpcnN0TmFtZUZsYWcsIGNhc2VPdmVycmlkZSkge1xuXHRcdHZhciBvcmlnTmFtZVZhbHVlID0gbmFtZVZhbHVlO1xuXHRcdG5hbWVWYWx1ZSA9IGNhc2VPdmVycmlkZSA/IG5hbWVWYWx1ZS50b0xvd2VyQ2FzZSgpIDogbmFtZVZhbHVlO1xuXHRcdHZhciBwYXJ0aWNsZUxpc3QgPSBbXTtcblx0XHR2YXIgYXBvc3Ryb3BoZTtcblx0XHR2YXIgcmV4O1xuXHRcdGlmIChmaXJzdE5hbWVGbGFnKSB7XG5cdFx0XHRuYW1lVmFsdWUgPSBuYW1lVmFsdWUuc3BsaXQoXCJcIikucmV2ZXJzZSgpLmpvaW4oXCJcIik7XG5cdFx0XHRyZXggPSBDU0wuUEFSVElDTEVfR0lWRU5fUkVHRVhQO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXggPSBDU0wuUEFSVElDTEVfRkFNSUxZX1JFR0VYUDtcblx0XHR9XG5cdFx0dmFyIG0gPSBuYW1lVmFsdWUubWF0Y2gocmV4KTtcblx0XHR3aGlsZSAobSkge1xuXHRcdFx0dmFyIG0xID0gZmlyc3ROYW1lRmxhZyA/IG1bMV0uc3BsaXQoXCJcIikucmV2ZXJzZSgpLmpvaW4oXCJcIikgOiBtWzFdO1xuXHRcdFx0dmFyIGZpcnN0Q2hhciA9IG0gPyBtMSA6IGZhbHNlO1xuXHRcdFx0dmFyIGZpcnN0Q2hhciA9IGZpcnN0Q2hhciA/IG0xLnJlcGxhY2UoL15bLVxcJ1xcdTAyYmJcXHUyMDE5XFxzXSooLikuKiQvLCBcIiQxXCIpIDogZmFsc2U7XG5cdFx0XHR2YXIgaGFzUGFydGljbGUgPSBmaXJzdENoYXIgPyBmaXJzdENoYXIudG9VcHBlckNhc2UoKSAhPT0gZmlyc3RDaGFyIDogZmFsc2U7XG5cdFx0XHRpZiAoIWhhc1BhcnRpY2xlKSBicmVhaztcblx0XHRcdGlmIChmaXJzdE5hbWVGbGFnKSB7XG5cdFx0XHRcdHBhcnRpY2xlTGlzdC5wdXNoKG9yaWdOYW1lVmFsdWUuc2xpY2UobTEubGVuZ3RoICogLTEpKTtcblx0XHRcdFx0b3JpZ05hbWVWYWx1ZSA9IG9yaWdOYW1lVmFsdWUuc2xpY2UoMCxtMS5sZW5ndGggKiAtMSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRwYXJ0aWNsZUxpc3QucHVzaChvcmlnTmFtZVZhbHVlLnNsaWNlKDAsbTEubGVuZ3RoKSk7XG5cdFx0XHRcdG9yaWdOYW1lVmFsdWUgPSBvcmlnTmFtZVZhbHVlLnNsaWNlKG0xLmxlbmd0aCk7XG5cdFx0XHR9XG5cdFx0XHRuYW1lVmFsdWUgPSBtWzJdO1xuXHRcdFx0bSA9IG5hbWVWYWx1ZS5tYXRjaChyZXgpO1xuXHRcdH1cblx0XHRpZiAoZmlyc3ROYW1lRmxhZykge1xuXHRcdFx0bmFtZVZhbHVlID0gbmFtZVZhbHVlLnNwbGl0KFwiXCIpLnJldmVyc2UoKS5qb2luKFwiXCIpO1xuXHRcdFx0cGFydGljbGVMaXN0LnJldmVyc2UoKTtcblx0XHRcdGZvciAodmFyIGk9MSxpbGVuPXBhcnRpY2xlTGlzdC5sZW5ndGg7aTxpbGVuO2krKykge1xuXHRcdFx0XHRpZiAocGFydGljbGVMaXN0W2ldLnNsaWNlKDAsIDEpID09IFwiIFwiKSB7XG5cdFx0XHRcdFx0cGFydGljbGVMaXN0W2ktMV0gKz0gXCIgXCI7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdGZvciAodmFyIGk9MCxpbGVuPXBhcnRpY2xlTGlzdC5sZW5ndGg7aTxpbGVuO2krKykge1xuXHRcdFx0XHRpZiAocGFydGljbGVMaXN0W2ldLnNsaWNlKDAsIDEpID09IFwiIFwiKSB7XG5cdFx0XHRcdFx0cGFydGljbGVMaXN0W2ldID0gcGFydGljbGVMaXN0W2ldLnNsaWNlKDEpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRuYW1lVmFsdWUgPSBvcmlnTmFtZVZhbHVlLnNsaWNlKDAsIG5hbWVWYWx1ZS5sZW5ndGgpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRuYW1lVmFsdWUgPSBvcmlnTmFtZVZhbHVlLnNsaWNlKG5hbWVWYWx1ZS5sZW5ndGggKiAtMSk7XG5cdFx0fVxuXHRcdHJldHVybiBbaGFzUGFydGljbGUsIG5hbWVWYWx1ZSwgcGFydGljbGVMaXN0XTtcblx0fVxuICAgIGZ1bmN0aW9uIHRyaW1MYXN0KHN0cikge1xuICAgICAgICB2YXIgbGFzdENoYXIgPSBzdHIuc2xpY2UoLTEpO1xuICAgICAgICBzdHIgPSBzdHIudHJpbSgpO1xuICAgICAgICBpZiAobGFzdENoYXIgPT09IFwiIFwiICYmIFtcIlxcJ1wiLCBcIlxcdTIwMTlcIl0uaW5kZXhPZihzdHIuc2xpY2UoLTEpKSA+IC0xKSB7XG4gICAgICAgICAgICBzdHIgKz0gXCIgXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN0cjtcbiAgICB9XG4gICAgZnVuY3Rpb24gcGFyc2VTdWZmaXgobmFtZU9iaikge1xuICAgICAgICBpZiAoIW5hbWVPYmouc3VmZml4ICYmIG5hbWVPYmouZ2l2ZW4pIHtcbiAgICAgICAgICAgIHZhciBtID0gbmFtZU9iai5naXZlbi5tYXRjaCgvKFxccyosISpcXHMqKS8pO1xuICAgICAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgICAgICB2YXIgaWR4ID0gbmFtZU9iai5naXZlbi5pbmRleE9mKG1bMV0pO1xuICAgICAgICAgICAgICAgIHZhciBwb3NzaWJsZV9zdWZmaXggPSBuYW1lT2JqLmdpdmVuLnNsaWNlKGlkeCArIG1bMV0ubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICB2YXIgcG9zc2libGVfY29tbWEgPSBuYW1lT2JqLmdpdmVuLnNsaWNlKGlkeCwgaWR4ICsgbVsxXS5sZW5ndGgpLnJlcGxhY2UoL1xccyovZywgXCJcIik7XG4gICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlX3N1ZmZpeC5yZXBsYWNlKC9cXC4vZywgXCJcIikgPT09ICdldCBhbCcgJiYgIW5hbWVPYmpbXCJkcm9wcGluZy1wYXJ0aWNsZVwiXSkge1xuICAgICAgICAgICAgICAgICAgICBuYW1lT2JqW1wiZHJvcHBpbmctcGFydGljbGVcIl0gPSBwb3NzaWJsZV9zdWZmaXg7XG4gICAgICAgICAgICAgICAgICAgIG5hbWVPYmpbXCJjb21tYS1kcm9wcGluZy1wYXJ0aWNsZVwiXSA9IFwiLFwiO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwb3NzaWJsZV9jb21tYS5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVPYmpbXCJjb21tYS1zdWZmaXhcIl0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG5hbWVPYmouc3VmZml4ID0gcG9zc2libGVfc3VmZml4O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBuYW1lT2JqLmdpdmVuID0gbmFtZU9iai5naXZlbi5zbGljZSgwLCBpZHgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmdW5jdGlvbihuYW1lT2JqKSB7XG4gICAgICAgIHZhciByZXMgPSBzcGxpdFBhcnRpY2xlcyhuYW1lT2JqLmZhbWlseSk7XG4gICAgICAgIHZhciBoYXNMYXN0UGFydGljbGUgPSByZXNbMF07XG4gICAgICAgIHZhciBsYXN0TmFtZVZhbHVlID0gcmVzWzFdO1xuICAgICAgICB2YXIgbGFzdFBhcnRpY2xlTGlzdCA9IHJlc1syXTtcbiAgICAgICAgbmFtZU9iai5mYW1pbHkgPSBsYXN0TmFtZVZhbHVlO1xuICAgICAgICB2YXIgbm9uRHJvcHBpbmdQYXJ0aWNsZSA9IHRyaW1MYXN0KGxhc3RQYXJ0aWNsZUxpc3Quam9pbihcIlwiKSk7XG4gICAgICAgIGlmIChub25Ecm9wcGluZ1BhcnRpY2xlKSB7XG4gICAgICAgICAgICBuYW1lT2JqWydub24tZHJvcHBpbmctcGFydGljbGUnXSA9IG5vbkRyb3BwaW5nUGFydGljbGU7XG4gICAgICAgIH1cbiAgICAgICAgcGFyc2VTdWZmaXgobmFtZU9iaik7XG4gICAgICAgIHZhciByZXMgPSBzcGxpdFBhcnRpY2xlcyhuYW1lT2JqLmdpdmVuLCB0cnVlKTtcbiAgICAgICAgdmFyIGhhc0ZpcnN0UGFydGljbGUgPSByZXNbMF07XG4gICAgICAgIHZhciBmaXJzdE5hbWVWYWx1ZSA9IHJlc1sxXTtcbiAgICAgICAgdmFyIGZpcnN0UGFydGljbGVMaXN0ID0gcmVzWzJdO1xuICAgICAgICBuYW1lT2JqLmdpdmVuID0gZmlyc3ROYW1lVmFsdWU7XG4gICAgICAgIHZhciBkcm9wcGluZ1BhcnRpY2xlID0gZmlyc3RQYXJ0aWNsZUxpc3Quam9pbihcIlwiKS50cmltKCk7XG4gICAgICAgIGlmIChkcm9wcGluZ1BhcnRpY2xlKSB7XG4gICAgICAgICAgICBuYW1lT2JqWydkcm9wcGluZy1wYXJ0aWNsZSddID0gZHJvcHBpbmdQYXJ0aWNsZTtcbiAgICAgICAgfVxuICAgIH1cbn0oKTtcbm1vZHVsZS5leHBvcnRzID0gQ1NMO1xuIiwiLy8gVGhpcyBmaWxlIGNhbiBiZSByZXF1aXJlZCBpbiBCcm93c2VyaWZ5IGFuZCBOb2RlLmpzIGZvciBhdXRvbWF0aWMgcG9seWZpbGxcbi8vIFRvIHVzZSBpdDogIHJlcXVpcmUoJ2VzNi1wcm9taXNlL2F1dG8nKTtcbid1c2Ugc3RyaWN0Jztcbm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi8nKS5wb2x5ZmlsbCgpO1xuIiwiLyohXG4gKiBAb3ZlcnZpZXcgZXM2LXByb21pc2UgLSBhIHRpbnkgaW1wbGVtZW50YXRpb24gb2YgUHJvbWlzZXMvQSsuXG4gKiBAY29weXJpZ2h0IENvcHlyaWdodCAoYykgMjAxNCBZZWh1ZGEgS2F0eiwgVG9tIERhbGUsIFN0ZWZhbiBQZW5uZXIgYW5kIGNvbnRyaWJ1dG9ycyAoQ29udmVyc2lvbiB0byBFUzYgQVBJIGJ5IEpha2UgQXJjaGliYWxkKVxuICogQGxpY2Vuc2UgICBMaWNlbnNlZCB1bmRlciBNSVQgbGljZW5zZVxuICogICAgICAgICAgICBTZWUgaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3N0ZWZhbnBlbm5lci9lczYtcHJvbWlzZS9tYXN0ZXIvTElDRU5TRVxuICogQHZlcnNpb24gICA0LjEuMVxuICovXG5cbihmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7XG5cdHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyA/IG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpIDpcblx0dHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKGZhY3RvcnkpIDpcblx0KGdsb2JhbC5FUzZQcm9taXNlID0gZmFjdG9yeSgpKTtcbn0odGhpcywgKGZ1bmN0aW9uICgpIHsgJ3VzZSBzdHJpY3QnO1xuXG5mdW5jdGlvbiBvYmplY3RPckZ1bmN0aW9uKHgpIHtcbiAgdmFyIHR5cGUgPSB0eXBlb2YgeDtcbiAgcmV0dXJuIHggIT09IG51bGwgJiYgKHR5cGUgPT09ICdvYmplY3QnIHx8IHR5cGUgPT09ICdmdW5jdGlvbicpO1xufVxuXG5mdW5jdGlvbiBpc0Z1bmN0aW9uKHgpIHtcbiAgcmV0dXJuIHR5cGVvZiB4ID09PSAnZnVuY3Rpb24nO1xufVxuXG52YXIgX2lzQXJyYXkgPSB1bmRlZmluZWQ7XG5pZiAoQXJyYXkuaXNBcnJheSkge1xuICBfaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7XG59IGVsc2Uge1xuICBfaXNBcnJheSA9IGZ1bmN0aW9uICh4KSB7XG4gICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh4KSA9PT0gJ1tvYmplY3QgQXJyYXldJztcbiAgfTtcbn1cblxudmFyIGlzQXJyYXkgPSBfaXNBcnJheTtcblxudmFyIGxlbiA9IDA7XG52YXIgdmVydHhOZXh0ID0gdW5kZWZpbmVkO1xudmFyIGN1c3RvbVNjaGVkdWxlckZuID0gdW5kZWZpbmVkO1xuXG52YXIgYXNhcCA9IGZ1bmN0aW9uIGFzYXAoY2FsbGJhY2ssIGFyZykge1xuICBxdWV1ZVtsZW5dID0gY2FsbGJhY2s7XG4gIHF1ZXVlW2xlbiArIDFdID0gYXJnO1xuICBsZW4gKz0gMjtcbiAgaWYgKGxlbiA9PT0gMikge1xuICAgIC8vIElmIGxlbiBpcyAyLCB0aGF0IG1lYW5zIHRoYXQgd2UgbmVlZCB0byBzY2hlZHVsZSBhbiBhc3luYyBmbHVzaC5cbiAgICAvLyBJZiBhZGRpdGlvbmFsIGNhbGxiYWNrcyBhcmUgcXVldWVkIGJlZm9yZSB0aGUgcXVldWUgaXMgZmx1c2hlZCwgdGhleVxuICAgIC8vIHdpbGwgYmUgcHJvY2Vzc2VkIGJ5IHRoaXMgZmx1c2ggdGhhdCB3ZSBhcmUgc2NoZWR1bGluZy5cbiAgICBpZiAoY3VzdG9tU2NoZWR1bGVyRm4pIHtcbiAgICAgIGN1c3RvbVNjaGVkdWxlckZuKGZsdXNoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2NoZWR1bGVGbHVzaCgpO1xuICAgIH1cbiAgfVxufTtcblxuZnVuY3Rpb24gc2V0U2NoZWR1bGVyKHNjaGVkdWxlRm4pIHtcbiAgY3VzdG9tU2NoZWR1bGVyRm4gPSBzY2hlZHVsZUZuO1xufVxuXG5mdW5jdGlvbiBzZXRBc2FwKGFzYXBGbikge1xuICBhc2FwID0gYXNhcEZuO1xufVxuXG52YXIgYnJvd3NlcldpbmRvdyA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnID8gd2luZG93IDogdW5kZWZpbmVkO1xudmFyIGJyb3dzZXJHbG9iYWwgPSBicm93c2VyV2luZG93IHx8IHt9O1xudmFyIEJyb3dzZXJNdXRhdGlvbk9ic2VydmVyID0gYnJvd3Nlckdsb2JhbC5NdXRhdGlvbk9ic2VydmVyIHx8IGJyb3dzZXJHbG9iYWwuV2ViS2l0TXV0YXRpb25PYnNlcnZlcjtcbnZhciBpc05vZGUgPSB0eXBlb2Ygc2VsZiA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIHByb2Nlc3MgIT09ICd1bmRlZmluZWQnICYmICh7fSkudG9TdHJpbmcuY2FsbChwcm9jZXNzKSA9PT0gJ1tvYmplY3QgcHJvY2Vzc10nO1xuXG4vLyB0ZXN0IGZvciB3ZWIgd29ya2VyIGJ1dCBub3QgaW4gSUUxMFxudmFyIGlzV29ya2VyID0gdHlwZW9mIFVpbnQ4Q2xhbXBlZEFycmF5ICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgaW1wb3J0U2NyaXB0cyAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIE1lc3NhZ2VDaGFubmVsICE9PSAndW5kZWZpbmVkJztcblxuLy8gbm9kZVxuZnVuY3Rpb24gdXNlTmV4dFRpY2soKSB7XG4gIC8vIG5vZGUgdmVyc2lvbiAwLjEwLnggZGlzcGxheXMgYSBkZXByZWNhdGlvbiB3YXJuaW5nIHdoZW4gbmV4dFRpY2sgaXMgdXNlZCByZWN1cnNpdmVseVxuICAvLyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2N1am9qcy93aGVuL2lzc3Vlcy80MTAgZm9yIGRldGFpbHNcbiAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gcHJvY2Vzcy5uZXh0VGljayhmbHVzaCk7XG4gIH07XG59XG5cbi8vIHZlcnR4XG5mdW5jdGlvbiB1c2VWZXJ0eFRpbWVyKCkge1xuICBpZiAodHlwZW9mIHZlcnR4TmV4dCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgdmVydHhOZXh0KGZsdXNoKTtcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHVzZVNldFRpbWVvdXQoKTtcbn1cblxuZnVuY3Rpb24gdXNlTXV0YXRpb25PYnNlcnZlcigpIHtcbiAgdmFyIGl0ZXJhdGlvbnMgPSAwO1xuICB2YXIgb2JzZXJ2ZXIgPSBuZXcgQnJvd3Nlck11dGF0aW9uT2JzZXJ2ZXIoZmx1c2gpO1xuICB2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcnKTtcbiAgb2JzZXJ2ZXIub2JzZXJ2ZShub2RlLCB7IGNoYXJhY3RlckRhdGE6IHRydWUgfSk7XG5cbiAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcbiAgICBub2RlLmRhdGEgPSBpdGVyYXRpb25zID0gKytpdGVyYXRpb25zICUgMjtcbiAgfTtcbn1cblxuLy8gd2ViIHdvcmtlclxuZnVuY3Rpb24gdXNlTWVzc2FnZUNoYW5uZWwoKSB7XG4gIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7XG4gIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gZmx1c2g7XG4gIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGNoYW5uZWwucG9ydDIucG9zdE1lc3NhZ2UoMCk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZVNldFRpbWVvdXQoKSB7XG4gIC8vIFN0b3JlIHNldFRpbWVvdXQgcmVmZXJlbmNlIHNvIGVzNi1wcm9taXNlIHdpbGwgYmUgdW5hZmZlY3RlZCBieVxuICAvLyBvdGhlciBjb2RlIG1vZGlmeWluZyBzZXRUaW1lb3V0IChsaWtlIHNpbm9uLnVzZUZha2VUaW1lcnMoKSlcbiAgdmFyIGdsb2JhbFNldFRpbWVvdXQgPSBzZXRUaW1lb3V0O1xuICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBnbG9iYWxTZXRUaW1lb3V0KGZsdXNoLCAxKTtcbiAgfTtcbn1cblxudmFyIHF1ZXVlID0gbmV3IEFycmF5KDEwMDApO1xuZnVuY3Rpb24gZmx1c2goKSB7XG4gIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDIpIHtcbiAgICB2YXIgY2FsbGJhY2sgPSBxdWV1ZVtpXTtcbiAgICB2YXIgYXJnID0gcXVldWVbaSArIDFdO1xuXG4gICAgY2FsbGJhY2soYXJnKTtcblxuICAgIHF1ZXVlW2ldID0gdW5kZWZpbmVkO1xuICAgIHF1ZXVlW2kgKyAxXSA9IHVuZGVmaW5lZDtcbiAgfVxuXG4gIGxlbiA9IDA7XG59XG5cbmZ1bmN0aW9uIGF0dGVtcHRWZXJ0eCgpIHtcbiAgdHJ5IHtcbiAgICB2YXIgciA9IHJlcXVpcmU7XG4gICAgdmFyIHZlcnR4ID0gcigndmVydHgnKTtcbiAgICB2ZXJ0eE5leHQgPSB2ZXJ0eC5ydW5Pbkxvb3AgfHwgdmVydHgucnVuT25Db250ZXh0O1xuICAgIHJldHVybiB1c2VWZXJ0eFRpbWVyKCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gdXNlU2V0VGltZW91dCgpO1xuICB9XG59XG5cbnZhciBzY2hlZHVsZUZsdXNoID0gdW5kZWZpbmVkO1xuLy8gRGVjaWRlIHdoYXQgYXN5bmMgbWV0aG9kIHRvIHVzZSB0byB0cmlnZ2VyaW5nIHByb2Nlc3Npbmcgb2YgcXVldWVkIGNhbGxiYWNrczpcbmlmIChpc05vZGUpIHtcbiAgc2NoZWR1bGVGbHVzaCA9IHVzZU5leHRUaWNrKCk7XG59IGVsc2UgaWYgKEJyb3dzZXJNdXRhdGlvbk9ic2VydmVyKSB7XG4gIHNjaGVkdWxlRmx1c2ggPSB1c2VNdXRhdGlvbk9ic2VydmVyKCk7XG59IGVsc2UgaWYgKGlzV29ya2VyKSB7XG4gIHNjaGVkdWxlRmx1c2ggPSB1c2VNZXNzYWdlQ2hhbm5lbCgpO1xufSBlbHNlIGlmIChicm93c2VyV2luZG93ID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHJlcXVpcmUgPT09ICdmdW5jdGlvbicpIHtcbiAgc2NoZWR1bGVGbHVzaCA9IGF0dGVtcHRWZXJ0eCgpO1xufSBlbHNlIHtcbiAgc2NoZWR1bGVGbHVzaCA9IHVzZVNldFRpbWVvdXQoKTtcbn1cblxuZnVuY3Rpb24gdGhlbihvbkZ1bGZpbGxtZW50LCBvblJlamVjdGlvbikge1xuICB2YXIgX2FyZ3VtZW50cyA9IGFyZ3VtZW50cztcblxuICB2YXIgcGFyZW50ID0gdGhpcztcblxuICB2YXIgY2hpbGQgPSBuZXcgdGhpcy5jb25zdHJ1Y3Rvcihub29wKTtcblxuICBpZiAoY2hpbGRbUFJPTUlTRV9JRF0gPT09IHVuZGVmaW5lZCkge1xuICAgIG1ha2VQcm9taXNlKGNoaWxkKTtcbiAgfVxuXG4gIHZhciBfc3RhdGUgPSBwYXJlbnQuX3N0YXRlO1xuXG4gIGlmIChfc3RhdGUpIHtcbiAgICAoZnVuY3Rpb24gKCkge1xuICAgICAgdmFyIGNhbGxiYWNrID0gX2FyZ3VtZW50c1tfc3RhdGUgLSAxXTtcbiAgICAgIGFzYXAoZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gaW52b2tlQ2FsbGJhY2soX3N0YXRlLCBjaGlsZCwgY2FsbGJhY2ssIHBhcmVudC5fcmVzdWx0KTtcbiAgICAgIH0pO1xuICAgIH0pKCk7XG4gIH0gZWxzZSB7XG4gICAgc3Vic2NyaWJlKHBhcmVudCwgY2hpbGQsIG9uRnVsZmlsbG1lbnQsIG9uUmVqZWN0aW9uKTtcbiAgfVxuXG4gIHJldHVybiBjaGlsZDtcbn1cblxuLyoqXG4gIGBQcm9taXNlLnJlc29sdmVgIHJldHVybnMgYSBwcm9taXNlIHRoYXQgd2lsbCBiZWNvbWUgcmVzb2x2ZWQgd2l0aCB0aGVcbiAgcGFzc2VkIGB2YWx1ZWAuIEl0IGlzIHNob3J0aGFuZCBmb3IgdGhlIGZvbGxvd2luZzpcblxuICBgYGBqYXZhc2NyaXB0XG4gIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXtcbiAgICByZXNvbHZlKDEpO1xuICB9KTtcblxuICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpe1xuICAgIC8vIHZhbHVlID09PSAxXG4gIH0pO1xuICBgYGBcblxuICBJbnN0ZWFkIG9mIHdyaXRpbmcgdGhlIGFib3ZlLCB5b3VyIGNvZGUgbm93IHNpbXBseSBiZWNvbWVzIHRoZSBmb2xsb3dpbmc6XG5cbiAgYGBgamF2YXNjcmlwdFxuICBsZXQgcHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSgxKTtcblxuICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpe1xuICAgIC8vIHZhbHVlID09PSAxXG4gIH0pO1xuICBgYGBcblxuICBAbWV0aG9kIHJlc29sdmVcbiAgQHN0YXRpY1xuICBAcGFyYW0ge0FueX0gdmFsdWUgdmFsdWUgdGhhdCB0aGUgcmV0dXJuZWQgcHJvbWlzZSB3aWxsIGJlIHJlc29sdmVkIHdpdGhcbiAgVXNlZnVsIGZvciB0b29saW5nLlxuICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCB3aWxsIGJlY29tZSBmdWxmaWxsZWQgd2l0aCB0aGUgZ2l2ZW5cbiAgYHZhbHVlYFxuKi9cbmZ1bmN0aW9uIHJlc29sdmUkMShvYmplY3QpIHtcbiAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgdmFyIENvbnN0cnVjdG9yID0gdGhpcztcblxuICBpZiAob2JqZWN0ICYmIHR5cGVvZiBvYmplY3QgPT09ICdvYmplY3QnICYmIG9iamVjdC5jb25zdHJ1Y3RvciA9PT0gQ29uc3RydWN0b3IpIHtcbiAgICByZXR1cm4gb2JqZWN0O1xuICB9XG5cbiAgdmFyIHByb21pc2UgPSBuZXcgQ29uc3RydWN0b3Iobm9vcCk7XG4gIHJlc29sdmUocHJvbWlzZSwgb2JqZWN0KTtcbiAgcmV0dXJuIHByb21pc2U7XG59XG5cbnZhciBQUk9NSVNFX0lEID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDE2KTtcblxuZnVuY3Rpb24gbm9vcCgpIHt9XG5cbnZhciBQRU5ESU5HID0gdm9pZCAwO1xudmFyIEZVTEZJTExFRCA9IDE7XG52YXIgUkVKRUNURUQgPSAyO1xuXG52YXIgR0VUX1RIRU5fRVJST1IgPSBuZXcgRXJyb3JPYmplY3QoKTtcblxuZnVuY3Rpb24gc2VsZkZ1bGZpbGxtZW50KCkge1xuICByZXR1cm4gbmV3IFR5cGVFcnJvcihcIllvdSBjYW5ub3QgcmVzb2x2ZSBhIHByb21pc2Ugd2l0aCBpdHNlbGZcIik7XG59XG5cbmZ1bmN0aW9uIGNhbm5vdFJldHVybk93bigpIHtcbiAgcmV0dXJuIG5ldyBUeXBlRXJyb3IoJ0EgcHJvbWlzZXMgY2FsbGJhY2sgY2Fubm90IHJldHVybiB0aGF0IHNhbWUgcHJvbWlzZS4nKTtcbn1cblxuZnVuY3Rpb24gZ2V0VGhlbihwcm9taXNlKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIHByb21pc2UudGhlbjtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBHRVRfVEhFTl9FUlJPUi5lcnJvciA9IGVycm9yO1xuICAgIHJldHVybiBHRVRfVEhFTl9FUlJPUjtcbiAgfVxufVxuXG5mdW5jdGlvbiB0cnlUaGVuKHRoZW4kJDEsIHZhbHVlLCBmdWxmaWxsbWVudEhhbmRsZXIsIHJlamVjdGlvbkhhbmRsZXIpIHtcbiAgdHJ5IHtcbiAgICB0aGVuJCQxLmNhbGwodmFsdWUsIGZ1bGZpbGxtZW50SGFuZGxlciwgcmVqZWN0aW9uSGFuZGxlcik7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBoYW5kbGVGb3JlaWduVGhlbmFibGUocHJvbWlzZSwgdGhlbmFibGUsIHRoZW4kJDEpIHtcbiAgYXNhcChmdW5jdGlvbiAocHJvbWlzZSkge1xuICAgIHZhciBzZWFsZWQgPSBmYWxzZTtcbiAgICB2YXIgZXJyb3IgPSB0cnlUaGVuKHRoZW4kJDEsIHRoZW5hYmxlLCBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgIGlmIChzZWFsZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgc2VhbGVkID0gdHJ1ZTtcbiAgICAgIGlmICh0aGVuYWJsZSAhPT0gdmFsdWUpIHtcbiAgICAgICAgcmVzb2x2ZShwcm9taXNlLCB2YWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmdWxmaWxsKHByb21pc2UsIHZhbHVlKTtcbiAgICAgIH1cbiAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7XG4gICAgICBpZiAoc2VhbGVkKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHNlYWxlZCA9IHRydWU7XG5cbiAgICAgIHJlamVjdChwcm9taXNlLCByZWFzb24pO1xuICAgIH0sICdTZXR0bGU6ICcgKyAocHJvbWlzZS5fbGFiZWwgfHwgJyB1bmtub3duIHByb21pc2UnKSk7XG5cbiAgICBpZiAoIXNlYWxlZCAmJiBlcnJvcikge1xuICAgICAgc2VhbGVkID0gdHJ1ZTtcbiAgICAgIHJlamVjdChwcm9taXNlLCBlcnJvcik7XG4gICAgfVxuICB9LCBwcm9taXNlKTtcbn1cblxuZnVuY3Rpb24gaGFuZGxlT3duVGhlbmFibGUocHJvbWlzZSwgdGhlbmFibGUpIHtcbiAgaWYgKHRoZW5hYmxlLl9zdGF0ZSA9PT0gRlVMRklMTEVEKSB7XG4gICAgZnVsZmlsbChwcm9taXNlLCB0aGVuYWJsZS5fcmVzdWx0KTtcbiAgfSBlbHNlIGlmICh0aGVuYWJsZS5fc3RhdGUgPT09IFJFSkVDVEVEKSB7XG4gICAgcmVqZWN0KHByb21pc2UsIHRoZW5hYmxlLl9yZXN1bHQpO1xuICB9IGVsc2Uge1xuICAgIHN1YnNjcmliZSh0aGVuYWJsZSwgdW5kZWZpbmVkLCBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgIHJldHVybiByZXNvbHZlKHByb21pc2UsIHZhbHVlKTtcbiAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7XG4gICAgICByZXR1cm4gcmVqZWN0KHByb21pc2UsIHJlYXNvbik7XG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gaGFuZGxlTWF5YmVUaGVuYWJsZShwcm9taXNlLCBtYXliZVRoZW5hYmxlLCB0aGVuJCQxKSB7XG4gIGlmIChtYXliZVRoZW5hYmxlLmNvbnN0cnVjdG9yID09PSBwcm9taXNlLmNvbnN0cnVjdG9yICYmIHRoZW4kJDEgPT09IHRoZW4gJiYgbWF5YmVUaGVuYWJsZS5jb25zdHJ1Y3Rvci5yZXNvbHZlID09PSByZXNvbHZlJDEpIHtcbiAgICBoYW5kbGVPd25UaGVuYWJsZShwcm9taXNlLCBtYXliZVRoZW5hYmxlKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAodGhlbiQkMSA9PT0gR0VUX1RIRU5fRVJST1IpIHtcbiAgICAgIHJlamVjdChwcm9taXNlLCBHRVRfVEhFTl9FUlJPUi5lcnJvcik7XG4gICAgICBHRVRfVEhFTl9FUlJPUi5lcnJvciA9IG51bGw7XG4gICAgfSBlbHNlIGlmICh0aGVuJCQxID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGZ1bGZpbGwocHJvbWlzZSwgbWF5YmVUaGVuYWJsZSk7XG4gICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHRoZW4kJDEpKSB7XG4gICAgICBoYW5kbGVGb3JlaWduVGhlbmFibGUocHJvbWlzZSwgbWF5YmVUaGVuYWJsZSwgdGhlbiQkMSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZ1bGZpbGwocHJvbWlzZSwgbWF5YmVUaGVuYWJsZSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHJlc29sdmUocHJvbWlzZSwgdmFsdWUpIHtcbiAgaWYgKHByb21pc2UgPT09IHZhbHVlKSB7XG4gICAgcmVqZWN0KHByb21pc2UsIHNlbGZGdWxmaWxsbWVudCgpKTtcbiAgfSBlbHNlIGlmIChvYmplY3RPckZ1bmN0aW9uKHZhbHVlKSkge1xuICAgIGhhbmRsZU1heWJlVGhlbmFibGUocHJvbWlzZSwgdmFsdWUsIGdldFRoZW4odmFsdWUpKTtcbiAgfSBlbHNlIHtcbiAgICBmdWxmaWxsKHByb21pc2UsIHZhbHVlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwdWJsaXNoUmVqZWN0aW9uKHByb21pc2UpIHtcbiAgaWYgKHByb21pc2UuX29uZXJyb3IpIHtcbiAgICBwcm9taXNlLl9vbmVycm9yKHByb21pc2UuX3Jlc3VsdCk7XG4gIH1cblxuICBwdWJsaXNoKHByb21pc2UpO1xufVxuXG5mdW5jdGlvbiBmdWxmaWxsKHByb21pc2UsIHZhbHVlKSB7XG4gIGlmIChwcm9taXNlLl9zdGF0ZSAhPT0gUEVORElORykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHByb21pc2UuX3Jlc3VsdCA9IHZhbHVlO1xuICBwcm9taXNlLl9zdGF0ZSA9IEZVTEZJTExFRDtcblxuICBpZiAocHJvbWlzZS5fc3Vic2NyaWJlcnMubGVuZ3RoICE9PSAwKSB7XG4gICAgYXNhcChwdWJsaXNoLCBwcm9taXNlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZWplY3QocHJvbWlzZSwgcmVhc29uKSB7XG4gIGlmIChwcm9taXNlLl9zdGF0ZSAhPT0gUEVORElORykge1xuICAgIHJldHVybjtcbiAgfVxuICBwcm9taXNlLl9zdGF0ZSA9IFJFSkVDVEVEO1xuICBwcm9taXNlLl9yZXN1bHQgPSByZWFzb247XG5cbiAgYXNhcChwdWJsaXNoUmVqZWN0aW9uLCBwcm9taXNlKTtcbn1cblxuZnVuY3Rpb24gc3Vic2NyaWJlKHBhcmVudCwgY2hpbGQsIG9uRnVsZmlsbG1lbnQsIG9uUmVqZWN0aW9uKSB7XG4gIHZhciBfc3Vic2NyaWJlcnMgPSBwYXJlbnQuX3N1YnNjcmliZXJzO1xuICB2YXIgbGVuZ3RoID0gX3N1YnNjcmliZXJzLmxlbmd0aDtcblxuICBwYXJlbnQuX29uZXJyb3IgPSBudWxsO1xuXG4gIF9zdWJzY3JpYmVyc1tsZW5ndGhdID0gY2hpbGQ7XG4gIF9zdWJzY3JpYmVyc1tsZW5ndGggKyBGVUxGSUxMRURdID0gb25GdWxmaWxsbWVudDtcbiAgX3N1YnNjcmliZXJzW2xlbmd0aCArIFJFSkVDVEVEXSA9IG9uUmVqZWN0aW9uO1xuXG4gIGlmIChsZW5ndGggPT09IDAgJiYgcGFyZW50Ll9zdGF0ZSkge1xuICAgIGFzYXAocHVibGlzaCwgcGFyZW50KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwdWJsaXNoKHByb21pc2UpIHtcbiAgdmFyIHN1YnNjcmliZXJzID0gcHJvbWlzZS5fc3Vic2NyaWJlcnM7XG4gIHZhciBzZXR0bGVkID0gcHJvbWlzZS5fc3RhdGU7XG5cbiAgaWYgKHN1YnNjcmliZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHZhciBjaGlsZCA9IHVuZGVmaW5lZCxcbiAgICAgIGNhbGxiYWNrID0gdW5kZWZpbmVkLFxuICAgICAgZGV0YWlsID0gcHJvbWlzZS5fcmVzdWx0O1xuXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgc3Vic2NyaWJlcnMubGVuZ3RoOyBpICs9IDMpIHtcbiAgICBjaGlsZCA9IHN1YnNjcmliZXJzW2ldO1xuICAgIGNhbGxiYWNrID0gc3Vic2NyaWJlcnNbaSArIHNldHRsZWRdO1xuXG4gICAgaWYgKGNoaWxkKSB7XG4gICAgICBpbnZva2VDYWxsYmFjayhzZXR0bGVkLCBjaGlsZCwgY2FsbGJhY2ssIGRldGFpbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhbGxiYWNrKGRldGFpbCk7XG4gICAgfVxuICB9XG5cbiAgcHJvbWlzZS5fc3Vic2NyaWJlcnMubGVuZ3RoID0gMDtcbn1cblxuZnVuY3Rpb24gRXJyb3JPYmplY3QoKSB7XG4gIHRoaXMuZXJyb3IgPSBudWxsO1xufVxuXG52YXIgVFJZX0NBVENIX0VSUk9SID0gbmV3IEVycm9yT2JqZWN0KCk7XG5cbmZ1bmN0aW9uIHRyeUNhdGNoKGNhbGxiYWNrLCBkZXRhaWwpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gY2FsbGJhY2soZGV0YWlsKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIFRSWV9DQVRDSF9FUlJPUi5lcnJvciA9IGU7XG4gICAgcmV0dXJuIFRSWV9DQVRDSF9FUlJPUjtcbiAgfVxufVxuXG5mdW5jdGlvbiBpbnZva2VDYWxsYmFjayhzZXR0bGVkLCBwcm9taXNlLCBjYWxsYmFjaywgZGV0YWlsKSB7XG4gIHZhciBoYXNDYWxsYmFjayA9IGlzRnVuY3Rpb24oY2FsbGJhY2spLFxuICAgICAgdmFsdWUgPSB1bmRlZmluZWQsXG4gICAgICBlcnJvciA9IHVuZGVmaW5lZCxcbiAgICAgIHN1Y2NlZWRlZCA9IHVuZGVmaW5lZCxcbiAgICAgIGZhaWxlZCA9IHVuZGVmaW5lZDtcblxuICBpZiAoaGFzQ2FsbGJhY2spIHtcbiAgICB2YWx1ZSA9IHRyeUNhdGNoKGNhbGxiYWNrLCBkZXRhaWwpO1xuXG4gICAgaWYgKHZhbHVlID09PSBUUllfQ0FUQ0hfRVJST1IpIHtcbiAgICAgIGZhaWxlZCA9IHRydWU7XG4gICAgICBlcnJvciA9IHZhbHVlLmVycm9yO1xuICAgICAgdmFsdWUuZXJyb3IgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdWNjZWVkZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIGlmIChwcm9taXNlID09PSB2YWx1ZSkge1xuICAgICAgcmVqZWN0KHByb21pc2UsIGNhbm5vdFJldHVybk93bigpKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgdmFsdWUgPSBkZXRhaWw7XG4gICAgc3VjY2VlZGVkID0gdHJ1ZTtcbiAgfVxuXG4gIGlmIChwcm9taXNlLl9zdGF0ZSAhPT0gUEVORElORykge1xuICAgIC8vIG5vb3BcbiAgfSBlbHNlIGlmIChoYXNDYWxsYmFjayAmJiBzdWNjZWVkZWQpIHtcbiAgICAgIHJlc29sdmUocHJvbWlzZSwgdmFsdWUpO1xuICAgIH0gZWxzZSBpZiAoZmFpbGVkKSB7XG4gICAgICByZWplY3QocHJvbWlzZSwgZXJyb3IpO1xuICAgIH0gZWxzZSBpZiAoc2V0dGxlZCA9PT0gRlVMRklMTEVEKSB7XG4gICAgICBmdWxmaWxsKHByb21pc2UsIHZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKHNldHRsZWQgPT09IFJFSkVDVEVEKSB7XG4gICAgICByZWplY3QocHJvbWlzZSwgdmFsdWUpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gaW5pdGlhbGl6ZVByb21pc2UocHJvbWlzZSwgcmVzb2x2ZXIpIHtcbiAgdHJ5IHtcbiAgICByZXNvbHZlcihmdW5jdGlvbiByZXNvbHZlUHJvbWlzZSh2YWx1ZSkge1xuICAgICAgcmVzb2x2ZShwcm9taXNlLCB2YWx1ZSk7XG4gICAgfSwgZnVuY3Rpb24gcmVqZWN0UHJvbWlzZShyZWFzb24pIHtcbiAgICAgIHJlamVjdChwcm9taXNlLCByZWFzb24pO1xuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgcmVqZWN0KHByb21pc2UsIGUpO1xuICB9XG59XG5cbnZhciBpZCA9IDA7XG5mdW5jdGlvbiBuZXh0SWQoKSB7XG4gIHJldHVybiBpZCsrO1xufVxuXG5mdW5jdGlvbiBtYWtlUHJvbWlzZShwcm9taXNlKSB7XG4gIHByb21pc2VbUFJPTUlTRV9JRF0gPSBpZCsrO1xuICBwcm9taXNlLl9zdGF0ZSA9IHVuZGVmaW5lZDtcbiAgcHJvbWlzZS5fcmVzdWx0ID0gdW5kZWZpbmVkO1xuICBwcm9taXNlLl9zdWJzY3JpYmVycyA9IFtdO1xufVxuXG5mdW5jdGlvbiBFbnVtZXJhdG9yJDEoQ29uc3RydWN0b3IsIGlucHV0KSB7XG4gIHRoaXMuX2luc3RhbmNlQ29uc3RydWN0b3IgPSBDb25zdHJ1Y3RvcjtcbiAgdGhpcy5wcm9taXNlID0gbmV3IENvbnN0cnVjdG9yKG5vb3ApO1xuXG4gIGlmICghdGhpcy5wcm9taXNlW1BST01JU0VfSURdKSB7XG4gICAgbWFrZVByb21pc2UodGhpcy5wcm9taXNlKTtcbiAgfVxuXG4gIGlmIChpc0FycmF5KGlucHV0KSkge1xuICAgIHRoaXMubGVuZ3RoID0gaW5wdXQubGVuZ3RoO1xuICAgIHRoaXMuX3JlbWFpbmluZyA9IGlucHV0Lmxlbmd0aDtcblxuICAgIHRoaXMuX3Jlc3VsdCA9IG5ldyBBcnJheSh0aGlzLmxlbmd0aCk7XG5cbiAgICBpZiAodGhpcy5sZW5ndGggPT09IDApIHtcbiAgICAgIGZ1bGZpbGwodGhpcy5wcm9taXNlLCB0aGlzLl9yZXN1bHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxlbmd0aCA9IHRoaXMubGVuZ3RoIHx8IDA7XG4gICAgICB0aGlzLl9lbnVtZXJhdGUoaW5wdXQpO1xuICAgICAgaWYgKHRoaXMuX3JlbWFpbmluZyA9PT0gMCkge1xuICAgICAgICBmdWxmaWxsKHRoaXMucHJvbWlzZSwgdGhpcy5fcmVzdWx0KTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmVqZWN0KHRoaXMucHJvbWlzZSwgdmFsaWRhdGlvbkVycm9yKCkpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRpb25FcnJvcigpIHtcbiAgcmV0dXJuIG5ldyBFcnJvcignQXJyYXkgTWV0aG9kcyBtdXN0IGJlIHByb3ZpZGVkIGFuIEFycmF5Jyk7XG59XG5cbkVudW1lcmF0b3IkMS5wcm90b3R5cGUuX2VudW1lcmF0ZSA9IGZ1bmN0aW9uIChpbnB1dCkge1xuICBmb3IgKHZhciBpID0gMDsgdGhpcy5fc3RhdGUgPT09IFBFTkRJTkcgJiYgaSA8IGlucHV0Lmxlbmd0aDsgaSsrKSB7XG4gICAgdGhpcy5fZWFjaEVudHJ5KGlucHV0W2ldLCBpKTtcbiAgfVxufTtcblxuRW51bWVyYXRvciQxLnByb3RvdHlwZS5fZWFjaEVudHJ5ID0gZnVuY3Rpb24gKGVudHJ5LCBpKSB7XG4gIHZhciBjID0gdGhpcy5faW5zdGFuY2VDb25zdHJ1Y3RvcjtcbiAgdmFyIHJlc29sdmUkJDEgPSBjLnJlc29sdmU7XG5cbiAgaWYgKHJlc29sdmUkJDEgPT09IHJlc29sdmUkMSkge1xuICAgIHZhciBfdGhlbiA9IGdldFRoZW4oZW50cnkpO1xuXG4gICAgaWYgKF90aGVuID09PSB0aGVuICYmIGVudHJ5Ll9zdGF0ZSAhPT0gUEVORElORykge1xuICAgICAgdGhpcy5fc2V0dGxlZEF0KGVudHJ5Ll9zdGF0ZSwgaSwgZW50cnkuX3Jlc3VsdCk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgX3RoZW4gIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRoaXMuX3JlbWFpbmluZy0tO1xuICAgICAgdGhpcy5fcmVzdWx0W2ldID0gZW50cnk7XG4gICAgfSBlbHNlIGlmIChjID09PSBQcm9taXNlJDIpIHtcbiAgICAgIHZhciBwcm9taXNlID0gbmV3IGMobm9vcCk7XG4gICAgICBoYW5kbGVNYXliZVRoZW5hYmxlKHByb21pc2UsIGVudHJ5LCBfdGhlbik7XG4gICAgICB0aGlzLl93aWxsU2V0dGxlQXQocHJvbWlzZSwgaSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3dpbGxTZXR0bGVBdChuZXcgYyhmdW5jdGlvbiAocmVzb2x2ZSQkMSkge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZSQkMShlbnRyeSk7XG4gICAgICB9KSwgaSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHRoaXMuX3dpbGxTZXR0bGVBdChyZXNvbHZlJCQxKGVudHJ5KSwgaSk7XG4gIH1cbn07XG5cbkVudW1lcmF0b3IkMS5wcm90b3R5cGUuX3NldHRsZWRBdCA9IGZ1bmN0aW9uIChzdGF0ZSwgaSwgdmFsdWUpIHtcbiAgdmFyIHByb21pc2UgPSB0aGlzLnByb21pc2U7XG5cbiAgaWYgKHByb21pc2UuX3N0YXRlID09PSBQRU5ESU5HKSB7XG4gICAgdGhpcy5fcmVtYWluaW5nLS07XG5cbiAgICBpZiAoc3RhdGUgPT09IFJFSkVDVEVEKSB7XG4gICAgICByZWplY3QocHJvbWlzZSwgdmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9yZXN1bHRbaV0gPSB2YWx1ZTtcbiAgICB9XG4gIH1cblxuICBpZiAodGhpcy5fcmVtYWluaW5nID09PSAwKSB7XG4gICAgZnVsZmlsbChwcm9taXNlLCB0aGlzLl9yZXN1bHQpO1xuICB9XG59O1xuXG5FbnVtZXJhdG9yJDEucHJvdG90eXBlLl93aWxsU2V0dGxlQXQgPSBmdW5jdGlvbiAocHJvbWlzZSwgaSkge1xuICB2YXIgZW51bWVyYXRvciA9IHRoaXM7XG5cbiAgc3Vic2NyaWJlKHByb21pc2UsIHVuZGVmaW5lZCwgZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgcmV0dXJuIGVudW1lcmF0b3IuX3NldHRsZWRBdChGVUxGSUxMRUQsIGksIHZhbHVlKTtcbiAgfSwgZnVuY3Rpb24gKHJlYXNvbikge1xuICAgIHJldHVybiBlbnVtZXJhdG9yLl9zZXR0bGVkQXQoUkVKRUNURUQsIGksIHJlYXNvbik7XG4gIH0pO1xufTtcblxuLyoqXG4gIGBQcm9taXNlLmFsbGAgYWNjZXB0cyBhbiBhcnJheSBvZiBwcm9taXNlcywgYW5kIHJldHVybnMgYSBuZXcgcHJvbWlzZSB3aGljaFxuICBpcyBmdWxmaWxsZWQgd2l0aCBhbiBhcnJheSBvZiBmdWxmaWxsbWVudCB2YWx1ZXMgZm9yIHRoZSBwYXNzZWQgcHJvbWlzZXMsIG9yXG4gIHJlamVjdGVkIHdpdGggdGhlIHJlYXNvbiBvZiB0aGUgZmlyc3QgcGFzc2VkIHByb21pc2UgdG8gYmUgcmVqZWN0ZWQuIEl0IGNhc3RzIGFsbFxuICBlbGVtZW50cyBvZiB0aGUgcGFzc2VkIGl0ZXJhYmxlIHRvIHByb21pc2VzIGFzIGl0IHJ1bnMgdGhpcyBhbGdvcml0aG0uXG5cbiAgRXhhbXBsZTpcblxuICBgYGBqYXZhc2NyaXB0XG4gIGxldCBwcm9taXNlMSA9IHJlc29sdmUoMSk7XG4gIGxldCBwcm9taXNlMiA9IHJlc29sdmUoMik7XG4gIGxldCBwcm9taXNlMyA9IHJlc29sdmUoMyk7XG4gIGxldCBwcm9taXNlcyA9IFsgcHJvbWlzZTEsIHByb21pc2UyLCBwcm9taXNlMyBdO1xuXG4gIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uKGFycmF5KXtcbiAgICAvLyBUaGUgYXJyYXkgaGVyZSB3b3VsZCBiZSBbIDEsIDIsIDMgXTtcbiAgfSk7XG4gIGBgYFxuXG4gIElmIGFueSBvZiB0aGUgYHByb21pc2VzYCBnaXZlbiB0byBgYWxsYCBhcmUgcmVqZWN0ZWQsIHRoZSBmaXJzdCBwcm9taXNlXG4gIHRoYXQgaXMgcmVqZWN0ZWQgd2lsbCBiZSBnaXZlbiBhcyBhbiBhcmd1bWVudCB0byB0aGUgcmV0dXJuZWQgcHJvbWlzZXMnc1xuICByZWplY3Rpb24gaGFuZGxlci4gRm9yIGV4YW1wbGU6XG5cbiAgRXhhbXBsZTpcblxuICBgYGBqYXZhc2NyaXB0XG4gIGxldCBwcm9taXNlMSA9IHJlc29sdmUoMSk7XG4gIGxldCBwcm9taXNlMiA9IHJlamVjdChuZXcgRXJyb3IoXCIyXCIpKTtcbiAgbGV0IHByb21pc2UzID0gcmVqZWN0KG5ldyBFcnJvcihcIjNcIikpO1xuICBsZXQgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTtcblxuICBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbihmdW5jdGlvbihhcnJheSl7XG4gICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMgYmVjYXVzZSB0aGVyZSBhcmUgcmVqZWN0ZWQgcHJvbWlzZXMhXG4gIH0sIGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgLy8gZXJyb3IubWVzc2FnZSA9PT0gXCIyXCJcbiAgfSk7XG4gIGBgYFxuXG4gIEBtZXRob2QgYWxsXG4gIEBzdGF0aWNcbiAgQHBhcmFtIHtBcnJheX0gZW50cmllcyBhcnJheSBvZiBwcm9taXNlc1xuICBAcGFyYW0ge1N0cmluZ30gbGFiZWwgb3B0aW9uYWwgc3RyaW5nIGZvciBsYWJlbGluZyB0aGUgcHJvbWlzZS5cbiAgVXNlZnVsIGZvciB0b29saW5nLlxuICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdoZW4gYWxsIGBwcm9taXNlc2AgaGF2ZSBiZWVuXG4gIGZ1bGZpbGxlZCwgb3IgcmVqZWN0ZWQgaWYgYW55IG9mIHRoZW0gYmVjb21lIHJlamVjdGVkLlxuICBAc3RhdGljXG4qL1xuZnVuY3Rpb24gYWxsJDEoZW50cmllcykge1xuICByZXR1cm4gbmV3IEVudW1lcmF0b3IkMSh0aGlzLCBlbnRyaWVzKS5wcm9taXNlO1xufVxuXG4vKipcbiAgYFByb21pc2UucmFjZWAgcmV0dXJucyBhIG5ldyBwcm9taXNlIHdoaWNoIGlzIHNldHRsZWQgaW4gdGhlIHNhbWUgd2F5IGFzIHRoZVxuICBmaXJzdCBwYXNzZWQgcHJvbWlzZSB0byBzZXR0bGUuXG5cbiAgRXhhbXBsZTpcblxuICBgYGBqYXZhc2NyaXB0XG4gIGxldCBwcm9taXNlMSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7XG4gICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgcmVzb2x2ZSgncHJvbWlzZSAxJyk7XG4gICAgfSwgMjAwKTtcbiAgfSk7XG5cbiAgbGV0IHByb21pc2UyID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXtcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICByZXNvbHZlKCdwcm9taXNlIDInKTtcbiAgICB9LCAxMDApO1xuICB9KTtcblxuICBQcm9taXNlLnJhY2UoW3Byb21pc2UxLCBwcm9taXNlMl0pLnRoZW4oZnVuY3Rpb24ocmVzdWx0KXtcbiAgICAvLyByZXN1bHQgPT09ICdwcm9taXNlIDInIGJlY2F1c2UgaXQgd2FzIHJlc29sdmVkIGJlZm9yZSBwcm9taXNlMVxuICAgIC8vIHdhcyByZXNvbHZlZC5cbiAgfSk7XG4gIGBgYFxuXG4gIGBQcm9taXNlLnJhY2VgIGlzIGRldGVybWluaXN0aWMgaW4gdGhhdCBvbmx5IHRoZSBzdGF0ZSBvZiB0aGUgZmlyc3RcbiAgc2V0dGxlZCBwcm9taXNlIG1hdHRlcnMuIEZvciBleGFtcGxlLCBldmVuIGlmIG90aGVyIHByb21pc2VzIGdpdmVuIHRvIHRoZVxuICBgcHJvbWlzZXNgIGFycmF5IGFyZ3VtZW50IGFyZSByZXNvbHZlZCwgYnV0IHRoZSBmaXJzdCBzZXR0bGVkIHByb21pc2UgaGFzXG4gIGJlY29tZSByZWplY3RlZCBiZWZvcmUgdGhlIG90aGVyIHByb21pc2VzIGJlY2FtZSBmdWxmaWxsZWQsIHRoZSByZXR1cm5lZFxuICBwcm9taXNlIHdpbGwgYmVjb21lIHJlamVjdGVkOlxuXG4gIGBgYGphdmFzY3JpcHRcbiAgbGV0IHByb21pc2UxID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXtcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICByZXNvbHZlKCdwcm9taXNlIDEnKTtcbiAgICB9LCAyMDApO1xuICB9KTtcblxuICBsZXQgcHJvbWlzZTIgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3Qpe1xuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoJ3Byb21pc2UgMicpKTtcbiAgICB9LCAxMDApO1xuICB9KTtcblxuICBQcm9taXNlLnJhY2UoW3Byb21pc2UxLCBwcm9taXNlMl0pLnRoZW4oZnVuY3Rpb24ocmVzdWx0KXtcbiAgICAvLyBDb2RlIGhlcmUgbmV2ZXIgcnVuc1xuICB9LCBmdW5jdGlvbihyZWFzb24pe1xuICAgIC8vIHJlYXNvbi5tZXNzYWdlID09PSAncHJvbWlzZSAyJyBiZWNhdXNlIHByb21pc2UgMiBiZWNhbWUgcmVqZWN0ZWQgYmVmb3JlXG4gICAgLy8gcHJvbWlzZSAxIGJlY2FtZSBmdWxmaWxsZWRcbiAgfSk7XG4gIGBgYFxuXG4gIEFuIGV4YW1wbGUgcmVhbC13b3JsZCB1c2UgY2FzZSBpcyBpbXBsZW1lbnRpbmcgdGltZW91dHM6XG5cbiAgYGBgamF2YXNjcmlwdFxuICBQcm9taXNlLnJhY2UoW2FqYXgoJ2Zvby5qc29uJyksIHRpbWVvdXQoNTAwMCldKVxuICBgYGBcblxuICBAbWV0aG9kIHJhY2VcbiAgQHN0YXRpY1xuICBAcGFyYW0ge0FycmF5fSBwcm9taXNlcyBhcnJheSBvZiBwcm9taXNlcyB0byBvYnNlcnZlXG4gIFVzZWZ1bCBmb3IgdG9vbGluZy5cbiAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHdoaWNoIHNldHRsZXMgaW4gdGhlIHNhbWUgd2F5IGFzIHRoZSBmaXJzdCBwYXNzZWRcbiAgcHJvbWlzZSB0byBzZXR0bGUuXG4qL1xuZnVuY3Rpb24gcmFjZSQxKGVudHJpZXMpIHtcbiAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgdmFyIENvbnN0cnVjdG9yID0gdGhpcztcblxuICBpZiAoIWlzQXJyYXkoZW50cmllcykpIHtcbiAgICByZXR1cm4gbmV3IENvbnN0cnVjdG9yKGZ1bmN0aW9uIChfLCByZWplY3QpIHtcbiAgICAgIHJldHVybiByZWplY3QobmV3IFR5cGVFcnJvcignWW91IG11c3QgcGFzcyBhbiBhcnJheSB0byByYWNlLicpKTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbmV3IENvbnN0cnVjdG9yKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIHZhciBsZW5ndGggPSBlbnRyaWVzLmxlbmd0aDtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgICAgQ29uc3RydWN0b3IucmVzb2x2ZShlbnRyaWVzW2ldKS50aGVuKHJlc29sdmUsIHJlamVjdCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxuLyoqXG4gIGBQcm9taXNlLnJlamVjdGAgcmV0dXJucyBhIHByb21pc2UgcmVqZWN0ZWQgd2l0aCB0aGUgcGFzc2VkIGByZWFzb25gLlxuICBJdCBpcyBzaG9ydGhhbmQgZm9yIHRoZSBmb2xsb3dpbmc6XG5cbiAgYGBgamF2YXNjcmlwdFxuICBsZXQgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7XG4gICAgcmVqZWN0KG5ldyBFcnJvcignV0hPT1BTJykpO1xuICB9KTtcblxuICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpe1xuICAgIC8vIENvZGUgaGVyZSBkb2Vzbid0IHJ1biBiZWNhdXNlIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkIVxuICB9LCBmdW5jdGlvbihyZWFzb24pe1xuICAgIC8vIHJlYXNvbi5tZXNzYWdlID09PSAnV0hPT1BTJ1xuICB9KTtcbiAgYGBgXG5cbiAgSW5zdGVhZCBvZiB3cml0aW5nIHRoZSBhYm92ZSwgeW91ciBjb2RlIG5vdyBzaW1wbHkgYmVjb21lcyB0aGUgZm9sbG93aW5nOlxuXG4gIGBgYGphdmFzY3JpcHRcbiAgbGV0IHByb21pc2UgPSBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ1dIT09QUycpKTtcblxuICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpe1xuICAgIC8vIENvZGUgaGVyZSBkb2Vzbid0IHJ1biBiZWNhdXNlIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkIVxuICB9LCBmdW5jdGlvbihyZWFzb24pe1xuICAgIC8vIHJlYXNvbi5tZXNzYWdlID09PSAnV0hPT1BTJ1xuICB9KTtcbiAgYGBgXG5cbiAgQG1ldGhvZCByZWplY3RcbiAgQHN0YXRpY1xuICBAcGFyYW0ge0FueX0gcmVhc29uIHZhbHVlIHRoYXQgdGhlIHJldHVybmVkIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCB3aXRoLlxuICBVc2VmdWwgZm9yIHRvb2xpbmcuXG4gIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSByZWplY3RlZCB3aXRoIHRoZSBnaXZlbiBgcmVhc29uYC5cbiovXG5mdW5jdGlvbiByZWplY3QkMShyZWFzb24pIHtcbiAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgdmFyIENvbnN0cnVjdG9yID0gdGhpcztcbiAgdmFyIHByb21pc2UgPSBuZXcgQ29uc3RydWN0b3Iobm9vcCk7XG4gIHJlamVjdChwcm9taXNlLCByZWFzb24pO1xuICByZXR1cm4gcHJvbWlzZTtcbn1cblxuZnVuY3Rpb24gbmVlZHNSZXNvbHZlcigpIHtcbiAgdGhyb3cgbmV3IFR5cGVFcnJvcignWW91IG11c3QgcGFzcyBhIHJlc29sdmVyIGZ1bmN0aW9uIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byB0aGUgcHJvbWlzZSBjb25zdHJ1Y3RvcicpO1xufVxuXG5mdW5jdGlvbiBuZWVkc05ldygpIHtcbiAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkZhaWxlZCB0byBjb25zdHJ1Y3QgJ1Byb21pc2UnOiBQbGVhc2UgdXNlIHRoZSAnbmV3JyBvcGVyYXRvciwgdGhpcyBvYmplY3QgY29uc3RydWN0b3IgY2Fubm90IGJlIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLlwiKTtcbn1cblxuLyoqXG4gIFByb21pc2Ugb2JqZWN0cyByZXByZXNlbnQgdGhlIGV2ZW50dWFsIHJlc3VsdCBvZiBhbiBhc3luY2hyb25vdXMgb3BlcmF0aW9uLiBUaGVcbiAgcHJpbWFyeSB3YXkgb2YgaW50ZXJhY3Rpbmcgd2l0aCBhIHByb21pc2UgaXMgdGhyb3VnaCBpdHMgYHRoZW5gIG1ldGhvZCwgd2hpY2hcbiAgcmVnaXN0ZXJzIGNhbGxiYWNrcyB0byByZWNlaXZlIGVpdGhlciBhIHByb21pc2UncyBldmVudHVhbCB2YWx1ZSBvciB0aGUgcmVhc29uXG4gIHdoeSB0aGUgcHJvbWlzZSBjYW5ub3QgYmUgZnVsZmlsbGVkLlxuXG4gIFRlcm1pbm9sb2d5XG4gIC0tLS0tLS0tLS0tXG5cbiAgLSBgcHJvbWlzZWAgaXMgYW4gb2JqZWN0IG9yIGZ1bmN0aW9uIHdpdGggYSBgdGhlbmAgbWV0aG9kIHdob3NlIGJlaGF2aW9yIGNvbmZvcm1zIHRvIHRoaXMgc3BlY2lmaWNhdGlvbi5cbiAgLSBgdGhlbmFibGVgIGlzIGFuIG9iamVjdCBvciBmdW5jdGlvbiB0aGF0IGRlZmluZXMgYSBgdGhlbmAgbWV0aG9kLlxuICAtIGB2YWx1ZWAgaXMgYW55IGxlZ2FsIEphdmFTY3JpcHQgdmFsdWUgKGluY2x1ZGluZyB1bmRlZmluZWQsIGEgdGhlbmFibGUsIG9yIGEgcHJvbWlzZSkuXG4gIC0gYGV4Y2VwdGlvbmAgaXMgYSB2YWx1ZSB0aGF0IGlzIHRocm93biB1c2luZyB0aGUgdGhyb3cgc3RhdGVtZW50LlxuICAtIGByZWFzb25gIGlzIGEgdmFsdWUgdGhhdCBpbmRpY2F0ZXMgd2h5IGEgcHJvbWlzZSB3YXMgcmVqZWN0ZWQuXG4gIC0gYHNldHRsZWRgIHRoZSBmaW5hbCByZXN0aW5nIHN0YXRlIG9mIGEgcHJvbWlzZSwgZnVsZmlsbGVkIG9yIHJlamVjdGVkLlxuXG4gIEEgcHJvbWlzZSBjYW4gYmUgaW4gb25lIG9mIHRocmVlIHN0YXRlczogcGVuZGluZywgZnVsZmlsbGVkLCBvciByZWplY3RlZC5cblxuICBQcm9taXNlcyB0aGF0IGFyZSBmdWxmaWxsZWQgaGF2ZSBhIGZ1bGZpbGxtZW50IHZhbHVlIGFuZCBhcmUgaW4gdGhlIGZ1bGZpbGxlZFxuICBzdGF0ZS4gIFByb21pc2VzIHRoYXQgYXJlIHJlamVjdGVkIGhhdmUgYSByZWplY3Rpb24gcmVhc29uIGFuZCBhcmUgaW4gdGhlXG4gIHJlamVjdGVkIHN0YXRlLiAgQSBmdWxmaWxsbWVudCB2YWx1ZSBpcyBuZXZlciBhIHRoZW5hYmxlLlxuXG4gIFByb21pc2VzIGNhbiBhbHNvIGJlIHNhaWQgdG8gKnJlc29sdmUqIGEgdmFsdWUuICBJZiB0aGlzIHZhbHVlIGlzIGFsc28gYVxuICBwcm9taXNlLCB0aGVuIHRoZSBvcmlnaW5hbCBwcm9taXNlJ3Mgc2V0dGxlZCBzdGF0ZSB3aWxsIG1hdGNoIHRoZSB2YWx1ZSdzXG4gIHNldHRsZWQgc3RhdGUuICBTbyBhIHByb21pc2UgdGhhdCAqcmVzb2x2ZXMqIGEgcHJvbWlzZSB0aGF0IHJlamVjdHMgd2lsbFxuICBpdHNlbGYgcmVqZWN0LCBhbmQgYSBwcm9taXNlIHRoYXQgKnJlc29sdmVzKiBhIHByb21pc2UgdGhhdCBmdWxmaWxscyB3aWxsXG4gIGl0c2VsZiBmdWxmaWxsLlxuXG5cbiAgQmFzaWMgVXNhZ2U6XG4gIC0tLS0tLS0tLS0tLVxuXG4gIGBgYGpzXG4gIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgLy8gb24gc3VjY2Vzc1xuICAgIHJlc29sdmUodmFsdWUpO1xuXG4gICAgLy8gb24gZmFpbHVyZVxuICAgIHJlamVjdChyZWFzb24pO1xuICB9KTtcblxuICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpIHtcbiAgICAvLyBvbiBmdWxmaWxsbWVudFxuICB9LCBmdW5jdGlvbihyZWFzb24pIHtcbiAgICAvLyBvbiByZWplY3Rpb25cbiAgfSk7XG4gIGBgYFxuXG4gIEFkdmFuY2VkIFVzYWdlOlxuICAtLS0tLS0tLS0tLS0tLS1cblxuICBQcm9taXNlcyBzaGluZSB3aGVuIGFic3RyYWN0aW5nIGF3YXkgYXN5bmNocm9ub3VzIGludGVyYWN0aW9ucyBzdWNoIGFzXG4gIGBYTUxIdHRwUmVxdWVzdGBzLlxuXG4gIGBgYGpzXG4gIGZ1bmN0aW9uIGdldEpTT04odXJsKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7XG4gICAgICBsZXQgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG5cbiAgICAgIHhoci5vcGVuKCdHRVQnLCB1cmwpO1xuICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGhhbmRsZXI7XG4gICAgICB4aHIucmVzcG9uc2VUeXBlID0gJ2pzb24nO1xuICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0FjY2VwdCcsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgICB4aHIuc2VuZCgpO1xuXG4gICAgICBmdW5jdGlvbiBoYW5kbGVyKCkge1xuICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLkRPTkUpIHtcbiAgICAgICAgICBpZiAodGhpcy5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLnJlc3BvbnNlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignZ2V0SlNPTjogYCcgKyB1cmwgKyAnYCBmYWlsZWQgd2l0aCBzdGF0dXM6IFsnICsgdGhpcy5zdGF0dXMgKyAnXScpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBnZXRKU09OKCcvcG9zdHMuanNvbicpLnRoZW4oZnVuY3Rpb24oanNvbikge1xuICAgIC8vIG9uIGZ1bGZpbGxtZW50XG4gIH0sIGZ1bmN0aW9uKHJlYXNvbikge1xuICAgIC8vIG9uIHJlamVjdGlvblxuICB9KTtcbiAgYGBgXG5cbiAgVW5saWtlIGNhbGxiYWNrcywgcHJvbWlzZXMgYXJlIGdyZWF0IGNvbXBvc2FibGUgcHJpbWl0aXZlcy5cblxuICBgYGBqc1xuICBQcm9taXNlLmFsbChbXG4gICAgZ2V0SlNPTignL3Bvc3RzJyksXG4gICAgZ2V0SlNPTignL2NvbW1lbnRzJylcbiAgXSkudGhlbihmdW5jdGlvbih2YWx1ZXMpe1xuICAgIHZhbHVlc1swXSAvLyA9PiBwb3N0c0pTT05cbiAgICB2YWx1ZXNbMV0gLy8gPT4gY29tbWVudHNKU09OXG5cbiAgICByZXR1cm4gdmFsdWVzO1xuICB9KTtcbiAgYGBgXG5cbiAgQGNsYXNzIFByb21pc2VcbiAgQHBhcmFtIHtmdW5jdGlvbn0gcmVzb2x2ZXJcbiAgVXNlZnVsIGZvciB0b29saW5nLlxuICBAY29uc3RydWN0b3JcbiovXG5mdW5jdGlvbiBQcm9taXNlJDIocmVzb2x2ZXIpIHtcbiAgdGhpc1tQUk9NSVNFX0lEXSA9IG5leHRJZCgpO1xuICB0aGlzLl9yZXN1bHQgPSB0aGlzLl9zdGF0ZSA9IHVuZGVmaW5lZDtcbiAgdGhpcy5fc3Vic2NyaWJlcnMgPSBbXTtcblxuICBpZiAobm9vcCAhPT0gcmVzb2x2ZXIpIHtcbiAgICB0eXBlb2YgcmVzb2x2ZXIgIT09ICdmdW5jdGlvbicgJiYgbmVlZHNSZXNvbHZlcigpO1xuICAgIHRoaXMgaW5zdGFuY2VvZiBQcm9taXNlJDIgPyBpbml0aWFsaXplUHJvbWlzZSh0aGlzLCByZXNvbHZlcikgOiBuZWVkc05ldygpO1xuICB9XG59XG5cblByb21pc2UkMi5hbGwgPSBhbGwkMTtcblByb21pc2UkMi5yYWNlID0gcmFjZSQxO1xuUHJvbWlzZSQyLnJlc29sdmUgPSByZXNvbHZlJDE7XG5Qcm9taXNlJDIucmVqZWN0ID0gcmVqZWN0JDE7XG5Qcm9taXNlJDIuX3NldFNjaGVkdWxlciA9IHNldFNjaGVkdWxlcjtcblByb21pc2UkMi5fc2V0QXNhcCA9IHNldEFzYXA7XG5Qcm9taXNlJDIuX2FzYXAgPSBhc2FwO1xuXG5Qcm9taXNlJDIucHJvdG90eXBlID0ge1xuICBjb25zdHJ1Y3RvcjogUHJvbWlzZSQyLFxuXG4gIC8qKlxuICAgIFRoZSBwcmltYXJ5IHdheSBvZiBpbnRlcmFjdGluZyB3aXRoIGEgcHJvbWlzZSBpcyB0aHJvdWdoIGl0cyBgdGhlbmAgbWV0aG9kLFxuICAgIHdoaWNoIHJlZ2lzdGVycyBjYWxsYmFja3MgdG8gcmVjZWl2ZSBlaXRoZXIgYSBwcm9taXNlJ3MgZXZlbnR1YWwgdmFsdWUgb3IgdGhlXG4gICAgcmVhc29uIHdoeSB0aGUgcHJvbWlzZSBjYW5ub3QgYmUgZnVsZmlsbGVkLlxuICBcbiAgICBgYGBqc1xuICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbih1c2VyKXtcbiAgICAgIC8vIHVzZXIgaXMgYXZhaWxhYmxlXG4gICAgfSwgZnVuY3Rpb24ocmVhc29uKXtcbiAgICAgIC8vIHVzZXIgaXMgdW5hdmFpbGFibGUsIGFuZCB5b3UgYXJlIGdpdmVuIHRoZSByZWFzb24gd2h5XG4gICAgfSk7XG4gICAgYGBgXG4gIFxuICAgIENoYWluaW5nXG4gICAgLS0tLS0tLS1cbiAgXG4gICAgVGhlIHJldHVybiB2YWx1ZSBvZiBgdGhlbmAgaXMgaXRzZWxmIGEgcHJvbWlzZS4gIFRoaXMgc2Vjb25kLCAnZG93bnN0cmVhbSdcbiAgICBwcm9taXNlIGlzIHJlc29sdmVkIHdpdGggdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZmlyc3QgcHJvbWlzZSdzIGZ1bGZpbGxtZW50XG4gICAgb3IgcmVqZWN0aW9uIGhhbmRsZXIsIG9yIHJlamVjdGVkIGlmIHRoZSBoYW5kbGVyIHRocm93cyBhbiBleGNlcHRpb24uXG4gIFxuICAgIGBgYGpzXG4gICAgZmluZFVzZXIoKS50aGVuKGZ1bmN0aW9uICh1c2VyKSB7XG4gICAgICByZXR1cm4gdXNlci5uYW1lO1xuICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHtcbiAgICAgIHJldHVybiAnZGVmYXVsdCBuYW1lJztcbiAgICB9KS50aGVuKGZ1bmN0aW9uICh1c2VyTmFtZSkge1xuICAgICAgLy8gSWYgYGZpbmRVc2VyYCBmdWxmaWxsZWQsIGB1c2VyTmFtZWAgd2lsbCBiZSB0aGUgdXNlcidzIG5hbWUsIG90aGVyd2lzZSBpdFxuICAgICAgLy8gd2lsbCBiZSBgJ2RlZmF1bHQgbmFtZSdgXG4gICAgfSk7XG4gIFxuICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbiAodXNlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdGb3VuZCB1c2VyLCBidXQgc3RpbGwgdW5oYXBweScpO1xuICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignYGZpbmRVc2VyYCByZWplY3RlZCBhbmQgd2UncmUgdW5oYXBweScpO1xuICAgIH0pLnRoZW4oZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAvLyBuZXZlciByZWFjaGVkXG4gICAgfSwgZnVuY3Rpb24gKHJlYXNvbikge1xuICAgICAgLy8gaWYgYGZpbmRVc2VyYCBmdWxmaWxsZWQsIGByZWFzb25gIHdpbGwgYmUgJ0ZvdW5kIHVzZXIsIGJ1dCBzdGlsbCB1bmhhcHB5Jy5cbiAgICAgIC8vIElmIGBmaW5kVXNlcmAgcmVqZWN0ZWQsIGByZWFzb25gIHdpbGwgYmUgJ2BmaW5kVXNlcmAgcmVqZWN0ZWQgYW5kIHdlJ3JlIHVuaGFwcHknLlxuICAgIH0pO1xuICAgIGBgYFxuICAgIElmIHRoZSBkb3duc3RyZWFtIHByb21pc2UgZG9lcyBub3Qgc3BlY2lmeSBhIHJlamVjdGlvbiBoYW5kbGVyLCByZWplY3Rpb24gcmVhc29ucyB3aWxsIGJlIHByb3BhZ2F0ZWQgZnVydGhlciBkb3duc3RyZWFtLlxuICBcbiAgICBgYGBqc1xuICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbiAodXNlcikge1xuICAgICAgdGhyb3cgbmV3IFBlZGFnb2dpY2FsRXhjZXB0aW9uKCdVcHN0cmVhbSBlcnJvcicpO1xuICAgIH0pLnRoZW4oZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAvLyBuZXZlciByZWFjaGVkXG4gICAgfSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgIC8vIG5ldmVyIHJlYWNoZWRcbiAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7XG4gICAgICAvLyBUaGUgYFBlZGdhZ29jaWFsRXhjZXB0aW9uYCBpcyBwcm9wYWdhdGVkIGFsbCB0aGUgd2F5IGRvd24gdG8gaGVyZVxuICAgIH0pO1xuICAgIGBgYFxuICBcbiAgICBBc3NpbWlsYXRpb25cbiAgICAtLS0tLS0tLS0tLS1cbiAgXG4gICAgU29tZXRpbWVzIHRoZSB2YWx1ZSB5b3Ugd2FudCB0byBwcm9wYWdhdGUgdG8gYSBkb3duc3RyZWFtIHByb21pc2UgY2FuIG9ubHkgYmVcbiAgICByZXRyaWV2ZWQgYXN5bmNocm9ub3VzbHkuIFRoaXMgY2FuIGJlIGFjaGlldmVkIGJ5IHJldHVybmluZyBhIHByb21pc2UgaW4gdGhlXG4gICAgZnVsZmlsbG1lbnQgb3IgcmVqZWN0aW9uIGhhbmRsZXIuIFRoZSBkb3duc3RyZWFtIHByb21pc2Ugd2lsbCB0aGVuIGJlIHBlbmRpbmdcbiAgICB1bnRpbCB0aGUgcmV0dXJuZWQgcHJvbWlzZSBpcyBzZXR0bGVkLiBUaGlzIGlzIGNhbGxlZCAqYXNzaW1pbGF0aW9uKi5cbiAgXG4gICAgYGBganNcbiAgICBmaW5kVXNlcigpLnRoZW4oZnVuY3Rpb24gKHVzZXIpIHtcbiAgICAgIHJldHVybiBmaW5kQ29tbWVudHNCeUF1dGhvcih1c2VyKTtcbiAgICB9KS50aGVuKGZ1bmN0aW9uIChjb21tZW50cykge1xuICAgICAgLy8gVGhlIHVzZXIncyBjb21tZW50cyBhcmUgbm93IGF2YWlsYWJsZVxuICAgIH0pO1xuICAgIGBgYFxuICBcbiAgICBJZiB0aGUgYXNzaW1saWF0ZWQgcHJvbWlzZSByZWplY3RzLCB0aGVuIHRoZSBkb3duc3RyZWFtIHByb21pc2Ugd2lsbCBhbHNvIHJlamVjdC5cbiAgXG4gICAgYGBganNcbiAgICBmaW5kVXNlcigpLnRoZW4oZnVuY3Rpb24gKHVzZXIpIHtcbiAgICAgIHJldHVybiBmaW5kQ29tbWVudHNCeUF1dGhvcih1c2VyKTtcbiAgICB9KS50aGVuKGZ1bmN0aW9uIChjb21tZW50cykge1xuICAgICAgLy8gSWYgYGZpbmRDb21tZW50c0J5QXV0aG9yYCBmdWxmaWxscywgd2UnbGwgaGF2ZSB0aGUgdmFsdWUgaGVyZVxuICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHtcbiAgICAgIC8vIElmIGBmaW5kQ29tbWVudHNCeUF1dGhvcmAgcmVqZWN0cywgd2UnbGwgaGF2ZSB0aGUgcmVhc29uIGhlcmVcbiAgICB9KTtcbiAgICBgYGBcbiAgXG4gICAgU2ltcGxlIEV4YW1wbGVcbiAgICAtLS0tLS0tLS0tLS0tLVxuICBcbiAgICBTeW5jaHJvbm91cyBFeGFtcGxlXG4gIFxuICAgIGBgYGphdmFzY3JpcHRcbiAgICBsZXQgcmVzdWx0O1xuICBcbiAgICB0cnkge1xuICAgICAgcmVzdWx0ID0gZmluZFJlc3VsdCgpO1xuICAgICAgLy8gc3VjY2Vzc1xuICAgIH0gY2F0Y2gocmVhc29uKSB7XG4gICAgICAvLyBmYWlsdXJlXG4gICAgfVxuICAgIGBgYFxuICBcbiAgICBFcnJiYWNrIEV4YW1wbGVcbiAgXG4gICAgYGBganNcbiAgICBmaW5kUmVzdWx0KGZ1bmN0aW9uKHJlc3VsdCwgZXJyKXtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgLy8gZmFpbHVyZVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gc3VjY2Vzc1xuICAgICAgfVxuICAgIH0pO1xuICAgIGBgYFxuICBcbiAgICBQcm9taXNlIEV4YW1wbGU7XG4gIFxuICAgIGBgYGphdmFzY3JpcHRcbiAgICBmaW5kUmVzdWx0KCkudGhlbihmdW5jdGlvbihyZXN1bHQpe1xuICAgICAgLy8gc3VjY2Vzc1xuICAgIH0sIGZ1bmN0aW9uKHJlYXNvbil7XG4gICAgICAvLyBmYWlsdXJlXG4gICAgfSk7XG4gICAgYGBgXG4gIFxuICAgIEFkdmFuY2VkIEV4YW1wbGVcbiAgICAtLS0tLS0tLS0tLS0tLVxuICBcbiAgICBTeW5jaHJvbm91cyBFeGFtcGxlXG4gIFxuICAgIGBgYGphdmFzY3JpcHRcbiAgICBsZXQgYXV0aG9yLCBib29rcztcbiAgXG4gICAgdHJ5IHtcbiAgICAgIGF1dGhvciA9IGZpbmRBdXRob3IoKTtcbiAgICAgIGJvb2tzICA9IGZpbmRCb29rc0J5QXV0aG9yKGF1dGhvcik7XG4gICAgICAvLyBzdWNjZXNzXG4gICAgfSBjYXRjaChyZWFzb24pIHtcbiAgICAgIC8vIGZhaWx1cmVcbiAgICB9XG4gICAgYGBgXG4gIFxuICAgIEVycmJhY2sgRXhhbXBsZVxuICBcbiAgICBgYGBqc1xuICBcbiAgICBmdW5jdGlvbiBmb3VuZEJvb2tzKGJvb2tzKSB7XG4gIFxuICAgIH1cbiAgXG4gICAgZnVuY3Rpb24gZmFpbHVyZShyZWFzb24pIHtcbiAgXG4gICAgfVxuICBcbiAgICBmaW5kQXV0aG9yKGZ1bmN0aW9uKGF1dGhvciwgZXJyKXtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgZmFpbHVyZShlcnIpO1xuICAgICAgICAvLyBmYWlsdXJlXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGZpbmRCb29va3NCeUF1dGhvcihhdXRob3IsIGZ1bmN0aW9uKGJvb2tzLCBlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgZmFpbHVyZShlcnIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBmb3VuZEJvb2tzKGJvb2tzKTtcbiAgICAgICAgICAgICAgfSBjYXRjaChyZWFzb24pIHtcbiAgICAgICAgICAgICAgICBmYWlsdXJlKHJlYXNvbik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaChlcnJvcikge1xuICAgICAgICAgIGZhaWx1cmUoZXJyKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBzdWNjZXNzXG4gICAgICB9XG4gICAgfSk7XG4gICAgYGBgXG4gIFxuICAgIFByb21pc2UgRXhhbXBsZTtcbiAgXG4gICAgYGBgamF2YXNjcmlwdFxuICAgIGZpbmRBdXRob3IoKS5cbiAgICAgIHRoZW4oZmluZEJvb2tzQnlBdXRob3IpLlxuICAgICAgdGhlbihmdW5jdGlvbihib29rcyl7XG4gICAgICAgIC8vIGZvdW5kIGJvb2tzXG4gICAgfSkuY2F0Y2goZnVuY3Rpb24ocmVhc29uKXtcbiAgICAgIC8vIHNvbWV0aGluZyB3ZW50IHdyb25nXG4gICAgfSk7XG4gICAgYGBgXG4gIFxuICAgIEBtZXRob2QgdGhlblxuICAgIEBwYXJhbSB7RnVuY3Rpb259IG9uRnVsZmlsbGVkXG4gICAgQHBhcmFtIHtGdW5jdGlvbn0gb25SZWplY3RlZFxuICAgIFVzZWZ1bCBmb3IgdG9vbGluZy5cbiAgICBAcmV0dXJuIHtQcm9taXNlfVxuICAqL1xuICB0aGVuOiB0aGVuLFxuXG4gIC8qKlxuICAgIGBjYXRjaGAgaXMgc2ltcGx5IHN1Z2FyIGZvciBgdGhlbih1bmRlZmluZWQsIG9uUmVqZWN0aW9uKWAgd2hpY2ggbWFrZXMgaXQgdGhlIHNhbWVcbiAgICBhcyB0aGUgY2F0Y2ggYmxvY2sgb2YgYSB0cnkvY2F0Y2ggc3RhdGVtZW50LlxuICBcbiAgICBgYGBqc1xuICAgIGZ1bmN0aW9uIGZpbmRBdXRob3IoKXtcbiAgICAgIHRocm93IG5ldyBFcnJvcignY291bGRuJ3QgZmluZCB0aGF0IGF1dGhvcicpO1xuICAgIH1cbiAgXG4gICAgLy8gc3luY2hyb25vdXNcbiAgICB0cnkge1xuICAgICAgZmluZEF1dGhvcigpO1xuICAgIH0gY2F0Y2gocmVhc29uKSB7XG4gICAgICAvLyBzb21ldGhpbmcgd2VudCB3cm9uZ1xuICAgIH1cbiAgXG4gICAgLy8gYXN5bmMgd2l0aCBwcm9taXNlc1xuICAgIGZpbmRBdXRob3IoKS5jYXRjaChmdW5jdGlvbihyZWFzb24pe1xuICAgICAgLy8gc29tZXRoaW5nIHdlbnQgd3JvbmdcbiAgICB9KTtcbiAgICBgYGBcbiAgXG4gICAgQG1ldGhvZCBjYXRjaFxuICAgIEBwYXJhbSB7RnVuY3Rpb259IG9uUmVqZWN0aW9uXG4gICAgVXNlZnVsIGZvciB0b29saW5nLlxuICAgIEByZXR1cm4ge1Byb21pc2V9XG4gICovXG4gICdjYXRjaCc6IGZ1bmN0aW9uIF9jYXRjaChvblJlamVjdGlvbikge1xuICAgIHJldHVybiB0aGlzLnRoZW4obnVsbCwgb25SZWplY3Rpb24pO1xuICB9XG59O1xuXG4vKmdsb2JhbCBzZWxmKi9cbmZ1bmN0aW9uIHBvbHlmaWxsJDEoKSB7XG4gICAgdmFyIGxvY2FsID0gdW5kZWZpbmVkO1xuXG4gICAgaWYgKHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIGxvY2FsID0gZ2xvYmFsO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIGxvY2FsID0gc2VsZjtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbG9jYWwgPSBGdW5jdGlvbigncmV0dXJuIHRoaXMnKSgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3BvbHlmaWxsIGZhaWxlZCBiZWNhdXNlIGdsb2JhbCBvYmplY3QgaXMgdW5hdmFpbGFibGUgaW4gdGhpcyBlbnZpcm9ubWVudCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdmFyIFAgPSBsb2NhbC5Qcm9taXNlO1xuXG4gICAgaWYgKFApIHtcbiAgICAgICAgdmFyIHByb21pc2VUb1N0cmluZyA9IG51bGw7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBwcm9taXNlVG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoUC5yZXNvbHZlKCkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAvLyBzaWxlbnRseSBpZ25vcmVkXG4gICAgICAgIH1cblxuICAgICAgICBpZiAocHJvbWlzZVRvU3RyaW5nID09PSAnW29iamVjdCBQcm9taXNlXScgJiYgIVAuY2FzdCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbG9jYWwuUHJvbWlzZSA9IFByb21pc2UkMjtcbn1cblxuLy8gU3RyYW5nZSBjb21wYXQuLlxuUHJvbWlzZSQyLnBvbHlmaWxsID0gcG9seWZpbGwkMTtcblByb21pc2UkMi5Qcm9taXNlID0gUHJvbWlzZSQyO1xuXG5yZXR1cm4gUHJvbWlzZSQyO1xuXG59KSkpO1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1lczYtcHJvbWlzZS5tYXBcbiIsIi8vIHRoZSB3aGF0d2ctZmV0Y2ggcG9seWZpbGwgaW5zdGFsbHMgdGhlIGZldGNoKCkgZnVuY3Rpb25cbi8vIG9uIHRoZSBnbG9iYWwgb2JqZWN0ICh3aW5kb3cgb3Igc2VsZilcbi8vXG4vLyBSZXR1cm4gdGhhdCBhcyB0aGUgZXhwb3J0IGZvciB1c2UgaW4gV2VicGFjaywgQnJvd3NlcmlmeSBldGMuXG5yZXF1aXJlKCd3aGF0d2ctZmV0Y2gnKTtcbm1vZHVsZS5leHBvcnRzID0gc2VsZi5mZXRjaC5iaW5kKHNlbGYpO1xuIiwiLy8gc2hpbSBmb3IgdXNpbmcgcHJvY2VzcyBpbiBicm93c2VyXG52YXIgcHJvY2VzcyA9IG1vZHVsZS5leHBvcnRzID0ge307XG5cbi8vIGNhY2hlZCBmcm9tIHdoYXRldmVyIGdsb2JhbCBpcyBwcmVzZW50IHNvIHRoYXQgdGVzdCBydW5uZXJzIHRoYXQgc3R1YiBpdFxuLy8gZG9uJ3QgYnJlYWsgdGhpbmdzLiAgQnV0IHdlIG5lZWQgdG8gd3JhcCBpdCBpbiBhIHRyeSBjYXRjaCBpbiBjYXNlIGl0IGlzXG4vLyB3cmFwcGVkIGluIHN0cmljdCBtb2RlIGNvZGUgd2hpY2ggZG9lc24ndCBkZWZpbmUgYW55IGdsb2JhbHMuICBJdCdzIGluc2lkZSBhXG4vLyBmdW5jdGlvbiBiZWNhdXNlIHRyeS9jYXRjaGVzIGRlb3B0aW1pemUgaW4gY2VydGFpbiBlbmdpbmVzLlxuXG52YXIgY2FjaGVkU2V0VGltZW91dDtcbnZhciBjYWNoZWRDbGVhclRpbWVvdXQ7XG5cbmZ1bmN0aW9uIGRlZmF1bHRTZXRUaW1vdXQoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdzZXRUaW1lb3V0IGhhcyBub3QgYmVlbiBkZWZpbmVkJyk7XG59XG5mdW5jdGlvbiBkZWZhdWx0Q2xlYXJUaW1lb3V0ICgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NsZWFyVGltZW91dCBoYXMgbm90IGJlZW4gZGVmaW5lZCcpO1xufVxuKGZ1bmN0aW9uICgpIHtcbiAgICB0cnkge1xuICAgICAgICBpZiAodHlwZW9mIHNldFRpbWVvdXQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBzZXRUaW1lb3V0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IGRlZmF1bHRTZXRUaW1vdXQ7XG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBkZWZhdWx0U2V0VGltb3V0O1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgICBpZiAodHlwZW9mIGNsZWFyVGltZW91dCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gY2xlYXJUaW1lb3V0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gZGVmYXVsdENsZWFyVGltZW91dDtcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gZGVmYXVsdENsZWFyVGltZW91dDtcbiAgICB9XG59ICgpKVxuZnVuY3Rpb24gcnVuVGltZW91dChmdW4pIHtcbiAgICBpZiAoY2FjaGVkU2V0VGltZW91dCA9PT0gc2V0VGltZW91dCkge1xuICAgICAgICAvL25vcm1hbCBlbnZpcm9tZW50cyBpbiBzYW5lIHNpdHVhdGlvbnNcbiAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuLCAwKTtcbiAgICB9XG4gICAgLy8gaWYgc2V0VGltZW91dCB3YXNuJ3QgYXZhaWxhYmxlIGJ1dCB3YXMgbGF0dGVyIGRlZmluZWRcbiAgICBpZiAoKGNhY2hlZFNldFRpbWVvdXQgPT09IGRlZmF1bHRTZXRUaW1vdXQgfHwgIWNhY2hlZFNldFRpbWVvdXQpICYmIHNldFRpbWVvdXQpIHtcbiAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IHNldFRpbWVvdXQ7XG4gICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1biwgMCk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICAgIC8vIHdoZW4gd2hlbiBzb21lYm9keSBoYXMgc2NyZXdlZCB3aXRoIHNldFRpbWVvdXQgYnV0IG5vIEkuRS4gbWFkZG5lc3NcbiAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQoZnVuLCAwKTtcbiAgICB9IGNhdGNoKGUpe1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gV2hlbiB3ZSBhcmUgaW4gSS5FLiBidXQgdGhlIHNjcmlwdCBoYXMgYmVlbiBldmFsZWQgc28gSS5FLiBkb2Vzbid0IHRydXN0IHRoZSBnbG9iYWwgb2JqZWN0IHdoZW4gY2FsbGVkIG5vcm1hbGx5XG4gICAgICAgICAgICByZXR1cm4gY2FjaGVkU2V0VGltZW91dC5jYWxsKG51bGwsIGZ1biwgMCk7XG4gICAgICAgIH0gY2F0Y2goZSl7XG4gICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aGVuIGl0J3MgYSB2ZXJzaW9uIG9mIEkuRS4gdGhhdCBtdXN0IGhhdmUgdGhlIGdsb2JhbCBvYmplY3QgZm9yICd0aGlzJywgaG9wZnVsbHkgb3VyIGNvbnRleHQgY29ycmVjdCBvdGhlcndpc2UgaXQgd2lsbCB0aHJvdyBhIGdsb2JhbCBlcnJvclxuICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQuY2FsbCh0aGlzLCBmdW4sIDApO1xuICAgICAgICB9XG4gICAgfVxuXG5cbn1cbmZ1bmN0aW9uIHJ1bkNsZWFyVGltZW91dChtYXJrZXIpIHtcbiAgICBpZiAoY2FjaGVkQ2xlYXJUaW1lb3V0ID09PSBjbGVhclRpbWVvdXQpIHtcbiAgICAgICAgLy9ub3JtYWwgZW52aXJvbWVudHMgaW4gc2FuZSBzaXR1YXRpb25zXG4gICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQobWFya2VyKTtcbiAgICB9XG4gICAgLy8gaWYgY2xlYXJUaW1lb3V0IHdhc24ndCBhdmFpbGFibGUgYnV0IHdhcyBsYXR0ZXIgZGVmaW5lZFxuICAgIGlmICgoY2FjaGVkQ2xlYXJUaW1lb3V0ID09PSBkZWZhdWx0Q2xlYXJUaW1lb3V0IHx8ICFjYWNoZWRDbGVhclRpbWVvdXQpICYmIGNsZWFyVGltZW91dCkge1xuICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBjbGVhclRpbWVvdXQ7XG4gICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQobWFya2VyKTtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgICAgLy8gd2hlbiB3aGVuIHNvbWVib2R5IGhhcyBzY3Jld2VkIHdpdGggc2V0VGltZW91dCBidXQgbm8gSS5FLiBtYWRkbmVzc1xuICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0KG1hcmtlcik7XG4gICAgfSBjYXRjaCAoZSl7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBXaGVuIHdlIGFyZSBpbiBJLkUuIGJ1dCB0aGUgc2NyaXB0IGhhcyBiZWVuIGV2YWxlZCBzbyBJLkUuIGRvZXNuJ3QgIHRydXN0IHRoZSBnbG9iYWwgb2JqZWN0IHdoZW4gY2FsbGVkIG5vcm1hbGx5XG4gICAgICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0LmNhbGwobnVsbCwgbWFya2VyKTtcbiAgICAgICAgfSBjYXRjaCAoZSl7XG4gICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aGVuIGl0J3MgYSB2ZXJzaW9uIG9mIEkuRS4gdGhhdCBtdXN0IGhhdmUgdGhlIGdsb2JhbCBvYmplY3QgZm9yICd0aGlzJywgaG9wZnVsbHkgb3VyIGNvbnRleHQgY29ycmVjdCBvdGhlcndpc2UgaXQgd2lsbCB0aHJvdyBhIGdsb2JhbCBlcnJvci5cbiAgICAgICAgICAgIC8vIFNvbWUgdmVyc2lvbnMgb2YgSS5FLiBoYXZlIGRpZmZlcmVudCBydWxlcyBmb3IgY2xlYXJUaW1lb3V0IHZzIHNldFRpbWVvdXRcbiAgICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQuY2FsbCh0aGlzLCBtYXJrZXIpO1xuICAgICAgICB9XG4gICAgfVxuXG5cblxufVxudmFyIHF1ZXVlID0gW107XG52YXIgZHJhaW5pbmcgPSBmYWxzZTtcbnZhciBjdXJyZW50UXVldWU7XG52YXIgcXVldWVJbmRleCA9IC0xO1xuXG5mdW5jdGlvbiBjbGVhblVwTmV4dFRpY2soKSB7XG4gICAgaWYgKCFkcmFpbmluZyB8fCAhY3VycmVudFF1ZXVlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZHJhaW5pbmcgPSBmYWxzZTtcbiAgICBpZiAoY3VycmVudFF1ZXVlLmxlbmd0aCkge1xuICAgICAgICBxdWV1ZSA9IGN1cnJlbnRRdWV1ZS5jb25jYXQocXVldWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHF1ZXVlSW5kZXggPSAtMTtcbiAgICB9XG4gICAgaWYgKHF1ZXVlLmxlbmd0aCkge1xuICAgICAgICBkcmFpblF1ZXVlKCk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBkcmFpblF1ZXVlKCkge1xuICAgIGlmIChkcmFpbmluZykge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciB0aW1lb3V0ID0gcnVuVGltZW91dChjbGVhblVwTmV4dFRpY2spO1xuICAgIGRyYWluaW5nID0gdHJ1ZTtcblxuICAgIHZhciBsZW4gPSBxdWV1ZS5sZW5ndGg7XG4gICAgd2hpbGUobGVuKSB7XG4gICAgICAgIGN1cnJlbnRRdWV1ZSA9IHF1ZXVlO1xuICAgICAgICBxdWV1ZSA9IFtdO1xuICAgICAgICB3aGlsZSAoKytxdWV1ZUluZGV4IDwgbGVuKSB7XG4gICAgICAgICAgICBpZiAoY3VycmVudFF1ZXVlKSB7XG4gICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlW3F1ZXVlSW5kZXhdLnJ1bigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHF1ZXVlSW5kZXggPSAtMTtcbiAgICAgICAgbGVuID0gcXVldWUubGVuZ3RoO1xuICAgIH1cbiAgICBjdXJyZW50UXVldWUgPSBudWxsO1xuICAgIGRyYWluaW5nID0gZmFsc2U7XG4gICAgcnVuQ2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xufVxuXG5wcm9jZXNzLm5leHRUaWNrID0gZnVuY3Rpb24gKGZ1bikge1xuICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGFyZ3VtZW50cy5sZW5ndGggLSAxKTtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldO1xuICAgICAgICB9XG4gICAgfVxuICAgIHF1ZXVlLnB1c2gobmV3IEl0ZW0oZnVuLCBhcmdzKSk7XG4gICAgaWYgKHF1ZXVlLmxlbmd0aCA9PT0gMSAmJiAhZHJhaW5pbmcpIHtcbiAgICAgICAgcnVuVGltZW91dChkcmFpblF1ZXVlKTtcbiAgICB9XG59O1xuXG4vLyB2OCBsaWtlcyBwcmVkaWN0aWJsZSBvYmplY3RzXG5mdW5jdGlvbiBJdGVtKGZ1biwgYXJyYXkpIHtcbiAgICB0aGlzLmZ1biA9IGZ1bjtcbiAgICB0aGlzLmFycmF5ID0gYXJyYXk7XG59XG5JdGVtLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5mdW4uYXBwbHkobnVsbCwgdGhpcy5hcnJheSk7XG59O1xucHJvY2Vzcy50aXRsZSA9ICdicm93c2VyJztcbnByb2Nlc3MuYnJvd3NlciA9IHRydWU7XG5wcm9jZXNzLmVudiA9IHt9O1xucHJvY2Vzcy5hcmd2ID0gW107XG5wcm9jZXNzLnZlcnNpb24gPSAnJzsgLy8gZW1wdHkgc3RyaW5nIHRvIGF2b2lkIHJlZ2V4cCBpc3N1ZXNcbnByb2Nlc3MudmVyc2lvbnMgPSB7fTtcblxuZnVuY3Rpb24gbm9vcCgpIHt9XG5cbnByb2Nlc3Mub24gPSBub29wO1xucHJvY2Vzcy5hZGRMaXN0ZW5lciA9IG5vb3A7XG5wcm9jZXNzLm9uY2UgPSBub29wO1xucHJvY2Vzcy5vZmYgPSBub29wO1xucHJvY2Vzcy5yZW1vdmVMaXN0ZW5lciA9IG5vb3A7XG5wcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycyA9IG5vb3A7XG5wcm9jZXNzLmVtaXQgPSBub29wO1xucHJvY2Vzcy5wcmVwZW5kTGlzdGVuZXIgPSBub29wO1xucHJvY2Vzcy5wcmVwZW5kT25jZUxpc3RlbmVyID0gbm9vcDtcblxucHJvY2Vzcy5saXN0ZW5lcnMgPSBmdW5jdGlvbiAobmFtZSkgeyByZXR1cm4gW10gfVxuXG5wcm9jZXNzLmJpbmRpbmcgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5iaW5kaW5nIGlzIG5vdCBzdXBwb3J0ZWQnKTtcbn07XG5cbnByb2Nlc3MuY3dkID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gJy8nIH07XG5wcm9jZXNzLmNoZGlyID0gZnVuY3Rpb24gKGRpcikge1xuICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkJyk7XG59O1xucHJvY2Vzcy51bWFzayA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gMDsgfTtcbiIsIihmdW5jdGlvbihzZWxmKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICBpZiAoc2VsZi5mZXRjaCkge1xuICAgIHJldHVyblxuICB9XG5cbiAgdmFyIHN1cHBvcnQgPSB7XG4gICAgc2VhcmNoUGFyYW1zOiAnVVJMU2VhcmNoUGFyYW1zJyBpbiBzZWxmLFxuICAgIGl0ZXJhYmxlOiAnU3ltYm9sJyBpbiBzZWxmICYmICdpdGVyYXRvcicgaW4gU3ltYm9sLFxuICAgIGJsb2I6ICdGaWxlUmVhZGVyJyBpbiBzZWxmICYmICdCbG9iJyBpbiBzZWxmICYmIChmdW5jdGlvbigpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIG5ldyBCbG9iKClcbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICB9KSgpLFxuICAgIGZvcm1EYXRhOiAnRm9ybURhdGEnIGluIHNlbGYsXG4gICAgYXJyYXlCdWZmZXI6ICdBcnJheUJ1ZmZlcicgaW4gc2VsZlxuICB9XG5cbiAgaWYgKHN1cHBvcnQuYXJyYXlCdWZmZXIpIHtcbiAgICB2YXIgdmlld0NsYXNzZXMgPSBbXG4gICAgICAnW29iamVjdCBJbnQ4QXJyYXldJyxcbiAgICAgICdbb2JqZWN0IFVpbnQ4QXJyYXldJyxcbiAgICAgICdbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XScsXG4gICAgICAnW29iamVjdCBJbnQxNkFycmF5XScsXG4gICAgICAnW29iamVjdCBVaW50MTZBcnJheV0nLFxuICAgICAgJ1tvYmplY3QgSW50MzJBcnJheV0nLFxuICAgICAgJ1tvYmplY3QgVWludDMyQXJyYXldJyxcbiAgICAgICdbb2JqZWN0IEZsb2F0MzJBcnJheV0nLFxuICAgICAgJ1tvYmplY3QgRmxvYXQ2NEFycmF5XSdcbiAgICBdXG5cbiAgICB2YXIgaXNEYXRhVmlldyA9IGZ1bmN0aW9uKG9iaikge1xuICAgICAgcmV0dXJuIG9iaiAmJiBEYXRhVmlldy5wcm90b3R5cGUuaXNQcm90b3R5cGVPZihvYmopXG4gICAgfVxuXG4gICAgdmFyIGlzQXJyYXlCdWZmZXJWaWV3ID0gQXJyYXlCdWZmZXIuaXNWaWV3IHx8IGZ1bmN0aW9uKG9iaikge1xuICAgICAgcmV0dXJuIG9iaiAmJiB2aWV3Q2xhc3Nlcy5pbmRleE9mKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopKSA+IC0xXG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gbm9ybWFsaXplTmFtZShuYW1lKSB7XG4gICAgaWYgKHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykge1xuICAgICAgbmFtZSA9IFN0cmluZyhuYW1lKVxuICAgIH1cbiAgICBpZiAoL1teYS16MC05XFwtIyQlJicqKy5cXF5fYHx+XS9pLnRlc3QobmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgY2hhcmFjdGVyIGluIGhlYWRlciBmaWVsZCBuYW1lJylcbiAgICB9XG4gICAgcmV0dXJuIG5hbWUudG9Mb3dlckNhc2UoKVxuICB9XG5cbiAgZnVuY3Rpb24gbm9ybWFsaXplVmFsdWUodmFsdWUpIHtcbiAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykge1xuICAgICAgdmFsdWUgPSBTdHJpbmcodmFsdWUpXG4gICAgfVxuICAgIHJldHVybiB2YWx1ZVxuICB9XG5cbiAgLy8gQnVpbGQgYSBkZXN0cnVjdGl2ZSBpdGVyYXRvciBmb3IgdGhlIHZhbHVlIGxpc3RcbiAgZnVuY3Rpb24gaXRlcmF0b3JGb3IoaXRlbXMpIHtcbiAgICB2YXIgaXRlcmF0b3IgPSB7XG4gICAgICBuZXh0OiBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHZhbHVlID0gaXRlbXMuc2hpZnQoKVxuICAgICAgICByZXR1cm4ge2RvbmU6IHZhbHVlID09PSB1bmRlZmluZWQsIHZhbHVlOiB2YWx1ZX1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoc3VwcG9ydC5pdGVyYWJsZSkge1xuICAgICAgaXRlcmF0b3JbU3ltYm9sLml0ZXJhdG9yXSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gaXRlcmF0b3JcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gaXRlcmF0b3JcbiAgfVxuXG4gIGZ1bmN0aW9uIEhlYWRlcnMoaGVhZGVycykge1xuICAgIHRoaXMubWFwID0ge31cblxuICAgIGlmIChoZWFkZXJzIGluc3RhbmNlb2YgSGVhZGVycykge1xuICAgICAgaGVhZGVycy5mb3JFYWNoKGZ1bmN0aW9uKHZhbHVlLCBuYW1lKSB7XG4gICAgICAgIHRoaXMuYXBwZW5kKG5hbWUsIHZhbHVlKVxuICAgICAgfSwgdGhpcylcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaGVhZGVycykpIHtcbiAgICAgIGhlYWRlcnMuZm9yRWFjaChmdW5jdGlvbihoZWFkZXIpIHtcbiAgICAgICAgdGhpcy5hcHBlbmQoaGVhZGVyWzBdLCBoZWFkZXJbMV0pXG4gICAgICB9LCB0aGlzKVxuICAgIH0gZWxzZSBpZiAoaGVhZGVycykge1xuICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoaGVhZGVycykuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7XG4gICAgICAgIHRoaXMuYXBwZW5kKG5hbWUsIGhlYWRlcnNbbmFtZV0pXG4gICAgICB9LCB0aGlzKVxuICAgIH1cbiAgfVxuXG4gIEhlYWRlcnMucHJvdG90eXBlLmFwcGVuZCA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7XG4gICAgbmFtZSA9IG5vcm1hbGl6ZU5hbWUobmFtZSlcbiAgICB2YWx1ZSA9IG5vcm1hbGl6ZVZhbHVlKHZhbHVlKVxuICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMubWFwW25hbWVdXG4gICAgdGhpcy5tYXBbbmFtZV0gPSBvbGRWYWx1ZSA/IG9sZFZhbHVlKycsJyt2YWx1ZSA6IHZhbHVlXG4gIH1cblxuICBIZWFkZXJzLnByb3RvdHlwZVsnZGVsZXRlJ10gPSBmdW5jdGlvbihuYW1lKSB7XG4gICAgZGVsZXRlIHRoaXMubWFwW25vcm1hbGl6ZU5hbWUobmFtZSldXG4gIH1cblxuICBIZWFkZXJzLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbihuYW1lKSB7XG4gICAgbmFtZSA9IG5vcm1hbGl6ZU5hbWUobmFtZSlcbiAgICByZXR1cm4gdGhpcy5oYXMobmFtZSkgPyB0aGlzLm1hcFtuYW1lXSA6IG51bGxcbiAgfVxuXG4gIEhlYWRlcnMucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgICByZXR1cm4gdGhpcy5tYXAuaGFzT3duUHJvcGVydHkobm9ybWFsaXplTmFtZShuYW1lKSlcbiAgfVxuXG4gIEhlYWRlcnMucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7XG4gICAgdGhpcy5tYXBbbm9ybWFsaXplTmFtZShuYW1lKV0gPSBub3JtYWxpemVWYWx1ZSh2YWx1ZSlcbiAgfVxuXG4gIEhlYWRlcnMucHJvdG90eXBlLmZvckVhY2ggPSBmdW5jdGlvbihjYWxsYmFjaywgdGhpc0FyZykge1xuICAgIGZvciAodmFyIG5hbWUgaW4gdGhpcy5tYXApIHtcbiAgICAgIGlmICh0aGlzLm1hcC5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXNBcmcsIHRoaXMubWFwW25hbWVdLCBuYW1lLCB0aGlzKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIEhlYWRlcnMucHJvdG90eXBlLmtleXMgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgaXRlbXMgPSBbXVxuICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbih2YWx1ZSwgbmFtZSkgeyBpdGVtcy5wdXNoKG5hbWUpIH0pXG4gICAgcmV0dXJuIGl0ZXJhdG9yRm9yKGl0ZW1zKVxuICB9XG5cbiAgSGVhZGVycy5wcm90b3R5cGUudmFsdWVzID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGl0ZW1zID0gW11cbiAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24odmFsdWUpIHsgaXRlbXMucHVzaCh2YWx1ZSkgfSlcbiAgICByZXR1cm4gaXRlcmF0b3JGb3IoaXRlbXMpXG4gIH1cblxuICBIZWFkZXJzLnByb3RvdHlwZS5lbnRyaWVzID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGl0ZW1zID0gW11cbiAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24odmFsdWUsIG5hbWUpIHsgaXRlbXMucHVzaChbbmFtZSwgdmFsdWVdKSB9KVxuICAgIHJldHVybiBpdGVyYXRvckZvcihpdGVtcylcbiAgfVxuXG4gIGlmIChzdXBwb3J0Lml0ZXJhYmxlKSB7XG4gICAgSGVhZGVycy5wcm90b3R5cGVbU3ltYm9sLml0ZXJhdG9yXSA9IEhlYWRlcnMucHJvdG90eXBlLmVudHJpZXNcbiAgfVxuXG4gIGZ1bmN0aW9uIGNvbnN1bWVkKGJvZHkpIHtcbiAgICBpZiAoYm9keS5ib2R5VXNlZCkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBUeXBlRXJyb3IoJ0FscmVhZHkgcmVhZCcpKVxuICAgIH1cbiAgICBib2R5LmJvZHlVc2VkID0gdHJ1ZVxuICB9XG5cbiAgZnVuY3Rpb24gZmlsZVJlYWRlclJlYWR5KHJlYWRlcikge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIHJlYWRlci5vbmxvYWQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmVzb2x2ZShyZWFkZXIucmVzdWx0KVxuICAgICAgfVxuICAgICAgcmVhZGVyLm9uZXJyb3IgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmVqZWN0KHJlYWRlci5lcnJvcilcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZnVuY3Rpb24gcmVhZEJsb2JBc0FycmF5QnVmZmVyKGJsb2IpIHtcbiAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKVxuICAgIHZhciBwcm9taXNlID0gZmlsZVJlYWRlclJlYWR5KHJlYWRlcilcbiAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoYmxvYilcbiAgICByZXR1cm4gcHJvbWlzZVxuICB9XG5cbiAgZnVuY3Rpb24gcmVhZEJsb2JBc1RleHQoYmxvYikge1xuICAgIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpXG4gICAgdmFyIHByb21pc2UgPSBmaWxlUmVhZGVyUmVhZHkocmVhZGVyKVxuICAgIHJlYWRlci5yZWFkQXNUZXh0KGJsb2IpXG4gICAgcmV0dXJuIHByb21pc2VcbiAgfVxuXG4gIGZ1bmN0aW9uIHJlYWRBcnJheUJ1ZmZlckFzVGV4dChidWYpIHtcbiAgICB2YXIgdmlldyA9IG5ldyBVaW50OEFycmF5KGJ1ZilcbiAgICB2YXIgY2hhcnMgPSBuZXcgQXJyYXkodmlldy5sZW5ndGgpXG5cbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZpZXcubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNoYXJzW2ldID0gU3RyaW5nLmZyb21DaGFyQ29kZSh2aWV3W2ldKVxuICAgIH1cbiAgICByZXR1cm4gY2hhcnMuam9pbignJylcbiAgfVxuXG4gIGZ1bmN0aW9uIGJ1ZmZlckNsb25lKGJ1Zikge1xuICAgIGlmIChidWYuc2xpY2UpIHtcbiAgICAgIHJldHVybiBidWYuc2xpY2UoMClcbiAgICB9IGVsc2Uge1xuICAgICAgdmFyIHZpZXcgPSBuZXcgVWludDhBcnJheShidWYuYnl0ZUxlbmd0aClcbiAgICAgIHZpZXcuc2V0KG5ldyBVaW50OEFycmF5KGJ1ZikpXG4gICAgICByZXR1cm4gdmlldy5idWZmZXJcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBCb2R5KCkge1xuICAgIHRoaXMuYm9keVVzZWQgPSBmYWxzZVxuXG4gICAgdGhpcy5faW5pdEJvZHkgPSBmdW5jdGlvbihib2R5KSB7XG4gICAgICB0aGlzLl9ib2R5SW5pdCA9IGJvZHlcbiAgICAgIGlmICghYm9keSkge1xuICAgICAgICB0aGlzLl9ib2R5VGV4dCA9ICcnXG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJykge1xuICAgICAgICB0aGlzLl9ib2R5VGV4dCA9IGJvZHlcbiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydC5ibG9iICYmIEJsb2IucHJvdG90eXBlLmlzUHJvdG90eXBlT2YoYm9keSkpIHtcbiAgICAgICAgdGhpcy5fYm9keUJsb2IgPSBib2R5XG4gICAgICB9IGVsc2UgaWYgKHN1cHBvcnQuZm9ybURhdGEgJiYgRm9ybURhdGEucHJvdG90eXBlLmlzUHJvdG90eXBlT2YoYm9keSkpIHtcbiAgICAgICAgdGhpcy5fYm9keUZvcm1EYXRhID0gYm9keVxuICAgICAgfSBlbHNlIGlmIChzdXBwb3J0LnNlYXJjaFBhcmFtcyAmJiBVUkxTZWFyY2hQYXJhbXMucHJvdG90eXBlLmlzUHJvdG90eXBlT2YoYm9keSkpIHtcbiAgICAgICAgdGhpcy5fYm9keVRleHQgPSBib2R5LnRvU3RyaW5nKClcbiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydC5hcnJheUJ1ZmZlciAmJiBzdXBwb3J0LmJsb2IgJiYgaXNEYXRhVmlldyhib2R5KSkge1xuICAgICAgICB0aGlzLl9ib2R5QXJyYXlCdWZmZXIgPSBidWZmZXJDbG9uZShib2R5LmJ1ZmZlcilcbiAgICAgICAgLy8gSUUgMTAtMTEgY2FuJ3QgaGFuZGxlIGEgRGF0YVZpZXcgYm9keS5cbiAgICAgICAgdGhpcy5fYm9keUluaXQgPSBuZXcgQmxvYihbdGhpcy5fYm9keUFycmF5QnVmZmVyXSlcbiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydC5hcnJheUJ1ZmZlciAmJiAoQXJyYXlCdWZmZXIucHJvdG90eXBlLmlzUHJvdG90eXBlT2YoYm9keSkgfHwgaXNBcnJheUJ1ZmZlclZpZXcoYm9keSkpKSB7XG4gICAgICAgIHRoaXMuX2JvZHlBcnJheUJ1ZmZlciA9IGJ1ZmZlckNsb25lKGJvZHkpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Vuc3VwcG9ydGVkIEJvZHlJbml0IHR5cGUnKVxuICAgICAgfVxuXG4gICAgICBpZiAoIXRoaXMuaGVhZGVycy5nZXQoJ2NvbnRlbnQtdHlwZScpKSB7XG4gICAgICAgIGlmICh0eXBlb2YgYm9keSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICB0aGlzLmhlYWRlcnMuc2V0KCdjb250ZW50LXR5cGUnLCAndGV4dC9wbGFpbjtjaGFyc2V0PVVURi04JylcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9ib2R5QmxvYiAmJiB0aGlzLl9ib2R5QmxvYi50eXBlKSB7XG4gICAgICAgICAgdGhpcy5oZWFkZXJzLnNldCgnY29udGVudC10eXBlJywgdGhpcy5fYm9keUJsb2IudHlwZSlcbiAgICAgICAgfSBlbHNlIGlmIChzdXBwb3J0LnNlYXJjaFBhcmFtcyAmJiBVUkxTZWFyY2hQYXJhbXMucHJvdG90eXBlLmlzUHJvdG90eXBlT2YoYm9keSkpIHtcbiAgICAgICAgICB0aGlzLmhlYWRlcnMuc2V0KCdjb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkO2NoYXJzZXQ9VVRGLTgnKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHN1cHBvcnQuYmxvYikge1xuICAgICAgdGhpcy5ibG9iID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciByZWplY3RlZCA9IGNvbnN1bWVkKHRoaXMpXG4gICAgICAgIGlmIChyZWplY3RlZCkge1xuICAgICAgICAgIHJldHVybiByZWplY3RlZFxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuX2JvZHlCbG9iKSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLl9ib2R5QmxvYilcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9ib2R5QXJyYXlCdWZmZXIpIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyBCbG9iKFt0aGlzLl9ib2R5QXJyYXlCdWZmZXJdKSlcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9ib2R5Rm9ybURhdGEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCByZWFkIEZvcm1EYXRhIGJvZHkgYXMgYmxvYicpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShuZXcgQmxvYihbdGhpcy5fYm9keVRleHRdKSlcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0aGlzLmFycmF5QnVmZmVyID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmICh0aGlzLl9ib2R5QXJyYXlCdWZmZXIpIHtcbiAgICAgICAgICByZXR1cm4gY29uc3VtZWQodGhpcykgfHwgUHJvbWlzZS5yZXNvbHZlKHRoaXMuX2JvZHlBcnJheUJ1ZmZlcilcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5ibG9iKCkudGhlbihyZWFkQmxvYkFzQXJyYXlCdWZmZXIpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnRleHQgPSBmdW5jdGlvbigpIHtcbiAgICAgIHZhciByZWplY3RlZCA9IGNvbnN1bWVkKHRoaXMpXG4gICAgICBpZiAocmVqZWN0ZWQpIHtcbiAgICAgICAgcmV0dXJuIHJlamVjdGVkXG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLl9ib2R5QmxvYikge1xuICAgICAgICByZXR1cm4gcmVhZEJsb2JBc1RleHQodGhpcy5fYm9keUJsb2IpXG4gICAgICB9IGVsc2UgaWYgKHRoaXMuX2JvZHlBcnJheUJ1ZmZlcikge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlYWRBcnJheUJ1ZmZlckFzVGV4dCh0aGlzLl9ib2R5QXJyYXlCdWZmZXIpKVxuICAgICAgfSBlbHNlIGlmICh0aGlzLl9ib2R5Rm9ybURhdGEpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdjb3VsZCBub3QgcmVhZCBGb3JtRGF0YSBib2R5IGFzIHRleHQnKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLl9ib2R5VGV4dClcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoc3VwcG9ydC5mb3JtRGF0YSkge1xuICAgICAgdGhpcy5mb3JtRGF0YSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50ZXh0KCkudGhlbihkZWNvZGUpXG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5qc29uID0gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy50ZXh0KCkudGhlbihKU09OLnBhcnNlKVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzXG4gIH1cblxuICAvLyBIVFRQIG1ldGhvZHMgd2hvc2UgY2FwaXRhbGl6YXRpb24gc2hvdWxkIGJlIG5vcm1hbGl6ZWRcbiAgdmFyIG1ldGhvZHMgPSBbJ0RFTEVURScsICdHRVQnLCAnSEVBRCcsICdPUFRJT05TJywgJ1BPU1QnLCAnUFVUJ11cblxuICBmdW5jdGlvbiBub3JtYWxpemVNZXRob2QobWV0aG9kKSB7XG4gICAgdmFyIHVwY2FzZWQgPSBtZXRob2QudG9VcHBlckNhc2UoKVxuICAgIHJldHVybiAobWV0aG9kcy5pbmRleE9mKHVwY2FzZWQpID4gLTEpID8gdXBjYXNlZCA6IG1ldGhvZFxuICB9XG5cbiAgZnVuY3Rpb24gUmVxdWVzdChpbnB1dCwgb3B0aW9ucykge1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9XG4gICAgdmFyIGJvZHkgPSBvcHRpb25zLmJvZHlcblxuICAgIGlmIChpbnB1dCBpbnN0YW5jZW9mIFJlcXVlc3QpIHtcbiAgICAgIGlmIChpbnB1dC5ib2R5VXNlZCkge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBbHJlYWR5IHJlYWQnKVxuICAgICAgfVxuICAgICAgdGhpcy51cmwgPSBpbnB1dC51cmxcbiAgICAgIHRoaXMuY3JlZGVudGlhbHMgPSBpbnB1dC5jcmVkZW50aWFsc1xuICAgICAgaWYgKCFvcHRpb25zLmhlYWRlcnMpIHtcbiAgICAgICAgdGhpcy5oZWFkZXJzID0gbmV3IEhlYWRlcnMoaW5wdXQuaGVhZGVycylcbiAgICAgIH1cbiAgICAgIHRoaXMubWV0aG9kID0gaW5wdXQubWV0aG9kXG4gICAgICB0aGlzLm1vZGUgPSBpbnB1dC5tb2RlXG4gICAgICBpZiAoIWJvZHkgJiYgaW5wdXQuX2JvZHlJbml0ICE9IG51bGwpIHtcbiAgICAgICAgYm9keSA9IGlucHV0Ll9ib2R5SW5pdFxuICAgICAgICBpbnB1dC5ib2R5VXNlZCA9IHRydWVcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy51cmwgPSBTdHJpbmcoaW5wdXQpXG4gICAgfVxuXG4gICAgdGhpcy5jcmVkZW50aWFscyA9IG9wdGlvbnMuY3JlZGVudGlhbHMgfHwgdGhpcy5jcmVkZW50aWFscyB8fCAnb21pdCdcbiAgICBpZiAob3B0aW9ucy5oZWFkZXJzIHx8ICF0aGlzLmhlYWRlcnMpIHtcbiAgICAgIHRoaXMuaGVhZGVycyA9IG5ldyBIZWFkZXJzKG9wdGlvbnMuaGVhZGVycylcbiAgICB9XG4gICAgdGhpcy5tZXRob2QgPSBub3JtYWxpemVNZXRob2Qob3B0aW9ucy5tZXRob2QgfHwgdGhpcy5tZXRob2QgfHwgJ0dFVCcpXG4gICAgdGhpcy5tb2RlID0gb3B0aW9ucy5tb2RlIHx8IHRoaXMubW9kZSB8fCBudWxsXG4gICAgdGhpcy5yZWZlcnJlciA9IG51bGxcblxuICAgIGlmICgodGhpcy5tZXRob2QgPT09ICdHRVQnIHx8IHRoaXMubWV0aG9kID09PSAnSEVBRCcpICYmIGJvZHkpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0JvZHkgbm90IGFsbG93ZWQgZm9yIEdFVCBvciBIRUFEIHJlcXVlc3RzJylcbiAgICB9XG4gICAgdGhpcy5faW5pdEJvZHkoYm9keSlcbiAgfVxuXG4gIFJlcXVlc3QucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIG5ldyBSZXF1ZXN0KHRoaXMsIHsgYm9keTogdGhpcy5fYm9keUluaXQgfSlcbiAgfVxuXG4gIGZ1bmN0aW9uIGRlY29kZShib2R5KSB7XG4gICAgdmFyIGZvcm0gPSBuZXcgRm9ybURhdGEoKVxuICAgIGJvZHkudHJpbSgpLnNwbGl0KCcmJykuZm9yRWFjaChmdW5jdGlvbihieXRlcykge1xuICAgICAgaWYgKGJ5dGVzKSB7XG4gICAgICAgIHZhciBzcGxpdCA9IGJ5dGVzLnNwbGl0KCc9JylcbiAgICAgICAgdmFyIG5hbWUgPSBzcGxpdC5zaGlmdCgpLnJlcGxhY2UoL1xcKy9nLCAnICcpXG4gICAgICAgIHZhciB2YWx1ZSA9IHNwbGl0LmpvaW4oJz0nKS5yZXBsYWNlKC9cXCsvZywgJyAnKVxuICAgICAgICBmb3JtLmFwcGVuZChkZWNvZGVVUklDb21wb25lbnQobmFtZSksIGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpXG4gICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gZm9ybVxuICB9XG5cbiAgZnVuY3Rpb24gcGFyc2VIZWFkZXJzKHJhd0hlYWRlcnMpIHtcbiAgICB2YXIgaGVhZGVycyA9IG5ldyBIZWFkZXJzKClcbiAgICByYXdIZWFkZXJzLnNwbGl0KC9cXHI/XFxuLykuZm9yRWFjaChmdW5jdGlvbihsaW5lKSB7XG4gICAgICB2YXIgcGFydHMgPSBsaW5lLnNwbGl0KCc6JylcbiAgICAgIHZhciBrZXkgPSBwYXJ0cy5zaGlmdCgpLnRyaW0oKVxuICAgICAgaWYgKGtleSkge1xuICAgICAgICB2YXIgdmFsdWUgPSBwYXJ0cy5qb2luKCc6JykudHJpbSgpXG4gICAgICAgIGhlYWRlcnMuYXBwZW5kKGtleSwgdmFsdWUpXG4gICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gaGVhZGVyc1xuICB9XG5cbiAgQm9keS5jYWxsKFJlcXVlc3QucHJvdG90eXBlKVxuXG4gIGZ1bmN0aW9uIFJlc3BvbnNlKGJvZHlJbml0LCBvcHRpb25zKSB7XG4gICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICBvcHRpb25zID0ge31cbiAgICB9XG5cbiAgICB0aGlzLnR5cGUgPSAnZGVmYXVsdCdcbiAgICB0aGlzLnN0YXR1cyA9ICdzdGF0dXMnIGluIG9wdGlvbnMgPyBvcHRpb25zLnN0YXR1cyA6IDIwMFxuICAgIHRoaXMub2sgPSB0aGlzLnN0YXR1cyA+PSAyMDAgJiYgdGhpcy5zdGF0dXMgPCAzMDBcbiAgICB0aGlzLnN0YXR1c1RleHQgPSAnc3RhdHVzVGV4dCcgaW4gb3B0aW9ucyA/IG9wdGlvbnMuc3RhdHVzVGV4dCA6ICdPSydcbiAgICB0aGlzLmhlYWRlcnMgPSBuZXcgSGVhZGVycyhvcHRpb25zLmhlYWRlcnMpXG4gICAgdGhpcy51cmwgPSBvcHRpb25zLnVybCB8fCAnJ1xuICAgIHRoaXMuX2luaXRCb2R5KGJvZHlJbml0KVxuICB9XG5cbiAgQm9keS5jYWxsKFJlc3BvbnNlLnByb3RvdHlwZSlcblxuICBSZXNwb25zZS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gbmV3IFJlc3BvbnNlKHRoaXMuX2JvZHlJbml0LCB7XG4gICAgICBzdGF0dXM6IHRoaXMuc3RhdHVzLFxuICAgICAgc3RhdHVzVGV4dDogdGhpcy5zdGF0dXNUZXh0LFxuICAgICAgaGVhZGVyczogbmV3IEhlYWRlcnModGhpcy5oZWFkZXJzKSxcbiAgICAgIHVybDogdGhpcy51cmxcbiAgICB9KVxuICB9XG5cbiAgUmVzcG9uc2UuZXJyb3IgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgcmVzcG9uc2UgPSBuZXcgUmVzcG9uc2UobnVsbCwge3N0YXR1czogMCwgc3RhdHVzVGV4dDogJyd9KVxuICAgIHJlc3BvbnNlLnR5cGUgPSAnZXJyb3InXG4gICAgcmV0dXJuIHJlc3BvbnNlXG4gIH1cblxuICB2YXIgcmVkaXJlY3RTdGF0dXNlcyA9IFszMDEsIDMwMiwgMzAzLCAzMDcsIDMwOF1cblxuICBSZXNwb25zZS5yZWRpcmVjdCA9IGZ1bmN0aW9uKHVybCwgc3RhdHVzKSB7XG4gICAgaWYgKHJlZGlyZWN0U3RhdHVzZXMuaW5kZXhPZihzdGF0dXMpID09PSAtMSkge1xuICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0ludmFsaWQgc3RhdHVzIGNvZGUnKVxuICAgIH1cblxuICAgIHJldHVybiBuZXcgUmVzcG9uc2UobnVsbCwge3N0YXR1czogc3RhdHVzLCBoZWFkZXJzOiB7bG9jYXRpb246IHVybH19KVxuICB9XG5cbiAgc2VsZi5IZWFkZXJzID0gSGVhZGVyc1xuICBzZWxmLlJlcXVlc3QgPSBSZXF1ZXN0XG4gIHNlbGYuUmVzcG9uc2UgPSBSZXNwb25zZVxuXG4gIHNlbGYuZmV0Y2ggPSBmdW5jdGlvbihpbnB1dCwgaW5pdCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIHZhciByZXF1ZXN0ID0gbmV3IFJlcXVlc3QoaW5wdXQsIGluaXQpXG4gICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KClcblxuICAgICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgICAgICBzdGF0dXM6IHhoci5zdGF0dXMsXG4gICAgICAgICAgc3RhdHVzVGV4dDogeGhyLnN0YXR1c1RleHQsXG4gICAgICAgICAgaGVhZGVyczogcGFyc2VIZWFkZXJzKHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSB8fCAnJylcbiAgICAgICAgfVxuICAgICAgICBvcHRpb25zLnVybCA9ICdyZXNwb25zZVVSTCcgaW4geGhyID8geGhyLnJlc3BvbnNlVVJMIDogb3B0aW9ucy5oZWFkZXJzLmdldCgnWC1SZXF1ZXN0LVVSTCcpXG4gICAgICAgIHZhciBib2R5ID0gJ3Jlc3BvbnNlJyBpbiB4aHIgPyB4aHIucmVzcG9uc2UgOiB4aHIucmVzcG9uc2VUZXh0XG4gICAgICAgIHJlc29sdmUobmV3IFJlc3BvbnNlKGJvZHksIG9wdGlvbnMpKVxuICAgICAgfVxuXG4gICAgICB4aHIub25lcnJvciA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZWplY3QobmV3IFR5cGVFcnJvcignTmV0d29yayByZXF1ZXN0IGZhaWxlZCcpKVxuICAgICAgfVxuXG4gICAgICB4aHIub250aW1lb3V0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHJlamVjdChuZXcgVHlwZUVycm9yKCdOZXR3b3JrIHJlcXVlc3QgZmFpbGVkJykpXG4gICAgICB9XG5cbiAgICAgIHhoci5vcGVuKHJlcXVlc3QubWV0aG9kLCByZXF1ZXN0LnVybCwgdHJ1ZSlcblxuICAgICAgaWYgKHJlcXVlc3QuY3JlZGVudGlhbHMgPT09ICdpbmNsdWRlJykge1xuICAgICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZVxuICAgICAgfVxuXG4gICAgICBpZiAoJ3Jlc3BvbnNlVHlwZScgaW4geGhyICYmIHN1cHBvcnQuYmxvYikge1xuICAgICAgICB4aHIucmVzcG9uc2VUeXBlID0gJ2Jsb2InXG4gICAgICB9XG5cbiAgICAgIHJlcXVlc3QuaGVhZGVycy5mb3JFYWNoKGZ1bmN0aW9uKHZhbHVlLCBuYW1lKSB7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIHZhbHVlKVxuICAgICAgfSlcblxuICAgICAgeGhyLnNlbmQodHlwZW9mIHJlcXVlc3QuX2JvZHlJbml0ID09PSAndW5kZWZpbmVkJyA/IG51bGwgOiByZXF1ZXN0Ll9ib2R5SW5pdClcbiAgICB9KVxuICB9XG4gIHNlbGYuZmV0Y2gucG9seWZpbGwgPSB0cnVlXG59KSh0eXBlb2Ygc2VsZiAhPT0gJ3VuZGVmaW5lZCcgPyBzZWxmIDogdGhpcyk7XG4iLCIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHV0aWxzID0gcmVxdWlyZSgnLi91dGlscycpO1xuY29uc3QgZGVmYXVsdHMgPSByZXF1aXJlKCcuL2RlZmF1bHRzJyk7XG5jb25zdCBpdGVtVG9DU0xKU09OID0gcmVxdWlyZSgnLi4vem90ZXJvLXNoaW0vaXRlbS10by1jc2wtanNvbicpO1xuY29uc3QgZGF0ZVRvU3FsID0gcmVxdWlyZSgnLi4vem90ZXJvLXNoaW0vZGF0ZS10by1zcWwnKTtcblxuY2xhc3MgWm90ZXJvQmliIHtcblx0Y29uc3RydWN0b3Iob3B0cykge1xuXHRcdHRoaXMub3B0cyA9IE9iamVjdC5hc3NpZ24oe1xuXHRcdFx0c2Vzc2lvbmlkOiB1dGlscy51dWlkNCgpXG5cdFx0fSwgZGVmYXVsdHMoKSwgb3B0cyk7XG5cblx0XHRpZih0aGlzLm9wdHMucGVyc2lzdCAmJiB0aGlzLm9wdHMuc3RvcmFnZSkge1xuXHRcdFx0aWYoISgnZ2V0SXRlbScgaW4gdGhpcy5vcHRzLnN0b3JhZ2UgfHxcblx0XHRcdFx0J3NldEl0ZW0nIGluIHRoaXMub3B0cy5zdG9yYWdlIHx8XG5cdFx0XHRcdCdjbGVhcicgaW4gdGhpcy5vcHRzLnN0b3JhZ2Vcblx0XHRcdCkpIHtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHN0b3JhZ2UgZW5naW5lIHByb3ZpZGVkJyk7XG5cdFx0XHR9XG5cdFx0XHRpZih0aGlzLm9wdHMub3ZlcnJpZGUpIHtcblx0XHRcdFx0dGhpcy5jbGVhckl0ZW1zKCk7XG5cdFx0XHR9XG5cdFx0XHR0aGlzLml0ZW1zID0gWy4uLnRoaXMub3B0cy5pbml0aWFsSXRlbXMsIC4uLnRoaXMuZ2V0SXRlbXNTdG9yYWdlKCldO1xuXHRcdFx0dGhpcy5zZXRJdGVtc1N0b3JhZ2UodGhpcy5pdGVtcyk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuaXRlbXMgPSBbLi4udGhpcy5vcHRzLmluaXRpYWxJdGVtc107XG5cdFx0fVxuXHR9XG5cblx0Z2V0SXRlbXNTdG9yYWdlKCkge1xuXHRcdGxldCBpdGVtcyA9IHRoaXMub3B0cy5zdG9yYWdlLmdldEl0ZW0oYCR7dGhpcy5vcHRzLnN0b3JhZ2VQcmVmaXh9LWl0ZW1zYCk7XG5cdFx0cmV0dXJuIGl0ZW1zID8gSlNPTi5wYXJzZShpdGVtcykgOiBbXTtcblx0fVxuXG5cdHNldEl0ZW1zU3RvcmFnZShpdGVtcykge1xuXHRcdHRoaXMub3B0cy5zdG9yYWdlLnNldEl0ZW0oXG5cdFx0XHRgJHt0aGlzLm9wdHMuc3RvcmFnZVByZWZpeH0taXRlbXNgLFxuXHRcdFx0SlNPTi5zdHJpbmdpZnkoaXRlbXMpXG5cdFx0KTtcblx0fVxuXG5cdGFkZEl0ZW0oaXRlbSkge1xuXHRcdHRoaXMuaXRlbXMucHVzaChpdGVtKTtcblx0XHRpZih0aGlzLm9wdHMucGVyc2lzdCkge1xuXHRcdFx0dGhpcy5zZXRJdGVtc1N0b3JhZ2UodGhpcy5pdGVtcyk7XG5cdFx0fVxuXHR9XG5cblx0dXBkYXRlSXRlbShpbmRleCwgaXRlbSkge1xuXHRcdHRoaXMuaXRlbXNbaW5kZXhdID0gaXRlbTtcblx0XHRpZih0aGlzLm9wdHMucGVyc2lzdCkge1xuXHRcdFx0dGhpcy5zZXRJdGVtc1N0b3JhZ2UodGhpcy5pdGVtcyk7XG5cdFx0fVxuXHR9XG5cblx0cmVtb3ZlSXRlbShpdGVtKSB7XG5cdFx0bGV0IGluZGV4ID0gdGhpcy5pdGVtcy5pbmRleE9mKGl0ZW0pO1xuXHRcdGlmKGluZGV4ICE9PSAtMSkge1xuXHRcdFx0dGhpcy5pdGVtcy5zcGxpY2UoaW5kZXgsIDEpO1xuXHRcdFx0aWYodGhpcy5vcHRzLnBlcnNpc3QpIHtcblx0XHRcdFx0dGhpcy5zZXRJdGVtc1N0b3JhZ2UodGhpcy5pdGVtcyk7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHR9XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG5cblx0Y2xlYXJJdGVtcygpIHtcblx0XHR0aGlzLml0ZW1zID0gW107XG5cdFx0aWYodGhpcy5vcHRzLnBlcnNpc3QpIHtcblx0XHRcdHRoaXMuc2V0SXRlbXNTdG9yYWdlKHRoaXMuaXRlbXMpO1xuXHRcdH1cblx0fVxuXG5cdGdldCBpdGVtc0NTTCgpIHtcblx0XHRyZXR1cm4gdGhpcy5pdGVtcy5tYXAoaSA9PiBpdGVtVG9DU0xKU09OKGkpKVxuXHR9XG5cblx0Z2V0IGl0ZW1zUmF3KCkge1xuXHRcdHJldHVybiB0aGlzLml0ZW1zO1xuXHR9XG5cblx0YXN5bmMgdHJhbnNsYXRlVXJsKHVybCwgYWRkID0gdHJ1ZSkge1xuXHRcdGxldCB0cmFuc2xhdGlvblNlcnZlclVybCA9IGAke3RoaXMub3B0cy50cmFuc2xhdGlvblNlcnZlclVybH0vJHt0aGlzLm9wdHMudHJhbnNsYXRpb25TZXJ2ZXJQcmVmaXh9d2ViYDtcblx0XHRsZXQgc2Vzc2lvbmlkID0gdGhpcy5vcHRzLnNlc3Npb25pZDtcblx0XHRsZXQgZGF0YSA9IE9iamVjdC5hc3NpZ24oeyB1cmwsIHNlc3Npb25pZCB9LCB0aGlzLm9wdHMucmVxdWVzdCk7XG5cblx0XHRsZXQgaW5pdCA9IE9iamVjdC5hc3NpZ24oe1xuXHRcdFx0bWV0aG9kOiAnUE9TVCcsXG5cdFx0XHRoZWFkZXJzOiB7XG5cdFx0XHRcdCdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcblx0XHRcdH0sXG5cdFx0XHRib2R5OiBKU09OLnN0cmluZ2lmeShkYXRhKVxuXHRcdH0sIHRoaXMub3B0cy5pbml0KTtcblxuXHRcdGxldCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHRyYW5zbGF0aW9uU2VydmVyVXJsLCBpbml0KTtcblx0XHRsZXQgaXRlbXMgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG5cdFx0aWYoQXJyYXkuaXNBcnJheShpdGVtcykpIHtcblx0XHRcdGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG5cdFx0XHRcdGlmKGl0ZW0uYWNjZXNzRGF0ZSA9PT0gJ0NVUlJFTlRfVElNRVNUQU1QJykge1xuXHRcdFx0XHRcdGNvbnN0IGR0ID0gbmV3IERhdGUoRGF0ZS5ub3coKSk7XG5cdFx0XHRcdFx0aXRlbS5hY2Nlc3NEYXRlID0gZGF0ZVRvU3FsKGR0LCB0cnVlKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmKGFkZCkge1xuXHRcdFx0XHRcdHRoaXMuYWRkSXRlbShpdGVtKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIEFycmF5LmlzQXJyYXkoaXRlbXMpICYmIGl0ZW1zIHx8IGZhbHNlO1xuXHR9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gWm90ZXJvQmliO1xuIiwiJ3VzZSBzdHJpY3QnO1xuXG5tb2R1bGUuZXhwb3J0cyA9ICgpID0+ICh7XG5cdHRyYW5zbGF0aW9uU2VydmVyVXJsOiB0eXBlb2Ygd2luZG93ICE9ICd1bmRlZmluZWQnICYmIHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4gfHwgJycsXG5cdHRyYW5zbGF0aW9uU2VydmVyUHJlZml4OiAnJyxcblx0ZmV0Y2hDb25maWc6IHt9LFxuXHRpbml0aWFsSXRlbXM6IFtdLFxuXHRyZXF1ZXN0OiB7fSxcblx0c3RvcmFnZTogdHlwZW9mIHdpbmRvdyAhPSAndW5kZWZpbmVkJyAmJiAnbG9jYWxTdG9yYWdlJyBpbiB3aW5kb3cgJiYgd2luZG93LmxvY2FsU3RvcmFnZSB8fCB7fSxcblx0cGVyc2lzdDogdHJ1ZSxcblx0b3ZlcnJpZGU6IGZhbHNlLFxuXHRzdG9yYWdlUHJlZml4OiAnem90ZXJvLWJpYidcbn0pO1xuIiwiJ3VzZSBzdHJpY3QnO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblx0dXVpZDQ6ICgpID0+ICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywgYyA9PiB7XG5cdFx0XHR2YXIgciA9IE1hdGgucmFuZG9tKCkgKiAxNnwwLFxuXHRcdFx0XHR2ID0gYyA9PSAneCcgPyByIDogKHImMHgzfDB4OCk7XG5cblx0XHRcdHJldHVybiB2LnRvU3RyaW5nKDE2KTtcblx0XHR9KVxufVxuIiwiJ3VzZSBzdHJpY3QnO1xuXG5yZXF1aXJlKCdlczYtcHJvbWlzZS9hdXRvJyk7XG5yZXF1aXJlKCdpc29tb3JwaGljLWZldGNoJyk7XG5yZXF1aXJlKCdiYWJlbC1yZWdlbmVyYXRvci1ydW50aW1lJyk7XG5jb25zdCBab3Rlcm9CaWIgPSByZXF1aXJlKCcuL2JpYi9iaWInKTtcblxubW9kdWxlLmV4cG9ydHMgPSBab3Rlcm9CaWI7XG4iLCIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGNyZWF0b3JUeXBlcyA9IHtcblx0MTogJ2F1dGhvcicsXG5cdDI6ICdjb250cmlidXRvcicsXG5cdDM6ICdlZGl0b3InLFxuXHQ0OiAndHJhbnNsYXRvcicsXG5cdDU6ICdzZXJpZXNFZGl0b3InLFxuXHQ2OiAnaW50ZXJ2aWV3ZWUnLFxuXHQ3OiAnaW50ZXJ2aWV3ZXInLFxuXHQ4OiAnZGlyZWN0b3InLFxuXHQ5OiAnc2NyaXB0d3JpdGVyJyxcblx0MTA6ICdwcm9kdWNlcicsXG5cdDExOiAnY2FzdE1lbWJlcicsXG5cdDEyOiAnc3BvbnNvcicsXG5cdDEzOiAnY291bnNlbCcsXG5cdDE0OiAnaW52ZW50b3InLFxuXHQxNTogJ2F0dG9ybmV5QWdlbnQnLFxuXHQxNjogJ3JlY2lwaWVudCcsXG5cdDE3OiAncGVyZm9ybWVyJyxcblx0MTg6ICdjb21wb3NlcicsXG5cdDE5OiAnd29yZHNCeScsXG5cdDIwOiAnY2FydG9ncmFwaGVyJyxcblx0MjE6ICdwcm9ncmFtbWVyJyxcblx0MjI6ICdhcnRpc3QnLFxuXHQyMzogJ2NvbW1lbnRlcicsXG5cdDI0OiAncHJlc2VudGVyJyxcblx0MjU6ICdndWVzdCcsXG5cdDI2OiAncG9kY2FzdGVyJyxcblx0Mjc6ICdyZXZpZXdlZEF1dGhvcicsXG5cdDI4OiAnY29zcG9uc29yJyxcblx0Mjk6ICdib29rQXV0aG9yJ1xufTtcblxuXG4vL3JldmVyc2UgbG9va3VwXG5PYmplY3Qua2V5cyhjcmVhdG9yVHlwZXMpLm1hcChrID0+IGNyZWF0b3JUeXBlc1tjcmVhdG9yVHlwZXNba11dID0gayk7XG5tb2R1bGUuZXhwb3J0cyA9IGNyZWF0b3JUeXBlcztcbiIsIm1vZHVsZS5leHBvcnRzID0ge1xuXHRDU0xfTkFNRVNfTUFQUElOR1M6IHtcblx0XHQnYXV0aG9yJzonYXV0aG9yJyxcblx0XHQnZWRpdG9yJzonZWRpdG9yJyxcblx0XHQnYm9va0F1dGhvcic6J2NvbnRhaW5lci1hdXRob3InLFxuXHRcdCdjb21wb3Nlcic6J2NvbXBvc2VyJyxcblx0XHQnZGlyZWN0b3InOidkaXJlY3RvcicsXG5cdFx0J2ludGVydmlld2VyJzonaW50ZXJ2aWV3ZXInLFxuXHRcdCdyZWNpcGllbnQnOidyZWNpcGllbnQnLFxuXHRcdCdyZXZpZXdlZEF1dGhvcic6J3Jldmlld2VkLWF1dGhvcicsXG5cdFx0J3Nlcmllc0VkaXRvcic6J2NvbGxlY3Rpb24tZWRpdG9yJyxcblx0XHQndHJhbnNsYXRvcic6J3RyYW5zbGF0b3InXG5cdH0sXG5cblx0Lypcblx0ICogTWFwcGluZ3MgZm9yIHRleHQgdmFyaWFibGVzXG5cdCAqL1xuXHRDU0xfVEVYVF9NQVBQSU5HUzoge1xuXHRcdCd0aXRsZSc6Wyd0aXRsZSddLFxuXHRcdCdjb250YWluZXItdGl0bGUnOlsncHVibGljYXRpb25UaXRsZScsICAncmVwb3J0ZXInLCAnY29kZSddLCAvKiByZXBvcnRlciBhbmQgY29kZSBzaG91bGQgbW92ZSB0byBTUUwgbWFwcGluZyB0YWJsZXMgKi9cblx0XHQnY29sbGVjdGlvbi10aXRsZSc6WydzZXJpZXNUaXRsZScsICdzZXJpZXMnXSxcblx0XHQnY29sbGVjdGlvbi1udW1iZXInOlsnc2VyaWVzTnVtYmVyJ10sXG5cdFx0J3B1Ymxpc2hlcic6WydwdWJsaXNoZXInLCAnZGlzdHJpYnV0b3InXSwgLyogZGlzdHJpYnV0b3Igc2hvdWxkIG1vdmUgdG8gU1FMIG1hcHBpbmcgdGFibGVzICovXG5cdFx0J3B1Ymxpc2hlci1wbGFjZSc6WydwbGFjZSddLFxuXHRcdCdhdXRob3JpdHknOlsnY291cnQnLCdsZWdpc2xhdGl2ZUJvZHknLCAnaXNzdWluZ0F1dGhvcml0eSddLFxuXHRcdCdwYWdlJzpbJ3BhZ2VzJ10sXG5cdFx0J3ZvbHVtZSc6Wyd2b2x1bWUnLCAnY29kZU51bWJlciddLFxuXHRcdCdpc3N1ZSc6Wydpc3N1ZScsICdwcmlvcml0eU51bWJlcnMnXSxcblx0XHQnbnVtYmVyLW9mLXZvbHVtZXMnOlsnbnVtYmVyT2ZWb2x1bWVzJ10sXG5cdFx0J251bWJlci1vZi1wYWdlcyc6WydudW1QYWdlcyddLFxuXHRcdCdlZGl0aW9uJzpbJ2VkaXRpb24nXSxcblx0XHQndmVyc2lvbic6Wyd2ZXJzaW9uTnVtYmVyJ10sXG5cdFx0J3NlY3Rpb24nOlsnc2VjdGlvbicsICdjb21taXR0ZWUnXSxcblx0XHQnZ2VucmUnOlsndHlwZScsICdwcm9ncmFtbWluZ0xhbmd1YWdlJ10sXG5cdFx0J3NvdXJjZSc6WydsaWJyYXJ5Q2F0YWxvZyddLFxuXHRcdCdkaW1lbnNpb25zJzogWydhcnR3b3JrU2l6ZScsICdydW5uaW5nVGltZSddLFxuXHRcdCdtZWRpdW0nOlsnbWVkaXVtJywgJ3N5c3RlbSddLFxuXHRcdCdzY2FsZSc6WydzY2FsZSddLFxuXHRcdCdhcmNoaXZlJzpbJ2FyY2hpdmUnXSxcblx0XHQnYXJjaGl2ZV9sb2NhdGlvbic6WydhcmNoaXZlTG9jYXRpb24nXSxcblx0XHQnZXZlbnQnOlsnbWVldGluZ05hbWUnLCAnY29uZmVyZW5jZU5hbWUnXSwgLyogdGhlc2Ugc2hvdWxkIGJlIG1hcHBlZCB0byB0aGUgc2FtZSBiYXNlIGZpZWxkIGluIFNRTCBtYXBwaW5nIHRhYmxlcyAqL1xuXHRcdCdldmVudC1wbGFjZSc6WydwbGFjZSddLFxuXHRcdCdhYnN0cmFjdCc6WydhYnN0cmFjdE5vdGUnXSxcblx0XHQnVVJMJzpbJ3VybCddLFxuXHRcdCdET0knOlsnRE9JJ10sXG5cdFx0J0lTQk4nOlsnSVNCTiddLFxuXHRcdCdJU1NOJzpbJ0lTU04nXSxcblx0XHQnY2FsbC1udW1iZXInOlsnY2FsbE51bWJlcicsICdhcHBsaWNhdGlvbk51bWJlciddLFxuXHRcdCdub3RlJzpbJ2V4dHJhJ10sXG5cdFx0J251bWJlcic6WydudW1iZXInXSxcblx0XHQnY2hhcHRlci1udW1iZXInOlsnc2Vzc2lvbiddLFxuXHRcdCdyZWZlcmVuY2VzJzpbJ2hpc3RvcnknLCAncmVmZXJlbmNlcyddLFxuXHRcdCdzaG9ydFRpdGxlJzpbJ3Nob3J0VGl0bGUnXSxcblx0XHQnam91cm5hbEFiYnJldmlhdGlvbic6Wydqb3VybmFsQWJicmV2aWF0aW9uJ10sXG5cdFx0J3N0YXR1cyc6WydsZWdhbFN0YXR1cyddLFxuXHRcdCdsYW5ndWFnZSc6WydsYW5ndWFnZSddXG5cdH0sXG5cdENTTF9EQVRFX01BUFBJTkdTOiB7XG5cdFx0J2lzc3VlZCc6J2RhdGUnLFxuXHRcdCdhY2Nlc3NlZCc6J2FjY2Vzc0RhdGUnLFxuXHRcdCdzdWJtaXR0ZWQnOidmaWxpbmdEYXRlJ1xuXHR9LFxuXHRDU0xfVFlQRV9NQVBQSU5HUzoge1xuXHRcdCdib29rJzonYm9vaycsXG5cdFx0J2Jvb2tTZWN0aW9uJzonY2hhcHRlcicsXG5cdFx0J2pvdXJuYWxBcnRpY2xlJzonYXJ0aWNsZS1qb3VybmFsJyxcblx0XHQnbWFnYXppbmVBcnRpY2xlJzonYXJ0aWNsZS1tYWdhemluZScsXG5cdFx0J25ld3NwYXBlckFydGljbGUnOidhcnRpY2xlLW5ld3NwYXBlcicsXG5cdFx0J3RoZXNpcyc6J3RoZXNpcycsXG5cdFx0J2VuY3ljbG9wZWRpYUFydGljbGUnOidlbnRyeS1lbmN5Y2xvcGVkaWEnLFxuXHRcdCdkaWN0aW9uYXJ5RW50cnknOidlbnRyeS1kaWN0aW9uYXJ5Jyxcblx0XHQnY29uZmVyZW5jZVBhcGVyJzoncGFwZXItY29uZmVyZW5jZScsXG5cdFx0J2xldHRlcic6J3BlcnNvbmFsX2NvbW11bmljYXRpb24nLFxuXHRcdCdtYW51c2NyaXB0JzonbWFudXNjcmlwdCcsXG5cdFx0J2ludGVydmlldyc6J2ludGVydmlldycsXG5cdFx0J2ZpbG0nOidtb3Rpb25fcGljdHVyZScsXG5cdFx0J2FydHdvcmsnOidncmFwaGljJyxcblx0XHQnd2VicGFnZSc6J3dlYnBhZ2UnLFxuXHRcdCdyZXBvcnQnOidyZXBvcnQnLFxuXHRcdCdiaWxsJzonYmlsbCcsXG5cdFx0J2Nhc2UnOidsZWdhbF9jYXNlJyxcblx0XHQnaGVhcmluZyc6J2JpbGwnLFx0XHRcdFx0Ly8gPz9cblx0XHQncGF0ZW50JzoncGF0ZW50Jyxcblx0XHQnc3RhdHV0ZSc6J2xlZ2lzbGF0aW9uJyxcdFx0Ly8gPz9cblx0XHQnZW1haWwnOidwZXJzb25hbF9jb21tdW5pY2F0aW9uJyxcblx0XHQnbWFwJzonbWFwJyxcblx0XHQnYmxvZ1Bvc3QnOidwb3N0LXdlYmxvZycsXG5cdFx0J2luc3RhbnRNZXNzYWdlJzoncGVyc29uYWxfY29tbXVuaWNhdGlvbicsXG5cdFx0J2ZvcnVtUG9zdCc6J3Bvc3QnLFxuXHRcdCdhdWRpb1JlY29yZGluZyc6J3NvbmcnLFx0XHQvLyA/P1xuXHRcdCdwcmVzZW50YXRpb24nOidzcGVlY2gnLFxuXHRcdCd2aWRlb1JlY29yZGluZyc6J21vdGlvbl9waWN0dXJlJyxcblx0XHQndHZCcm9hZGNhc3QnOidicm9hZGNhc3QnLFxuXHRcdCdyYWRpb0Jyb2FkY2FzdCc6J2Jyb2FkY2FzdCcsXG5cdFx0J3BvZGNhc3QnOidzb25nJyxcdFx0XHQvLyA/P1xuXHRcdCdjb21wdXRlclByb2dyYW0nOidib29rJyxcdFx0Ly8gPz9cblx0XHQnZG9jdW1lbnQnOidhcnRpY2xlJyxcblx0XHQnbm90ZSc6J2FydGljbGUnLFxuXHRcdCdhdHRhY2htZW50JzonYXJ0aWNsZSdcblx0fVxufTtcbiIsImNvbnN0IGxwYWQgPSByZXF1aXJlKCcuL2xwYWQnKTtcblxubW9kdWxlLmV4cG9ydHMgPSAoZGF0ZSwgdG9VVEMpID0+IHtcblx0dmFyIHllYXIsIG1vbnRoLCBkYXksIGhvdXJzLCBtaW51dGVzLCBzZWNvbmRzO1xuXHR0cnkge1xuXHRcdGlmKHRvVVRDKSB7XG5cdFx0XHR5ZWFyID0gZGF0ZS5nZXRVVENGdWxsWWVhcigpO1xuXHRcdFx0bW9udGggPSBkYXRlLmdldFVUQ01vbnRoKCk7XG5cdFx0XHRkYXkgPSBkYXRlLmdldFVUQ0RhdGUoKTtcblx0XHRcdGhvdXJzID0gZGF0ZS5nZXRVVENIb3VycygpO1xuXHRcdFx0bWludXRlcyA9IGRhdGUuZ2V0VVRDTWludXRlcygpO1xuXHRcdFx0c2Vjb25kcyA9IGRhdGUuZ2V0VVRDU2Vjb25kcygpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpO1xuXHRcdFx0bW9udGggPSBkYXRlLmdldE1vbnRoKCk7XG5cdFx0XHRkYXkgPSBkYXRlLmdldERhdGUoKTtcblx0XHRcdGhvdXJzID0gZGF0ZS5nZXRIb3VycygpO1xuXHRcdFx0bWludXRlcyA9IGRhdGUuZ2V0TWludXRlcygpO1xuXHRcdFx0c2Vjb25kcyA9IGRhdGUuZ2V0U2Vjb25kcygpO1xuXHRcdH1cblxuXHRcdHllYXIgPSBscGFkKHllYXIsICcwJywgNCk7XG5cdFx0bW9udGggPSBscGFkKG1vbnRoICsgMSwgJzAnLCAyKTtcblx0XHRkYXkgPSBscGFkKGRheSwgJzAnLCAyKTtcblx0XHRob3VycyA9IGxwYWQoaG91cnMsICcwJywgMik7XG5cdFx0bWludXRlcyA9IGxwYWQobWludXRlcywgJzAnLCAyKTtcblx0XHRzZWNvbmRzID0gbHBhZChzZWNvbmRzLCAnMCcsIDIpO1xuXG5cdFx0cmV0dXJuIHllYXIgKyAnLScgKyBtb250aCArICctJyArIGRheSArICcgJ1xuXHRcdFx0KyBob3VycyArICc6JyArIG1pbnV0ZXMgKyAnOicgKyBzZWNvbmRzO1xuXHR9XG5cdGNhdGNoIChlKSB7XG5cdFx0cmV0dXJuICcnO1xuXHR9XG59XG4iLCJjb25zdCBpdGVtVHlwZXMgPSByZXF1aXJlKCcuL2l0ZW0tdHlwZXMnKTtcbmNvbnN0IGNyZWF0b3JUeXBlcyA9IHJlcXVpcmUoJy4vY3JlYXRvci10eXBlcycpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblx0W2l0ZW1UeXBlc1syXV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1szXV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1s0XV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1s1XV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1s2XV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1s3XV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1s4XV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1s5XV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1sxMF1dOiBjcmVhdG9yVHlwZXNbNl0sXG5cdFtpdGVtVHlwZXNbMTFdXTogY3JlYXRvclR5cGVzWzhdLFxuXHRbaXRlbVR5cGVzWzEyXV06IGNyZWF0b3JUeXBlc1syMl0sXG5cdFtpdGVtVHlwZXNbMTNdXTogY3JlYXRvclR5cGVzWzFdLFxuXHRbaXRlbVR5cGVzWzE1XV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1sxNl1dOiBjcmVhdG9yVHlwZXNbMTJdLFxuXHRbaXRlbVR5cGVzWzE3XV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1sxOF1dOiBjcmVhdG9yVHlwZXNbMl0sXG5cdFtpdGVtVHlwZXNbMTldXTogY3JlYXRvclR5cGVzWzE0XSxcblx0W2l0ZW1UeXBlc1syMF1dOiBjcmVhdG9yVHlwZXNbMV0sXG5cdFtpdGVtVHlwZXNbMjFdXTogY3JlYXRvclR5cGVzWzFdLFxuXHRbaXRlbVR5cGVzWzIyXV06IGNyZWF0b3JUeXBlc1syMF0sXG5cdFtpdGVtVHlwZXNbMjNdXTogY3JlYXRvclR5cGVzWzFdLFxuXHRbaXRlbVR5cGVzWzI0XV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1syNV1dOiBjcmVhdG9yVHlwZXNbMV0sXG5cdFtpdGVtVHlwZXNbMjZdXTogY3JlYXRvclR5cGVzWzE3XSxcblx0W2l0ZW1UeXBlc1syN11dOiBjcmVhdG9yVHlwZXNbMjRdLFxuXHRbaXRlbVR5cGVzWzI4XV06IGNyZWF0b3JUeXBlc1s4XSxcblx0W2l0ZW1UeXBlc1syOV1dOiBjcmVhdG9yVHlwZXNbOF0sXG5cdFtpdGVtVHlwZXNbMzBdXTogY3JlYXRvclR5cGVzWzhdLFxuXHRbaXRlbVR5cGVzWzMxXV06IGNyZWF0b3JUeXBlc1syNl0sXG5cdFtpdGVtVHlwZXNbMzJdXTogY3JlYXRvclR5cGVzWzIxXSxcblx0W2l0ZW1UeXBlc1szM11dOiBjcmVhdG9yVHlwZXNbMV0sXG5cdFtpdGVtVHlwZXNbMzRdXTogY3JlYXRvclR5cGVzWzFdLFxuXHRbaXRlbVR5cGVzWzM1XV06IGNyZWF0b3JUeXBlc1sxXSxcblx0W2l0ZW1UeXBlc1szNl1dOiBjcmVhdG9yVHlwZXNbMV1cbn07XG4iLCIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGZpZWxkcyA9IHtcblx0MTogJ3VybCcsXG5cdDI6ICdyaWdodHMnLFxuXHQzOiAnc2VyaWVzJyxcblx0NDogJ3ZvbHVtZScsXG5cdDU6ICdpc3N1ZScsXG5cdDY6ICdlZGl0aW9uJyxcblx0NzogJ3BsYWNlJyxcblx0ODogJ3B1Ymxpc2hlcicsXG5cdDEwOiAncGFnZXMnLFxuXHQxMTogJ0lTQk4nLFxuXHQxMjogJ3B1YmxpY2F0aW9uVGl0bGUnLFxuXHQxMzogJ0lTU04nLFxuXHQxNDogJ2RhdGUnLFxuXHQxNTogJ3NlY3Rpb24nLFxuXHQxODogJ2NhbGxOdW1iZXInLFxuXHQxOTogJ2FyY2hpdmVMb2NhdGlvbicsXG5cdDIxOiAnZGlzdHJpYnV0b3InLFxuXHQyMjogJ2V4dHJhJyxcblx0MjU6ICdqb3VybmFsQWJicmV2aWF0aW9uJyxcblx0MjY6ICdET0knLFxuXHQyNzogJ2FjY2Vzc0RhdGUnLFxuXHQyODogJ3Nlcmllc1RpdGxlJyxcblx0Mjk6ICdzZXJpZXNUZXh0Jyxcblx0MzA6ICdzZXJpZXNOdW1iZXInLFxuXHQzMTogJ2luc3RpdHV0aW9uJyxcblx0MzI6ICdyZXBvcnRUeXBlJyxcblx0MzY6ICdjb2RlJyxcblx0NDA6ICdzZXNzaW9uJyxcblx0NDE6ICdsZWdpc2xhdGl2ZUJvZHknLFxuXHQ0MjogJ2hpc3RvcnknLFxuXHQ0MzogJ3JlcG9ydGVyJyxcblx0NDQ6ICdjb3VydCcsXG5cdDQ1OiAnbnVtYmVyT2ZWb2x1bWVzJyxcblx0NDY6ICdjb21taXR0ZWUnLFxuXHQ0ODogJ2Fzc2lnbmVlJyxcblx0NTA6ICdwYXRlbnROdW1iZXInLFxuXHQ1MTogJ3ByaW9yaXR5TnVtYmVycycsXG5cdDUyOiAnaXNzdWVEYXRlJyxcblx0NTM6ICdyZWZlcmVuY2VzJyxcblx0NTQ6ICdsZWdhbFN0YXR1cycsXG5cdDU1OiAnY29kZU51bWJlcicsXG5cdDU5OiAnYXJ0d29ya01lZGl1bScsXG5cdDYwOiAnbnVtYmVyJyxcblx0NjE6ICdhcnR3b3JrU2l6ZScsXG5cdDYyOiAnbGlicmFyeUNhdGFsb2cnLFxuXHQ2MzogJ3ZpZGVvUmVjb3JkaW5nRm9ybWF0Jyxcblx0NjQ6ICdpbnRlcnZpZXdNZWRpdW0nLFxuXHQ2NTogJ2xldHRlclR5cGUnLFxuXHQ2NjogJ21hbnVzY3JpcHRUeXBlJyxcblx0Njc6ICdtYXBUeXBlJyxcblx0Njg6ICdzY2FsZScsXG5cdDY5OiAndGhlc2lzVHlwZScsXG5cdDcwOiAnd2Vic2l0ZVR5cGUnLFxuXHQ3MTogJ2F1ZGlvUmVjb3JkaW5nRm9ybWF0Jyxcblx0NzI6ICdsYWJlbCcsXG5cdDc0OiAncHJlc2VudGF0aW9uVHlwZScsXG5cdDc1OiAnbWVldGluZ05hbWUnLFxuXHQ3NjogJ3N0dWRpbycsXG5cdDc3OiAncnVubmluZ1RpbWUnLFxuXHQ3ODogJ25ldHdvcmsnLFxuXHQ3OTogJ3Bvc3RUeXBlJyxcblx0ODA6ICdhdWRpb0ZpbGVUeXBlJyxcblx0ODE6ICd2ZXJzaW9uTnVtYmVyJyxcblx0ODI6ICdzeXN0ZW0nLFxuXHQ4MzogJ2NvbXBhbnknLFxuXHQ4NDogJ2NvbmZlcmVuY2VOYW1lJyxcblx0ODU6ICdlbmN5Y2xvcGVkaWFUaXRsZScsXG5cdDg2OiAnZGljdGlvbmFyeVRpdGxlJyxcblx0ODc6ICdsYW5ndWFnZScsXG5cdDg4OiAncHJvZ3JhbW1pbmdMYW5ndWFnZScsXG5cdDg5OiAndW5pdmVyc2l0eScsXG5cdDkwOiAnYWJzdHJhY3ROb3RlJyxcblx0OTE6ICd3ZWJzaXRlVGl0bGUnLFxuXHQ5MjogJ3JlcG9ydE51bWJlcicsXG5cdDkzOiAnYmlsbE51bWJlcicsXG5cdDk0OiAnY29kZVZvbHVtZScsXG5cdDk1OiAnY29kZVBhZ2VzJyxcblx0OTY6ICdkYXRlRGVjaWRlZCcsXG5cdDk3OiAncmVwb3J0ZXJWb2x1bWUnLFxuXHQ5ODogJ2ZpcnN0UGFnZScsXG5cdDk5OiAnZG9jdW1lbnROdW1iZXInLFxuXHQxMDA6ICdkYXRlRW5hY3RlZCcsXG5cdDEwMTogJ3B1YmxpY0xhd051bWJlcicsXG5cdDEwMjogJ2NvdW50cnknLFxuXHQxMDM6ICdhcHBsaWNhdGlvbk51bWJlcicsXG5cdDEwNDogJ2ZvcnVtVGl0bGUnLFxuXHQxMDU6ICdlcGlzb2RlTnVtYmVyJyxcblx0MTA3OiAnYmxvZ1RpdGxlJyxcblx0MTA4OiAndHlwZScsXG5cdDEwOTogJ21lZGl1bScsXG5cdDExMDogJ3RpdGxlJyxcblx0MTExOiAnY2FzZU5hbWUnLFxuXHQxMTI6ICduYW1lT2ZBY3QnLFxuXHQxMTM6ICdzdWJqZWN0Jyxcblx0MTE0OiAncHJvY2VlZGluZ3NUaXRsZScsXG5cdDExNTogJ2Jvb2tUaXRsZScsXG5cdDExNjogJ3Nob3J0VGl0bGUnLFxuXHQxMTc6ICdkb2NrZXROdW1iZXInLFxuXHQxMTg6ICdudW1QYWdlcycsXG5cdDExOTogJ3Byb2dyYW1UaXRsZScsXG5cdDEyMDogJ2lzc3VpbmdBdXRob3JpdHknLFxuXHQxMjE6ICdmaWxpbmdEYXRlJyxcblx0MTIyOiAnZ2VucmUnLFxuXHQxMjM6ICdhcmNoaXZlJ1xufTtcblxuLy9yZXZlcnNlIGxvb2t1cFxuT2JqZWN0LmtleXMoZmllbGRzKS5tYXAoayA9PiBmaWVsZHNbZmllbGRzW2tdXSA9IGspO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZpZWxkcztcbiIsIid1c2Ugc3RyaWN0JztcblxuY29uc3Qge1xuXHRDU0xfTkFNRVNfTUFQUElOR1MsXG5cdENTTF9URVhUX01BUFBJTkdTLFxuXHRDU0xfREFURV9NQVBQSU5HUyxcblx0Q1NMX1RZUEVfTUFQUElOR1Ncbn0gPSByZXF1aXJlKCcuL2NzbC1tYXBwaW5ncycpO1xuXG5jb25zdCBDU0wgPSByZXF1aXJlKCdjaXRlcHJvYycpO1xuY29uc3QgeyBnZXRGaWVsZElERnJvbVR5cGVBbmRCYXNlIH0gPSByZXF1aXJlKCcuL3R5cGUtc3BlY2lmaWMtZmllbGQtbWFwJyk7XG5jb25zdCBmaWVsZHMgPSByZXF1aXJlKCcuL2ZpZWxkcycpO1xuY29uc3QgaXRlbVR5cGVzID0gcmVxdWlyZSgnLi9pdGVtLXR5cGVzJyk7XG5jb25zdCBzdHJUb0RhdGUgPSByZXF1aXJlKCcuL3N0ci10by1kYXRlJyk7XG5jb25zdCBkZWZhdWx0SXRlbVR5cGVDcmVhdG9yVHlwZUxvb2t1cCA9IHJlcXVpcmUoJy4vZGVmYXVsdC1pdGVtLXR5cGUtY3JlYXRvci10eXBlLWxvb2t1cCcpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHpvdGVyb0l0ZW0gPT4ge1xuXHR2YXIgY3NsVHlwZSA9IENTTF9UWVBFX01BUFBJTkdTW3pvdGVyb0l0ZW0uaXRlbVR5cGVdO1xuXHRpZiAoIWNzbFR5cGUpIHtcblx0XHR0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgWm90ZXJvIEl0ZW0gdHlwZSBcIicgKyB6b3Rlcm9JdGVtLml0ZW1UeXBlICsgJ1wiJyk7XG5cdH1cblxuXHR2YXIgaXRlbVR5cGVJRCA9IGl0ZW1UeXBlc1t6b3Rlcm9JdGVtLml0ZW1UeXBlXTtcblxuXHR2YXIgY3NsSXRlbSA9IHtcblx0XHQvLyAnaWQnOnpvdGVyb0l0ZW0udXJpLFxuXHRcdGlkOiB6b3Rlcm9JdGVtLml0ZW1LZXksXG5cdFx0J3R5cGUnOmNzbFR5cGVcblx0fTtcblxuXHQvLyBnZXQgYWxsIHRleHQgdmFyaWFibGVzICh0aGVyZSBtdXN0IGJlIGEgYmV0dGVyIHdheSlcblx0Zm9yKGxldCB2YXJpYWJsZSBpbiBDU0xfVEVYVF9NQVBQSU5HUykge1xuXHRcdGxldCBmaWVsZHMgPSBDU0xfVEVYVF9NQVBQSU5HU1t2YXJpYWJsZV07XG5cdFx0Zm9yKGxldCBpPTAsIG49ZmllbGRzLmxlbmd0aDsgaTxuOyBpKyspIHtcblx0XHRcdGxldCBmaWVsZCA9IGZpZWxkc1tpXSxcblx0XHRcdFx0dmFsdWUgPSBudWxsO1xuXG5cdFx0XHRpZihmaWVsZCBpbiB6b3Rlcm9JdGVtKSB7XG5cdFx0XHRcdHZhbHVlID0gem90ZXJvSXRlbVtmaWVsZF07XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHQvLyBATk9URTogRG9lcyB0aGlzIG5lZWQgcG9ydGluZz9cblx0XHRcdFx0Ly8gaWYgKGZpZWxkID09ICd2ZXJzaW9uTnVtYmVyJykge1xuXHRcdFx0XHQvLyBcdGZpZWxkID0gJ3ZlcnNpb24nOyAvLyBVbnRpbCBodHRwczovL2dpdGh1Yi5jb20vem90ZXJvL3pvdGVyby9pc3N1ZXMvNjcwXG5cdFx0XHRcdC8vIH1cblx0XHRcdFx0Ly8gdmFyIGZpZWxkSUQgPSBab3Rlcm8uSXRlbUZpZWxkcy5nZXRJRChmaWVsZCksXG5cdFx0XHRcdC8vIFx0dHlwZUZpZWxkSUQ7XG5cdFx0XHRcdC8vIGlmKGZpZWxkSURcblx0XHRcdFx0Ly8gXHQmJiAodHlwZUZpZWxkSUQgPSBab3Rlcm8uSXRlbUZpZWxkcy5nZXRGaWVsZElERnJvbVR5cGVBbmRCYXNlKGl0ZW1UeXBlSUQsIGZpZWxkSUQpKVxuXHRcdFx0XHQvLyApIHtcblx0XHRcdFx0Ly8gXHR2YWx1ZSA9IHpvdGVyb0l0ZW1bWm90ZXJvLkl0ZW1GaWVsZHMuZ2V0TmFtZSh0eXBlRmllbGRJRCldO1xuXHRcdFx0XHQvLyB9XG5cdFx0XHR9XG5cblx0XHRcdGlmICghdmFsdWUpIGNvbnRpbnVlO1xuXG5cdFx0XHRpZiAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdGlmIChmaWVsZCA9PSAnSVNCTicpIHtcblx0XHRcdFx0XHQvLyBPbmx5IHVzZSB0aGUgZmlyc3QgSVNCTiBpbiBDU0wgSlNPTlxuXHRcdFx0XHRcdHZhciBpc2JuID0gdmFsdWUubWF0Y2goL14oPzo5N1s4OV0tPyk/KD86XFxkLT8pezl9W1xcZHhdKD8hLSlcXGIvaSk7XG5cdFx0XHRcdFx0aWYoaXNibikge1xuXHRcdFx0XHRcdFx0dmFsdWUgPSBpc2JuWzBdO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXG5cdFx0XHRcdC8vIFN0cmlwIGVuY2xvc2luZyBxdW90ZXNcblx0XHRcdFx0aWYodmFsdWUuY2hhckF0KDApID09ICdcIicgJiYgdmFsdWUuaW5kZXhPZignXCInLCAxKSA9PSB2YWx1ZS5sZW5ndGggLSAxKSB7XG5cdFx0XHRcdFx0dmFsdWUgPSB2YWx1ZS5zdWJzdHJpbmcoMSwgdmFsdWUubGVuZ3RoIC0gMSk7XG5cdFx0XHRcdH1cblx0XHRcdFx0Y3NsSXRlbVt2YXJpYWJsZV0gPSB2YWx1ZTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0Ly8gc2VwYXJhdGUgbmFtZSB2YXJpYWJsZXNcblx0aWYgKHpvdGVyb0l0ZW0udHlwZSAhPSAnYXR0YWNobWVudCcgJiYgem90ZXJvSXRlbS50eXBlICE9ICdub3RlJykge1xuXHRcdC8vIHZhciBhdXRob3IgPSBab3Rlcm8uQ3JlYXRvclR5cGVzLmdldE5hbWUoWm90ZXJvLkNyZWF0b3JUeXBlcy5nZXRQcmltYXJ5SURGb3JUeXBlKCkpO1xuXHRcdGxldCBhdXRob3IgPSBkZWZhdWx0SXRlbVR5cGVDcmVhdG9yVHlwZUxvb2t1cFtpdGVtVHlwZUlEXTtcblx0XHRsZXQgY3JlYXRvcnMgPSB6b3Rlcm9JdGVtLmNyZWF0b3JzO1xuXHRcdGZvcihsZXQgaSA9IDA7IGNyZWF0b3JzICYmIGkgPCBjcmVhdG9ycy5sZW5ndGg7IGkrKykge1xuXHRcdFx0bGV0IGNyZWF0b3IgPSBjcmVhdG9yc1tpXTtcblx0XHRcdGxldCBjcmVhdG9yVHlwZSA9IGNyZWF0b3IuY3JlYXRvclR5cGU7XG5cdFx0XHRsZXQgbmFtZU9iajtcblxuXHRcdFx0aWYoY3JlYXRvclR5cGUgPT0gYXV0aG9yKSB7XG5cdFx0XHRcdGNyZWF0b3JUeXBlID0gJ2F1dGhvcic7XG5cdFx0XHR9XG5cblx0XHRcdGNyZWF0b3JUeXBlID0gQ1NMX05BTUVTX01BUFBJTkdTW2NyZWF0b3JUeXBlXTtcblx0XHRcdGlmKCFjcmVhdG9yVHlwZSkge1xuXHRcdFx0XHRjb250aW51ZTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKCdsYXN0TmFtZScgaW4gY3JlYXRvciB8fCAnZmlyc3ROYW1lJyBpbiBjcmVhdG9yKSB7XG5cdFx0XHRcdG5hbWVPYmogPSB7XG5cdFx0XHRcdFx0ZmFtaWx5OiBjcmVhdG9yLmxhc3ROYW1lIHx8ICcnLFxuXHRcdFx0XHRcdGdpdmVuOiBjcmVhdG9yLmZpcnN0TmFtZSB8fCAnJ1xuXHRcdFx0XHR9O1xuXG5cdFx0XHRcdC8vIFBhcnNlIG5hbWUgcGFydGljbGVzXG5cdFx0XHRcdC8vIFJlcGxpY2F0ZSBjaXRlcHJvYy1qcyBsb2dpYyBmb3Igd2hhdCBzaG91bGQgYmUgcGFyc2VkIHNvIHdlIGRvbid0XG5cdFx0XHRcdC8vIGJyZWFrIGN1cnJlbnQgYmVoYXZpb3IuXG5cdFx0XHRcdGlmIChuYW1lT2JqLmZhbWlseSAmJiBuYW1lT2JqLmdpdmVuKSB7XG5cdFx0XHRcdFx0Ly8gRG9uJ3QgcGFyc2UgaWYgbGFzdCBuYW1lIGlzIHF1b3RlZFxuXHRcdFx0XHRcdGlmIChuYW1lT2JqLmZhbWlseS5sZW5ndGggPiAxXG5cdFx0XHRcdFx0XHQmJiBuYW1lT2JqLmZhbWlseS5jaGFyQXQoMCkgPT0gJ1wiJ1xuXHRcdFx0XHRcdFx0JiYgbmFtZU9iai5mYW1pbHkuY2hhckF0KG5hbWVPYmouZmFtaWx5Lmxlbmd0aCAtIDEpID09ICdcIidcblx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdG5hbWVPYmouZmFtaWx5ID0gbmFtZU9iai5mYW1pbHkuc3Vic3RyKDEsIG5hbWVPYmouZmFtaWx5Lmxlbmd0aCAtIDIpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRDU0wucGFyc2VQYXJ0aWNsZXMobmFtZU9iaiwgdHJ1ZSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2UgaWYgKCduYW1lJyBpbiBjcmVhdG9yKSB7XG5cdFx0XHRcdG5hbWVPYmogPSB7J2xpdGVyYWwnOiBjcmVhdG9yLm5hbWV9O1xuXHRcdFx0fVxuXG5cdFx0XHRpZihjc2xJdGVtW2NyZWF0b3JUeXBlXSkge1xuXHRcdFx0XHRjc2xJdGVtW2NyZWF0b3JUeXBlXS5wdXNoKG5hbWVPYmopO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0Y3NsSXRlbVtjcmVhdG9yVHlwZV0gPSBbbmFtZU9ial07XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0Ly8gZ2V0IGRhdGUgdmFyaWFibGVzXG5cdGZvcihsZXQgdmFyaWFibGUgaW4gQ1NMX0RBVEVfTUFQUElOR1MpIHtcblx0XHRsZXQgZGF0ZSA9IHpvdGVyb0l0ZW1bQ1NMX0RBVEVfTUFQUElOR1NbdmFyaWFibGVdXTtcblx0XHRpZiAoIWRhdGUpIHtcblxuXHRcdFx0bGV0IHR5cGVTcGVjaWZpY0ZpZWxkSUQgPSBnZXRGaWVsZElERnJvbVR5cGVBbmRCYXNlKGl0ZW1UeXBlSUQsIENTTF9EQVRFX01BUFBJTkdTW3ZhcmlhYmxlXSk7XG5cdFx0XHRpZiAodHlwZVNwZWNpZmljRmllbGRJRCkge1xuXHRcdFx0XHRkYXRlID0gem90ZXJvSXRlbVtmaWVsZHNbdHlwZVNwZWNpZmljRmllbGRJRF1dO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmKGRhdGUpIHtcblx0XHRcdGxldCBkYXRlT2JqID0gc3RyVG9EYXRlKGRhdGUpO1xuXHRcdFx0Ly8gb3RoZXJ3aXNlLCB1c2UgZGF0ZS1wYXJ0c1xuXHRcdFx0bGV0IGRhdGVQYXJ0cyA9IFtdO1xuXHRcdFx0aWYoZGF0ZU9iai55ZWFyKSB7XG5cdFx0XHRcdC8vIGFkZCB5ZWFyLCBtb250aCwgYW5kIGRheSwgaWYgdGhleSBleGlzdFxuXHRcdFx0XHRkYXRlUGFydHMucHVzaChkYXRlT2JqLnllYXIpO1xuXHRcdFx0XHRpZihkYXRlT2JqLm1vbnRoICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRkYXRlUGFydHMucHVzaChkYXRlT2JqLm1vbnRoKzEpO1xuXHRcdFx0XHRcdGlmKGRhdGVPYmouZGF5KSB7XG5cdFx0XHRcdFx0XHRkYXRlUGFydHMucHVzaChkYXRlT2JqLmRheSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdGNzbEl0ZW1bdmFyaWFibGVdID0geydkYXRlLXBhcnRzJzpbZGF0ZVBhcnRzXX07XG5cblx0XHRcdFx0Ly8gaWYgbm8gbW9udGgsIHVzZSBzZWFzb24gYXMgbW9udGhcblx0XHRcdFx0aWYoZGF0ZU9iai5wYXJ0ICYmIGRhdGVPYmoubW9udGggPT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdGNzbEl0ZW1bdmFyaWFibGVdLnNlYXNvbiA9IGRhdGVPYmoucGFydDtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0Ly8gaWYgbm8geWVhciwgcGFzcyBkYXRlIGxpdGVyYWxseVxuXHRcdFx0XHRjc2xJdGVtW3ZhcmlhYmxlXSA9IHsnbGl0ZXJhbCc6ZGF0ZX07XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0Ly8gU3BlY2lhbCBtYXBwaW5nIGZvciBub3RlIHRpdGxlXG5cdC8vIEBOT1RFOiBOb3QgcG9ydGVkXG5cdC8vIGlmICh6b3Rlcm9JdGVtLml0ZW1UeXBlID09ICdub3RlJyAmJiB6b3Rlcm9JdGVtLm5vdGUpIHtcblx0Ly8gXHRjc2xJdGVtLnRpdGxlID0gWm90ZXJvLk5vdGVzLm5vdGVUb1RpdGxlKHpvdGVyb0l0ZW0ubm90ZSk7XG5cdC8vIH1cblxuXHQvL3RoaXMuX2NhY2hlW3pvdGVyb0l0ZW0uaWRdID0gY3NsSXRlbTtcblx0cmV0dXJuIGNzbEl0ZW07XG59XG4iLCIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGl0ZW1UeXBlcyA9IHtcblx0MTogJ25vdGUnLFxuXHQyOiAnYm9vaycsXG5cdDM6ICdib29rU2VjdGlvbicsXG5cdDQ6ICdqb3VybmFsQXJ0aWNsZScsXG5cdDU6ICdtYWdhemluZUFydGljbGUnLFxuXHQ2OiAnbmV3c3BhcGVyQXJ0aWNsZScsXG5cdDc6ICd0aGVzaXMnLFxuXHQ4OiAnbGV0dGVyJyxcblx0OTogJ21hbnVzY3JpcHQnLFxuXHQxMDogJ2ludGVydmlldycsXG5cdDExOiAnZmlsbScsXG5cdDEyOiAnYXJ0d29yaycsXG5cdDEzOiAnd2VicGFnZScsXG5cdDE0OiAnYXR0YWNobWVudCcsXG5cdDE1OiAncmVwb3J0Jyxcblx0MTY6ICdiaWxsJyxcblx0MTc6ICdjYXNlJyxcblx0MTg6ICdoZWFyaW5nJyxcblx0MTk6ICdwYXRlbnQnLFxuXHQyMDogJ3N0YXR1dGUnLFxuXHQyMTogJ2VtYWlsJyxcblx0MjI6ICdtYXAnLFxuXHQyMzogJ2Jsb2dQb3N0Jyxcblx0MjQ6ICdpbnN0YW50TWVzc2FnZScsXG5cdDI1OiAnZm9ydW1Qb3N0Jyxcblx0MjY6ICdhdWRpb1JlY29yZGluZycsXG5cdDI3OiAncHJlc2VudGF0aW9uJyxcblx0Mjg6ICd2aWRlb1JlY29yZGluZycsXG5cdDI5OiAndHZCcm9hZGNhc3QnLFxuXHQzMDogJ3JhZGlvQnJvYWRjYXN0Jyxcblx0MzE6ICdwb2RjYXN0Jyxcblx0MzI6ICdjb21wdXRlclByb2dyYW0nLFxuXHQzMzogJ2NvbmZlcmVuY2VQYXBlcicsXG5cdDM0OiAnZG9jdW1lbnQnLFxuXHQzNTogJ2VuY3ljbG9wZWRpYUFydGljbGUnLFxuXHQzNjogJ2RpY3Rpb25hcnlFbnRyeSdcbn07XG5cbi8vcmV2ZXJzZSBsb29rdXBcbk9iamVjdC5rZXlzKGl0ZW1UeXBlcykubWFwKGsgPT4gaXRlbVR5cGVzW2l0ZW1UeXBlc1trXV0gPSBrKTtcbm1vZHVsZS5leHBvcnRzID0gaXRlbVR5cGVzO1xuIiwiJ3VzZSBzdHJpY3QnO1xuXG5tb2R1bGUuZXhwb3J0cyA9IChzdHJpbmcsIHBhZCwgbGVuZ3RoKSA9PiB7XG5cdHN0cmluZyA9IHN0cmluZyA/IHN0cmluZyArICcnIDogJyc7XG5cdHdoaWxlKHN0cmluZy5sZW5ndGggPCBsZW5ndGgpIHtcblx0XHRzdHJpbmcgPSBwYWQgKyBzdHJpbmc7XG5cdH1cblx0cmV0dXJuIHN0cmluZztcbn1cbiIsIid1c2Ugc3RyaWN0JztcblxuY29uc3QgZGF0ZVRvU1FMID0gcmVxdWlyZSgnLi9kYXRlLXRvLXNxbCcpO1xuXG5jb25zdCBtb250aHMgPSBbJ2phbicsICdmZWInLCAnbWFyJywgJ2FwcicsICdtYXknLCAnanVuJywgJ2p1bCcsICdhdWcnLCAnc2VwJywgJ29jdCcsICdub3YnLCAnZGVjJywgJ2phbnVhcnknLCAnZmVicnVhcnknLCAnbWFyY2gnLCAnYXByaWwnLCAnbWF5JywgJ2p1bmUnLCAnanVseScsICdhdWd1c3QnLCAnc2VwdGVtYmVyJywgJ29jdG9iZXInLCAnbm92ZW1iZXInLCAnZGVjZW1iZXInXTtcblxuY29uc3QgX3NsYXNoUmUgPSAvXiguKj8pXFxiKFswLTldezEsNH0pKD86KFtcXC1cXC9cXC5cXHU1ZTc0XSkoWzAtOV17MSwyfSkpPyg/OihbXFwtXFwvXFwuXFx1NjcwOF0pKFswLTldezEsNH0pKT8oKD86XFxifFteMC05XSkuKj8pJC9cbmNvbnN0IF95ZWFyUmUgPSAvXiguKj8pXFxiKCg/OmNpcmNhIHxhcm91bmQgfGFib3V0IHxjXFwuPyA/KT9bMC05XXsxLDR9KD86ID9CXFwuPyA/Q1xcLj8oPzogP0VcXC4/KT98ID9DXFwuPyA/RVxcLj98ID9BXFwuPyA/RFxcLj8pfFswLTldezMsNH0pXFxiKC4qPykkL2k7XG5jb25zdCBfbW9udGhSZSA9IG5ldyBSZWdFeHAoJ14oLiopXFxcXGIoJyArIG1vbnRocy5qb2luKCd8JykgKyAnKVteIF0qKD86ICguKikkfCQpJywgJ2knKTtcbmNvbnN0IF9kYXlSZSA9IG5ldyBSZWdFeHAoJ1xcXFxiKFswLTldezEsMn0pKD86c3R8bmR8cmR8dGgpP1xcXFxiKC4qKScsICdpJyk7XG5cbmNvbnN0IF9pbnNlcnREYXRlT3JkZXJQYXJ0ID0gKGRhdGVPcmRlciwgcGFydCwgcGFydE9yZGVyKSA9PiB7XG5cdFx0aWYgKCFkYXRlT3JkZXIpIHtcblx0XHRcdHJldHVybiBwYXJ0O1xuXHRcdH1cblx0XHRpZiAocGFydE9yZGVyLmJlZm9yZSA9PT0gdHJ1ZSkge1xuXHRcdFx0cmV0dXJuIHBhcnQgKyBkYXRlT3JkZXI7XG5cdFx0fVxuXHRcdGlmIChwYXJ0T3JkZXIuYWZ0ZXIgPT09IHRydWUpIHtcblx0XHRcdHJldHVybiBkYXRlT3JkZXIgKyBwYXJ0O1xuXHRcdH1cblx0XHRpZiAocGFydE9yZGVyLmJlZm9yZSkge1xuXHRcdFx0bGV0IHBvcyA9IGRhdGVPcmRlci5pbmRleE9mKHBhcnRPcmRlci5iZWZvcmUpO1xuXHRcdFx0aWYgKHBvcyA9PSAtMSkge1xuXHRcdFx0XHRyZXR1cm4gZGF0ZU9yZGVyO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIGRhdGVPcmRlci5yZXBsYWNlKG5ldyBSZWdFeHAoJygnICsgcGFydE9yZGVyLmJlZm9yZSArICcpJyksIHBhcnQgKyAnJDEnKTtcblx0XHR9XG5cdFx0aWYgKHBhcnRPcmRlci5hZnRlcikge1xuXHRcdFx0bGV0IHBvcyA9IGRhdGVPcmRlci5pbmRleE9mKHBhcnRPcmRlci5hZnRlcik7XG5cdFx0XHRpZiAocG9zID09IC0xKSB7XG5cdFx0XHRcdHJldHVybiBkYXRlT3JkZXIgKyBwYXJ0O1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIGRhdGVPcmRlci5yZXBsYWNlKG5ldyBSZWdFeHAoJygnICsgcGFydE9yZGVyLmFmdGVyICsgJyknKSwgJyQxJyArIHBhcnQpO1xuXHRcdH1cblx0XHRyZXR1cm4gZGF0ZU9yZGVyICsgcGFydDtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBzdHJpbmcgPT4ge1xuXHR2YXIgZGF0ZSA9IHtcblx0XHRvcmRlcjogJydcblx0fTtcblxuXHQvLyBza2lwIGVtcHR5IHRoaW5nc1xuXHRpZighc3RyaW5nKSB7XG5cdFx0cmV0dXJuIGRhdGU7XG5cdH1cblxuXHR2YXIgcGFydHMgPSBbXTtcblxuXHQvLyBQYXJzZSAneWVzdGVyZGF5Jy8ndG9kYXknLyd0b21vcnJvdydcblx0bGV0IGxjID0gKHN0cmluZyArICcnKS50b0xvd2VyQ2FzZSgpO1xuXHRpZiAobGMgPT0gJ3llc3RlcmRheScpIHtcblx0XHRzdHJpbmcgPSBkYXRlVG9TUUwobmV3IERhdGUoRGF0ZS5ub3coKSAtIDEwMDAqNjAqNjAqMjQpKS5zdWJzdHIoMCwgMTApO1xuXHR9XG5cdGVsc2UgaWYgKGxjID09ICd0b2RheScpIHtcblx0XHRzdHJpbmcgPSBkYXRlVG9TUUwobmV3IERhdGUoKSkuc3Vic3RyKDAsIDEwKTtcblx0fVxuXHRlbHNlIGlmIChsYyA9PSAndG9tb3Jyb3cnKSB7XG5cdFx0c3RyaW5nID0gZGF0ZVRvU1FMKG5ldyBEYXRlKERhdGUubm93KCkgKyAxMDAwKjYwKjYwKjI0KSkuc3Vic3RyKDAsIDEwKTtcblx0fVxuXHRlbHNlIHtcblx0XHRzdHJpbmcgPSBzdHJpbmcudG9TdHJpbmcoKS5yZXBsYWNlKC9eXFxzK3xcXHMrJC9nLCAnJykucmVwbGFjZSgvXFxzKy8sICcgJyk7XG5cdH1cblxuXHQvLyBmaXJzdCwgZGlyZWN0bHkgaW5zcGVjdCB0aGUgc3RyaW5nXG5cdGxldCBtID0gX3NsYXNoUmUuZXhlYyhzdHJpbmcpO1xuXHRpZihtICYmXG5cdFx0KCghbVs1XSB8fCAhbVszXSkgfHwgbVszXSA9PSBtWzVdIHx8IChtWzNdID09ICdcXHU1ZTc0JyAmJiBtWzVdID09ICdcXHU2NzA4JykpICYmXHQvLyByZXF1aXJlIHNhbmUgc2VwYXJhdG9yc1xuXHRcdCgobVsyXSAmJiBtWzRdICYmIG1bNl0pIHx8ICghbVsxXSAmJiAhbVs3XSkpKSB7XHRcdFx0XHRcdFx0Ly8gcmVxdWlyZSB0aGF0IGVpdGhlciBhbGwgcGFydHMgYXJlIGZvdW5kLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQvLyBvciBlbHNlIHRoaXMgaXMgdGhlIGVudGlyZSBkYXRlIGZpZWxkXG5cdFx0Ly8gZmlndXJlIG91dCBkYXRlIGJhc2VkIG9uIHBhcnRzXG5cdFx0aWYobVsyXS5sZW5ndGggPT0gMyB8fCBtWzJdLmxlbmd0aCA9PSA0IHx8IG1bM10gPT0gJ1xcdTVlNzQnKSB7XG5cdFx0XHQvLyBJU08gODYwMSBzdHlsZSBkYXRlIChiaWcgZW5kaWFuKVxuXHRcdFx0ZGF0ZS55ZWFyID0gbVsyXTtcblx0XHRcdGRhdGUubW9udGggPSBtWzRdO1xuXHRcdFx0ZGF0ZS5kYXkgPSBtWzZdO1xuXHRcdFx0ZGF0ZS5vcmRlciArPSBtWzJdID8gJ3knIDogJyc7XG5cdFx0XHRkYXRlLm9yZGVyICs9IG1bNF0gPyAnbScgOiAnJztcblx0XHRcdGRhdGUub3JkZXIgKz0gbVs2XSA/ICdkJyA6ICcnO1xuXHRcdH0gZWxzZSBpZihtWzJdICYmICFtWzRdICYmIG1bNl0pIHtcblx0XHRcdGRhdGUubW9udGggPSBtWzJdO1xuXHRcdFx0ZGF0ZS55ZWFyID0gbVs2XTtcblx0XHRcdGRhdGUub3JkZXIgKz0gbVsyXSA/ICdtJyA6ICcnO1xuXHRcdFx0ZGF0ZS5vcmRlciArPSBtWzZdID8gJ3knIDogJyc7XG5cdFx0fSBlbHNlIHtcblx0XHRcdC8vIGxvY2FsIHN0eWxlIGRhdGUgKG1pZGRsZSBvciBsaXR0bGUgZW5kaWFuKVxuXHRcdFx0dmFyIGNvdW50cnkgPSB3aW5kb3cubmF2aWdhdG9yLmxhbmd1YWdlID8gd2luZG93Lm5hdmlnYXRvci5sYW5ndWFnZS5zdWJzdHIoMykgOiAnVVMnO1xuXHRcdFx0aWYoY291bnRyeSA9PSAnVVMnIHx8XHQvLyBUaGUgVW5pdGVkIFN0YXRlc1xuXHRcdFx0XHRjb3VudHJ5ID09ICdGTScgfHxcdC8vIFRoZSBGZWRlcmF0ZWQgU3RhdGVzIG9mIE1pY3JvbmVzaWFcblx0XHRcdFx0Y291bnRyeSA9PSAnUFcnIHx8XHQvLyBQYWxhdVxuXHRcdFx0XHRjb3VudHJ5ID09ICdQSCcpIHtcdC8vIFRoZSBQaGlsaXBwaW5lc1xuXHRcdFx0XHRcdGRhdGUubW9udGggPSBtWzJdO1xuXHRcdFx0XHRcdGRhdGUuZGF5ID0gbVs0XTtcblx0XHRcdFx0XHRkYXRlLm9yZGVyICs9IG1bMl0gPyAnbScgOiAnJztcblx0XHRcdFx0XHRkYXRlLm9yZGVyICs9IG1bNF0gPyAnZCcgOiAnJztcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGRhdGUubW9udGggPSBtWzRdO1xuXHRcdFx0XHRkYXRlLmRheSA9IG1bMl07XG5cdFx0XHRcdGRhdGUub3JkZXIgKz0gbVsyXSA/ICdkJyA6ICcnO1xuXHRcdFx0XHRkYXRlLm9yZGVyICs9IG1bNF0gPyAnbScgOiAnJztcblx0XHRcdH1cblx0XHRcdGRhdGUueWVhciA9IG1bNl07XG5cdFx0XHRkYXRlLm9yZGVyICs9ICd5Jztcblx0XHR9XG5cblx0XHRpZihkYXRlLnllYXIpIHtcblx0XHRcdGRhdGUueWVhciA9IHBhcnNlSW50KGRhdGUueWVhciwgMTApO1xuXHRcdH1cblx0XHRpZihkYXRlLmRheSkge1xuXHRcdFx0ZGF0ZS5kYXkgPSBwYXJzZUludChkYXRlLmRheSwgMTApO1xuXHRcdH1cblx0XHRpZihkYXRlLm1vbnRoKSB7XG5cdFx0XHRkYXRlLm1vbnRoID0gcGFyc2VJbnQoZGF0ZS5tb250aCwgMTApO1xuXG5cdFx0XHRpZihkYXRlLm1vbnRoID4gMTIpIHtcblx0XHRcdFx0Ly8gc3dhcCBkYXkgYW5kIG1vbnRoXG5cdFx0XHRcdHZhciB0bXAgPSBkYXRlLmRheTtcblx0XHRcdFx0ZGF0ZS5kYXkgPSBkYXRlLm1vbnRoXG5cdFx0XHRcdGRhdGUubW9udGggPSB0bXA7XG5cdFx0XHRcdGRhdGUub3JkZXIgPSBkYXRlLm9yZGVyLnJlcGxhY2UoJ20nLCAnRCcpXG5cdFx0XHRcdFx0LnJlcGxhY2UoJ2QnLCAnTScpXG5cdFx0XHRcdFx0LnJlcGxhY2UoJ0QnLCAnZCcpXG5cdFx0XHRcdFx0LnJlcGxhY2UoJ00nLCAnbScpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmKCghZGF0ZS5tb250aCB8fCBkYXRlLm1vbnRoIDw9IDEyKSAmJiAoIWRhdGUuZGF5IHx8IGRhdGUuZGF5IDw9IDMxKSkge1xuXHRcdFx0aWYoZGF0ZS55ZWFyICYmIGRhdGUueWVhciA8IDEwMCkge1x0Ly8gZm9yIHR3byBkaWdpdCB5ZWFycywgZGV0ZXJtaW5lIHByb3BlclxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0Ly8gZm91ciBkaWdpdCB5ZWFyXG5cdFx0XHRcdHZhciB0b2RheSA9IG5ldyBEYXRlKCk7XG5cdFx0XHRcdHZhciB5ZWFyID0gdG9kYXkuZ2V0RnVsbFllYXIoKTtcblx0XHRcdFx0dmFyIHR3b0RpZ2l0WWVhciA9IHllYXIgJSAxMDA7XG5cdFx0XHRcdHZhciBjZW50dXJ5ID0geWVhciAtIHR3b0RpZ2l0WWVhcjtcblxuXHRcdFx0XHRpZihkYXRlLnllYXIgPD0gdHdvRGlnaXRZZWFyKSB7XG5cdFx0XHRcdFx0Ly8gYXNzdW1lIHRoaXMgZGF0ZSBpcyBmcm9tIG91ciBjZW50dXJ5XG5cdFx0XHRcdFx0ZGF0ZS55ZWFyID0gY2VudHVyeSArIGRhdGUueWVhcjtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHQvLyBhc3N1bWUgdGhpcyBkYXRlIGlzIGZyb20gdGhlIHByZXZpb3VzIGNlbnR1cnlcblx0XHRcdFx0XHRkYXRlLnllYXIgPSBjZW50dXJ5IC0gMTAwICsgZGF0ZS55ZWFyO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGlmKGRhdGUubW9udGgpIHtcblx0XHRcdFx0ZGF0ZS5tb250aC0tO1x0XHQvLyBzdWJ0cmFjdCBvbmUgZm9yIEpTIHN0eWxlXG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRkZWxldGUgZGF0ZS5tb250aDtcblx0XHRcdH1cblxuXHRcdFx0cGFydHMucHVzaChcblx0XHRcdFx0eyBwYXJ0OiBtWzFdLCBiZWZvcmU6IHRydWUgfSxcblx0XHRcdFx0eyBwYXJ0OiBtWzddIH1cblx0XHRcdCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHZhciBkYXRlID0ge1xuXHRcdFx0XHRvcmRlcjogJydcblx0XHRcdH07XG5cdFx0XHRwYXJ0cy5wdXNoKHsgcGFydDogc3RyaW5nIH0pO1xuXHRcdH1cblx0fSBlbHNlIHtcblx0XHRwYXJ0cy5wdXNoKHsgcGFydDogc3RyaW5nIH0pO1xuXHR9XG5cblx0Ly8gY291bGRuJ3QgZmluZCBzb21ldGhpbmcgd2l0aCB0aGUgYWxnb3JpdGhtczsgdXNlIHJlZ2V4cFxuXHQvLyBZRUFSXG5cdGlmKCFkYXRlLnllYXIpIHtcblx0XHRmb3IgKGxldCBpIGluIHBhcnRzKSB7XG5cdFx0XHRsZXQgbSA9IF95ZWFyUmUuZXhlYyhwYXJ0c1tpXS5wYXJ0KTtcblx0XHRcdGlmIChtKSB7XG5cdFx0XHRcdGRhdGUueWVhciA9IG1bMl07XG5cdFx0XHRcdGRhdGUub3JkZXIgPSBfaW5zZXJ0RGF0ZU9yZGVyUGFydChkYXRlLm9yZGVyLCAneScsIHBhcnRzW2ldKTtcblx0XHRcdFx0cGFydHMuc3BsaWNlKFxuXHRcdFx0XHRcdGksIDEsXG5cdFx0XHRcdFx0eyBwYXJ0OiBtWzFdLCBiZWZvcmU6IHRydWUgfSxcblx0XHRcdFx0XHR7IHBhcnQ6IG1bM10gfVxuXHRcdFx0XHQpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHQvLyBNT05USFxuXHRpZihkYXRlLm1vbnRoID09PSB1bmRlZmluZWQpIHtcblx0XHRmb3IgKGxldCBpIGluIHBhcnRzKSB7XG5cdFx0XHRsZXQgbSA9IF9tb250aFJlLmV4ZWMocGFydHNbaV0ucGFydCk7XG5cdFx0XHRpZiAobSkge1xuXHRcdFx0XHQvLyBNb2R1bG8gMTIgaW4gY2FzZSB3ZSBoYXZlIG11bHRpcGxlIGxhbmd1YWdlc1xuXHRcdFx0XHRkYXRlLm1vbnRoID0gbW9udGhzLmluZGV4T2YobVsyXS50b0xvd2VyQ2FzZSgpKSAlIDEyO1xuXHRcdFx0XHRkYXRlLm9yZGVyID0gX2luc2VydERhdGVPcmRlclBhcnQoZGF0ZS5vcmRlciwgJ20nLCBwYXJ0c1tpXSk7XG5cdFx0XHRcdHBhcnRzLnNwbGljZShcblx0XHRcdFx0XHRpLCAxLFxuXHRcdFx0XHRcdHsgcGFydDogbVsxXSwgYmVmb3JlOiAnbScgfSxcblx0XHRcdFx0XHR7IHBhcnQ6IG1bM10sIGFmdGVyOiAnbScgfVxuXHRcdFx0XHQpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHQvLyBEQVlcblx0aWYoIWRhdGUuZGF5KSB7XG5cdFx0Ly8gY29tcGlsZSBkYXkgcmVndWxhciBleHByZXNzaW9uXG5cdFx0Zm9yIChsZXQgaSBpbiBwYXJ0cykge1xuXHRcdFx0bGV0IG0gPSBfZGF5UmUuZXhlYyhwYXJ0c1tpXS5wYXJ0KTtcblx0XHRcdGlmIChtKSB7XG5cdFx0XHRcdHZhciBkYXkgPSBwYXJzZUludChtWzFdLCAxMCksXG5cdFx0XHRcdFx0cGFydDtcblx0XHRcdFx0Ly8gU2FuaXR5IGNoZWNrXG5cdFx0XHRcdGlmIChkYXkgPD0gMzEpIHtcblx0XHRcdFx0XHRkYXRlLmRheSA9IGRheTtcblx0XHRcdFx0XHRkYXRlLm9yZGVyID0gX2luc2VydERhdGVPcmRlclBhcnQoZGF0ZS5vcmRlciwgJ2QnLCBwYXJ0c1tpXSk7XG5cdFx0XHRcdFx0aWYobS5pbmRleCA+IDApIHtcblx0XHRcdFx0XHRcdHBhcnQgPSBwYXJ0c1tpXS5wYXJ0LnN1YnN0cigwLCBtLmluZGV4KTtcblx0XHRcdFx0XHRcdGlmKG1bMl0pIHtcblx0XHRcdFx0XHRcdFx0cGFydCArPSAnICcgKyBtWzJdO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRwYXJ0ID0gbVsyXTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0cGFydHMuc3BsaWNlKFxuXHRcdFx0XHRcdFx0aSwgMSxcblx0XHRcdFx0XHRcdHsgcGFydDogcGFydCB9XG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdC8vIENvbmNhdGVuYXRlIGRhdGUgcGFydHNcblx0ZGF0ZS5wYXJ0ID0gJyc7XG5cdGZvciAodmFyIGkgaW4gcGFydHMpIHtcblx0XHRkYXRlLnBhcnQgKz0gcGFydHNbaV0ucGFydCArICcgJztcblx0fVxuXG5cdC8vIGNsZWFuIHVwIGRhdGUgcGFydFxuXHRpZihkYXRlLnBhcnQpIHtcblx0XHRkYXRlLnBhcnQgPSBkYXRlLnBhcnQucmVwbGFjZSgvXlteQS1aYS16MC05XSt8W15BLVphLXowLTldKyQvZywgJycpO1xuXHR9XG5cblx0aWYoZGF0ZS5wYXJ0ID09PSAnJyB8fCBkYXRlLnBhcnQgPT0gdW5kZWZpbmVkKSB7XG5cdFx0ZGVsZXRlIGRhdGUucGFydDtcblx0fVxuXG5cdC8vbWFrZSBzdXJlIHllYXIgaXMgYWx3YXlzIGEgc3RyaW5nXG5cdGlmKGRhdGUueWVhciB8fCBkYXRlLnllYXIgPT09IDApIGRhdGUueWVhciArPSAnJztcblxuXHRyZXR1cm4gZGF0ZTtcbn1cbiIsImNvbnN0IGZpZWxkcyA9IHJlcXVpcmUoJy4vZmllbGRzJyk7XG5jb25zdCBpdGVtVHlwZXMgPSByZXF1aXJlKCcuL2l0ZW0tdHlwZXMnKTtcblxuY29uc3QgdHlwZVNwZWNpZmljRmllbGRNYXAgPSB7XG5cdFsoMTYgPDwgOCkgKyA0XTogOTQsXG5cdFsoMTcgPDwgOCkgKyA0XTogOTcsXG5cdFsoNyA8PCA4KSArIDhdOiA4OSxcblx0WygxMSA8PCA4KSArIDhdOiAyMSxcblx0WygxNSA8PCA4KSArIDhdOiAzMSxcblx0WygyNiA8PCA4KSArIDhdOiA3Mixcblx0WygyOCA8PCA4KSArIDhdOiA3Nixcblx0WygyOSA8PCA4KSArIDhdOiA3OCxcblx0WygzMCA8PCA4KSArIDhdOiA3OCxcblx0WygzMiA8PCA4KSArIDhdOiA4Myxcblx0WygxNiA8PCA4KSArIDEwXTogOTUsXG5cdFsoMTcgPDwgOCkgKyAxMF06IDk4LFxuXHRbKDMgPDwgOCkgKyAxMl06IDExNSxcblx0WygzMyA8PCA4KSArIDEyXTogMTE0LFxuXHRbKDEzIDw8IDgpICsgMTJdOiA5MSxcblx0WygyMyA8PCA4KSArIDEyXTogMTA3LFxuXHRbKDI1IDw8IDgpICsgMTJdOiAxMDQsXG5cdFsoMjkgPDwgOCkgKyAxMl06IDExOSxcblx0WygzMCA8PCA4KSArIDEyXTogMTE5LFxuXHRbKDM1IDw8IDgpICsgMTJdOiA4NSxcblx0WygzNiA8PCA4KSArIDEyXTogODYsXG5cdFsoMTcgPDwgOCkgKyAxNF06IDk2LFxuXHRbKDE5IDw8IDgpICsgMTRdOiA1Mixcblx0WygyMCA8PCA4KSArIDE0XTogMTAwLFxuXHRbKDE1IDw8IDgpICsgNjBdOiA5Mixcblx0WygxNiA8PCA4KSArIDYwXTogOTMsXG5cdFsoMTcgPDwgOCkgKyA2MF06IDExNyxcblx0WygxOCA8PCA4KSArIDYwXTogOTksXG5cdFsoMTkgPDwgOCkgKyA2MF06IDUwLFxuXHRbKDIwIDw8IDgpICsgNjBdOiAxMDEsXG5cdFsoMjkgPDwgOCkgKyA2MF06IDEwNSxcblx0WygzMCA8PCA4KSArIDYwXTogMTA1LFxuXHRbKDMxIDw8IDgpICsgNjBdOiAxMDUsXG5cdFsoNyA8PCA4KSArIDEwOF06IDY5LFxuXHRbKDggPDwgOCkgKyAxMDhdOiA2NSxcblx0Wyg5IDw8IDgpICsgMTA4XTogNjYsXG5cdFsoMTEgPDwgOCkgKyAxMDhdOiAxMjIsXG5cdFsoMTMgPDwgOCkgKyAxMDhdOiA3MCxcblx0WygxNSA8PCA4KSArIDEwOF06IDMyLFxuXHRbKDIyIDw8IDgpICsgMTA4XTogNjcsXG5cdFsoMjMgPDwgOCkgKyAxMDhdOiA3MCxcblx0WygyNSA8PCA4KSArIDEwOF06IDc5LFxuXHRbKDI3IDw8IDgpICsgMTA4XTogNzQsXG5cdFsoMTAgPDwgOCkgKyAxMDldOiA2NCxcblx0WygxMSA8PCA4KSArIDEwOV06IDYzLFxuXHRbKDEyIDw8IDgpICsgMTA5XTogNTksXG5cdFsoMjYgPDwgOCkgKyAxMDldOiA3MSxcblx0WygyOCA8PCA4KSArIDEwOV06IDYzLFxuXHRbKDI5IDw8IDgpICsgMTA5XTogNjMsXG5cdFsoMzAgPDwgOCkgKyAxMDldOiA3MSxcblx0WygzMSA8PCA4KSArIDEwOV06IDgwLFxuXHRbKDE3IDw8IDgpICsgMTEwXTogMTExLFxuXHRbKDIwIDw8IDgpICsgMTEwXTogMTEyLFxuXHRbKDIxIDw8IDgpICsgMTEwXTogMTEzXG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblx0bWFwOiB0eXBlU3BlY2lmaWNGaWVsZE1hcCxcblx0Z2V0RmllbGRJREZyb21UeXBlQW5kQmFzZTogKHR5cGVJZCwgZmllbGRJZCkgPT4ge1xuXHRcdHR5cGVJZCA9IHR5cGVvZiB0eXBlSWQgPT09ICdudW1iZXInID8gdHlwZUlkIDogaXRlbVR5cGVzW3R5cGVJZF07XG5cdFx0ZmllbGRJZCA9IHR5cGVvZiBmaWVsZElkID09PSAnbnVtYmVyJyA/IGZpZWxkSWQgOiBmaWVsZHNbZmllbGRJZF07XG5cdFx0cmV0dXJuIHR5cGVTcGVjaWZpY0ZpZWxkTWFwWyh0eXBlSWQgPDwgOCkgKyBmaWVsZElkXTtcblx0fVxufTtcbiJdfQ==
