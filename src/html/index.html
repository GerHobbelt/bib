<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title>Zotero Bib</title>
	<link rel="stylesheet" type="text/css" href="bib.css"/>
</head>
<body>
	<form id="zotero-bib">
		<input name="url" placeholder="Enter a URL to create a citation" />
		<button type="submit">GO</button>
	</form>
	<div id="bibliography">
	</div>
	<script src="bib.js"></script>
	<script>
		/* global ZoteroBib: false */
		let bib = new ZoteroBib({
			persistInLocalStorage: false
		});
		let citeprocSys = {
			retrieveLocale: function (lang) {
				var xhr = new XMLHttpRequest();
				xhr.open('GET', 'https://raw.githubusercontent.com/Juris-M/citeproc-js-docs/master/locales-' + lang + '.xml', false);
				xhr.send(null);
				return xhr.responseText;
			},
			retrieveItem: function(id) {
				return bib.items.find(item => item.id === id);
			}
		};

		let getProcessor = styleID => {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', 'https://raw.githubusercontent.com/citation-style-language/styles/master/' + styleID + '.csl', false);
			xhr.send(null);
			var styleAsText = xhr.responseText;
			var citeproc = new ZoteroBib.CSL.Engine(citeprocSys, styleAsText);
			return citeproc;
		};

		document.getElementById('zotero-bib').addEventListener('submit', ev => {
			ev.preventDefault();
			
			bib.translateUrl(ev.target.elements['url'].value).then(() => {
				var citeproc = getProcessor('chicago-fullnote-bibliography');
				citeproc.updateItems(bib.items.map(item => item.id));
				var result = citeproc.makeBibliography();
				document.getElementById('bibliography').innerHTML = `
					${result[0].bibstart}
					${result[1].join('\n')}
					${result[0].bibend}
				`;
			});
		});
	</script>
</body>
</html